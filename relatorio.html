<!doctype html>
<!-- Version: 5.16.0 - Enhanced social sharing with thumbnail - Cache buster: 2026-02-24-v5 -->
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Relat√≥rio completo de Performance com posts publicados, stories, objetivos alcan√ßados, m√©tricas de crescimento detalhadas e an√°lise de leads gerados. Acompanhe o progresso da sua estrat√©gia de marketing digital.">
  <title>Relat√≥rio de Performance ‚Ä¢ MediaGrowth</title>
  
  <!-- Open Graph / Facebook / WhatsApp -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="">
  <meta property="og:title" content="üìä Relat√≥rio de Performance - MediaGrowth">
  <meta property="og:description" content="üìà Relat√≥rio completo com posts publicados, objetivos alcan√ßados, m√©tricas de crescimento e an√°lise de leads. Visualize o progresso da sua estrat√©gia de marketing digital com dados detalhados e insights acion√°veis.">
  <meta property="og:image" content="https://dashboard.mediagrowth.com.br/assets/relatorio-thumbnail.png">
  <meta property="og:image:secure_url" content="https://dashboard.mediagrowth.com.br/assets/relatorio-thumbnail.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:image:alt" content="Relat√≥rio de Performance - Dashboard com m√©tricas e resultados">
  <meta property="og:site_name" content="MediaGrowth Dashboard">
  <meta property="og:locale" content="pt_BR">
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:url" content="">
  <meta name="twitter:title" content="üìä Relat√≥rio de Performance - MediaGrowth">
  <meta name="twitter:description" content="üìà Relat√≥rio completo com posts publicados, objetivos alcan√ßados, m√©tricas de crescimento e an√°lise de leads. Acompanhe o progresso da sua estrat√©gia digital.">
  <meta name="twitter:image" content="https://dashboard.mediagrowth.com.br/assets/relatorio-thumbnail.png">
  
  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
  
  <style>
    :root{ --panel:#111936; --shell-border:rgba(255,255,255,.12); }
    html,body{margin:0;padding:0;background:#0b1020;color:#e2e8f0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";overflow-x:hidden;min-height:100vh}
    body{overflow-y:auto}
    .btn{background:#1f2937;color:#e5e7eb;border:1px solid rgba(148,163,184,.35);border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn.small{padding:6px 10px;font-size:.9rem}
    .btn.secondary{background:rgba(255,255,255,.05)}
    .relatorio-wrap{max-width:1200px;margin:24px auto;padding:0 16px;display:flex;flex-direction:column;gap:20px;min-height:calc(100vh - 48px)}
    .relatorio-container{background:var(--panel);border:1px solid var(--shell-border);border-radius:16px;padding:24px;box-shadow:0 10px 28px rgba(0,0,0,.35)}
    .relatorio-header{margin-bottom:16px}
    .relatorio-header h2{margin:0 0 8px;font-size:1.8rem;font-weight:900;background:linear-gradient(135deg,#ff6633,#ff944d);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .relatorio-subtitle{margin:0;color:#94a3b8;font-size:.95rem}
    .relatorio-desc{margin:14px auto 0;color:#e5ecff;font-size:1.06rem;line-height:1.6;text-align:center;font-weight:700;letter-spacing:.01em;max-width:980px}
    .relatorio-preview{min-height:auto;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px}
    .relatorio-preview-meta{display:flex;align-items:center;gap:10px;color:#cbd5f5;font-size:.95rem;background:rgba(255,255,255,.02);border:1px dashed rgba(255,255,255,.12);border-radius:10px;padding:10px 12px}
    .relatorio-preview-meta .meta-item.ok{color:#86efac;font-weight:800}
    .relatorio-preview-meta .meta-sep{opacity:.6}
    .relatorio-goals-summary{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    .goal-pill{border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.05);color:#e2e8f0;padding:8px 12px;border-radius:999px;font-size:.9rem}
    .goal-pill strong{color:#fff;margin-left:4px}
    .goals-columns{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    .goals-col h3{margin:0 0 10px}
    .goals-list{display:flex;flex-direction:column;gap:10px}
    .goal-card{border:1px solid rgba(255,255,255,.12);border-left:4px solid #64748b;background:rgba(255,255,255,.03);border-radius:10px;padding:10px 12px}
    .goal-title{font-weight:800;color:#fff;margin:0 0 4px;font-size:.98rem}
    .goal-meta{font-size:.9rem;color:#cbd5f5}
    .macro-social-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px}
    .macro-social-item{display:flex;flex-direction:column;align-items:center;justify-content:flex-start;gap:14px;background:rgba(15,23,42,.52);border:1px solid rgba(148,163,184,.28);border-radius:18px;padding:18px 16px;text-align:center;box-shadow:0 10px 22px rgba(0,0,0,.26);min-height:220px}
    .macro-social-icon{width:56px;height:56px;border-radius:16px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,.8);border:1px solid rgba(148,163,184,.38);color:#e2e8f0;flex:0 0 auto;padding:16px;font-size:24px;line-height:1}
    .macro-social-icon img{width:24px;height:24px;object-fit:contain;display:block}
    .macro-social-info{display:flex;flex-direction:column;gap:6px;align-items:center;justify-content:center;flex:1;min-width:0}
    .macro-social-label{font-weight:800;color:#e2e8f0}
    .macro-social-detail{font-size:.9rem;color:#94a3b8}
    .macro-social-actions{display:flex;justify-content:center;align-items:center;width:100%;margin-top:auto}
    @media(max-width:900px){ .goals-columns{grid-template-columns:1fr} }

  /* Cores por status ‚Äî Objetivos do m√™s */
  #relatorioGoalsColumns .goals-col[data-status="concluido"]{ background: rgba(22,163,74,.12); border-color: rgba(22,163,74,.35); }
  #relatorioGoalsColumns .goals-col[data-status="em-andamento"]{ background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.35); }
  #relatorioGoalsColumns .goals-col[data-status="nao-iniciado"]{ background: rgba(59,130,246,.12); border-color: rgba(59,130,246,.35); }
  #relatorioGoalsDonePill{ border-color:#14532d; background:rgba(20,83,45,.25); }
  #relatorioGoalsProgressPill{ border-color:#b45309; background:rgba(180,83,9,.22); }
  #relatorioGoalsTodoPill{ border-color:#1e3a8a; background:rgba(30,58,138,.22); }

    @media print{ .btn{display:none !important} .relatorio-container{box-shadow:none} }
    /* Stories & Posts carrossel */
    .relatorio-stories-carousel{position:relative;display:flex;align-items:center;gap:12px}
    .relatorio-stories-grid{flex:1;display:flex;gap:12px;overflow-x:auto;scroll-behavior:smooth;padding:12px 4px;-webkit-overflow-scrolling:touch;will-change:scroll-position}
    .relatorio-stories-grid::-webkit-scrollbar{height:8px}
    .relatorio-stories-grid::-webkit-scrollbar-track{background:rgba(255,255,255,.05);border-radius:4px}
    .relatorio-stories-grid::-webkit-scrollbar-thumb{background:#ff6633;border-radius:4px}
    .relatorio-stories-grid::-webkit-scrollbar-thumb:hover{background:#ff7744}
  .relatorio-story-item{min-width:120px;width:120px;height:200px;border-radius:12px;overflow:hidden;position:relative;cursor:pointer;background:rgba(0,0,0,.4);border:2px solid rgba(255,255,255,.1);transition:all .3s ease;flex-shrink:0;transform:translateZ(0);backface-visibility:hidden;contain:layout paint}
    .relatorio-story-item:hover{transform:translateY(-4px) translateZ(0);border-color:#ff6633;box-shadow:0 8px 24px rgba(255,102,51,.3)}
    .relatorio-story-item img{width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0;display:block}
  .relatorio-story-item img[data-error="true"]{opacity:0.3;filter:grayscale(1)}
  .relatorio-story-item.video::before{content:"‚ñ∂";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:2rem;color:#fff;text-shadow:0 2px 8px rgba(0,0,0,.8);z-index:2;pointer-events:none}
  /* Evita :has() por custo de reflow: usamos classe .has-thumb */
  .relatorio-story-item[data-video-url]:not(.has-thumb)::after{content:"V";font-size:1.2rem;color:#fff;font-weight:700;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}
    .relatorio-story-item > span{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:1.2rem;color:#fff;font-weight:700}
    .relatorio-story-date{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(to top,rgba(0,0,0,.9),transparent);color:#fff;font-size:.75rem;font-weight:700;padding:8px 6px 6px;text-align:center}
    .relatorio-story-status{position:absolute;top:6px;right:6px;width:12px;height:12px;border-radius:50%;border:2px solid #fff;box-shadow:0 2px 4px rgba(0,0,0,.5)}
    .relatorio-story-item.aprovado .relatorio-story-status{background:#4ade80}
    .relatorio-story-item.aprovado-interno .relatorio-story-status{background:#60a5fa}
    .relatorio-story-item.revisar .relatorio-story-status{background:#fbbf24}
    .relatorio-story-item.pendente .relatorio-story-status{background:#94a3b8}
    .relatorio-stories-empty{width:100%;text-align:center;padding:40px 20px;color:#94a3b8}
    .carousel-nav{background:rgba(255,102,51,.2);border:2px solid #ff6633;color:#ff6633;width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:700;cursor:pointer;transition:all .3s ease;flex-shrink:0}
    .carousel-nav:hover{background:#ff6633;color:#fff;transform:scale(1.1)}
    .carousel-nav:active{transform:scale(.95)}
    @media(max-width:768px){ .carousel-nav{width:32px;height:32px;font-size:1.2rem} .relatorio-story-item{min-width:100px;width:100px;height:170px} }
    
    /* Estilos para tabelas nos relat√≥rios - bordas verticais */
    .relatorio-container table{
      width:100%;
      border-collapse:collapse;
      margin:16px 0;
      font-size:.85rem;
      background:rgba(15,23,42,.4);
      border-radius:8px;
      overflow:hidden;
    }
    .relatorio-container table th,
    .relatorio-container table td{
      border:1px solid rgba(255,255,255,.15);
      padding:10px 12px;
      text-align:left;
    }
    .relatorio-container table th{
      background:rgba(99,102,241,.2);
      color:#fff;
      font-weight:700;
      text-transform:uppercase;
      font-size:.75rem;
      letter-spacing:.03em;
    }
    .relatorio-container table tr:nth-child(even){
      background:rgba(255,255,255,.03);
    }
    .relatorio-container table tr:hover{
      background:rgba(99,102,241,.1);
    }
    .relatorio-container table td{
      color:rgba(255,255,255,.85);
    }
  </style>
</head>
<body>
  <div class="relatorio-wrap">
    <div class="relatorio-container" id="authGate" style="display:none">
      <div class="relatorio-header">
        <h2>Autentica√ß√£o necess√°ria</h2>
        <p class="relatorio-subtitle">Voc√™ precisa fazer login para visualizar este relat√≥rio.</p>
      </div>
      <button id="loginBtn" class="btn" type="button">Entrar com Google</button>
    </div>

    <div class="relatorio-container" id="content" style="display:none">
      <div class="relatorio-header">
        <h2>Relat√≥rio de Performance</h2>
        <p class="relatorio-subtitle" id="relatorioHeaderSubtitle">Vis√£o completa das m√©tricas de crescimento</p>
      </div>
      <div class="relatorio-preview">
        <div class="relatorio-preview-meta" id="relatorioPreviewMeta">
          <span class="meta-item">üìÖ <span id="reportMonth"></span></span>
          <span class="meta-sep">‚Ä¢</span>
          <span class="meta-item ok">‚úÖ Relat√≥rio gerado</span>
          <span class="meta-sep">‚Ä¢</span>
          <button id="printBtn" class="btn small" type="button">Imprimir / Salvar PDF</button>
        </div>
      </div>
    </div>

    <!-- Stories -->
    <div class="relatorio-container" id="relatorioStoriesSection" style="display:none">
      <div class="relatorio-header">
        <h2>üì± Stories Produzidos</h2>
        <p class="relatorio-subtitle" id="relatorioStoriesSubtitle"></p>
      </div>
      <div class="relatorio-stories-carousel">
        <button type="button" class="carousel-nav" id="relatorioStoriesPrev">‚Äπ</button>
        <div class="relatorio-stories-grid" id="relatorioStoriesGrid">
          <div class="relatorio-stories-empty">Nenhum story encontrado para este per√≠odo</div>
        </div>
        <button type="button" class="carousel-nav" id="relatorioStoriesNext">‚Ä∫</button>
      </div>
      <p class="relatorio-desc" id="relatorioStoriesDesc" style="display:none"></p>
    </div>

    <!-- Posts (Feed) -->
    <div class="relatorio-container" id="relatorioPostsSection" style="display:none">
      <div class="relatorio-header">
        <h2>üì∞ Posts Produzidos</h2>
        <p class="relatorio-subtitle" id="relatorioPostsSubtitle"></p>
      </div>
      <div class="relatorio-stories-carousel">
        <button type="button" class="carousel-nav" id="relatorioPostsPrev">‚Äπ</button>
        <div class="relatorio-stories-grid" id="relatorioPostsGrid">
          <div class="relatorio-stories-empty">Nenhum post de feed encontrado para este per√≠odo</div>
        </div>
        <button type="button" class="carousel-nav" id="relatorioPostsNext">‚Ä∫</button>
      </div>
      <p class="relatorio-desc" id="relatorioPostsDesc" style="display:none"></p>
    </div>

    <!-- Objetivos do m√™s (Planejamento) -->
    <div class="relatorio-container" id="relatorioGoalsSection" style="display:none">
      <div class="relatorio-header">
        <h2>üéØ Objetivos do m√™s</h2>
        <p class="relatorio-subtitle" id="relatorioGoalsSubtitle">Status das demandas do Planejamento no m√™s selecionado</p>
      </div>
      <div class="relatorio-goals-summary">
        <div class="goal-pill" id="relatorioGoalsDonePill">Conclu√≠dos: <strong>-</strong></div>
        <div class="goal-pill" id="relatorioGoalsProgressPill">Em andamento: <strong>-</strong></div>
        <div class="goal-pill" id="relatorioGoalsTodoPill">N√£o iniciados: <strong>-</strong></div>
      </div>
      <div class="goals-columns" id="relatorioGoalsColumns">
        <div class="goals-col" data-status="concluido">
          <h3>Conclu√≠dos</h3>
          <div class="goals-list" id="relatorioGoalsDone"></div>
        </div>
        <div class="goals-col" data-status="em-andamento">
          <h3>Em andamento</h3>
          <div class="goals-list" id="relatorioGoalsProgress"></div>
        </div>
        <div class="goals-col" data-status="nao-iniciado">
          <h3>N√£o iniciados</h3>
          <div class="goals-list" id="relatorioGoalsTodo"></div>
        </div>
      </div>
      <p class="relatorio-desc" id="relatorioGoalsDesc"></p>
    </div>

    <!-- Relat√≥rio de Performance -->
    <div class="relatorio-container" id="relatorioPerformanceSection" style="display:none">
      <div class="relatorio-header">
        <h2>Relat√≥rio de Performance</h2>
        <p class="relatorio-subtitle" id="relatorioPerformanceSubtitle">Vis√£o completa das m√©tricas de crescimento</p>
      </div>

      <!-- TR√ÅFEGO PAGO -->
      <div class="performance-category">
        <h3 class="performance-category-title" style="background: linear-gradient(135deg, #C34B09, #E05A0F); color: white; padding: 12px 16px; border-radius: 8px 8px 0 0; margin: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 10px;">
          <svg viewBox="0 0 24 24" style="width:28px;height:28px;"><defs><linearGradient id="adsGradientTitle" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#ffffff;stop-opacity:1" /><stop offset="100%" style="stop-color:#ffffff;stop-opacity:0.8" /></linearGradient></defs><path fill="url(#adsGradientTitle)" d="M18.5,1.15C17.97,1.15 17.46,1.34 17.07,1.73L11.26,7.55L16.91,13.2L22.73,7.39C23.5,6.61 23.5,5.35 22.73,4.56L19.89,1.73C19.5,1.34 19,1.15 18.5,1.15M10.3,8.5L4.34,14.46C3.56,15.24 3.56,16.5 4.36,17.31L11.69,24.64C12.5,25.44 13.76,25.44 14.56,24.64L20.5,18.7L14.84,13.05L10.3,8.5M2.86,15.94L1.15,17.65C0.734,18.07 0.734,18.74 1.15,19.15L4.93,22.93C5.34,23.35 6,23.35 6.42,22.93L8.13,21.22L2.86,15.94Z" /></svg>
          TR√ÅFEGO PAGO
        </h3>
        <div class="performance-grid" id="relatorioTrafegoGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; padding: 16px; background: rgba(195, 75, 9, 0.05); border-radius: 0 0 8px 8px; border: 1px solid rgba(195, 75, 9, 0.2);">
          <!-- Cards ser√£o inseridos aqui -->
        </div>
      </div>

      <!-- CANAIS -->
      <div class="performance-category" style="margin-top: 24px;">
        <h3 class="performance-category-title" style="background: linear-gradient(135deg, #005B81, #007AA8); color: white; padding: 12px 16px; border-radius: 8px 8px 0 0; margin: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 10px;">
          <svg viewBox="0 0 24 24" style="width:28px;height:28px;"><defs><linearGradient id="analyticsGradientTitle" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#ffffff;stop-opacity:1" /><stop offset="100%" style="stop-color:#ffffff;stop-opacity:0.8" /></linearGradient></defs><path fill="url(#analyticsGradientTitle)" d="M7,2H9A2,2 0 0,1 11,4V20A2,2 0 0,1 9,22H7A2,2 0 0,1 5,20V4A2,2 0 0,1 7,2M15,8H17A2,2 0 0,1 19,10V20A2,2 0 0,1 17,22H15A2,2 0 0,1 13,20V10A2,2 0 0,1 15,8Z" /></svg>
          CANAIS
        </h3>
        <div class="performance-grid" id="relatorioCanaisGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; padding: 16px; background: rgba(0, 91, 129, 0.05); border-radius: 0 0 8px 8px; border: 1px solid rgba(0, 91, 129, 0.2);">
          <!-- Cards ser√£o inseridos aqui -->
        </div>
      </div>

      <!-- CRM E AUTOMA√á√ïES -->
      <div class="performance-category" style="margin-top: 24px;">
        <h3 class="performance-category-title" style="background: linear-gradient(135deg, #007E41, #00A055); color: white; padding: 12px 16px; border-radius: 8px 8px 0 0; margin: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 10px;">
          <svg viewBox="0 0 24 24" style="width:28px;height:28px;"><defs><linearGradient id="crmGradientTitle" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#ffffff;stop-opacity:1" /><stop offset="100%" style="stop-color:#ffffff;stop-opacity:0.8" /></linearGradient></defs><path fill="url(#crmGradientTitle)" d="M16,17V14H9V10H16V7L21,12L16,17M14,2A2,2 0 0,1 16,4V6H14V4H5V20H14V18H16V20A2,2 0 0,1 14,22H5A2,2 0 0,1 3,20V4A2,2 0 0,1 5,2H14Z" /></svg>
          CRM E AUTOMA√á√ïES
        </h3>
        <div class="performance-grid" id="relatorioCRMGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; padding: 16px; background: rgba(0, 126, 65, 0.05); border-radius: 0 0 8px 8px; border: 1px solid rgba(0, 126, 65, 0.2);">
          <!-- Cards ser√£o inseridos aqui -->
        </div>
      </div>

      <!-- LIDERAN√áA -->
      <div class="performance-category" style="margin-top: 24px;">
        <h3 class="performance-category-title" style="background: linear-gradient(135deg, #7F6001, #A67C00); color: white; padding: 12px 16px; border-radius: 8px 8px 0 0; margin: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 10px;">
          <svg viewBox="0 0 24 24" style="width:28px;height:28px;"><defs><linearGradient id="emailGradientTitle" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#ffffff;stop-opacity:1" /><stop offset="100%" style="stop-color:#ffffff;stop-opacity:0.8" /></linearGradient></defs><path fill="url(#emailGradientTitle)" d="M12,5.5A3.5,3.5 0 0,1 15.5,9A3.5,3.5 0 0,1 12,12.5A3.5,3.5 0 0,1 8.5,9A3.5,3.5 0 0,1 12,5.5M5,8C5.56,8 6.08,8.15 6.53,8.42C6.38,9.85 6.8,11.27 7.66,12.38C7.16,13.34 6.16,14 5,14A3,3 0 0,1 2,11A3,3 0 0,1 5,8M19,8A3,3 0 0,1 22,11A3,3 0 0,1 19,14C17.84,14 16.84,13.34 16.34,12.38C17.2,11.27 17.62,9.85 17.47,8.42C17.92,8.15 18.44,8 19,8M5.5,18.25C5.5,16.18 8.41,14.5 12,14.5C15.59,14.5 18.5,16.18 18.5,18.25V20H5.5V18.25M0,20V18.5C0,17.11 1.89,15.94 4.45,15.6C3.86,16.28 3.5,17.22 3.5,18.25V20H0M24,20H20.5V18.25C20.5,17.22 20.14,16.28 19.55,15.6C22.11,15.94 24,17.11 24,18.5V20Z" /></svg>
          LIDERAN√áA
        </h3>
        <div class="performance-grid" id="relatorioLiderancaGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; padding: 16px; background: rgba(127, 96, 1, 0.05); border-radius: 0 0 8px 8px; border: 1px solid rgba(127, 96, 1, 0.2);">
          <!-- Cards ser√£o inseridos aqui -->
        </div>
      </div>

      <!-- OUTROS -->
      <div class="performance-category" style="margin-top: 24px;">
        <h3 class="performance-category-title" style="background: linear-gradient(135deg, #9900FF, #BB33FF); color: white; padding: 12px 16px; border-radius: 8px 8px 0 0; margin: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 10px;">
          <svg viewBox="0 0 24 24" style="width:28px;height:28px;"><defs><linearGradient id="automationGradientTitle" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#ffffff;stop-opacity:1" /><stop offset="100%" style="stop-color:#ffffff;stop-opacity:0.8" /></linearGradient></defs><path fill="url(#automationGradientTitle)" d="M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8M12,10A2,2 0 0,0 10,12A2,2 0 0,0 12,14A2,2 0 0,0 14,12A2,2 0 0,0 12,10M10,22C9.75,22 9.54,21.82 9.5,21.58L9.13,18.93C8.5,18.68 7.96,18.34 7.44,17.94L4.95,18.95C4.73,19.03 4.46,18.95 4.34,18.73L2.34,15.27C2.21,15.05 2.27,14.78 2.46,14.63L4.57,12.97L4.5,12L4.57,11L2.46,9.37C2.27,9.22 2.21,8.95 2.34,8.73L4.34,5.27C4.46,5.05 4.73,4.96 4.95,5.05L7.44,6.05C7.96,5.66 8.5,5.32 9.13,5.07L9.5,2.42C9.54,2.18 9.75,2 10,2H14C14.25,2 14.46,2.18 14.5,2.42L14.87,5.07C15.5,5.32 16.04,5.66 16.56,6.05L19.05,5.05C19.27,4.96 19.54,5.05 19.66,5.27L21.66,8.73C21.79,8.95 21.73,9.22 21.54,9.37L19.43,11L19.5,12L19.43,13L21.54,14.63C21.73,14.78 21.79,15.05 21.66,15.27L19.66,18.73C19.54,18.95 19.27,19.04 19.05,18.95L16.56,17.95C16.04,18.34 15.5,18.68 14.87,18.93L14.5,21.58C14.46,21.82 14.25,22 14,22H10M11.25,4L10.88,6.61C9.68,6.86 8.62,7.5 7.85,8.39L5.44,7.35L4.69,8.65L6.8,10.2C6.4,11.37 6.4,12.64 6.8,13.8L4.68,15.36L5.43,16.66L7.86,15.62C8.63,16.5 9.68,17.14 10.87,17.38L11.24,20H12.76L13.13,17.39C14.32,17.14 15.37,16.5 16.14,15.62L18.57,16.66L19.32,15.36L17.2,13.81C17.6,12.64 17.6,11.37 17.2,10.2L19.31,8.65L18.56,7.35L16.15,8.39C15.38,7.5 14.32,6.86 13.12,6.62L12.75,4H11.25Z" /></svg>
          OUTROS
        </h3>
        <div class="performance-grid" id="relatorioOutrosGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; padding: 16px; background: rgba(153, 0, 255, 0.05); border-radius: 0 0 8px 8px; border: 1px solid rgba(153, 0, 255, 0.2);">
          <!-- Cards ser√£o inseridos aqui -->
        </div>
      </div>
    </div>

    <!-- Leads Gerados -->
    <div class="relatorio-container" id="relatorioLeadsSection" style="display:none">
      <div class="relatorio-header">
        <h2>üéØ Leads Gerados</h2>
        <p class="relatorio-subtitle" id="relatorioLeadsSubtitle"></p>
      </div>
      <div class="relatorio-preview">
        <div class="relatorio-preview-meta" style="justify-content: center; font-size: 1.4rem; padding: 20px;">
          <span class="meta-item" style="color: #86efac; font-weight: 900; font-size: 2rem;">
            üìä <span id="relatorioLeadsCount">0</span> leads
          </span>
        </div>
      </div>
      
      <!-- An√°lise Detalhada -->
      <div class="relatorio-leads-analysis" id="relatorioLeadsAnalysis" style="display:none; margin-top: 20px;">
        
        <!-- Por Plataforma -->
        <div class="relatorio-container" style="margin-bottom: 16px;">
          <h3 style="margin: 0 0 12px; font-size: 1.1rem; color: #e2e8f0;">üì± Por Plataforma</h3>
          <div class="relatorio-goals-summary" id="relatorioLeadsPlatforms"></div>
        </div>
        
        <!-- Por Fonte -->
        <div class="relatorio-container" style="margin-bottom: 16px;">
          <h3 style="margin: 0 0 12px; font-size: 1.1rem; color: #e2e8f0;">üåê Por Fonte</h3>
          <div class="relatorio-goals-summary" id="relatorioLeadsSources"></div>
        </div>
        
        <!-- Principais Perguntas -->
        <div class="relatorio-container" style="margin-bottom: 16px;">
          <h3 style="margin: 0 0 12px; font-size: 1.1rem; color: #e2e8f0;">üí¨ Principais Perguntas</h3>
          <div id="relatorioLeadsQuestions" style="display: flex; flex-direction: column; gap: 8px;"></div>
        </div>
        
        <!-- An√°lise IA -->
        <div class="relatorio-container" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1)); border: 1px solid rgba(139, 92, 246, 0.3);">
          <h3 style="margin: 0 0 12px; font-size: 1.1rem; color: #c4b5fd;">ü§ñ An√°lise Inteligente</h3>
          <div id="relatorioLeadsAIAnalysis" style="color: #e9d5ff; line-height: 1.6; font-size: 0.95rem;"></div>
        </div>
        
      </div>
      
      <p class="relatorio-desc" id="relatorioLeadsDesc"></p>
    </div>

    <!-- Redes conectadas -->
    <div class="relatorio-container" id="relatorioRedesSection" style="display:none">
      <div class="relatorio-header">
        <h2>üîó Redes trabalhadas no m√™s</h2>
        <p class="relatorio-subtitle" id="relatorioRedesSubtitle"></p>
      </div>
      <div class="macro-social-grid" id="relatorioRedesGrid"></div>
      <p class="relatorio-desc" id="relatorioRedesDesc"></p>
    </div>
    
    <!-- Resumo em Texto -->
    <div class="relatorio-container" id="relatorioResumoTextoSection" style="display:none; background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(100, 116, 139, 0.3);">
      <div class="relatorio-header">
        <h2>üìã Resumo em Texto</h2>
        <p class="relatorio-subtitle">Copie este resumo para compartilhar facilmente</p>
      </div>
      
      <div style="position: relative;">
        <button type="button" id="btnCopiarResumo" class="btn secondary small" style="position: absolute; top: 8px; right: 8px; z-index: 10; background: rgba(59, 130, 246, 0.2); border-color: rgba(59, 130, 246, 0.4);">
          üìã Copiar Texto
        </button>
        
        <div id="relatorioResumoTextoContent" style="
          background: rgba(15, 23, 42, 0.8);
          border: 1px solid rgba(71, 85, 105, 0.4);
          border-radius: 8px;
          padding: 24px;
          color: #e2e8f0;
          font-family: 'Courier New', monospace;
          font-size: 0.95rem;
          line-height: 1.8;
          white-space: pre-wrap;
          overflow-x: auto;
          min-height: 200px;
        ">
          <!-- Ser√° preenchido dinamicamente -->
        </div>
      </div>
    </div>
    
  </div>

  <script type="module">
    // Firebase SDK (modular)
    import { initializeApp, getApps } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
    import { getFirestore, doc, getDoc, collection, getDocs, setDoc } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js';

    // ===== Config igual ao index.html =====
    const firebaseConfig = {
      apiKey: "AIzaSyD4CbPQWrwOcfANX3ar0ibmGN20ffsRCqo",
      authDomain: "mediagrowth-a5349.firebaseapp.com",
      projectId: "mediagrowth-a5349",
      storageBucket: "mediagrowth-a5349.firebasestorage.app",
      messagingSenderId: "1074237637946",
      appId: "1:1074237637946:web:cf5008b649bbb4d7d13c03"
    };

    // Parse params
  const qs = new URLSearchParams(location.search);
  const shareToken = qs.get('share') || '';
  
  // üî• NOVO: Suportar per√≠odo multi-m√™s (mesInicio + mesFim) e formato antigo (mes)
  const mesInicioISO = (qs.get('mesInicio') || qs.get('mes') || '').slice(0,7);
  const mesFimISO = (qs.get('mesFim') || mesInicioISO || '').slice(0,7);
  const mesISO = mesInicioISO; // Compatibilidade com c√≥digo antigo
  
  const TENANT = qs.get('tenant') || document.body.getAttribute('data-client-id') || '';
  
  // üî• NOVO: Gerar label de per√≠odo (Janeiro a Fevereiro 2026, ou apenas Janeiro 2026)
  const monthLabel = (()=>{ 
    try{ 
      const [anoInicio, mesInicio] = mesInicioISO.split('-'); 
      const [anoFim, mesFim] = mesFimISO.split('-'); 
      const nomes = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro']; 
      
      if(mesInicioISO === mesFimISO){
        // Per√≠odo de um √∫nico m√™s
        return `${nomes[(+mesInicio||1)-1]} ${anoInicio}`;
      } else {
        // Per√≠odo multi-m√™s
        const mesInicioNome = nomes[(+mesInicio||1)-1];
        const mesFimNome = nomes[(+mesFim||1)-1];
        
        if(anoInicio === anoFim){
          return `${mesInicioNome} a ${mesFimNome} ${anoInicio}`;
        } else {
          return `${mesInicioNome} ${anoInicio} a ${mesFimNome} ${anoFim}`;
        }
      }
    } catch{ 
      return mesInicioISO; 
    } 
  })();
  
  document.getElementById('reportMonth').textContent = monthLabel || '';
  document.getElementById('relatorioHeaderSubtitle').textContent = monthLabel ? `Resumo do per√≠odo ${monthLabel}` : '';
  
  // Atualizar meta tags Open Graph dinamicamente
  const currentUrl = window.location.href;
  const baseUrl = window.location.origin;
  const thumbnailUrl = `${baseUrl}/assets/relatorio-thumbnail.png`;
  
  document.querySelector('meta[property="og:url"]').setAttribute('content', currentUrl);
  document.querySelector('meta[name="twitter:url"]').setAttribute('content', currentUrl);
  
  // Garantir que a imagem esteja sempre definida
  document.querySelector('meta[property="og:image"]').setAttribute('content', thumbnailUrl);
  document.querySelector('meta[property="og:image:secure_url"]').setAttribute('content', thumbnailUrl);
  document.querySelector('meta[name="twitter:image"]').setAttribute('content', thumbnailUrl);
  
  if(monthLabel) {
    const ogTitle = `üìä Relat√≥rio de ${monthLabel} - MediaGrowth`;
    const ogDesc = `üìà Relat√≥rio completo de ${monthLabel}: posts publicados, objetivos alcan√ßados, m√©tricas detalhadas de crescimento (visualiza√ß√µes, engajamento, novos seguidores) e an√°lise de leads gerados. Acompanhe os resultados da sua estrat√©gia digital.`;
    
    document.title = ogTitle;
    document.querySelector('meta[property="og:title"]').setAttribute('content', ogTitle);
    document.querySelector('meta[property="og:description"]').setAttribute('content', ogDesc);
    document.querySelector('meta[name="twitter:title"]').setAttribute('content', ogTitle);
    document.querySelector('meta[name="twitter:description"]').setAttribute('content', ogDesc);
    document.querySelector('meta[name="description"]').setAttribute('content', ogDesc);
  }

  // App/Auth/DB
    const app = getApps()[0] || initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // ==================== CONSTANTES GLOBAIS (DEVE ESTAR NO TOPO DO M√ìDULO) ====================
    
    // üé® Logos de plataformas (SVG inline) - DECLARADO ANTES DE TODAS AS FUN√á√ïES QUE O USAM
    const PLATFORM_LOGOS = {
      google: '<svg viewBox="0 0 24 24" fill="currentColor" style="width: 18px; height: 18px;"><path d="M12.48 10.92v3.28h7.84c-.24 1.84-.853 3.187-1.787 4.133-1.147 1.147-2.933 2.4-6.053 2.4-4.827 0-8.6-3.893-8.6-8.72s3.773-8.72 8.6-8.72c2.6 0 4.507 1.027 5.907 2.347l2.307-2.307C18.747 1.44 16.133 0 12.48 0 5.867 0 .307 5.387.307 12s5.56 12 12.173 12c3.573 0 6.267-1.173 8.373-3.36 2.16-2.16 2.84-5.213 2.84-7.667 0-.76-.053-1.467-.173-2.053H12.48z"/></svg>',
      facebook: '<svg viewBox="0 0 24 24" fill="currentColor" style="width: 18px; height: 18px;"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>',
      instagram: '<svg viewBox="0 0 24 24" fill="currentColor" style="width: 18px; height: 18px;"><path d="M12 0C8.74 0 8.333.015 7.053.072 5.775.132 4.905.333 4.14.63c-.789.306-1.459.717-2.126 1.384S.935 3.35.63 4.14C.333 4.905.131 5.775.072 7.053.012 8.333 0 8.74 0 12s.015 3.667.072 4.947c.06 1.277.261 2.148.558 2.913.306.788.717 1.459 1.384 2.126.667.666 1.336 1.079 2.126 1.384.766.296 1.636.499 2.913.558C8.333 23.988 8.74 24 12 24s3.667-.015 4.947-.072c1.277-.06 2.148-.262 2.913-.558.788-.306 1.459-.718 2.126-1.384.666-.667 1.079-1.335 1.384-2.126.296-.765.499-1.636.558-2.913.06-1.28.072-1.687.072-4.947s-.015-3.667-.072-4.947c-.06-1.277-.262-2.149-.558-2.913-.306-.789-.718-1.459-1.384-2.126C21.319 1.347 20.651.935 19.86.63c-.765-.297-1.636-.499-2.913-.558C15.667.012 15.26 0 12 0zm0 2.16c3.203 0 3.585.016 4.85.071 1.17.055 1.805.249 2.227.415.562.217.96.477 1.382.896.419.42.679.819.896 1.381.164.422.36 1.057.413 2.227.057 1.266.07 1.646.07 4.85s-.015 3.585-.074 4.85c-.061 1.17-.256 1.805-.421 2.227-.224.562-.479.96-.899 1.382-.419.419-.824.679-1.38.896-.42.164-1.065.36-2.235.413-1.274.057-1.649.07-4.859.07-3.211 0-3.586-.015-4.859-.074-1.171-.061-1.816-.256-2.236-.421-.569-.224-.96-.479-1.379-.899-.421-.419-.69-.824-.9-1.38-.165-.42-.359-1.065-.42-2.235-.045-1.26-.061-1.649-.061-4.844 0-3.196.016-3.586.061-4.861.061-1.17.255-1.814.42-2.234.21-.57.479-.96.9-1.381.419-.419.81-.689 1.379-.898.42-.166 1.051-.361 2.221-.421 1.275-.045 1.65-.06 4.859-.06l.045.03zm0 3.678c-3.405 0-6.162 2.76-6.162 6.162 0 3.405 2.76 6.162 6.162 6.162 3.405 0 6.162-2.76 6.162-6.162 0-3.405-2.76-6.162-6.162-6.162zM12 16c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zm7.846-10.405c0 .795-.646 1.44-1.44 1.44-.795 0-1.44-.646-1.44-1.44 0-.794.646-1.439 1.44-1.439.793-.001 1.44.645 1.44 1.439z"/></svg>',
      linkedin: '<svg viewBox="0 0 24 24" fill="currentColor" style="width: 18px; height: 18px;"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>',
      youtube: '<svg viewBox="0 0 24 24" fill="currentColor" style="width: 18px; height: 18px;"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>',
      tiktok: '<svg viewBox="0 0 24 24" fill="currentColor" style="width: 18px; height: 18px;"><path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-1.43.08-2.86-.31-4.08-1.03-2.02-1.19-3.44-3.37-3.65-5.71-.02-.5-.03-1-.01-1.49.18-1.9 1.12-3.72 2.58-4.96 1.66-1.44 3.98-2.13 6.15-1.72.02 1.48-.04 2.96-.04 4.44-.99-.32-2.15-.23-3.02.37-.63.41-1.11 1.04-1.36 1.75-.21.51-.15 1.07-.14 1.61.24 1.64 1.82 3.02 3.5 2.87 1.12-.01 2.19-.66 2.77-1.61.19-.33.4-.67.41-1.06.1-1.79.06-3.57.07-5.36.01-4.03-.01-8.05.02-12.07z"/></svg>',
      whatsapp: '<svg viewBox="0 0 24 24" fill="currentColor" style="width: 18px; height: 18px;"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.890-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>',
      meta: '<svg viewBox="0 0 24 24" fill="currentColor" style="width: 18px; height: 18px;"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>',
      crm: '<svg viewBox="0 0 24 24" fill="currentColor" style="width: 18px; height: 18px;"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>',
      email: '<svg viewBox="0 0 24 24" fill="currentColor" style="width: 18px; height: 18px;"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>',
      automation: '<svg viewBox="0 0 24 24" fill="currentColor" style="width: 18px; height: 18px;"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>',
      ads: '<svg viewBox="0 0 24 24" fill="currentColor" style="width: 18px; height: 18px;"><path d="M18.5 3h-13C4.67 3 4 3.67 4 4.5v15c0 .83.67 1.5 1.5 1.5h13c.83 0 1.5-.67 1.5-1.5v-15c0-.83-.67-1.5-1.5-1.5zM7 18H5V9h2v9zm8 0h-2v-6h2v6zm4 0h-2V6h2v12z"/></svg>',
      analytics: '<svg viewBox="0 0 24 24" fill="currentColor" style="width: 18px; height: 18px;"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>'
    };

    /**
     * Fun√ß√£o robusta para copiar texto que funciona em iframes e diferentes contextos de permiss√£o
     * @param {string} text - Texto a ser copiado
     * @returns {Promise<boolean>} - Retorna true se a c√≥pia foi bem-sucedida
     */
    async function mgCopyToClipboard(text) {
      if(!text && text !== '') return false;
      
      let copiado = false;
      
      // M√©todo 1: Clipboard API moderna
      if(navigator?.clipboard?.writeText) {
        try {
          await navigator.clipboard.writeText(text);
          copiado = true;
        } catch(clipErr) {
          console.warn('[mgCopyToClipboard] Clipboard API falhou, tentando fallback:', clipErr);
        }
      }
      
      // M√©todo 2: Fallback com textarea + execCommand (funciona em iframes sem permiss√£o clipboard-write)
      if(!copiado) {
        try {
          const textarea = document.createElement('textarea');
          textarea.value = text;
          textarea.style.position = 'fixed';
          textarea.style.left = '-9999px';
          textarea.style.top = '-9999px';
          textarea.style.opacity = '0';
          textarea.style.pointerEvents = 'none';
          textarea.setAttribute('readonly', '');
          textarea.setAttribute('aria-hidden', 'true');
          document.body.appendChild(textarea);
          
          textarea.focus();
          textarea.select();
          textarea.setSelectionRange(0, text.length);
          
          const sucesso = document.execCommand('copy');
          if(sucesso) copiado = true;
          
          document.body.removeChild(textarea);
        } catch(execErr) {
          console.error('[mgCopyToClipboard] execCommand falhou:', execErr);
        }
      }
      
      return copiado;
    }

    // Helpers metas (copiados do index de forma m√≠nima)
    const META_MONTHS = ['2025-01','2025-02','2025-03','2025-04','2025-05','2025-06','2025-07','2025-08','2025-09','2025-10','2025-11','2025-12'];
    function normalizeMetaNumber(value){
      if(value===null||value===undefined) return 0; const n=Number(String(value).replace(/[^0-9.,-]/g,'').replace(',','.')); return Number.isFinite(n)?n:0;
    }
    function evaluateMetaGoal(planned, realized, direction){
      const p = Math.max(0, normalizeMetaNumber(planned));
      const r = normalizeMetaNumber(realized);
      
      // Se n√£o tem meta planejada ou realizado est√° vazio/zero, retorna 'missing' (precisa colocar)
      if(p <= 0 || (r === 0 && planned === 0) || (r === 0 && !realized && realized !== 0)) return 'missing';
      
      const dir = (direction || 'aumentar').toLowerCase();
      
      if(dir === 'diminuir'){
        // Para diminuir: se realizado <= planejado = atingida (achieved), sen√£o = em andamento (progress)
        return r <= p ? 'achieved' : 'progress';
      }
      if(dir === 'manter'){
        if(p === 0) return 'progress';
        const tolerance = Math.max(Math.abs(p) * 0.05, 0.01);
        return Math.abs(r - p) <= tolerance ? 'achieved' : 'progress';
      }
      // Para aumentar: se realizado >= planejado = atingida (achieved), sen√£o = em andamento (progress)
      return r >= p ? 'achieved' : 'progress';
    }

    function escapeHtml(v){ return String(v??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

    // UI refs
    const els = {
      authGate: document.getElementById('authGate'),
      loginBtn: document.getElementById('loginBtn'),
      content: document.getElementById('content'),
      printBtn: document.getElementById('printBtn'),
      stories: {
        section: document.getElementById('relatorioStoriesSection'),
        grid: document.getElementById('relatorioStoriesGrid'),
        prev: document.getElementById('relatorioStoriesPrev'),
        next: document.getElementById('relatorioStoriesNext'),
        subtitle: document.getElementById('relatorioStoriesSubtitle'),
        desc: document.getElementById('relatorioStoriesDesc')
      },
      posts: {
        section: document.getElementById('relatorioPostsSection'),
        grid: document.getElementById('relatorioPostsGrid'),
        prev: document.getElementById('relatorioPostsPrev'),
        next: document.getElementById('relatorioPostsNext'),
        subtitle: document.getElementById('relatorioPostsSubtitle'),
        desc: document.getElementById('relatorioPostsDesc')
      },
      goals: {
        section: document.getElementById('relatorioGoalsSection'),
        subtitle: document.getElementById('relatorioGoalsSubtitle'),
        desc: document.getElementById('relatorioGoalsDesc'),
        donePill: document.getElementById('relatorioGoalsDonePill'),
        progressPill: document.getElementById('relatorioGoalsProgressPill'),
        todoPill: document.getElementById('relatorioGoalsTodoPill'),
        done: document.getElementById('relatorioGoalsDone'),
        progress: document.getElementById('relatorioGoalsProgress'),
        todo: document.getElementById('relatorioGoalsTodo')
      }
    };

    els.printBtn.addEventListener('click', ()=> window.print());

    els.loginBtn?.addEventListener('click', async ()=>{
      try{
        await setPersistence(auth, browserLocalPersistence);
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
      }catch(err){ alert('Falha no login. Veja o console.'); console.error(err); }
    });

    if(shareToken){
      // Modo p√∫blico via token: n√£o exige login
      console.log('[Relatorio] Modo p√∫blico - carregando via shareToken:', shareToken);
      els.authGate.style.display = 'none';
      els.content.style.display = 'block';
      try{
        const snap = await getDoc(doc(db,'reportShares', shareToken));
        if(!snap.exists()){
          console.error('[Relatorio] Token n√£o encontrado no Firestore');
          throw new Error('Link inv√°lido ou expirado');
        }
        console.log('[Relatorio] Token encontrado, carregando payload...');
        const data = snap.data() || {};
        const payload = data.payload || {};
        console.log('[Relatorio] Payload carregado:', {
          hasStories: Array.isArray(payload.posts) ? payload.posts.filter(p => p.target === 'stories').length : 0,
          hasPosts: Array.isArray(payload.posts) ? payload.posts.filter(p => p.target === 'feed').length : 0,
          totalPosts: Array.isArray(payload.posts) ? payload.posts.length : 0,
          leadsCount: payload.leadsCount || 0,
          leadsDataCount: Array.isArray(payload.leadsData) ? payload.leadsData.length : 0
        });
        console.log('[Relatorio] leadsData preview:', Array.isArray(payload.leadsData) && payload.leadsData.length > 0 ? payload.leadsData[0] : 'nenhum lead');
        renderFromPayload(payload);
      }catch(err){
        console.error('[Relatorio] Erro ao carregar link p√∫blico:', err);
        els.content.innerHTML = '<div class="relatorio-desc">Link inv√°lido ou expirado. Erro: ' + (err.message || String(err)) + '</div>';
      }
    } else {
      // Modo autenticado (retrocompat)
      console.log('[Relatorio] Modo autenticado - aguardando login...');
      console.warn('[Relatorio] IMPORTANTE: Para acesso p√∫blico use o bot√£o "Copiar link" no painel principal que gera um link com token ?share=...');
      console.warn('[Relatorio] Acesso direto sem token requer autentica√ß√£o Google.');
      
      onAuthStateChanged(auth, async (user)=>{
        if(!user){
          console.log('[Relatorio] Usu√°rio n√£o autenticado, mostrando tela de login');
          console.warn('[Relatorio] Se voc√™ est√° em produ√ß√£o e quer acessar o relat√≥rio, use o link gerado com o bot√£o "Copiar link" que inclui o token de compartilhamento.');
          els.authGate.style.display = 'block';
          els.content.style.display = 'none';
          
          // Mostra mensagem mais clara
          const subtitle = els.authGate.querySelector('.relatorio-subtitle');
          if(subtitle){
            subtitle.innerHTML = 'Voc√™ precisa fazer login para visualizar este relat√≥rio.<br><small style="color:#94a3b8;margin-top:8px;display:block;">üí° Dica: Use o bot√£o "Copiar link" no painel principal para gerar um link p√∫blico que n√£o requer login.</small>';
          }
          return;
        }
        console.log('[Relatorio] Usu√°rio autenticado:', user.uid);
        els.authGate.style.display = 'none';
        els.content.style.display = 'block';
        try{
          await loadAndRender(user.uid);
        }catch(err){
          console.error('[Relatorio] Erro ao carregar relat√≥rio:', err);
          alert('N√£o foi poss√≠vel carregar o relat√≥rio.');
        }
      });
    }

    async function loadAndRender(uid){
      console.log('[Relatorio] loadAndRender iniciado - uid:', uid, 'mesISO:', mesISO, 'TENANT:', TENANT);
      
      // 1) USER_DATA b√°sico (metas, social links)
      const userSnap = await getDoc(doc(db,'usuarios', uid));
      const USER_DATA = userSnap.exists() ? (userSnap.data()||{}) : {};
      const METAS = Array.isArray(USER_DATA.metas) ? USER_DATA.metas : [];
      const SOCIAL_LINKS = USER_DATA.socialLinks && typeof USER_DATA.socialLinks==='object' ? USER_DATA.socialLinks : {};
      console.log('[Relatorio] USER_DATA carregado - metas:', METAS.length);

      // 2) Posts (filtrar por per√≠odo e tenant)
      const postsSnap = await getDocs(collection(db,'usuarios', uid, 'posts'));
      const allPosts = postsSnap.docs.map(d=>({ id:d.id, ...(d.data()||{}) }));
      console.log('[Relatorio] Total de posts no Firestore:', allPosts.length);
      
      const posts = allPosts.filter(p => {
        const iso = String(p.dateISO||'').slice(0,7); // Pega apenas YYYY-MM
        
        // üî• NOVO: Verificar se est√° no per√≠odo (mesInicio <= iso <= mesFim)
        const okMes = iso >= mesInicioISO && iso <= mesFimISO;
        
        const tenant = p.tenant||''; 
        const safeTenant = TENANT||'';
        const okTenant = !tenant || !safeTenant ? true : (tenant===safeTenant);
        const keep = okMes && okTenant;
        
        if(!keep && mesInicioISO && TENANT){
          console.log('[Relatorio] Post filtrado:', p.id, 'dateISO:', iso, 'tenant:', tenant, 'okMes:', okMes, 'okTenant:', okTenant);
        }
        return keep;
      }).sort((a,b)=> String(a.dateISO||'').localeCompare(String(b.dateISO||'')));
      
      console.log('[Relatorio] Posts ap√≥s filtro (per√≠odo', mesInicioISO, 'at√©', mesFimISO, '):', posts.length);
      console.log('[Relatorio] Stories:', posts.filter(p => p.target === 'stories').length);
      console.log('[Relatorio] Feed posts:', posts.filter(p => (p.target||'feed') === 'feed').length);

      // 3) Calendar notes por cliente
      let notes = [];
      if(TENANT){
        const notesSnap = await getDocs(collection(db,'usuarios', uid, 'clients', TENANT, 'calendarNotes'));
        notes = notesSnap.docs
          .map(d=>({ id:d.id, ...(d.data()||{}) }))
          .filter(n=> String(n.id||'').startsWith(mesISO))
          .sort((a,b)=> String(a.id).localeCompare(String(b.id)));
        console.log('[Relatorio] Calendar notes carregadas:', notes.length);
      }

      // 4) Leads por cliente (filtrados pelo m√™s)
      let leads = [];
      if(TENANT && mesISO){
        try{
          const leadsSnap = await getDocs(collection(db,'usuarios', uid, 'clients', TENANT, 'leads'));
          const allLeads = leadsSnap.docs.map(d=>({ id:d.id, ...(d.data()||{}) }));
          
          // Filtrar leads pelo m√™s de cria√ß√£o
          leads = allLeads.filter(lead => {
            if(!lead.createdAt) return false;
            
            // Converter createdAt para data
            let leadDate;
            if(typeof lead.createdAt.toMillis === 'function'){
              leadDate = new Date(lead.createdAt.toMillis());
            } else if(typeof lead.createdAt.toDate === 'function'){
              leadDate = lead.createdAt.toDate();
            } else if(lead.createdAt.seconds) {
              leadDate = new Date(lead.createdAt.seconds * 1000);
            } else if(typeof lead.createdAt === 'number'){
              leadDate = new Date(lead.createdAt);
            } else {
              return false;
            }
            
            // Formatar data no formato YYYY-MM
            const year = leadDate.getFullYear();
            const month = String(leadDate.getMonth() + 1).padStart(2, '0');
            const leadMonthISO = `${year}-${month}`;
            
            return leadMonthISO === mesISO;
          });
          
          console.log('[Relatorio] Total de leads no Firestore:', allLeads.length);
          console.log('[Relatorio] Leads filtrados para o m√™s', mesISO, ':', leads.length);
          if(leads.length > 0) {
            console.log('[Relatorio] Primeiro lead (exemplo):', {
              name: leads[0].name,
              plataforma: leads[0].plataforma,
              source: leads[0].source,
              question: leads[0].question
            });
          }
        }catch(err){
          console.warn('[Relatorio] Erro ao carregar leads:', err);
        }
      }

      const payload = {
        labelMonth: monthLabel,
        metas: (METAS||[]).filter(m=>m && m.ativo!==false).map(m=>{ const cur=(m.meses&&m.meses[mesISO])||{p:'',r:''}; return { descricao:m.descricao||'', unidade:m.unidade||'', direcao:m.direcao||'up', planned: normalizeMetaNumber(cur.p), realized: normalizeMetaNumber(cur.r) }; }),
        posts: posts.map(p=>({
          id: p.id||'',
          dateISO: p.dateISO||'',
          target: (p.target||'feed'),
          status: p.status||'',
          approvedBy: p.approvedBy||'',
          thumbUrl: p.thumbUrl||'',
          mediaUrls: Array.isArray(p.mediaUrls)?p.mediaUrls.slice(0,4):[]
        })),
        notes,
        socialLinks: SOCIAL_LINKS||{},
        leadsCount: leads.length,
        leadsData: leads.map(lead => ({
          name: lead.name || '',
          email: lead.email || '',
          phone: lead.phone || '',
          question: lead.question || '',
          plataforma: lead.plataforma || 'N√£o especificado',
          source: lead.source || 'N√£o especificado'
        }))
      };
      
      console.log('[Relatorio] Payload preparado:', {
        metas: payload.metas.length,
        posts: payload.posts.length,
        stories: payload.posts.filter(p => p.target === 'stories').length,
        feed: payload.posts.filter(p => (p.target||'feed') === 'feed').length,
        leadsCount: payload.leadsCount,
        leadsData: payload.leadsData.length
      });
      
      renderReportSections(payload);
      
      // Gerar preview para redes sociais (async)
      setTimeout(() => {
        generateSocialPreview(payload).catch(err => {
          console.error('[Relatorio] ‚ùå Erro ao gerar preview:', err);
        });
      }, 1000);
    }
    
    // ==================== FUN√á√ïES ====================
    
    // Fun√ß√£o para obter √≠cone da m√©trica (usa PLATFORM_LOGOS acima)
    function getMetricIcon(descricao, categoria){
      const desc = (descricao || '').toLowerCase();
      
      // Logos espec√≠ficas por palavra-chave
      if(desc.includes('instagram') || desc.includes('insta')) return PLATFORM_LOGOS.instagram;
      if(desc.includes('facebook') || desc.includes('fb')) return PLATFORM_LOGOS.facebook;
      if(desc.includes('meta') && !desc.includes('metrica')) return PLATFORM_LOGOS.meta;
      if(desc.includes('google') || desc.includes('ads') || desc.includes('adwords')) return PLATFORM_LOGOS.google;
      if(desc.includes('whatsapp') || desc.includes('wpp') || desc.includes('zap')) return PLATFORM_LOGOS.whatsapp;
      if(desc.includes('youtube') || desc.includes('yt')) return PLATFORM_LOGOS.youtube;
      if(desc.includes('tiktok') || desc.includes('tik tok')) return PLATFORM_LOGOS.tiktok;
      if(desc.includes('linkedin') || desc.includes('linked in')) return PLATFORM_LOGOS.linkedin;
      if(desc.includes('crm') || desc.includes('cliente') || desc.includes('contato')) return PLATFORM_LOGOS.crm;
      if(desc.includes('email') || desc.includes('e-mail') || desc.includes('newsletter')) return PLATFORM_LOGOS.email;
      if(desc.includes('automa√ß') || desc.includes('automacao') || desc.includes('workflow')) return PLATFORM_LOGOS.automation;
      if(desc.includes('an√∫nc') || desc.includes('anuncio') || desc.includes('campanha')) return PLATFORM_LOGOS.ads;
      if(desc.includes('analis') || desc.includes('analytic') || desc.includes('dado')) return PLATFORM_LOGOS.analytics;
      
      // Fallback por categoria
      if(categoria === 'trafego_pago') return PLATFORM_LOGOS.ads;
      if(categoria === 'canais') return PLATFORM_LOGOS.analytics;
      if(categoria === 'crm_automacoes') return PLATFORM_LOGOS.crm;
      if(categoria === 'lideranca') return PLATFORM_LOGOS.email;
      
      // Fallback padr√£o
      return PLATFORM_LOGOS.automation;
    }
    
    // Fun√ß√£o para renderizar Relat√≥rio de Performance
    function renderPerformance(metas, labelMonth, periodoTexto){
      console.log('[renderPerformance] Iniciando - metas:', metas.length, 'per√≠odo:', periodoTexto);
      
      const section = document.getElementById('relatorioPerformanceSection');
      if(!section) {
        console.error('[renderPerformance] Se√ß√£o #relatorioPerformanceSection n√£o encontrada');
        return;
      }
      
      if(!metas || metas.length === 0){
        section.style.display = 'none';
        console.log('[renderPerformance] Sem metas, ocultando se√ß√£o');
        return;
      }
      
      section.style.display = 'block';
      
      // Atualizar subtitle com per√≠odo
      const subtitle = section.querySelector('#relatorioPerformanceSubtitle');
      if(subtitle) {
        subtitle.textContent = `Vis√£o completa das m√©tricas de crescimento ‚Ä¢ ${periodoTexto || labelMonth}`;
      }
      
      // Organizar metas por categoria
      const metasPorCategoria = {
        trafego_pago: [],
        canais: [],
        crm_automacoes: [],
        lideranca: [],
        outros: []
      };
      
      metas.forEach(meta => {
        // Usar categoria que vem do payload (se existir) ou detectar automaticamente
        const categoria = meta.categoria || detectarCategoriaMeta(meta.descricao || '');
        
        if(metasPorCategoria[categoria]){
          metasPorCategoria[categoria].push({...meta, categoria}); // Garantir que categoria est√° no meta
        } else {
          metasPorCategoria.outros.push({...meta, categoria: 'outros'});
        }
      });
      
      console.log('[renderPerformance] Metas por categoria:', {
        trafego_pago: metasPorCategoria.trafego_pago.length,
        canais: metasPorCategoria.canais.length,
        crm_automacoes: metasPorCategoria.crm_automacoes.length,
        lideranca: metasPorCategoria.lideranca.length,
        outros: metasPorCategoria.outros.length
      });
      
      // Renderizar cada categoria
      renderCategoriaGrid('relatorioTrafegoGrid', metasPorCategoria.trafego_pago);
      renderCategoriaGrid('relatorioCanaisGrid', metasPorCategoria.canais);
      renderCategoriaGrid('relatorioCRMGrid', metasPorCategoria.crm_automacoes);
      renderCategoriaGrid('relatorioLiderancaGrid', metasPorCategoria.lideranca);
      renderCategoriaGrid('relatorioOutrosGrid', metasPorCategoria.outros);
    }
    
    // Detectar categoria da meta baseado na descri√ß√£o
    function detectarCategoriaMeta(descricao){
      const desc = (descricao || '').toLowerCase();
      
      // Tr√°fego Pago - PRIORIDADE M√ÅXIMA
      if(desc.includes('tr√°fego pago') || desc.includes('trafego pago') ||
         desc.includes('google ads') || desc.includes('facebook ads') || desc.includes('meta ads') || 
         desc.includes('an√∫ncio') || desc.includes('anuncio') || desc.includes('ads') ||
         desc.includes('investimento') || desc.includes('roi') ||
         desc.includes('cpa') || desc.includes('cpc') || desc.includes('cpm') ||
         desc.includes('roas') || desc.includes('convers√£o') || desc.includes('conversao') ||
         desc.includes('verba') || desc.includes('campanha') || desc.includes('lead') && (desc.includes('qualificado') || desc.includes('vendas'))){
        return 'trafego_pago';
      }
      
      // Canais (Redes Sociais, SEO, Org√¢nico)
      if(desc.includes('seo') || desc.includes('org√¢nico') || desc.includes('organico') || 
         desc.includes('conte√∫do') || desc.includes('conteudo') || 
         desc.includes('blog') || desc.includes('redes sociais') || 
         desc.includes('instagram') || desc.includes('facebook') || desc.includes('linkedin') ||
         desc.includes('youtube') || desc.includes('tiktok') || desc.includes('twitter') ||
         desc.includes('seguidores') || desc.includes('alcance') || desc.includes('engajamento') ||
         desc.includes('impress√µes') || desc.includes('impressoes') || desc.includes('visualiza') ||
         desc.includes('views') || desc.includes('coment√°rio') || desc.includes('comentario') ||
         desc.includes('salva') || desc.includes('compartilha')){
        return 'canais';
      }
      
      // CRM e Automa√ß√µes
      if(desc.includes('crm') || desc.includes('automa√ß√£o') || desc.includes('automacao') || 
         desc.includes('leads') && !desc.includes('qualificado') || desc.includes('convers√µes') || desc.includes('conversoes') || 
         desc.includes('funil') || desc.includes('pipeline') || 
         desc.includes('email') || desc.includes('whatsapp') ||
         desc.includes('contato') || desc.includes('cliente') || desc.includes('oportunidade') ||
         desc.includes('workflow') || desc.includes('sequ√™ncia') || desc.includes('sequencia') || desc.includes('nurturing')){
        return 'crm_automacoes';
      }
      
      // Lideran√ßa (Reuni√µes, Apresenta√ß√µes, KPIs)
      if(desc.includes('lideran√ßa') || desc.includes('lideranca') || 
         desc.includes('equipe') || desc.includes('time') || 
         desc.includes('produtividade') || desc.includes('gest√£o') || desc.includes('gestao') ||
         desc.includes('reuni√£o') || desc.includes('reuniao') || desc.includes('meeting') ||
         desc.includes('kpi') || desc.includes('performance') ||
         desc.includes('apresenta√ß√£o') || desc.includes('apresentacao') || desc.includes('proposta') ||
         desc.includes('alinhamento') || desc.includes('follow-up')){
        return 'lideranca';
      }
      
      // Outros (padr√£o)
      return 'outros';
    }
    
    // Renderizar grid de uma categoria
    function renderCategoriaGrid(gridId, metas){
      const grid = document.getElementById(gridId);
      if(!grid){
        console.error('[renderCategoriaGrid] Grid n√£o encontrado:', gridId);
        return;
      }
      
      // LOG SIMPLIFICADO (s√≥ primeira vez)
      if(gridId === 'relatorioTrafegoGrid'){
        console.log(`[renderPerformance] Total de metas: Tr√°fego=${metas.length}`);
      }
      
      if(!metas || metas.length === 0){
        grid.innerHTML = '<div style="padding: 20px; text-align: center; color: #94a3b8; grid-column: 1/-1;">Nenhuma m√©trica registrada nesta categoria</div>';
        return;
      }
      
      grid.innerHTML = metas.map(meta => criarCardMeta(meta)).join('');
    }
    
    // Criar HTML de um card de meta
    function criarCardMeta(meta){
      // ‚ö†Ô∏è LOG SIMPLIFICADO (n√£o usar JSON.stringify em loop)
      const realized = Number.isFinite(meta.realized) ? meta.realized : 0;
      const unidade = escapeHtml(meta.unidade || '');
      const descricao = escapeHtml(meta.descricao || 'Meta');
      const categoria = meta.categoria || 'outros';
      
      // ‚ö†Ô∏è Se n√£o tiver dados, retornar mensagem
      if(realized === 0 && (!meta.valoresPorMes || meta.valoresPorMes.length === 0)){
        return `
          <div style="background: rgba(30, 41, 59, 0.8); border: 2px solid rgba(100, 116, 139, 0.4); border-radius: 12px; padding: 16px; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.3); backdrop-filter: blur(10px);">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <div style="color: rgba(255,255,255,0.6);">üìä</div>
              <div style="font-size: 0.9rem; font-weight: 600; color: #cbd5e1;">${descricao}</div>
            </div>
            <div style="text-align: center; padding: 20px; color: #64748b; font-style: italic;">
              Sem dados registrados para este per√≠odo
            </div>
          </div>
        `;
      }
      
      // üé® Obter logo personalizada baseado na descri√ß√£o
      const platformIcon = getMetricIcon(descricao, categoria);
      
      // Formatar valor
      const formatValue = (val) => {
        if(!val || val === 0) return '‚Äî';
        if(!unidade) return val.toLocaleString('pt-BR');
        return `${val.toLocaleString('pt-BR')} ${unidade}`;
      };
      
      // Status visual baseado se tem valor ou n√£o
      let statusColor = '#64748b';
      let statusEmoji = '‚ö™';
      
      if(realized > 0){
        statusColor = '#10b981';
        statusEmoji = 'üìä';
      }
      
      // Criar HTML de compara√ß√£o mensal se houver valoresPorMes
      let comparacaoHTML = '';
      if(meta.valoresPorMes && Array.isArray(meta.valoresPorMes) && meta.valoresPorMes.length > 0){
        const meses = meta.valoresPorMes;
        
        // S√≥ mostrar compara√ß√£o se houver pelo menos 2 meses
        if(meses.length >= 2){
          comparacaoHTML = `
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255, 255, 255, 0.15);">
              <div style="font-size: 0.7rem; color: rgba(255,255,255,0.9); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">
                üìä Compara√ß√£o Mensal
              </div>
              <div style="display: flex; flex-direction: column; gap: 6px;">
          `;
          
          meses.forEach((mes, idx) => {
            const [ano, mesNum] = mes.mesISO.split('-');
            const dataCorreta = new Date(parseInt(ano), parseInt(mesNum) - 1, 15);
            const mesNome = dataCorreta.toLocaleDateString('pt-BR', {month: 'short', year: 'numeric'});
            const valor = mes.realized || 0;
            
            // Calcular varia√ß√£o com m√™s anterior
            let variacaoHTML = '';
            if(idx > 0){
              const mesAnterior = meses[idx - 1].realized || 0;
              if(mesAnterior > 0 && valor > 0){
                const variacao = ((valor - mesAnterior) / mesAnterior) * 100;
                const variacaoIcon = variacao > 0 ? 'üìà' : variacao < 0 ? 'üìâ' : '‚û°Ô∏è';
                const variacaoColor = variacao > 0 ? '#10b981' : variacao < 0 ? '#ef4444' : '#64748b';
                variacaoHTML = `
                  <span style="font-size: 0.7rem; color: ${variacaoColor}; margin-left: 8px;">
                    ${variacaoIcon} ${variacao > 0 ? '+' : ''}${variacao.toFixed(1)}%
                  </span>
                `;
              }
            }
            
            comparacaoHTML += `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0;">
                <span style="font-size: 0.75rem; color: rgba(255,255,255,0.8); font-weight: 500;">${mesNome}</span>
                <div style="display: flex; align-items: center;">
                  <span style="font-size: 0.8rem; font-weight: 700; color: #ffffff;">${formatValue(valor)}</span>
                  ${variacaoHTML}
                </div>
              </div>
            `;
          });
          
          comparacaoHTML += `
              </div>
            </div>
          `;
        } else if(meses.length === 1){
          // Se tiver apenas 1 m√™s
          const [ano, mesNum] = meses[0].mesISO.split('-');
          const dataCorreta = new Date(parseInt(ano), parseInt(mesNum) - 1, 15);
          const mesNome = dataCorreta.toLocaleDateString('pt-BR', {month: 'long', year: 'numeric'});
          comparacaoHTML = `
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255, 255, 255, 0.15);">
              <div style="font-size: 0.7rem; color: rgba(255,255,255,0.7); text-align: center; font-style: italic;">
                üìÖ Dados dispon√≠veis apenas para ${mesNome}
              </div>
            </div>
          `;
        }
      }
      
      return `
        <div style="background: rgba(30, 41, 59, 0.8); border: 2px solid ${statusColor}60; border-radius: 12px; padding: 16px; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.3); backdrop-filter: blur(10px);">
          <!-- Cabe√ßalho com √çcone da Plataforma -->
          <div style="display: flex; justify-content: space-between; align-items: start; gap: 8px; margin-bottom: 12px;">
            <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
              <div style="color: rgba(255,255,255,0.9); filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));">
                ${platformIcon}
              </div>
              <div style="font-size: 0.95rem; font-weight: 600; color: #e2e8f0; line-height: 1.4;">
                ${descricao}
              </div>
            </div>
            <div style="font-size: 1.2rem;">
              ${statusEmoji}
            </div>
          </div>
          
          <!-- Valor Principal -->
          <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05)); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 10px; padding: 16px; text-align: center;">
            <div style="font-size: 0.75rem; color: #cbd5e1; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; font-weight: 600;">Total do Per√≠odo</div>
            <div style="font-size: 2rem; font-weight: 900; color: #10b981; line-height: 1;">
              ${formatNumber(realized)}
            </div>
            ${unidade ? `<div style="font-size: 0.8rem; color: #94a3b8; margin-top: 4px; font-weight: 500;">${unidade}</div>` : ''}
          </div>
          
          ${comparacaoHTML}
        </div>
      `;
    }
    
    // Formatar n√∫mero com separador de milhares
    function formatNumber(num){
      if(!Number.isFinite(num)) return '0';
      return num.toLocaleString('pt-BR');
    }
    
    function renderReportSections(payload){
      console.log('[Relatorio] renderReportSections chamado - payload:', {
        hasPosts: Array.isArray(payload.posts),
        postsLength: Array.isArray(payload.posts) ? payload.posts.length : 0,
        hasMetas: Array.isArray(payload.metas),
        metasLength: Array.isArray(payload.metas) ? payload.metas.length : 0,
        hasGoals: payload.goals !== null && payload.goals !== undefined,
        labelMonth: payload.labelMonth,
        leadsCount: payload.leadsCount || 0
      });
      
      // Stories + Posts (feed)
      try{ 
        console.log('[Relatorio] Chamando renderStoriesAndPosts...');
        renderStoriesAndPosts(Array.isArray(payload.posts)?payload.posts:[], payload.labelMonth||''); 
      }catch(e){ 
        console.error('[Relatorio] Erro em renderStoriesAndPosts:', e); 
      }

  // Objetivos do m√™s (Planejamento)
  try{ renderGoals(payload.goals||null, payload.labelMonth||''); }catch(e){ console.warn('renderGoals', e); }

  // Relat√≥rio de Performance (substitui Metas)
  try{ 
    console.log('[Relatorio] Chamando renderPerformance...');
    console.log('[Relatorio] payload.metas:', Array.isArray(payload.metas) ? payload.metas.length : 'n√£o √© array');
    if(Array.isArray(payload.metas) && payload.metas.length > 0){
      console.log('[Relatorio] Primeira meta:', JSON.stringify(payload.metas[0], null, 2));
    }
    renderPerformance(Array.isArray(payload.metas)?payload.metas:[], payload.labelMonth||'', payload.periodoTexto||''); 
  }catch(e){ 
    console.error('[Relatorio] Erro em renderPerformance:', e); 
  }

      // Leads Gerados
      const leadsSection = document.getElementById('relatorioLeadsSection');
      const leadsSubtitle = document.getElementById('relatorioLeadsSubtitle');
      const leadsCount = document.getElementById('relatorioLeadsCount');
      const leadsDesc = document.getElementById('relatorioLeadsDesc');
      const leadCount = typeof payload.leadsCount === 'number' ? payload.leadsCount : 0;
      const leadsDataArray = Array.isArray(payload.leadsData) ? payload.leadsData : [];
      
      if(leadCount > 0 || TENANT){
        leadsSection.style.display='block';
        if(leadsSubtitle) leadsSubtitle.textContent = `Leads captados em ${payload.labelMonth||''}`;
        if(leadsCount) leadsCount.textContent = leadCount;
        
        // Se h√° an√°lise no payload (novo formato) ou dados detalhados, mostrar an√°lise
        const analysis = payload.leadsAnalysis;
        if(analysis || leadsDataArray.length > 0) {
          const leadsAnalysisEl = document.getElementById('relatorioLeadsAnalysis');
          const leadsPlatforms = document.getElementById('relatorioLeadsPlatforms');
          const leadsSources = document.getElementById('relatorioLeadsSources');
          const leadsQuestions = document.getElementById('relatorioLeadsQuestions');
          const leadsAIAnalysis = document.getElementById('relatorioLeadsAIAnalysis');
          
          // Usar an√°lise do payload se dispon√≠vel, sen√£o calcular
          let platforms, sources, topQuestions;
          
          if(analysis) {
            // Usar dados pr√©-processados do payload
            platforms = analysis.platforms || [];
            sources = analysis.sources || [];
            topQuestions = analysis.topQuestions || [];
          } else {
            // Fallback: calcular da leadsData (compatibilidade com payloads antigos)
            const platformStats = {};
            leadsDataArray.forEach(lead => {
              const platform = (lead.plataforma || 'N√£o especificado').toString().trim();
              platformStats[platform] = (platformStats[platform] || 0) + 1;
            });
            
            const sourceStats = {};
            leadsDataArray.forEach(lead => {
              const source = (lead.source || 'N√£o especificado').toString().trim();
              sourceStats[source] = (sourceStats[source] || 0) + 1;
            });
            
            const questionStats = {};
            leadsDataArray.forEach(lead => {
              const question = (lead.question || '').toString().trim();
              if(question && question.length > 0) {
                questionStats[question] = (questionStats[question] || 0) + 1;
              }
            });
            
            platforms = Object.entries(platformStats)
              .sort((a, b) => b[1] - a[1])
              .map(([name, count]) => ({
                name,
                count,
                percent: Math.round((count / leadCount) * 100),
                emoji: name.toLowerCase().includes('google') ? 'üîç' : 
                       name.toLowerCase().includes('meta') ? 'üìò' : 'üì±'
              }));
            
            sources = Object.entries(sourceStats)
              .sort((a, b) => b[1] - a[1])
              .map(([name, count]) => ({
                name,
                count,
                percent: Math.round((count / leadCount) * 100),
                emoji: 'üåê'
              }));
            
            topQuestions = Object.entries(questionStats)
              .sort((a, b) => b[1] - a[1])
              .slice(0, 5)
              .map(([question, count]) => ({
                question,
                count,
                percent: Math.round((count / leadCount) * 100)
              }));
          }
          
          // Renderizar plataformas
          if(leadsPlatforms) {
            leadsPlatforms.innerHTML = platforms.map(p => {
              return `<div class="goal-pill" style="border-color: rgba(99, 102, 241, 0.4); background: rgba(99, 102, 241, 0.15);">
                ${p.emoji} ${p.name}: <strong>${p.count}</strong> <span style="opacity: 0.7;">(${p.percent}%)</span>
              </div>`;
            }).join('');
          }
          
          // Renderizar fontes
          if(leadsSources) {
            leadsSources.innerHTML = sources.map(s => {
              return `<div class="goal-pill" style="border-color: rgba(16, 185, 129, 0.4); background: rgba(16, 185, 129, 0.15);">
                ${s.emoji} ${s.name}: <strong>${s.count}</strong> <span style="opacity: 0.7;">(${s.percent}%)</span>
              </div>`;
            }).join('');
          }
          
          // Renderizar perguntas
          if(leadsQuestions) {
            if(topQuestions.length === 0) {
              leadsQuestions.innerHTML = '<div style="color: #94a3b8; font-size: 0.9rem; padding: 8px;">Nenhuma pergunta registrada</div>';
            } else {
              leadsQuestions.innerHTML = topQuestions.map((q, index) => {
                return `<div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; padding: 10px 12px;">
                  <div style="display: flex; align-items: start; gap: 8px;">
                    <span style="color: #fbbf24; font-weight: 800; font-size: 1.1rem; flex-shrink: 0;">${index + 1}.</span>
                    <div style="flex: 1;">
                      <div style="color: #e2e8f0; margin-bottom: 4px; line-height: 1.4;">${escapeHtml(q.question)}</div>
                      <div style="color: #94a3b8; font-size: 0.85rem;">
                        <strong style="color: #60a5fa;">${q.count}</strong> ${q.count === 1 ? 'pergunta' : 'perguntas'} 
                        <span style="opacity: 0.7;">(${q.percent}% dos leads)</span>
                      </div>
                    </div>
                  </div>
                </div>`;
              }).join('');
            }
          }
          
          // IA Insights
          if(leadsAIAnalysis) {
            const insights = [];
            const avgLeadsPerDay = (leadCount / 30).toFixed(1);
            insights.push(`üìä <strong>Volume:</strong> ${leadCount} leads gerados em ${payload.labelMonth||''}, com m√©dia de ${avgLeadsPerDay} leads/dia.`);
            
            if(platforms.length > 0) {
              const topPlatform = platforms[0];
              insights.push(`üì± <strong>Plataforma l√≠der:</strong> ${topPlatform.name} com ${topPlatform.count} leads (${topPlatform.percent}% do total).`);
              
              if(platforms.length > 1 && topPlatform.percent >= 70) {
                insights.push(`üí° <strong>Recomenda√ß√£o:</strong> H√° uma forte concentra√ß√£o em ${topPlatform.name}. Considere diversificar investimentos em outras plataformas.`);
              }
            }
            
            if(sources.length > 0) {
              const topSource = sources[0];
              insights.push(`üåê <strong>Fonte principal:</strong> ${topSource.name} com ${topSource.count} leads (${topSource.percent}% do total).`);
            }
            
            // Calcular engajamento (leads com pergunta)
            let leadsComPergunta = 0;
            if(analysis && analysis.topQuestions) {
              leadsComPergunta = analysis.topQuestions.reduce((sum, q) => sum + q.count, 0);
            } else if(leadsDataArray.length > 0) {
              leadsComPergunta = leadsDataArray.filter(l => (l.question || '').toString().trim().length > 0).length;
            }
            
            const engagementRate = leadCount > 0 ? Math.round((leadsComPergunta / leadCount) * 100) : 0;
            insights.push(`üí¨ <strong>Engajamento:</strong> ${engagementRate}% dos leads deixaram perguntas (${leadsComPergunta} de ${leadCount}).`);
            
            if(engagementRate < 30) {
              insights.push(`‚ö†Ô∏è <strong>Aten√ß√£o:</strong> Taxa de engajamento baixa. Considere revisar os formul√°rios ou calls-to-action.`);
            } else if(engagementRate >= 70) {
              insights.push(`‚úÖ <strong>Excelente:</strong> Alta taxa de engajamento! Os leads est√£o demonstrando interesse genu√≠no.`);
            }
            
            if(platforms.length >= 2) {
              insights.push(`üéØ <strong>Diversifica√ß√£o:</strong> Leads provenientes de ${platforms.length} plataformas diferentes, demonstrando boa distribui√ß√£o de canais.`);
            }
            
            if(topQuestions.length > 0) {
              const topQuestion = topQuestions[0];
              insights.push(`‚ùì <strong>Principal d√∫vida:</strong> "${topQuestion.question}" apareceu ${topQuestion.count} ${topQuestion.count === 1 ? 'vez' : 'vezes'}. Considere criar conte√∫do ou FAQ abordando este tema.`);
            }
            
            leadsAIAnalysis.innerHTML = insights.map(insight => 
              `<div style="margin-bottom: 10px; padding-left: 4px; border-left: 3px solid rgba(168, 85, 247, 0.5);">${insight}</div>`
            ).join('');
          }
          
          if(leadsAnalysisEl) leadsAnalysisEl.style.display = 'block';

          const platformCount = Array.isArray(platforms) ? platforms.length : 0;
          const sourceCount = Array.isArray(sources) ? sources.length : 0;
          if(leadsDesc) leadsDesc.textContent = `üéØ Total de ${leadCount} lead${leadCount === 1 ? '' : 's'} gerado${leadCount === 1 ? '' : 's'} durante ${payload.labelMonth||''} atrav√©s de ${platformCount} plataforma${platformCount === 1 ? '' : 's'} e ${sourceCount} fonte${sourceCount === 1 ? '' : 's'} diferente${sourceCount === 1 ? '' : 's'}.`;
        } else {
          if(leadsDesc) leadsDesc.textContent = `üéØ Total de ${leadCount} lead${leadCount === 1 ? '' : 's'} gerado${leadCount === 1 ? '' : 's'} durante ${payload.labelMonth||''}.`;
        }
      } else {
        leadsSection.style.display='none';
      }

      // Redes
      const redesSection = document.getElementById('relatorioRedesSection');
      const redesGrid = document.getElementById('relatorioRedesGrid');
      const redesSub = document.getElementById('relatorioRedesSubtitle');
      const redesDesc = document.getElementById('relatorioRedesDesc');
      const socialArray = Array.isArray(payload.social) ? payload.social.filter(i=> i && i.href) : [];
      const entries = socialArray.length ? socialArray : Object.entries(payload.socialLinks||{}).filter(([,url])=> !!url).map(([label, href])=> ({ label, href }));
      if(entries.length){
        redesSection.style.display='block';
        redesSub.textContent = 'Redes conectadas no cliente (clique para acessar)';
        redesDesc.textContent = `üìå ${entries.length} rede${entries.length===1?'':'s'} com link configurado ‚Äî ${payload.labelMonth||''}`;
        const frag = document.createDocumentFragment();
        entries.forEach(item=>{
          const label = item.label || (Array.isArray(item) ? item[0] : 'Rede');
          const href = item.href || (Array.isArray(item) ? item[1] : '');
          const card = document.createElement('div'); card.className='macro-social-item';
          const icon = document.createElement('div'); icon.className='macro-social-icon';
          const info = document.createElement('div'); info.className='macro-social-info';
          const l = document.createElement('span'); l.className='macro-social-label'; l.textContent = label||'Rede';
          const d = document.createElement('span'); d.className='macro-social-detail'; d.textContent='Link conectado';
          info.append(l,d);
          const actions = document.createElement('div'); actions.className='macro-social-actions';
          const open = document.createElement('button'); open.className='btn small'; open.type='button'; open.textContent='Abrir';
          open.addEventListener('click', ()=>{ try{ const w=window.open(href,'_blank','noopener'); if(w) w.opener=null; else location.href=href; }catch{ location.href=href; } });
          actions.appendChild(open);
          // √≠cone com base no snapshot do header (se dispon√≠vel)
          if(item.iconInfo && item.iconInfo.type==='img' && item.iconInfo.src){
            const img = document.createElement('img'); img.src = item.iconInfo.src; img.alt = item.iconInfo.alt || label; icon.appendChild(img);
          } else if(item.iconInfo && item.iconInfo.type==='text' && item.iconInfo.text){
            icon.textContent = item.iconInfo.text; if(item.iconInfo.fontSize){ icon.style.fontSize = item.iconInfo.fontSize; }
          } else {
            // fallback: primeira letra
            icon.textContent = (label||'?').slice(0,1).toUpperCase();
          }
          card.append(icon, info, actions); frag.appendChild(card);
        });
        redesGrid.replaceChildren(frag);
      } else {
        redesSection.style.display='none';
      }
      
      // Gerar resumo em texto
      gerarResumoTexto(payload);
    }
    
    // Gera resumo em texto copi√°vel
    function gerarResumoTexto(payload){
      const resumoSection = document.getElementById('relatorioResumoTextoSection');
      const resumoContent = document.getElementById('relatorioResumoTextoContent');
      const btnCopiar = document.getElementById('btnCopiarResumo');
      
      if(!resumoSection || !resumoContent) return;
      
      const mesLabel = payload.labelMonth || mesISO || '';
      
      let resumo = `üìä RESUMO DO RELAT√ìRIO - ${mesLabel.toUpperCase()}\n`;
      resumo += `${'='.repeat(60)}\n\n`;
      
      // Stories e Posts - USAR DADOS DO PAYLOAD ao inv√©s do DOM
      const allPosts = Array.isArray(payload.posts) ? payload.posts : [];
      const storiesCount = allPosts.filter(p => p.target === 'stories').length;
      const postsCount = allPosts.length - storiesCount;
      
      resumo += `üì∏ STORIES PUBLICADOS\n`;
      resumo += `   Quantidade: ${storiesCount} ${storiesCount === 1 ? 'story' : 'stories'}\n\n`;
      
      resumo += `üì± POSTS DE FEED PUBLICADOS\n`;
      resumo += `   Quantidade: ${postsCount} ${postsCount === 1 ? 'post' : 'posts'}\n\n`;
      
      // Objetivos (Planejamento) - usar payload
      const goals = payload.goals || {};
      const goalsSummary = goals.summary || {};
      const goalsTotal = goalsSummary.total || 0;
      const goalsDone = goalsSummary.done || 0;
      const goalsProgress = goalsSummary.progress || 0;
      const goalsTodo = goalsSummary.todo || 0;
      
      if(goalsTotal > 0) {
        resumo += `üéØ OBJETIVOS DO M√äS (PLANEJAMENTO)\n`;
        resumo += `   Total de objetivos: ${goalsTotal}\n`;
        resumo += `   ‚úÖ Conclu√≠dos: ${goalsDone}\n`;
        resumo += `   üîÑ Em andamento: ${goalsProgress}\n`;
        resumo += `   ‚è≥ N√£o iniciados: ${goalsTodo}\n`;
        
        if(goalsTotal > 0) {
          const percentConcluido = Math.round((goalsDone / goalsTotal) * 100);
          resumo += `   Taxa de conclus√£o: ${percentConcluido}%\n`;
        }
        resumo += `\n`;
      }
      
      // Metas - usar payload
      const metas = Array.isArray(payload.metas) ? payload.metas : [];
      const metasAchieved = metas.filter(m => m.status === 'achieved').length;
      const metasProgress = metas.filter(m => m.status === 'progress').length;
      const metasMissing = metas.filter(m => m.status === 'missing').length;
      const metasTotal = metas.length;
      
      if(metasTotal > 0) {
        resumo += `ÔøΩ RELAT√ìRIO DE PERFORMANCE\n`;
        resumo += `   Total de m√©tricas: ${metasTotal}\n`;
        resumo += `   ‚úÖ Atingidas: ${metasAchieved}\n`;
        resumo += `   üîÑ Em andamento: ${metasProgress}\n`;
        resumo += `   ‚ö†Ô∏è Abaixo do esperado: ${metasMissing}\n`;
        
        if(metasTotal > 0) {
          const percentAtingido = Math.round((metasAchieved / metasTotal) * 100);
          resumo += `   Taxa de atingimento: ${percentAtingido}%\n`;
        }
        resumo += `\n`;
      }
      
      // Leads - usar payload.leadsAnalysis
      const leadsCount = payload.leadsCount || 0;
      
      if(leadsCount > 0) {
        resumo += `üéØ LEADS GERADOS\n`;
        resumo += `   Total de leads: ${leadsCount}\n`;
        
        // Usar an√°lise do payload se dispon√≠vel
        const analysis = payload.leadsAnalysis || {};
        
        // Plataformas
        if(analysis.platforms && analysis.platforms.length > 0) {
          resumo += `\n   Por Plataforma:\n`;
          analysis.platforms.forEach(p => {
            resumo += `   ${p.emoji} ${p.name}: ${p.count} (${p.percent}%)\n`;
          });
        }
        
        // Fontes
        if(analysis.sources && analysis.sources.length > 0) {
          resumo += `\n   Por Fonte:\n`;
          analysis.sources.forEach(s => {
            resumo += `   ${s.emoji} ${s.name}: ${s.count} (${s.percent}%)\n`;
          });
        }
        
        // Top perguntas
        if(analysis.topQuestions && analysis.topQuestions.length > 0) {
          resumo += `\n   Principais Perguntas:\n`;
          analysis.topQuestions.forEach((q, idx) => {
            resumo += `   ${idx + 1}. ${q.question} (${q.count} ${q.count === 1 ? 'lead' : 'leads'})\n`;
          });
        }
        
        resumo += `\n`;
      }
      
      // Redes trabalhadas - usar payload
      const redes = Array.isArray(payload.redes) ? payload.redes : [];
      const redesCount = redes.length;
      if(redesCount > 0) {
        resumo += `üîó REDES TRABALHADAS\n`;
        resumo += `   Quantidade: ${redesCount} ${redesCount === 1 ? 'rede' : 'redes'} com link configurado\n\n`;
      }
      
      // Rodap√©
      resumo += `${'='.repeat(60)}\n`;
      resumo += `Relat√≥rio gerado em ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}\n`;
      
      resumoContent.textContent = resumo;
      resumoSection.style.display = 'block';
      
      // Evento de copiar
      if(btnCopiar && !btnCopiar.dataset.listenerAdded){
        btnCopiar.dataset.listenerAdded = 'true';
        btnCopiar.addEventListener('click', async ()=>{
          const texto = resumoContent.textContent;
          try {
            // Usar fun√ß√£o robusta de clipboard com fallback para iframes
            const copiado = await mgCopyToClipboard(texto);
            if(copiado) {
              const original = btnCopiar.textContent;
              btnCopiar.textContent = '‚úÖ Copiado!';
              btnCopiar.style.background = 'rgba(16, 185, 129, 0.3)';
              btnCopiar.style.borderColor = 'rgba(16, 185, 129, 0.5)';
              setTimeout(() => {
                btnCopiar.textContent = original;
                btnCopiar.style.background = '';
                btnCopiar.style.borderColor = '';
              }, 2000);
            } else {
              alert('N√£o foi poss√≠vel copiar. Tente selecionar e copiar manualmente.');
            }
          } catch(err) {
            console.error('Erro ao copiar:', err);
            alert('Erro ao copiar. Tente selecionar e copiar manualmente.');
          }
        });
      }
    }

    // === Sistema de gera√ß√£o autom√°tica de thumbnails para v√≠deos ===
    const VIDEO_THUMBNAILS_CACHE = new Map();

    async function generateVideoThumbnail(videoUrl, postId) {
      // ‚ö†Ô∏è FUN√á√ÉO DESABILITADA: Previne loops de erro MEDIA_ELEMENT_ERROR
      console.log('[Relatorio] ‚ö†Ô∏è generateVideoThumbnail DESABILITADA - retornando null');
      return null;
      
      // C√ìDIGO ORIGINAL COMENTADO PARA REFER√äNCIA:
      /*
      console.log('[Relatorio] Gerando thumbnail para:', videoUrl);
      
      // ‚ö†Ô∏è Validar URL antes de tentar gerar thumbnail
      if(!videoUrl || videoUrl.trim() === ''){
        console.warn('[Relatorio] ‚ö†Ô∏è URL de v√≠deo vazia/inv√°lida, retornando fallback');
        return '/assets/video-placeholder.jpg'; // ou null
      }
      
      if (VIDEO_THUMBNAILS_CACHE.has(videoUrl)) {
        console.log('[Relatorio] Retornando do cache');
        return VIDEO_THUMBNAILS_CACHE.get(videoUrl);
      }

      // Tenta duas vezes: primeiro sem CORS, depois com CORS se falhar
      const tryGenerate = (useCors = false) => {
        return new Promise((resolve, reject) => {
          const video = document.createElement('video');
          video.preload = 'metadata';
          video.muted = true;
          video.playsInline = true;
          if (useCors) {
            video.crossOrigin = 'anonymous';
            console.log('[Relatorio] Tentando com crossOrigin=anonymous');
          }
          
          const timeout = setTimeout(() => {
            console.error('[Relatorio] Timeout ao carregar v√≠deo (useCors:', useCors, ')');
            video.src = '';
            reject(new Error('Timeout ao gerar thumbnail'));
          }, 20000); // 20s timeout

          video.onloadedmetadata = () => {
            console.log('[Relatorio] Metadata carregada, dura√ß√£o:', video.duration, 'dimens√µes:', video.videoWidth, 'x', video.videoHeight);
            const seekTime = Math.min(0.5, video.duration * 0.1);
            video.currentTime = seekTime;
          };
          
          video.onseeked = () => {
            console.log('[Relatorio] Frame encontrado, capturando canvas...');
            try {
              clearTimeout(timeout);
              
              const canvas = document.createElement('canvas');
              canvas.width = video.videoWidth || 640;
              canvas.height = video.videoHeight || 360;
              
              const ctx = canvas.getContext('2d', { willReadFrequently: false });
              ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
              
              const thumbnailDataUrl = canvas.toDataURL('image/jpeg', 0.8);
              
              console.log('[Relatorio] ‚úÖ Thumbnail gerada com sucesso! Tamanho:', thumbnailDataUrl.length, 'bytes');
              
              VIDEO_THUMBNAILS_CACHE.set(videoUrl, thumbnailDataUrl);
              video.src = '';
              
              resolve(thumbnailDataUrl);
            } catch (err) {
              clearTimeout(timeout);
              console.error('[Relatorio] ‚ùå Erro ao capturar frame do canvas:', err);
              video.src = '';
              reject(err);
            }
          };
          
          video.onerror = (err) => {
            clearTimeout(timeout);
            console.error('[Relatorio] ‚ùå Erro ao carregar v√≠deo:', err, 'errorCode:', video.error?.code, 'message:', video.error?.message);
            video.src = '';
            reject(err);
          };
          
          // Garante HTTPS
          let safeUrl = videoUrl;
          if (videoUrl.includes('firebasestorage.googleapis.com') && videoUrl.startsWith('http://')) {
            safeUrl = videoUrl.replace('http://', 'https://');
            console.log('[Relatorio] URL convertida para HTTPS:', safeUrl);
          }
          
          // ‚ö†Ô∏è N√ÉO setar src se a URL estiver vazia (evita erro MEDIA_ELEMENT_ERROR)
          if(!safeUrl || safeUrl.trim() === ''){
            console.warn('[Relatorio] ‚ö†Ô∏è videoUrl vazio, pulando gera√ß√£o de thumbnail');
            clearTimeout(timeout);
            reject(new Error('URL de v√≠deo vazia'));
            return;
          }
          
          video.src = safeUrl;
        });
      };

      // Tenta sem CORS primeiro, depois com CORS se falhar
      try {
        return await tryGenerate(false);
      } catch (err) {
        console.warn('[Relatorio] Primeira tentativa falhou, tentando com CORS...');
        return await tryGenerate(true);
      }
      */
    }

    // Lazy + throttled thumbnail generation para reduzir jank
    const THUMB_QUEUE = [];
    let THUMB_WORKERS = 0;
    const MAX_WORKERS = 2;
    let thumbObserver = null;

    function startThumbWorkers(){
      while(THUMB_WORKERS < MAX_WORKERS && THUMB_QUEUE.length){
        const container = THUMB_QUEUE.shift();
        if(!container || container.dataset.thumbProcessing==='1') continue;
        THUMB_WORKERS++;
        container.dataset.thumbProcessing = '1';
        // Micro-yield para n√£o travar
        requestAnimationFrame(()=> processContainerThumbnail(container).finally(()=>{
          THUMB_WORKERS = Math.max(0, THUMB_WORKERS-1);
          // Continua fila
          if(THUMB_QUEUE.length){ startThumbWorkers(); }
        }));
      }
    }

    async function processContainerThumbnail(container){
      try{
        if(!container || container.classList.contains('has-thumb')) return;
        const videoUrl = container.getAttribute('data-video-url');
        const postId = container.getAttribute('data-id');
        console.log('[Relatorio] Processando thumbnail - postId:', postId, 'url:', videoUrl);
        
        if(!videoUrl) {
          console.warn('[Relatorio] Container sem data-video-url, ignorando');
          return;
        }
        
        // Evita duplicado
        if(container.querySelector('img')){ 
          console.log('[Relatorio] Container j√° tem img, marcando como processado');
          container.classList.add('has-thumb'); 
          return; 
        }
        
        const thumbnailUrl = await generateVideoThumbnail(videoUrl, postId);
        
        if (container.getAttribute('data-video-url') !== videoUrl) {
          console.warn('[Relatorio] URL mudou durante processamento, abortando');
          return; // mudou
        }
        
        const img = document.createElement('img');
        img.src = thumbnailUrl;
        img.alt = 'Video preview';
        img.decoding = 'async';
        img.loading = 'lazy';
        img.style.cssText = 'width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0;display:block;background:#000';
        
        // Trata erro de carregamento da imagem
        img.onerror = () => {
          console.warn('[Relatorio] ‚ùå Erro ao exibir thumbnail gerada, usando fallback de √≠cone');
          img.remove();
          addVideoPlayIcon(container);
        };
        
        img.onload = () => {
          console.log('[Relatorio] ‚úÖ Thumbnail exibida com sucesso para postId:', postId);
        };
        
        const span = container.querySelector('span'); 
        if(span) span.remove();
        container.appendChild(img);
        container.classList.add('has-thumb');
        
      }catch(err){
        console.error('[Relatorio] ‚ùå Falha ao gerar thumbnail:', err.message, 'para postId:', container?.getAttribute('data-id'));
        // Adiciona indicador visual de que √© um v√≠deo mesmo que falhe
        if(container && !container.classList.contains('has-thumb')){
          addVideoPlayIcon(container);
        }
      }finally{
        if(container) delete container.dataset.thumbProcessing;
      }
    }

    function addVideoPlayIcon(container) {
      const playIcon = document.createElement('div');
      playIcon.style.cssText = 'position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:3rem;color:#fff;text-shadow:0 2px 8px rgba(0,0,0,.8);pointer-events:none;z-index:1;';
      playIcon.textContent = '‚ñ∂';
      container.appendChild(playIcon);
      container.classList.add('has-thumb');
      console.log('[Relatorio] √çcone de play adicionado como fallback');
    }

    function enqueueContainer(c){
      if(!c || c.classList.contains('has-thumb')) return;
      THUMB_QUEUE.push(c);
      startThumbWorkers();
    }

    function applyVideoThumbnails() {
      // ‚ö†Ô∏è DESABILITADO: Gera√ß√£o de thumbnails de v√≠deo causa erros em loop
      console.log('[Relatorio] ‚ö†Ô∏è Gera√ß√£o de thumbnails de v√≠deo DESABILITADA (previne loops de erro)');
      
      // Apenas adicionar √≠cone de play em v√≠deos
      const items = document.querySelectorAll('.relatorio-story-item[data-video-url]');
      items.forEach(container => {
        if(!container.classList.contains('has-thumb')){
          addVideoPlayIcon(container);
        }
      });
      
      return; // ‚Üê RETORNA AQUI, n√£o executa o c√≥digo abaixo
      
      // C√ìDIGO ORIGINAL (DESABILITADO):
      /*
      const items = document.querySelectorAll('.relatorio-story-item[data-video-url]');
      if('IntersectionObserver' in window){
        if(!thumbObserver){
          thumbObserver = new IntersectionObserver((entries)=>{
            entries.forEach(entry=>{
              const el = entry.target;
              if(entry.isIntersecting){
                thumbObserver.unobserve(el);
                enqueueContainer(el);
              }
            });
          }, { root:null, rootMargin:'200px 0px', threshold:0.01 });
        }
        items.forEach(el=>{ if(!el.dataset.thumbObserved){ el.dataset.thumbObserved='1'; thumbObserver.observe(el); } });
      }else{
        // Fallback: processa todos, com fila
        items.forEach(el=> enqueueContainer(el));
      }
      */
    }

    function renderStoriesAndPosts(posts, labelMonth){
      console.log('[Relatorio] renderStoriesAndPosts chamado - total posts:', posts.length);
      const monthLabel = labelMonth || document.getElementById('reportMonth').textContent || '';
      const parts = monthLabel.split(' ');
      const ano = parts.length>1 ? parts[1] : '';
      // Split
      const stories = posts.filter(p=> (p.target||'feed')==='stories');
      const feed = posts.filter(p=> (p.target||'feed')==='feed');
      
      console.log('[Relatorio] Stories encontrados:', stories.length);
      console.log('[Relatorio] Posts de feed encontrados:', feed.length);
      
      if(stories.length > 0){
        console.log('[Relatorio] Primeiro story:', stories[0]);
      }
      if(feed.length > 0){
        console.log('[Relatorio] Primeiro post:', feed[0]);
      }

      // Helper para garantir HTTPS nas URLs do Firebase Storage
      const ensureHttps = (url) => {
        if (!url) return '';
        const urlStr = String(url);
        if ((urlStr.includes('firebasestorage.googleapis.com') || urlStr.includes('firebasestorage.app')) && urlStr.startsWith('http://')) {
          return urlStr.replace('http://', 'https://');
        }
        return urlStr;
      };

      // Helpers
      const buildCard = (p)=>{
        const [y,m,d] = String(p.dateISO||'').split('-');
        const dateLabel = (d&&m)? `${d}/${m}` : '';
        
        // Determinar se √© v√≠deo baseado no mediaUrls[0] (primeira m√≠dia)
        const firstMedia = (Array.isArray(p.mediaUrls) && p.mediaUrls[0]) || '';
        const firstMediaExt = String(firstMedia).split('?')[0].split('.').pop().toLowerCase();
        const isVideo = ['mp4','mov','webm','m4v','avi'].includes(firstMediaExt);
        
        // Determinar thumbnail a usar
        let thumbnailUrl = '';
        
        // Prioridade 1: Se tem thumbUrl (capa personalizada/gerada), usar ela
        if(p.thumbUrl) {
          thumbnailUrl = ensureHttps(p.thumbUrl);
          console.log(`[buildCard] Post ${p.id}: thumbUrl encontrada:`, p.thumbUrl.substring(0, 80));
        }
        // Prioridade 2: Se n√£o tem thumbUrl mas tem mediaUrls[0] e n√£o √© v√≠deo, usar primeira m√≠dia
        else if(firstMedia && !isVideo) {
          thumbnailUrl = ensureHttps(firstMedia);
          console.log(`[buildCard] Post ${p.id}: usando primeira m√≠dia (imagem)`);
        }
        // Prioridade 3: V√≠deo sem thumbnail - n√£o renderiza imagem (s√≥ √≠cone de play ser√° adicionado)
        else if(isVideo && firstMedia) {
          console.log(`[buildCard] Post ${p.id}: v√≠deo SEM thumbnail - precisa gerar`);
        }
        
        // Classes CSS
        let cls = 'relatorio-story-item';
        if((p.status||'')==='aprovado'){
          cls += (p.approvedBy==='interno')? ' aprovado-interno':' aprovado';
        } else if((p.status||'')==='revisar'){
          cls += ' revisar';
        } else {
          cls += ' pendente';
        }
        if(isVideo) cls += ' video';
        
        // Renderizar card
        const imgTag = thumbnailUrl 
          ? `<img src="${thumbnailUrl}" alt="${(p.target||'')==='stories'?'Story':'Post'} ${dateLabel}" loading="lazy">` 
          : '';
        
        const videoAttr = (isVideo && !thumbnailUrl && firstMedia) 
          ? ` data-video-url="${ensureHttps(firstMedia)}"` 
          : '';
        
        return `<div class="${cls}" data-id="${p.id||''}"${videoAttr}>${imgTag}<div class="relatorio-story-status"></div><div class="relatorio-story-date">${dateLabel}</div></div>`;
      };

      // Stories section
      const s = els.stories; if(s && s.section){
        if(stories.length){
          s.section.style.display='block';
          if(s.subtitle){
            const meses = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
            let mesNome = '';
            try{ const match = monthLabel.match(/^(\p{L}+)/u); mesNome = match?match[1]:monthLabel; }catch(_){ mesNome = monthLabel; }
            s.subtitle.textContent = `${stories.length} ${stories.length===1?'story':'stories'} produzid${stories.length===1?'o':'os'} em ${monthLabel}`;
          }
          if(s.desc){
            const total = stories.length;
            const aprov = stories.filter(p=> (p.status||'')==='aprovado').length;
            const revisar = stories.filter(p=> (p.status||'')==='revisar').length;
            const pend = Math.max(0, total - aprov - revisar);
            const rate = total>0 ? Math.round((aprov/total)*100) : 0;
            s.desc.style.display='block';
            s.desc.textContent = `‚ú® ${monthLabel}: ${total} ${total===1?'story':'stories'} ‚Äî ${aprov} aprovados (${rate}%), ${revisar} para revisar, ${pend} pendentes.`;
          }
          s.grid.innerHTML = stories.sort((a,b)=> String(a.dateISO||'').localeCompare(String(b.dateISO||''))).map(buildCard).join('');
          s.prev?.addEventListener('click', ()=> s.grid.scrollBy({left:-200, behavior:'smooth'}));
          s.next?.addEventListener('click', ()=> s.grid.scrollBy({left: 200, behavior:'smooth'}));
          
          // Gera thumbnails para v√≠deos
          setTimeout(() => {
            console.log('[Relatorio] Aplicando thumbnails aos stories');
            applyVideoThumbnails();
          }, 100);
        } else {
          s.section.style.display='none';
        }
      }

      // Posts section
      const psec = els.posts; if(psec && psec.section){
        if(feed.length){
          psec.section.style.display='block';
          if(psec.subtitle){
            psec.subtitle.textContent = `${feed.length} ${feed.length===1?'post':'posts'} produzid${feed.length===1?'o':'os'} em ${monthLabel}`;
          }
          if(psec.desc){
            const total = feed.length;
            const aprov = feed.filter(p=> (p.status||'')==='aprovado').length;
            const revisar = feed.filter(p=> (p.status||'')==='revisar').length;
            const pend = Math.max(0, total - aprov - revisar);
            const rate = total>0 ? Math.round((aprov/total)*100) : 0;
            psec.desc.style.display='block';
            psec.desc.textContent = `‚ú® ${monthLabel}: ${total} ${total===1?'post':'posts'} no feed ‚Äî ${aprov} aprovados (${rate}%), ${revisar} para revisar, ${pend} pendentes.`;
          }
          psec.grid.innerHTML = feed.sort((a,b)=> String(a.dateISO||'').localeCompare(String(b.dateISO||''))).map(buildCard).join('');
          psec.prev?.addEventListener('click', ()=> psec.grid.scrollBy({left:-200, behavior:'smooth'}));
          psec.next?.addEventListener('click', ()=> psec.grid.scrollBy({left: 200, behavior:'smooth'}));
          
          // Gera thumbnails para v√≠deos
          setTimeout(() => {
            console.log('[Relatorio] Aplicando thumbnails aos posts');
            applyVideoThumbnails();
          }, 150);
        } else {
          psec.section.style.display='none';
        }
      }
    }

    function renderGoals(goals, labelMonth){
      const g = els.goals; if(!g || !g.section) return;
      if(!goals || !Array.isArray(goals.items) || goals.items.length===0){ g.section.style.display='none'; return; }
      g.section.style.display='block';
      const total = Number(goals.summary?.total)||goals.items.length;
      const done = Number(goals.summary?.done)||0;
      const progress = Number(goals.summary?.progress)||0;
      const todo = Number(goals.summary?.todo)||0;
      if(g.subtitle) g.subtitle.textContent = `Resumo de ${total} objetivo${total===1?'':'s'} em ${labelMonth}`;
      g.donePill?.querySelector('strong')?.replaceWith(Object.assign(document.createElement('strong'),{textContent:String(done)}));
      g.progressPill?.querySelector('strong')?.replaceWith(Object.assign(document.createElement('strong'),{textContent:String(progress)}));
      g.todoPill?.querySelector('strong')?.replaceWith(Object.assign(document.createElement('strong'),{textContent:String(todo)}));
      if(g.desc){
        const rate = total>0 ? Math.round((done/total)*100) : 0;
        g.desc.textContent = `üöÄ ${labelMonth}: ${total} objetivo${total===1?'':'s'} ‚Äî Conclu√≠dos: ${done} (${rate}%), Em andamento: ${progress}, N√£o iniciados: ${todo}.`;
      }
      const groups = { 'concluido':[], 'em-andamento':[], 'nao-iniciado':[] };
      goals.items.forEach(item=>{
        const st = (item.status||'').toLowerCase();
        const key = (st==='concluido') ? 'concluido' : ((st==='em-andamento'||st==='bloqueado'||st==='prioridade'||st==='prioridade-grupo') ? 'em-andamento' : 'nao-iniciado');
        groups[key].push(item);
      });
      const renderCard = (d)=>{
        const title = (d.title||'').trim() || '(Sem t√≠tulo)';
        const resp = (d.responsavel||'').trim();
        const date = (d.endDate||'').split('-');
        const dateLabel = (date.length===3) ? `${date[2]}/${date[1]}` : '';
        const tag = (d.tag||'').toString();
        const statusKey = (d.status||'').toLowerCase();
        const statusLabel = (statusKey==='concluido')? 'Conclu√≠do' : (statusKey==='em-andamento'?'Em andamento': (statusKey||''));
        return `<div class="goal-card"><div class="goal-title">${escapeHtml(title)}</div><div class="goal-meta">${resp?`<span class=\"goal-tag\">üë§ ${escapeHtml(resp)}</span>`:''}${dateLabel?`<span class=\"goal-tag\">üìÖ ${dateLabel}</span>`:''}${statusLabel?`<span class=\"goal-tag\">${escapeHtml(statusLabel)}</span>`:''}${tag?`<span class=\"goal-tag\">üè∑Ô∏è ${escapeHtml(tag)}</span>`:''}</div></div>`;
      };
      g.done.innerHTML = groups['concluido'].map(renderCard).join('');
      g.progress.innerHTML = groups['em-andamento'].map(renderCard).join('');
      g.todo.innerHTML = groups['nao-iniciado'].map(renderCard).join('');
    }

    // Preenche p√°gina p√∫blica a partir do snapshot do token
    function renderFromPayload(payload){
      // Atualizar t√≠tulo e per√≠odo
      const titulo = payload.reportTitle || 'Relat√≥rio de Performance';
      const periodo = payload.periodoTexto || payload.labelMonth || '';
      
      if(payload && periodo){
        document.getElementById('reportMonth').textContent = periodo;
        document.getElementById('relatorioHeaderSubtitle').textContent = `${titulo} ‚Ä¢ ${periodo}`;
      }
      
      renderReportSections(payload||{});
      
      // Gerar preview para redes sociais (async)
      setTimeout(() => {
        generateSocialPreview(payload).catch(err => {
          console.error('[Relatorio] ‚ùå Erro ao gerar preview:', err);
        });
      }, 1000);
    }
    
    // Gera imagem de preview para WhatsApp/Redes Sociais
    async function generateSocialPreview(payload) {
      try {
        console.log('[Relatorio] üì∏ Gerando preview social...');
        
        const canvas = document.createElement('canvas');
        canvas.width = 1200;
        canvas.height = 630;
        const ctx = canvas.getContext('2d');
        
        // Fundo gradiente
        const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        gradient.addColorStop(0, '#0b1020');
        gradient.addColorStop(0.5, '#111936');
        gradient.addColorStop(1, '#1a2847');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // T√≠tulo
        ctx.fillStyle = '#ff6633';
        ctx.font = 'bold 72px Arial, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('üìä Relat√≥rio Mensal', canvas.width / 2, 120);
        
        // M√™s
        if(payload && payload.labelMonth) {
          ctx.fillStyle = '#e2e8f0';
          ctx.font = 'bold 56px Arial, sans-serif';
          ctx.fillText(payload.labelMonth, canvas.width / 2, 200);
        }
        
        // Linha separadora
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(200, 250);
        ctx.lineTo(1000, 250);
        ctx.stroke();
        
        // Estat√≠sticas
        let yPos = 320;
        const stats = [];
        
        // Posts/Stories
        const postsCount = Array.isArray(payload.posts) ? payload.posts.length : 0;
        const storiesCount = Array.isArray(payload.posts) ? payload.posts.filter(p => p.target === 'stories').length : 0;
        const feedCount = postsCount - storiesCount;
        
        if(storiesCount > 0) stats.push(`üì∏ ${storiesCount} Stories`);
        if(feedCount > 0) stats.push(`üì± ${feedCount} Posts`);
        
        // Objetivos
        if(payload.goals && payload.goals.summary) {
          const total = payload.goals.summary.total || 0;
          const done = payload.goals.summary.done || 0;
          if(total > 0) stats.push(`üéØ ${done}/${total} Objetivos`);
        }
        
        // Metas
        const metasCount = Array.isArray(payload.metas) ? payload.metas.length : 0;
        if(metasCount > 0) stats.push(`üìà ${metasCount} Metas`);
        
        // Leads
        const leadsCount = payload.leadsCount || 0;
        if(leadsCount > 0) stats.push(`üéØ ${leadsCount} Leads`);
        
        // Renderizar estat√≠sticas
        ctx.fillStyle = '#86efac';
        ctx.font = 'bold 42px Arial, sans-serif';
        ctx.textAlign = 'left';
        
        const leftCol = stats.slice(0, 3);
        const rightCol = stats.slice(3);
        
        leftCol.forEach((stat, i) => {
          ctx.fillText(stat, 200, yPos + (i * 70));
        });
        
        if(rightCol.length > 0) {
          ctx.textAlign = 'right';
          rightCol.forEach((stat, i) => {
            ctx.fillText(stat, 1000, yPos + (i * 70));
          });
        }
        
        // Rodap√©
        ctx.fillStyle = '#94a3b8';
        ctx.font = '32px Arial, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('MediaGrowth Dashboard', canvas.width / 2, 590);
        
        // Converter canvas para blob
        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
        
        // Verificar se tem token (link compartilhado)
        if(shareToken) {
          console.log('[Relatorio] üì§ Fazendo upload da imagem para Firebase Storage...');
          
          try {
            // Upload para Firebase Storage
            const filename = `preview-${shareToken}.png`;
            const storageRef = sRef(storage, `previews/${filename}`);
            await uploadBytes(storageRef, blob);
            const publicUrl = await getDownloadURL(storageRef);
            
            console.log('[Relatorio] ‚úÖ Upload conclu√≠do! URL:', publicUrl);
            
            // Atualizar meta tags com URL p√∫blica
            const ogImage = document.querySelector('meta[property="og:image"]');
            const twitterImage = document.querySelector('meta[name="twitter:image"]');
            
            if(ogImage) ogImage.setAttribute('content', publicUrl);
            if(twitterImage) twitterImage.setAttribute('content', publicUrl);
            
            // Salvar URL no documento do Firestore para cache
            try {
              const shareDoc = doc(db, 'reportShares', shareToken);
              await setDoc(shareDoc, { previewUrl: publicUrl }, { merge: true });
              console.log('[Relatorio] ‚úÖ URL salva no Firestore para cache');
            } catch(err) {
              console.warn('[Relatorio] ‚ö†Ô∏è N√£o foi poss√≠vel salvar URL no Firestore:', err);
            }
            
            console.log('[Relatorio] ‚úÖ Preview gerado e salvo com sucesso!');
          } catch(uploadErr) {
            console.error('[Relatorio] ‚ùå Erro no upload:', uploadErr);
            // Fallback para data URL
            const imageDataUrl = canvas.toDataURL('image/png');
            document.querySelector('meta[property="og:image"]')?.setAttribute('content', imageDataUrl);
            document.querySelector('meta[name="twitter:image"]')?.setAttribute('content', imageDataUrl);
          }
        } else {
          console.log('[Relatorio] ‚ö†Ô∏è Sem token, usando data URL (pode n√£o funcionar no WhatsApp)');
          const imageDataUrl = canvas.toDataURL('image/png');
          document.querySelector('meta[property="og:image"]')?.setAttribute('content', imageDataUrl);
          document.querySelector('meta[name="twitter:image"]')?.setAttribute('content', imageDataUrl);
        }
        
      } catch(err) {
        console.error('[Relatorio] ‚ùå Erro ao gerar preview:', err);
      }
    }

    // Global error handler para imagens (debug em produ√ß√£o)
    document.addEventListener('error', (e) => {
      if (e.target.tagName === 'IMG') {
        const img = e.target;
        const src = img.src;
        console.error('[Relatorio] Falha ao carregar imagem:', src);
        console.error('[Relatorio] Elemento pai:', img.parentElement?.className);
        console.error('[Relatorio] Protocolo:', src.startsWith('https://') ? 'HTTPS ‚úì' : 'HTTP ‚úó');
        
        // Marca a imagem com erro
        img.setAttribute('data-error', 'true');
        
        // Se for uma imagem de story/post, adiciona fallback visual
        const container = img.closest('.relatorio-story-item');
        if (container && !container.querySelector('.error-fallback')) {
          const fallback = document.createElement('div');
          fallback.className = 'error-fallback';
          fallback.style.cssText = 'position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#ff6633;font-size:2rem;text-shadow:0 2px 8px rgba(0,0,0,.8);pointer-events:none;';
          fallback.textContent = 'üì∑';
          container.appendChild(fallback);
        }
      }
    }, true); // capture phase para pegar todos os erros

    // Log inicial para debug
    console.log('[Relatorio] Script carregado. Modo:', shareToken ? 'P√∫blico (token)' : 'Autenticado');
    console.log('[Relatorio] Per√≠odo:', mesInicioISO, 'at√©', mesFimISO);
    console.log('[Relatorio] Label:', monthLabel);
    console.log('[Relatorio] Tenant:', TENANT);
  </script>
</body>
</html>

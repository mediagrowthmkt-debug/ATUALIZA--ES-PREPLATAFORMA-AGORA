<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Relat√≥rio do m√™s</title>
  
  <!-- Open Graph / Facebook / WhatsApp -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="">
  <meta property="og:title" content="üìä Relat√≥rio Mensal - MediaGrowth">
  <meta property="og:description" content="Confira o relat√≥rio completo com posts, stories, objetivos, metas e leads gerados durante o m√™s.">
  <meta property="og:image" content="">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:image:alt" content="Relat√≥rio Mensal - Resumo de Performance">
  <meta property="og:site_name" content="MediaGrowth Dashboard">
  <meta property="og:locale" content="pt_BR">
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:url" content="">
  <meta name="twitter:title" content="üìä Relat√≥rio Mensal - MediaGrowth">
  <meta name="twitter:description" content="Confira o relat√≥rio completo com posts, stories, objetivos, metas e leads gerados durante o m√™s.">
  <meta name="twitter:image" content="">
  
  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
  
  <style>
    :root{ --panel:#111936; --shell-border:rgba(255,255,255,.12); }
    html,body{margin:0;padding:0;background:#0b1020;color:#e2e8f0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";overflow-x:hidden;min-height:100vh}
    body{overflow-y:auto}
    .btn{background:#1f2937;color:#e5e7eb;border:1px solid rgba(148,163,184,.35);border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn.small{padding:6px 10px;font-size:.9rem}
    .btn.secondary{background:rgba(255,255,255,.05)}
    .relatorio-wrap{max-width:1200px;margin:24px auto;padding:0 16px;display:flex;flex-direction:column;gap:20px;min-height:calc(100vh - 48px)}
    .relatorio-container{background:var(--panel);border:1px solid var(--shell-border);border-radius:16px;padding:24px;box-shadow:0 10px 28px rgba(0,0,0,.35)}
    .relatorio-header{margin-bottom:16px}
    .relatorio-header h2{margin:0 0 8px;font-size:1.8rem;font-weight:900;background:linear-gradient(135deg,#ff6633,#ff944d);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .relatorio-subtitle{margin:0;color:#94a3b8;font-size:.95rem}
    .relatorio-desc{margin:14px auto 0;color:#e5ecff;font-size:1.06rem;line-height:1.6;text-align:center;font-weight:700;letter-spacing:.01em;max-width:980px}
    .relatorio-preview{min-height:auto;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px}
    .relatorio-preview-meta{display:flex;align-items:center;gap:10px;color:#cbd5f5;font-size:.95rem;background:rgba(255,255,255,.02);border:1px dashed rgba(255,255,255,.12);border-radius:10px;padding:10px 12px}
    .relatorio-preview-meta .meta-item.ok{color:#86efac;font-weight:800}
    .relatorio-preview-meta .meta-sep{opacity:.6}
    .relatorio-goals-summary{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    .goal-pill{border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.05);color:#e2e8f0;padding:8px 12px;border-radius:999px;font-size:.9rem}
    .goal-pill strong{color:#fff;margin-left:4px}
    .goals-columns{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    .goals-col h3{margin:0 0 10px}
    .goals-list{display:flex;flex-direction:column;gap:10px}
    .goal-card{border:1px solid rgba(255,255,255,.12);border-left:4px solid #64748b;background:rgba(255,255,255,.03);border-radius:10px;padding:10px 12px}
    .goal-title{font-weight:800;color:#fff;margin:0 0 4px;font-size:.98rem}
    .goal-meta{font-size:.9rem;color:#cbd5f5}
    .macro-social-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px}
    .macro-social-item{display:flex;flex-direction:column;align-items:center;justify-content:flex-start;gap:14px;background:rgba(15,23,42,.52);border:1px solid rgba(148,163,184,.28);border-radius:18px;padding:18px 16px;text-align:center;box-shadow:0 10px 22px rgba(0,0,0,.26);min-height:220px}
    .macro-social-icon{width:56px;height:56px;border-radius:16px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,.8);border:1px solid rgba(148,163,184,.38);color:#e2e8f0;flex:0 0 auto;padding:16px;font-size:24px;line-height:1}
    .macro-social-icon img{width:24px;height:24px;object-fit:contain;display:block}
    .macro-social-info{display:flex;flex-direction:column;gap:6px;align-items:center;justify-content:center;flex:1;min-width:0}
    .macro-social-label{font-weight:800;color:#e2e8f0}
    .macro-social-detail{font-size:.9rem;color:#94a3b8}
    .macro-social-actions{display:flex;justify-content:center;align-items:center;width:100%;margin-top:auto}
    @media(max-width:900px){ .goals-columns{grid-template-columns:1fr} }

  /* Cores por status ‚Äî Objetivos do m√™s */
  #relatorioGoalsColumns .goals-col[data-status="concluido"]{ background: rgba(22,163,74,.12); border-color: rgba(22,163,74,.35); }
  #relatorioGoalsColumns .goals-col[data-status="em-andamento"]{ background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.35); }
  #relatorioGoalsColumns .goals-col[data-status="nao-iniciado"]{ background: rgba(59,130,246,.12); border-color: rgba(59,130,246,.35); }
  #relatorioGoalsDonePill{ border-color:#14532d; background:rgba(20,83,45,.25); }
  #relatorioGoalsProgressPill{ border-color:#b45309; background:rgba(180,83,9,.22); }
  #relatorioGoalsTodoPill{ border-color:#1e3a8a; background:rgba(30,58,138,.22); }

  /* Cores por status ‚Äî Metas do m√™s (map: achieved=verde, progress=amarelo, missing=azul) */
  #relatorioMetasColumns .goals-col[data-status="concluido"]{ background: rgba(22,163,74,.12); border-color: rgba(22,163,74,.35); }
  #relatorioMetasColumns .goals-col[data-status="em-andamento"]{ background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.35); }
  #relatorioMetasColumns .goals-col[data-status="nao-iniciado"]{ background: rgba(59,130,246,.12); border-color: rgba(59,130,246,.35); }
  #relatorioMetasAchievedPill{ border-color:#14532d; background:rgba(20,83,45,.25); }
  #relatorioMetasProgressPill{ border-color:#b45309; background:rgba(180,83,9,.22); }
  #relatorioMetasMissingPill{ border-color:#1e3a8a; background:rgba(30,58,138,.22); }
    @media print{ .btn{display:none !important} .relatorio-container{box-shadow:none} }
    /* Stories & Posts carrossel */
    .relatorio-stories-carousel{position:relative;display:flex;align-items:center;gap:12px}
    .relatorio-stories-grid{flex:1;display:flex;gap:12px;overflow-x:auto;scroll-behavior:smooth;padding:12px 4px;-webkit-overflow-scrolling:touch;will-change:scroll-position}
    .relatorio-stories-grid::-webkit-scrollbar{height:8px}
    .relatorio-stories-grid::-webkit-scrollbar-track{background:rgba(255,255,255,.05);border-radius:4px}
    .relatorio-stories-grid::-webkit-scrollbar-thumb{background:#ff6633;border-radius:4px}
    .relatorio-stories-grid::-webkit-scrollbar-thumb:hover{background:#ff7744}
  .relatorio-story-item{min-width:120px;width:120px;height:200px;border-radius:12px;overflow:hidden;position:relative;cursor:pointer;background:rgba(0,0,0,.4);border:2px solid rgba(255,255,255,.1);transition:all .3s ease;flex-shrink:0;transform:translateZ(0);backface-visibility:hidden;contain:layout paint}
    .relatorio-story-item:hover{transform:translateY(-4px) translateZ(0);border-color:#ff6633;box-shadow:0 8px 24px rgba(255,102,51,.3)}
    .relatorio-story-item img{width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0;display:block}
  .relatorio-story-item img[data-error="true"]{opacity:0.3;filter:grayscale(1)}
  .relatorio-story-item.video::before{content:"‚ñ∂";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:2rem;color:#fff;text-shadow:0 2px 8px rgba(0,0,0,.8);z-index:2;pointer-events:none}
  /* Evita :has() por custo de reflow: usamos classe .has-thumb */
  .relatorio-story-item[data-video-url]:not(.has-thumb)::after{content:"V";font-size:1.2rem;color:#fff;font-weight:700;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}
    .relatorio-story-item > span{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:1.2rem;color:#fff;font-weight:700}
    .relatorio-story-date{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(to top,rgba(0,0,0,.9),transparent);color:#fff;font-size:.75rem;font-weight:700;padding:8px 6px 6px;text-align:center}
    .relatorio-story-status{position:absolute;top:6px;right:6px;width:12px;height:12px;border-radius:50%;border:2px solid #fff;box-shadow:0 2px 4px rgba(0,0,0,.5)}
    .relatorio-story-item.aprovado .relatorio-story-status{background:#4ade80}
    .relatorio-story-item.aprovado-interno .relatorio-story-status{background:#60a5fa}
    .relatorio-story-item.revisar .relatorio-story-status{background:#fbbf24}
    .relatorio-story-item.pendente .relatorio-story-status{background:#94a3b8}
    .relatorio-stories-empty{width:100%;text-align:center;padding:40px 20px;color:#94a3b8}
    .carousel-nav{background:rgba(255,102,51,.2);border:2px solid #ff6633;color:#ff6633;width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:700;cursor:pointer;transition:all .3s ease;flex-shrink:0}
    .carousel-nav:hover{background:#ff6633;color:#fff;transform:scale(1.1)}
    .carousel-nav:active{transform:scale(.95)}
    @media(max-width:768px){ .carousel-nav{width:32px;height:32px;font-size:1.2rem} .relatorio-story-item{min-width:100px;width:100px;height:170px} }
    
    /* Estilos para tabelas nos relat√≥rios - bordas verticais */
    .relatorio-container table{
      width:100%;
      border-collapse:collapse;
      margin:16px 0;
      font-size:.85rem;
      background:rgba(15,23,42,.4);
      border-radius:8px;
      overflow:hidden;
    }
    .relatorio-container table th,
    .relatorio-container table td{
      border:1px solid rgba(255,255,255,.15);
      padding:10px 12px;
      text-align:left;
    }
    .relatorio-container table th{
      background:rgba(99,102,241,.2);
      color:#fff;
      font-weight:700;
      text-transform:uppercase;
      font-size:.75rem;
      letter-spacing:.03em;
    }
    .relatorio-container table tr:nth-child(even){
      background:rgba(255,255,255,.03);
    }
    .relatorio-container table tr:hover{
      background:rgba(99,102,241,.1);
    }
    .relatorio-container table td{
      color:rgba(255,255,255,.85);
    }
  </style>
</head>
<body>
  <div class="relatorio-wrap">
    <div class="relatorio-container" id="authGate" style="display:none">
      <div class="relatorio-header">
        <h2>Autentica√ß√£o necess√°ria</h2>
        <p class="relatorio-subtitle">Voc√™ precisa fazer login para visualizar este relat√≥rio.</p>
      </div>
      <button id="loginBtn" class="btn" type="button">Entrar com Google</button>
    </div>

    <div class="relatorio-container" id="content" style="display:none">
      <div class="relatorio-header">
        <h2>Relat√≥rio do m√™s</h2>
        <p class="relatorio-subtitle" id="relatorioHeaderSubtitle"></p>
      </div>
      <div class="relatorio-preview">
        <div class="relatorio-preview-meta" id="relatorioPreviewMeta">
          <span class="meta-item">üìÖ <span id="reportMonth"></span></span>
          <span class="meta-sep">‚Ä¢</span>
          <span class="meta-item ok">‚úÖ Relat√≥rio gerado</span>
          <span class="meta-sep">‚Ä¢</span>
          <button id="printBtn" class="btn small" type="button">Imprimir / Salvar PDF</button>
        </div>
      </div>
    </div>

    <!-- Stories -->
    <div class="relatorio-container" id="relatorioStoriesSection" style="display:none">
      <div class="relatorio-header">
        <h2>üì± Stories Produzidos</h2>
        <p class="relatorio-subtitle" id="relatorioStoriesSubtitle"></p>
      </div>
      <div class="relatorio-stories-carousel">
        <button type="button" class="carousel-nav" id="relatorioStoriesPrev">‚Äπ</button>
        <div class="relatorio-stories-grid" id="relatorioStoriesGrid">
          <div class="relatorio-stories-empty">Nenhum story encontrado para este per√≠odo</div>
        </div>
        <button type="button" class="carousel-nav" id="relatorioStoriesNext">‚Ä∫</button>
      </div>
      <p class="relatorio-desc" id="relatorioStoriesDesc" style="display:none"></p>
    </div>

    <!-- Posts (Feed) -->
    <div class="relatorio-container" id="relatorioPostsSection" style="display:none">
      <div class="relatorio-header">
        <h2>üì∞ Posts Produzidos</h2>
        <p class="relatorio-subtitle" id="relatorioPostsSubtitle"></p>
      </div>
      <div class="relatorio-stories-carousel">
        <button type="button" class="carousel-nav" id="relatorioPostsPrev">‚Äπ</button>
        <div class="relatorio-stories-grid" id="relatorioPostsGrid">
          <div class="relatorio-stories-empty">Nenhum post de feed encontrado para este per√≠odo</div>
        </div>
        <button type="button" class="carousel-nav" id="relatorioPostsNext">‚Ä∫</button>
      </div>
      <p class="relatorio-desc" id="relatorioPostsDesc" style="display:none"></p>
    </div>

    <!-- Objetivos do m√™s (Planejamento) -->
    <div class="relatorio-container" id="relatorioGoalsSection" style="display:none">
      <div class="relatorio-header">
        <h2>üéØ Objetivos do m√™s</h2>
        <p class="relatorio-subtitle" id="relatorioGoalsSubtitle">Status das demandas do Planejamento no m√™s selecionado</p>
      </div>
      <div class="relatorio-goals-summary">
        <div class="goal-pill" id="relatorioGoalsDonePill">Conclu√≠dos: <strong>-</strong></div>
        <div class="goal-pill" id="relatorioGoalsProgressPill">Em andamento: <strong>-</strong></div>
        <div class="goal-pill" id="relatorioGoalsTodoPill">N√£o iniciados: <strong>-</strong></div>
      </div>
      <div class="goals-columns" id="relatorioGoalsColumns">
        <div class="goals-col" data-status="concluido">
          <h3>Conclu√≠dos</h3>
          <div class="goals-list" id="relatorioGoalsDone"></div>
        </div>
        <div class="goals-col" data-status="em-andamento">
          <h3>Em andamento</h3>
          <div class="goals-list" id="relatorioGoalsProgress"></div>
        </div>
        <div class="goals-col" data-status="nao-iniciado">
          <h3>N√£o iniciados</h3>
          <div class="goals-list" id="relatorioGoalsTodo"></div>
        </div>
      </div>
      <p class="relatorio-desc" id="relatorioGoalsDesc"></p>
    </div>

    <!-- Metas -->
    <div class="relatorio-container" id="relatorioMetasSection" style="display:none">
      <div class="relatorio-header">
        <h2>üìà Metas do m√™s</h2>
        <p class="relatorio-subtitle" id="relatorioMetasSubtitle"></p>
      </div>
      <div class="relatorio-goals-summary">
        <div class="goal-pill" id="relatorioMetasAchievedPill">Atingidas: <strong>-</strong></div>
        <div class="goal-pill" id="relatorioMetasProgressPill">Em andamento: <strong>-</strong></div>
        <div class="goal-pill" id="relatorioMetasMissingPill">Precisa colocar: <strong>-</strong></div>
      </div>
      <div class="goals-columns" id="relatorioMetasColumns">
        <div class="goals-col" data-status="concluido">
          <h3>Atingidas</h3>
          <div class="goals-list" id="relatorioMetasAchieved"></div>
        </div>
        <div class="goals-col" data-status="em-andamento">
          <h3>Em andamento</h3>
          <div class="goals-list" id="relatorioMetasProgress"></div>
        </div>
        <div class="goals-col" data-status="nao-iniciado">
          <h3>Precisa colocar</h3>
          <div class="goals-list" id="relatorioMetasMissing"></div>
        </div>
      </div>
      <p class="relatorio-desc" id="relatorioMetasDesc"></p>
    </div>

    <!-- Leads Gerados -->
    <div class="relatorio-container" id="relatorioLeadsSection" style="display:none">
      <div class="relatorio-header">
        <h2>üéØ Leads Gerados</h2>
        <p class="relatorio-subtitle" id="relatorioLeadsSubtitle"></p>
      </div>
      <div class="relatorio-preview">
        <div class="relatorio-preview-meta" style="justify-content: center; font-size: 1.4rem; padding: 20px;">
          <span class="meta-item" style="color: #86efac; font-weight: 900; font-size: 2rem;">
            üìä <span id="relatorioLeadsCount">0</span> leads
          </span>
        </div>
      </div>
      
      <!-- An√°lise Detalhada -->
      <div class="relatorio-leads-analysis" id="relatorioLeadsAnalysis" style="display:none; margin-top: 20px;">
        
        <!-- Por Plataforma -->
        <div class="relatorio-container" style="margin-bottom: 16px;">
          <h3 style="margin: 0 0 12px; font-size: 1.1rem; color: #e2e8f0;">üì± Por Plataforma</h3>
          <div class="relatorio-goals-summary" id="relatorioLeadsPlatforms"></div>
        </div>
        
        <!-- Por Fonte -->
        <div class="relatorio-container" style="margin-bottom: 16px;">
          <h3 style="margin: 0 0 12px; font-size: 1.1rem; color: #e2e8f0;">üåê Por Fonte</h3>
          <div class="relatorio-goals-summary" id="relatorioLeadsSources"></div>
        </div>
        
        <!-- Principais Perguntas -->
        <div class="relatorio-container" style="margin-bottom: 16px;">
          <h3 style="margin: 0 0 12px; font-size: 1.1rem; color: #e2e8f0;">üí¨ Principais Perguntas</h3>
          <div id="relatorioLeadsQuestions" style="display: flex; flex-direction: column; gap: 8px;"></div>
        </div>
        
        <!-- An√°lise IA -->
        <div class="relatorio-container" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1)); border: 1px solid rgba(139, 92, 246, 0.3);">
          <h3 style="margin: 0 0 12px; font-size: 1.1rem; color: #c4b5fd;">ü§ñ An√°lise Inteligente</h3>
          <div id="relatorioLeadsAIAnalysis" style="color: #e9d5ff; line-height: 1.6; font-size: 0.95rem;"></div>
        </div>
        
      </div>
      
      <p class="relatorio-desc" id="relatorioLeadsDesc"></p>
    </div>

    <!-- Redes conectadas -->
    <div class="relatorio-container" id="relatorioRedesSection" style="display:none">
      <div class="relatorio-header">
        <h2>üîó Redes trabalhadas no m√™s</h2>
        <p class="relatorio-subtitle" id="relatorioRedesSubtitle"></p>
      </div>
      <div class="macro-social-grid" id="relatorioRedesGrid"></div>
      <p class="relatorio-desc" id="relatorioRedesDesc"></p>
    </div>
    
    <!-- Resumo em Texto -->
    <div class="relatorio-container" id="relatorioResumoTextoSection" style="display:none; background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(100, 116, 139, 0.3);">
      <div class="relatorio-header">
        <h2>üìã Resumo em Texto</h2>
        <p class="relatorio-subtitle">Copie este resumo para compartilhar facilmente</p>
      </div>
      
      <div style="position: relative;">
        <button type="button" id="btnCopiarResumo" class="btn secondary small" style="position: absolute; top: 8px; right: 8px; z-index: 10; background: rgba(59, 130, 246, 0.2); border-color: rgba(59, 130, 246, 0.4);">
          üìã Copiar Texto
        </button>
        
        <div id="relatorioResumoTextoContent" style="
          background: rgba(15, 23, 42, 0.8);
          border: 1px solid rgba(71, 85, 105, 0.4);
          border-radius: 8px;
          padding: 24px;
          color: #e2e8f0;
          font-family: 'Courier New', monospace;
          font-size: 0.95rem;
          line-height: 1.8;
          white-space: pre-wrap;
          overflow-x: auto;
          min-height: 200px;
        ">
          <!-- Ser√° preenchido dinamicamente -->
        </div>
      </div>
    </div>
    
  </div>

  <script type="module">
    // Firebase SDK (modular)
    import { initializeApp, getApps } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
    import { getFirestore, doc, getDoc, collection, getDocs, setDoc } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js';

    // ===== Config igual ao index.html =====
    const firebaseConfig = {
      apiKey: "AIzaSyD4CbPQWrwOcfANX3ar0ibmGN20ffsRCqo",
      authDomain: "mediagrowth-a5349.firebaseapp.com",
      projectId: "mediagrowth-a5349",
      storageBucket: "mediagrowth-a5349.firebasestorage.app",
      messagingSenderId: "1074237637946",
      appId: "1:1074237637946:web:cf5008b649bbb4d7d13c03"
    };

    // Parse params
  const qs = new URLSearchParams(location.search);
  const shareToken = qs.get('share') || '';
  const mesISO = (qs.get('mes') || '').slice(0,7);
  const TENANT = qs.get('tenant') || document.body.getAttribute('data-client-id') || '';
  const monthLabel = (()=>{ try{ const [a,m]=mesISO.split('-'); const nomes=['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro']; return `${nomes[(+m||1)-1]} ${a}` }catch{ return mesISO } })();
  document.getElementById('reportMonth').textContent = monthLabel || '';
  document.getElementById('relatorioHeaderSubtitle').textContent = monthLabel ? `Resumo do m√™s ${monthLabel}` : '';
  
  // Atualizar meta tags Open Graph dinamicamente
  const currentUrl = window.location.href;
  document.querySelector('meta[property="og:url"]').setAttribute('content', currentUrl);
  document.querySelector('meta[name="twitter:url"]').setAttribute('content', currentUrl);
  
  if(monthLabel) {
    const ogTitle = `üìä Relat√≥rio de ${monthLabel} - MediaGrowth`;
    const ogDesc = `Confira o relat√≥rio completo de ${monthLabel} com posts, stories, objetivos, metas e leads gerados.`;
    
    document.title = ogTitle;
    document.querySelector('meta[property="og:title"]').setAttribute('content', ogTitle);
    document.querySelector('meta[property="og:description"]').setAttribute('content', ogDesc);
    document.querySelector('meta[name="twitter:title"]').setAttribute('content', ogTitle);
    document.querySelector('meta[name="twitter:description"]').setAttribute('content', ogDesc);
  }

  // App/Auth/DB
    const app = getApps()[0] || initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Helpers metas (copiados do index de forma m√≠nima)
    const META_MONTHS = ['2025-01','2025-02','2025-03','2025-04','2025-05','2025-06','2025-07','2025-08','2025-09','2025-10','2025-11','2025-12'];
    function normalizeMetaNumber(value){
      if(value===null||value===undefined) return 0; const n=Number(String(value).replace(/[^0-9.,-]/g,'').replace(',','.')); return Number.isFinite(n)?n:0;
    }
    function evaluateMetaGoal(planned, realized, direction){
      const p = Math.max(0, normalizeMetaNumber(planned));
      const r = normalizeMetaNumber(realized);
      
      // Se n√£o tem meta planejada ou realizado est√° vazio/zero, retorna 'missing' (precisa colocar)
      if(p <= 0 || (r === 0 && planned === 0) || (r === 0 && !realized && realized !== 0)) return 'missing';
      
      const dir = (direction || 'aumentar').toLowerCase();
      
      if(dir === 'diminuir'){
        // Para diminuir: se realizado <= planejado = atingida (achieved), sen√£o = em andamento (progress)
        return r <= p ? 'achieved' : 'progress';
      }
      if(dir === 'manter'){
        if(p === 0) return 'progress';
        const tolerance = Math.max(Math.abs(p) * 0.05, 0.01);
        return Math.abs(r - p) <= tolerance ? 'achieved' : 'progress';
      }
      // Para aumentar: se realizado >= planejado = atingida (achieved), sen√£o = em andamento (progress)
      return r >= p ? 'achieved' : 'progress';
    }

    function escapeHtml(v){ return String(v??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

    // UI refs
    const els = {
      authGate: document.getElementById('authGate'),
      loginBtn: document.getElementById('loginBtn'),
      content: document.getElementById('content'),
      printBtn: document.getElementById('printBtn'),
      stories: {
        section: document.getElementById('relatorioStoriesSection'),
        grid: document.getElementById('relatorioStoriesGrid'),
        prev: document.getElementById('relatorioStoriesPrev'),
        next: document.getElementById('relatorioStoriesNext'),
        subtitle: document.getElementById('relatorioStoriesSubtitle'),
        desc: document.getElementById('relatorioStoriesDesc')
      },
      posts: {
        section: document.getElementById('relatorioPostsSection'),
        grid: document.getElementById('relatorioPostsGrid'),
        prev: document.getElementById('relatorioPostsPrev'),
        next: document.getElementById('relatorioPostsNext'),
        subtitle: document.getElementById('relatorioPostsSubtitle'),
        desc: document.getElementById('relatorioPostsDesc')
      },
      goals: {
        section: document.getElementById('relatorioGoalsSection'),
        subtitle: document.getElementById('relatorioGoalsSubtitle'),
        desc: document.getElementById('relatorioGoalsDesc'),
        donePill: document.getElementById('relatorioGoalsDonePill'),
        progressPill: document.getElementById('relatorioGoalsProgressPill'),
        todoPill: document.getElementById('relatorioGoalsTodoPill'),
        done: document.getElementById('relatorioGoalsDone'),
        progress: document.getElementById('relatorioGoalsProgress'),
        todo: document.getElementById('relatorioGoalsTodo')
      }
    };

    els.printBtn.addEventListener('click', ()=> window.print());

    els.loginBtn?.addEventListener('click', async ()=>{
      try{
        await setPersistence(auth, browserLocalPersistence);
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
      }catch(err){ alert('Falha no login. Veja o console.'); console.error(err); }
    });

    if(shareToken){
      // Modo p√∫blico via token: n√£o exige login
      console.log('[Relatorio] Modo p√∫blico - carregando via shareToken:', shareToken);
      els.authGate.style.display = 'none';
      els.content.style.display = 'block';
      try{
        const snap = await getDoc(doc(db,'reportShares', shareToken));
        if(!snap.exists()){
          console.error('[Relatorio] Token n√£o encontrado no Firestore');
          throw new Error('Link inv√°lido ou expirado');
        }
        console.log('[Relatorio] Token encontrado, carregando payload...');
        const data = snap.data() || {};
        const payload = data.payload || {};
        console.log('[Relatorio] Payload carregado:', {
          hasStories: Array.isArray(payload.posts) ? payload.posts.filter(p => p.target === 'stories').length : 0,
          hasPosts: Array.isArray(payload.posts) ? payload.posts.filter(p => p.target === 'feed').length : 0,
          totalPosts: Array.isArray(payload.posts) ? payload.posts.length : 0,
          leadsCount: payload.leadsCount || 0,
          leadsDataCount: Array.isArray(payload.leadsData) ? payload.leadsData.length : 0
        });
        console.log('[Relatorio] leadsData preview:', Array.isArray(payload.leadsData) && payload.leadsData.length > 0 ? payload.leadsData[0] : 'nenhum lead');
        renderFromPayload(payload);
      }catch(err){
        console.error('[Relatorio] Erro ao carregar link p√∫blico:', err);
        els.content.innerHTML = '<div class="relatorio-desc">Link inv√°lido ou expirado. Erro: ' + (err.message || String(err)) + '</div>';
      }
    } else {
      // Modo autenticado (retrocompat)
      console.log('[Relatorio] Modo autenticado - aguardando login...');
      console.warn('[Relatorio] IMPORTANTE: Para acesso p√∫blico use o bot√£o "Copiar link" no painel principal que gera um link com token ?share=...');
      console.warn('[Relatorio] Acesso direto sem token requer autentica√ß√£o Google.');
      
      onAuthStateChanged(auth, async (user)=>{
        if(!user){
          console.log('[Relatorio] Usu√°rio n√£o autenticado, mostrando tela de login');
          console.warn('[Relatorio] Se voc√™ est√° em produ√ß√£o e quer acessar o relat√≥rio, use o link gerado com o bot√£o "Copiar link" que inclui o token de compartilhamento.');
          els.authGate.style.display = 'block';
          els.content.style.display = 'none';
          
          // Mostra mensagem mais clara
          const subtitle = els.authGate.querySelector('.relatorio-subtitle');
          if(subtitle){
            subtitle.innerHTML = 'Voc√™ precisa fazer login para visualizar este relat√≥rio.<br><small style="color:#94a3b8;margin-top:8px;display:block;">üí° Dica: Use o bot√£o "Copiar link" no painel principal para gerar um link p√∫blico que n√£o requer login.</small>';
          }
          return;
        }
        console.log('[Relatorio] Usu√°rio autenticado:', user.uid);
        els.authGate.style.display = 'none';
        els.content.style.display = 'block';
        try{
          await loadAndRender(user.uid);
        }catch(err){
          console.error('[Relatorio] Erro ao carregar relat√≥rio:', err);
          alert('N√£o foi poss√≠vel carregar o relat√≥rio.');
        }
      });
    }

    async function loadAndRender(uid){
      console.log('[Relatorio] loadAndRender iniciado - uid:', uid, 'mesISO:', mesISO, 'TENANT:', TENANT);
      
      // 1) USER_DATA b√°sico (metas, social links)
      const userSnap = await getDoc(doc(db,'usuarios', uid));
      const USER_DATA = userSnap.exists() ? (userSnap.data()||{}) : {};
      const METAS = Array.isArray(USER_DATA.metas) ? USER_DATA.metas : [];
      const SOCIAL_LINKS = USER_DATA.socialLinks && typeof USER_DATA.socialLinks==='object' ? USER_DATA.socialLinks : {};
      console.log('[Relatorio] USER_DATA carregado - metas:', METAS.length);

      // 2) Posts (filtrar por m√™s e tenant)
      const postsSnap = await getDocs(collection(db,'usuarios', uid, 'posts'));
      const allPosts = postsSnap.docs.map(d=>({ id:d.id, ...(d.data()||{}) }));
      console.log('[Relatorio] Total de posts no Firestore:', allPosts.length);
      
      const posts = allPosts.filter(p => {
        const iso = String(p.dateISO||'');
        const okMes = mesISO ? iso.startsWith(mesISO) : true;
        const tenant = p.tenant||''; const safeTenant = TENANT||'';
        const okTenant = !tenant || !safeTenant ? true : (tenant===safeTenant);
        const keep = okMes && okTenant;
        if(!keep && mesISO && TENANT){
          console.log('[Relatorio] Post filtrado:', p.id, 'dateISO:', iso, 'tenant:', tenant, 'okMes:', okMes, 'okTenant:', okTenant);
        }
        return keep;
      }).sort((a,b)=> String(a.dateISO||'').localeCompare(String(b.dateISO||'')));
      
      console.log('[Relatorio] Posts ap√≥s filtro:', posts.length);
      console.log('[Relatorio] Stories:', posts.filter(p => p.target === 'stories').length);
      console.log('[Relatorio] Feed posts:', posts.filter(p => (p.target||'feed') === 'feed').length);

      // 3) Calendar notes por cliente
      let notes = [];
      if(TENANT){
        const notesSnap = await getDocs(collection(db,'usuarios', uid, 'clients', TENANT, 'calendarNotes'));
        notes = notesSnap.docs
          .map(d=>({ id:d.id, ...(d.data()||{}) }))
          .filter(n=> String(n.id||'').startsWith(mesISO))
          .sort((a,b)=> String(a.id).localeCompare(String(b.id)));
        console.log('[Relatorio] Calendar notes carregadas:', notes.length);
      }

      // 4) Leads por cliente (filtrados pelo m√™s)
      let leads = [];
      if(TENANT && mesISO){
        try{
          const leadsSnap = await getDocs(collection(db,'usuarios', uid, 'clients', TENANT, 'leads'));
          const allLeads = leadsSnap.docs.map(d=>({ id:d.id, ...(d.data()||{}) }));
          
          // Filtrar leads pelo m√™s de cria√ß√£o
          leads = allLeads.filter(lead => {
            if(!lead.createdAt) return false;
            
            // Converter createdAt para data
            let leadDate;
            if(typeof lead.createdAt.toMillis === 'function'){
              leadDate = new Date(lead.createdAt.toMillis());
            } else if(typeof lead.createdAt.toDate === 'function'){
              leadDate = lead.createdAt.toDate();
            } else if(lead.createdAt.seconds) {
              leadDate = new Date(lead.createdAt.seconds * 1000);
            } else if(typeof lead.createdAt === 'number'){
              leadDate = new Date(lead.createdAt);
            } else {
              return false;
            }
            
            // Formatar data no formato YYYY-MM
            const year = leadDate.getFullYear();
            const month = String(leadDate.getMonth() + 1).padStart(2, '0');
            const leadMonthISO = `${year}-${month}`;
            
            return leadMonthISO === mesISO;
          });
          
          console.log('[Relatorio] Total de leads no Firestore:', allLeads.length);
          console.log('[Relatorio] Leads filtrados para o m√™s', mesISO, ':', leads.length);
          if(leads.length > 0) {
            console.log('[Relatorio] Primeiro lead (exemplo):', {
              name: leads[0].name,
              plataforma: leads[0].plataforma,
              source: leads[0].source,
              question: leads[0].question
            });
          }
        }catch(err){
          console.warn('[Relatorio] Erro ao carregar leads:', err);
        }
      }

      const payload = {
        labelMonth: monthLabel,
        metas: (METAS||[]).filter(m=>m && m.ativo!==false).map(m=>{ const cur=(m.meses&&m.meses[mesISO])||{p:'',r:''}; return { descricao:m.descricao||'', unidade:m.unidade||'', direcao:m.direcao||'up', planned: normalizeMetaNumber(cur.p), realized: normalizeMetaNumber(cur.r) }; }),
        posts: posts.map(p=>({
          id: p.id||'',
          dateISO: p.dateISO||'',
          target: (p.target||'feed'),
          status: p.status||'',
          approvedBy: p.approvedBy||'',
          thumbUrl: p.thumbUrl||'',
          mediaUrls: Array.isArray(p.mediaUrls)?p.mediaUrls.slice(0,4):[]
        })),
        notes,
        socialLinks: SOCIAL_LINKS||{},
        leadsCount: leads.length,
        leadsData: leads.map(lead => ({
          name: lead.name || '',
          email: lead.email || '',
          phone: lead.phone || '',
          question: lead.question || '',
          plataforma: lead.plataforma || 'N√£o especificado',
          source: lead.source || 'N√£o especificado'
        }))
      };
      
      console.log('[Relatorio] Payload preparado:', {
        metas: payload.metas.length,
        posts: payload.posts.length,
        stories: payload.posts.filter(p => p.target === 'stories').length,
        feed: payload.posts.filter(p => (p.target||'feed') === 'feed').length,
        leadsCount: payload.leadsCount,
        leadsData: payload.leadsData.length
      });
      
      renderReportSections(payload);
      
      // Gerar preview para redes sociais (async)
      setTimeout(() => {
        generateSocialPreview(payload).catch(err => {
          console.error('[Relatorio] ‚ùå Erro ao gerar preview:', err);
        });
      }, 1000);
    }
    function renderReportSections(payload){
      console.log('[Relatorio] renderReportSections chamado - payload:', {
        hasPosts: Array.isArray(payload.posts),
        postsLength: Array.isArray(payload.posts) ? payload.posts.length : 0,
        hasMetas: Array.isArray(payload.metas),
        metasLength: Array.isArray(payload.metas) ? payload.metas.length : 0,
        hasGoals: payload.goals !== null && payload.goals !== undefined,
        labelMonth: payload.labelMonth,
        leadsCount: payload.leadsCount || 0
      });
      
      // Stories + Posts (feed)
      try{ 
        console.log('[Relatorio] Chamando renderStoriesAndPosts...');
        renderStoriesAndPosts(Array.isArray(payload.posts)?payload.posts:[], payload.labelMonth||''); 
      }catch(e){ 
        console.error('[Relatorio] Erro em renderStoriesAndPosts:', e); 
      }

  // Objetivos do m√™s (Planejamento)
  try{ renderGoals(payload.goals||null, payload.labelMonth||''); }catch(e){ console.warn('renderGoals', e); }

  // Metas
      const metas = Array.isArray(payload.metas)?payload.metas:[];
      const metasSection = document.getElementById('relatorioMetasSection');
      const sub = document.getElementById('relatorioMetasSubtitle');
      const desc = document.getElementById('relatorioMetasDesc');
      const colA = document.getElementById('relatorioMetasAchieved');
      const colP = document.getElementById('relatorioMetasProgress');
      const colM = document.getElementById('relatorioMetasMissing');
      const pillA = document.getElementById('relatorioMetasAchievedPill');
      const pillP = document.getElementById('relatorioMetasProgressPill');
      const pillM = document.getElementById('relatorioMetasMissingPill');
      if(metas.length){
        metasSection.style.display='block';
        if(sub) sub.textContent = `Metas ativas no m√™s ${payload.labelMonth||''}`;
        const groups = { achieved:[], progress:[], missing:[] };
        metas.forEach(m=>{ const st=evaluateMetaGoal(m.planned,m.realized,m.direcao); (groups[st]||(groups.progress)).push(m); });
        pillA.querySelector('strong').textContent = groups.achieved.length;
        pillP.querySelector('strong').textContent = groups.progress.length;
        pillM.querySelector('strong').textContent = groups.missing.length;
        const total = metas.length; const rate = total? Math.round((groups.achieved.length/total)*100):0;
        if(desc) desc.textContent = `üéØ ${payload.labelMonth||''}: ${total} metas ativas ‚Äî Atingidas: ${groups.achieved.length} (${rate}%), Em andamento: ${groups.progress.length}, Precisa colocar: ${groups.missing.length}.`;
        const card = (m)=>{
          const planned = Number.isFinite(m.planned)?m.planned:0;
          const realized = Number.isFinite(m.realized)?m.realized:0;
          return `<div class="goal-card"><div class="goal-title">${escapeHtml(m.descricao||'(Meta)')}</div><div class="goal-meta">Planejado: <strong>${planned}</strong> ${escapeHtml(m.unidade||'')} ‚Ä¢ Realizado: <strong>${realized}</strong> ${escapeHtml(m.unidade||'')}</div></div>`;
        };
        colA.innerHTML = groups.achieved.map(card).join('');
        colP.innerHTML = groups.progress.map(card).join('');
        colM.innerHTML = groups.missing.map(card).join('');
      } else {
        metasSection.style.display='none';
      }

      // Leads Gerados
      const leadsSection = document.getElementById('relatorioLeadsSection');
      const leadsSubtitle = document.getElementById('relatorioLeadsSubtitle');
      const leadsCount = document.getElementById('relatorioLeadsCount');
      const leadsDesc = document.getElementById('relatorioLeadsDesc');
      const leadCount = typeof payload.leadsCount === 'number' ? payload.leadsCount : 0;
      const leadsDataArray = Array.isArray(payload.leadsData) ? payload.leadsData : [];
      
      if(leadCount > 0 || TENANT){
        leadsSection.style.display='block';
        if(leadsSubtitle) leadsSubtitle.textContent = `Leads captados em ${payload.labelMonth||''}`;
        if(leadsCount) leadsCount.textContent = leadCount;
        
        // Se h√° an√°lise no payload (novo formato) ou dados detalhados, mostrar an√°lise
        const analysis = payload.leadsAnalysis;
        if(analysis || leadsDataArray.length > 0) {
          const leadsAnalysisEl = document.getElementById('relatorioLeadsAnalysis');
          const leadsPlatforms = document.getElementById('relatorioLeadsPlatforms');
          const leadsSources = document.getElementById('relatorioLeadsSources');
          const leadsQuestions = document.getElementById('relatorioLeadsQuestions');
          const leadsAIAnalysis = document.getElementById('relatorioLeadsAIAnalysis');
          
          // Usar an√°lise do payload se dispon√≠vel, sen√£o calcular
          let platforms, sources, topQuestions;
          
          if(analysis) {
            // Usar dados pr√©-processados do payload
            platforms = analysis.platforms || [];
            sources = analysis.sources || [];
            topQuestions = analysis.topQuestions || [];
          } else {
            // Fallback: calcular da leadsData (compatibilidade com payloads antigos)
            const platformStats = {};
            leadsDataArray.forEach(lead => {
              const platform = (lead.plataforma || 'N√£o especificado').toString().trim();
              platformStats[platform] = (platformStats[platform] || 0) + 1;
            });
            
            const sourceStats = {};
            leadsDataArray.forEach(lead => {
              const source = (lead.source || 'N√£o especificado').toString().trim();
              sourceStats[source] = (sourceStats[source] || 0) + 1;
            });
            
            const questionStats = {};
            leadsDataArray.forEach(lead => {
              const question = (lead.question || '').toString().trim();
              if(question && question.length > 0) {
                questionStats[question] = (questionStats[question] || 0) + 1;
              }
            });
            
            platforms = Object.entries(platformStats)
              .sort((a, b) => b[1] - a[1])
              .map(([name, count]) => ({
                name,
                count,
                percent: Math.round((count / leadCount) * 100),
                emoji: name.toLowerCase().includes('google') ? 'üîç' : 
                       name.toLowerCase().includes('meta') ? 'üìò' : 'üì±'
              }));
            
            sources = Object.entries(sourceStats)
              .sort((a, b) => b[1] - a[1])
              .map(([name, count]) => ({
                name,
                count,
                percent: Math.round((count / leadCount) * 100),
                emoji: 'üåê'
              }));
            
            topQuestions = Object.entries(questionStats)
              .sort((a, b) => b[1] - a[1])
              .slice(0, 5)
              .map(([question, count]) => ({
                question,
                count,
                percent: Math.round((count / leadCount) * 100)
              }));
          }
          
          // Renderizar plataformas
          if(leadsPlatforms) {
            leadsPlatforms.innerHTML = platforms.map(p => {
              return `<div class="goal-pill" style="border-color: rgba(99, 102, 241, 0.4); background: rgba(99, 102, 241, 0.15);">
                ${p.emoji} ${p.name}: <strong>${p.count}</strong> <span style="opacity: 0.7;">(${p.percent}%)</span>
              </div>`;
            }).join('');
          }
          
          // Renderizar fontes
          if(leadsSources) {
            leadsSources.innerHTML = sources.map(s => {
              return `<div class="goal-pill" style="border-color: rgba(16, 185, 129, 0.4); background: rgba(16, 185, 129, 0.15);">
                ${s.emoji} ${s.name}: <strong>${s.count}</strong> <span style="opacity: 0.7;">(${s.percent}%)</span>
              </div>`;
            }).join('');
          }
          
          // Renderizar perguntas
          if(leadsQuestions) {
            if(topQuestions.length === 0) {
              leadsQuestions.innerHTML = '<div style="color: #94a3b8; font-size: 0.9rem; padding: 8px;">Nenhuma pergunta registrada</div>';
            } else {
              leadsQuestions.innerHTML = topQuestions.map((q, index) => {
                return `<div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; padding: 10px 12px;">
                  <div style="display: flex; align-items: start; gap: 8px;">
                    <span style="color: #fbbf24; font-weight: 800; font-size: 1.1rem; flex-shrink: 0;">${index + 1}.</span>
                    <div style="flex: 1;">
                      <div style="color: #e2e8f0; margin-bottom: 4px; line-height: 1.4;">${escapeHtml(q.question)}</div>
                      <div style="color: #94a3b8; font-size: 0.85rem;">
                        <strong style="color: #60a5fa;">${q.count}</strong> ${q.count === 1 ? 'pergunta' : 'perguntas'} 
                        <span style="opacity: 0.7;">(${q.percent}% dos leads)</span>
                      </div>
                    </div>
                  </div>
                </div>`;
              }).join('');
            }
          }
          
          // IA Insights
          if(leadsAIAnalysis) {
            const insights = [];
            const avgLeadsPerDay = (leadCount / 30).toFixed(1);
            insights.push(`üìä <strong>Volume:</strong> ${leadCount} leads gerados em ${payload.labelMonth||''}, com m√©dia de ${avgLeadsPerDay} leads/dia.`);
            
            if(platforms.length > 0) {
              const topPlatform = platforms[0];
              insights.push(`üì± <strong>Plataforma l√≠der:</strong> ${topPlatform.name} com ${topPlatform.count} leads (${topPlatform.percent}% do total).`);
              
              if(platforms.length > 1 && topPlatform.percent >= 70) {
                insights.push(`üí° <strong>Recomenda√ß√£o:</strong> H√° uma forte concentra√ß√£o em ${topPlatform.name}. Considere diversificar investimentos em outras plataformas.`);
              }
            }
            
            if(sources.length > 0) {
              const topSource = sources[0];
              insights.push(`üåê <strong>Fonte principal:</strong> ${topSource.name} com ${topSource.count} leads (${topSource.percent}% do total).`);
            }
            
            // Calcular engajamento (leads com pergunta)
            let leadsComPergunta = 0;
            if(analysis && analysis.topQuestions) {
              leadsComPergunta = analysis.topQuestions.reduce((sum, q) => sum + q.count, 0);
            } else if(leadsDataArray.length > 0) {
              leadsComPergunta = leadsDataArray.filter(l => (l.question || '').toString().trim().length > 0).length;
            }
            
            const engagementRate = leadCount > 0 ? Math.round((leadsComPergunta / leadCount) * 100) : 0;
            insights.push(`üí¨ <strong>Engajamento:</strong> ${engagementRate}% dos leads deixaram perguntas (${leadsComPergunta} de ${leadCount}).`);
            
            if(engagementRate < 30) {
              insights.push(`‚ö†Ô∏è <strong>Aten√ß√£o:</strong> Taxa de engajamento baixa. Considere revisar os formul√°rios ou calls-to-action.`);
            } else if(engagementRate >= 70) {
              insights.push(`‚úÖ <strong>Excelente:</strong> Alta taxa de engajamento! Os leads est√£o demonstrando interesse genu√≠no.`);
            }
            
            if(platforms.length >= 2) {
              insights.push(`üéØ <strong>Diversifica√ß√£o:</strong> Leads provenientes de ${platforms.length} plataformas diferentes, demonstrando boa distribui√ß√£o de canais.`);
            }
            
            if(topQuestions.length > 0) {
              const topQuestion = topQuestions[0];
              insights.push(`‚ùì <strong>Principal d√∫vida:</strong> "${topQuestion.question}" apareceu ${topQuestion.count} ${topQuestion.count === 1 ? 'vez' : 'vezes'}. Considere criar conte√∫do ou FAQ abordando este tema.`);
            }
            
            leadsAIAnalysis.innerHTML = insights.map(insight => 
              `<div style="margin-bottom: 10px; padding-left: 4px; border-left: 3px solid rgba(168, 85, 247, 0.5);">${insight}</div>`
            ).join('');
          }
          
          if(leadsAnalysisEl) leadsAnalysisEl.style.display = 'block';

          const platformCount = Array.isArray(platforms) ? platforms.length : 0;
          const sourceCount = Array.isArray(sources) ? sources.length : 0;
          if(leadsDesc) leadsDesc.textContent = `üéØ Total de ${leadCount} lead${leadCount === 1 ? '' : 's'} gerado${leadCount === 1 ? '' : 's'} durante ${payload.labelMonth||''} atrav√©s de ${platformCount} plataforma${platformCount === 1 ? '' : 's'} e ${sourceCount} fonte${sourceCount === 1 ? '' : 's'} diferente${sourceCount === 1 ? '' : 's'}.`;
        } else {
          if(leadsDesc) leadsDesc.textContent = `üéØ Total de ${leadCount} lead${leadCount === 1 ? '' : 's'} gerado${leadCount === 1 ? '' : 's'} durante ${payload.labelMonth||''}.`;
        }
      } else {
        leadsSection.style.display='none';
      }

      // Redes
      const redesSection = document.getElementById('relatorioRedesSection');
      const redesGrid = document.getElementById('relatorioRedesGrid');
      const redesSub = document.getElementById('relatorioRedesSubtitle');
      const redesDesc = document.getElementById('relatorioRedesDesc');
      const socialArray = Array.isArray(payload.social) ? payload.social.filter(i=> i && i.href) : [];
      const entries = socialArray.length ? socialArray : Object.entries(payload.socialLinks||{}).filter(([,url])=> !!url).map(([label, href])=> ({ label, href }));
      if(entries.length){
        redesSection.style.display='block';
        redesSub.textContent = 'Redes conectadas no cliente (clique para acessar)';
        redesDesc.textContent = `üìå ${entries.length} rede${entries.length===1?'':'s'} com link configurado ‚Äî ${payload.labelMonth||''}`;
        const frag = document.createDocumentFragment();
        entries.forEach(item=>{
          const label = item.label || (Array.isArray(item) ? item[0] : 'Rede');
          const href = item.href || (Array.isArray(item) ? item[1] : '');
          const card = document.createElement('div'); card.className='macro-social-item';
          const icon = document.createElement('div'); icon.className='macro-social-icon';
          const info = document.createElement('div'); info.className='macro-social-info';
          const l = document.createElement('span'); l.className='macro-social-label'; l.textContent = label||'Rede';
          const d = document.createElement('span'); d.className='macro-social-detail'; d.textContent='Link conectado';
          info.append(l,d);
          const actions = document.createElement('div'); actions.className='macro-social-actions';
          const open = document.createElement('button'); open.className='btn small'; open.type='button'; open.textContent='Abrir';
          open.addEventListener('click', ()=>{ try{ const w=window.open(href,'_blank','noopener'); if(w) w.opener=null; else location.href=href; }catch{ location.href=href; } });
          actions.appendChild(open);
          // √≠cone com base no snapshot do header (se dispon√≠vel)
          if(item.iconInfo && item.iconInfo.type==='img' && item.iconInfo.src){
            const img = document.createElement('img'); img.src = item.iconInfo.src; img.alt = item.iconInfo.alt || label; icon.appendChild(img);
          } else if(item.iconInfo && item.iconInfo.type==='text' && item.iconInfo.text){
            icon.textContent = item.iconInfo.text; if(item.iconInfo.fontSize){ icon.style.fontSize = item.iconInfo.fontSize; }
          } else {
            // fallback: primeira letra
            icon.textContent = (label||'?').slice(0,1).toUpperCase();
          }
          card.append(icon, info, actions); frag.appendChild(card);
        });
        redesGrid.replaceChildren(frag);
      } else {
        redesSection.style.display='none';
      }
      
      // Gerar resumo em texto
      gerarResumoTexto(payload);
    }
    
    // Gera resumo em texto copi√°vel
    function gerarResumoTexto(payload){
      const resumoSection = document.getElementById('relatorioResumoTextoSection');
      const resumoContent = document.getElementById('relatorioResumoTextoContent');
      const btnCopiar = document.getElementById('btnCopiarResumo');
      
      if(!resumoSection || !resumoContent) return;
      
      const mesLabel = payload.labelMonth || mesISO || '';
      
      let resumo = `üìä RESUMO DO RELAT√ìRIO - ${mesLabel.toUpperCase()}\n`;
      resumo += `${'='.repeat(60)}\n\n`;
      
      // Stories e Posts - USAR DADOS DO PAYLOAD ao inv√©s do DOM
      const allPosts = Array.isArray(payload.posts) ? payload.posts : [];
      const storiesCount = allPosts.filter(p => p.target === 'stories').length;
      const postsCount = allPosts.length - storiesCount;
      
      resumo += `üì∏ STORIES PUBLICADOS\n`;
      resumo += `   Quantidade: ${storiesCount} ${storiesCount === 1 ? 'story' : 'stories'}\n\n`;
      
      resumo += `üì± POSTS DE FEED PUBLICADOS\n`;
      resumo += `   Quantidade: ${postsCount} ${postsCount === 1 ? 'post' : 'posts'}\n\n`;
      
      // Objetivos (Planejamento) - usar payload
      const goals = payload.goals || {};
      const goalsSummary = goals.summary || {};
      const goalsTotal = goalsSummary.total || 0;
      const goalsDone = goalsSummary.done || 0;
      const goalsProgress = goalsSummary.progress || 0;
      const goalsTodo = goalsSummary.todo || 0;
      
      if(goalsTotal > 0) {
        resumo += `üéØ OBJETIVOS DO M√äS (PLANEJAMENTO)\n`;
        resumo += `   Total de objetivos: ${goalsTotal}\n`;
        resumo += `   ‚úÖ Conclu√≠dos: ${goalsDone}\n`;
        resumo += `   üîÑ Em andamento: ${goalsProgress}\n`;
        resumo += `   ‚è≥ N√£o iniciados: ${goalsTodo}\n`;
        
        if(goalsTotal > 0) {
          const percentConcluido = Math.round((goalsDone / goalsTotal) * 100);
          resumo += `   Taxa de conclus√£o: ${percentConcluido}%\n`;
        }
        resumo += `\n`;
      }
      
      // Metas - usar payload
      const metas = Array.isArray(payload.metas) ? payload.metas : [];
      const metasAchieved = metas.filter(m => m.status === 'achieved').length;
      const metasProgress = metas.filter(m => m.status === 'progress').length;
      const metasMissing = metas.filter(m => m.status === 'missing').length;
      const metasTotal = metas.length;
      
      if(metasTotal > 0) {
        resumo += `üìà METAS DO M√äS\n`;
        resumo += `   Total de metas: ${metasTotal}\n`;
        resumo += `   ‚úÖ Atingidas: ${metasAchieved}\n`;
        resumo += `   üîÑ Em andamento: ${metasProgress}\n`;
        resumo += `   ‚ö†Ô∏è Precisa colocar: ${metasMissing}\n`;
        
        if(metasTotal > 0) {
          const percentAtingido = Math.round((metasAchieved / metasTotal) * 100);
          resumo += `   Taxa de atingimento: ${percentAtingido}%\n`;
        }
        resumo += `\n`;
      }
      
      // Leads - usar payload.leadsAnalysis
      const leadsCount = payload.leadsCount || 0;
      
      if(leadsCount > 0) {
        resumo += `üéØ LEADS GERADOS\n`;
        resumo += `   Total de leads: ${leadsCount}\n`;
        
        // Usar an√°lise do payload se dispon√≠vel
        const analysis = payload.leadsAnalysis || {};
        
        // Plataformas
        if(analysis.platforms && analysis.platforms.length > 0) {
          resumo += `\n   Por Plataforma:\n`;
          analysis.platforms.forEach(p => {
            resumo += `   ${p.emoji} ${p.name}: ${p.count} (${p.percent}%)\n`;
          });
        }
        
        // Fontes
        if(analysis.sources && analysis.sources.length > 0) {
          resumo += `\n   Por Fonte:\n`;
          analysis.sources.forEach(s => {
            resumo += `   ${s.emoji} ${s.name}: ${s.count} (${s.percent}%)\n`;
          });
        }
        
        // Top perguntas
        if(analysis.topQuestions && analysis.topQuestions.length > 0) {
          resumo += `\n   Principais Perguntas:\n`;
          analysis.topQuestions.forEach((q, idx) => {
            resumo += `   ${idx + 1}. ${q.question} (${q.count} ${q.count === 1 ? 'lead' : 'leads'})\n`;
          });
        }
        
        resumo += `\n`;
      }
      
      // Redes trabalhadas - usar payload
      const redes = Array.isArray(payload.redes) ? payload.redes : [];
      const redesCount = redes.length;
      if(redesCount > 0) {
        resumo += `üîó REDES TRABALHADAS\n`;
        resumo += `   Quantidade: ${redesCount} ${redesCount === 1 ? 'rede' : 'redes'} com link configurado\n\n`;
      }
      
      // Rodap√©
      resumo += `${'='.repeat(60)}\n`;
      resumo += `Relat√≥rio gerado em ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}\n`;
      
      resumoContent.textContent = resumo;
      resumoSection.style.display = 'block';
      
      // Evento de copiar
      if(btnCopiar && !btnCopiar.dataset.listenerAdded){
        btnCopiar.dataset.listenerAdded = 'true';
        btnCopiar.addEventListener('click', async ()=>{
          const texto = resumoContent.textContent;
          try {
            if(navigator.clipboard?.writeText) {
              await navigator.clipboard.writeText(texto);
              const original = btnCopiar.textContent;
              btnCopiar.textContent = '‚úÖ Copiado!';
              btnCopiar.style.background = 'rgba(16, 185, 129, 0.3)';
              btnCopiar.style.borderColor = 'rgba(16, 185, 129, 0.5)';
              setTimeout(() => {
                btnCopiar.textContent = original;
                btnCopiar.style.background = '';
                btnCopiar.style.borderColor = '';
              }, 2000);
            } else {
              const textArea = document.createElement('textarea');
              textArea.value = texto;
              textArea.style.position = 'fixed';
              textArea.style.left = '-9999px';
              document.body.appendChild(textArea);
              textArea.select();
              document.execCommand('copy');
              document.body.removeChild(textArea);
              alert('‚úÖ Resumo copiado!');
            }
          } catch(err) {
            console.error('Erro ao copiar:', err);
            alert('Erro ao copiar. Tente selecionar e copiar manualmente.');
          }
        });
      }
    }

    // === Sistema de gera√ß√£o autom√°tica de thumbnails para v√≠deos ===
    const VIDEO_THUMBNAILS_CACHE = new Map();

    async function generateVideoThumbnail(videoUrl, postId) {
      console.log('[Relatorio] Gerando thumbnail para:', videoUrl);
      
      if (VIDEO_THUMBNAILS_CACHE.has(videoUrl)) {
        console.log('[Relatorio] Retornando do cache');
        return VIDEO_THUMBNAILS_CACHE.get(videoUrl);
      }

      // Tenta duas vezes: primeiro sem CORS, depois com CORS se falhar
      const tryGenerate = (useCors = false) => {
        return new Promise((resolve, reject) => {
          const video = document.createElement('video');
          video.preload = 'metadata';
          video.muted = true;
          video.playsInline = true;
          if (useCors) {
            video.crossOrigin = 'anonymous';
            console.log('[Relatorio] Tentando com crossOrigin=anonymous');
          }
          
          const timeout = setTimeout(() => {
            console.error('[Relatorio] Timeout ao carregar v√≠deo (useCors:', useCors, ')');
            video.src = '';
            reject(new Error('Timeout ao gerar thumbnail'));
          }, 20000); // 20s timeout

          video.onloadedmetadata = () => {
            console.log('[Relatorio] Metadata carregada, dura√ß√£o:', video.duration, 'dimens√µes:', video.videoWidth, 'x', video.videoHeight);
            const seekTime = Math.min(0.5, video.duration * 0.1);
            video.currentTime = seekTime;
          };
          
          video.onseeked = () => {
            console.log('[Relatorio] Frame encontrado, capturando canvas...');
            try {
              clearTimeout(timeout);
              
              const canvas = document.createElement('canvas');
              canvas.width = video.videoWidth || 640;
              canvas.height = video.videoHeight || 360;
              
              const ctx = canvas.getContext('2d', { willReadFrequently: false });
              ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
              
              const thumbnailDataUrl = canvas.toDataURL('image/jpeg', 0.8);
              
              console.log('[Relatorio] ‚úÖ Thumbnail gerada com sucesso! Tamanho:', thumbnailDataUrl.length, 'bytes');
              
              VIDEO_THUMBNAILS_CACHE.set(videoUrl, thumbnailDataUrl);
              video.src = '';
              
              resolve(thumbnailDataUrl);
            } catch (err) {
              clearTimeout(timeout);
              console.error('[Relatorio] ‚ùå Erro ao capturar frame do canvas:', err);
              video.src = '';
              reject(err);
            }
          };
          
          video.onerror = (err) => {
            clearTimeout(timeout);
            console.error('[Relatorio] ‚ùå Erro ao carregar v√≠deo:', err, 'errorCode:', video.error?.code, 'message:', video.error?.message);
            video.src = '';
            reject(err);
          };
          
          // Garante HTTPS
          let safeUrl = videoUrl;
          if (videoUrl.includes('firebasestorage.googleapis.com') && videoUrl.startsWith('http://')) {
            safeUrl = videoUrl.replace('http://', 'https://');
            console.log('[Relatorio] URL convertida para HTTPS:', safeUrl);
          }
          
          video.src = safeUrl;
        });
      };

      // Tenta sem CORS primeiro, depois com CORS se falhar
      try {
        return await tryGenerate(false);
      } catch (err) {
        console.warn('[Relatorio] Primeira tentativa falhou, tentando com CORS...');
        return await tryGenerate(true);
      }
    }

    // Lazy + throttled thumbnail generation para reduzir jank
    const THUMB_QUEUE = [];
    let THUMB_WORKERS = 0;
    const MAX_WORKERS = 2;
    let thumbObserver = null;

    function startThumbWorkers(){
      while(THUMB_WORKERS < MAX_WORKERS && THUMB_QUEUE.length){
        const container = THUMB_QUEUE.shift();
        if(!container || container.dataset.thumbProcessing==='1') continue;
        THUMB_WORKERS++;
        container.dataset.thumbProcessing = '1';
        // Micro-yield para n√£o travar
        requestAnimationFrame(()=> processContainerThumbnail(container).finally(()=>{
          THUMB_WORKERS = Math.max(0, THUMB_WORKERS-1);
          // Continua fila
          if(THUMB_QUEUE.length){ startThumbWorkers(); }
        }));
      }
    }

    async function processContainerThumbnail(container){
      try{
        if(!container || container.classList.contains('has-thumb')) return;
        const videoUrl = container.getAttribute('data-video-url');
        const postId = container.getAttribute('data-id');
        console.log('[Relatorio] Processando thumbnail - postId:', postId, 'url:', videoUrl);
        
        if(!videoUrl) {
          console.warn('[Relatorio] Container sem data-video-url, ignorando');
          return;
        }
        
        // Evita duplicado
        if(container.querySelector('img')){ 
          console.log('[Relatorio] Container j√° tem img, marcando como processado');
          container.classList.add('has-thumb'); 
          return; 
        }
        
        const thumbnailUrl = await generateVideoThumbnail(videoUrl, postId);
        
        if (container.getAttribute('data-video-url') !== videoUrl) {
          console.warn('[Relatorio] URL mudou durante processamento, abortando');
          return; // mudou
        }
        
        const img = document.createElement('img');
        img.src = thumbnailUrl;
        img.alt = 'Video preview';
        img.decoding = 'async';
        img.loading = 'lazy';
        img.style.cssText = 'width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0;display:block;background:#000';
        
        // Trata erro de carregamento da imagem
        img.onerror = () => {
          console.warn('[Relatorio] ‚ùå Erro ao exibir thumbnail gerada, usando fallback de √≠cone');
          img.remove();
          addVideoPlayIcon(container);
        };
        
        img.onload = () => {
          console.log('[Relatorio] ‚úÖ Thumbnail exibida com sucesso para postId:', postId);
        };
        
        const span = container.querySelector('span'); 
        if(span) span.remove();
        container.appendChild(img);
        container.classList.add('has-thumb');
        
      }catch(err){
        console.error('[Relatorio] ‚ùå Falha ao gerar thumbnail:', err.message, 'para postId:', container?.getAttribute('data-id'));
        // Adiciona indicador visual de que √© um v√≠deo mesmo que falhe
        if(container && !container.classList.contains('has-thumb')){
          addVideoPlayIcon(container);
        }
      }finally{
        if(container) delete container.dataset.thumbProcessing;
      }
    }

    function addVideoPlayIcon(container) {
      const playIcon = document.createElement('div');
      playIcon.style.cssText = 'position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:3rem;color:#fff;text-shadow:0 2px 8px rgba(0,0,0,.8);pointer-events:none;z-index:1;';
      playIcon.textContent = '‚ñ∂';
      container.appendChild(playIcon);
      container.classList.add('has-thumb');
      console.log('[Relatorio] √çcone de play adicionado como fallback');
    }

    function enqueueContainer(c){
      if(!c || c.classList.contains('has-thumb')) return;
      THUMB_QUEUE.push(c);
      startThumbWorkers();
    }

    function applyVideoThumbnails() {
      const items = document.querySelectorAll('.relatorio-story-item[data-video-url]');
      if('IntersectionObserver' in window){
        if(!thumbObserver){
          thumbObserver = new IntersectionObserver((entries)=>{
            entries.forEach(entry=>{
              const el = entry.target;
              if(entry.isIntersecting){
                thumbObserver.unobserve(el);
                enqueueContainer(el);
              }
            });
          }, { root:null, rootMargin:'200px 0px', threshold:0.01 });
        }
        items.forEach(el=>{ if(!el.dataset.thumbObserved){ el.dataset.thumbObserved='1'; thumbObserver.observe(el); } });
      }else{
        // Fallback: processa todos, com fila
        items.forEach(el=> enqueueContainer(el));
      }
    }

    function renderStoriesAndPosts(posts, labelMonth){
      console.log('[Relatorio] renderStoriesAndPosts chamado - total posts:', posts.length);
      const monthLabel = labelMonth || document.getElementById('reportMonth').textContent || '';
      const parts = monthLabel.split(' ');
      const ano = parts.length>1 ? parts[1] : '';
      // Split
      const stories = posts.filter(p=> (p.target||'feed')==='stories');
      const feed = posts.filter(p=> (p.target||'feed')==='feed');
      
      console.log('[Relatorio] Stories encontrados:', stories.length);
      console.log('[Relatorio] Posts de feed encontrados:', feed.length);
      
      if(stories.length > 0){
        console.log('[Relatorio] Primeiro story:', stories[0]);
      }
      if(feed.length > 0){
        console.log('[Relatorio] Primeiro post:', feed[0]);
      }

      // Helper para garantir HTTPS nas URLs do Firebase Storage
      const ensureHttps = (url) => {
        if (!url) return '';
        const urlStr = String(url);
        if ((urlStr.includes('firebasestorage.googleapis.com') || urlStr.includes('firebasestorage.app')) && urlStr.startsWith('http://')) {
          return urlStr.replace('http://', 'https://');
        }
        return urlStr;
      };

      // Helpers
      const buildCard = (p)=>{
        const first = ensureHttps(p.thumbUrl || (Array.isArray(p.mediaUrls)&&p.mediaUrls[0]) || '');
        const ext = String(first).split('?')[0].split('.').pop().toLowerCase();
        const isVideo = ['mp4','mov','webm','m4v','avi'].includes(ext);
        let cls = 'relatorio-story-item';
        if((p.status||'')==='aprovado'){
          cls += (p.approvedBy==='interno')? ' aprovado-interno':' aprovado';
        } else if((p.status||'')==='revisar'){
          cls += ' revisar';
        } else {
          cls += ' pendente';
        }
        if(isVideo) cls += ' video';
        const [y,m,d] = String(p.dateISO||'').split('-');
        const dateLabel = (d&&m)? `${d}/${m}` : '';
        
        // Se √© v√≠deo e tem thumbUrl personalizada (capa), usa ela
        if(isVideo && p.thumbUrl && !p.thumbUrl.includes('.mp4') && !p.thumbUrl.includes('.mov') && !p.thumbUrl.includes('.webm')) {
          const safeThumbUrl = ensureHttps(p.thumbUrl);
          return `<div class="${cls}" data-id="${p.id||''}"><img src="${safeThumbUrl}" alt="${(p.target||'')==='stories'?'Story':'Post'} ${dateLabel}" loading="lazy"><div class="relatorio-story-status"></div><div class="relatorio-story-date">${dateLabel}</div></div>`;
        }
        
        // Se √© v√≠deo sem capa, adiciona data-video-url para gerar thumbnail
        if(isVideo && first) {
          return `<div class="${cls}" data-id="${p.id||''}" data-video-url="${first}"><div class="relatorio-story-status"></div><div class="relatorio-story-date">${dateLabel}</div></div>`;
        }
        
        // Se √© imagem ou n√£o tem m√≠dia
        const img = first ? `<img src="${first}" alt="${(p.target||'')==='stories'?'Story':'Post'} ${dateLabel}" loading="lazy">` : '';
        return `<div class="${cls}" data-id="${p.id||''}">${img}<div class="relatorio-story-status"></div><div class="relatorio-story-date">${dateLabel}</div></div>`;
      };

      // Stories section
      const s = els.stories; if(s && s.section){
        if(stories.length){
          s.section.style.display='block';
          if(s.subtitle){
            const meses = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
            let mesNome = '';
            try{ const match = monthLabel.match(/^(\p{L}+)/u); mesNome = match?match[1]:monthLabel; }catch(_){ mesNome = monthLabel; }
            s.subtitle.textContent = `${stories.length} ${stories.length===1?'story':'stories'} produzid${stories.length===1?'o':'os'} em ${monthLabel}`;
          }
          if(s.desc){
            const total = stories.length;
            const aprov = stories.filter(p=> (p.status||'')==='aprovado').length;
            const revisar = stories.filter(p=> (p.status||'')==='revisar').length;
            const pend = Math.max(0, total - aprov - revisar);
            const rate = total>0 ? Math.round((aprov/total)*100) : 0;
            s.desc.style.display='block';
            s.desc.textContent = `‚ú® ${monthLabel}: ${total} ${total===1?'story':'stories'} ‚Äî ${aprov} aprovados (${rate}%), ${revisar} para revisar, ${pend} pendentes.`;
          }
          s.grid.innerHTML = stories.sort((a,b)=> String(a.dateISO||'').localeCompare(String(b.dateISO||''))).map(buildCard).join('');
          s.prev?.addEventListener('click', ()=> s.grid.scrollBy({left:-200, behavior:'smooth'}));
          s.next?.addEventListener('click', ()=> s.grid.scrollBy({left: 200, behavior:'smooth'}));
          
          // Gera thumbnails para v√≠deos
          setTimeout(() => {
            console.log('[Relatorio] Aplicando thumbnails aos stories');
            applyVideoThumbnails();
          }, 100);
        } else {
          s.section.style.display='none';
        }
      }

      // Posts section
      const psec = els.posts; if(psec && psec.section){
        if(feed.length){
          psec.section.style.display='block';
          if(psec.subtitle){
            psec.subtitle.textContent = `${feed.length} ${feed.length===1?'post':'posts'} produzid${feed.length===1?'o':'os'} em ${monthLabel}`;
          }
          if(psec.desc){
            const total = feed.length;
            const aprov = feed.filter(p=> (p.status||'')==='aprovado').length;
            const revisar = feed.filter(p=> (p.status||'')==='revisar').length;
            const pend = Math.max(0, total - aprov - revisar);
            const rate = total>0 ? Math.round((aprov/total)*100) : 0;
            psec.desc.style.display='block';
            psec.desc.textContent = `‚ú® ${monthLabel}: ${total} ${total===1?'post':'posts'} no feed ‚Äî ${aprov} aprovados (${rate}%), ${revisar} para revisar, ${pend} pendentes.`;
          }
          psec.grid.innerHTML = feed.sort((a,b)=> String(a.dateISO||'').localeCompare(String(b.dateISO||''))).map(buildCard).join('');
          psec.prev?.addEventListener('click', ()=> psec.grid.scrollBy({left:-200, behavior:'smooth'}));
          psec.next?.addEventListener('click', ()=> psec.grid.scrollBy({left: 200, behavior:'smooth'}));
          
          // Gera thumbnails para v√≠deos
          setTimeout(() => {
            console.log('[Relatorio] Aplicando thumbnails aos posts');
            applyVideoThumbnails();
          }, 150);
        } else {
          psec.section.style.display='none';
        }
      }
    }

    function renderGoals(goals, labelMonth){
      const g = els.goals; if(!g || !g.section) return;
      if(!goals || !Array.isArray(goals.items) || goals.items.length===0){ g.section.style.display='none'; return; }
      g.section.style.display='block';
      const total = Number(goals.summary?.total)||goals.items.length;
      const done = Number(goals.summary?.done)||0;
      const progress = Number(goals.summary?.progress)||0;
      const todo = Number(goals.summary?.todo)||0;
      if(g.subtitle) g.subtitle.textContent = `Resumo de ${total} objetivo${total===1?'':'s'} em ${labelMonth}`;
      g.donePill?.querySelector('strong')?.replaceWith(Object.assign(document.createElement('strong'),{textContent:String(done)}));
      g.progressPill?.querySelector('strong')?.replaceWith(Object.assign(document.createElement('strong'),{textContent:String(progress)}));
      g.todoPill?.querySelector('strong')?.replaceWith(Object.assign(document.createElement('strong'),{textContent:String(todo)}));
      if(g.desc){
        const rate = total>0 ? Math.round((done/total)*100) : 0;
        g.desc.textContent = `üöÄ ${labelMonth}: ${total} objetivo${total===1?'':'s'} ‚Äî Conclu√≠dos: ${done} (${rate}%), Em andamento: ${progress}, N√£o iniciados: ${todo}.`;
      }
      const groups = { 'concluido':[], 'em-andamento':[], 'nao-iniciado':[] };
      goals.items.forEach(item=>{
        const st = (item.status||'').toLowerCase();
        const key = (st==='concluido') ? 'concluido' : ((st==='em-andamento'||st==='bloqueado'||st==='prioridade'||st==='prioridade-grupo') ? 'em-andamento' : 'nao-iniciado');
        groups[key].push(item);
      });
      const renderCard = (d)=>{
        const title = (d.title||'').trim() || '(Sem t√≠tulo)';
        const resp = (d.responsavel||'').trim();
        const date = (d.endDate||'').split('-');
        const dateLabel = (date.length===3) ? `${date[2]}/${date[1]}` : '';
        const tag = (d.tag||'').toString();
        const statusKey = (d.status||'').toLowerCase();
        const statusLabel = (statusKey==='concluido')? 'Conclu√≠do' : (statusKey==='em-andamento'?'Em andamento': (statusKey||''));
        return `<div class="goal-card"><div class="goal-title">${escapeHtml(title)}</div><div class="goal-meta">${resp?`<span class=\"goal-tag\">üë§ ${escapeHtml(resp)}</span>`:''}${dateLabel?`<span class=\"goal-tag\">üìÖ ${dateLabel}</span>`:''}${statusLabel?`<span class=\"goal-tag\">${escapeHtml(statusLabel)}</span>`:''}${tag?`<span class=\"goal-tag\">üè∑Ô∏è ${escapeHtml(tag)}</span>`:''}</div></div>`;
      };
      g.done.innerHTML = groups['concluido'].map(renderCard).join('');
      g.progress.innerHTML = groups['em-andamento'].map(renderCard).join('');
      g.todo.innerHTML = groups['nao-iniciado'].map(renderCard).join('');
    }

    // Preenche p√°gina p√∫blica a partir do snapshot do token
    function renderFromPayload(payload){
      if(payload && payload.labelMonth){
        document.getElementById('reportMonth').textContent = payload.labelMonth;
        document.getElementById('relatorioHeaderSubtitle').textContent = `Resumo do m√™s ${payload.labelMonth}`;
      }
      renderReportSections(payload||{});
      
      // Gerar preview para redes sociais (async)
      setTimeout(() => {
        generateSocialPreview(payload).catch(err => {
          console.error('[Relatorio] ‚ùå Erro ao gerar preview:', err);
        });
      }, 1000);
    }
    
    // Gera imagem de preview para WhatsApp/Redes Sociais
    async function generateSocialPreview(payload) {
      try {
        console.log('[Relatorio] üì∏ Gerando preview social...');
        
        const canvas = document.createElement('canvas');
        canvas.width = 1200;
        canvas.height = 630;
        const ctx = canvas.getContext('2d');
        
        // Fundo gradiente
        const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        gradient.addColorStop(0, '#0b1020');
        gradient.addColorStop(0.5, '#111936');
        gradient.addColorStop(1, '#1a2847');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // T√≠tulo
        ctx.fillStyle = '#ff6633';
        ctx.font = 'bold 72px Arial, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('üìä Relat√≥rio Mensal', canvas.width / 2, 120);
        
        // M√™s
        if(payload && payload.labelMonth) {
          ctx.fillStyle = '#e2e8f0';
          ctx.font = 'bold 56px Arial, sans-serif';
          ctx.fillText(payload.labelMonth, canvas.width / 2, 200);
        }
        
        // Linha separadora
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(200, 250);
        ctx.lineTo(1000, 250);
        ctx.stroke();
        
        // Estat√≠sticas
        let yPos = 320;
        const stats = [];
        
        // Posts/Stories
        const postsCount = Array.isArray(payload.posts) ? payload.posts.length : 0;
        const storiesCount = Array.isArray(payload.posts) ? payload.posts.filter(p => p.target === 'stories').length : 0;
        const feedCount = postsCount - storiesCount;
        
        if(storiesCount > 0) stats.push(`üì∏ ${storiesCount} Stories`);
        if(feedCount > 0) stats.push(`üì± ${feedCount} Posts`);
        
        // Objetivos
        if(payload.goals && payload.goals.summary) {
          const total = payload.goals.summary.total || 0;
          const done = payload.goals.summary.done || 0;
          if(total > 0) stats.push(`üéØ ${done}/${total} Objetivos`);
        }
        
        // Metas
        const metasCount = Array.isArray(payload.metas) ? payload.metas.length : 0;
        if(metasCount > 0) stats.push(`üìà ${metasCount} Metas`);
        
        // Leads
        const leadsCount = payload.leadsCount || 0;
        if(leadsCount > 0) stats.push(`üéØ ${leadsCount} Leads`);
        
        // Renderizar estat√≠sticas
        ctx.fillStyle = '#86efac';
        ctx.font = 'bold 42px Arial, sans-serif';
        ctx.textAlign = 'left';
        
        const leftCol = stats.slice(0, 3);
        const rightCol = stats.slice(3);
        
        leftCol.forEach((stat, i) => {
          ctx.fillText(stat, 200, yPos + (i * 70));
        });
        
        if(rightCol.length > 0) {
          ctx.textAlign = 'right';
          rightCol.forEach((stat, i) => {
            ctx.fillText(stat, 1000, yPos + (i * 70));
          });
        }
        
        // Rodap√©
        ctx.fillStyle = '#94a3b8';
        ctx.font = '32px Arial, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('MediaGrowth Dashboard', canvas.width / 2, 590);
        
        // Converter canvas para blob
        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
        
        // Verificar se tem token (link compartilhado)
        if(shareToken) {
          console.log('[Relatorio] üì§ Fazendo upload da imagem para Firebase Storage...');
          
          try {
            // Upload para Firebase Storage
            const filename = `preview-${shareToken}.png`;
            const storageRef = sRef(storage, `previews/${filename}`);
            await uploadBytes(storageRef, blob);
            const publicUrl = await getDownloadURL(storageRef);
            
            console.log('[Relatorio] ‚úÖ Upload conclu√≠do! URL:', publicUrl);
            
            // Atualizar meta tags com URL p√∫blica
            const ogImage = document.querySelector('meta[property="og:image"]');
            const twitterImage = document.querySelector('meta[name="twitter:image"]');
            
            if(ogImage) ogImage.setAttribute('content', publicUrl);
            if(twitterImage) twitterImage.setAttribute('content', publicUrl);
            
            // Salvar URL no documento do Firestore para cache
            try {
              const shareDoc = doc(db, 'reportShares', shareToken);
              await setDoc(shareDoc, { previewUrl: publicUrl }, { merge: true });
              console.log('[Relatorio] ‚úÖ URL salva no Firestore para cache');
            } catch(err) {
              console.warn('[Relatorio] ‚ö†Ô∏è N√£o foi poss√≠vel salvar URL no Firestore:', err);
            }
            
            console.log('[Relatorio] ‚úÖ Preview gerado e salvo com sucesso!');
          } catch(uploadErr) {
            console.error('[Relatorio] ‚ùå Erro no upload:', uploadErr);
            // Fallback para data URL
            const imageDataUrl = canvas.toDataURL('image/png');
            document.querySelector('meta[property="og:image"]')?.setAttribute('content', imageDataUrl);
            document.querySelector('meta[name="twitter:image"]')?.setAttribute('content', imageDataUrl);
          }
        } else {
          console.log('[Relatorio] ‚ö†Ô∏è Sem token, usando data URL (pode n√£o funcionar no WhatsApp)');
          const imageDataUrl = canvas.toDataURL('image/png');
          document.querySelector('meta[property="og:image"]')?.setAttribute('content', imageDataUrl);
          document.querySelector('meta[name="twitter:image"]')?.setAttribute('content', imageDataUrl);
        }
        
      } catch(err) {
        console.error('[Relatorio] ‚ùå Erro ao gerar preview:', err);
      }
    }

    // Global error handler para imagens (debug em produ√ß√£o)
    document.addEventListener('error', (e) => {
      if (e.target.tagName === 'IMG') {
        const img = e.target;
        const src = img.src;
        console.error('[Relatorio] Falha ao carregar imagem:', src);
        console.error('[Relatorio] Elemento pai:', img.parentElement?.className);
        console.error('[Relatorio] Protocolo:', src.startsWith('https://') ? 'HTTPS ‚úì' : 'HTTP ‚úó');
        
        // Marca a imagem com erro
        img.setAttribute('data-error', 'true');
        
        // Se for uma imagem de story/post, adiciona fallback visual
        const container = img.closest('.relatorio-story-item');
        if (container && !container.querySelector('.error-fallback')) {
          const fallback = document.createElement('div');
          fallback.className = 'error-fallback';
          fallback.style.cssText = 'position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#ff6633;font-size:2rem;text-shadow:0 2px 8px rgba(0,0,0,.8);pointer-events:none;';
          fallback.textContent = 'üì∑';
          container.appendChild(fallback);
        }
      }
    }, true); // capture phase para pegar todos os erros

    // Log inicial para debug
    console.log('[Relatorio] Script carregado. Modo:', shareToken ? 'P√∫blico (token)' : 'Autenticado');
    console.log('[Relatorio] M√™s:', mesISO);
    console.log('[Relatorio] Tenant:', TENANT);
  </script>
</body>
</html>

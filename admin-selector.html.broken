<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <title>Painel Admin - Sele√ß√£o de Empresas</title>
  <link rel="icon" type="image/png" href="favicon.png"/>
  <style>
    :root {
      --accent: #ff6600;
      --bg: #000;
      --panel: #111;
      --input: #1a1a1a;
      --border: #333;
      --muted: #bbb;
      --shell-border: rgba(255,255,255,.14);
      --title-bg: rgba(0,0,0,.35);
    }

    * {
      box-sizing: border-box;
    }

    html {
      background: linear-gradient(135deg, var(--bg), #1a1a1a 40%, var(--accent) 120%);
      background-attachment: fixed;
      min-height: 100vh;
    }

    body {
      margin: 0;
      color: #fff;
      font-family: Arial, Helvetica, sans-serif;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      padding: 20px;
    }

    h1 {
      text-align: center;
      font-size: 1.8rem;
      margin: 20px 0 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    h1 img {
      height: 50px;
      width: auto;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }

    .user-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--panel);
      border: 1px solid var(--shell-border);
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,.35);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 1.2rem;
      color: #000;
    }

    .user-details {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .user-name {
      font-weight: 700;
      font-size: 0.95rem;
    }

    .user-role {
      font-size: 0.75rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .btn {
      display: inline-block;
      border: 0;
      border-radius: 10px;
      padding: 10px 16px;
      font-weight: 700;
      color: #fff;
      background: var(--accent);
      cursor: pointer;
      transition: transform 0.2s, filter 0.2s;
    }

    .btn:hover {
      transform: translateY(-2px);
      filter: brightness(1.1);
    }

    .btn.secondary {
      background: #333;
    }

    .section {
      background: var(--panel);
      border: 1px solid var(--shell-border);
      border-radius: 14px;
      padding: 20px;
      margin-bottom: 24px;
      box-shadow: 0 8px 20px rgba(0,0,0,.35);
    }

    .section-title {
      font-size: 1.2rem;
      font-weight: 800;
      margin: 0 0 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .add-company-form {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      margin-bottom: 24px;
    }

    .input {
      width: 100%;
      background: var(--input);
      border: 1px solid var(--border);
      color: #fff;
      border-radius: 10px;
      padding: 12px 14px;
      font-size: 0.95rem;
    }

    .input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .companies-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }

    .company-card {
      background: rgba(255,255,255,.04);
      border: 1px solid var(--shell-border);
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .company-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 28px rgba(0,0,0,.4);
      background: rgba(255,255,255,.08);
      border-color: var(--accent);
    }

    .company-header {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .company-logo {
      width: 50px;
      height: 50px;
      border-radius: 10px;
      background: rgba(255,255,255,.08);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--accent);
      overflow: hidden;
    }

    .company-logo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .company-info {
      flex: 1;
      min-width: 0;
    }

    .company-name {
      font-weight: 800;
      font-size: 1.05rem;
      margin: 0 0 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .company-email {
      font-size: 0.8rem;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .company-stats {
      display: flex;
      gap: 12px;
      font-size: 0.75rem;
      color: #cbd5f5;
      border-top: 1px solid rgba(255,255,255,.1);
      padding-top: 12px;
    }

    .company-stat {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .company-stat-label {
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .company-stat-value {
      font-weight: 700;
      color: #fff;
      font-size: 0.9rem;
    }

    .company-actions {
      display: flex;
      gap: 8px;
      margin-top: auto;
    }

    .company-actions .btn {
      flex: 1;
      padding: 8px 12px;
      font-size: 0.85rem;
      text-align: center;
    }

    .btn.danger {
      background: #991b1b;
      border: 1px solid rgba(239,68,68,.6);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state-text {
      font-size: 1.1rem;
      margin-bottom: 8px;
    }

    .empty-state-hint {
      font-size: 0.9rem;
      opacity: 0.7;
    }

    .auth-box {
      width: 100%;
      max-width: 400px;
      margin: 100px auto;
      background: var(--panel);
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.4);
      padding: 24px;
    }

    .auth-box h2 {
      margin: 0 0 20px;
      text-align: center;
      font-size: 1.4rem;
    }

    .field {
      margin: 12px 0;
    }

    .divider {
      height: 2px;
      background: #ddd;
      opacity: 0.4;
      margin: 16px 0;
    }

    #authArea {
      display: none;
    }

    #appArea {
      display: none;
    }

    .loading {
      text-align: center;
      padding: 40px;
      font-size: 1.2rem;
      color: var(--muted);
    }

    .mg-toast {
      position: fixed;
      left: 50%;
      bottom: 22px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.85);
      color: #fff;
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.2);
      z-index: 100000;
      font-weight: 800;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    @media (max-width: 768px) {
      .companies-grid {
        grid-template-columns: 1fr;
      }

      .add-company-form {
        grid-template-columns: 1fr;
      }

      h1 {
        font-size: 1.4rem;
      }

      .user-bar {
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
      }
    }
  </style>
</head>
<body>
  <!-- √Årea de Login -->
  <div id="authArea">
    <div class="auth-box">
      <h2>üîê Login Admin</h2>
      <button class="btn" id="loginGoogle">Entrar com Google</button>
      <div class="divider"></div>
      <div class="field">
        <input class="input" id="email" type="email" placeholder="E-mail" autocomplete="username">
      </div>
      <div class="field">
        <input class="input" id="password" type="password" placeholder="Senha" autocomplete="current-password">
      </div>
      <button class="btn" id="loginEmail">Entrar</button>
      <p id="authStatus" style="font-size:.85rem;color:#bbb;margin:12px 0 0;text-align:center;"></p>
    </div>
  </div>

  <!-- √Årea Principal -->
  <div id="appArea">
    <div class="container">
      <h1>
        <img src="./logosite.svg" alt="Logo" onerror="this.style.display='none'"/>
        Painel Admin - Empresas
      </h1>

      <div class="user-bar">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">A</div>
          <div class="user-details">
            <div class="user-name" id="userName">Admin</div>
            <div class="user-role" id="userRole">Administrador</div>
          </div>
        </div>
        <button class="btn secondary" id="logoutBtn">Sair</button>
      </div>

      <div class="section">
        <div class="section-title">‚ûï Adicionar Empresa</div>
        <div class="add-company-form">
          <input 
            type="text" 
            id="companyEmail" 
            class="input" 
            placeholder="Digite o UID do Firebase (ex: fwc3gltXsfdpuIF6o7AFtj212)"
          >
          <button class="btn" id="addCompanyBtn">Adicionar por UID</button>
        </div>
        <p style="font-size:0.85rem;color:var(--muted);margin:0;line-height:1.6;">
          üí° <strong>Como obter o UID:</strong><br>
          1. Acesse o <a href="https://console.firebase.google.com/project/mediagrowth-a5349/authentication/users" target="_blank" style="color:#667eea;text-decoration:underline;">Firebase Console ‚Üí Authentication</a><br>
          2. Procure o email da empresa na lista<br>
          3. Copie o <strong>User UID</strong> e cole acima<br>
          <span style="color:#f59e0b;">‚ö†Ô∏è Importante: Use o UID, n√£o o email</span>
        </p>
      </div>

      <div class="section">
        <div class="section-title">üè¢ Minhas Empresas (<span id="companyCount">0</span>)</div>
        <div class="companies-grid" id="companiesGrid">
          <div class="empty-state">
            <div class="empty-state-icon">üè¢</div>
            <div class="empty-state-text">Nenhuma empresa vinculada</div>
            <div class="empty-state-hint">Adicione empresas usando o formul√°rio acima</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="loadingArea" class="loading">
    Carregando...
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { 
      getAuth, 
      signInWithPopup, 
      GoogleAuthProvider, 
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { 
      getFirestore, 
      doc, 
      getDoc, 
      setDoc, 
      updateDoc,
      deleteDoc,
      collection,
      query,
      where,
      getDocs,
      serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD4CbPQWrwOcfANX3ar0ibmGN20ffsRCqo",
      authDomain: "mediagrowth-a5349.firebaseapp.com",
      projectId: "mediagrowth-a5349",
      storageBucket: "mediagrowth-a5349.firebasestorage.app",
      messagingSenderId: "568656972714",
      appId: "1:568656972714:web:cd20fa37e6a962f38ac0d5"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Elements
    const authArea = document.getElementById('authArea');
    const appArea = document.getElementById('appArea');
    const loadingArea = document.getElementById('loadingArea');
    const loginGoogle = document.getElementById('loginGoogle');
    const loginEmail = document.getElementById('loginEmail');
    const logoutBtn = document.getElementById('logoutBtn');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const authStatus = document.getElementById('authStatus');
    const userName = document.getElementById('userName');
    const userRole = document.getElementById('userRole');
    const userAvatar = document.getElementById('userAvatar');
    const companyEmail = document.getElementById('companyEmail');
    const addCompanyBtn = document.getElementById('addCompanyBtn');
    const companiesGrid = document.getElementById('companiesGrid');
    const companyCount = document.getElementById('companyCount');

    let currentUser = null;
    let adminData = null;

    // Toast helper
    function mgToast(msg) {
      const toast = document.createElement('div');
      toast.className = 'mg-toast';
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Login com Google
    loginGoogle.onclick = async () => {
      try {
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
        authStatus.textContent = '';
      } catch (err) {
        console.error(err);
        authStatus.textContent = 'Erro ao fazer login: ' + err.message;
      }
    };

    // Login com Email
    loginEmail.onclick = async () => {
      try {
        const email = emailInput.value.trim();
        const password = passwordInput.value;
        if (!email || !password) {
          authStatus.textContent = 'Preencha email e senha';
          return;
        }
        await signInWithEmailAndPassword(auth, email, password);
        authStatus.textContent = '';
      } catch (err) {
        console.error(err);
        authStatus.textContent = 'Erro ao fazer login: ' + err.message;
      }
    };

    // Logout
    logoutBtn.onclick = async () => {
      try {
        await signOut(auth);
      } catch (err) {
        console.error(err);
        mgToast('Erro ao sair');
      }
    };

    // Auth state
    onAuthStateChanged(auth, async (user) => {
      loadingArea.style.display = 'flex';
      authArea.style.display = 'none';
      appArea.style.display = 'none';

      if (!user) {
        loadingArea.style.display = 'none';
        authArea.style.display = 'block';
        return;
      }

      currentUser = user;

      // Verifica se √© admin
      const adminRef = doc(db, 'admins', user.uid);
      const adminSnap = await getDoc(adminRef);

      if (!adminSnap.exists()) {
        mgToast('‚ùå Voc√™ n√£o tem permiss√£o de admin');
        await signOut(auth);
        loadingArea.style.display = 'none';
        authArea.style.display = 'block';
        return;
      }

      adminData = adminSnap.data();

      // Atualiza UI
      userName.textContent = user.displayName || user.email;
      userRole.textContent = 'Administrador';
      userAvatar.textContent = (user.displayName || user.email || 'A')[0].toUpperCase();

      loadingArea.style.display = 'none';
      appArea.style.display = 'block';

      // Carrega empresas
      await loadCompanies();
    });

    // Adicionar empresa
    addCompanyBtn.onclick = async () => {
      try {
        const input = companyEmail.value.trim();
        if (!input) {
          mgToast('Digite o UID do usu√°rio');
          return;
        }

        if (!currentUser) {
          mgToast('Voc√™ n√£o est√° logado');
          return;
        }

        addCompanyBtn.disabled = true;
        addCompanyBtn.textContent = 'Adicionando...';

        console.log('üîç Input recebido:', input);
        
        // Assume que √© UID (Firebase Auth UIDs t√™m ~28 caracteres)
        const userId = input;
        let userData = {};
        
        console.log('‚úÖ Usando UID:', userId);
        
        // Busca dados do usu√°rio em /usuarios/{uid}
        try {
          const userDocRef = doc(db, 'usuarios', userId);
          const userDocSnap = await getDoc(userDocRef);
          
          if (userDocSnap.exists()) {
            userData = userDocSnap.data();
            console.log('‚úÖ Dados em /usuarios/' + userId + ':', userData);
          } else {
            console.log('‚ö†Ô∏è /usuarios/' + userId + ' n√£o existe');
          }
        } catch (err) {
          console.warn('‚ö†Ô∏è Erro ao buscar /usuarios/' + userId + ':', err);
        }
        
        // Se n√£o tem email, tenta buscar na primeira subcole√ß√£o clients
        if (!userData.email) {
          console.log('üîç Buscando email na subcole√ß√£o /usuarios/' + userId + '/clients/*...');
          try {
            const clientsRef = collection(db, 'usuarios', userId, 'clients');
            const clientsSnap = await getDocs(clientsRef);
            
            if (!clientsSnap.empty) {
              const firstClient = clientsSnap.docs[0];
              const clientData = firstClient.data();
              userData = { ...userData, ...clientData };
              console.log('‚úÖ Dados em subcole√ß√£o:', clientData);
            }
          } catch (err) {
            console.warn('‚ö†Ô∏è Erro ao buscar subcole√ß√£o:', err);
          }
        }

        console.log('‚úÖ UID final:', userId);

        // Verifica se j√° n√£o est√° adicionado
        const existingCompanyRef = doc(db, 'admins', currentUser.uid, 'companies', userId);
        const existingSnap = await getDoc(existingCompanyRef);
        
        if (existingSnap.exists()) {
          mgToast('‚ö†Ô∏è Esta empresa j√° est√° vinculada!');
          addCompanyBtn.disabled = false;
          addCompanyBtn.textContent = 'Adicionar por UID';
          companyEmail.value = '';
          return;
        }

        // Adiciona √† lista de empresas do admin
        await setDoc(existingCompanyRef, {
          email: userData.email || 'email@desconhecido.com',
          displayName: userData.displayName || userData.email || 'Empresa',
          photoURL: userData.photoURL || userData.profileLogoUrl || null,
          addedAt: serverTimestamp(),
          lastAccessed: null
        });

        mgToast('‚úÖ Empresa adicionada com sucesso!');
        companyEmail.value = '';
        await loadCompanies();

      } catch (err) {
        console.error('Erro ao adicionar empresa:', err);
        mgToast('‚ùå Erro ao adicionar empresa: ' + err.message);
      } finally {
        addCompanyBtn.disabled = false;
        addCompanyBtn.textContent = 'Adicionar por UID';
      }
    };

    // Carrega empresas
    async function loadCompanies() {
        // vamos buscar no Firestore usando uma query por email
        
        const usersRef = collection(db, 'usuarios');
        const q = query(usersRef, where('email', '==', email));
        
        console.log('üîç Executando query em /usuarios onde email ==', email);
        
        let querySnap;
        try {
          querySnap = await getDocs(q);
          console.log('‚úÖ Query executada. Documentos encontrados:', querySnap.size);
        } catch (queryErr) {
          console.error('‚ùå Erro na query:', queryErr);
          mgToast('‚ùå Erro ao buscar usu√°rio: ' + queryErr.message);
          addCompanyBtn.disabled = false;
          addCompanyBtn.textContent = 'Adicionar';
          return;
        }

        let userId = null;
        let userData = {};

        if (!querySnap.empty) {
          // Encontrou documento raiz em /usuarios/{uid}
          const userDoc = querySnap.docs[0];
          userId = userDoc.id;
          userData = userDoc.data();
          console.log('‚úÖ Usu√°rio encontrado em /usuarios/' + userId, userData);
        } else {
          console.warn('‚ö†Ô∏è Query n√£o retornou resultados para email:', email);
          console.log('üí° O campo email n√£o existe nos documentos raiz de /usuarios');
          console.log('üîç Vamos buscar nas subcole√ß√µes /usuarios/*/clients/*...');
          
          // Extrai clientKey do email para buscar na subcole√ß√£o correta
          const clientKey = email.split('@')[0];
          const safeKey = clientKey.replace(/[^\w-]/g, '_');
          
          console.log('ÔøΩ Email:', email, '‚Üí clientKey:', clientKey, '‚Üí safeKey:', safeKey);
          
          // Busca TODOS os UIDs em /usuarios
          try {
            const allUsersSnap = await getDocs(collection(db, 'usuarios'));
            console.log('üìä Total de documentos em /usuarios:', allUsersSnap.size);
            console.log('üîç Buscando em cada /usuarios/{uid}/clients/' + clientKey + '...');
            
            let foundInSubcollection = false;
            
            // Para cada UID, tenta buscar na subcole√ß√£o clients
            for (const userDoc of allUsersSnap.docs) {
              const uid = userDoc.id;
              
              try {
                // Tenta com safeKey primeiro
                let clientDocRef = doc(db, 'usuarios', uid, 'clients', safeKey);
                let clientDocSnap = await getDoc(clientDocRef);
                
                // Se n√£o encontrou, tenta com clientKey original
                if (!clientDocSnap.exists() && safeKey !== clientKey) {
                  clientDocRef = doc(db, 'usuarios', uid, 'clients', clientKey);
                  clientDocSnap = await getDoc(clientDocRef);
                }
                
                if (clientDocSnap.exists()) {
                  const clientData = clientDocSnap.data();
                  console.log('‚úÖ ENCONTRADO em /usuarios/' + uid + '/clients/' + (clientDocSnap.exists() ? clientKey : safeKey), clientData);
                  
                  // Verifica se o email bate (pode estar no clientData ou no userDoc)
                  const docEmail = clientData.email || userDoc.data().email;
                  if (docEmail && docEmail.toLowerCase() === email.toLowerCase()) {
                    userId = uid;
                    userData = { ...userDoc.data(), ...clientData };
                    foundInSubcollection = true;
                    console.log('‚úÖ Email confirmado! UID:', uid);
                    break;
                  } else {
                    console.log('‚ö†Ô∏è Documento encontrado mas email n√£o bate:', docEmail, 'vs', email);
                  }
                }
              } catch (subErr) {
                // N√£o tem permiss√£o ou n√£o existe, continua
              }
            }
            
            if (!foundInSubcollection) {
              console.error('‚ùå Email n√£o encontrado em nenhuma subcole√ß√£o /usuarios/*/clients/*');
            }
          } catch (listErr) {
            console.error('‚ùå Erro ao buscar em subcole√ß√µes:', listErr);
          }
          
          if (!userId) {
            mgToast('‚ùå Email n√£o encontrado. O usu√°rio precisa fazer login no dashboard pelo menos uma vez.');
            addCompanyBtn.disabled = false;
            addCompanyBtn.textContent = 'Adicionar';
            return;
          }
        }

        console.log('‚úÖ UID encontrado:', userId);

        // Verifica se j√° n√£o est√° adicionado
        const existingCompanyRef = doc(db, 'admins', currentUser.uid, 'companies', userId);
        const existingSnap = await getDoc(existingCompanyRef);
        
        if (existingSnap.exists()) {
          mgToast('‚ö†Ô∏è Esta empresa j√° est√° vinculada!');
          addCompanyBtn.disabled = false;
          addCompanyBtn.textContent = 'Adicionar';
          companyEmail.value = '';
          return;
        }

        // Adiciona √† lista de empresas do admin
        await setDoc(existingCompanyRef, {
          email: email,
          displayName: userData.displayName || email.split('@')[0],
          photoURL: userData.photoURL || userData.profileLogoUrl || null,
          addedAt: serverTimestamp(),
          lastAccessed: null
        });

        mgToast('‚úÖ Empresa adicionada com sucesso!');
        companyEmail.value = '';
        await loadCompanies();

      } catch (err) {
        console.error('Erro ao adicionar empresa:', err);
        mgToast('‚ùå Erro ao adicionar empresa: ' + err.message);
      } finally {
        addCompanyBtn.disabled = false;
        addCompanyBtn.textContent = 'Adicionar';
      }
    };

    // Carrega empresas
    async function loadCompanies() {
      if (!currentUser) return;

      try {
        const companiesRef = collection(db, 'admins', currentUser.uid, 'companies');
        const snapshot = await getDocs(companiesRef);

        const companies = [];
        
        // Carrega dados completos de cada empresa do Firestore
        for (const docSnap of snapshot.docs) {
          const companyData = {
            id: docSnap.id,
            ...docSnap.data()
          };
          
          console.log('üè¢ Empresa adicionada:', companyData);
          
          // Busca foto de perfil usando a MESMA l√≥gica do dashboard (#profileAvatarImg)
          // A foto est√° em CLIENT_PROFILE.profileLogoUrl que vem de /usuarios/{uid}/clients/{clientKey}
          try {
            // Extrai clientKey do email (mesma l√≥gica do dashboard: getClientKey())
            const email = companyData.email || '';
            const clientKey = email.split('@')[0]; // Ex: brunogestormktp@gmail.com ‚Üí brunogestormktp
            const safeKey = clientKey.replace(/[^\w-]/g, '_'); // Remove caracteres especiais
            
            console.log('ÔøΩ Email:', email, '‚Üí clientKey:', clientKey, '‚Üí safeKey:', safeKey);
            
            let photoFound = false;
            let clientData = null;
            
            // Tenta buscar com safeKey primeiro (mesma l√≥gica do loadClientProfile)
            try {
              const clientDocRef = doc(db, 'usuarios', docSnap.id, 'clients', safeKey);
              const clientDocSnap = await getDoc(clientDocRef);
              
              if (clientDocSnap.exists()) {
                clientData = clientDocSnap.data();
                console.log('‚úÖ Documento encontrado em /usuarios/' + docSnap.id + '/clients/' + safeKey, clientData);
              } else if (safeKey !== clientKey) {
                // Se n√£o encontrou com safeKey, tenta com clientKey original
                const clientDocRef2 = doc(db, 'usuarios', docSnap.id, 'clients', clientKey);
                const clientDocSnap2 = await getDoc(clientDocRef2);
                
                if (clientDocSnap2.exists()) {
                  clientData = clientDocSnap2.data();
                  console.log('‚úÖ Documento encontrado em /usuarios/' + docSnap.id + '/clients/' + clientKey, clientData);
                }
              }
            } catch (err) {
              console.warn('‚ö†Ô∏è Erro ao buscar documento do cliente:', err);
            }
            
            // Extrai profileLogoUrl do CLIENT_PROFILE (mesma l√≥gica do updateProfileAvatar)
            if (clientData && clientData.profileLogoUrl) {
              companyData.photoURL = clientData.profileLogoUrl;
              console.log('‚úÖ Foto encontrada (CLIENT_PROFILE.profileLogoUrl):', clientData.profileLogoUrl);
              photoFound = true;
            }
            
            // Tamb√©m atualiza displayName se dispon√≠vel
            if (clientData && clientData.displayName) {
              companyData.displayName = clientData.displayName;
            }
            
            if (!photoFound) {
              console.log('‚ùå Nenhuma foto encontrada em /usuarios/' + docSnap.id + '/clients/' + clientKey);
            }
            
          } catch (err) {
            console.warn('‚ùå Erro ao carregar foto de perfil para:', companyData.email, err);
          }
          
          companies.push(companyData);
        }

        // Ordena por data de adi√ß√£o
        companies.sort((a, b) => {
          const aTime = a.addedAt?.toMillis?.() || 0;
          const bTime = b.addedAt?.toMillis?.() || 0;
          return bTime - aTime;
        });

        companyCount.textContent = companies.length;

        if (companies.length === 0) {
          companiesGrid.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üè¢</div>
              <div class="empty-state-text">Nenhuma empresa vinculada</div>
              <div class="empty-state-hint">Adicione empresas usando o formul√°rio acima</div>
            </div>
          `;
          return;
        }

        companiesGrid.innerHTML = companies.map(company => {
          const initial = (company.displayName || company.email || '?')[0].toUpperCase();
          const logoHtml = company.photoURL 
            ? `<img src="${company.photoURL}" alt="Logo">` 
            : initial;
          
          console.log('üé® Renderizando empresa:', company.email, 'photoURL:', company.photoURL, 'logoHtml:', logoHtml);

          return `
            <div class="company-card" data-uid="${company.id}">
              <div class="company-header">
                <div class="company-logo">${logoHtml}</div>
                <div class="company-info">
                  <div class="company-name">${company.displayName || company.email}</div>
                  <div class="company-email">${company.email}</div>
                </div>
              </div>
              <div class="company-stats">
                <div class="company-stat">
                  <div class="company-stat-label">Adicionado</div>
                  <div class="company-stat-value">${formatDate(company.addedAt)}</div>
                </div>
                <div class="company-stat">
                  <div class="company-stat-label">√öltimo acesso</div>
                  <div class="company-stat-value">${company.lastAccessed ? formatDate(company.lastAccessed) : 'Nunca'}</div>
                </div>
              </div>
              <div class="company-actions">
                <button class="btn" onclick="accessCompany('${company.id}', '${company.email}')">
                  Acessar Dashboard
                </button>
                <button class="btn danger" onclick="removeCompany('${company.id}', '${company.email}')">
                  Remover
                </button>
              </div>
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error('Erro ao carregar empresas:', err);
        mgToast('‚ùå Erro ao carregar empresas');
      }
    }

    // Formata data
    function formatDate(timestamp) {
      if (!timestamp) return '-';
      const date = timestamp.toDate?.() || new Date(timestamp);
      return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    // Acessar empresa
    window.accessCompany = async (userId, email) => {
      try {
        // Atualiza √∫ltimo acesso
        const companyRef = doc(db, 'admins', currentUser.uid, 'companies', userId);
        await updateDoc(companyRef, {
          lastAccessed: serverTimestamp()
        });

        // Salva informa√ß√µes do admin no sessionStorage para autentica√ß√£o silenciosa
        sessionStorage.setItem('adminSession', JSON.stringify({
          adminUid: currentUser.uid,
          adminEmail: currentUser.email,
          adminDisplayName: currentUser.displayName,
          targetUid: userId,
          targetEmail: email,
          timestamp: Date.now()
        }));

        // Redireciona para o dashboard com par√¢metros admin
        const clientKey = email.toLowerCase().replace(/[^a-z0-9]/g, '_');
        window.location.href = `index.html?client=${clientKey}&admin=true&uid=${userId}&adminEmail=${encodeURIComponent(currentUser.email)}`;

      } catch (err) {
        console.error('Erro ao acessar empresa:', err);
        mgToast('‚ùå Erro ao acessar empresa');
      }
    };

    // Remover empresa
    window.removeCompany = async (userId, email) => {
      if (!confirm(`Tem certeza que deseja remover "${email}"?`)) {
        return;
      }

      try {
        const companyRef = doc(db, 'admins', currentUser.uid, 'companies', userId);
        await deleteDoc(companyRef);
        mgToast('‚úÖ Empresa removida');
        await loadCompanies();
      } catch (err) {
        console.error('Erro ao remover empresa:', err);
        mgToast('‚ùå Erro ao remover empresa');
      }
    };
  </script>
</body>
</html>

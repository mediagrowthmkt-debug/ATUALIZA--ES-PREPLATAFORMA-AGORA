<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>PAINEL MEDIAGROWTH HTML 4.5 (fix duplicar/fechar iframes)</title>
<link rel="icon" type="image/png" href="favicon.png"/>
<style id="calendar-css">
/* ===================== CALEND√ÅRIO / POSTS ===================== */
.calendar-wrap{ margin-left:var(--margin-left); margin-right:var(--margin-right); display:flex; flex-direction:column; gap:10px; }
.cal-toolbar{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; background:var(--title-bg,rgba(0,0,0,.35)); border:1px solid var(--shell-border,rgba(255,255,255,.14)); padding:8px; border-radius:10px; }
.cal-google-sync{ display:flex; align-items:center; flex-wrap:wrap; gap:8px; margin-left:auto; }
.cal-google-sync .status{ font-size:.82rem; color:#cbd5f5; }
.cal-google-sync .btn{ flex:0 0 auto; }
@media (max-width: 820px){
  .cal-google-sync{ width:100%; margin-left:0; }
  .cal-google-sync .status{ flex-basis:100%; }
}
.cal-toolbar input[type="text"], .cal-toolbar input[type="date"]{ background:#222; color:#fff; border:1px solid #333; border-radius:8px; padding:8px 10px; }
.cal-toolbar input[type="file"]{ background:#111; border:1px dashed #333; border-radius:10px; padding:8px; color:#bbb; }
.cal-legend{ display:flex; gap:10px; align-items:center; font-size:.9rem; color:#ddd; }
.cal-badge{ display:inline-block; width:10px; height:10px; border-radius:2px; margin-right:6px; }
.b-pendente{ background:#777; }
.b-aprovado{ background:#2e7d32; }
.b-aprovado-interno{ background:#7c4dff; }
.b-revisar{ background:#c8a600; }
.calendar{ background:transparent; border:1px solid var(--shell-border,rgba(255,255,255,.14)); border-radius:12px; overflow:hidden; }
.cal-head{ display:grid; grid-template-columns: 40px 1fr 40px; align-items:center; padding:8px 10px; background:rgba(255,255,255,.06); border-bottom:1px solid var(--shell-border,rgba(255,255,255,.14)); }
.cal-head .nav{ display:flex; align-items:center; justify-content:center; }
.cal-head button{ background:#222; border:1px solid #333; color:#fff; border-radius:8px; padding:6px 10px; cursor:pointer; font-weight:800; }
.cal-title{ text-align:center; font-weight:900; }
.cal-grid{ display:grid; grid-template-columns: repeat(7, 1fr); gap:0; }
.cal-weekday{ background:rgba(255,255,255,.06); padding:8px 10px; text-align:center; border-right:1px solid var(--shell-border,rgba(255,255,255,.14)); font-weight:800; font-size:.85rem; }
.cal-weekday:last-child{ border-right:0; }
.cal-weekday.weekend{ background:rgba(148,163,184,.16); color:#f8fafc; }
.cal-cell{ border-top:1px solid var(--shell-border,rgba(255,255,255,.14)); border-right:1px solid var(--shell-border,rgba(255,255,255,.14)); min-height:110px; padding:6px; position:relative; }
.cal-cell:nth-child(7n){ border-right:0; }
.cal-cell.weekend:not(.today){ background:rgba(148,163,184,.12); }
.cal-cell.weekend.out{ background:rgba(148,163,184,.06); }
.cal-cell.weekend .daynum{ color:#e2e8f0; font-weight:800; }
.cal-cell.today{ background:rgba(255,255,255,.08); box-shadow:0 0 0 2px var(--accent) inset; }
.cal-cell.today .daynum{ color:var(--accent); font-weight:900; }
.daynum{ position:absolute; top:6px; right:6px; font-size:.8rem; color:#bbb; }
.cal-holidays{ font-size:.7rem; line-height:1.2; margin-top:18px; display:flex; flex-direction:column; gap:2px; color:#ccc; }
.cal-items{ display:flex; flex-wrap:wrap; gap:4px; margin-top:4px; }
.cal-demands{ display:flex; flex-direction:column; gap:4px; margin-top:4px; }
.cal-demand{ display:flex; align-items:flex-start; gap:6px; background:rgba(15,23,42,.35); border:1px solid rgba(255,255,255,.08); border-left:3px solid var(--status-color,#64748b); border-radius:8px; padding:4px 6px; }
.cal-demand-dot{ width:8px; height:8px; border-radius:50%; background:var(--status-color,#64748b); flex:0 0 auto; margin-top:4px; }
.cal-demand-text{ display:flex; flex-direction:column; gap:2px; min-width:0; }
.cal-demand-title{ font-size:.72rem; font-weight:600; color:#f3f4f6; line-height:1.3; word-break:break-word; }
.cal-demand-meta{ font-size:.65rem; color:#cbd5f5; line-height:1.2; }
.calendar-demandas-mobile{ display:none; flex-direction:column; gap:10px; margin-top:12px; }
.calendar-demandas-mobile-title{ margin:0; font-size:1rem; font-weight:700; color:#fff; }
.calendar-demandas-mobile-list{ display:flex; flex-direction:column; gap:8px; }
.calendar-demandas-mobile-day{ background:rgba(15,23,42,.35); border:1px solid rgba(255,255,255,.08); border-radius:10px; padding:10px; display:flex; flex-direction:column; gap:6px; }
.calendar-demandas-mobile-date{ font-size:.78rem; font-weight:700; color:#cbd5f5; text-transform:uppercase; letter-spacing:.02em; }
.calendar-demandas-mobile-empty{ background:rgba(15,23,42,.2); border:1px dashed rgba(255,255,255,.14); border-radius:10px; padding:12px; color:#cbd5f5; font-size:.85rem; }
.cal-note{ width:100%; min-height:40px; margin-top:4px; background:transparent; border:1px dashed var(--shell-border,rgba(255,255,255,.14)); border-radius:6px; color:#fff; font-size:.75rem; padding:2px; resize:vertical; }
.cal-thumb{ width:38px; height:38px; border-radius:6px; overflow:hidden; border:2px solid #777; cursor:pointer; background:#111; display:flex; align-items:center; justify-content:center; font-size:.8rem; }
.cal-thumb.aprovado{ border-color:#2e7d32; }
.cal-thumb.aprovado-interno{ border-color:#7c4dff; }
.cal-thumb.revisar{ border-color:#c8a600; }
.cal-thumb img, .cal-thumb video{ width:100%; height:100%; object-fit:cover; display:block; }
.insta-preview{ display:flex; justify-content:center; margin-top:10px; }
.insta-phone{ width:360px; background:#fff; border:1px solid #ccc; border-radius:32px; overflow:hidden; }
.insta-feed{ display:grid; grid-template-columns:repeat(3,1fr); gap:1px; background:#fff; }
.feed-item{ position:relative; aspect-ratio:1/1; background:#000; display:flex; align-items:center; justify-content:center; cursor:pointer; }
.feed-item img, .feed-item video{ width:100%; height:100%; object-fit:cover; display:block; }
.feed-item span{ color:#fff; font-weight:800; }
.feed-item.aprovado::after{ content:""; position:absolute; inset:0; box-shadow:0 0 0 4px #2e7d32 inset; }
.feed-item.aprovado-interno::after{ content:""; position:absolute; inset:0; box-shadow:0 0 0 4px #7c4dff inset; }
.feed-item.revisar::after{ content:""; position:absolute; inset:0; box-shadow:0 0 0 4px #c8a600 inset; }
.feed-item.pendente::after{ content:""; position:absolute; inset:0; box-shadow:0 0 0 4px #777 inset; }
.cover-upload-btn{ position:absolute; z-index:5; background:rgba(0,0,0,.75); color:#fff; border:1px solid rgba(255,255,255,.35); border-radius:999px; font-size:.65rem; padding:2px 6px; display:flex; align-items:center; gap:4px; cursor:pointer; line-height:1; }
.cover-upload-btn:hover{ filter:brightness(1.1); }
.feed-item .cover-upload-btn{ bottom:6px; left:50%; transform:translateX(-50%); }
.insta-stories-wrapper{ position:relative; background:#fff; padding:4px; }
.insta-stories{ display:flex; gap:4px; overflow-x:auto; scroll-behavior:smooth; }
.stories-arrow{ position:absolute; top:50%; transform:translateY(-50%); width:24px; height:24px; border:0; border-radius:50%; background:rgba(0,0,0,.6); color:#fff; display:flex; align-items:center; justify-content:center; cursor:pointer; }
.stories-arrow.left{ left:4px; }
.stories-arrow.right{ right:4px; }
.story-date{ position:absolute; bottom:2px; right:2px; background:rgba(0,0,0,.6); color:#fff; font-size:.6rem; padding:1px 3px; border-radius:3px; }
@media (max-width: 820px){ .stories-arrow{ display:none; } }
.story-item{ position:relative; flex:0 0 90px; aspect-ratio:9/16; background:#000; display:flex; align-items:center; justify-content:center; cursor:pointer; border-radius:4px; }
.story-item img, .story-item video{ width:100%; height:100%; object-fit:cover; display:block; }
.story-item span{ color:#fff; font-weight:800; }
.story-item.aprovado::after{ content:""; position:absolute; inset:0; box-shadow:0 0 0 4px #2e7d32 inset; }
.story-item.aprovado-interno::after{ content:""; position:absolute; inset:0; box-shadow:0 0 0 4px #7c4dff inset; }
.story-item.revisar::after{ content:""; position:absolute; inset:0; box-shadow:0 0 0 4px #c8a600 inset; }
.story-item.pendente::after{ content:""; position:absolute; inset:0; box-shadow:0 0 0 4px #777 inset; }
.story-item .cover-upload-btn{ top:6px; left:6px; transform:none; }
.status-pill{ display:inline-block; padding:4px 8px; border-radius:999px; font-weight:800; font-size:.75rem; }
.status-aprovado{ background:#1b5e20; border:1px solid #2e7d32; }
.status-aprovado-interno{ background:#2d185b; border:1px solid #7c4dff; color:#e8ddff; }
.status-revisar{ background:#5f4d00; border:1px solid #c8a600; }
.status-pendente{ background:#333; border:1px solid #555; }
.actions-inline{ display:flex; gap:6px; flex-wrap:wrap; }
.cal-filters{ display:flex; gap:8px; align-items:center; }
/* Modal */
.modal{ position:fixed; inset:0; background:rgba(0,0,0,.65); display:none; align-items:center; justify-content:center; z-index:99999; }
.modal.show{ display:flex; }
.modal-card{ width:min(900px, 96vw); background:#111; border:1px solid var(--shell-border,rgba(255,255,255,.14)); border-radius:14px; overflow:hidden; max-height:92vh; display:flex; flex-direction:column; }
.modal-head{ display:flex; justify-content:space-between; align-items:center; padding:10px 12px; background:rgba(255,255,255,.06); border-bottom:1px solid var(--shell-border,rgba(255,255,255,.14)); flex-shrink:0; }
.modal-body{ padding:12px; display:grid; grid-template-columns: 1fr 1fr; gap:12px; flex:1 1 auto; overflow-y:auto; min-height:0; }
.modal-body .preview{ background:#000; border:1px solid var(--shell-border,rgba(255,255,255,.14)); border-radius:10px; padding:8px; min-height:260px; display:flex; align-items:center; justify-content:center; }
.modal-body .preview img, .modal-body .preview video{ max-width:100%; max-height:60vh; }
.modal-body .info textarea{ width:100%; min-height:140px; background:#1a1a1a; color:#fff; border:1px solid #333; border-radius:8px; padding:8px; }
.modal-foot{ display:flex; justify-content:flex-end; gap:8px; padding:10px 12px; border-top:1px solid var(--shell-border,rgba(255,255,255,.14)); flex-shrink:0; background:#111; }
@media (max-width: 820px){
  .modal-body{ grid-template-columns: 1fr; }
}
@media (max-width: 820px){
  .insta-preview{ flex-direction:column; align-items:center; }
  .calendar .cal-demands{ display:none; }
  .calendar-demandas-mobile{ display:flex; }
}
/* ===================== FIM CALEND√ÅRIO / POSTS ===================== */

html, body{ -webkit-text-size-adjust: 100%; }

/* mg-toast */
.mg-toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:rgba(0,0,0,.85);color:#fff;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.2);z-index:100000;font-weight:800}


/* ===== Evitar zoom ao digitar no mobile (iOS) ===== */
@media (max-width: 820px){
  input, textarea, select, .input, .btn, .btn.small {
    font-size: 16px !important; /* iOS n√£o d√° zoom se fonte >=16px */
  }
  /* Altura confort√°vel para toque */
  input, textarea, select {
    min-height: 44px;
  }
}

/* ===== Mobile: reduzir fontes e bot√µes no modal de post ===== */
@media (max-width: 820px){
  /* Mant√©m inputs/textarea >=16px (evitar zoom iOS), mas reduz bot√µes e textos n√£o interativos */
  #postModal .btn { font-size: 13px !important; padding: 6px 8px !important; }
  #postModal .btn.small { font-size: 12.5px !important; padding: 5px 8px !important; border-radius: 8px !important; }
  #postModal .modal-foot .btn { min-height: 36px !important; padding: 6px 8px !important; }
  #postModal .modal-head .btn { min-height: 32px !important; padding: 4px 8px !important; }

  /* Tipografia interna do modal */
  #postModal #modalTitle { font-size: 0.95rem !important; }
  #postModal #modalDate { font-size: 0.85rem !important; }
  #postModal .info, #postModal .info label, #postModal .info p { font-size: 0.9rem !important; }
  #postModal #clientNotesList, #postModal #postChecklistBlock { font-size: 0.9rem !important; }

  /* Descri√ß√£o: menor para leitura; volta a 16px ao focar para evitar zoom no iOS */
  #postModal #modalDesc { font-size: 13px !important; line-height: 1.35 !important; font-family: inherit !important; }
  #postModal #modalDesc:focus { font-size: 16px !important; }

  /* Header do modal mais compacto e com t√≠tulo super curto */
  #postModal .modal-head { padding: 6px 8px !important; gap: 8px; }
  #postModal #modalTitle { 
    max-width: 4ch !important; /* mostra visualmente ~4 caracteres */
    overflow: hidden !important; 
    white-space: nowrap !important; 
    text-overflow: clip !important; 
    display: inline-block !important;
  }

  /* Bot√£o fechar vira um X para economizar espa√ßo */
  #postModal #modalClose { 
    font-size: 0 !important; /* esconde o texto 'Fechar' */
    width: 36px !important; 
    min-width: 36px !important; 
    height: 32px !important; 
    padding: 0 !important; 
    display: inline-flex !important; 
    align-items: center; 
    justify-content: center; 
    border-radius: 8px !important;
  }
  #postModal #modalClose::before { 
    content: "‚úï"; 
    font-size: 18px; 
    font-weight: 800; 
    line-height: 1; 
  }
}

/* ===== Post Checklist: layout e visibilidade ===== */
#postChecklistBlock{
  background: #121212;
  border: 1px solid var(--shell-border, rgba(255,255,255,.14));
  border-radius: 10px;
  padding: 10px;
}
#postChecklistBlock .post-checklist-grid{
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px 12px;
}
#postChecklistBlock label{ display:flex; align-items:center; gap:8px; }

/* Desktop: preview em largura total e info+checklist lado a lado */
@media (min-width: 821px){
  #postModal .modal-body{ grid-template-columns: 1fr 1fr; }
  #postModal #modalPreview{ grid-column: 1 / -1; }
  #postModal .info{ grid-column: 1; align-self: start; }
  #postModal #postChecklistBlock{ grid-column: 2; align-self: start; }
}

/* Mobile: esconder checklist (deixar como est√°) */
@media (max-width: 820px){
  #postChecklistBlock{ display:none !important; }
}

</style>
<style id="access-css">
  /* ===================== ACESSOS ===================== */
  .access-wrap {
    margin-left: var(--margin-left);
    margin-right: var(--margin-right);
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .access-header {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 12px;
  }

  .access-toolbar {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
    background: var(--title-bg, rgba(0, 0, 0, 0.35));
    border: 1px solid var(--shell-border, rgba(255, 255, 255, 0.14));
    padding: 8px 10px;
    border-radius: 10px;
  }

  .access-toolbar .access-search {
    flex: 1 1 260px;
    min-width: 220px;
    width: 100%;
  }

  .access-toolbar .access-search input[type="text"] {
    width: 100%;
    background: #222;
    color: #fff;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 8px 10px;
  }

  .access-toolbar .access-actions {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    flex: 0 0 auto;
  }

  .access-toolbar .access-actions .btn {
    white-space: nowrap;
  }

  .access-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 8px;
  }

  .access-row {
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid var(--shell-border);
    border-radius: 10px;
    display: grid;
    grid-template-columns: 180px 1fr 200px 200px 160px 210px;
    gap: 8px;
    padding: 8px 8px;
    align-items: center;
  }

  .access-row .cell {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .access-row .cell a {
    color: #ffd9bf;
    text-decoration: underline;
  }

  .pill {
    background: #222;
    border: 1px solid #333;
    border-radius: 999px;
    padding: 2px 8px;
    font-size: 0.75rem;
    margin-right: 4px;
    display: inline-block;
  }

  .pw {
    letter-spacing: 2px;
  }

  .actions {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    justify-content: flex-end;
  }

  .help-note {
    color: #bbb;
    font-size: 0.85rem;
  }

  .warn {
    color: #ffc266;
  }

  .form-inline {
    display: grid;
    grid-template-columns: 180px 1fr 200px 200px 160px 210px;
    gap: 8px;
  }

  .form-inline input {
    width: 100%;
    background: #222;
    border: 1px solid #333;
    border-radius: 8px;
    color: #fff;
    padding: 8px 10px;
  }

  .access-empty {
    color: #bbb;
    padding: 8px;
  }

  @media (max-width: 1100px) {
    .access-row,
    .form-inline {
      grid-template-columns: 160px 1fr 160px 170px 140px 200px;
    }
  }

  @media (max-width: 900px) {
    .access-row,
    .form-inline {
      grid-template-columns: 1fr 1fr;
    }

    .access-row .cell.hide-sm {
      display: none;
    }

    .form-inline .hide-sm {
      display: none;
    }
  }

  /* ===================== MOBILE OPTIMIZA√á√ïES v4.9.2 ===================== */
  @media (max-width: 820px) {
    :root {
      --iframe-h: 520px;
    }

    html,
    body {
      overscroll-behavior-y: contain;
    }

    body {
      padding-bottom: calc(env(safe-area-inset-bottom, 0) + 8px);
    }

    h1 {
      font-size: 1.05rem;
      margin: 10px 0;
    }

    .center-box {
      padding: 12px;
    }

    .auth-box {
      max-width: 420px;
      border-radius: 12px;
      padding: 16px;
    }

    .input {
      font-size: 0.95rem;
      padding: 12px;
    }

    .btn {
      font-size: 0.95rem;
    }

    .btn.small {
      font-size: 0.9rem;
      padding: 7px 10px;
    }

    .topbar {
      gap: 8px;
      grid-template-columns: 1fr;
    }

    .topbar-left {
      width: 100%;
      justify-content: space-between;
      gap: 8px;
    }

    .user-info {
      white-space: normal;
    }

    .right-tools {
      width: 100%;
      justify-content: space-between;
      gap: 8px;
    }

    .profile-area {
      flex: 1;
      justify-content: flex-start;
    }

    .profile-area .profile-meta {
      display: none;
    }

    .profile-avatar {
      width: 42px;
      height: 42px;
    }

    .settings-tab {
      width: 40px;
      height: 40px;
      font-size: 1.05rem;
      border-radius: 12px;
    }

    .mini-total {
      padding: 6px 10px;
      min-width: auto;
    }

    .total-score {
      font-size: 1.2rem;
    }

    .tabs {
      margin-top: 4px;
      justify-content: flex-start;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      padding: 0 8px;
      gap: 6px;
    }

    .tab-btn {
      flex: 0 0 auto;
      padding: 8px 10px;
      font-size: 0.9rem;
    }

    .dashboard {
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .macro-actions {
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }

    .macro-summary {
      flex-direction: column;
      align-items: flex-start;
      gap: 14px;
    }

    .macro-summary-score {
      font-size: 2.2rem;
    }

    .macro-progress-grid {
      grid-template-columns: 1fr;
    }

    .macro-sections {
      grid-template-columns: 1fr;
    }

    .macro-mini-dashboard {
      grid-template-columns: 1fr;
    }

    .macro-timeline-date {
      min-width: 78px;
    }

    .widgets-grid {
      gap: 10px;
    }

    .widget-head {
      margin-left: var(--margin-left);
      margin-right: var(--margin-right);
      padding: 8px;
    }

    .widget-input {
      grid-template-columns: 1fr;
      margin-left: var(--margin-left);
      margin-right: var(--margin-right);
    }

    .frame-shell {
      min-height: 360px;
      margin-left: var(--margin-left);
      margin-right: var(--margin-right);
    }

    .note-toolbar,
    .brief-toolbar,
    .access-toolbar {
      gap: 8px;
    }

    .access-toolbar {
      flex-direction: column;
      align-items: stretch;
    }

    .access-toolbar .access-actions {
      width: 100%;
      justify-content: flex-start;
    }

    .access-toolbar .access-actions .btn {
      width: 100%;
    }

    .access-toolbar .access-search {
      min-width: 0;
    }

    .note-toolbar label,
    .brief-toolbar input[type="text"] {
      width: 100%;
    }

    .notes-wrap,
    .access-wrap {
      margin-left: var(--margin-left);
      margin-right: var(--margin-right);
    }

    .note-editor {
      min-height: 160px;
    }

    #briefForm {
      grid-template-columns: 1fr;
    }

    #briefIframeUrl {
      min-width: 0;
      width: 100%;
    }

    .access-row,
    .form-inline {
      grid-template-columns: 1fr;
    }

    .actions {
      justify-content: flex-start;
    }
  }

  @media (max-width: 520px) {
    .dashboard {
      grid-template-columns: 1fr;
    }

    .card textarea,
    .card input[type="number"] {
      width: 100%;
    }
  }
  /* ===================== FIM MOBILE OPTIMIZA√á√ïES ===================== */
</style>
<style id="calendar-review-css">
/* ======= Observa√ß√µes & Review modal ======= */

/* ===== Ajuste modal revis√£o no mobile ===== */
@media (max-width: 820px){
  #reviewModal .modal-card{
    width: 100% !important;
    height: 70vh !important;
    max-height: 70vh !important;
    margin: auto 0 0 0; /* bottom sheet */
    border-radius: 14px 14px 0 0;
    display: flex;
    flex-direction: column;
  }
  #reviewModal .modal-body{
    flex: 1 1 auto;
    overflow-y: auto;
    padding: 12px;
  }
  #reviewModal textarea{
    min-height: 100px;
  }
  #reviewModal .modal-foot{
    position: sticky;
    bottom: 0;
    background: #111;
    padding: 12px;
    border-top: 1px solid #333;
  }
  #reviewSend{
    width: 100%;
    font-size: 1rem;
    min-height: 44px;
  }
}

.notes-block{ margin-top:12px; }
.notes-list{ display:flex; flex-direction:column; gap:8px; background:#121212; border:1px solid var(--shell-border,rgba(255,255,255,.14)); border-radius:8px; padding:10px; max-height:220px; overflow:auto; }
.note-item{ background:#0d0d0d; border:1px solid #2a2a2a; border-radius:8px; padding:8px; }
.note-item.active{ border-color:var(--accent,#7c4dff); box-shadow:0 0 0 1px var(--accent,#7c4dff); }
.note-item.active .note-title{ color:#fff; }
.note-head{ display:flex; gap:8px; font-size:.8rem; color:#bbb; margin-bottom:4px; }
.note-body{ white-space:normal; }
.markdown-view{ line-height:1.5; font-size:inherit; color:inherit; }
.markdown-view p{ margin:0 0 0.75em; }
.markdown-view p:last-child{ margin-bottom:0; }
.markdown-view ul,.markdown-view ol{ margin:0 0 0.75em 1.2em; padding-left:1.2em; }
.markdown-view li{ margin:0.25em 0; }
.markdown-view pre{ margin:0 0 0.75em; background:#111; border:1px solid rgba(255,255,255,.18); border-radius:8px; padding:8px; overflow:auto; }
.markdown-view code{ background:rgba(255,255,255,.08); border-radius:4px; padding:0 4px; font-family:Consolas,Monaco,'Courier New',monospace; }
.markdown-view pre code{ background:transparent; padding:0; }
.markdown-view blockquote{ margin:0 0 0.75em; padding-left:12px; border-left:3px solid rgba(255,255,255,.22); color:rgba(255,255,255,.8); }
.markdown-view a{ color:#60a5fa; }
.origin-pill{ margin-left:auto; padding:2px 8px; border-radius:999px; font-size:.7rem; font-weight:800; text-transform:uppercase; letter-spacing:.02em; background:#222; border:1px solid #444; color:#ddd; }
.origin-pill.origin-cliente{ background:rgba(255,102,0,.16); border-color:#ff6600; color:#ffb380; }
.origin-pill.origin-interno{ background:rgba(46,125,50,.18); border-color:#2e7d32; color:#b2f2bb; }
.modal-card.small{ width:min(560px, 96vw); }

/* Estilos para tabelas de an√°lise - mais espa√ßosas e leg√≠veis */
.markdown-view table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
  font-size: 0.85rem;
  overflow-x: auto;
  display: block;
}
.markdown-view table thead {
  display: table-header-group;
}
.markdown-view table tbody {
  display: table-row-group;
}
.markdown-view table tr {
  display: table-row;
}
.markdown-view table th,
.markdown-view table td {
  display: table-cell;
  border: 1px solid rgba(255, 255, 255, 0.12);
  padding: 12px 16px;
  text-align: left;
  vertical-align: middle;
  min-width: 90px;
  white-space: nowrap;
}
.markdown-view table th {
  background: rgba(99, 102, 241, 0.15);
  font-weight: 600;
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: rgba(255, 255, 255, 0.95);
  border-bottom: 2px solid rgba(99, 102, 241, 0.4);
}
.markdown-view table td {
  background: rgba(0, 0, 0, 0.25);
  color: rgba(255, 255, 255, 0.85);
}
.markdown-view table tbody tr:hover td {
  background: rgba(99, 102, 241, 0.08);
}
.markdown-view table td strong {
  color: rgba(255, 255, 255, 0.95);
  font-weight: 600;
}
/* Largura m√≠nima maior para colunas de valores monet√°rios */
.markdown-view table td:nth-child(2),
.markdown-view table td:nth-child(3),
.markdown-view table td:nth-child(4) {
  min-width: 110px;
}

</style>
<style>
/* Esconde observa√ß√µes dentro do pop-up do Post (hist√≥rico ficar√° na p√°gina) */
#postModal .notes-block{ display:none !important; }
</style>
<style>
#btnApprove{background:#2e7d32 !important;border-color:#2e7d32 !important;color:#fff;}
#btnApproveInternal{background:#7c4dff !important;border-color:#7c4dff !important;color:#fff;}
#btnApproveInternal:disabled{background:#b39ddb !important;border-color:#b39ddb !important;color:#4527a0 !important;}
#btnApproveInternal.btn-interno-concluido{background:#5e35b1 !important;border-color:#5e35b1 !important;color:#fff !important;}
#btnApprove:hover,#btnApproveInternal:hover{filter:brightness(1.1)}
</style>
<style>
/* === In-modal carousel arrows (reliable) === */
#modalPreview{ position:relative; }
#modalPreview .pv-stage{ position:relative; background:#000; border-radius:12px; overflow:hidden; }
#modalPreview .pv-media{ display:flex; align-items:center; justify-content:center; min-height:220px; }
#modalPreview .pv-media img,
#modalPreview .pv-media video{
  display:block; background:#000;
  max-width:100%; max-height:62vh; width:auto; height:auto; object-fit:contain;
}
#modalPreview .pv-arrow{
  position:absolute; top:50%; transform:translateY(-50%);
  width:42px; height:42px; border-radius:999px;
  display:none; align-items:center; justify-content:center;
  color:#fff; font-weight:900; font-size:22px;
  background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.25);
  cursor:pointer; z-index:10; user-select:none; -webkit-user-select:none;
  -webkit-tap-highlight-color:transparent;
}
#modalPreview.pv-has-many .pv-arrow{ display:flex; }
#modalPreview .pv-arrow.left{ left:10px; } 
#modalPreview .pv-arrow.right{ right:10px; }
@keyframes pvBlink {0%,100%{opacity:.45} 50%{opacity:1}}
#modalPreview.pv-hint .pv-arrow{ animation: pvBlink 1s ease-in-out infinite; }
#modalPreview.pv-hint-end .pv-arrow{ animation: none; }
</style>
<style>
/* Team Management Styles */
.team-manager {
  margin-top: 16px;
}
.team-form {
  margin-bottom: 24px;
}
.team-sync-notice {
  background: rgba(59, 130, 246, 0.1);
  border: 1px solid rgba(59, 130, 246, 0.3);
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 16px;
  color: #93c5fd;
  font-size: 14px;
}
.team-sync-notice p {
  margin: 0 0 8px 0;
  line-height: 1.5;
}
.auto-imported-badge {
  display: inline-block;
  font-size: 14px;
  margin-right: 4px;
  opacity: 0.7;
}
.team-form-row {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
}
.team-form-row input,
.team-form-row select {
  flex: 1;
  padding: 8px 12px;
  border: 1px solid #475569;
  border-radius: 6px;
  background: #1e293b;
  color: #f8fafc;
  font-size: 14px;
}
.team-form-row input:focus,
.team-form-row select:focus {
  outline: none;
  border-color: #3b82f6;
}
.team-form-row button {
  padding: 8px 16px;
  background: #3b82f6;
  color: #fff;
  border: none;
  border-radius: 6px;
  font-weight: 500;
  cursor: pointer;
}
.team-form-row button:hover {
  background: #2563eb;
}
.team-list {
  background: #1e293b;
  border-radius: 8px;
  overflow: hidden;
}
.team-list-header,
.team-member {
  display: grid;
  grid-template-columns: 2fr 2fr 1fr 1fr;
  gap: 12px;
  padding: 12px;
  align-items: center;
}
.team-list-header {
  background: #0f172a;
  font-weight: 600;
  color: #94a3b8;
}
.team-member {
  border-bottom: 1px solid #334155;
}
.team-member:last-child {
  border-bottom: none;
}
.team-member-actions {
  display: flex;
  gap: 8px;
}
.team-member-actions button {
  padding: 4px 8px;
  border: none;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
}
.team-member-actions .edit-btn {
  background: #059669;
  color: white;
}
.team-member-actions .remove-btn {
  background: #dc2626;
  color: white;
}
.client-invite-form {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-top: 12px;
}
.client-invite-grid {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 12px;
}
.client-invite-grid label {
  display: flex;
  flex-direction: column;
  gap: 6px;
  font-size: 0.85rem;
  color: #cbd5f5;
}
.client-invite-grid input {
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid #334155;
  background: #1e293b;
  color: #f8fafc;
  font-size: 0.9rem;
}
.client-invite-grid input:focus {
  outline: none;
  border-color: #3b82f6;
}
.client-invite-actions {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}
.client-invite-actions .btn {
  min-width: 160px;
}
.client-invite-status {
  font-size: 0.85rem;
  min-height: 1.2em;
  color: #cbd5f5;
}
.client-invite-status.success {
  color: #86efac;
}
.client-invite-status.error {
  color: #fca5a5;
}
.client-role-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  align-items: center;
  margin-bottom: 12px;
}
.client-role-actions .btn {
  min-width: 220px;
}
.client-accounts-section {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-top: 16px;
}
.client-accounts-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.client-account-trigger {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 4px;
  padding: 12px 16px;
  border-radius: 10px;
  border: 1px solid rgba(148, 163, 184, 0.16);
  background: rgba(15, 23, 42, 0.6);
  color: inherit;
  text-align: left;
  cursor: pointer;
  transition: border-color 0.2s ease, background 0.2s ease;
}
.client-account-trigger:hover {
  border-color: rgba(96, 165, 250, 0.6);
  background: rgba(30, 41, 59, 0.7);
}
.client-account-trigger[disabled] {
  opacity: 0.6;
  cursor: wait;
}
.client-account-name {
  font-weight: 600;
  font-size: 0.95rem;
}
.client-account-meta {
  font-size: 0.8rem;
  color: #94a3b8;
}
.client-accounts-empty {
  font-size: 0.85rem;
  color: #cbd5f5;
}
@media (max-width: 820px) {
  .client-role-actions {
    flex-direction: column;
    align-items: stretch;
  }
  .client-role-actions .btn {
    width: 100%;
  }
}
@media (max-width: 820px) {
  .client-invite-grid {
    grid-template-columns: 1fr;
  }
  .client-invite-actions {
    flex-direction: column;
    align-items: stretch;
  }
  .client-invite-actions .btn {
    width: 100%;
  }
}
</style>
</head>
<body>
<!-- partial:index.partial.html -->
<!DOCTYPE html>

<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
<title>üìä Sa√∫de do Marketing ‚Äî v4.9.1 (isola√ß√£o de abas + IDs est√°veis)</title>
<style>
    :root{ --accent:#ff6600; --bg:#000; --panel:#111; --input:#1a1a1a; --border:#333; --muted:#bbb;
      --iframe-h: 720px; --margin-left: clamp(10px,4vw,24px); --margin-right: clamp(10px,4vw,24px);
      --shell-border: rgba(255,255,255,.14); --title-bg: rgba(0,0,0,.35); }

    @media (max-width: 900px){
      :root{
        --margin-left: 16px;
        --margin-right: 16px;
      }

      .auth-box{
        max-width:min(100%,520px);
      }
    }
    *{box-sizing:border-box}
    html,body{min-height=100%}
    html{background:linear-gradient(135deg,var(--bg),#1a1a1a 40%,var(--accent) 120%);background-attachment:fixed}
    body{margin:0;color:#fff;font-family:Arial,Helvetica,sans-serif;display:flex;flex-direction:column;min-height:100vh;width:100%;overflow-x:hidden}
    h1{margin:16px 0;text-align:center;font-size:1.35rem}
    h1.site-logo{display:flex;align-items:center;justify-content:center}
    h1.site-logo img{height:clamp(40px,8vw,50px);width:auto;max-width:100%}

    .center-box{flex:1;display:flex;align-items:center;justify-content:center;padding:16px}
    .auth-box{width:100%;max-width:380px;background:var(--panel);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.4);padding:20px}
    .field{margin:10px 0}
    .input{width:100%;background:var(--input);border:1px solid var(--border);color:#fff;border-radius:10px;padding:12px 14px;font-size:.95rem}
    .input[type="date"]{color-scheme:dark;cursor:pointer}
    .input[type="date"]::-webkit-calendar-picker-indicator{filter:invert(1);cursor:pointer}
    .btn{display:inline-block;border:0;border-radius:12px;padding:10px 14px;font-weight:800;color:#fff;background:var(--accent);cursor:pointer}
    .btn.secondary{background:#333}
    .btn.danger{background:#991b1b;border:1px solid rgba(239,68,68,.6)}
    .btn.small{padding:6px 10px;border-radius:8px;font-weight:700}
    .btn.ghost{background:rgba(255,255,255,.07);border:1px solid var(--shell-border)}
    .link{color:#ffb366;text-decoration:underline;cursor:pointer;font-size:.9rem}
    .divider{height:2px;background:#ddd;opacity:.4;margin:8px 0 14px}

    #userArea{display:none;padding:16px}
    .topbar{display:grid;grid-template-columns:minmax(0,1fr) auto;align-items:stretch;gap:14px;margin-bottom:8px}
    .topbar-left{display:flex;align-items:center;gap:12px;flex-wrap:wrap;min-width:0}
    .user-info{font-weight:700;font-size:.85rem;color:#f5f5f5;line-height:1.4;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .user-btn{background:#333;border:0;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}

    .social-icons{display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin-left:0}
    .social-icon{width:24px;height:24px;border-radius:50%;overflow:hidden;display:inline-flex;align-items:center;justify-content:center;position:relative;cursor:pointer}
    .social-icon img{width:100%;height:100%;object-fit:cover}
    .social-icon:not(.has-link)::after{content:"+";position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:900;background:rgba(0,0,0,.5);color:#fff;opacity:0;transition:opacity .2s;border-radius:50%}
    .social-icon:not(.has-link):hover::after{opacity:1}

    .right-tools{display:flex;align-items:stretch;gap:12px;justify-content:flex-end;flex-wrap:wrap}
    .profile-area{display:none;align-items:center;gap:8px;position:relative}
    .profile-area.active{display:flex}
    .profile-avatar{width:46px;height:46px;border-radius:50%;border:2px solid var(--shell-border,rgba(255,255,255,.35));background:#0f172a;color:#94a3b8;display:flex;align-items:center;justify-content:center;overflow:hidden;cursor:pointer;position:relative;transition:border-color .2s ease,transform .2s ease;padding:0}
    .profile-avatar:hover{border-color:var(--accent,#0ea5e9);transform:scale(1.02)}
    .profile-avatar img{width:100%;height:100%;object-fit:cover;display:none}
    .profile-avatar.has-image img{display:block}
    .profile-avatar .avatar-placeholder{font-size:.8rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase}
    .profile-avatar.has-image .avatar-placeholder{display:none}
    .profile-avatar.uploading{cursor:progress;pointer-events:none}
    .profile-avatar.uploading::after{content:"";position:absolute;inset:0;background:rgba(0,0,0,.55)}
    .profile-avatar.uploading::before{content:"";position:absolute;width:18px;height:18px;border:2px solid rgba(255,255,255,.25);border-top-color:#fff;border-radius:50%;animation:spin .9s linear infinite}
    .profile-meta{display:flex;flex-direction:column;align-items:flex-start;line-height:1}
    .profile-meta strong{font-size:.78rem;color:#fff;text-transform:uppercase;letter-spacing:.08em}
    .profile-meta small{font-size:.65rem;color:#9ca3af}
    .settings-tab{width:46px;height:46px;border-radius:14px;border:1px solid var(--shell-border,rgba(255,255,255,.18));background:rgba(15,23,42,.6);color:var(--accent);display:none;align-items:center;justify-content:center;font-size:1.2rem;font-weight:700;cursor:pointer;transition:background .2s ease,border-color .2s ease,transform .2s ease;box-shadow:0 6px 18px rgba(8,15,40,.45)}
    .profile-area[aria-hidden="false"] + .settings-tab{display:flex}
    .settings-tab:hover,.settings-tab:focus-visible{outline:none;background:rgba(14,116,144,.25);border-color:var(--accent);transform:translateY(-1px)}
    .settings-tab:active{transform:scale(.96)}
    .settings-panel{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.8);backdrop-filter:blur(8px);padding:24px;z-index:10000}
    .settings-panel.open{display:flex}
    .settings-panel-inner{width:min(1080px,94vw);max-height:90vh;background:rgba(15,23,42,.92);border:1px solid var(--shell-border,rgba(255,255,255,.18));border-radius:18px;display:flex;overflow:hidden;box-shadow:0 30px 80px rgba(0,0,0,.65)}
    .settings-sidebar{width:240px;background:rgba(15,23,42,.88);border-right:1px solid var(--shell-border,rgba(255,255,255,.12));display:flex;flex-direction:column;gap:6px;padding:22px 18px;position:relative}
    .settings-sidebar::after{content:"";position:absolute;top:0;right:0;bottom:0;width:1px;background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,0));opacity:.6}
    .settings-sidebar-title{font-size:.78rem;letter-spacing:.12em;text-transform:uppercase;color:#94a3b8;font-weight:800;margin-bottom:12px}
    .settings-nav-btn{appearance:none;border:0;border-radius:12px;padding:10px 12px;background:transparent;color:#e2e8f0;font-size:.9rem;font-weight:700;text-align:left;cursor:pointer;transition:background .2s ease,color .2s ease,transform .2s ease}
    .settings-nav-btn:hover,.settings-nav-btn:focus-visible{outline:none;background:rgba(14,116,144,.18);color:#fff;transform:translateX(2px)}
    .settings-nav-btn.active{background:rgba(14,116,144,.28);color:#fff;box-shadow:inset 0 0 0 1px rgba(56,189,248,.35)}
    .settings-content{flex:1;display:flex;flex-direction:column;background:linear-gradient(135deg,rgba(13,23,42,.85),rgba(9,14,32,.95))}
    .settings-content-header{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:22px 24px;border-bottom:1px solid var(--shell-border,rgba(255,255,255,.12))}
    .settings-content-header h2{margin:0;font-size:1.35rem;font-weight:800;color:#f8fafc}
    .settings-subtitle{margin:4px 0 0;font-size:.9rem;color:#cbd5f5}
    .settings-close{background:rgba(15,23,42,.72);border:1px solid rgba(148,163,184,.24);color:#e2e8f0;border-radius:10px;width:40px;height:40px;font-size:1.4rem;font-weight:700;line-height:1;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .2s ease,border-color .2s ease,transform .2s ease}
    .settings-close:hover,.settings-close:focus-visible{outline:none;background:rgba(14,116,144,.25);border-color:var(--accent);transform:rotate(90deg)}
    .settings-body{flex:1;padding:24px;overflow-y:auto;display:flex;flex-direction:column;gap:18px}
    .settings-card{background:rgba(15,23,42,.75);border:1px solid var(--shell-border,rgba(255,255,255,.12));border-radius:14px;padding:18px;display:flex;flex-direction:column;gap:10px;box-shadow:0 18px 30px rgba(8,15,40,.45)}
    .settings-card h3{margin:0;font-size:1.05rem;font-weight:800;color:#f1f5f9}
    .settings-card p{margin:0;font-size:.92rem;color:#cbd5f5;line-height:1.6}
    .settings-card ul{margin:0;padding-left:18px;color:#cbd5f5;font-size:.9rem;display:flex;flex-direction:column;gap:4px}
    .settings-card ul li strong{color:#f8fafc}
    .settings-mobile-nav{display:none;align-items:center;gap:12px;padding:16px 24px;border-bottom:1px solid rgba(148,163,184,.18);background:rgba(15,23,42,.75)}
    .settings-mobile-nav label{font-size:.78rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#94a3b8}
    .settings-mobile-nav select{flex:1;background:#0f172a;border:1px solid rgba(148,163,184,.28);border-radius:10px;padding:8px 12px;color:#e2e8f0;font-size:.92rem}
    @media (max-width: 980px){
      .settings-panel{padding:16px}
      .settings-panel-inner{flex-direction:column;width:min(680px,96vw)}
      .settings-sidebar{display:none}
      .settings-mobile-nav{display:flex}
      .settings-content{background:rgba(15,23,42,.92)}
    }
    @media (max-width: 600px){
      .settings-panel{padding:12px}
      .settings-close{width:36px;height:36px}
      .settings-body{padding:18px}
    }
    .mini-total{background:var(--panel);border:1px solid #222;border-radius:12px;padding:8px 12px;display:flex;align-items:center;gap:8px;box-shadow:0 4px 12px rgba(0,0,0,.35);min-width:84px;justify-content:center;flex-wrap:wrap}
    .mini-total .dot{width:8px;height:8px;border-radius:50%;background:var(--accent)}
    .mini-total .total-level{font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#cbd5f5}
    .mini-total[data-level="excelente"] .dot{background:#22c55e}
    .mini-total[data-level="bom"] .dot{background:#38bdf8}
    .mini-total[data-level="atencao"] .dot{background:#f97316}
    .mini-total[data-level="critico"] .dot{background:#ef4444}
    .total-score{font-size:1.4rem;font-weight:900;line-height:1;color:var(--accent)}
    .total-sub{font-size:.8rem;color:var(--muted)}
    .mini-total[data-tip]{position:relative}
    .mini-total[data-tip]:hover::after{content:attr(data-tip);position:absolute;right:0;top:calc(100% + 8px);background:#000;color:#fff;border:1px solid #222;padding:8px 10px;border-radius:8px;font-size:.8rem;white-space:nowrap;box-shadow:0 6px 16px rgba(0,0,0,.45);z-index:5}

    .storage-usage{display:flex;flex-direction:column;gap:6px;background:var(--panel);border:1px solid var(--shell-border);border-radius:12px;padding:10px 12px;min-width:220px;flex:1 1 240px;max-width:320px;box-shadow:0 4px 12px rgba(0,0,0,.3)}
    .storage-usage.hidden{display:none}
    .storage-usage-header,.storage-usage-footer{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap}
    .storage-usage-title{font-size:.78rem;font-weight:700;color:var(--muted)}
    .storage-usage-percent{font-size:.9rem;font-weight:800;color:#fff}
    .storage-usage-bar{width:100%;height:8px;background:rgba(255,255,255,.14);border-radius:999px;overflow:hidden;position:relative}
    .storage-usage-fill{height:100%;width:0;background:var(--accent);transition:width .25s ease,background-color .25s ease}
    .storage-usage[data-level="warn"] .storage-usage-fill{background:#ffb74d}
    .storage-usage[data-level="alert"] .storage-usage-fill{background:#ef5350}
    .storage-usage[data-level="warn"] .storage-usage-percent{color:#ffb74d}
    .storage-usage[data-level="alert"] .storage-usage-percent{color:#ef9a9a}
    .storage-usage-footer{font-size:.75rem;color:var(--muted)}
    .storage-usage-summary{color:#fff;font-weight:600}
    .storage-usage-hint{margin-left:auto}

    .section-title{display:none}
    .header-calendar-bar{display:none}
    @media (min-width: 821px){
      .header-calendar-bar{
        display:flex;
        align-items:center;
        gap:12px;
        background:var(--title-bg,rgba(0,0,0,.35));
        border:1px solid var(--shell-border,rgba(255,255,255,.14));
        border-radius:12px;
        padding:10px 14px;
        margin:0 0 12px;
        box-shadow:0 8px 20px rgba(0,0,0,.25);
      }
      .header-calendar-month{
        font-weight:800;
        font-size:.95rem;
        text-transform:capitalize;
        white-space:nowrap;
      }
      .header-calendar-days{
        flex:1;
        display:flex;
        gap:4px;
        align-items:center;
      }
      .header-calendar-day{
        flex:1;
        min-width:0;
        display:flex;
        align-items:center;
        justify-content:center;
        font-size:.75rem;
        font-weight:700;
        color:#e5e5e5;
        background:rgba(255,255,255,.06);
        border-radius:8px;
        padding:6px 0;
        box-shadow:0 2px 6px rgba(0,0,0,.25) inset;
      }
      .header-calendar-day.today{
        background:var(--accent,#ff6600);
        color:#000;
        box-shadow:0 0 0 1px rgba(0,0,0,.35) inset,0 4px 10px rgba(255,102,0,.35);
      }
    }
    .dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:6px}
    .macro-actions{display:none;align-items:center;justify-content:space-between;gap:12px;margin:16px 0 0}
    .macro-insight-badges{display:flex;flex-wrap:wrap;gap:8px}
    .macro-insight-badge{display:flex;align-items:center;gap:6px;background:rgba(255,255,255,.08);border:1px solid var(--shell-border);border-radius:999px;padding:6px 12px;font-size:.8rem;font-weight:600;color:#e5e7eb;box-shadow:0 4px 12px rgba(0,0,0,.28)}
    .macro-insight-badge .dot{width:8px;height:8px;border-radius:50%}
    #historyControls{display:none;margin:20px 0;text-align:right}
    #historyControls select{background:var(--input);color:#fff;border:1px solid var(--border);border-radius:8px;padding:6px 10px}
    #historyLegend{display:none;flex-wrap:wrap;gap:8px;margin:8px 0;align-items:center}
    #historyLegend .legend-item{display:flex;align-items:center;gap:4px;font-size:.8rem;color:#ddd}
    #historyLegend .legend-line{width:16px;height:4px;border-radius:2px}
    #historyChart{display:none;width:100%;margin:20px 0;height:300px}
    .macro-intel{display:flex;flex-direction:column;gap:18px}
    .macro-summary{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:16px;background:var(--panel);border:1px solid var(--shell-border);border-radius:18px;padding:18px;box-shadow:0 14px 32px rgba(0,0,0,.38)}
    .macro-summary-left{display:flex;flex-direction:column;gap:6px;min-width:220px}
    .macro-summary-score{font-size:2.6rem;font-weight:800;line-height:1}
    .macro-summary-level{font-size:1.05rem;font-weight:800;text-transform:uppercase;letter-spacing:.08em}
    .macro-summary-detail{color:#cbd5f5;font-size:.86rem;max-width:540px}
    .macro-summary-meta{display:flex;flex-direction:column;gap:6px;color:#94a3b8;font-size:.8rem}
    .macro-progress-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:16px}
    .macro-progress-card{position:relative;border-radius:18px;padding:18px;color:#fff;overflow:hidden;box-shadow:0 14px 30px rgba(0,0,0,.38)}
    .macro-progress-card::after{content:"";position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,.12),rgba(0,0,0,.3));opacity:.35;pointer-events:none}
    .macro-progress-card strong{font-size:1.02rem;display:block}
    .macro-progress-card small{display:block;margin-top:4px;font-size:.8rem;color:rgba(255,255,255,.8)}
    .macro-progress-summary{margin-top:8px;font-size:.78rem;line-height:1.3;color:rgba(255,255,255,.85);display:none}
    .macro-progress-summary.is-visible{display:flex;flex-direction:column;gap:6px}
    .macro-progress-summary div+div{margin-top:4px}
    .macro-post-target-value{display:block;font-size:1.25rem;font-weight:800;color:#fff}
    .macro-progress-value{font-size:1.9rem;font-weight:800;margin:14px 0 10px;line-height:1}
    .macro-progress-bar{height:8px;background:rgba(255,255,255,.24);border-radius:999px;overflow:hidden}
    .macro-progress-fill{height:100%;background:rgba(255,255,255,.92);border-radius:999px}
    .macro-progress-meta{display:flex;align-items:center;justify-content:space-between;color:rgba(255,255,255,.82);font-size:.78rem;margin-top:10px}
    .macro-goals-detail{background:var(--panel);border:1px solid var(--shell-border);border-radius:18px;padding:18px;box-shadow:0 14px 30px rgba(0,0,0,.36);display:flex;flex-direction:column;gap:16px}
    .macro-goals-detail-title{margin:0;font-size:1.02rem;font-weight:800;color:#fff}
    .macro-goals-detail-content{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
    .macro-goals-card{background:rgba(15,23,42,.45);border:1px solid rgba(148,163,184,.28);border-radius:14px;padding:16px;display:flex;flex-direction:column;gap:10px}
    .macro-goals-card-title{margin:0;font-size:.92rem;font-weight:700;color:#e2e8f0}
    .macro-goals-row{display:flex;align-items:center;justify-content:space-between;font-size:.86rem;color:#e2e8f0}
    .macro-goals-label{color:#94a3b8;font-weight:600}
    .macro-goals-value{font-weight:700;color:#f8fafc}
    .macro-goals-empty{display:none;text-align:center;font-size:.85rem;color:#94a3b8;background:rgba(15,23,42,.45);border:1px dashed rgba(148,163,184,.35);border-radius:12px;padding:14px}
    .macro-sections{display:grid;grid-template-columns:2fr 1fr;gap:18px}
    .macro-timeline{background:var(--panel);border:1px solid var(--shell-border);border-radius:18px;padding:18px;box-shadow:0 14px 30px rgba(0,0,0,.36);display:flex;flex-direction:column;gap:12px}
    .macro-section-title{margin:0;font-size:1.02rem;font-weight:800;color:#fff}
    .macro-timeline-list{display:flex;flex-direction:column;gap:12px;max-height:320px;overflow:auto;padding-right:4px}
    .macro-timeline-item{display:flex;gap:12px;align-items:flex-start}
    .macro-timeline-date{min-width:92px;font-weight:700;font-size:.82rem;color:#cbd5f5;text-transform:uppercase;letter-spacing:.05em}
    .macro-timeline-content{flex:1}
    .macro-timeline-label{font-weight:700;font-size:.92rem;color:#e2e8f0}
    .macro-timeline-meta{font-size:.78rem;color:#94a3b8;margin-top:4px}
    .macro-tag{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:999px;font-size:.72rem;font-weight:700;background:rgba(148,163,184,.16);color:#e2e8f0;margin-top:6px}
    .macro-checklist{background:var(--panel);border:1px solid var(--shell-border);border-radius:18px;padding:18px;box-shadow:0 14px 30px rgba(0,0,0,.36);display:flex;flex-direction:column;gap:12px}
    .macro-check-item{display:flex;gap:12px;align-items:flex-start}
    .macro-check-icon{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1rem;font-weight:700}
    .macro-check-icon.done{background:#22c55e;color:#052e16}
    .macro-check-icon.pending{background:#f97316;color:#311508}
    .macro-check-text{flex:1}
    .macro-check-text strong{display:block;font-size:.92rem;color:#e2e8f0}
    .macro-check-text span{display:block;font-size:.78rem;color:#94a3b8;margin-top:2px}
    .macro-alerts{display:flex;flex-direction:column;gap:10px}
    .macro-alert{display:flex;gap:10px;align-items:flex-start;background:rgba(248,113,113,.12);border:1px solid rgba(248,113,113,.4);border-radius:14px;padding:12px 14px;color:#fecaca;font-size:.84rem;box-shadow:0 10px 24px rgba(0,0,0,.32)}
    .macro-alert.ok{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.35);color:#bbf7d0}
    .macro-mini-dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px}
    .macro-mini-card{background:var(--panel);border:1px solid var(--shell-border);border-radius:16px;padding:16px;box-shadow:0 10px 26px rgba(0,0,0,.34);display:flex;flex-direction:column;gap:8px}
    .macro-mini-card strong{font-size:1.1rem;color:#f8fafc}
    .macro-mini-card span{font-size:.8rem;color:#94a3b8}
    .macro-fill{background:var(--panel);border:1px solid var(--shell-border);border-radius:18px;padding:18px;box-shadow:0 14px 30px rgba(0,0,0,.36);display:flex;flex-direction:column;gap:14px}
    .macro-indicator{display:flex;flex-direction:column;gap:8px}
    .macro-indicator-head{display:flex;align-items:center;justify-content:space-between;font-weight:700;font-size:.9rem;color:#e2e8f0}
    .macro-indicator-bar{height:8px;background:rgba(148,163,184,.2);border-radius:999px;overflow:hidden}
    .macro-indicator-fill{height:100%;background:linear-gradient(90deg,#38bdf8,#0ea5e9)}
    .macro-indicator-desc{font-size:.78rem;color:#94a3b8}
    .macro-empty{background:rgba(15,23,42,.6);border:1px dashed rgba(148,163,184,.3);padding:14px;border-radius:12px;color:#94a3b8;font-size:.85rem;text-align:center}
    .macro-supplemental{display:flex;flex-direction:column;gap:16px}
    .macro-supplemental-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
    .macro-metric-card{background:var(--panel);border:1px solid var(--shell-border);border-radius:16px;padding:16px;box-shadow:0 12px 26px rgba(0,0,0,.32);display:flex;flex-direction:column;gap:10px}
    .macro-metric-title{margin:0;font-size:.95rem;font-weight:800;color:#f8fafc}
    .macro-metric-value{font-size:1.8rem;font-weight:800;color:#fff;line-height:1}
    .macro-metric-detail{font-size:.78rem;color:#94a3b8;min-height:1.2em}
    .macro-list-card{background:var(--panel);border:1px solid var(--shell-border);border-radius:16px;padding:16px;box-shadow:0 12px 26px rgba(0,0,0,.32);display:flex;flex-direction:column;gap:12px}
    .macro-list-title{margin:0;font-size:1rem;font-weight:800;color:#f8fafc}
    .macro-list-items{display:flex;flex-direction:column;gap:10px}
    .macro-list-item{display:flex;flex-direction:column;gap:2px}
    .macro-list-item strong{font-size:.9rem;color:#e2e8f0}
    .macro-list-item span{font-size:.75rem;color:#94a3b8}
    .macro-list-empty{display:none;font-size:.8rem;color:#94a3b8;background:rgba(15,23,42,.45);border:1px dashed rgba(148,163,184,.28);border-radius:10px;padding:12px;text-align:center}
    .macro-social-card{background:var(--panel);border:1px solid var(--shell-border);border-radius:20px;padding:22px;box-shadow:0 16px 34px rgba(0,0,0,.32);display:flex;flex-direction:column;gap:18px}
    .macro-social-title{margin:0;font-size:1.05rem;font-weight:800;color:#f8fafc;text-align:center}
    .macro-social-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px}
    .macro-social-item{display:flex;flex-direction:column;align-items:center;justify-content:flex-start;gap:14px;background:rgba(15,23,42,.52);border:1px solid rgba(148,163,184,.28);border-radius:18px;padding:18px 16px;text-align:center;box-shadow:0 10px 22px rgba(0,0,0,.26);min-height:220px;transition:transform .2s ease,box-shadow .2s ease}
    .macro-social-item:hover{transform:translateY(-2px);box-shadow:0 16px 28px rgba(0,0,0,.28)}
    .macro-social-icon{width:56px;height:56px;border-radius:16px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,.8);border:1px solid rgba(148,163,184,.38);color:#e2e8f0;flex:0 0 auto;padding:16px;font-size:24px;line-height:1}
    .macro-social-icon img{width:24px;height:24px;object-fit:contain;display:block}
    .macro-social-info{display:flex;flex-direction:column;gap:6px;align-items:center;justify-content:center;flex:1;min-width:0}
    .macro-social-label{font-size:.9rem;font-weight:700;color:#f1f5f9}
    .macro-social-status{display:inline-flex;align-items:center;justify-content:center;gap:6px;font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;padding:4px 12px;border-radius:999px;margin-top:2px}
    .macro-social-status.ok{background:rgba(34,197,94,.16);color:#bbf7d0;border:1px solid rgba(34,197,94,.45)}
    .macro-social-status.missing{background:rgba(248,113,113,.16);color:#fecaca;border:1px solid rgba(248,113,113,.45)}
    .macro-social-detail{font-size:.75rem;color:#94a3b8;line-height:1.4}
    .macro-social-actions{display:flex;justify-content:center;align-items:center;width:100%;margin-top:auto}
    .macro-social-open{background:rgba(148,163,184,.18);color:#f1f5f9;border:1px solid rgba(148,163,184,.4);border-radius:999px;padding:8px 18px;font-size:.75rem;font-weight:800;text-transform:uppercase;letter-spacing:.08em;cursor:pointer;transition:background .2s,color .2s,border-color .2s;min-width:140px}
    .macro-social-open:hover{background:rgba(148,163,184,.3);color:#fff}
    .macro-social-open:disabled{opacity:.55;cursor:not-allowed;background:rgba(148,163,184,.12);color:#94a3b8;border-color:rgba(148,163,184,.24)}
    .macro-social-summary{margin-top:4px;font-size:.82rem;color:#cbd5f5;font-weight:600;background:rgba(15,23,42,.52);border:1px dashed rgba(148,163,184,.32);border-radius:14px;padding:12px 16px;text-align:center}

    @media (max-width: 900px){
      .macro-summary{padding:16px}
      .macro-summary-score{font-size:2.2rem}
      .macro-progress-card{padding:16px}
      .macro-progress-value{font-size:1.6rem}
    }

    @media (max-width: 768px){
      .macro-actions{flex-direction:column;align-items:flex-start;gap:10px}
      .macro-intel{gap:14px}
      .macro-summary{flex-direction:column;align-items:flex-start;text-align:left;gap:12px}
      .macro-summary-left{min-width:0;width:100%;gap:4px}
      .macro-summary-score{font-size:2rem}
      .macro-summary-meta{font-size:.78rem}
      .macro-progress-grid{grid-template-columns:1fr}
      .macro-progress-card{padding:14px}
      .macro-progress-meta{flex-direction:column;align-items:flex-start;gap:6px;margin-top:8px}
      .macro-progress-summary{gap:6px}
      .macro-progress-summary.is-visible{display:flex;flex-direction:column;gap:6px}
      .macro-goals-detail{padding:16px}
      .macro-goals-detail-content{grid-template-columns:1fr}
      .macro-goals-row{flex-direction:column;align-items:flex-start;gap:4px}
      .macro-sections{grid-template-columns:1fr;gap:14px}
      .macro-timeline{padding:16px}
      .macro-timeline-list{max-height:none;padding-right:0}
      .macro-timeline-item{flex-direction:column;gap:6px}
      .macro-timeline-date{min-width:0;font-size:.78rem}
      .macro-checklist{padding:16px}
      .macro-check-item{flex-direction:column;gap:8px}
      .macro-alert{flex-direction:column;gap:8px}
      .macro-mini-dashboard{grid-template-columns:1fr}
      .macro-mini-card{padding:14px}
      .macro-fill{padding:16px;gap:12px}
      .macro-indicator-head{flex-direction:column;align-items:flex-start;gap:4px}
      .macro-supplemental{gap:14px}
      .macro-supplemental-grid{grid-template-columns:1fr}
      .macro-list-card{padding:14px}
      .macro-social-card{padding:16px}
      .macro-social-grid{grid-template-columns:1fr}
    }

    @media (max-width: 520px){
      .macro-summary{padding:14px}
      .macro-summary-score{font-size:1.8rem}
      .macro-summary-level{font-size:.95rem}
      .macro-summary-detail{font-size:.8rem}
      .macro-progress-card{padding:12px}
      .macro-progress-card strong{font-size:.95rem}
      .macro-progress-value{font-size:1.4rem;margin:12px 0 8px}
      .macro-progress-meta{font-size:.72rem}
      .macro-goals-card{padding:14px}
      .macro-timeline{padding:14px}
      .macro-timeline-date{font-size:.72rem}
      .macro-checklist{padding:14px}
      .macro-alert{padding:12px}
      .macro-mini-card{padding:12px}
      .macro-metric-card{padding:12px}
      .macro-list-card{padding:12px}
      .macro-social-card{padding:14px}
      .macro-social-item{min-height:auto;padding:16px 14px;gap:12px}
      .macro-social-open{min-width:0;width:100%}
      .macro-social-icon{width:52px;height:52px;padding:14px}
    }

    /* tabs */
    .tabs-container{width:100%;margin:14px auto 6px auto;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;gap:8px}
    .menu-toggle{display:none;align-items:center;justify-content:center;gap:8px;background:linear-gradient(135deg,#ff7a1a,#ff3b30);border:0;color:#fff;font-weight:800;border-radius:14px;padding:12px 18px;cursor:pointer;box-shadow:0 10px 22px rgba(255,82,40,.32),0 0 0 1px rgba(255,255,255,.08) inset;text-shadow:0 1px 3px rgba(0,0,0,.35);transition:transform .18s ease,box-shadow .18s ease,filter .18s ease}
    .menu-toggle:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
    .menu-toggle:hover,.menu-toggle:active{transform:scale(1.03);filter:brightness(1.05);box-shadow:0 14px 26px rgba(255,82,40,.38),0 0 0 1px rgba(255,255,255,.12) inset}
    .menu-toggle:active{transform:scale(1.02)}
    .tabs{margin:0;width:100%;display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap}
    .tab-btn{border:1px solid var(--shell-border);background:rgba(255,255,255,.06);color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:800;font-size:.92rem;transition:transform .06s ease,background .2s ease;display:inline-flex;align-items:center;gap:6px}
    .tab-btn:hover{transform:translateY(-1px)}
    .tab-btn.active{background:var(--accent);color:var(--black);border-color:transparent}
    .tab-btn .tab-badge{display:inline-flex;align-items:center;gap:4px;font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.04em;background:rgba(56,189,248,.18);color:#38bdf8;border:1px solid rgba(56,189,248,.45);border-radius:999px;padding:2px 6px}
    .tab-btn .tab-badge::before{content:"";width:6px;height:6px;border-radius:50%;background:currentColor;display:inline-block}
    .tab-btn .tab-badge[hidden]{display:none}

    @media (max-width: 820px){
      .tabs-container{align-items:stretch;gap:0}
      .menu-toggle{display:flex;width:min(260px,100%);margin:0 auto}
      .tabs{display:none;position:absolute;top:calc(100% + 8px);left:50%;transform:translateX(-50%);flex-direction:column;align-items:stretch;justify-content:flex-start;gap:8px;flex-wrap:nowrap;background:rgba(15,23,42,.95);border:1px solid var(--shell-border);border-radius:12px;padding:12px;max-width:min(340px,calc(100vw - 32px));box-shadow:0 18px 32px rgba(0,0,0,.45);z-index:999}
      .tabs-container.menu-open .tabs{display:flex}
      .tabs-container.menu-open .menu-toggle{background:linear-gradient(135deg,#ff8a2b,#ff613a);color:#fff;box-shadow:0 12px 24px rgba(255,82,40,.4),0 0 0 1px rgba(255,255,255,.12) inset}
      .tabs .tab-btn{width:100%;text-align:left}
    }

    /* iframes list */
    .widgets-grid{display:flex;flex-direction:column;gap:12px;margin-top:6px}
    .widget-card{background:transparent;border:0;border-radius:12px;padding:0;width:100%}
    .widget-head{display:flex;align-items:center;gap:8px;margin-left:var(--margin-left);margin-right:var(--margin-right);padding:6px 10px;border-top-left-radius:10px;border-top-right-radius:10px;background:var(--title-bg);backdrop-filter:blur(2px);border:1px solid var(--shell-border);border-bottom:0;cursor:grab}
    .widget-head:active{cursor:grabbing}
    .widget-title{font-weight:700;font-size:.95rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
    .widget-meta{font-size:.8rem;color:#ddd;opacity:.85;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:40%}
    .widget-actions{display:flex;gap:6px;margin-left:6px}
    .icon-btn{border:1px solid var(--shell-border);background:rgba(255,255,255,.06);color:#fff;border-radius:8px;padding:4px 8px;font-size:.85rem;cursor:pointer}
    .icon-btn.danger{background:#3a0000;border-color:#5a0000}
    .widget-input{position:relative;z-index:2;display:none;margin:6px var(--margin-right) 0 var(--margin-left);grid-template-columns:1fr 1fr;gap:8px}
    .widget-card.editing .widget-input{display:grid}
    .widget-input .input{background:var(--input);border:1px solid var(--border);border-radius:8px;padding:10px 12px}
    .frame-shell{height:var(--iframe-h);border:1px solid var(--shell-border);border-top:0;border-bottom-left-radius:10px;border-bottom-right-radius:10px;background:transparent;resize:vertical;overflow:auto;min-height:200px;max-height:3000px;margin-left:var(--margin-left);margin-right:var(--margin-right);box-shadow:0 6px 18px rgba(0,0,0,.35);overscroll-behavior:contain}
    .widget-iframe{width:100%;height:100%;border:0;display:block;background:transparent}
    .drag-placeholder{outline:2px dashed rgba(255,255,255,.35);border-radius:12px;margin-left:var(--margin-left);margin-right:var(--margin-right);height:24px}

    .muted{color:var(--muted);font-size:.85rem}
    @media (max-width: 820px){.brief-webhook-area{display:none!important}}

    /* notas */
    .notes-wrap{margin-left:var(--margin-left);margin-right:var(--margin-right);display:flex;flex-direction:column;gap:10px}
    .note-toolbar, .brief-toolbar{display:flex;flex-wrap:wrap;gap:6px;align-items:center;background:var(--title-bg);border:1px solid var(--shell-border);padding:8px;border-radius:10px}
    .note-toolbar .tool, .brief-toolbar .tool{background:#222;border:1px solid #333;color:#fff;border-radius:8px;padding:6px 10px;cursor:pointer;font-weight:700}
    .brief-toolbar-main{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .brief-webhook-controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .note-toolbar select, .note-toolbar input[type="date"], .note-toolbar input[type="text"],
    .note-toolbar input[type="color"],
    .brief-toolbar input[type="text"]{background:#222;color:#fff;border:1px solid #333;border-radius:8px;padding:6px 8px}
    .note-toolbar input[type="color"]{padding:0;width:36px;height:36px}
    .note-editor{min-height:180px;border:1px solid var(--shell-border);border-radius:10px;padding:10px;outline:none;white-space:pre-wrap;word-wrap:break-word}
    .note-editor, .note-editor *{color:#fff!important;background:transparent!important}
    .note-editor{background:rgba(0,0,0,.2)!important}
    .notes-list{display:flex;flex-direction:column;gap:10px;margin-top:4px}
    .note-template-actions{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    .note-template-actions select{min-width:160px}
    @media (max-width:640px){
      .note-template-actions{width:100%;justify-content:flex-start}
      .note-template-actions select{flex:1 1 160px}
      .note-template-actions .btn{flex:1 1 auto;min-width:140px}
    }
    .note-item{background:var(--panel);border:1px solid var(--shell-border);border-radius:12px;padding:10px;box-shadow:0 6px 18px rgba(0,0,0,.35)}
    .note-head{display:flex;justify-content:space-between;gap:8px;align-items:center}
    .note-title{font-weight:900}
    .note-meta{font-size:.85rem;color:#ddd}
    .tag{font-size:.75rem;font-weight:800;background:#333;padding:3px 8px;border-radius:999px}
    .media-resizable{display:inline-block;max-width:100%;border:1px dashed rgba(255,255,255,.25);border-radius:6px;overflow:hidden;resize:both;padding:2px;margin:6px 2px;vertical-align:middle;background:rgba(255,255,255,.02);box-sizing:border-box;width:420px;position:relative;cursor:pointer}
    .media-resizable img,.media-resizable video{display:block;max-width:100%;width:100%;height:auto;pointer-events:none;object-fit:contain}
    .media-resizable.selected{border-color:var(--accent);box-shadow:0 0 0 2px rgba(255,102,0,.25) inset}
    .media-resizable.selected::after{content:"Pressione Delete ou Backspace para remover";position:absolute;bottom:4px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.8);color:#fff;padding:4px 8px;border-radius:4px;font-size:11px;white-space:nowrap;pointer-events:none;z-index:10}
    .note-editor .media-resizable{max-width:calc(100% - 4px)}

    /* ===== ESTRUTURA√á√ÉO (GAMIFICA√á√ÉO) ===== */
    .estruturacao-wrap{margin-left:var(--margin-left);margin-right:var(--margin-right);display:flex;flex-direction:column;gap:16px;padding-bottom:40px}
    .estruturacao-header{background:var(--panel);border:1px solid var(--shell-border);border-radius:14px;padding:20px;box-shadow:0 8px 22px rgba(0,0,0,.35)}
    .estruturacao-title{font-size:1.8rem;font-weight:900;margin:0 0 8px;background:linear-gradient(135deg,#ff6600,#ffaa00);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .estruturacao-subtitle{font-size:1rem;color:rgba(255,255,255,.7);margin:0}
    
    /* Informa√ß√µes do Neg√≥cio para IA - Vers√£o Minimalista */
    .estruturacao-business-info{margin-top:16px;padding:12px 16px;background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.1);border-radius:10px}
    .estruturacao-business-info-header{display:flex;align-items:center;gap:12px;margin-bottom:10px}
    .estruturacao-business-info-title{font-size:.9rem;font-weight:600;color:rgba(255,255,255,.7)}
    .estruturacao-business-info-fields{display:flex;gap:10px;flex-wrap:wrap}
    .estruturacao-business-info-field{flex:1;min-width:140px;display:flex;flex-direction:column;gap:4px}
    .estruturacao-business-info-field-obs{flex:2;min-width:200px}
    .estruturacao-business-label{font-size:.7rem;font-weight:600;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:.5px}
    .estruturacao-business-input{width:100%;padding:8px 12px;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.12);border-radius:6px;color:#fff;font-size:.85rem;outline:none;transition:all .2s ease}
    .estruturacao-business-textarea{font-family:inherit;line-height:1.5;resize:vertical;min-height:60px;max-height:300px;overflow-y:auto}
    .estruturacao-business-input::placeholder{color:rgba(255,255,255,.3);font-size:.8rem}
    .estruturacao-business-input:focus{border-color:var(--accent);background:rgba(0,0,0,.4)}
    .estruturacao-business-save-btn{padding:6px 14px;background:var(--accent);border:none;border-radius:6px;color:#fff;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .2s ease;white-space:nowrap}
    .estruturacao-business-save-btn:hover{opacity:.9}
    .estruturacao-business-save-status{font-size:.75rem;color:rgba(255,255,255,.5)}
    .estruturacao-business-save-status.success{color:#4ade80}
    .estruturacao-business-save-status.error{color:#f87171}
    @media(max-width:700px){.estruturacao-business-info-fields{flex-direction:column}.estruturacao-business-info-field,.estruturacao-business-info-field-obs{min-width:100%}}
    
    /* Bot√£o Limpar Tudo */
    #clearAllEstruturacaoBtn{
      background:#dc2626 !important;
      border:none !important;
      transition:all .3s ease;
    }
    #clearAllEstruturacaoBtn:hover{
      background:#b91c1c !important;
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(220, 38, 38, 0.4);
    }
    #clearAllEstruturacaoBtn:active{
      transform:translateY(0);
    }
    
    .estruturacao-progress-bar{margin-top:16px;height:12px;background:rgba(0,0,0,.4);border-radius:999px;overflow:hidden;position:relative;border:1px solid rgba(255,255,255,.1)}
    .estruturacao-progress-fill{height:100%;background:linear-gradient(90deg,#ff6600,#ffaa00);transition:width .6s ease;border-radius:999px;position:relative;overflow:hidden}
    .estruturacao-progress-fill::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);animation:shimmer 2s infinite}
    @keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
    .estruturacao-progress-text{display:flex;justify-content:space-between;margin-top:8px;font-size:.85rem;color:rgba(255,255,255,.6)}
    
    /* Barra de pesquisa da estrutura√ß√£o */
    .estruturacao-search-wrap{margin-top:20px;position:relative}
    .estruturacao-search-input{width:100%;padding:14px 20px 14px 48px;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.15);border-radius:12px;color:#fff;font-size:.95rem;outline:none;transition:all .2s ease}
    .estruturacao-search-input::placeholder{color:rgba(255,255,255,.4)}
    .estruturacao-search-input:focus{border-color:var(--accent);background:rgba(0,0,0,.5);box-shadow:0 0 0 3px rgba(255,102,0,.15)}
    .estruturacao-search-icon{position:absolute;left:16px;top:50%;transform:translateY(-50%);font-size:1.1rem;color:rgba(255,255,255,.4);pointer-events:none}
    .estruturacao-search-input:focus + .estruturacao-search-icon,.estruturacao-search-input:not(:placeholder-shown) + .estruturacao-search-icon{color:var(--accent)}
    .estruturacao-search-clear{position:absolute;right:14px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,.1);border:none;color:rgba(255,255,255,.6);width:24px;height:24px;border-radius:50%;cursor:pointer;display:none;align-items:center;justify-content:center;font-size:.8rem;transition:all .2s ease}
    .estruturacao-search-clear:hover{background:rgba(255,100,100,.3);color:#fff}
    .estruturacao-search-input:not(:placeholder-shown) ~ .estruturacao-search-clear{display:flex}
    .estruturacao-search-results{margin-top:8px;font-size:.8rem;color:rgba(255,255,255,.5);display:none}
    .estruturacao-search-results.active{display:block}
    .estruturacao-search-results .highlight{color:var(--accent);font-weight:600}
    
    /* Bot√µes de filtro de m√≠dia */
    .estruturacao-media-filters{display:flex;gap:8px;margin-top:12px}
    .estruturacao-media-filter-btn{display:flex;align-items:center;gap:6px;padding:10px 16px;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.12);border-radius:10px;color:rgba(255,255,255,.7);font-size:.85rem;cursor:pointer;transition:all .2s ease}
    .estruturacao-media-filter-btn:hover{background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.2);color:#fff}
    .estruturacao-media-filter-btn.active{background:rgba(255,102,0,.2);border-color:var(--accent);color:var(--accent)}
    .estruturacao-media-filter-btn .filter-icon{font-size:1.1rem}
    .estruturacao-media-filter-btn .filter-count{background:rgba(255,255,255,.15);padding:2px 8px;border-radius:12px;font-size:.75rem;font-weight:600}
    .estruturacao-media-filter-btn.active .filter-count{background:rgba(255,102,0,.3)}
    
    /* Galeria de M√≠dia */
    .estruturacao-media-gallery{display:none;margin-top:20px;background:var(--panel);border:1px solid var(--shell-border);border-radius:14px;padding:20px;animation:fadeIn .3s ease}
    .estruturacao-media-gallery.active{display:block}
    .estruturacao-media-gallery-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid rgba(255,255,255,.1)}
    .estruturacao-media-gallery-title{font-size:1.1rem;font-weight:600;color:#fff;display:flex;align-items:center;gap:8px}
    .estruturacao-media-gallery-title .gallery-icon{font-size:1.3rem}
    .estruturacao-media-gallery-close{background:rgba(255,255,255,.1);border:none;color:rgba(255,255,255,.6);width:32px;height:32px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1rem;transition:all .2s ease}
    .estruturacao-media-gallery-close:hover{background:rgba(255,100,100,.3);color:#fff}
    .estruturacao-media-gallery-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(200px, 1fr));gap:16px}
    .estruturacao-media-gallery-item{background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.1);border-radius:12px;overflow:hidden;transition:all .2s ease;cursor:pointer}
    .estruturacao-media-gallery-item:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,.4)}
    .estruturacao-media-gallery-preview{width:100%;aspect-ratio:16/10;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative}
    .estruturacao-media-gallery-preview img{width:100%;height:100%;object-fit:cover}
    .estruturacao-media-gallery-preview video{width:100%;height:100%;object-fit:cover}
    .estruturacao-media-gallery-preview .video-overlay{position:absolute;inset:0;background:rgba(0,0,0,.3);display:flex;align-items:center;justify-content:center;font-size:2.5rem;color:#fff;opacity:.9;transition:opacity .2s ease}
    .estruturacao-media-gallery-item:hover .video-overlay{opacity:1;background:rgba(0,0,0,.15)}
    .estruturacao-media-gallery-info{padding:12px}
    .estruturacao-media-gallery-name{font-size:.85rem;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:6px}
    .estruturacao-media-gallery-location{font-size:.75rem;color:rgba(255,255,255,.5);display:flex;flex-direction:column;gap:2px}
    .estruturacao-media-gallery-location span{display:flex;align-items:center;gap:4px}
    .estruturacao-media-gallery-location .loc-icon{font-size:.7rem}
    .estruturacao-media-gallery-empty{text-align:center;padding:40px 20px;color:rgba(255,255,255,.4)}
    .estruturacao-media-gallery-empty .empty-icon{font-size:3rem;margin-bottom:12px;opacity:.5}
    .estruturacao-media-gallery-empty p{font-size:.95rem}
    .estruturacao-media-gallery-actions{display:flex;gap:6px;margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,.1)}
    .estruturacao-media-gallery-goto{flex:1;padding:6px 10px;background:rgba(255,102,0,.2);border:1px solid var(--accent);border-radius:6px;color:var(--accent);font-size:.75rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:4px;transition:all .2s ease}
    .estruturacao-media-gallery-goto:hover{background:var(--accent);color:#fff}
    
    /* Agrupamento de itens do mesmo checklist */
    .estruturacao-media-gallery-group{display:contents}
    .estruturacao-media-gallery-group-header{grid-column:1/-1;background:rgba(255,102,0,.1);border:1px solid rgba(255,102,0,.25);border-radius:10px;padding:10px 14px;margin-top:8px;display:flex;flex-wrap:wrap;align-items:center;gap:8px 16px}
    .estruturacao-media-gallery-group:first-child .estruturacao-media-gallery-group-header{margin-top:0}
    .estruturacao-media-gallery-group-title{font-size:.85rem;font-weight:600;color:#fff;display:flex;align-items:center;gap:6px}
    .estruturacao-media-gallery-group-title .group-icon{font-size:.9rem}
    .estruturacao-media-gallery-group-meta{font-size:.75rem;color:rgba(255,255,255,.5);display:flex;align-items:center;gap:6px}
    .estruturacao-media-gallery-group-meta span{display:flex;align-items:center;gap:4px}
    .estruturacao-media-gallery-group-count{margin-left:auto;background:rgba(255,102,0,.2);color:var(--accent);padding:3px 10px;border-radius:12px;font-size:.7rem;font-weight:700}
    .estruturacao-media-gallery-group-goto{background:transparent;border:1px solid var(--accent);color:var(--accent);padding:4px 10px;border-radius:6px;font-size:.7rem;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:4px;transition:all .2s ease;margin-left:8px}
    .estruturacao-media-gallery-group-goto:hover{background:var(--accent);color:#fff}
    .estruturacao-media-gallery-group-items{display:contents}
    .estruturacao-media-gallery-item.grouped{border-left:3px solid var(--accent)}
    .estruturacao-media-gallery-item.grouped .estruturacao-media-gallery-location{display:none}
    .estruturacao-media-gallery-item.grouped .estruturacao-media-gallery-actions{display:none}
    
    /* Preview de documentos na galeria */
    .document-preview-icon{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;width:100%;height:100%;background:linear-gradient(135deg,rgba(30,30,40,.9),rgba(20,20,30,.95))}
    .document-preview-icon .doc-icon{font-size:2.5rem}
    .document-preview-icon .doc-ext{background:rgba(255,102,0,.2);color:var(--accent);padding:2px 8px;border-radius:4px;font-size:.7rem;font-weight:700;text-transform:uppercase}
    .document-preview-icon .doc-size{font-size:.7rem;color:rgba(255,255,255,.4)}
    .estruturacao-media-gallery-item.is-document .estruturacao-media-gallery-preview{cursor:pointer}
    
    /* Preview de documentos no Lightbox */
    .estruturacao-lightbox-document{width:90vw;max-width:900px;height:80vh;display:flex;align-items:center;justify-content:center}
    .document-iframe-preview{width:100%;height:100%;border:none;border-radius:8px;background:#fff}
    .document-preview-large{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;padding:40px;background:rgba(30,30,40,.95);border-radius:16px;border:1px solid rgba(255,255,255,.1);min-width:320px}
    .doc-icon-large{font-size:5rem}
    .doc-name-large{font-size:1.1rem;font-weight:600;color:#fff;text-align:center;word-break:break-word;max-width:400px}
    .doc-size-large{font-size:.9rem;color:rgba(255,255,255,.5)}
    .doc-actions-large{display:flex;flex-direction:column;gap:10px;margin-top:16px;width:100%;max-width:280px}
    .doc-btn-open,.doc-btn-download{display:flex;align-items:center;justify-content:center;gap:8px;padding:12px 20px;border-radius:8px;font-size:.9rem;font-weight:600;text-decoration:none;transition:all .2s ease}
    .doc-btn-open{background:rgba(255,102,0,.2);color:var(--accent);border:1px solid var(--accent)}
    .doc-btn-open:hover{background:var(--accent);color:#fff}
    .doc-btn-download{background:rgba(96,165,250,.2);color:#60a5fa;border:1px solid #60a5fa}
    .doc-btn-download:hover{background:#60a5fa;color:#fff}
    
    /* Popup de Preview de Documentos (usado nos checklists) */
    .doc-preview-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.85);z-index:10000;display:flex;align-items:center;justify-content:center;opacity:0;visibility:hidden;transition:all .25s ease}
    .doc-preview-overlay.active{opacity:1;visibility:visible}
    .doc-preview-container{background:#1a1a24;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.5);overflow:hidden;display:flex;flex-direction:column;max-width:90vw;max-height:90vh;width:900px;height:80vh}
    .doc-preview-container.doc-preview-compact{width:auto;min-width:360px;max-width:500px;height:auto}
    .doc-preview-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:rgba(0,0,0,.3);border-bottom:1px solid rgba(255,255,255,.1);gap:16px}
    .doc-preview-title{display:flex;align-items:center;gap:10px;flex:1;min-width:0}
    .doc-preview-icon{font-size:1.5rem}
    .doc-preview-name{font-size:.9rem;font-weight:600;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .doc-preview-size{font-size:.75rem;color:rgba(255,255,255,.5);white-space:nowrap}
    .doc-preview-actions{display:flex;align-items:center;gap:8px}
    .doc-preview-close{background:rgba(255,255,255,.1);border:none;color:#fff;font-size:1.2rem;width:32px;height:32px;border-radius:6px;cursor:pointer;transition:background .2s}
    .doc-preview-close:hover{background:rgba(255,255,255,.2)}
    .doc-preview-iframe{flex:1;border:none;background:#fff}
    .doc-preview-body{display:flex;flex-direction:column;align-items:center;gap:20px;padding:40px}
    .doc-preview-large-icon{font-size:4rem}
    .doc-preview-info{text-align:center}
    .doc-preview-filename{font-size:1rem;font-weight:600;color:#fff;word-break:break-word;margin-bottom:4px}
    .doc-preview-filesize{font-size:.85rem;color:rgba(255,255,255,.5)}
    .doc-preview-buttons{display:flex;flex-direction:column;gap:10px;width:100%;max-width:260px;margin-top:8px}
    .doc-btn-delete{display:flex;align-items:center;justify-content:center;gap:8px;padding:12px 20px;border-radius:8px;font-size:.9rem;font-weight:600;background:rgba(239,68,68,.15);color:#ef4444;border:1px solid #ef4444;cursor:pointer;transition:all .2s ease}
    .doc-btn-delete:hover{background:#ef4444;color:#fff}
    
    @media (max-width: 600px){
      .doc-preview-container{max-width:95vw;max-height:85vh}
      .doc-preview-container.doc-preview-compact{min-width:90vw}
      .doc-preview-header{flex-direction:column;align-items:stretch;gap:10px}
      .doc-preview-actions{justify-content:center;flex-wrap:wrap}
    }

    @media (max-width: 820px){
      .estruturacao-media-gallery-group-header{flex-direction:column;align-items:flex-start;gap:6px}
      .estruturacao-media-gallery-group-count{margin-left:0}
      .estruturacao-media-gallery-group-goto{margin-left:0;width:100%;justify-content:center;margin-top:4px}
      .estruturacao-lightbox-document{width:95vw;height:70vh}
      .document-preview-large{padding:24px;min-width:auto}
      .doc-icon-large{font-size:3.5rem}
      .doc-name-large{font-size:.95rem}
    }
    
    /* Lightbox para visualiza√ß√£o */
    .estruturacao-lightbox{position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:999999;display:none;align-items:center;justify-content:center;padding:20px;animation:fadeIn .2s ease}
    .estruturacao-lightbox.active{display:flex}
    .estruturacao-lightbox-content{max-width:95vw;max-height:90vh;position:relative}
    .estruturacao-lightbox-content img,.estruturacao-lightbox-content video{max-width:100%;max-height:70vh;border-radius:8px}
    .estruturacao-lightbox-close{position:absolute;top:-40px;right:0;background:rgba(255,255,255,.1);border:none;color:#fff;width:36px;height:36px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.2rem;transition:all .2s ease;z-index:10}
    .estruturacao-lightbox-close:hover{background:rgba(255,100,100,.5)}
    .estruturacao-lightbox-info{position:absolute;bottom:-50px;left:0;right:0;text-align:center;color:rgba(255,255,255,.7);font-size:.85rem}
    .estruturacao-lightbox-nav{position:fixed;top:50%;transform:translateY(-50%);background:rgba(255,255,255,.1);border:none;color:#fff;width:50px;height:50px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.5rem;transition:all .2s ease;z-index:1000000}
    .estruturacao-lightbox-nav:hover{background:rgba(255,102,0,.6);transform:translateY(-50%) scale(1.1)}
    .estruturacao-lightbox-nav:disabled{opacity:.3;cursor:not-allowed}
    .estruturacao-lightbox-nav:disabled:hover{background:rgba(255,255,255,.1);transform:translateY(-50%)}
    .estruturacao-lightbox-nav.prev{left:20px}
    .estruturacao-lightbox-nav.next{right:20px}
    .estruturacao-lightbox-counter{position:absolute;top:-40px;left:0;color:rgba(255,255,255,.6);font-size:.85rem}
    /* Lightbox Layout com Sidebar de Tags */
    .lightbox-layout{display:flex;gap:24px;align-items:flex-start;}
    .lightbox-media{flex:1;display:flex;align-items:center;justify-content:center;}
    .lightbox-media img,.lightbox-media video{max-width:100%;max-height:70vh;border-radius:12px;border:3px solid var(--accent);box-shadow:0 10px 40px rgba(0,0,0,.5);}
    .lightbox-sidebar{width:320px;background:rgba(20,20,30,0.95);border-radius:14px;padding:18px;max-height:75vh;overflow-y:auto;box-shadow:0 8px 32px rgba(0,0,0,.4);}
    .lightbox-sidebar-title{color:#fff;margin:0 0 14px 0;font-size:1rem;display:flex;align-items:center;gap:8px;}
    .lightbox-sidebar-section{margin-bottom:14px;}
    .lightbox-sidebar-label{color:rgba(255,255,255,.7);font-size:.8rem;display:block;margin-bottom:6px;}
    .lightbox-sidebar-textarea{width:100%;min-height:60px;background:#1a1a2e;border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:10px;color:#fff;font-size:.85rem;resize:vertical;}
    .lightbox-sidebar-textarea:focus{outline:none;border-color:rgba(99,102,241,.5);}
    .lightbox-tags-container{display:flex;flex-wrap:wrap;gap:5px;max-height:220px;overflow-y:auto;padding:2px 0;}
    .lightbox-tag-option{display:flex;align-items:center;gap:4px;background:rgba(255,255,255,.05);border:2px solid rgba(255,255,255,.1);border-radius:6px;padding:5px 8px;cursor:pointer;transition:all .2s ease;font-size:.75rem;color:#fff;}
    .lightbox-tag-option:hover{border-color:rgba(99,102,241,.4);background:rgba(99,102,241,.1);}
    .lightbox-tag-option.selected{background:rgba(99,102,241,.3);border-color:rgba(99,102,241,.8);}
    .lightbox-sidebar-actions{margin-top:16px;}
    .lightbox-save-btn{width:100%;background:linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);border:none;color:#fff;padding:12px 20px;border-radius:8px;font-size:.9rem;font-weight:600;cursor:pointer;transition:all .2s ease;box-shadow:0 4px 12px rgba(99,102,241,.3);}
    .lightbox-save-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(99,102,241,.4);}
    @media (max-width:900px){.lightbox-layout{flex-direction:column;align-items:center;} .lightbox-sidebar{width:100%;max-width:400px;}}
    
    /* Highlight nos itens encontrados */
    /* Highlight nos itens encontrados - esconde o que n√£o corresponde, mant√©m cores originais */
    .estruturacao-week.search-hidden{display:none !important}
    .estruturacao-block.search-hidden{display:none !important}
    .estruturacao-item.search-hidden{display:none !important}
    .search-highlight{background:rgba(255,200,0,.35);color:inherit;padding:1px 3px;border-radius:3px;font-weight:inherit}
    
    .estruturacao-weeks{display:flex;flex-direction:column;gap:20px}
    .estruturacao-week{background:var(--panel);border:1px solid var(--shell-border);border-radius:14px;overflow:visible;box-shadow:0 8px 22px rgba(0,0,0,.35);transition:all .3s ease;position:relative;z-index:1}
    .estruturacao-week:has(.estruturacao-disclaimer-icon:hover){z-index:9999}
    .estruturacao-week.completed{border-color:#2e7d32;box-shadow:0 8px 22px rgba(46,125,50,.3)}
    .estruturacao-week-header{padding:16px 20px;background:rgba(255,255,255,.04);border-bottom:1px solid var(--shell-border);cursor:pointer;display:flex;align-items:center;gap:12px;transition:background .2s ease;border-radius:14px 14px 0 0;overflow:visible;position:relative}
    .estruturacao-week-header:hover{background:rgba(255,255,255,.06)}
    /* Disclaimers Icons */
    .estruturacao-disclaimers{display:flex;align-items:center;gap:6px;margin-left:auto;margin-right:8px;position:relative;z-index:50}
    .estruturacao-disclaimer-icon{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.85rem;cursor:help;position:relative;transition:all .2s ease;border:1px solid rgba(255,255,255,.15)}
    .estruturacao-disclaimer-icon:hover{transform:scale(1.15);z-index:999999}
    .estruturacao-disclaimer-icon.icon-explain{background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:#fff}
    .estruturacao-disclaimer-icon.icon-explain:hover{box-shadow:0 0 12px rgba(59,130,246,.6)}
    .estruturacao-disclaimer-icon.icon-warning{background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff}
    .estruturacao-disclaimer-icon.icon-warning:hover{box-shadow:0 0 12px rgba(245,158,11,.6)}
    .estruturacao-disclaimer-icon.icon-importance{background:linear-gradient(135deg,#10b981,#059669);color:#fff}
    .estruturacao-disclaimer-icon.icon-importance:hover{box-shadow:0 0 12px rgba(16,185,129,.6)}
    .estruturacao-disclaimer-tooltip{position:absolute;bottom:calc(100% + 10px);left:50%;transform:translateX(-50%);width:320px;background:rgba(20,20,25,.98);border:1px solid rgba(255,255,255,.2);border-radius:12px;padding:14px 16px;box-shadow:0 10px 40px rgba(0,0,0,.6);opacity:0;visibility:hidden;pointer-events:none;transition:all .25s ease;z-index:999999}
    .estruturacao-disclaimer-icon:hover .estruturacao-disclaimer-tooltip{opacity:1;visibility:visible;pointer-events:auto}
    .estruturacao-disclaimer-tooltip::before{content:'';position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);border-left:8px solid transparent;border-right:8px solid transparent;border-top:8px solid rgba(255,255,255,.2)}
    .estruturacao-disclaimer-tooltip::after{content:'';position:absolute;bottom:-6px;left:50%;transform:translateX(-50%);border-left:6px solid transparent;border-right:6px solid transparent;border-top:6px solid rgba(20,20,25,.98)}
    .estruturacao-disclaimer-tooltip-title{font-size:.9rem;font-weight:800;margin:0 0 8px;display:flex;align-items:center;gap:8px}
    .estruturacao-disclaimer-tooltip.tooltip-explain .estruturacao-disclaimer-tooltip-title{color:#60a5fa}
    .estruturacao-disclaimer-tooltip.tooltip-warning .estruturacao-disclaimer-tooltip-title{color:#fbbf24}
    .estruturacao-disclaimer-tooltip.tooltip-importance .estruturacao-disclaimer-tooltip-title{color:#34d399}
    .estruturacao-disclaimer-tooltip-content{font-size:.8rem;color:rgba(255,255,255,.85);line-height:1.5;margin:0}
    .estruturacao-disclaimer-tooltip-content ul{margin:6px 0 0;padding-left:18px}
    .estruturacao-disclaimer-tooltip-content li{margin-bottom:4px}
    .estruturacao-week-badge{width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,#ff6600,#ffaa00);display:flex;align-items:center;justify-content:center;font-size:1.2rem;font-weight:900;color:#fff;flex-shrink:0;box-shadow:0 4px 12px rgba(255,102,0,.4)}
    .estruturacao-week.completed .estruturacao-week-badge{background:linear-gradient(135deg,#2e7d32,#4caf50)}
    .estruturacao-week-info{flex:1;min-width:0}
    .estruturacao-week-title{font-size:1.1rem;font-weight:900;margin:0 0 4px;color:#fff}
    .estruturacao-week-desc{font-size:.85rem;color:rgba(255,255,255,.6);margin:0}
    .estruturacao-week-progress{display:flex;align-items:center;gap:12px;font-size:.85rem;color:rgba(255,255,255,.7)}
    .estruturacao-week-progress-mini{width:80px;height:6px;background:rgba(0,0,0,.4);border-radius:999px;overflow:hidden}
    .estruturacao-week-progress-mini-fill{height:100%;background:linear-gradient(90deg,#ff6600,#ffaa00);transition:width .3s ease}
    .estruturacao-week.completed .estruturacao-week-progress-mini-fill{background:linear-gradient(90deg,#2e7d32,#4caf50)}
    .estruturacao-week-chevron{font-size:1.2rem;color:rgba(255,255,255,.4);transition:transform .3s ease}
    .estruturacao-week.open .estruturacao-week-chevron{transform:rotate(180deg)}
    .estruturacao-week-body{max-height:0;overflow:hidden;transition:max-height .4s ease}
    .estruturacao-week.open .estruturacao-week-body{max-height:5000px}
    .estruturacao-week-content{padding:20px;display:flex;flex-direction:column;gap:16px}
    .estruturacao-blocks{display:flex;flex-direction:column;gap:12px}
    .estruturacao-block{background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.08);border-radius:12px;overflow:hidden;transition:all .3s ease}
    .estruturacao-block.completed{border-color:#2e7d32;background:rgba(46,125,50,.08)}
    .estruturacao-block-header{padding:14px 16px;display:flex;align-items:flex-start;gap:12px;cursor:pointer;transition:background .2s ease}
    .estruturacao-block-header:hover{background:rgba(255,255,255,.04)}
    .estruturacao-checkbox-wrap{position:relative;width:24px;height:24px;flex-shrink:0;margin-top:2px}
    .estruturacao-checkbox{width:24px;height:24px;border:2px solid rgba(255,255,255,.3);border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .3s ease;background:rgba(0,0,0,.3)}
    .estruturacao-checkbox:hover{border-color:rgba(255,255,255,.5);background:rgba(255,255,255,.05)}
    .estruturacao-checkbox.checked{border-color:#2e7d32;background:#2e7d32}
    .estruturacao-checkbox.checked::after{content:'‚úì';color:#fff;font-size:16px;font-weight:900}
    .estruturacao-block-info{flex:1;min-width:0}
    .estruturacao-block-title{font-size:1rem;font-weight:800;margin:0 0 6px;color:#fff;line-height:1.3}
    .estruturacao-block-items{font-size:.85rem;color:rgba(255,255,255,.6);line-height:1.5;margin:0}
    
    /* Resumo do bloco */
    .estruturacao-block-summary{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .estruturacao-block-summary-item{display:inline-flex;align-items:center;gap:4px;font-size:.7rem;padding:3px 8px;border-radius:20px;background:rgba(255,255,255,.08);color:rgba(255,255,255,.7)}
    .estruturacao-block-summary-item.completed{background:rgba(46,125,50,.2);color:#81c784}
    .estruturacao-block-summary-item.notes{background:rgba(255,193,7,.15);color:#ffd54f}
    .estruturacao-block-summary-item.files{background:rgba(33,150,243,.15);color:#64b5f6}
    .estruturacao-block-summary-item .icon{font-size:.8rem}
    .estruturacao-block-summary-preview{font-size:.65rem;color:rgba(255,255,255,.5);margin-top:6px;display:flex;flex-wrap:wrap;gap:4px 10px;line-height:1.4}
    .estruturacao-block-summary-preview span{display:inline;white-space:nowrap}
    
    .estruturacao-block-body{max-height:0;overflow:hidden;transition:max-height .3s ease}
    .estruturacao-block.open .estruturacao-block-body{max-height:2000px}
    .estruturacao-block-content{padding:0 16px 16px 52px;display:flex;flex-direction:column;gap:12px}
    .estruturacao-items{display:flex;flex-direction:column;gap:8px}
    .estruturacao-item{display:flex;align-items:flex-start;gap:10px;padding:8px;background:rgba(0,0,0,.2);border-radius:8px;border:1px solid rgba(255,255,255,.06);transition:background .2s ease}
    .estruturacao-item:hover{background:rgba(255,255,255,.04)}
    .estruturacao-item-checkbox-wrap{width:20px;height:20px;flex-shrink:0;margin-top:2px}
    .estruturacao-item-checkbox{width:20px;height:20px;border:2px solid rgba(255,255,255,.3);border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s ease;background:rgba(0,0,0,.4)}
    .estruturacao-item-checkbox:hover{border-color:rgba(255,255,255,.5)}
    .estruturacao-item-checkbox.checked{border-color:#2e7d32;background:#2e7d32}
    .estruturacao-item-checkbox.checked::after{content:'‚úì';color:#fff;font-size:12px;font-weight:900}
    .estruturacao-item-text{flex:1;font-size:.9rem;color:rgba(255,255,255,.8);line-height:1.4;min-width:0}
    .estruturacao-item.completed .estruturacao-item-text{color:rgba(255,255,255,.5);text-decoration:line-through}
    
    /* ===== WEEK EXTRAS (Texto, Arquivos, Checklist por semana) ===== */
    .estruturacao-week-extras{margin-bottom:16px;padding:16px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.1);border-radius:12px}
    .estruturacao-week-actions{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .estruturacao-week-action-btn{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.15);color:rgba(255,255,255,.8);border-radius:8px;padding:8px 14px;font-size:.85rem;font-weight:700;cursor:pointer;transition:all .2s ease;display:flex;align-items:center;gap:6px}
    .estruturacao-week-action-btn:hover{background:rgba(255,255,255,.12);color:#fff;border-color:rgba(255,255,255,.3)}
    .estruturacao-week-action-btn.active{background:rgba(255,102,0,.15);border-color:var(--accent);color:var(--accent)}
    .estruturacao-week-expand{display:flex;flex-direction:column;gap:16px}
    .estruturacao-week-expand.hidden{display:none}
    .estruturacao-week-section-label{font-size:.85rem;font-weight:700;color:rgba(255,255,255,.7);margin-bottom:8px;display:flex;align-items:center;gap:6px}
    
    /* Week Note - contenteditable com Markdown renderizado */
    .estruturacao-week-note{width:100%;min-height:100px;max-height:600px;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:14px 16px;color:#fff;font-size:.9rem;overflow-y:auto;transition:border-color .2s ease;line-height:1.6}
    .estruturacao-week-note:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(255,102,0,.15)}
    .estruturacao-week-note[contenteditable="true"]:empty::before{content:attr(data-placeholder);color:rgba(255,255,255,.4);pointer-events:none}
    
    /* Markdown renderizado dentro do week note */
    .estruturacao-week-note h1{font-size:1.35rem;font-weight:700;margin:0 0 .55em;color:#fff;border-bottom:1px solid rgba(255,255,255,.15);padding-bottom:.3em}
    .estruturacao-week-note h2{font-size:1.15rem;font-weight:600;margin:0 0 .45em;color:#fff}
    .estruturacao-week-note h3{font-size:1.02rem;font-weight:600;margin:0 0 .4em;color:rgba(255,255,255,.95)}
    .estruturacao-week-note h4,.estruturacao-week-note h5,.estruturacao-week-note h6{font-size:.95rem;font-weight:600;margin:0 0 .35em;color:rgba(255,255,255,.9)}
    .estruturacao-week-note p{margin:0 0 .65em}
    .estruturacao-week-note p:last-child{margin-bottom:0}
    .estruturacao-week-note strong{font-weight:700;color:#fff}
    .estruturacao-week-note em{font-style:italic}
    .estruturacao-week-note ul,.estruturacao-week-note ol{margin:0 0 .65em;padding-left:1.5em}
    .estruturacao-week-note li{margin:.25em 0}
    .estruturacao-week-note li::marker{color:var(--accent)}
    .estruturacao-week-note blockquote{margin:.5em 0;padding:10px 14px;border-left:3px solid var(--accent);background:rgba(255,102,0,.08);border-radius:0 6px 6px 0;color:rgba(255,255,255,.85);font-style:italic}
    .estruturacao-week-note code{background:rgba(255,255,255,.1);border-radius:4px;padding:2px 6px;font-family:'Consolas','Monaco','Courier New',monospace;font-size:.85rem}
    .estruturacao-week-note pre{background:rgba(0,0,0,.5);border:1px solid rgba(255,255,255,.1);border-radius:6px;padding:12px;overflow-x:auto;margin:.5em 0}
    .estruturacao-week-note pre code{background:transparent;padding:0}
    .estruturacao-week-note hr{border:none;border-top:1px solid rgba(255,255,255,.2);margin:1em 0}
    .estruturacao-week-note a{color:#60a5fa;text-decoration:none}
    .estruturacao-week-note a:hover{text-decoration:underline}
    
    /* Week Note Markdown Editor */
    .estruturacao-week-markdown-editor{display:flex;flex-direction:column;gap:0}
    .estruturacao-week-markdown-toolbar{display:flex;flex-wrap:wrap;gap:4px;padding:8px 10px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.12);border-radius:10px 10px 0 0;border-bottom:none}
    .estruturacao-week-markdown-toolbar + .estruturacao-week-note{border-radius:0 0 10px 10px}
    
    .estruturacao-week-files{display:flex;flex-direction:column;gap:10px}
    .estruturacao-week-files-header{display:flex;align-items:center;gap:10px}
    .estruturacao-week-upload-btn{background:rgba(255,102,0,.12);border:1px solid rgba(255,102,0,.4);color:var(--accent);border-radius:8px;padding:8px 14px;font-size:.85rem;font-weight:700;cursor:pointer;transition:all .2s ease;display:flex;align-items:center;gap:6px}
    .estruturacao-week-upload-btn:hover{background:rgba(255,102,0,.2);border-color:rgba(255,102,0,.6)}
    .estruturacao-week-paste-zone{border:2px dashed rgba(255,255,255,.2);border-radius:10px;padding:20px;text-align:center;color:rgba(255,255,255,.5);font-size:.85rem;cursor:pointer;transition:all .2s ease;background:rgba(0,0,0,.2)}
    .estruturacao-week-paste-zone:hover,.estruturacao-week-paste-zone.dragover{border-color:var(--accent);background:rgba(255,102,0,.08);color:var(--accent)}
    .estruturacao-week-paste-zone p{margin:4px 0}
    .estruturacao-week-files-list{display:flex;flex-wrap:wrap;gap:10px}
    .estruturacao-week-file{position:relative;width:80px;height:80px;border-radius:10px;overflow:visible;border:2px solid rgba(255,255,255,.15);background:#111;cursor:zoom-in;transition:all .2s ease;z-index:1}
    .estruturacao-week-file:hover{border-color:var(--accent);transform:scale(1.05);z-index:9999}
    .estruturacao-week-file img,.estruturacao-week-file video{width:100%;height:100%;object-fit:cover;border-radius:8px}
    
    /* √çcone de zoom - removido pois usamos JS overlay */
    .estruturacao-week-file::after{
      display:none;
    }
    .estruturacao-week-file:hover::after{
      display:none;
    }
    
    /* Zoom effect on hover for week files */
    .estruturacao-week-file:hover::before{
      display:none;
    }
    .estruturacao-week-file:hover img,
    .estruturacao-week-file:hover video{
      /* Removido - usando JS overlay */
    }
    
    .estruturacao-week-file-overlay{position:absolute;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;gap:8px;opacity:0;transition:opacity .2s ease;pointer-events:none;z-index:10}
    .estruturacao-week-file:hover .estruturacao-week-file-overlay{opacity:1;pointer-events:auto}
    .estruturacao-week-file-overlay button{background:rgba(255,255,255,.2);border:none;color:#fff;border-radius:50%;width:28px;height:28px;font-size:.8rem;cursor:pointer;display:flex;align-items:center;justify-content:center;pointer-events:auto}
    .estruturacao-week-file-overlay button:hover{background:rgba(255,255,255,.4)}
    .estruturacao-week-file-overlay button.delete:hover{background:rgba(255,80,80,.8)}
    .estruturacao-week-file-doc{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;font-size:1.8rem;color:rgba(255,255,255,.7)}
    .estruturacao-week-file-doc span{font-size:.6rem;margin-top:4px;color:rgba(255,255,255,.5);text-transform:uppercase;max-width:70px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .estruturacao-week-checklist{display:flex;flex-direction:column;gap:10px}
    .estruturacao-week-checklist-header{display:flex;align-items:center;gap:10px}
    .estruturacao-week-checklist-add{background:rgba(46,125,50,.15);border:1px solid rgba(46,125,50,.4);color:#4caf50;border-radius:8px;padding:8px 14px;font-size:.85rem;font-weight:700;cursor:pointer;transition:all .2s ease}
    .estruturacao-week-checklist-add:hover{background:rgba(46,125,50,.25);border-color:rgba(46,125,50,.6)}
    .estruturacao-week-checklist-items{display:flex;flex-direction:column;gap:8px}
    .estruturacao-week-check{display:flex;align-items:center;gap:10px;padding:10px 12px;background:rgba(0,0,0,.3);border-radius:8px;border:1px solid rgba(255,255,255,.08)}
    .estruturacao-week-check-box{width:20px;height:20px;border:2px solid rgba(255,255,255,.3);border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s ease;background:rgba(0,0,0,.4);flex-shrink:0}
    .estruturacao-week-check-box:hover{border-color:rgba(255,255,255,.5)}
    .estruturacao-week-check-box.checked{border-color:#2e7d32;background:#2e7d32}
    .estruturacao-week-check-box.checked::after{content:'‚úì';color:#fff;font-size:12px;font-weight:900}
    .estruturacao-week-check-input{flex:1;background:transparent;border:none;color:#fff;font-size:.9rem;outline:none}
    .estruturacao-week-check-input::placeholder{color:rgba(255,255,255,.4)}
    .estruturacao-week-check.completed .estruturacao-week-check-input{color:rgba(255,255,255,.5);text-decoration:line-through}
    .estruturacao-week-check-delete{background:none;border:none;color:rgba(255,100,100,.6);cursor:pointer;font-size:1rem;padding:0 4px;opacity:.6;transition:opacity .2s ease}
    .estruturacao-week-check-delete:hover{opacity:1}
    .estruturacao-week-checklist-empty{font-size:.8rem;color:rgba(255,255,255,.4);text-align:center;padding:12px}
    
    /* Item extras minimalista */
    .estruturacao-item{position:relative;display:flex;flex-direction:column;align-items:stretch}
    .estruturacao-item-main{display:flex;align-items:center;gap:10px;cursor:pointer;padding:4px 0}
    .estruturacao-item-main:hover{background:rgba(255,255,255,.02);border-radius:6px}
    .estruturacao-item-toggle{background:none;border:none;color:rgba(255,255,255,.3);cursor:pointer;font-size:.75rem;padding:2px 8px;margin-left:auto;opacity:.7;transition:all .2s ease;display:flex;align-items:center;gap:4px}
    .estruturacao-item-toggle:hover{opacity:1;color:var(--accent)}
    .estruturacao-item.has-extras .estruturacao-item-toggle{color:var(--accent);opacity:1}
    .estruturacao-item.open .estruturacao-item-toggle{transform:rotate(90deg);color:var(--accent);opacity:1}
    .estruturacao-item-extras{display:none;margin-top:10px;margin-left:34px;padding:12px;background:rgba(0,0,0,.3);border-radius:10px;border:1px solid rgba(255,255,255,.1);flex-direction:column;gap:10px}
    .estruturacao-item.open .estruturacao-item-extras{display:flex}
    
    /* Preview da nota no item (horizontal - usa todo espa√ßo) */
    .estruturacao-item-preview{display:flex;flex-wrap:wrap;gap:3px 8px;margin-top:4px;margin-left:34px;font-size:.65rem;color:rgba(255,255,255,.5);line-height:1.35;width:calc(100% - 44px)}
    .estruturacao-item-preview span{display:inline;white-space:nowrap}
    .estruturacao-item-preview .preview-file{background:rgba(33,150,243,.12);color:#64b5f6;padding:1px 6px;border-radius:10px;font-size:.6rem}
    .estruturacao-item.open .estruturacao-item-preview{display:none}
    
    /* Mini actions bar */
    .estruturacao-item-actions{display:flex;gap:6px;margin-bottom:8px}
    .estruturacao-item-action{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.1);border-radius:6px;padding:5px 10px;font-size:.7rem;color:rgba(255,255,255,.6);cursor:pointer;transition:all .2s ease;display:flex;align-items:center;gap:4px}
    .estruturacao-item-action:hover{background:rgba(255,102,0,.15);border-color:rgba(255,102,0,.3);color:var(--accent)}
    .estruturacao-item-action.active{background:rgba(255,102,0,.2);border-color:rgba(255,102,0,.4);color:var(--accent)}
    
    /* Note area - contenteditable com Markdown renderizado */
    .estruturacao-item-note{width:100%;min-height:80px;max-height:500px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:12px 14px;color:#fff;font-size:.85rem;overflow-y:auto;line-height:1.6;transition:border-color .2s ease}
    .estruturacao-item-note:focus{outline:none;border-color:var(--accent)}
    .estruturacao-item-note[contenteditable="true"]:empty::before{content:attr(data-placeholder);color:rgba(255,255,255,.35);pointer-events:none}
    
    /* Markdown renderizado dentro do contenteditable */
    .estruturacao-item-note h1{font-size:1.25rem;font-weight:700;margin:0 0 .5em;color:#fff;border-bottom:1px solid rgba(255,255,255,.15);padding-bottom:.25em}
    .estruturacao-item-note h2{font-size:1.1rem;font-weight:600;margin:0 0 .4em;color:#fff}
    .estruturacao-item-note h3{font-size:1rem;font-weight:600;margin:0 0 .35em;color:rgba(255,255,255,.95)}
    .estruturacao-item-note h4,.estruturacao-item-note h5,.estruturacao-item-note h6{font-size:.9rem;font-weight:600;margin:0 0 .3em;color:rgba(255,255,255,.9)}
    .estruturacao-item-note p{margin:0 0 .6em}
    .estruturacao-item-note p:last-child{margin-bottom:0}
    .estruturacao-item-note strong{font-weight:700;color:#fff}
    .estruturacao-item-note em{font-style:italic}
    .estruturacao-item-note ul,.estruturacao-item-note ol{margin:0 0 .6em;padding-left:1.4em}
    .estruturacao-item-note li{margin:.2em 0}
    .estruturacao-item-note li::marker{color:var(--accent)}
    .estruturacao-item-note blockquote{margin:.4em 0;padding:8px 12px;border-left:3px solid var(--accent);background:rgba(255,102,0,.08);border-radius:0 6px 6px 0;color:rgba(255,255,255,.85);font-style:italic}
    .estruturacao-item-note code{background:rgba(255,255,255,.1);border-radius:4px;padding:2px 5px;font-family:'Consolas','Monaco','Courier New',monospace;font-size:.8rem}
    .estruturacao-item-note pre{background:rgba(0,0,0,.5);border:1px solid rgba(255,255,255,.1);border-radius:6px;padding:10px;overflow-x:auto;margin:.4em 0}
    .estruturacao-item-note pre code{background:transparent;padding:0}
    .estruturacao-item-note hr{border:none;border-top:1px solid rgba(255,255,255,.2);margin:.8em 0}
    .estruturacao-item-note a,.estruturacao-week-notes a{color:#60a5fa;text-decoration:none;cursor:pointer !important;pointer-events:auto !important;position:relative;z-index:10}
    .estruturacao-item-note a:hover,.estruturacao-week-notes a:hover{text-decoration:underline;color:#93c5fd}
    .estruturacao-item-note a::after,.estruturacao-week-notes a::after{content:'‚Üó';font-size:0.65em;margin-left:2px;opacity:0.6}
    
    /* Markdown Editor Container */
    .estruturacao-markdown-editor{display:flex;flex-direction:column;gap:6px;width:100%}
    .estruturacao-markdown-toolbar{display:flex;flex-wrap:wrap;gap:4px;padding:6px 8px;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.12);border-radius:8px 8px 0 0;border-bottom:none}
    .estruturacao-markdown-toolbar + .estruturacao-item-note{border-radius:0 0 8px 8px}
    .estruturacao-markdown-btn{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);border-radius:4px;padding:4px 8px;font-size:.7rem;color:rgba(255,255,255,.7);cursor:pointer;transition:all .15s ease;display:flex;align-items:center;justify-content:center;min-width:28px;font-weight:600}
    .estruturacao-markdown-btn:hover{background:rgba(255,102,0,.2);border-color:rgba(255,102,0,.4);color:var(--accent)}
    .estruturacao-markdown-btn.active{background:rgba(255,102,0,.25);border-color:var(--accent);color:var(--accent)}
    .estruturacao-markdown-btn-sep{width:1px;height:20px;background:rgba(255,255,255,.15);margin:0 4px}
    .estruturacao-markdown-btn-label{font-size:.65rem;color:rgba(255,255,255,.4);margin-left:auto;padding:4px 6px}
    
    /* Help tooltip for markdown */
    .estruturacao-markdown-help{position:relative}
    .estruturacao-markdown-help-tooltip{position:absolute;bottom:calc(100% + 8px);right:0;background:#1a1a1a;border:1px solid rgba(255,255,255,.15);border-radius:8px;padding:12px;min-width:280px;display:none;z-index:100;box-shadow:0 4px 20px rgba(0,0,0,.5)}
    .estruturacao-markdown-help:hover .estruturacao-markdown-help-tooltip{display:block}
    .estruturacao-markdown-help-tooltip h4{font-size:.75rem;color:var(--accent);margin:0 0 8px;font-weight:600}
    .estruturacao-markdown-help-tooltip code{background:rgba(255,255,255,.1);padding:2px 4px;border-radius:3px;font-size:.7rem}
    .estruturacao-markdown-help-tooltip table{width:100%;border-collapse:collapse;font-size:.7rem}
    .estruturacao-markdown-help-tooltip td{padding:4px 6px;border-bottom:1px solid rgba(255,255,255,.08)}
    .estruturacao-markdown-help-tooltip td:first-child{color:rgba(255,255,255,.5);width:45%}
    .estruturacao-markdown-help-tooltip td:last-child{color:#fff}
    
    /* Bot√£o IA Preencher */
    .estruturacao-ai-fill-btn{display:flex;align-items:center;gap:4px;padding:4px 10px;background:linear-gradient(135deg,#8b5cf6,#a855f7);border:none;border-radius:4px;font-size:.7rem;color:#fff;cursor:pointer;transition:all .2s ease;font-weight:600;margin-left:auto}
    .estruturacao-ai-fill-btn:hover{background:linear-gradient(135deg,#7c3aed,#9333ea);transform:translateY(-1px);box-shadow:0 2px 8px rgba(139,92,246,.4)}
    .estruturacao-ai-fill-btn:active{transform:translateY(0)}
    .estruturacao-ai-fill-btn .ai-icon{font-size:.8rem}
    
    /* Bot√£o IA Global para Bloco (preenche todos os itens de uma vez) */
    .estruturacao-block-ai-btn{display:none;align-items:center;gap:6px;padding:6px 14px;background:linear-gradient(135deg,#8b5cf6,#a855f7);border:none;border-radius:6px;font-size:.75rem;color:#fff;cursor:pointer;transition:all .2s ease;font-weight:600;margin-left:auto;white-space:nowrap}
    .estruturacao-block.open .estruturacao-block-ai-btn{display:flex}
    .estruturacao-block-ai-btn:hover{background:linear-gradient(135deg,#7c3aed,#9333ea);transform:translateY(-1px);box-shadow:0 4px 12px rgba(139,92,246,.5)}
    .estruturacao-block-ai-btn:active{transform:translateY(0)}
    .estruturacao-block-ai-btn .ai-icon{font-size:.9rem}
    .estruturacao-block-ai-btn.loading{opacity:.7;pointer-events:none}
    .estruturacao-block-ai-btn.loading::after{content:'';display:inline-block;width:12px;height:12px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;margin-left:6px}
    @keyframes spin{to{transform:rotate(360deg)}}
    
    /* Mini popup para observa√ß√£o antes de gerar com IA */
    .ai-quick-input-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:9999;backdrop-filter:blur(2px)}
    .ai-quick-input-popup{background:#1e1e2e;border:1px solid rgba(139,92,246,.4);border-radius:12px;width:90%;max-width:400px;padding:16px;box-shadow:0 10px 40px rgba(0,0,0,.5)}
    .ai-quick-input-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .ai-quick-input-title{font-size:.9rem;font-weight:600;color:#fff;display:flex;align-items:center;gap:6px}
    .ai-quick-input-close{background:none;border:none;color:rgba(255,255,255,.5);font-size:1.2rem;cursor:pointer;padding:0;line-height:1}
    .ai-quick-input-close:hover{color:#fff}
    .ai-quick-input-field{width:100%;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.15);border-radius:8px;padding:10px 12px;color:#fff;font-size:.85rem;resize:none;min-height:60px;margin-bottom:12px}
    .ai-quick-input-field::placeholder{color:rgba(255,255,255,.4)}
    .ai-quick-input-field:focus{outline:none;border-color:rgba(139,92,246,.5)}
    .ai-quick-input-hint{font-size:.7rem;color:rgba(255,255,255,.4);margin-bottom:12px}
    .ai-quick-input-actions{display:flex;gap:8px;justify-content:flex-end}
    .ai-quick-input-skip{padding:8px 16px;background:rgba(255,255,255,.1);border:none;border-radius:6px;color:rgba(255,255,255,.7);font-size:.8rem;cursor:pointer;transition:all .2s}
    .ai-quick-input-skip:hover{background:rgba(255,255,255,.15)}
    .ai-quick-input-generate{padding:8px 16px;background:linear-gradient(135deg,#8b5cf6,#a855f7);border:none;border-radius:6px;color:#fff;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:4px}
    .ai-quick-input-generate:hover{opacity:.9}
    
    /* Seletor de imagens para IA Vision */
    .ai-quick-input-images{margin-bottom:12px}
    .ai-quick-input-images-label{font-size:.75rem;color:rgba(255,255,255,.6);margin-bottom:8px;display:flex;align-items:center;gap:6px}
    .ai-quick-input-images-label .vision-badge{background:linear-gradient(135deg,#10b981,#059669);color:#fff;padding:2px 6px;border-radius:4px;font-size:.65rem;font-weight:600}
    .ai-quick-input-images-grid{display:flex;flex-wrap:wrap;gap:8px}
    .ai-quick-input-image-item{position:relative;width:64px;height:64px;border-radius:8px;overflow:hidden;cursor:pointer;border:2px solid transparent;transition:all .2s;opacity:.6}
    .ai-quick-input-image-item:hover{opacity:.9;border-color:rgba(139,92,246,.5)}
    .ai-quick-input-image-item.selected{opacity:1;border-color:#8b5cf6;box-shadow:0 0 12px rgba(139,92,246,.5)}
    .ai-quick-input-image-item img{width:100%;height:100%;object-fit:cover}
    .ai-quick-input-image-item .check-badge{position:absolute;top:2px;right:2px;width:18px;height:18px;background:#8b5cf6;border-radius:50%;display:none;align-items:center;justify-content:center;font-size:.7rem;color:#fff}
    .ai-quick-input-image-item.selected .check-badge{display:flex}
    .ai-quick-input-no-images{font-size:.7rem;color:rgba(255,255,255,.3);font-style:italic;padding:8px 0}
    .ai-quick-input-images-hint{font-size:.65rem;color:rgba(139,92,246,.7);margin-top:6px}
    
    /* Hist√≥rico de prompts IA */
    .ai-quick-input-history{margin-bottom:12px;padding:10px;background:rgba(0,0,0,.25);border-radius:8px;border:1px solid rgba(255,255,255,.08)}
    .ai-quick-input-history-label{font-size:.75rem;color:rgba(255,255,255,.5);margin-bottom:8px;display:flex;align-items:center;gap:6px}
    .ai-quick-input-history-list{display:flex;flex-direction:column;gap:4px;max-height:100px;overflow-y:auto}
    .ai-quick-input-history-item{padding:6px 10px;background:rgba(139,92,246,.15);border:1px solid rgba(139,92,246,.25);border-radius:6px;font-size:.7rem;color:rgba(255,255,255,.7);cursor:pointer;transition:all .2s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .ai-quick-input-history-item:hover{background:rgba(139,92,246,.3);border-color:rgba(139,92,246,.5);color:#fff}
    
    /* Modal IA Preencher */
    .ai-fill-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:9999;backdrop-filter:blur(4px)}
    .ai-fill-modal{background:#1a1a2e;border:1px solid rgba(139,92,246,.3);border-radius:12px;width:90%;max-width:600px;max-height:80vh;display:flex;flex-direction:column;box-shadow:0 20px 50px rgba(0,0,0,.5)}
    .ai-fill-modal-header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid rgba(255,255,255,.1);font-weight:600;color:#fff;font-size:.95rem}
    .ai-fill-modal-close{background:rgba(255,255,255,.1);border:none;color:#fff;width:28px;height:28px;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
    .ai-fill-modal-close:hover{background:rgba(255,100,100,.3)}
    .ai-fill-modal-body{padding:16px 18px;flex:1;overflow:auto}
    .ai-fill-prompt-text{width:100%;min-height:250px;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.15);border-radius:8px;padding:14px;color:#e0e0e0;font-size:.85rem;line-height:1.6;resize:vertical;font-family:inherit}
    .ai-fill-prompt-text:focus{outline:none;border-color:rgba(139,92,246,.5)}
    .ai-fill-modal-footer{padding:14px 18px;border-top:1px solid rgba(255,255,255,.1);display:flex;align-items:center;gap:12px}
    .ai-fill-copy-btn{padding:10px 20px;background:linear-gradient(135deg,#8b5cf6,#a855f7);border:none;border-radius:8px;color:#fff;font-weight:600;cursor:pointer;transition:all .2s}
    .ai-fill-copy-btn:hover{opacity:.9}
    .ai-fill-tip{font-size:.75rem;color:rgba(255,255,255,.5)}
    
    /* Bot√£o Lembrar Depois */
    .estruturacao-item-remind{background:none;border:none;color:rgba(255,255,255,.3);cursor:pointer;font-size:.8rem;padding:2px 6px;opacity:.6;transition:all .2s ease;display:flex;align-items:center}
    .estruturacao-item-remind:hover{opacity:1;color:#ffc107;transform:scale(1.1)}
    .estruturacao-item-remind.active{color:#ffc107;opacity:1}
    .estruturacao-item-remind.active:hover{color:#ff9800}
    
    /* Se√ß√£o de Lembretes no final */
    .estruturacao-reminders{margin-top:30px;padding:20px;background:linear-gradient(135deg,rgba(255,193,7,.08),rgba(255,152,0,.05));border:1px solid rgba(255,193,7,.25);border-radius:14px}
    .estruturacao-reminders-header{display:flex;align-items:center;gap:10px;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid rgba(255,193,7,.2)}
    .estruturacao-reminders-header h3{font-size:1rem;color:#ffc107;font-weight:700;margin:0;display:flex;align-items:center;gap:8px}
    .estruturacao-reminders-header h3::before{content:'üîî';font-size:1.1rem}
    .estruturacao-reminders-count{background:rgba(255,193,7,.2);color:#ffc107;padding:2px 8px;border-radius:12px;font-size:.7rem;font-weight:600}
    .estruturacao-reminders-empty{font-size:.85rem;color:rgba(255,255,255,.4);text-align:center;padding:20px;font-style:italic}
    .estruturacao-reminders-list{display:flex;flex-direction:column;gap:10px}
    .estruturacao-reminder-item{display:flex;align-items:flex-start;gap:12px;padding:12px 14px;background:rgba(0,0,0,.3);border-radius:10px;border:1px solid rgba(255,193,7,.15);transition:all .2s ease}
    .estruturacao-reminder-item:hover{border-color:rgba(255,193,7,.35);background:rgba(0,0,0,.4)}
    .estruturacao-reminder-item-info{flex:1;display:flex;flex-direction:column;gap:4px}
    .estruturacao-reminder-item-path{font-size:.65rem;color:rgba(255,255,255,.4);display:flex;flex-wrap:wrap;gap:4px}
    .estruturacao-reminder-item-path span{background:rgba(255,255,255,.08);padding:2px 6px;border-radius:4px}
    .estruturacao-reminder-item-text{font-size:.9rem;color:#fff;font-weight:500}
    .estruturacao-reminder-item-note{font-size:.75rem;color:rgba(255,255,255,.5);margin-top:4px;line-height:1.4;max-height:40px;overflow:hidden;text-overflow:ellipsis}
    .estruturacao-reminder-actions{display:flex;gap:6px;flex-shrink:0}
    .estruturacao-reminder-btn{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.1);border-radius:6px;padding:6px 10px;font-size:.7rem;color:rgba(255,255,255,.6);cursor:pointer;transition:all .2s ease;display:flex;align-items:center;gap:4px}
    .estruturacao-reminder-btn:hover{background:rgba(255,193,7,.15);border-color:rgba(255,193,7,.3);color:#ffc107}
    .estruturacao-reminder-btn.remove{color:rgba(255,100,100,.6)}
    .estruturacao-reminder-btn.remove:hover{background:rgba(255,100,100,.15);border-color:rgba(255,100,100,.3);color:#ff6b6b}
    
    /* Files area */
    .estruturacao-item-files{display:flex;flex-direction:column;gap:8px}
    .estruturacao-item-files-grid{display:flex;flex-wrap:wrap;gap:8px}
    .estruturacao-item-file{position:relative;width:60px;height:60px;border-radius:8px;overflow:visible;border:2px solid rgba(255,255,255,.12);background:#111;cursor:zoom-in;transition:all .2s ease;z-index:1}
    .estruturacao-item-file:hover{border-color:var(--accent);transform:scale(1.05);z-index:9999}
    .estruturacao-item-file img,.estruturacao-item-file video{width:100%;height:100%;object-fit:cover;border-radius:6px}
    
    /* √çcone de zoom - removido pois usamos JS overlay */
    .estruturacao-item-file::after{
      display:none;
    }
    .estruturacao-item-file:hover::after{
      display:none;
    }
    
    /* Zoom effect on hover */
    .estruturacao-item-file:hover::before{
      display:none;
    }
    .estruturacao-item-file:hover img,
    .estruturacao-item-file:hover video{
      /* Removido - usando JS overlay */
    }
    
    /* Overlay de Zoom Global */
    .zoom-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.92);
      z-index:9999999;
      display:flex;
      align-items:center;
      justify-content:center;
      opacity:0;
      visibility:hidden;
      transition:opacity .2s ease, visibility .2s ease;
      pointer-events:none;
      flex-direction:column;
      gap:20px;
    }
    .zoom-overlay.active{
      opacity:1;
      visibility:visible;
      pointer-events:auto;
    }
    .zoom-overlay img,
    .zoom-overlay video{
      max-width:90vw;
      max-height:80vh;
      object-fit:contain;
      border-radius:12px;
      border:4px solid var(--accent);
      box-shadow:0 20px 80px rgba(0,0,0,.9);
      background:#000;
    }
    .zoom-overlay-actions{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .zoom-overlay-btn{
      background:rgba(255,255,255,.15);
      border:2px solid rgba(255,255,255,.3);
      color:#fff;
      padding:12px 24px;
      border-radius:30px;
      font-size:.95rem;
      font-weight:700;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:8px;
      transition:all .2s ease;
    }
    .zoom-overlay-btn:hover{
      background:rgba(255,255,255,.25);
      border-color:rgba(255,255,255,.5);
    }
    .zoom-overlay-btn.delete{
      background:rgba(244,67,54,.2);
      border-color:rgba(244,67,54,.5);
      color:#ff6b6b;
    }
    .zoom-overlay-btn.delete:hover{
      background:rgba(244,67,54,.4);
      border-color:#f44336;
    }
    .zoom-overlay-btn.primary{
      background:linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      border-color:rgba(99,102,241,.8);
      color:#fff;
    }
    .zoom-overlay-btn.primary:hover{
      transform:translateY(-2px);
      box-shadow:0 6px 20px rgba(99,102,241,0.4);
    }
    .zoom-overlay-hint{
      font-size:.8rem;
      color:rgba(255,255,255,.5);
      text-align:center;
    }
    /* Layout com sidebar para tags */
    .zoom-overlay-layout{
      display:flex;
      gap:24px;
      max-width:95vw;
      max-height:90vh;
      align-items:flex-start;
    }
    .zoom-overlay-media{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .zoom-overlay-media img,
    .zoom-overlay-media video{
      max-width:100%;
      max-height:75vh;
      object-fit:contain;
      border-radius:12px;
      border:3px solid var(--accent);
      box-shadow:0 20px 60px rgba(0,0,0,.8);
    }
    .zoom-overlay-sidebar{
      width:340px;
      background:rgba(20,20,30,0.95);
      border-radius:16px;
      padding:20px;
      max-height:80vh;
      overflow-y:auto;
      box-shadow:0 10px 40px rgba(0,0,0,.5);
    }
    .zoom-sidebar-title{
      color:#fff;
      margin:0 0 16px 0;
      font-size:1.1rem;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .zoom-sidebar-section{
      margin-bottom:16px;
    }
    .zoom-sidebar-label{
      color:rgba(255,255,255,.7);
      font-size:.85rem;
      display:block;
      margin-bottom:8px;
    }
    .zoom-sidebar-textarea{
      width:100%;
      min-height:70px;
      background:#1a1a2e;
      border:1px solid rgba(255,255,255,.1);
      border-radius:8px;
      padding:10px;
      color:#fff;
      font-size:.9rem;
      resize:vertical;
    }
    .zoom-sidebar-textarea:focus{
      outline:none;
      border-color:rgba(99,102,241,.5);
    }
    .zoom-tags-container{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      max-height:250px;
      overflow-y:auto;
      padding:4px 0;
    }
    .zoom-tag-option{
      display:flex;
      align-items:center;
      gap:4px;
      background:rgba(255,255,255,.05);
      border:2px solid rgba(255,255,255,.1);
      border-radius:6px;
      padding:6px 10px;
      cursor:pointer;
      transition:all .2s ease;
      font-size:.8rem;
      color:#fff;
    }
    .zoom-tag-option:hover{
      border-color:rgba(99,102,241,.4);
      background:rgba(99,102,241,.1);
    }
    .zoom-tag-option.selected{
      background:rgba(99,102,241,.3);
      border-color:rgba(99,102,241,.8);
    }
    .zoom-sidebar-actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:20px;
    }
    .zoom-sidebar-actions .zoom-overlay-btn{
      flex:1;
      min-width:100px;
      justify-content:center;
      padding:10px 16px;
      font-size:.85rem;
    }
    @media (max-width:900px){
      .zoom-overlay-layout{
        flex-direction:column;
        align-items:center;
      }
      .zoom-overlay-sidebar{
        width:100%;
        max-width:500px;
      }
    }
    
    .estruturacao-item-file-doc{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;font-size:1.3rem;color:rgba(255,255,255,.6)}
    .estruturacao-item-file-doc span{font-size:.5rem;margin-top:2px;color:rgba(255,255,255,.4);max-width:50px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .estruturacao-item-file-delete{position:absolute;top:2px;right:2px;background:rgba(0,0,0,.7);border:none;color:#ff6b6b;border-radius:50%;width:18px;height:18px;font-size:.6rem;cursor:pointer;opacity:0;transition:opacity .2s ease;display:flex;align-items:center;justify-content:center}
    .estruturacao-item-file:hover .estruturacao-item-file-delete{opacity:1}
    
    /* Drop zone */
    .estruturacao-item-dropzone{border:2px dashed rgba(255,255,255,.15);border-radius:8px;padding:12px;text-align:center;color:rgba(255,255,255,.4);font-size:.75rem;cursor:pointer;transition:all .2s ease;background:rgba(0,0,0,.2)}
    .estruturacao-item-dropzone:hover,.estruturacao-item-dropzone.dragover{border-color:var(--accent);background:rgba(255,102,0,.08);color:var(--accent)}
    .estruturacao-item-dropzone-icon{font-size:1.2rem;margin-bottom:4px}
    
    .estruturacao-notes-area{margin-top:8px}
    .estruturacao-notes-label{font-size:.85rem;font-weight:700;color:rgba(255,255,255,.7);margin-bottom:6px;display:flex;align-items:center;gap:6px}
    .estruturacao-notes-label::before{content:'üìù'}
    .estruturacao-textarea{width:100%;min-height:80px;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.12);border-radius:8px;padding:10px;color:#fff;font-size:.9rem;resize:vertical;font-family:inherit;transition:border-color .2s ease}
    .estruturacao-textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(255,102,0,.15)}
    .estruturacao-textarea::placeholder{color:rgba(255,255,255,.4)}
    
    .estruturacao-extras{margin-top:16px;display:flex;flex-direction:column;gap:16px;padding-top:16px;border-top:1px solid rgba(255,255,255,.08)}
    .estruturacao-extra-section{background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:14px;display:flex;flex-direction:column;gap:10px}
    .estruturacao-extra-header{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .estruturacao-extra-title{font-size:.9rem;font-weight:800;color:#fff;display:flex;align-items:center;gap:8px;margin:0}
    .estruturacao-extra-count{font-size:.75rem;background:rgba(255,255,255,.1);padding:2px 8px;border-radius:999px;color:rgba(255,255,255,.7)}
    .estruturacao-custom-checklist{display:flex;flex-direction:column;gap:8px}
    .estruturacao-custom-item{display:flex;align-items:flex-start;gap:10px;padding:8px;background:rgba(0,0,0,.3);border-radius:8px;border:1px solid rgba(255,255,255,.06)}
    .estruturacao-custom-item-checkbox{width:18px;height:18px;border:2px solid rgba(255,255,255,.3);border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s ease;background:rgba(0,0,0,.4);flex-shrink:0;margin-top:2px}
    .estruturacao-custom-item-checkbox:hover{border-color:rgba(255,255,255,.5)}
    .estruturacao-custom-item-checkbox.checked{border-color:#2e7d32;background:#2e7d32}
    .estruturacao-custom-item-checkbox.checked::after{content:'‚úì';color:#fff;font-size:11px;font-weight:900}
    .estruturacao-custom-item-input{flex:1;background:transparent;border:none;color:#fff;font-size:.85rem;outline:none}
    .estruturacao-custom-item-input::placeholder{color:rgba(255,255,255,.4)}
    .estruturacao-custom-item-delete{background:none;border:none;color:rgba(255,100,100,.7);cursor:pointer;font-size:1rem;padding:0 4px;opacity:.6;transition:opacity .2s ease}
    .estruturacao-custom-item-delete:hover{opacity:1}
    .estruturacao-custom-item.completed .estruturacao-custom-item-input{color:rgba(255,255,255,.5);text-decoration:line-through}
    .estruturacao-files-list{display:flex;flex-direction:column;gap:8px}
    .estruturacao-file-item{display:flex;align-items:center;gap:10px;padding:10px;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.08);border-radius:8px;transition:background .2s ease}
    .estruturacao-file-item:hover{background:rgba(255,255,255,.04)}
    .estruturacao-file-icon{font-size:1.3rem;flex-shrink:0}
    .estruturacao-file-info{flex:1;min-width:0}
    .estruturacao-file-name{font-size:.85rem;font-weight:700;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin:0 0 2px}
    .estruturacao-file-meta{font-size:.75rem;color:rgba(255,255,255,.5)}
    .estruturacao-file-actions{display:flex;gap:6px}
    .estruturacao-file-actions button{background:none;border:none;color:rgba(255,255,255,.6);cursor:pointer;font-size:1.1rem;padding:4px 8px;border-radius:6px;transition:all .2s ease}
    .estruturacao-file-actions button:hover{background:rgba(255,255,255,.1);color:#fff}
    .estruturacao-file-actions .delete-file:hover{color:#ff6b6b}
    .estruturacao-file-empty{text-align:center;padding:16px;color:rgba(255,255,255,.5);font-size:.85rem}
    .estruturacao-add-btn{background:rgba(255,102,0,.1);border:1px solid rgba(255,102,0,.3);color:var(--accent);border-radius:8px;padding:8px 12px;font-size:.85rem;font-weight:700;cursor:pointer;transition:all .2s ease;display:flex;align-items:center;justify-content:center;gap:6px}
    .estruturacao-add-btn:hover{background:rgba(255,102,0,.2);border-color:rgba(255,102,0,.5)}
    
    .estruturacao-arrow{text-align:center;padding:8px 0;font-size:1.5rem;color:rgba(255,255,255,.3)}
    @media (max-width:820px){
      .estruturacao-week-header{padding:12px 16px}
      .estruturacao-week-badge{width:40px;height:40px;font-size:1rem}
      .estruturacao-week-title{font-size:1rem}
      .estruturacao-week-progress{flex-direction:column;align-items:flex-start;gap:6px}
      .estruturacao-block-content{padding-left:16px}
      .estruturacao-title{font-size:1.4rem}
      .estruturacao-extras{gap:12px}
      .estruturacao-extra-section{padding:12px}
      .estruturacao-file-item{flex-wrap:wrap}
      .estruturacao-file-actions{width:100%;justify-content:flex-end}
      .estruturacao-disclaimers{gap:4px;margin-left:8px;margin-right:4px}
      .estruturacao-disclaimer-icon{width:24px;height:24px;font-size:.7rem}
      .estruturacao-disclaimer-tooltip{width:260px;left:auto;right:-20px;transform:none;padding:12px}
      .estruturacao-disclaimer-tooltip::before,.estruturacao-disclaimer-tooltip::after{left:auto;right:28px;transform:none}
    }
    @media (max-width:480px){
      .estruturacao-disclaimers{gap:3px}
      .estruturacao-disclaimer-icon{width:22px;height:22px;font-size:.65rem}
      .estruturacao-disclaimer-tooltip{width:240px;right:-10px;padding:10px}
      .estruturacao-disclaimer-tooltip-title{font-size:.8rem}
      .estruturacao-disclaimer-tooltip-content{font-size:.75rem}
    }

    /* ===== ENTREG√ÅVEIS MEDIAGROWTH (ESTILO DROPDOWN) ===== */
    .entregaveis-week{
      margin-top:20px;
      border-color:rgba(0,200,83,.3) !important;
    }
    .entregaveis-week .estruturacao-week-header{
      background:linear-gradient(135deg,rgba(0,200,83,.08),rgba(0,200,83,.02));
    }
    .entregaveis-week .estruturacao-week-header:hover{
      background:linear-gradient(135deg,rgba(0,200,83,.12),rgba(0,200,83,.04));
    }
    .entregaveis-intro{
      text-align:center;
      margin-bottom:24px;
      padding:16px;
      background:rgba(0,200,83,.06);
      border:1px solid rgba(0,200,83,.15);
      border-radius:12px;
    }
    .entregaveis-intro p{
      margin:0;
      font-size:.95rem;
      color:rgba(255,255,255,.85);
      line-height:1.6;
    }
    /* Galeria de Entreg√°veis */
    .entregaveis-gallery{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
      gap:16px;
      margin-bottom:32px;
    }
    .entregavel-card{
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.1);
      border-radius:14px;
      overflow:hidden;
      transition:all .3s ease;
      display:flex;
      flex-direction:column;
    }
    .entregavel-card:hover{
      border-color:rgba(0,200,83,.4);
      transform:translateY(-4px);
      box-shadow:0 12px 32px rgba(0,200,83,.15);
    }
    .entregavel-image{
      aspect-ratio:3/4;
      background:linear-gradient(135deg,rgba(0,200,83,.1),rgba(0,0,0,.3));
      display:flex;
      align-items:center;
      justify-content:center;
      border-bottom:1px solid rgba(255,255,255,.08);
      overflow:hidden;
      position:relative;
    }
    .entregavel-image img{
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .entregavel-image-placeholder{
      font-size:3rem;
      color:rgba(255,255,255,.15);
    }
    .entregavel-info{
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:6px;
      flex:1;
    }
    .entregavel-name{
      font-size:.9rem;
      font-weight:800;
      color:#fff;
      margin:0;
      line-height:1.3;
    }
    .entregavel-desc{
      font-size:.75rem;
      color:rgba(255,255,255,.6);
      margin:0;
      line-height:1.4;
      flex:1;
    }
    .entregavel-value{
      font-size:.7rem;
      color:rgba(0,200,83,.8);
      font-weight:700;
      margin-top:4px;
      padding-top:8px;
      border-top:1px dashed rgba(255,255,255,.1);
    }
    /* Se√ß√£o de Valor Total */
    .entregaveis-valor-section{
      background:linear-gradient(135deg,#00c853,#1b5e20);
      border-radius:16px;
      padding:32px;
      text-align:center;
      position:relative;
      overflow:hidden;
    }
    .entregaveis-valor-section::before{
      content:'';
      position:absolute;
      inset:0;
      background:url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M54.627 0l.83.828-1.415 1.415L51.8 0h2.827zM5.373 0l-.83.828L5.96 2.243 8.2 0H5.374zM48.97 0l3.657 3.657-1.414 1.414L46.143 0h2.828zM11.03 0L7.372 3.657 8.787 5.07 13.857 0H11.03zm32.284 0L49.8 6.485 48.384 7.9l-7.9-7.9h2.83zM16.686 0L10.2 6.485 11.616 7.9l7.9-7.9h-2.83zM22.344 0L13.858 8.485 15.272 9.9l9.9-9.9h-2.828zM32 0l-3.486 3.485-1.414-1.414L30.172 0H32zm-6.142 0L16.2 9.657l1.414 1.414L28.97 0h-3.112zm12.142 0L48.97 10.97l-1.414 1.415L35.172 0h2.828z' fill='%23ffffff' fill-opacity='.03' fill-rule='evenodd'/%3E%3C/svg%3E");
      pointer-events:none;
    }
    .entregaveis-valor-comparativo{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:24px;
      margin-bottom:24px;
    }
    .entregaveis-valor-item{
      display:flex;
      flex-direction:column;
      gap:4px;
      align-items:center;
    }
    .entregaveis-valor-label{
      font-size:.8rem;
      color:rgba(255,255,255,.7);
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.05em;
    }
    .entregaveis-valor-original{
      font-size:1.3rem;
      color:rgba(255,255,255,.5);
      text-decoration:line-through;
      font-weight:700;
    }
    .entregaveis-valor-divider{
      font-size:2rem;
      color:rgba(255,255,255,.3);
      align-self:center;
    }
    .entregaveis-valor-final{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
    }
    .entregaveis-valor-main{
      font-size:3rem;
      font-weight:900;
      color:#fff;
      text-shadow:0 4px 20px rgba(0,0,0,.4);
      line-height:1;
    }
    .entregaveis-valor-parcelado{
      font-size:1.1rem;
      color:rgba(255,255,255,.9);
      font-weight:700;
    }
    .entregaveis-valor-urgencia{
      display:inline-block;
      background:rgba(0,0,0,.25);
      padding:8px 20px;
      border-radius:30px;
      font-size:.9rem;
      font-weight:800;
      color:#fff;
      margin-top:12px;
      border:1px solid rgba(255,255,255,.2);
    }
    .entregaveis-country-toggle{
      display:flex;
      justify-content:center;
      gap:12px;
      margin-bottom:20px;
    }
    .entregaveis-country-btn{
      background:rgba(255,255,255,.1);
      border:2px solid rgba(255,255,255,.2);
      color:#fff;
      padding:10px 24px;
      border-radius:30px;
      font-size:.9rem;
      font-weight:700;
      cursor:pointer;
      transition:all .2s ease;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .entregaveis-country-btn:hover{
      background:rgba(255,255,255,.2);
      border-color:rgba(255,255,255,.4);
    }
    .entregaveis-country-btn.active{
      background:#fff;
      color:#1b5e20;
      border-color:#fff;
    }
    @media (max-width:820px){
      .entregaveis-gallery{
        grid-template-columns:repeat(2,1fr);
        gap:12px;
      }
      .entregaveis-valor-main{
        font-size:2.2rem;
      }
      .entregaveis-header,.entregaveis-content{
        padding:16px;
      }
      .entregaveis-valor-section{
        padding:24px 16px;
      }
    }
    @media (max-width:480px){
      .entregaveis-gallery{
        grid-template-columns:1fr 1fr;
        gap:10px;
      }
      .entregavel-info{
        padding:10px;
      }
      .entregavel-name{
        font-size:.8rem;
      }
      .entregaveis-valor-main{
        font-size:1.8rem;
      }
    }

    /* ===== BOT√ÉO GERAR DOC ENTREG√ÅVEIS ===== */
    .entregavel-gerar-doc-btn{
      background:linear-gradient(135deg,#6366f1,#8b5cf6);
      border:none;
      color:#fff;
      padding:10px 14px;
      border-radius:8px;
      font-size:.8rem;
      font-weight:700;
      cursor:pointer;
      transition:all .3s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      margin-top:8px;
      width:100%;
    }
    .entregavel-gerar-doc-btn:hover{
      background:linear-gradient(135deg,#4f46e5,#7c3aed);
      transform:translateY(-2px);
      box-shadow:0 6px 20px rgba(99,102,241,.4);
    }
    .entregavel-gerar-doc-btn:active{
      transform:translateY(0);
    }
    .entregavel-gerar-doc-btn.loading{
      pointer-events:none;
      opacity:.7;
    }
    .entregavel-gerar-doc-btn .spinner{
      width:14px;
      height:14px;
      border:2px solid rgba(255,255,255,.3);
      border-top-color:#fff;
      border-radius:50%;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Modal Preview Doc */
    .doc-preview-modal{
      position:fixed;
      inset:0;
      z-index:999999;
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      background:rgba(0,0,0,.85);
      backdrop-filter:blur(8px);
    }
    .doc-preview-modal.show{
      display:flex;
    }
    .doc-preview-container{
      background:var(--panel);
      border:1px solid var(--shell-border);
      border-radius:16px;
      width:100%;
      max-width:900px;
      max-height:90vh;
      display:flex;
      flex-direction:column;
      box-shadow:0 20px 60px rgba(0,0,0,.6);
      overflow:hidden;
    }
    .doc-preview-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:16px 20px;
      background:rgba(255,255,255,.04);
      border-bottom:1px solid var(--shell-border);
    }
    .doc-preview-title{
      font-size:1.1rem;
      font-weight:800;
      color:#fff;
      margin:0;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .doc-preview-title .icon{
      font-size:1.3rem;
    }
    .doc-preview-actions{
      display:flex;
      gap:10px;
    }
    .doc-preview-btn{
      background:rgba(255,255,255,.1);
      border:1px solid rgba(255,255,255,.2);
      color:#fff;
      padding:8px 16px;
      border-radius:8px;
      font-size:.85rem;
      font-weight:700;
      cursor:pointer;
      transition:all .2s ease;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .doc-preview-btn:hover{
      background:rgba(255,255,255,.2);
      border-color:rgba(255,255,255,.4);
    }
    .doc-preview-btn.primary{
      background:linear-gradient(135deg,#00c853,#1b5e20);
      border-color:transparent;
    }
    .doc-preview-btn.primary:hover{
      box-shadow:0 4px 16px rgba(0,200,83,.4);
    }
    .doc-preview-btn.close-btn{
      background:rgba(255,100,100,.15);
      border-color:rgba(255,100,100,.3);
      color:#ff6b6b;
    }
    .doc-preview-btn.close-btn:hover{
      background:rgba(255,100,100,.25);
    }
    .doc-preview-body{
      flex:1;
      overflow:auto;
      padding:24px;
    }
    .doc-preview-content{
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.1);
      border-radius:12px;
      padding:24px;
      color:rgba(255,255,255,.9);
      font-size:.95rem;
      line-height:1.7;
      min-height:300px;
    }
    .doc-preview-content h1{
      font-size:1.5rem;
      font-weight:800;
      color:#fff;
      margin:0 0 16px;
      padding-bottom:12px;
      border-bottom:2px solid var(--accent);
    }
    .doc-preview-content h2{
      font-size:1.25rem;
      font-weight:700;
      color:#fff;
      margin:24px 0 12px;
    }
    .doc-preview-content h3{
      font-size:1.1rem;
      font-weight:700;
      color:rgba(255,255,255,.95);
      margin:20px 0 10px;
    }
    .doc-preview-content p{
      margin:0 0 12px;
    }
    .doc-preview-content ul,.doc-preview-content ol{
      margin:0 0 16px;
      padding-left:24px;
    }
    .doc-preview-content li{
      margin-bottom:8px;
    }
    .doc-preview-content blockquote{
      margin:16px 0;
      padding:12px 16px;
      border-left:4px solid var(--accent);
      background:rgba(255,102,0,.08);
      border-radius:0 8px 8px 0;
    }
    .doc-preview-content strong{
      color:#fff;
      font-weight:700;
    }
    .doc-preview-content em{
      color:rgba(255,255,255,.8);
    }
    .doc-preview-content hr{
      border:none;
      border-top:1px solid rgba(255,255,255,.15);
      margin:24px 0;
    }
    .doc-preview-loading{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:16px;
      padding:60px;
      color:rgba(255,255,255,.7);
    }
    .doc-preview-loading .spinner-large{
      width:48px;
      height:48px;
      border:4px solid rgba(255,255,255,.1);
      border-top-color:var(--accent);
      border-radius:50%;
      animation:spin 1s linear infinite;
    }
    .doc-preview-source{
      margin-top:20px;
      padding-top:16px;
      border-top:1px solid rgba(255,255,255,.1);
    }
    .doc-preview-source-title{
      font-size:.85rem;
      font-weight:700;
      color:rgba(255,255,255,.6);
      margin-bottom:10px;
    }
    .doc-preview-source-list{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .doc-preview-source-item{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.1);
      padding:6px 12px;
      border-radius:6px;
      font-size:.75rem;
      color:rgba(255,255,255,.7);
    }
    @media (max-width:820px){
      .doc-preview-container{
        max-height:95vh;
      }
      .doc-preview-header{
        flex-wrap:wrap;
        gap:12px;
      }
      .doc-preview-title{
        width:100%;
      }
      .doc-preview-actions{
        width:100%;
        justify-content:flex-end;
      }
    }

    /* ===== BOT√ÉO AN√ÅLISE ENTREG√ÅVEIS ===== */
    .entregavel-analise-btn{
      background:linear-gradient(135deg,#3b82f6,#2563eb);
      border:none;
      color:#fff;
      padding:10px 14px;
      border-radius:8px;
      font-size:.8rem;
      font-weight:700;
      cursor:pointer;
      transition:all .3s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      margin-top:6px;
      width:100%;
    }
    .entregavel-analise-btn:hover{
      background:linear-gradient(135deg,#2563eb,#1d4ed8);
      transform:translateY(-2px);
      box-shadow:0 6px 20px rgba(59,130,246,.5);
    }
    .entregavel-analise-btn:active{
      transform:translateY(0);
    }
    .entregavel-analise-btn.loading{
      pointer-events:none;
      opacity:.7;
    }
    .entregavel-buttons-row{
      display:flex;
      gap:8px;
      margin-top:8px;
    }
    .entregavel-buttons-row .entregavel-gerar-doc-btn,
    .entregavel-buttons-row .entregavel-analise-btn{
      flex:1;
      margin-top:0;
      font-size:.75rem;
      padding:8px 10px;
    }

    /* Bot√£o Copiar Link Aprova√ß√£o */
    .entregavel-copiar-link-btn{
      background:linear-gradient(135deg,#6366f1,#8b5cf6);
      border:none;
      color:#fff;
      padding:8px 10px;
      border-radius:8px;
      font-size:.75rem;
      font-weight:700;
      cursor:pointer;
      transition:all .3s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      flex:1;
    }
    .entregavel-copiar-link-btn:hover{
      background:linear-gradient(135deg,#8b5cf6,#a855f7);
      transform:translateY(-2px);
      box-shadow:0 6px 20px rgba(99,102,241,.4);
    }
    .entregavel-copiar-link-btn:active{
      transform:translateY(0);
    }
    .entregavel-copiar-link-btn.loading{
      pointer-events:none;
      opacity:.7;
    }
    .entregavel-copiar-link-btn.copied{
      background:linear-gradient(135deg,#3b82f6,#2563eb);
    }

    /* Bot√£o Gerar An√°lise R√°pida - LARANJA */
    .entregavel-gerar-btn{
      background:linear-gradient(135deg,#f59e0b,#d97706);
      border:none;
      color:#fff;
      padding:8px 10px;
      border-radius:8px;
      font-size:.75rem;
      font-weight:700;
      cursor:pointer;
      transition:all .3s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      flex:1;
    }
    .entregavel-gerar-btn:hover{
      background:linear-gradient(135deg,#d97706,#b45309);
      transform:translateY(-2px);
      box-shadow:0 6px 20px rgba(245,158,11,.5);
    }
    .entregavel-gerar-btn:active{
      transform:translateY(0);
    }
    .entregavel-gerar-btn.generating{
      pointer-events:none;
      opacity:.7;
      animation: pulse 1.5s ease-in-out infinite;
    }
    .entregavel-gerar-btn.generated{
      background:linear-gradient(135deg,#10b981,#059669);
    }
    @keyframes pulse {
      0%, 100% { opacity: 0.7; }
      50% { opacity: 1; }
    }

    /* Popup de Sucesso ao Gerar An√°lise */
    .analise-success-popup {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #10b981, #059669);
      color: #fff;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(16, 185, 129, 0.4);
      font-weight: 700;
      font-size: 0.9rem;
      z-index: 100000;
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideInRight 0.4s ease-out, fadeOut 0.4s ease-in 2.6s forwards;
      pointer-events: none;
    }
    .analise-success-popup::before {
      content: '‚úÖ';
      font-size: 1.5rem;
    }
    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    @keyframes fadeOut {
      from {
        opacity: 1;
      }
      to {
        opacity: 0;
      }
    }

    /* Indicador de Aprovado do Cliente */
    .entregavel-card.cliente-aprovado{
      border:2px solid #22c55e !important;
      box-shadow:0 0 20px rgba(34,197,94,.3), inset 0 0 0 1px rgba(34,197,94,.2);
    }
    .entregavel-card.cliente-aprovado::before{
      content:'‚úÖ Aprovado pelo Cliente';
      position:absolute;
      top:-12px;
      left:50%;
      transform:translateX(-50%);
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#fff;
      font-size:.7rem;
      font-weight:800;
      padding:4px 12px;
      border-radius:999px;
      white-space:nowrap;
      z-index:10;
      box-shadow:0 4px 12px rgba(34,197,94,.3);
    }
    .entregavel-card{
      position:relative;
    }

    /* Bot√£o Relat√≥rio Completo */
    .relatorio-completo-section{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
      margin-bottom:24px;
      padding:20px;
      background:linear-gradient(135deg,rgba(34,197,94,.1),rgba(16,185,129,.05));
      border-radius:16px;
      border:1px solid rgba(34,197,94,.2);
    }
    .relatorio-completo-info{
      text-align:center;
    }
    .relatorio-completo-info h4{
      color:#22c55e;
      font-size:1rem;
      margin-bottom:4px;
    }
    .relatorio-completo-info p{
      color:#a0a0a0;
      font-size:.85rem;
    }
    .relatorio-completo-btns{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      justify-content:center;
    }
    .btn-relatorio-completo{
      display:flex;
      align-items:center;
      gap:8px;
      padding:12px 24px;
      border-radius:12px;
      font-size:.9rem;
      font-weight:700;
      border:none;
      cursor:pointer;
      transition:all .3s ease;
    }
    .btn-relatorio-visualizar{
      background:linear-gradient(135deg,#3b82f6,#1d4ed8);
      color:#fff;
    }
    .btn-relatorio-visualizar:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 20px rgba(59,130,246,.4);
    }
    .btn-relatorio-pdf{
      background:linear-gradient(135deg,#ef4444,#dc2626);
      color:#fff;
    }
    .btn-relatorio-pdf:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 20px rgba(239,68,68,.4);
    }
    .btn-relatorio-completo:disabled{
      opacity:.5;
      cursor:not-allowed;
      transform:none !important;
    }
    .btn-relatorio-completo .spinner{
      width:16px;
      height:16px;
      border:2px solid rgba(255,255,255,.3);
      border-top-color:#fff;
      border-radius:50%;
      animation:spin 1s linear infinite;
    }

    /* Modal Relat√≥rio Completo */
    .relatorio-modal{
      position:fixed;
      inset:0;
      z-index:999999;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.9);
      backdrop-filter:blur(8px);
    }
    .relatorio-modal.active{
      display:flex;
    }
    .relatorio-modal-content{
      width:95%;
      max-width:900px;
      max-height:90vh;
      background:linear-gradient(145deg,#1a1a2e,#16162a);
      border-radius:20px;
      border:1px solid rgba(255,255,255,.1);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .relatorio-modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:20px 24px;
      border-bottom:1px solid rgba(255,255,255,.1);
      background:linear-gradient(135deg,rgba(34,197,94,.1),transparent);
    }
    .relatorio-modal-header h3{
      color:#22c55e;
      font-size:1.2rem;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .relatorio-modal-actions{
      display:flex;
      gap:10px;
    }
    .relatorio-modal-close{
      background:rgba(255,255,255,.1);
      border:none;
      color:#fff;
      width:36px;
      height:36px;
      border-radius:50%;
      cursor:pointer;
      font-size:1.2rem;
      transition:all .2s;
    }
    .relatorio-modal-close:hover{
      background:rgba(239,68,68,.3);
    }
    .relatorio-modal-body{
      flex:1;
      overflow-y:auto;
      padding:28px 32px;
    }
    /* Espa√ßamento de texto no relat√≥rio */
    .relatorio-modal-body h2{
      font-size:1.1rem !important;
      font-weight:700 !important;
      color:#10b981 !important;
      margin:28px 0 14px !important;
      padding-bottom:8px !important;
      border-bottom:1px solid rgba(16,185,129,.3) !important;
    }
    .relatorio-modal-body h3{
      font-size:1rem !important;
      font-weight:700 !important;
      color:#fff !important;
      margin:24px 0 12px !important;
    }
    .relatorio-modal-body h4{
      font-size:.95rem !important;
      font-weight:600 !important;
      color:#a5b4fc !important;
      margin:20px 0 10px !important;
    }
    .relatorio-modal-body p{
      margin:12px 0 !important;
      line-height:1.9 !important;
    }
    .relatorio-modal-body ul,
    .relatorio-modal-body ol{
      margin:14px 0 !important;
      padding-left:28px !important;
    }
    .relatorio-modal-body li{
      margin-bottom:10px !important;
      line-height:1.8 !important;
      padding-left:4px !important;
    }
    .relatorio-modal-body strong{
      color:#10b981 !important;
    }
    /* Tabelas dentro do relat√≥rio modal */
    .relatorio-modal-body table{
      width:100% !important;
      border-collapse:collapse !important;
      margin:20px 0 !important;
      font-size:.85rem !important;
      background:rgba(15,23,42,.6) !important;
      border-radius:8px !important;
      overflow:hidden !important;
      border:1px solid rgba(255,255,255,.25) !important;
      display:table !important;
    }
    .relatorio-modal-body table th,
    .relatorio-modal-body table td{
      border:1px solid rgba(255,255,255,.25) !important;
      padding:12px 14px !important;
      text-align:left !important;
      display:table-cell !important;
    }
    .relatorio-modal-body table th{
      background:rgba(99,102,241,.35) !important;
      color:#fff !important;
      font-weight:700 !important;
      text-transform:uppercase !important;
      font-size:.75rem !important;
      letter-spacing:.03em !important;
    }
    .relatorio-modal-body table tr{
      display:table-row !important;
    }
    .relatorio-modal-body table tr:nth-child(even){
      background:rgba(255,255,255,.05) !important;
    }
    .relatorio-modal-body table tr:hover{
      background:rgba(99,102,241,.15) !important;
    }
    .relatorio-modal-body table td{
      color:rgba(255,255,255,.9) !important;
    }
    .relatorio-modal-body table thead,
    .relatorio-modal-body table tbody{
      display:table-row-group !important;
    }
    .relatorio-section{
      margin-bottom:40px;
      padding-bottom:32px;
      border-bottom:1px solid rgba(255,255,255,.1);
    }
    .relatorio-section:last-child{
      border-bottom:none;
      margin-bottom:0;
    }
    .relatorio-section-header{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:16px;
    }
    .relatorio-section-number{
      width:32px;
      height:32px;
      background:linear-gradient(135deg,#f97316,#ea580c);
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight:800;
      font-size:.9rem;
    }
    .relatorio-section-title{
      color:#fff;
      font-size:1.1rem;
      font-weight:700;
    }
    /* Relatorio content - ID√äNTICO ao analise-insight-content */
    .relatorio-section-content{
      background:rgba(15,23,42,.4);
      border-radius:8px;
      padding:20px;
      color:rgba(255,255,255,.9);
      font-size:.9rem;
      line-height:1.7;
    }
    .relatorio-section-content h3{
      font-size:.95rem;
      font-weight:700;
      color:#fff;
      margin:16px 0 8px;
    }
    .relatorio-section-content h3:first-child{
      margin-top:0;
    }
    .relatorio-section-content h1,
    .relatorio-section-content h2{
      font-size:1rem;
      font-weight:700;
      color:#fff;
      margin:16px 0 8px;
    }
    .relatorio-section-content h4{
      font-size:.9rem;
      font-weight:600;
      color:#fff;
      margin:12px 0 6px;
    }
    .relatorio-section-content p{
      margin:8px 0;
    }
    .relatorio-section-content ul,
    .relatorio-section-content ol{
      margin:8px 0;
      padding-left:20px;
    }
    .relatorio-section-content li{
      margin-bottom:6px;
    }
    .relatorio-section-content strong{
      color:#10b981;
    }
    /* Tabelas - EXATAMENTE igual ao original */
    .relatorio-section-content table{
      width:100%;
      border-collapse:collapse;
      margin:16px 0;
      font-size:.85rem;
      background:rgba(15,23,42,.4);
      border-radius:8px;
      overflow:hidden;
    }
    .relatorio-section-content table th,
    .relatorio-section-content table td{
      border:1px solid rgba(255,255,255,.15);
      padding:10px 12px;
      text-align:left;
    }
    .relatorio-section-content table th{
      background:rgba(99,102,241,.2);
      color:#fff;
      font-weight:700;
      text-transform:uppercase;
      font-size:.75rem;
      letter-spacing:.03em;
    }
    .relatorio-section-content table tr:nth-child(even){
      background:rgba(255,255,255,.03);
    }
    .relatorio-section-content table tr:hover{
      background:rgba(99,102,241,.1);
    }
    .relatorio-section-content table td{
      color:rgba(255,255,255,.85);
    }
    /* Imagens */
    .relatorio-section-content img{
      max-width:100%;
      height:auto;
      border-radius:8px;
      margin:8px 0;
    }
    .relatorio-section-content video{
      max-width:100%;
      border-radius:8px;
    }
    /* Grid de m√≠dias */
    .relatorio-section-content .midias-referencia-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(150px,1fr));
      gap:12px;
      margin:16px 0;
    }
    .relatorio-section-content .midias-referencia-grid img,
    .relatorio-section-content .midias-referencia-grid video{
      width:100%;
      height:150px;
      object-fit:cover;
      border-radius:8px;
    }
    .relatorio-empty{
      text-align:center;
      padding:40px;
      color:#666;
    }
    .relatorio-empty-icon{
      font-size:3rem;
      margin-bottom:12px;
    }
    .relatorio-stats{
      display:flex;
      gap:16px;
      justify-content:center;
      margin-bottom:20px;
      flex-wrap:wrap;
    }
    .relatorio-stat{
      background:rgba(255,255,255,.05);
      padding:12px 20px;
      border-radius:12px;
      text-align:center;
    }
    .relatorio-stat-value{
      font-size:1.5rem;
      font-weight:800;
      color:#22c55e;
    }
    .relatorio-stat-label{
      font-size:.75rem;
      color:#888;
    }
    /* === Capa do Relat√≥rio === */
    .relatorio-capa{
      text-align:center;
      padding:60px 40px;
      margin-bottom:40px;
      background:linear-gradient(135deg,rgba(34,197,94,.1),rgba(99,102,241,.1));
      border-radius:16px;
      border:1px solid rgba(255,255,255,.15);
    }
    .relatorio-capa-logo{
      margin-bottom:32px;
    }
    .relatorio-capa-logo img{
      height:60px;
      width:auto;
      margin-bottom:12px;
    }
    .relatorio-capa-brand{
      display:block;
      font-size:1.4rem;
      font-weight:700;
      color:#22c55e;
      letter-spacing:.1em;
    }
    .relatorio-capa-title{
      font-size:1.6rem;
      font-weight:800;
      color:#22c55e;
      margin-bottom:16px;
      text-shadow:0 2px 8px rgba(34,197,94,.3);
    }
    .relatorio-capa-client{
      font-size:1.3rem;
      color:#fff;
      font-weight:600;
      margin-bottom:8px;
    }
    .relatorio-capa-date{
      font-size:.9rem;
      color:rgba(255,255,255,.6);
      margin-bottom:32px;
    }
    .relatorio-capa-stats{
      display:flex;
      justify-content:center;
      gap:24px;
      flex-wrap:wrap;
      margin-top:24px;
    }
    .relatorio-capa-stat{
      background:rgba(255,255,255,.08);
      padding:16px 28px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.1);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
    }
    .relatorio-capa-stat .stat-value{
      font-size:1.8rem;
      font-weight:800;
      color:#22c55e;
    }
    .relatorio-capa-stat .stat-label{
      font-size:.75rem;
      color:#888;
      text-transform:uppercase;
      letter-spacing:.05em;
    }
    /* === Sum√°rio === */
    .relatorio-sumario{
      background:rgba(15,23,42,.6);
      border-radius:16px;
      padding:32px;
      margin-bottom:40px;
      border:1px solid rgba(255,255,255,.1);
    }
    .relatorio-sumario-title{
      font-size:1.2rem;
      font-weight:700;
      color:#22c55e;
      margin-bottom:20px;
      padding-bottom:12px;
      border-bottom:1px solid rgba(255,255,255,.1);
    }
    .relatorio-sumario-list{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .relatorio-sumario-item{
      display:flex;
      align-items:center;
      padding:12px 16px;
      background:rgba(255,255,255,.03);
      border-radius:10px;
      transition:all .2s;
      text-decoration:none;
      color:rgba(255,255,255,.9);
      gap:12px;
    }
    .relatorio-sumario-item:hover{
      background:rgba(99,102,241,.15);
      transform:translateX(6px);
    }
    .sumario-numero{
      width:28px;
      height:28px;
      background:linear-gradient(135deg,#f97316,#ea580c);
      border-radius:6px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight:700;
      font-size:.8rem;
      flex-shrink:0;
    }
    .sumario-titulo{
      flex:1;
      font-size:.9rem;
    }
    .sumario-dots{
      flex:1;
      border-bottom:2px dotted rgba(255,255,255,.15);
      margin:0 12px;
    }
    .sumario-pagina{
      color:rgba(255,255,255,.4);
      font-size:.8rem;
      flex-shrink:0;
    }
    /* === P√°gina do Relat√≥rio === */
    .relatorio-page{
      position:relative;
      page-break-before:always;
    }
    .relatorio-page:first-of-type{
      page-break-before:auto;
    }
    .relatorio-page-number{
      position:absolute;
      top:12px;
      right:16px;
      font-size:.75rem;
      color:rgba(255,255,255,.35);
      background:rgba(0,0,0,.2);
      padding:4px 10px;
      border-radius:6px;
      z-index:10;
    }
    /* === CAPA DO CAP√çTULO - IMAGEM TELA CHEIA === */
    .relatorio-chapter-cover{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      min-height:70vh;
      background:linear-gradient(135deg,rgba(15,23,42,.95),rgba(30,41,59,.9));
      border-radius:20px;
      padding:48px 32px;
      margin-bottom:24px;
      border:1px solid rgba(255,255,255,.1);
      text-align:center;
      position:relative;
      overflow:hidden;
    }
    .relatorio-chapter-cover::before{
      content:'';
      position:absolute;
      inset:0;
      background:linear-gradient(135deg,rgba(34,197,94,.08),rgba(99,102,241,.08));
      pointer-events:none;
    }
    .relatorio-chapter-image{
      max-width:90%;
      width:auto;
      max-height:55vh;
      object-fit:contain;
      border-radius:16px;
      box-shadow:0 20px 60px rgba(0,0,0,.5);
      margin-bottom:32px;
      position:relative;
      z-index:1;
    }
    .relatorio-chapter-info{
      position:relative;
      z-index:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
    }
    .relatorio-chapter-number{
      width:56px;
      height:56px;
      background:linear-gradient(135deg,#f97316,#ea580c);
      border-radius:14px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight:800;
      font-size:1.6rem;
      box-shadow:0 8px 24px rgba(249,115,22,.4);
    }
    .relatorio-chapter-title{
      font-size:1.5rem;
      font-weight:700;
      color:#fff;
      margin:8px 0;
      text-shadow:0 2px 8px rgba(0,0,0,.3);
    }
    .relatorio-chapter-date{
      font-size:.85rem;
      color:rgba(255,255,255,.5);
    }
    .relatorio-chapter-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:rgba(34,197,94,.25);
      color:#22c55e;
      padding:8px 16px;
      border-radius:24px;
      font-size:.85rem;
      font-weight:600;
      margin-top:8px;
    }
    /* === Cover antigo (fallback) === */
    .relatorio-section-cover{
      display:flex;
      gap:24px;
      align-items:center;
      background:linear-gradient(135deg,rgba(34,197,94,.08),rgba(99,102,241,.08));
      border-radius:16px;
      padding:24px;
      border:1px solid rgba(255,255,255,.1);
      margin-bottom:20px;
    }
    .relatorio-section-image{
      width:180px;
      height:auto;
      max-height:200px;
      object-fit:contain;
      border-radius:12px;
      box-shadow:0 8px 32px rgba(0,0,0,.4);
      flex-shrink:0;
    }
    .relatorio-section-cover-info{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .relatorio-section-number-big{
      width:48px;
      height:48px;
      background:linear-gradient(135deg,#f97316,#ea580c);
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight:800;
      font-size:1.4rem;
    }
    .relatorio-section-title-big{
      font-size:1.3rem;
      font-weight:700;
      color:#fff;
      margin:8px 0;
    }
    .relatorio-badge-aprovado{
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:rgba(34,197,94,.2);
      color:#22c55e;
      padding:6px 12px;
      border-radius:20px;
      font-size:.8rem;
      font-weight:600;
      width:fit-content;
    }
    .relatorio-section-date{
      font-size:.8rem;
      color:rgba(255,255,255,.5);
    }
    /* === Responsivo === */
    @media(max-width:600px){
      .relatorio-section-cover{
        flex-direction:column;
        text-align:center;
      }
      .relatorio-section-image{
        width:100%;
        max-width:200px;
      }
      .relatorio-section-cover-info{
        align-items:center;
      }
      .relatorio-capa-stats{
        flex-direction:column;
        align-items:center;
      }
    }

    /* Modal An√°lise Gr√°ficos */
    .analise-modal{
      position:fixed;
      inset:0;
      z-index:999999;
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      background:rgba(0,0,0,.9);
      backdrop-filter:blur(10px);
    }
    .analise-modal.show{
      display:flex;
    }
    .analise-container{
      background:var(--panel);
      border:1px solid var(--shell-border);
      border-radius:16px;
      width:100%;
      max-width:1100px;
      max-height:92vh;
      display:flex;
      flex-direction:column;
      box-shadow:0 24px 80px rgba(0,0,0,.7);
      overflow:hidden;
    }
    .analise-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:16px 20px;
      background:rgba(16,185,129,.1);
      border-bottom:1px solid var(--shell-border);
    }
    .analise-title{
      font-size:1.15rem;
      font-weight:800;
      color:#fff;
      margin:0;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .analise-title .icon{
      font-size:1.4rem;
    }
    .analise-close-btn{
      background:rgba(255,100,100,.15);
      border:1px solid rgba(255,100,100,.3);
      color:#ff6b6b;
      width:36px;
      height:36px;
      border-radius:8px;
      font-size:1.2rem;
      cursor:pointer;
      transition:all .2s ease;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .analise-close-btn:hover{
      background:rgba(255,100,100,.3);
      transform:scale(1.05);
    }
    /* Barra de a√ß√µes e status */
    .analise-actions{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 20px;
      background:rgba(255,255,255,.03);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .analise-regenerate-btn{
      display:flex;
      align-items:center;
      gap:8px;
      background:linear-gradient(135deg,#f59e0b,#d97706);
      border:none;
      color:#000;
      font-weight:700;
      font-size:.85rem;
      padding:10px 18px;
      border-radius:8px;
      cursor:pointer;
      transition:all .2s ease;
    }
    .analise-regenerate-btn:hover{
      transform:translateY(-2px);
      box-shadow:0 4px 15px rgba(245,158,11,.3);
    }
    .analise-regenerate-btn:disabled{
      opacity:.5;
      cursor:not-allowed;
      transform:none;
    }
    .analise-regenerate-btn.loading{
      pointer-events:none;
    }
    .analise-regenerate-btn.loading::after{
      content:'';
      width:14px;
      height:14px;
      border:2px solid rgba(0,0,0,.2);
      border-top-color:#000;
      border-radius:50%;
      animation:spin .8s linear infinite;
      margin-left:6px;
    }
    .analise-status{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:.8rem;
      color:rgba(255,255,255,.6);
    }
    .analise-status .status-badge{
      display:inline-flex;
      align-items:center;
      gap:5px;
      padding:4px 10px;
      border-radius:20px;
      font-weight:600;
      font-size:.75rem;
    }
    .analise-status .status-badge.saved{
      background:rgba(16,185,129,.15);
      color:#10b981;
      border:1px solid rgba(16,185,129,.3);
    }
    .analise-status .status-badge.new{
      background:rgba(59,130,246,.15);
      color:#60a5fa;
      border:1px solid rgba(59,130,246,.3);
    }
    .analise-status .status-date{
      color:rgba(255,255,255,.4);
      font-size:.75rem;
    }
    .analise-header-actions{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .analise-saved-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:rgba(16,185,129,.15);
      color:#10b981;
      font-size:.8rem;
      font-weight:600;
      padding:6px 12px;
      border-radius:20px;
      border:1px solid rgba(16,185,129,.3);
    }
    .analise-saved-badge .badge-icon{
      font-weight:700;
    }
    .analise-body{
      flex:1;
      overflow:auto;
      padding:20px;
      /* ‚ö†Ô∏è CR√çTICO: Garantir que nada saia do body */
      max-width: 100% !important;
      width: 100% !important;
      box-sizing: border-box !important;
      overflow-x: hidden !important; /* Prevenir scroll horizontal */
      overflow-y: auto !important; /* Permitir scroll vertical apenas */
    }
    .analise-loading{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:16px;
      padding:80px 40px;
      color:rgba(255,255,255,.7);
      text-align:center;
    }
    .analise-loading .spinner-large{
      width:56px;
      height:56px;
      border:4px solid rgba(255,255,255,.1);
      border-top-color:#10b981;
      border-radius:50%;
      animation:spin 1s linear infinite;
    }
    .analise-loading-text{
      font-size:.95rem;
      font-weight:600;
    }
    .analise-loading-sub{
      font-size:.8rem;
      color:rgba(255,255,255,.5);
    }
    .analise-grid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:20px;
      /* ‚ö†Ô∏è CR√çTICO: Garantir que o grid n√£o expanda al√©m do container */
      max-width: 100% !important;
      width: 100% !important;
      overflow: hidden !important;
      box-sizing: border-box !important;
    }
    .analise-chart-card{
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.1);
      border-radius:12px;
      padding:16px;
      display:flex;
      flex-direction:column;
      /* ‚ö†Ô∏è Garantir que cards n√£o expandam */
      max-width: 100% !important;
      overflow: hidden !important;
      box-sizing: border-box !important;
    }
    .analise-chart-title{
      font-size:.9rem;
      font-weight:700;
      color:#fff;
      margin:0 0 12px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .analise-chart-title .chart-icon{
      font-size:1rem;
    }
    .analise-chart-wrap{
      flex:1;
      min-height:220px;
      position:relative;
    }
    .analise-chart-description{
      margin:12px 0 0;
      padding:10px 12px;
      background:rgba(255,255,255,.03);
      border-left:3px solid rgba(16,185,129,.5);
      border-radius:0 6px 6px 0;
      font-size:.8rem;
      line-height:1.5;
      color:rgba(255,255,255,.7);
      font-style:italic;
    }
    .analise-insight-section{
      grid-column:1/-1;
      background:linear-gradient(135deg,rgba(16,185,129,.1),rgba(5,150,105,.05));
      border:1px solid rgba(16,185,129,.3);
      border-radius:12px;
      padding:20px;
      position:relative;
    }
    .analise-insight-title{
      font-size:1rem;
      font-weight:800;
      color:#10b981;
      margin:0 0 14px;
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .analise-insight-actions{
      margin-left:auto;
      display:flex;
      gap:8px;
      position:fixed;
      top:80px;
      right:40px;
      z-index:1000001;
      background:rgba(17,25,54,.95);
      padding:10px 14px;
      border-radius:12px;
      border:1px solid rgba(16,185,129,.4);
      box-shadow:0 8px 32px rgba(0,0,0,.5);
      backdrop-filter:blur(10px);
    }
    .analise-edit-btn, .analise-save-btn, .analise-cancel-btn{
      padding:8px 16px;
      border-radius:8px;
      font-size:.8rem;
      font-weight:700;
      cursor:pointer;
      transition:all .2s ease;
      border:1px solid;
      white-space:nowrap;
    }
    .analise-edit-btn{
      background:rgba(99,102,241,.25);
      border-color:rgba(99,102,241,.5);
      color:#a5b4fc;
    }
    .analise-edit-btn:hover{
      background:rgba(99,102,241,.4);
      transform:scale(1.02);
    }
    .analise-save-btn{
      background:rgba(16,185,129,.25);
      border-color:rgba(16,185,129,.5);
      color:#6ee7b7;
    }
    .analise-save-btn:hover{
      background:rgba(16,185,129,.4);
      transform:scale(1.02);
    }
    .analise-cancel-btn{
      background:rgba(239,68,68,.25);
      border-color:rgba(239,68,68,.5);
      color:#fca5a5;
    }
    .analise-cancel-btn:hover{
      background:rgba(239,68,68,.4);
      transform:scale(1.02);
    }
    .analise-pdf-btn{
      background:rgba(239,68,68,.2);
      border-color:rgba(239,68,68,.4);
      color:#f87171;
      padding:8px 16px;
      border-radius:8px;
      font-size:.8rem;
      font-weight:700;
      cursor:pointer;
      transition:all .2s ease;
      border:1px solid;
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .analise-pdf-btn:hover{
      background:rgba(239,68,68,.35);
      transform:scale(1.02);
      box-shadow:0 2px 8px rgba(239,68,68,.3);
    }
    .analise-pdf-btn:disabled{
      opacity:.5;
      cursor:not-allowed;
      transform:none;
    }
    .analise-insight-editor{
      width:100%;
      min-height:400px;
      background:rgba(0,0,0,.3);
      border:1px solid rgba(99,102,241,.4);
      border-radius:10px;
      padding:16px;
      color:#fff;
      font-size:.9rem;
      line-height:1.6;
      font-family:inherit;
      resize:vertical;
      outline:none;
    }
    .analise-insight-editor:focus{
      border-color:#6366f1;
      box-shadow:0 0 0 3px rgba(99,102,241,.2);
    }
    /* Modal de Instru√ß√µes para Regenerar */
    #regenerateInstructionsModal{
      position:fixed;
      top:0;left:0;right:0;bottom:0;
      background:rgba(0,0,0,.85);
      z-index:9999999 !important;
      display:flex;
      align-items:center;
      justify-content:center;
      animation:fadeIn .2s ease;
    }
    .regenerate-instructions-container{
      background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);
      border:1px solid rgba(99,102,241,.3);
      border-radius:16px;
      width:90%;
      max-width:550px;
      max-height:90vh;
      overflow:hidden;
      box-shadow:0 20px 60px rgba(0,0,0,.5);
      animation:slideUp .3s ease;
    }
    @keyframes slideUp{
      from{opacity:0;transform:translateY(30px);}
      to{opacity:1;transform:translateY(0);}
    }
    .regenerate-instructions-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:20px 24px;
      border-bottom:1px solid rgba(255,255,255,.1);
      background:rgba(99,102,241,.1);
    }
    .regenerate-instructions-header h3{
      margin:0;
      font-size:1.1rem;
      font-weight:700;
      color:#fff;
    }
    .regenerate-close-btn{
      background:transparent;
      border:none;
      color:rgba(255,255,255,.6);
      font-size:1.2rem;
      cursor:pointer;
      padding:4px 8px;
      border-radius:6px;
      transition:all .2s;
    }
    .regenerate-close-btn:hover{
      background:rgba(255,255,255,.1);
      color:#fff;
    }
    .regenerate-instructions-body{
      padding:24px;
    }
    .regenerate-description{
      color:rgba(255,255,255,.8);
      font-size:.9rem;
      margin:0 0 16px;
      line-height:1.5;
    }
    .regenerate-examples{
      background:rgba(99,102,241,.1);
      border-radius:10px;
      padding:14px 16px;
      margin-bottom:16px;
      border-left:3px solid #6366f1;
    }
    .regenerate-examples .example-label{
      font-size:.8rem;
      font-weight:600;
      color:#a5b4fc;
      display:block;
      margin-bottom:8px;
    }
    .regenerate-examples ul{
      margin:0;padding:0 0 0 16px;
      list-style:none;
    }
    .regenerate-examples li{
      font-size:.8rem;
      color:rgba(255,255,255,.7);
      margin:4px 0;
      position:relative;
    }
    .regenerate-examples li::before{
      content:"‚Ä¢";
      color:#6366f1;
      position:absolute;
      left:-12px;
    }
    .regenerate-instructions-textarea{
      width:100%;
      background:rgba(0,0,0,.3);
      border:1px solid rgba(99,102,241,.3);
      border-radius:10px;
      padding:14px;
      color:#fff;
      font-size:.9rem;
      line-height:1.5;
      resize:vertical;
      min-height:120px;
      font-family:inherit;
      transition:all .2s;
    }
    .regenerate-instructions-textarea:focus{
      outline:none;
      border-color:#6366f1;
      box-shadow:0 0 0 3px rgba(99,102,241,.2);
    }
    .regenerate-instructions-textarea::placeholder{
      color:rgba(255,255,255,.4);
    }
    .regenerate-instructions-footer{
      display:flex;
      gap:12px;
      justify-content:flex-end;
      padding:16px 24px;
      border-top:1px solid rgba(255,255,255,.1);
      background:rgba(0,0,0,.2);
    }
    .regenerate-cancel-btn{
      padding:10px 20px;
      border-radius:8px;
      font-size:.85rem;
      font-weight:600;
      cursor:pointer;
      transition:all .2s;
      background:transparent;
      border:1px solid rgba(255,255,255,.2);
      color:rgba(255,255,255,.7);
    }
    .regenerate-cancel-btn:hover{
      background:rgba(255,255,255,.1);
      color:#fff;
    }
    .regenerate-confirm-btn{
      padding:10px 24px;
      border-radius:8px;
      font-size:.85rem;
      font-weight:600;
      cursor:pointer;
      transition:all .2s;
      background:linear-gradient(135deg,#6366f1,#8b5cf6);
      border:none;
      color:#fff;
      box-shadow:0 4px 15px rgba(99,102,241,.3);
    }
    .regenerate-confirm-btn:hover{
      transform:translateY(-1px);
      box-shadow:0 6px 20px rgba(99,102,241,.4);
    }
    .regenerate-confirm-btn:disabled{
      opacity:.6;
      cursor:not-allowed;
      transform:none;
    }
    /* Modal de Landing Pages/Website - Coleta de Informa√ß√µes */
    #landingPagesInfoModal{
      position:fixed;
      top:0;left:0;right:0;bottom:0;
      background:rgba(0,0,0,.85);
      z-index:9999999 !important;
      display:flex;
      align-items:center;
      justify-content:center;
      animation:fadeIn .2s ease;
    }
    .landing-info-container{
      background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);
      border:1px solid rgba(99,102,241,.3);
      border-radius:16px;
      width:90%;
      max-width:600px;
      max-height:90vh;
      overflow-y:auto;
      box-shadow:0 20px 60px rgba(0,0,0,.5);
      animation:slideUp .3s ease;
    }
    .landing-info-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:20px 24px;
      border-bottom:1px solid rgba(255,255,255,.1);
      background:rgba(99,102,241,.1);
      position:sticky;top:0;z-index:10;
    }
    .landing-info-header h3{
      margin:0;
      font-size:1.1rem;
      font-weight:700;
      color:#fff;
    }
    .landing-info-close-btn{
      background:transparent;
      border:none;
      color:rgba(255,255,255,.6);
      font-size:1.2rem;
      cursor:pointer;
      padding:4px 8px;
      border-radius:6px;
      transition:all .2s;
    }
    .landing-info-close-btn:hover{
      background:rgba(255,255,255,.1);
      color:#fff;
    }
    .landing-info-body{
      padding:24px;
    }
    .landing-info-intro{
      color:rgba(255,255,255,.8);
      font-size:.9rem;
      margin:0 0 20px;
      line-height:1.5;
      padding:12px 16px;
      background:rgba(99,102,241,.1);
      border-radius:10px;
      border-left:3px solid #6366f1;
    }
    .landing-info-field{
      margin-bottom:20px;
    }
    .landing-info-field label{
      display:block;
      font-size:.85rem;
      font-weight:600;
      color:#a5b4fc;
      margin-bottom:8px;
    }
    .landing-info-field label .required{
      color:#f87171;
    }
    .landing-info-field input,
    .landing-info-field textarea,
    .landing-info-field select{
      width:100%;
      background:rgba(0,0,0,.3);
      border:1px solid rgba(99,102,241,.3);
      border-radius:10px;
      padding:12px 14px;
      color:#fff;
      font-size:.9rem;
      line-height:1.5;
      font-family:inherit;
      transition:all .2s;
    }
    .landing-info-field input:focus,
    .landing-info-field textarea:focus,
    .landing-info-field select:focus{
      outline:none;
      border-color:#6366f1;
      box-shadow:0 0 0 3px rgba(99,102,241,.2);
    }
    .landing-info-field input::placeholder,
    .landing-info-field textarea::placeholder{
      color:rgba(255,255,255,.4);
    }
    .landing-info-field textarea{
      resize:vertical;
      min-height:80px;
    }
    .landing-info-field select{
      cursor:pointer;
      appearance:none;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23a5b4fc' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat:no-repeat;
      background-position:right 14px center;
      padding-right:36px;
    }
    .landing-info-field select option{
      background:#1a1a2e;
      color:#fff;
    }
    .landing-info-hint{
      font-size:.75rem;
      color:rgba(255,255,255,.5);
      margin-top:6px;
    }
    .landing-info-footer{
      display:flex;
      gap:12px;
      justify-content:flex-end;
      padding:16px 24px;
      border-top:1px solid rgba(255,255,255,.1);
      background:rgba(0,0,0,.2);
      position:sticky;bottom:0;
    }
    .landing-info-cancel-btn{
      padding:10px 20px;
      border-radius:8px;
      font-size:.85rem;
      font-weight:600;
      cursor:pointer;
      transition:all .2s;
      background:transparent;
      border:1px solid rgba(255,255,255,.2);
      color:rgba(255,255,255,.7);
    }
    .landing-info-cancel-btn:hover{
      background:rgba(255,255,255,.1);
      color:#fff;
    }
    .landing-info-confirm-btn{
      padding:10px 24px;
      border-radius:8px;
      font-size:.85rem;
      font-weight:600;
      cursor:pointer;
      transition:all .2s;
      background:linear-gradient(135deg,#6366f1,#8b5cf6);
      border:none;
      color:#fff;
      box-shadow:0 4px 15px rgba(99,102,241,.3);
    }
    .landing-info-confirm-btn:hover{
      transform:translateY(-1px);
      box-shadow:0 6px 20px rgba(99,102,241,.4);
    }
    .landing-info-confirm-btn:disabled{
      opacity:.6;
      cursor:not-allowed;
      transform:none;
    }
    
    /* ========================================
       üìä MODAL DE M√âTRICAS DO PRIMEIRO M√äS
       ======================================== */
    .analise-modal-overlay{
      position:fixed;
      top:0;left:0;right:0;bottom:0;
      background:rgba(0,0,0,.9);
      z-index:99999999 !important;
      display:flex;
      align-items:center;
      justify-content:center;
      animation:fadeIn .2s ease;
    }
    .metricas-modal-container{
      background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);
      border:1px solid rgba(99,102,241,.3);
      border-radius:16px;
      width:90%;
      max-width:700px;
      max-height:90vh;
      overflow-y:auto;
      box-shadow:0 20px 60px rgba(0,0,0,.5);
      animation:slideUp .3s ease;
    }
    .metricas-modal-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:20px 24px;
      border-bottom:1px solid rgba(255,255,255,.1);
      background:rgba(99,102,241,.15);
      position:sticky;top:0;z-index:10;
    }
    .metricas-modal-header h3{
      margin:0;
      font-size:1.15rem;
      font-weight:700;
      color:#fff;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .metricas-close-btn{
      background:transparent;
      border:none;
      color:rgba(255,255,255,.6);
      font-size:1.3rem;
      cursor:pointer;
      padding:4px 8px;
      border-radius:6px;
      transition:all .2s;
    }
    .metricas-close-btn:hover{
      background:rgba(255,255,255,.1);
      color:#fff;
    }
    .metricas-modal-body{
      padding:24px;
    }
    .metricas-section{
      margin-bottom:24px;
      padding:16px;
      background:rgba(99,102,241,.08);
      border-radius:10px;
      border-left:3px solid #6366f1;
    }
    .metricas-section-title{
      font-size:.95rem;
      font-weight:600;
      color:#a5b4fc;
      margin:0 0 12px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .metricas-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      font-size:.85rem;
    }
    .metricas-item{
      display:flex;
      justify-content:space-between;
      color:rgba(255,255,255,.7);
    }
    .metricas-item strong{
      color:#fff;
      font-weight:600;
    }
    .metricas-sugestoes{
      background:rgba(34,197,94,.1);
      border-left-color:#22c55e;
    }
    .metricas-sugestoes-grid{
      display:grid;
      gap:10px;
    }
    .metricas-sug-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:8px 12px;
      background:rgba(0,0,0,.2);
      border-radius:8px;
      font-size:.85rem;
    }
    .metricas-sug-label{
      color:rgba(255,255,255,.7);
    }
    .metricas-sug-value{
      color:#22c55e;
      font-weight:700;
      font-size:.95rem;
    }
    .metricas-manual{
      background:rgba(251,191,36,.1);
      border-left-color:#fbbf24;
    }
    .metricas-input-grid{
      display:grid;
      gap:14px;
    }
    .metricas-input-field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .metricas-input-field label{
      font-size:.8rem;
      font-weight:600;
      color:#fbbf24;
    }
    .metricas-input-field input{
      background:rgba(0,0,0,.3);
      border:1px solid rgba(251,191,36,.3);
      border-radius:8px;
      padding:10px 12px;
      color:#fff;
      font-size:.9rem;
      transition:all .2s;
    }
    .metricas-input-field input:focus{
      outline:none;
      border-color:#fbbf24;
      box-shadow:0 0 0 3px rgba(251,191,36,.2);
    }
    .metricas-input-field input::placeholder{
      color:rgba(255,255,255,.3);
    }
    .metricas-modal-footer{
      display:flex;
      gap:12px;
      justify-content:space-between;
      padding:16px 24px;
      border-top:1px solid rgba(255,255,255,.1);
      background:rgba(0,0,0,.2);
      position:sticky;bottom:0;
    }
    .metricas-usar-sugestoes-btn{
      padding:10px 20px;
      border-radius:8px;
      font-size:.85rem;
      font-weight:600;
      cursor:pointer;
      transition:all .2s;
      background:linear-gradient(135deg,#22c55e,#16a34a);
      border:none;
      color:#fff;
      box-shadow:0 4px 15px rgba(34,197,94,.3);
    }
    .metricas-usar-sugestoes-btn:hover{
      transform:translateY(-1px);
      box-shadow:0 6px 20px rgba(34,197,94,.4);
    }
    .metricas-actions{
      display:flex;
      gap:12px;
    }
    .metricas-cancel-btn{
      padding:10px 20px;
      border-radius:8px;
      font-size:.85rem;
      font-weight:600;
      cursor:pointer;
      transition:all .2s;
      background:transparent;
      border:1px solid rgba(255,255,255,.2);
      color:rgba(255,255,255,.7);
    }
    .metricas-cancel-btn:hover{
      background:rgba(255,255,255,.1);
      color:#fff;
    }
    .metricas-confirm-btn{
      padding:10px 24px;
      border-radius:8px;
      font-size:.85rem;
      font-weight:600;
      cursor:pointer;
      transition:all .2s;
      background:linear-gradient(135deg,#6366f1,#8b5cf6);
      border:none;
      color:#fff;
      box-shadow:0 4px 15px rgba(99,102,241,.3);
    }
    .metricas-confirm-btn:hover{
      transform:translateY(-1px);
      box-shadow:0 6px 20px rgba(99,102,241,.4);
    }
    .metricas-confirm-btn:disabled{
      opacity:.6;
      cursor:not-allowed;
      transform:none;
    }
    
    .analise-insight-content{
      color:rgba(255,255,255,.9);
      font-size:.9rem;
      line-height:1.9;
      transition: all 0.2s ease;
      /* ‚ö†Ô∏è CR√çTICO: Garantir que texto NUNCA saia do container */
      max-width: 100% !important;
      width: 100% !important;
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
      word-break: break-word !important;
      hyphens: auto !important;
      overflow: hidden !important;
    }
    .analise-insight-content[contenteditable="true"]{
      cursor:text;
      outline:2px solid #6366f1 !important;
      border-radius:10px;
      padding:16px;
      background:rgba(99,102,241,0.1) !important;
    }
    .analise-insight-content[contenteditable="true"]:focus{
      box-shadow:0 0 0 4px rgba(99,102,241,0.2);
    }
    .analise-insight-content h3{
      font-size:1rem;
      font-weight:700;
      color:#fff;
      margin:24px 0 12px;
      /* ‚ö†Ô∏è Garantir que t√≠tulos n√£o saiam */
      max-width: 100% !important;
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
    }
    .analise-insight-content h3:first-child{
      margin-top:0;
    }
    .analise-insight-content h2{
      font-size:1.1rem;
      font-weight:700;
      color:#10b981;
      margin:28px 0 14px;
      padding-bottom:8px;
      border-bottom:1px solid rgba(16,185,129,.3);
      /* ‚ö†Ô∏è Garantir que t√≠tulos n√£o saiam */
      max-width: 100% !important;
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
    }
    .analise-insight-content h2:first-child{
      margin-top:0;
    }
    .analise-insight-content h4{
      font-size:.95rem;
      font-weight:600;
      color:#a5b4fc;
      margin:20px 0 10px;
      /* ‚ö†Ô∏è Garantir que t√≠tulos n√£o saiam */
      max-width: 100% !important;
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
    }
    .analise-insight-content p{
      margin:12px 0;
      /* ‚ö†Ô∏è Garantir que par√°grafos n√£o saiam */
      max-width: 100% !important;
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
      white-space: normal !important;
    }
    .analise-insight-content ul{
      margin:14px 0;
      padding-left:24px;
      /* ‚ö†Ô∏è Garantir que listas n√£o saiam */
      max-width: 100% !important;
    }
    .analise-insight-content ol{
      margin:14px 0;
      padding-left:24px;
      /* ‚ö†Ô∏è Garantir que listas n√£o saiam */
      max-width: 100% !important;
    }
    .analise-insight-content li{
      margin-bottom:10px;
      padding-left:4px;
      /* ‚ö†Ô∏è Garantir que itens de lista n√£o saiam */
      max-width: 100% !important;
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
    }
    /* ‚ö†Ô∏è REGRA GLOBAL: Aplicar a TODOS os elementos filhos */
    .analise-insight-content *{
      max-width: 100% !important;
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
      box-sizing: border-box !important;
    }
    /* ‚ö†Ô∏è CR√çTICO: NEGRITO E IT√ÅLICO (depois da regra global para ter prioridade) */
    .analise-insight-content strong{
      color:#10b981 !important;
      font-weight: 700 !important;
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
    }
    .analise-insight-content b{
      color:#10b981 !important;
      font-weight: 700 !important;
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
    }
    .analise-insight-content em,
    .analise-insight-content i{
      font-style: italic !important;
      color: rgba(255,255,255,0.95) !important;
    }
    /* ‚ö†Ô∏è CR√çTICO: Blockquotes (cita√ß√µes) */
    .analise-insight-content blockquote{
      border-left: 4px solid #10b981 !important;
      padding-left: 16px !important;
      margin: 16px 0 !important;
      color: rgba(255,255,255,0.8) !important;
      font-style: italic !important;
      background: rgba(16,185,129,0.1) !important;
      padding: 12px 16px !important;
      border-radius: 4px !important;
    }
    /* ‚ö†Ô∏è CR√çTICO: Code inline */
    .analise-insight-content code{
      background: rgba(99,102,241,0.2) !important;
      color: #a5b4fc !important;
      padding: 2px 6px !important;
      border-radius: 4px !important;
      font-family: 'Monaco', 'Courier New', monospace !important;
      font-size: 0.9em !important;
    }
    /* ‚ö†Ô∏è CR√çTICO: Pre + Code (blocos de c√≥digo) */
    .analise-insight-content pre{
      background: rgba(15,23,42,0.8) !important;
      border: 1px solid rgba(255,255,255,0.1) !important;
      border-radius: 8px !important;
      padding: 16px !important;
      overflow-x: auto !important;
      margin: 16px 0 !important;
    }
    .analise-insight-content pre code{
      background: transparent !important;
      padding: 0 !important;
      color: rgba(255,255,255,0.9) !important;
    }
    /* ‚ö†Ô∏è CR√çTICO: Links */
    .analise-insight-content a{
      color: #6366f1 !important;
      text-decoration: underline !important;
      transition: color 0.2s !important;
    }
    .analise-insight-content a:hover{
      color: #818cf8 !important;
    }
    /* ‚ö†Ô∏è CR√çTICO: HR (linha horizontal) */
    .analise-insight-content hr{
      border: none !important;
      border-top: 2px solid rgba(255,255,255,0.1) !important;
      margin: 24px 0 !important;
    }
    /* ‚ö†Ô∏è CR√çTICO: Divs dentro do content */
    .analise-insight-content div{
      max-width: 100% !important;
      overflow: hidden !important;
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
    }
    /* ‚ö†Ô∏è CR√çTICO: Spans e elementos inline */
    .analise-insight-content span,
    .analise-insight-content a,
    .analise-insight-content code{
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
      max-width: 100% !important;
      display: inline !important;
    }
    /* Estilos para tabelas nos relat√≥rios - bordas verticais */
    /* üìä CONTAINER COM SCROLL HORIZONTAL PARA TABELAS GRANDES */
    .analise-insight-content table{
      display: block !important;
      width: 100% !important;
      max-width: 100% !important;
      overflow-x: auto !important;
      overflow-y: visible !important;
      -webkit-overflow-scrolling: touch !important; /* Scroll suave no iOS */
      margin: 20px 0 !important;
      border-collapse: collapse !important;
      font-size: .85rem !important;
      background: rgba(15,23,42,.6) !important;
      border-radius: 8px !important;
      border: 1px solid rgba(255,255,255,.2) !important;
      /* Espa√ßamento do scrollbar */
      scrollbar-width: thin !important;
      scrollbar-color: rgba(99,102,241,.5) rgba(15,23,42,.3) !important;
    }
    
    /* Estiliza√ß√£o do scrollbar para Webkit (Chrome, Safari, Edge) */
    .analise-insight-content table::-webkit-scrollbar{
      height: 8px !important;
    }
    .analise-insight-content table::-webkit-scrollbar-track{
      background: rgba(15,23,42,.3) !important;
      border-radius: 4px !important;
    }
    .analise-insight-content table::-webkit-scrollbar-thumb{
      background: rgba(99,102,241,.5) !important;
      border-radius: 4px !important;
    }
    .analise-insight-content table::-webkit-scrollbar-thumb:hover{
      background: rgba(99,102,241,.7) !important;
    }
    
    /* Tbody, thead, tfoot voltam ao display normal */
    .analise-insight-content table thead,
    .analise-insight-content table tbody,
    .analise-insight-content table tfoot{
      display: table-row-group !important;
    }
    
    /* Tr e c√©lulas voltam ao display normal */
    .analise-insight-content table tr{
      display: table-row !important;
    }
    
    .analise-insight-content table th,
    .analise-insight-content table td{
      display: table-cell !important;
      border: 1px solid rgba(255,255,255,.2) !important;
      padding: 12px 14px !important;
      text-align: left !important;
      white-space: nowrap !important; /* Evita quebra de linha nas c√©lulas */
      min-width: 120px !important; /* Largura m√≠nima para cada c√©lula */
      vertical-align: middle !important;
    }
    
    .analise-insight-content table th{
      background: rgba(99,102,241,.3) !important;
      color: #fff !important;
      font-weight: 700 !important;
      text-transform: uppercase !important;
      font-size: .75rem !important;
      letter-spacing: .03em !important;
      position: sticky !important; /* Mant√©m cabe√ßalho fixo no scroll */
      top: 0 !important;
      z-index: 10 !important;
    }
    
    .analise-insight-content table tr:nth-child(even){
      background: rgba(255,255,255,.05) !important;
    }
    
    .analise-insight-content table tr:hover{
      background: rgba(99,102,241,.1) !important;
    }
    
    .analise-insight-content table td{
      color: rgba(255,255,255,.85) !important;
    }
    
    /* Indicador visual de que h√° mais conte√∫do para rolar */
    .analise-insight-content table::after{
      content: 'üëâ Role para a direita' !important;
      position: absolute !important;
      right: 20px !important;
      top: 50% !important;
      transform: translateY(-50%) !important;
      background: rgba(99,102,241,.8) !important;
      color: #fff !important;
      padding: 8px 12px !important;
      border-radius: 6px !important;
      font-size: .75rem !important;
      font-weight: 600 !important;
      pointer-events: none !important;
      opacity: 0 !important;
      transition: opacity 0.3s !important;
      z-index: 5 !important;
    }
    
    /* Mostrar indicador apenas quando h√° overflow */
    .analise-insight-content table[scrollWidth]:not([scrollWidth="0"])::after{
      opacity: 1 !important;
      animation: pulseHint 2s infinite !important;
    }
    
    @keyframes pulseHint{
      0%, 100%{ opacity: 0.7; }
      50%{ opacity: 1; }
    }
    /* ============================================ */
    /* BLOCOS REGENER√ÅVEIS DA AN√ÅLISE - MINIMALISTA */
    /* ============================================ */
    .analise-bloco-wrapper{
      position:relative;
      margin:0;
      padding:0;
      padding-right:100px;
    }
    .analise-bloco-wrapper:hover .analise-bloco-btns{
      opacity:1;
    }
    .analise-bloco-btns{
      position:absolute;
      top:2px;
      right:0;
      display:inline-flex;
      align-items:center;
      gap:4px;
      opacity:0;
      transition:all .2s ease;
      z-index:10;
    }
    .analise-bloco-regen-btn,
    .analise-bloco-delete-btn{
      background:rgba(99,102,241,.15);
      border:1px solid rgba(99,102,241,.25);
      color:rgba(255,255,255,.5);
      font-size:.65rem;
      padding:3px 8px;
      border-radius:4px;
      cursor:pointer;
      transition:all .2s ease;
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-weight:600;
    }
    .analise-bloco-regen-btn:hover{
      background:rgba(99,102,241,.35);
      border-color:rgba(99,102,241,.5);
      color:#fff;
      transform:scale(1.02);
    }
    .analise-bloco-delete-btn{
      background:rgba(239,68,68,.1);
      border-color:rgba(239,68,68,.2);
    }
    .analise-bloco-delete-btn:hover{
      background:rgba(239,68,68,.35);
      border-color:rgba(239,68,68,.5);
      color:#fff;
      transform:scale(1.02);
    }
    .analise-bloco-regen-btn.loading{
      pointer-events:none;
      background:rgba(245,158,11,.2);
      border-color:rgba(245,158,11,.4);
      color:#fbbf24;
    }
    .analise-bloco-content{
      transition:opacity .2s ease;
    }
    .analise-bloco-content.loading{
      opacity:.5;
    }
    /* Modal de Regenerar Bloco */
    .bloco-regen-modal-overlay{
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(0,0,0,.7);
      backdrop-filter:blur(4px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999999999 !important;
    }
    .bloco-regen-container{
      background:linear-gradient(135deg,#1e293b,#0f172a);
      border:1px solid rgba(99,102,241,.3);
      border-radius:16px;
      width:90%;
      max-width:500px;
      box-shadow:0 20px 60px rgba(0,0,0,.5);
      overflow:hidden;
    }
    .bloco-regen-header{
      padding:16px 20px;
      background:rgba(99,102,241,.1);
      border-bottom:1px solid rgba(99,102,241,.2);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .bloco-regen-header h3{
      font-size:1rem;
      color:#fff;
      margin:0;
    }
    .bloco-regen-close-btn{
      background:none;
      border:none;
      color:rgba(255,255,255,.6);
      font-size:1.2rem;
      cursor:pointer;
      padding:4px 8px;
      border-radius:4px;
    }
    .bloco-regen-close-btn:hover{
      background:rgba(255,255,255,.1);
      color:#fff;
    }
    .bloco-regen-body{
      padding:20px;
    }
    .bloco-regen-section-title{
      font-size:.85rem;
      color:rgba(255,255,255,.7);
      margin-bottom:8px;
      font-weight:600;
    }
    .bloco-regen-section-preview{
      background:rgba(0,0,0,.3);
      border:1px solid rgba(255,255,255,.1);
      border-radius:8px;
      padding:12px;
      font-size:.8rem;
      color:rgba(255,255,255,.6);
      max-height:80px;
      overflow-y:auto;
      margin-bottom:16px;
    }
    .bloco-regen-textarea{
      width:100%;
      min-height:100px;
      background:rgba(0,0,0,.3);
      border:1px solid rgba(99,102,241,.3);
      border-radius:8px;
      padding:12px;
      color:#fff;
      font-size:.85rem;
      resize:vertical;
      font-family:inherit;
    }
    .bloco-regen-textarea:focus{
      outline:none;
      border-color:rgba(99,102,241,.6);
      box-shadow:0 0 0 3px rgba(99,102,241,.15);
    }
    .bloco-regen-textarea::placeholder{
      color:rgba(255,255,255,.4);
    }
    .bloco-regen-footer{
      padding:16px 20px;
      background:rgba(0,0,0,.2);
      display:flex;
      gap:12px;
      justify-content:flex-end;
    }
    .bloco-regen-cancel-btn{
      background:rgba(255,255,255,.1);
      border:1px solid rgba(255,255,255,.2);
      color:rgba(255,255,255,.8);
      padding:10px 20px;
      border-radius:8px;
      font-size:.85rem;
      cursor:pointer;
      transition:all .2s ease;
    }
    .bloco-regen-cancel-btn:hover{
      background:rgba(255,255,255,.15);
    }
    .bloco-regen-confirm-btn{
      background:linear-gradient(135deg,#6366f1,#8b5cf6);
      border:none;
      color:#fff;
      padding:10px 24px;
      border-radius:8px;
      font-size:.85rem;
      font-weight:700;
      cursor:pointer;
      transition:all .2s ease;
    }
    .bloco-regen-confirm-btn:hover{
      transform:translateY(-1px);
      box-shadow:0 4px 15px rgba(99,102,241,.4);
    }
    .bloco-regen-confirm-btn:disabled{
      opacity:.6;
      cursor:not-allowed;
      transform:none;
    }
    /* Op√ß√µes de tamanho do texto */
    .bloco-regen-size-options{
      display:flex;
      gap:8px;
      margin-top:8px;
      margin-bottom:8px;
    }
    .bloco-regen-size-option{
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      padding:12px 8px;
      background:rgba(0,0,0,.3);
      border:2px solid rgba(255,255,255,.1);
      border-radius:10px;
      cursor:pointer;
      transition:all .2s ease;
    }
    .bloco-regen-size-option:hover{
      border-color:rgba(99,102,241,.4);
      background:rgba(99,102,241,.1);
    }
    .bloco-regen-size-option.selected,
    .bloco-regen-size-option:has(input:checked){
      border-color:rgba(99,102,241,.8);
      background:rgba(99,102,241,.2);
    }
    .bloco-regen-size-option input[type="radio"]{
      display:none;
    }
    .bloco-regen-size-label{
      font-size:.85rem;
      font-weight:700;
      color:#fff;
    }
    .bloco-regen-size-desc{
      font-size:.65rem;
      color:rgba(255,255,255,.5);
      text-align:center;
    }
    /* Op√ß√µes de modo (Refazer/Adicionar) */
    .bloco-regen-mode-options{
      display:flex;
      gap:10px;
      margin-top:8px;
      margin-bottom:16px;
    }
    .bloco-regen-mode-option{
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      padding:14px 10px;
      background:rgba(0,0,0,.3);
      border:2px solid rgba(255,255,255,.1);
      border-radius:12px;
      cursor:pointer;
      transition:all .2s ease;
    }
    .bloco-regen-mode-option:hover{
      border-color:rgba(16,185,129,.4);
      background:rgba(16,185,129,.1);
    }
    .bloco-regen-mode-option.selected,
    .bloco-regen-mode-option:has(input:checked){
      border-color:rgba(16,185,129,.8);
      background:rgba(16,185,129,.2);
    }
    .bloco-regen-mode-option input[type="radio"]{
      display:none;
    }
    .bloco-regen-mode-icon{
      font-size:1.4rem;
    }
    .bloco-regen-mode-label{
      font-size:.9rem;
      font-weight:700;
      color:#fff;
    }
    .bloco-regen-mode-desc{
      font-size:.65rem;
      color:rgba(255,255,255,.5);
      text-align:center;
    }
    /* Op√ß√µes de formato (Auto/Texto/Planilha) */
    .bloco-regen-format-options{
      display:flex;
      gap:10px;
      margin-top:8px;
      margin-bottom:16px;
    }
    .bloco-regen-format-option{
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      padding:12px 8px;
      background:rgba(0,0,0,.3);
      border:2px solid rgba(255,255,255,.1);
      border-radius:12px;
      cursor:pointer;
      transition:all .2s ease;
    }
    .bloco-regen-format-option:hover{
      border-color:rgba(245,158,11,.4);
      background:rgba(245,158,11,.1);
    }
    .bloco-regen-format-option.selected,
    .bloco-regen-format-option:has(input:checked){
      border-color:rgba(245,158,11,.8);
      background:rgba(245,158,11,.2);
    }
    .bloco-regen-format-option input[type="radio"]{
      display:none;
    }
    .bloco-regen-format-icon{
      font-size:1.2rem;
    }
    .bloco-regen-format-label{
      font-size:.85rem;
      font-weight:700;
      color:#fff;
    }
    .bloco-regen-format-desc{
      font-size:.6rem;
      color:rgba(255,255,255,.5);
      text-align:center;
    }
    /* Ocultar bot√µes de regenerar no PDF/impress√£o */
    @media print{
      .analise-bloco-regen-btn,
      .analise-bloco-delete-btn,
      .analise-bloco-btns{
        display:none !important;
      }
    }
    /* Galeria de M√≠dias de Refer√™ncia */
    .analise-insight-content .midias-referencia-grid img,
    .analise-insight-content .midias-referencia-grid video{
      cursor:pointer;
      transition:transform .2s ease, box-shadow .2s ease;
    }
    .analise-insight-content .midias-referencia-grid img:hover,
    .analise-insight-content .midias-referencia-grid video:hover{
      transform:scale(1.05);
      box-shadow:0 8px 25px rgba(99,102,241,.4);
    }
    .analise-metrics-row{
      grid-column:1/-1;
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:12px;
    }
    .analise-metric-card{
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.1);
      border-radius:10px;
      padding:16px;
      text-align:center;
    }
    .analise-metric-value{
      font-size:1.6rem;
      font-weight:800;
      color:#fff;
      margin-bottom:4px;
    }
    .analise-metric-value.positive{color:#10b981}
    .analise-metric-value.negative{color:#ef4444}
    .analise-metric-value.neutral{color:#f59e0b}
    .analise-metric-label{
      font-size:.75rem;
      color:rgba(255,255,255,.6);
      font-weight:600;
      text-transform:uppercase;
    }
    /* Container din√¢mico de gr√°ficos */
    .analise-charts-dynamic{
      grid-column:1/-1;
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:20px;
    }
    .analise-charts-dynamic .analise-chart-card{
      min-height:280px;
    }
    .analise-charts-dynamic .chart-primary{
      border-color:rgba(16,185,129,.3);
      background:linear-gradient(135deg,rgba(16,185,129,.08),rgba(16,185,129,.02));
    }
    .analise-charts-dynamic .chart-secondary{
      border-color:rgba(99,102,241,.3);
      background:linear-gradient(135deg,rgba(99,102,241,.08),rgba(99,102,241,.02));
    }
    .analise-charts-dynamic .chart-tertiary{
      border-color:rgba(245,158,11,.3);
      background:linear-gradient(135deg,rgba(245,158,11,.08),rgba(245,158,11,.02));
    }
    .analise-charts-dynamic .chart-radar{
      border-color:rgba(139,92,246,.3);
      background:linear-gradient(135deg,rgba(139,92,246,.08),rgba(139,92,246,.02));
    }
    
    /* ===== NOVOS GR√ÅFICOS DIAGN√ìSTICO ESTRAT√âGICO ===== */
    
    /* Funil Detalhado de Marketing e Vendas */
    .chart-funil-detalhado{
      border-color:rgba(99,102,241,.4);
      background:linear-gradient(135deg,rgba(99,102,241,.1),rgba(99,102,241,.02));
    }
    .funil-visual-container{
      padding:20px 10px;
    }
    .funil-visual-wrapper{
      display:flex;
      flex-direction:column;
      gap:0;
      position:relative;
    }
    .funil-etapa{
      display:flex;
      align-items:center;
      gap:16px;
      position:relative;
    }
    .funil-barra-container{
      flex:1;
      display:flex;
      justify-content:center;
    }
    .funil-barra{
      height:56px;
      border-radius:6px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      font-size:1.1rem;
      color:#fff;
      text-shadow:0 2px 4px rgba(0,0,0,.3);
      position:relative;
      transition:all .3s ease;
      cursor:pointer;
    }
    .funil-barra:hover{
      transform:scale(1.02);
      box-shadow:0 8px 24px rgba(0,0,0,.4);
    }
    .funil-barra-inner{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:2px;
    }
    .funil-barra-label{
      font-size:.75rem;
      font-weight:600;
      opacity:.9;
    }
    .funil-info{
      width:180px;
      padding:10px 14px;
      background:rgba(0,0,0,.3);
      border-radius:8px;
      border:1px solid rgba(255,255,255,.1);
    }
    .funil-info-titulo{
      font-weight:800;
      font-size:.85rem;
      color:#fff;
      margin-bottom:4px;
    }
    .funil-info-valor{
      font-size:1.2rem;
      font-weight:900;
      color:#10b981;
    }
    .funil-info-taxa{
      font-size:.75rem;
      color:rgba(255,255,255,.6);
    }
    .funil-perda{
      position:absolute;
      right:-120px;
      display:flex;
      align-items:center;
      gap:6px;
      padding:6px 12px;
      background:rgba(239,68,68,.2);
      border:1px solid rgba(239,68,68,.4);
      border-radius:6px;
      font-size:.75rem;
      font-weight:700;
      color:#fca5a5;
    }
    .funil-perda-icon{
      font-size:1rem;
    }
    .funil-conector{
      width:2px;
      height:16px;
      background:linear-gradient(to bottom,rgba(255,255,255,.3),rgba(255,255,255,.1));
      margin:0 auto;
    }
    .funil-diagnostico{
      margin-top:20px;
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:12px;
    }
    /* Responsividade para o grid de semanas no funil */
    @media (max-width:820px){
      .funil-visual-wrapper>div[style*="grid-template-columns:repeat(2"]{
        grid-template-columns:1fr!important;
      }
      .funil-visual-wrapper>div>div[style*="grid-template-columns:repeat(4"]{
        grid-template-columns:repeat(2,1fr)!important;
      }
    }
    .funil-diagnostico-item{
      padding:12px;
      background:rgba(0,0,0,.2);
      border-radius:8px;
      border-left:3px solid;
    }
    .funil-diagnostico-item.critico{border-left-color:#ef4444;}
    .funil-diagnostico-item.atencao{border-left-color:#f59e0b;}
    .funil-diagnostico-item.bom{border-left-color:#10b981;}
    .funil-diagnostico-titulo{
      font-weight:800;
      font-size:.8rem;
      color:#fff;
      margin-bottom:4px;
    }
    .funil-diagnostico-texto{
      font-size:.75rem;
      color:rgba(255,255,255,.7);
      line-height:1.4;
    }
    
    /* Mapa de Diferencia√ß√£o Competitiva */
    .chart-mapa-diferenciacao{
      border-color:rgba(16,185,129,.4);
      background:linear-gradient(135deg,rgba(16,185,129,.1),rgba(239,68,68,.05));
    }
    .mapa-diferenciacao-container{
      padding:20px;
    }
    .mapa-diferenciacao-wrapper{
      display:flex;
      flex-direction:column;
      gap:20px;
    }
    .mapa-eixos{
      display:flex;
      position:relative;
      height:380px;
      border-left:2px solid rgba(255,255,255,.3);
      border-bottom:2px solid rgba(255,255,255,.3);
      margin-left:40px;
      margin-bottom:30px;
    }
    .mapa-eixo-y-label{
      position:absolute;
      left:-40px;
      top:50%;
      transform:rotate(-90deg) translateX(50%);
      font-size:.75rem;
      font-weight:700;
      color:rgba(255,255,255,.7);
      white-space:nowrap;
    }
    .mapa-eixo-x-label{
      position:absolute;
      bottom:-25px;
      left:50%;
      transform:translateX(-50%);
      font-size:.75rem;
      font-weight:700;
      color:rgba(255,255,255,.7);
    }
    .mapa-quadrante{
      position:absolute;
      width:50%;
      height:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:.7rem;
      font-weight:700;
      color:rgba(255,255,255,.4);
      text-transform:uppercase;
    }
    .mapa-quadrante.oceano-vermelho{
      top:50%;left:0;
      background:rgba(239,68,68,.1);
    }
    .mapa-quadrante.commodity{
      top:50%;left:50%;
      background:rgba(245,158,11,.1);
    }
    .mapa-quadrante.premium{
      top:0;left:0;
      background:rgba(139,92,246,.1);
    }
    .mapa-quadrante.oceano-azul{
      top:0;left:50%;
      background:rgba(16,185,129,.15);
    }
    .mapa-empresa{
      position:absolute;
      width:60px;
      height:60px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:.7rem;
      text-align:center;
      color:#fff;
      border:3px solid;
      box-shadow:0 4px 16px rgba(0,0,0,.3);
      cursor:pointer;
      transition:all .3s ease;
      z-index:10;
    }
    .mapa-empresa:hover{
      transform:scale(1.15);
      z-index:20;
    }
    .mapa-empresa.voce{
      width:80px;
      height:80px;
      background:linear-gradient(135deg,#3b82f6,#2563eb);
      border-color:#34d399;
      font-size:.8rem;
    }
    .mapa-empresa.concorrente{
      background:rgba(239,68,68,.8);
      border-color:#f87171;
    }
    .mapa-legenda{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:10px;
    }
    .mapa-legenda-item{
      padding:10px;
      border-radius:8px;
      text-align:center;
      font-size:.75rem;
      font-weight:700;
    }
    .mapa-legenda-item.oceano-vermelho{background:rgba(239,68,68,.15);color:#fca5a5;}
    .mapa-legenda-item.commodity{background:rgba(245,158,11,.15);color:#fcd34d;}
    .mapa-legenda-item.premium{background:rgba(139,92,246,.15);color:#c4b5fd;}
    .mapa-legenda-item.oceano-azul{background:rgba(16,185,129,.15);color:#6ee7b7;}
    
    /* Gr√°fico de Sazonalidade */
    .chart-sazonalidade{
      border-color:rgba(245,158,11,.4);
      background:linear-gradient(135deg,rgba(245,158,11,.1),rgba(245,158,11,.02));
    }
    .sazonalidade-legenda{
      display:flex;
      justify-content:center;
      gap:20px;
      margin-top:12px;
      padding:10px;
      background:rgba(0,0,0,.2);
      border-radius:8px;
    }
    .sazonalidade-legenda-item{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:.75rem;
      color:rgba(255,255,255,.8);
    }
    .sazonalidade-legenda-dot{
      width:12px;
      height:12px;
      border-radius:50%;
    }
    .sazonalidade-legenda-dot.pico{background:#10b981;}
    .sazonalidade-legenda-dot.normal{background:#6366f1;}
    .sazonalidade-legenda-dot.baixa{background:#ef4444;}
    
    /* Gr√°fico Clareza de Marca */
    .chart-clareza-marca{
      border-color:rgba(139,92,246,.4);
      background:linear-gradient(135deg,rgba(139,92,246,.1),rgba(139,92,246,.02));
    }
    .clareza-marca-container{
      padding:20px;
    }
    .clareza-marca-wrapper{
      display:grid;
      grid-template-columns:1fr 80px 1fr;
      gap:20px;
      align-items:stretch;
    }
    .clareza-marca-coluna{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .clareza-marca-header{
      text-align:center;
      padding:12px;
      border-radius:10px;
      font-weight:900;
      font-size:.9rem;
    }
    .clareza-marca-header.antes{
      background:rgba(239,68,68,.2);
      color:#fca5a5;
      border:1px solid rgba(239,68,68,.3);
    }
    .clareza-marca-header.depois{
      background:rgba(16,185,129,.2);
      color:#6ee7b7;
      border:1px solid rgba(16,185,129,.3);
    }
    .clareza-marca-item{
      padding:14px;
      background:rgba(0,0,0,.2);
      border-radius:10px;
      border-left:4px solid;
    }
    .clareza-marca-item.antes{border-left-color:#ef4444;}
    .clareza-marca-item.depois{border-left-color:#10b981;}
    .clareza-marca-item-titulo{
      font-weight:800;
      font-size:.8rem;
      color:#fff;
      margin-bottom:6px;
    }
    .clareza-marca-item-valor{
      font-size:1.4rem;
      font-weight:900;
    }
    .clareza-marca-item.antes .clareza-marca-item-valor{color:#fca5a5;}
    .clareza-marca-item.depois .clareza-marca-item-valor{color:#6ee7b7;}
    .clareza-marca-item-desc{
      font-size:.7rem;
      color:rgba(255,255,255,.6);
      margin-top:4px;
    }
    .clareza-marca-seta{
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:2rem;
      color:rgba(255,255,255,.4);
    }
    .clareza-marca-resumo{
      grid-column:1/-1;
      margin-top:10px;
      padding:16px;
      background:linear-gradient(135deg,rgba(16,185,129,.15),rgba(16,185,129,.05));
      border:1px solid rgba(16,185,129,.3);
      border-radius:10px;
      text-align:center;
    }
    .clareza-marca-resumo-titulo{
      font-size:.85rem;
      font-weight:800;
      color:#10b981;
      margin-bottom:6px;
    }
    .clareza-marca-resumo-valor{
      font-size:2rem;
      font-weight:900;
      color:#fff;
    }
    .clareza-marca-resumo-desc{
      font-size:.75rem;
      color:rgba(255,255,255,.6);
    }
    
    @media (max-width:900px){
      .analise-grid{
        grid-template-columns:1fr;
      }
      .analise-charts-dynamic{
        grid-template-columns:1fr;
      }
      .analise-metrics-row{
        grid-template-columns:repeat(2,1fr);
      }
    }
    @media (max-width:600px){
      .analise-metrics-row{
        grid-template-columns:1fr;
      }
      .entregavel-buttons-row{
        flex-direction:column;
      }
    }

    /* ===== IA CHAT ===== */
    .ia-wrap{margin-left:var(--margin-left);margin-right:var(--margin-right);display:flex;flex-direction:column;gap:12px;min-height:0}
    .ia-shell{display:flex;gap:12px;min-height:0}
    .ia-sidebar{width:280px;background:var(--panel);border:1px solid var(--shell-border);border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:10px;box-shadow:0 8px 22px rgba(0,0,0,.35);overflow:hidden}
    .ia-sidebar-content{flex:1;min-height:0;display:flex;flex-direction:column;gap:10px;overflow:hidden}
    .ia-knowledge{border:1px solid rgba(255,255,255,.12);border-radius:12px;background:rgba(255,255,255,.03);overflow:hidden}
    .ia-knowledge summary{margin:0;padding:12px;font-size:.9rem;font-weight:800;list-style:none;display:flex;align-items:center;justify-content:space-between;cursor:pointer;gap:8px}
    .ia-knowledge summary:hover{background:rgba(255,255,255,.04)}
    .ia-knowledge summary::-webkit-details-marker{display:none}
    .ia-knowledge summary::after{content:'‚ñæ';font-size:.8rem;opacity:.8;transition:transform .2s ease}
    .ia-knowledge[open] summary::after{transform:rotate(180deg)}
    .ia-knowledge-content{padding:0 12px 12px;display:flex;flex-direction:column;gap:10px}
    .ia-knowledge p{margin:0;font-size:.8rem;color:rgba(255,255,255,.6);line-height:1.4}
    .ia-doc-count{font-size:.75rem;color:rgba(255,255,255,.65);background:rgba(255,255,255,.06);padding:2px 8px;border-radius:999px;font-weight:700}
    .ia-docs-actions{display:flex;gap:8px;flex-wrap:wrap}
    .ia-docs-actions .btn{flex:1}
    .ia-docs-status{font-size:.75rem;color:rgba(255,255,255,.55)}
    .ia-docs-list{display:flex;flex-direction:column;gap:8px;max-height:220px;overflow:auto;padding-right:4px}
    .ia-doc-item{border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px;background:rgba(0,0,0,.3);display:flex;flex-direction:column;gap:6px}
    .ia-doc-item h4{margin:0;font-size:.85rem;font-weight:800;color:#fff}
    .ia-doc-meta{font-size:.75rem;color:rgba(255,255,255,.55);display:flex;gap:10px;flex-wrap:wrap}
    .ia-doc-buttons{display:flex;gap:6px;flex-wrap:wrap}
    .ia-doc-buttons .btn.small{flex:1;min-width:120px}
    .ia-doc-empty{font-size:.8rem;color:rgba(255,255,255,.55);padding:10px;text-align:center;border:1px dashed rgba(255,255,255,.18);border-radius:10px}
    .ia-sidebar-header{display:flex;justify-content:space-between;align-items:center}
    .ia-sidebar-search .input{width:100%;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);color:#fff;border-radius:10px;padding:8px 12px}
    .ia-chat-list{flex:1;min-height:0;overflow:auto;display:flex;flex-direction:column;gap:6px;padding-right:4px;max-height:calc(100vh - 250px)}
    .ia-chat-item{border:1px solid transparent;background:rgba(255,255,255,.04);color:#fff;border-radius:10px;padding:10px;display:flex;flex-direction:column;gap:4px;text-align:left;cursor:pointer;transition:background .2s ease,border .2s ease}
    .ia-chat-item:hover{background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.12)}
    .ia-chat-item.active{background:var(--accent);color:#000;border-color:transparent;box-shadow:0 6px 16px rgba(255,102,0,.4)}
    .ia-chat-item.active .ia-chat-meta,.ia-chat-item.active .ia-chat-preview{color:#111}
    .ia-chat-title{font-weight:800;font-size:.95rem;line-height:1.2}
    .ia-chat-preview{font-size:.8rem;color:rgba(255,255,255,.75);line-height:1.3}
    .ia-chat-meta{font-size:.75rem;color:rgba(255,255,255,.55)}
    .ia-chat-empty{padding:20px;border:1px dashed rgba(255,255,255,.2);border-radius:12px;text-align:center;font-size:.85rem;color:rgba(255,255,255,.6)}
    .ia-main{flex:1;background:var(--panel);border:1px solid var(--shell-border);border-radius:16px;display:flex;flex-direction:column;position:relative;box-shadow:0 10px 26px rgba(0,0,0,.35);overflow:hidden;height:calc(100vh - 180px) !important;min-height:700px !important;max-height:1200px !important}
    .ia-main-head{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid rgba(255,255,255,.08);gap:10px}
    .ia-title{font-weight:900;font-size:1.05rem;flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .ia-main-actions{display:flex;gap:8px}
    .btn.ghost.danger{background:rgba(255,255,255,.04);border-color:#5a0000;color:#ff9a9a}
    .ia-history{flex:1;overflow-y:auto;padding:18px;display:flex;flex-direction:column;gap:16px;scroll-behavior:smooth;background:linear-gradient(180deg,rgba(255,255,255,.01),rgba(0,0,0,.08));min-height:0}
    .ia-msg{max-width:78%;display:flex;flex-direction:column;gap:6px}
    .ia-msg-user{margin-left:auto;align-items:flex-end}
    .ia-msg-assistant{margin-right:auto;align-items:flex-start}
    .ia-msg-bubble{padding:12px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.05);font-size:.88rem;line-height:1.5;box-shadow:0 8px 18px rgba(0,0,0,.25);display:flex;flex-direction:column;gap:10px}
    .ia-msg-user .ia-msg-bubble{background:linear-gradient(135deg,var(--accent),#ff944d);color:#000;border-color:rgba(0,0,0,.08);box-shadow:0 10px 22px rgba(255,102,0,.35)}
    .ia-msg-meta{font-size:.75rem;color:rgba(255,255,255,.55)}
    .ia-msg-user .ia-msg-meta{color:rgba(0,0,0,.6)}
    .ia-msg-content{font-size:.88rem}
    .ia-msg-content p{margin:0 0 8px 0}
    .ia-msg-content p:last-child{margin-bottom:0}
    .ia-msg-content ul,.ia-msg-content ol{margin:0 0 8px 18px;font-size:.88rem}
    .ia-msg-content ul:last-child,.ia-msg-content ol:last-child{margin-bottom:0}
    .ia-msg-content li{margin-bottom:4px;line-height:1.5;position:relative;padding-right:28px}
    .ia-msg-content li:hover .ia-line-add-btn{opacity:1}
    .ia-msg-content p{position:relative;padding-right:28px}
    .ia-msg-content p:hover .ia-line-add-btn{opacity:1}
    .ia-msg-content pre{margin:0}
    .ia-line-add-btn{position:absolute;right:0;top:0;opacity:0;background:rgba(255,102,0,.15);border:1px solid rgba(255,102,0,.35);color:var(--accent);border-radius:6px;padding:2px 6px;font-size:.65rem;font-weight:700;cursor:pointer;transition:all .2s ease;z-index:10}
    .ia-line-add-btn:hover{opacity:1 !important;background:rgba(255,102,0,.25);transform:scale(1.05)}
    .ia-line-add-btn:active{transform:scale(.95)}
    .ia-code{background:#090909;border:1px solid #222;border-radius:10px;padding:12px;font-family:"Fira Code",monospace;font-size:.8rem;overflow:auto}
    .ia-msg-actions{display:flex;justify-content:flex-end;gap:8px;flex-wrap:wrap}
    .ia-copy-btn,.ia-add-all-planning-btn,.ia-add-metas-btn,.ia-edit-btn{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);color:#fff;border-radius:8px;padding:4px 10px;font-size:.75rem;font-weight:700;cursor:pointer;transition:background .2s ease,transform .1s ease}
    .ia-copy-btn:hover,.ia-add-all-planning-btn:hover,.ia-add-metas-btn:hover,.ia-edit-btn:hover{background:rgba(255,255,255,.16)}
    .ia-copy-btn:active,.ia-add-all-planning-btn:active,.ia-add-metas-btn:active,.ia-edit-btn:active{transform:scale(.97)}
    .ia-add-all-planning-btn{background:rgba(255,102,0,.12);border-color:rgba(255,102,0,.3);color:var(--accent)}
    .ia-add-all-planning-btn:hover{background:rgba(255,102,0,.2)}
    .ia-add-metas-btn{background:rgba(16,185,129,.12);border-color:rgba(16,185,129,.3);color:#10b981}
    .ia-add-metas-btn:hover{background:rgba(16,185,129,.2)}
    .ia-edit-btn{background:rgba(59,130,246,.12);border-color:rgba(59,130,246,.3);color:#3b82f6}
    .ia-edit-btn:hover{background:rgba(59,130,246,.2)}
    .ia-msg-editing .ia-msg-content{display:none}
    .ia-msg-edit-area{display:none;width:100%;margin-bottom:10px}
    .ia-msg-editing .ia-msg-edit-area{display:block}
    .ia-msg-edit-textarea{width:100%;min-height:150px;max-height:400px;padding:12px;background:#1a1f2e;border:2px solid rgba(59,130,246,.5);border-radius:8px;color:#fff;font-size:.9rem;font-family:inherit;resize:vertical;outline:none}
    .ia-msg-edit-textarea:focus{border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.2)}
    .ia-msg-edit-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
    .ia-msg-edit-save,.ia-msg-edit-cancel{padding:6px 16px;border-radius:6px;font-size:.8rem;font-weight:700;cursor:pointer;transition:all .2s ease}
    .ia-msg-edit-save{background:#3b82f6;border:1px solid #3b82f6;color:#fff}
    .ia-msg-edit-save:hover{background:#2563eb;transform:translateY(-1px)}
    .ia-msg-edit-cancel{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.2);color:#fff}
    .ia-msg-edit-cancel:hover{background:rgba(255,255,255,.16)}
    .ia-empty{position:absolute;inset:80px 18px 90px 18px;border:1px dashed rgba(255,255,255,.18);border-radius:16px;display:flex;align-items:center;justify-content:center;text-align:center;padding:20px;color:rgba(255,255,255,.6);font-size:.9rem;pointer-events:none}
    .ia-composer{position:sticky;bottom:0;display:flex;gap:10px;padding:14px 18px;background:rgba(0,0,0,.65);backdrop-filter:blur(8px);border-top:1px solid rgba(255,255,255,.08);flex-wrap:wrap;align-items:flex-end}
    .ia-composer-top{display:flex;gap:12px;align-items:flex-start;width:100%;margin-bottom:8px;flex-wrap:wrap}
    .ia-response-size{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    .ia-response-size-label{font-size:.75rem;color:rgba(255,255,255,.6);font-weight:600;white-space:nowrap}
    .ia-size-btn{padding:6px 12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:rgba(255,255,255,.7);border-radius:8px;font-size:.75rem;font-weight:600;cursor:pointer;transition:all .2s ease;position:relative}
    .ia-size-btn:hover{background:rgba(255,255,255,.1);color:#fff;transform:translateY(-1px)}
    .ia-size-btn.active{background:var(--accent);border-color:var(--accent);color:#000;box-shadow:0 0 0 3px rgba(255,102,0,.3),0 4px 12px rgba(255,102,0,.4);font-weight:800;transform:scale(1.05)}
    .ia-sources-select{display:flex;gap:6px;align-items:center;flex:1;min-width:300px}
    .ia-sources-label{font-size:.75rem;color:rgba(255,255,255,.6);font-weight:600;white-space:nowrap}
    .ia-cost-badge{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;background:rgba(255,102,0,.1);border:1px solid rgba(255,102,0,.3);border-radius:6px;font-size:.7rem;font-weight:700;color:var(--accent);white-space:nowrap;margin-left:8px;transition:all .2s ease}
    .ia-cost-badge.flash{animation:costFlash .5s ease}
    .ia-sources-dropdown{position:relative;flex:1}
    .ia-sources-btn{width:100%;padding:8px 12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:#fff;border-radius:8px;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .2s ease;display:flex;align-items:center;justify-content:space-between;gap:8px}
    .ia-sources-btn:hover{background:rgba(255,255,255,.1)}
    .ia-sources-btn.active{border-color:var(--accent)}
    .ia-sources-menu{position:absolute;bottom:calc(100% + 8px);left:0;right:0;background:rgba(20,20,20,.98);border:1px solid rgba(255,255,255,.2);border-radius:12px;padding:8px;display:none;flex-direction:column;gap:4px;max-height:400px;overflow-y:auto;z-index:1000;box-shadow:0 8px 24px rgba(0,0,0,.5);backdrop-filter:blur(12px)}
    .ia-sources-menu.show{display:flex}
    .ia-source-option{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;cursor:pointer;transition:all .2s ease;background:transparent}
    .ia-source-option:hover{background:rgba(255,255,255,.08)}
    .ia-source-option input[type="checkbox"]{width:18px;height:18px;cursor:pointer;accent-color:var(--accent)}
    .ia-source-option label{flex:1;cursor:pointer;font-size:.85rem;color:#fff;user-select:none}
    .ia-source-separator{padding:12px 12px 6px;font-size:.7rem;font-weight:800;color:var(--accent);text-transform:uppercase;letter-spacing:1px;border-top:1px solid rgba(255,255,255,.1);margin-top:8px}
    .ia-source-separator:first-child{border-top:none;margin-top:0}
    .ia-sources-actions{display:flex;gap:6px;padding:8px 4px 4px;border-top:1px solid rgba(255,255,255,.1);margin-top:4px}
    .ia-sources-action-btn{flex:1;padding:6px 10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#fff;border-radius:6px;font-size:.75rem;font-weight:600;cursor:pointer;transition:all .2s ease}
    .ia-sources-action-btn:hover{background:rgba(255,255,255,.1)}
    .ia-sources-action-btn.primary{background:var(--accent);border-color:var(--accent)}
    .ia-sources-action-btn.primary:hover{opacity:.9}
    .ia-input{flex:1;resize:none;min-height:48px;max-height:180px;padding:12px 14px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.12);border-radius:12px;color:#fff}
    .ia-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(255,102,0,.25)}
    .ia-source-note{margin:4px 0 0;width:100%;font-size:.72rem;color:rgba(255,255,255,.6);letter-spacing:.01em;opacity:.85}
    .ia-image-preview-wrapper{width:100%;margin-bottom:8px;display:none}
    .ia-image-preview-container{position:relative;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px;display:flex;gap:10px;align-items:center}
    .ia-image-preview-img{width:80px;height:80px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,.1)}
    .ia-image-preview-info{flex:1;display:flex;flex-direction:column;gap:4px}
    .ia-image-preview-name{font-size:.85rem;font-weight:700;color:#fff}
    .ia-image-preview-size{font-size:.75rem;color:rgba(255,255,255,.6)}
    .ia-image-preview-remove{background:rgba(239,68,68,.2);border:1px solid rgba(239,68,68,.4);color:#f87171;border-radius:8px;padding:6px 12px;cursor:pointer;font-size:.75rem;font-weight:700;transition:all .2s ease}
    .ia-image-preview-remove:hover{background:rgba(239,68,68,.3);transform:translateY(-1px)}
    .ia-typing{display:inline-flex;gap:6px;align-items:center}
    .ia-typing span{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.85);animation:iaTyping 1s ease-in-out infinite}
    .ia-typing span:nth-child(2){animation-delay:.15s}
    .ia-typing span:nth-child(3){animation-delay:.3s}
    @keyframes iaTyping{0%,80%,100%{opacity:.4;transform:translateY(0)}40%{opacity:1;transform:translateY(-3px)}}
    @keyframes slideInRight{from{opacity:0;transform:translateX(100px)}to{opacity:1;transform:translateX(0)}}
    @keyframes slideOutRight{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(100px)}}
    @keyframes costFlash{0%,100%{transform:scale(1)}50%{transform:scale(1.1);box-shadow:0 0 12px rgba(255,102,0,.6)}}
    @media (max-width:1024px){
      .ia-shell{flex-direction:column}
      .ia-sidebar{width:100%;flex-direction:column}
      .ia-main{max-height:calc(100vh - 260px)}
      .ia-msg{max-width:88%}
    }
    @media (max-width:640px){
      .ia-shell{min-height:420px}
      .ia-main{max-height:calc(100vh - 320px)}
      .ia-main-head{flex-direction:column;align-items:flex-start}
      .ia-main-actions{width:100%;justify-content:flex-end}
      .ia-composer{flex-direction:column}
      .ia-composer-top{flex-direction:column;align-items:flex-start;gap:10px}
      .ia-response-size{flex-wrap:wrap;width:100%}
      .ia-response-size-label{width:100%;margin-bottom:4px}
      .ia-size-btn{flex:1;min-width:80px}
      .ia-sources-select{width:100%;min-width:100%}
      .ia-sources-label{width:100%;margin-bottom:4px}
      .ia-input{width:100%}
      #iaSend{width:100%}
    }

    /* Modal para adicionar ao planejamento */
    .ia-planning-modal{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:99999;backdrop-filter:blur(6px)}
    .ia-planning-modal.show{display:flex}
    .ia-planning-modal-content{background:var(--panel);border:1px solid rgba(255,255,255,.15);border-radius:16px;width:90%;max-width:700px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,.6)}
    .ia-planning-modal-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid rgba(255,255,255,.1);background:rgba(255,102,0,.05)}
    .ia-planning-modal-header h3{margin:0;font-size:1.1rem;font-weight:800;color:#fff}
    .ia-planning-modal-close{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);color:#fff;border-radius:8px;padding:6px 12px;cursor:pointer;font-weight:700;font-size:.85rem}
    .ia-planning-modal-close:hover{background:rgba(255,255,255,.16)}
    .ia-planning-modal-body{padding:20px;overflow-y:auto;flex:1}
    .ia-planning-form-group{margin-bottom:18px}
    .ia-planning-form-group label{display:block;margin-bottom:6px;font-size:.85rem;font-weight:700;color:rgba(255,255,255,.85)}
    .ia-planning-form-group textarea,.ia-planning-form-group input,.ia-planning-form-group select{width:100%;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.12);color:#fff;border-radius:8px;padding:10px 12px;font-size:.9rem;font-family:inherit}
    .ia-planning-form-group textarea{min-height:120px;resize:vertical;font-family:inherit;line-height:1.5}
    .ia-planning-form-group textarea::placeholder{color:rgba(255,255,255,.4)}
    .ia-planning-form-help{font-size:.75rem;color:rgba(255,255,255,.5);margin-top:4px}
    .ia-planning-modal-footer{padding:16px 20px;border-top:1px solid rgba(255,255,255,.1);display:flex;gap:10px;justify-content:flex-end;background:rgba(0,0,0,.3)}
    .ia-planning-add-more{display:flex;align-items:center;gap:8px;margin-right:auto}
    .ia-planning-add-more input[type="checkbox"]{width:auto;cursor:pointer}
    .ia-planning-add-more label{margin:0;font-size:.85rem;color:rgba(255,255,255,.75);cursor:pointer}
    .ia-planning-periodo-field{display:flex;flex-direction:column;gap:8px}
    .ia-planning-periodo-field input{width:100%}
    .ia-planning-periodo-field.range-active .ia-planning-periodo-fim{display:block}
    .ia-planning-periodo-field.range-active .ia-planning-periodo-sep{display:block}
    .ia-planning-periodo-field:not(.range-active) .ia-planning-periodo-fim{display:none}
    .ia-planning-periodo-field:not(.range-active) .ia-planning-periodo-sep{display:none}
    .ia-planning-periodo-sep{font-size:.8rem;color:rgba(255,255,255,.6);text-align:center;margin:4px 0}
    .ia-planning-periodo-toggle{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:rgba(255,255,255,.75);border-radius:8px;padding:8px 12px;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .2s ease}
    .ia-planning-periodo-toggle:hover{background:rgba(255,255,255,.1);color:#fff}

    /* Modal para selecionar m√™s/ano */
    .ia-month-picker-modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:99999;backdrop-filter:blur(8px)}
    .ia-month-picker-modal.show{display:flex}
    .ia-month-picker-content{background:linear-gradient(135deg,#1a1f2e 0%,#0f1419 100%);border:1px solid rgba(255,102,0,.3);border-radius:20px;width:90%;max-width:550px;overflow:hidden;box-shadow:0 25px 70px rgba(255,102,0,.2),0 0 0 1px rgba(255,255,255,.05) inset;animation:modalSlideIn .3s ease}
    @keyframes modalSlideIn{from{transform:translateY(-30px);opacity:0}to{transform:translateY(0);opacity:1}}
    .ia-month-picker-header{display:flex;align-items:center;justify-content:space-between;padding:20px 24px;background:linear-gradient(135deg,rgba(255,102,0,.15) 0%,rgba(255,102,0,.05) 100%);border-bottom:1px solid rgba(255,102,0,.2)}
    .ia-month-picker-header h3{margin:0;font-size:1.25rem;font-weight:800;color:#fff;text-shadow:0 2px 8px rgba(255,102,0,.3)}
    .ia-month-picker-close{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);color:#fff;border-radius:50%;width:32px;height:32px;cursor:pointer;font-weight:700;font-size:1.1rem;display:flex;align-items:center;justify-content:center;transition:all .2s ease}
    .ia-month-picker-close:hover{background:rgba(255,255,255,.16);transform:rotate(90deg)}
    .ia-month-picker-body{padding:24px}
    .ia-month-picker-info{text-align:center;font-size:.95rem;color:rgba(255,255,255,.7);margin:0 0 24px;padding:12px;background:rgba(255,102,0,.08);border:1px solid rgba(255,102,0,.2);border-radius:10px}
    .ia-month-picker-info span{font-weight:800;color:var(--accent);font-size:1.1rem}
    .ia-month-picker-selectors{display:flex;flex-direction:column;gap:20px}
    .ia-year-selector{display:flex;flex-direction:column;align-items:center;gap:8px}
    .ia-year-selector label{font-size:.8rem;text-transform:uppercase;letter-spacing:.1em;color:rgba(255,255,255,.5);font-weight:700}
    .ia-year-buttons{display:flex;align-items:center;gap:16px}
    .ia-year-btn{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:#fff;border-radius:10px;width:40px;height:40px;cursor:pointer;font-size:1.1rem;font-weight:700;display:flex;align-items:center;justify-content:center;transition:all .2s ease}
    .ia-year-btn:hover{background:rgba(255,102,0,.2);border-color:rgba(255,102,0,.4);transform:scale(1.1)}
    .ia-year-btn:active{transform:scale(.95)}
    .ia-year-display{font-size:1.8rem;font-weight:800;color:#fff;min-width:100px;text-align:center;text-shadow:0 2px 12px rgba(255,102,0,.4)}
    .ia-month-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .ia-month-btn{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);color:rgba(255,255,255,.75);border-radius:12px;padding:14px 8px;cursor:pointer;font-size:.85rem;font-weight:700;transition:all .2s ease;position:relative;overflow:hidden}
    .ia-month-btn::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,102,0,.2) 0%,rgba(255,102,0,.05) 100%);opacity:0;transition:opacity .2s ease}
    .ia-month-btn:hover{border-color:rgba(255,102,0,.4);color:#fff;transform:translateY(-2px);box-shadow:0 4px 12px rgba(255,102,0,.2)}
    .ia-month-btn:hover::before{opacity:1}
    .ia-month-btn.selected{background:linear-gradient(135deg,var(--accent) 0%,rgba(255,102,0,.7) 100%);border-color:var(--accent);color:#fff;box-shadow:0 4px 16px rgba(255,102,0,.4),0 0 0 2px rgba(255,102,0,.2) inset;transform:scale(1.05)}
    .ia-month-btn.selected::before{opacity:0}
    .ia-month-btn:active{transform:scale(.98)}
    .ia-month-picker-footer{padding:16px 24px;border-top:1px solid rgba(255,255,255,.08);display:flex;gap:10px;justify-content:flex-end;background:rgba(0,0,0,.3)}
    .ia-month-picker-footer .btn:disabled{opacity:.4;cursor:not-allowed}

    /* Modal para mapear n√∫meros √†s metas */
    .ia-metas-mapper-modal{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:99999;backdrop-filter:blur(10px)}
    .ia-metas-mapper-modal.show{display:flex}
    .ia-metas-mapper-content{background:linear-gradient(135deg,#1a1f2e 0%,#0f1419 100%);border:1px solid rgba(16,185,129,.3);border-radius:20px;width:95%;max-width:700px;max-height:85vh;overflow:hidden;box-shadow:0 25px 70px rgba(16,185,129,.25),0 0 0 1px rgba(255,255,255,.05) inset;animation:modalSlideIn .3s ease}
    .ia-metas-mapper-header{display:flex;align-items:center;justify-content:space-between;padding:20px 24px;background:linear-gradient(135deg,rgba(16,185,129,.15) 0%,rgba(16,185,129,.05) 100%);border-bottom:1px solid rgba(16,185,129,.2)}
    .ia-metas-mapper-header h3{margin:0;font-size:1.25rem;font-weight:800;color:#fff;text-shadow:0 2px 8px rgba(16,185,129,.3)}
    .ia-metas-mapper-close{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);color:#fff;border-radius:50%;width:32px;height:32px;cursor:pointer;font-weight:700;font-size:1.1rem;display:flex;align-items:center;justify-content:center;transition:all .2s ease}
    .ia-metas-mapper-close:hover{background:rgba(255,255,255,.16);transform:rotate(90deg)}
    .ia-metas-mapper-body{padding:24px;max-height:calc(85vh - 180px);overflow-y:auto}
    .ia-metas-mapper-item{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:20px;margin-bottom:20px;animation:fadeInUp .3s ease;transition:all .2s ease;position:relative}
    .ia-metas-mapper-item:hover{background:rgba(255,255,255,.06);border-color:rgba(16,185,129,.3);box-shadow:0 6px 20px rgba(16,185,129,.15);transform:translateY(-2px)}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .ia-metas-mapper-item-header{display:flex;align-items:center;gap:12px;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid rgba(255,255,255,.08)}
    .ia-metas-mapper-number{display:inline-flex;align-items:center;justify-content:center;min-width:80px;gap:8px;background:linear-gradient(135deg,rgba(16,185,129,.25) 0%,rgba(16,185,129,.15) 100%);border:2px solid rgba(16,185,129,.4);border-radius:10px;padding:12px 20px;font-size:1.4rem;font-weight:900;color:#10b981;text-shadow:0 2px 8px rgba(16,185,129,.3);box-shadow:0 4px 12px rgba(16,185,129,.2),0 0 20px rgba(16,185,129,.1) inset}
    .ia-metas-mapper-index{position:absolute;top:12px;right:12px;background:rgba(16,185,129,.15);border:1px solid rgba(16,185,129,.3);border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:800;color:#10b981}
    .ia-metas-mapper-context{background:rgba(0,0,0,.3);border-left:3px solid rgba(16,185,129,.4);padding:12px 16px;border-radius:8px;margin-bottom:16px;position:relative}
    .ia-metas-mapper-context-label{font-size:.7rem;text-transform:uppercase;letter-spacing:.1em;color:rgba(16,185,129,.7);font-weight:700;margin-bottom:6px}
    .ia-metas-mapper-context-text{font-size:.9rem;color:rgba(255,255,255,.85);line-height:1.6;font-family:monospace;word-break:break-word}
    .ia-metas-mapper-context-text .highlight-number{background:rgba(16,185,129,.3);color:#10b981;font-weight:900;padding:2px 6px;border-radius:4px;border:1px solid rgba(16,185,129,.4)}
    .ia-metas-mapper-selectors{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .ia-metas-mapper-selectors label{display:block;font-size:.75rem;text-transform:uppercase;letter-spacing:.08em;color:rgba(255,255,255,.5);font-weight:700;margin-bottom:6px}
    .ia-metas-mapper-selectors select{width:100%;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.15);border-radius:8px;padding:10px 12px;color:#fff;font-size:.9rem;font-weight:600;cursor:pointer;transition:all .2s ease}
    .ia-metas-mapper-selectors select:hover{border-color:rgba(16,185,129,.4);background:rgba(0,0,0,.4)}
    .ia-metas-mapper-selectors select:focus{outline:none;border-color:rgba(16,185,129,.6);box-shadow:0 0 0 3px rgba(16,185,129,.1)}
    .ia-metas-mapper-footer{padding:16px 24px;border-top:1px solid rgba(255,255,255,.08);display:flex;gap:10px;justify-content:space-between;align-items:center;background:rgba(0,0,0,.3)}
    .ia-metas-mapper-bulk-actions{display:flex;gap:10px;align-items:center}
    .ia-metas-mapper-bulk-actions .btn{font-size:.85rem;padding:8px 16px}
    .ia-metas-mapper-checkbox{width:20px;height:20px;cursor:pointer;accent-color:#10b981}
    .ia-metas-mapper-item.selected{background:rgba(16,185,129,.1);border-color:rgba(16,185,129,.4);box-shadow:0 0 0 2px rgba(16,185,129,.2)}
    .ia-metas-mapper-item-checkbox{position:absolute;top:16px;left:16px;transform:scale(1.3)}
    .ia-metas-mapper-body::-webkit-scrollbar{width:8px}
    .ia-metas-mapper-body::-webkit-scrollbar-track{background:rgba(0,0,0,.2)}
    .ia-metas-mapper-body::-webkit-scrollbar-thumb{background:rgba(16,185,129,.3);border-radius:4px}
    .ia-metas-mapper-body::-webkit-scrollbar-thumb:hover{background:rgba(16,185,129,.5)}
    .ia-metas-mapper-auto-order-info{background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.3);border-radius:8px;padding:12px 16px;margin-bottom:16px;font-size:.85rem;color:rgba(147,197,253,.9);display:flex;align-items:flex-start;gap:10px;line-height:1.5}
    .ia-metas-mapper-auto-order-info strong{color:#60a5fa;display:block;margin-bottom:4px}


    /* ========= CALEND√ÅRIO / POSTS (Firestore + Storage) ========= */
    const calWeekdays = $("calWeekdays"), calDays = $("calDays"), calTitle = $("calTitle");
    const googleCalendarConnectBtn = $("googleCalendarConnect"), googleCalendarDisconnectBtn = $("googleCalendarDisconnect"), googleCalendarStatus = $("googleCalendarStatus");
    if(window.googleCalendarIntegration){
      window.googleCalendarIntegration.setDomRefs({
        connectBtn: googleCalendarConnectBtn,
        disconnectBtn: googleCalendarDisconnectBtn,
        statusEl: googleCalendarStatus
      });
      if(typeof window.googleCalendarIntegration.ensureConnected === 'function'){
        window.googleCalendarIntegration.ensureConnected();
      }
    }
    const calPrev = $("calPrev"), calNext = $("calNext"), calUpload = $("calUpload"), btnShareCalendar = $("btnShareCalendar");
    const btnCopyPlanningLink = $("btnCopyPlanningLink");
    const calDate = $("calDate"), calDesc = $("calDesc"), calFiles = $("calFiles"), calTarget = $("calTarget"), calFilterStatus = $("calFilterStatus"), calFilterCountry = $("calFilterCountry"), calFilterText = $("calFilterText");
    const feedGrid = $("feedGrid"), storiesGrid = $("storiesGrid"), storiesPrev = $("storiesPrev"), storiesNext = $("storiesNext"), calendarDemandasMobile = $("calendarDemandasMobile");
    const postModal = $("postModal"), modalClose = $("modalClose"), modalTitle = $("modalTitle"), modalPreview = $("modalPreview"), modalDate = $("modalDate"), modalStatus = $("modalStatus"), modalDesc = $("modalDesc"), modalTarget = $("modalTarget");
    const btnApprove = $("btnApprove"), btnApproveInternal = $("btnApproveInternal"), btnReview = $("btnReview"), btnCopyApprovalLink = $("btnCopyApprovalLink"), btnSave = $("btnSave"), btnDelete = $("btnDelete");

    if(storiesPrev && storiesGrid) storiesPrev.onclick = () => storiesGrid.scrollBy({left:-100, behavior:'smooth'});
    if(storiesNext && storiesGrid) storiesNext.onclick = () => storiesGrid.scrollBy({left:100, behavior:'smooth'});

    let STORAGE = null;
    let POSTS = []; // {id,dateISO,desc,mediaUrls:[...],thumbUrl,type,status,target,createdAt}
    let coverInput = null;
    let coverUploading = false;

    function ensureCoverInput(){
      if(coverInput) return coverInput;
      coverInput = document.createElement('input');
      coverInput.type = 'file';
      coverInput.accept = 'image/*';
      coverInput.style.display = 'none';
      coverInput.id = 'coverUploadInput';
      document.body.appendChild(coverInput);
      coverInput.addEventListener('change', ()=>{
        const file = coverInput.files?.[0] || null;
        const postId = coverInput.getAttribute('data-post-id');
        coverInput.value = '';
        coverInput.removeAttribute('data-post-id');
        if(file && postId){ uploadCoverImage(postId, file); }
      });
      return coverInput;
    }

    function promptCoverUpload(postId){
      if(!postId) return;
      const input = ensureCoverInput();
      input.setAttribute('data-post-id', postId);
      input.click();
    }

    async function uploadCoverImage(postId, file){
      if(!file) return;
      if(coverUploading) return;
      try{
        if(!(file.type||'').toLowerCase().startsWith('image/')){
          alert('Selecione uma imagem para a capa.');
          return;
        }
        const uid = auth.currentUser?.uid;
        if(!uid){
          alert('Fa√ßa login para enviar a capa.');
          return;
        }
        const post = POSTS.find(p=>p.id===postId);
        if(!post){
          alert('Post n√£o encontrado.');
          return;
        }
        const safeTenant = (typeof TENANT!=="undefined" && TENANT) ? TENANT : null;
        if(!safeTenant || safeTenant === 'no-client'){
          alert('Cliente n√£o definido na URL.');
          return;
        }
        if(!STORAGE){
          try{ STORAGE = getStorage(app); }
          catch(err){ console.error(err); alert('Storage n√£o inicializado.'); return; }
        }
        coverUploading = true;
        const safeName = (file.name||'cover').replace(/[^a-zA-Z0-9._-]/g,'_');
        const path = `users/${uid}/tenant-${safeTenant}/posts/${postId}/cover_${Date.now()}_${safeName}`;
        const ref = sRef(STORAGE, path);
        await uploadBytes(ref, file);
        const url = await getDownloadURL(ref);
        const coverSize = Number(file?.size);
        const coverMeta = {
          path,
          size: Number.isFinite(coverSize) && coverSize > 0 ? coverSize : null,
          contentType: file?.type || ''
        };
        await updateDoc(doc(db, 'usuarios', uid, 'posts', postId), {
          thumbUrl: url,
          coverMeta,
          updatedAt: serverTimestamp()
        });
        post.thumbUrl = url;
        post.coverMeta = coverMeta;
        if(selectedPost && selectedPost.id===postId){
          selectedPost.thumbUrl = url;
          selectedPost.coverMeta = coverMeta;
        }
        if(typeof mgToast === 'function'){
          mgToast('Capa atualizada!');
        }
        renderCalendarDays();
        renderPlanilha();
        await refreshStorageUsage();
      }catch(err){
        console.error('uploadCoverImage', err);
        alert('Falha ao enviar capa: ' + (err?.message || String(err)));
      }finally{
        coverUploading = false;
      }
    }
    let postsUnsub = null;

    // === Gera√ß√£o autom√°tica de thumbnails para v√≠deos ===
    const VIDEO_THUMBNAILS_CACHE = new Map(); // Cache de thumbnails geradas

    async function generateVideoThumbnail(videoUrl, postId) {
      console.log('[GenerateThumbnail] Iniciando para:', videoUrl);
      
      // URL inv√°lida: n√£o tenta carregar para evitar erros de m√≠dia
      if (!videoUrl || typeof videoUrl !== 'string' || videoUrl.trim() === '') {
        return null;
      }

      // Verifica se j√° tem no cache
      if (VIDEO_THUMBNAILS_CACHE.has(videoUrl)) {
        console.log('[GenerateThumbnail] Retornando do cache');
        return VIDEO_THUMBNAILS_CACHE.get(videoUrl);
      }

      // Fun√ß√£o de limpeza segura para evitar 'Empty src attribute'
      const releaseVideo = (video) => {
        try { video.onerror = null; video.onseeked = null; video.onloadedmetadata = null; } catch(_) {}
        try { video.pause?.(); } catch(_) {}
        try { video.removeAttribute('src'); video.load?.(); } catch(_) {}
      };

      return new Promise((resolve) => {
        const video = document.createElement('video');
        video.crossOrigin = 'anonymous';
        video.preload = 'metadata';
        video.muted = true;
        video.playsInline = true;
        
        console.log('[GenerateThumbnail] Video element criado');
        
        // Timeout de seguran√ßa
        const timeout = setTimeout(() => {
          // Evita spam de erro no console; apenas retorna null
          releaseVideo(video);
          resolve(null);
        }, 10000);

        video.onloadedmetadata = () => {
          try {
            // Vai para 0.5 segundo ou 10% do v√≠deo
            const seekTime = Math.min(0.5, Math.max(0, Number(video.duration) || 0) * 0.1);
            video.currentTime = seekTime;
          } catch(_) {
            // Falha ao buscar: retorna silenciosamente
            clearTimeout(timeout);
            releaseVideo(video);
            resolve(null);
          }
        };
        
        video.onseeked = () => {
          try {
            clearTimeout(timeout);
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 360;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const thumbnailDataUrl = canvas.toDataURL('image/jpeg', 0.7);
            // Adiciona ao cache
            VIDEO_THUMBNAILS_CACHE.set(videoUrl, thumbnailDataUrl);
            // Limpa o v√≠deo sem disparar erro de m√≠dia
            releaseVideo(video);
            resolve(thumbnailDataUrl);
          } catch (_) {
            clearTimeout(timeout);
            releaseVideo(video);
            resolve(null);
          }
        };
        
        video.onerror = () => {
          clearTimeout(timeout);
          // N√£o loga erro nem rejeita para evitar spam
          releaseVideo(video);
          resolve(null);
        };
        
        try {
          video.src = videoUrl;
        } catch(_) {
          clearTimeout(timeout);
          releaseVideo(video);
          resolve(null);
        }
      });
    }

    // Fun√ß√£o para aplicar thumbnails em elementos de v√≠deo no DOM
    function applyVideoThumbnails() {
      const videoContainers = document.querySelectorAll('.cal-thumb[data-video-url], .feed-item[data-video-url], .story-item[data-video-url], .relatorio-story-item[data-video-url]');
      
      console.log('[Thumbnails] Encontrados', videoContainers.length, 'v√≠deos para processar');
      
      videoContainers.forEach(async (container) => {
        const videoUrl = container.getAttribute('data-video-url');
        const postId = container.getAttribute('data-id');
        if (!videoUrl || typeof videoUrl !== 'string' || videoUrl.trim() === '') {
          console.log('[Thumbnails] Container sem videoUrl v√°lido:', container);
          return;
        }
        if (container.querySelector('img')) {
          console.log('[Thumbnails] J√° tem thumbnail:', videoUrl);
          return; // J√° tem thumbnail
        }
        console.log('[Thumbnails] Gerando thumbnail para:', videoUrl);
        try {
          const thumbnailUrl = await generateVideoThumbnail(videoUrl, postId);
          if (!thumbnailUrl) {
            console.log('[Thumbnails] Thumbnail n√£o gerada para videoUrl inv√°lido:', videoUrl);
            return;
          }
          console.log('[Thumbnails] Thumbnail gerada com sucesso:', thumbnailUrl.substring(0, 50) + '...');
          // Verifica se ainda est√° na p√°gina e n√£o foi substitu√≠do
          if (container.getAttribute('data-video-url') === videoUrl) {
            const img = document.createElement('img');
            img.src = thumbnailUrl;
            img.alt = 'Video preview';
            img.crossOrigin = 'anonymous';
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'cover';
            // Remove o span "V" e adiciona a imagem
            const span = container.querySelector('span');
            if (span) span.remove();
            container.appendChild(img);
            console.log('[Thumbnails] Thumbnail aplicada ao container');
          }
        } catch (err) {
          console.error('[Thumbnails] Falha ao gerar thumbnail para:', videoUrl, err);
          // Mant√©m o "V" como fallback
        }
      });
    }
    // Expor applyVideoThumbnails globalmente
    window.applyVideoThumbnails = applyVideoThumbnails;
    
    let currentMonth = (()=>{ const d=new Date(); return new Date(d.getFullYear(), d.getMonth(), 1); })();
    let selectedPost = null;
    const COMMEMORATIVE_DATES_BR = window.COMMEMORATIVE_DATES_BR || {};
    const COMMEMORATIVE_DATES_US = window.COMMEMORATIVE_DATES_US || {};
    let CAL_NOTES = {};
    let calNotesUnsub = null;
// === Estado do carrossel (aprova√ß√£o slide a slide) ===
let SLIDE_IDX = 0;
let SLIDES = []; // array de URLs da m√≠dia do post
let APPROVED_CLIENT_SET = new Set(); // √≠ndices aprovados pelo cliente
let APPROVED_INTERNAL_SET = new Set(); // √≠ndices aprovados pelo time interno
let REVIEWED_SET = new Set();  // √≠ndices revisados (carregados de Firestore)


    function ensureCalendar(){
      if(!STORAGE){ try{ STORAGE = getStorage(app); }catch(_){ /* ignore */ } }
      if(!postsUnsub){ subscribePosts(); }
      if(!calNotesUnsub){ subscribeCalNotes(); }
      renderCalendarStatic();
      renderCalendarDays();
      renderPlanilha();
    }

    function monthLabel(d){
      const names = ["janeiro","fevereiro","mar√ßo","abril","maio","junho","julho","agosto","setembro","outubro","novembro","dezembro"];
      return `${names[d.getMonth()].slice(0,1).toUpperCase()}${names[d.getMonth()].slice(1)} ${d.getFullYear()}`;
    }
    function localDateISO(d){
      const z = new Date(d.getTime() - d.getTimezoneOffset()*60000);
      return z.toISOString().slice(0,10);
    }
    function daysInMonth(year, month){ return new Date(year, month+1, 0).getDate(); }

    function renderCalendarStatic(){
      if(!calWeekdays) return;
      calWeekdays.innerHTML = ["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"].map((w, idx)=>`<div class="cal-weekday${(idx===0||idx===6)?' weekend':''}">${w}</div>`).join("");
      calPrev.onclick = ()=>{ currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()-1, 1); renderCalendarDays(); };
      calNext.onclick = ()=>{ currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()+1, 1); renderCalendarDays(); };
      calFilterStatus.onchange = ()=>{ renderCalendarDays(); renderPlanilha(); };
      calFilterCountry.onchange = ()=>{ renderCalendarDays(); };
      calFilterText.oninput = ()=>{ renderCalendarDays(); };
    }

    function postsByDateMap(){
      const map = new Map();
      const filt = (calFilterStatus?.value||"").trim();
      POSTS.forEach(p=>{
        if(filt && p.status !== filt) return;
        const list = map.get(p.dateISO) || [];
        list.push(p); map.set(p.dateISO, list);
      });
      return map;
    }

    function renderCalendarDays(){
      console.log("[Calendar] renderCalendarDays() chamado");
      if(!calDays) return;
      calTitle.textContent = monthLabel(currentMonth);
      const y = currentMonth.getFullYear(), m = currentMonth.getMonth();
      const monthKey = buildMonthKey(y, m+1);
      const todayISO = localDateISO(new Date());
      const firstDay = new Date(y, m, 1);
      const startWeekday = (firstDay.getDay() + 7) % 7; // 0=Sun
      const totalDays = daysInMonth(y,m);
      const prevPad = startWeekday;
      const totalCells = Math.ceil((prevPad + totalDays) / 7) * 7;

      const map = postsByDateMap();
      const demandaMap = new Map();
      if(Array.isArray(DEMANDAS)){
        DEMANDAS.forEach(d=>{
          normalizeDemanda(d);
          const entries = getDemandaCalendarEntries(d);
          entries.forEach(entry=>{
            if(!entry?.dateKey) return;
            const list = demandaMap.get(entry.dateKey) || [];
            list.push(entry);
            demandaMap.set(entry.dateKey, list);
          });
        });
        demandaMap.forEach(list=>{
          list.sort((a,b)=>{
            const diff = getDemandaEntryTime(a) - getDemandaEntryTime(b);
            if(diff !== 0) return diff;
            const nameA = (a?.demanda?.demanda || '').toLowerCase();
            const nameB = (b?.demanda?.demanda || '').toLowerCase();
            return nameA.localeCompare(nameB);
          });
        });
      }
      const esc = s => s.replace(/[&<>]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
      const cells = [];
      const country = (calFilterCountry?.value||"").trim();
      const textFilter = (calFilterText?.value||"").trim().toLowerCase();
      for(let i=0;i<totalCells;i++){
        const dayNum = i - prevPad + 1;
        const inMonth = dayNum>=1 && dayNum<=totalDays;
        const weekday = i % 7;
        const isWeekend = weekday === 0 || weekday === 6;
        const date = inMonth ? new Date(y,m,dayNum) : null;
        const iso = inMonth ? localDateISO(date) : "";
        const isToday = iso === todayISO;
        const items = inMonth ? (map.get(iso) || []) : [];
        const demandas = inMonth ? (demandaMap.get(iso) || []) : [];
        let holidays = [];
        if(inMonth && country){
          if(country === 'BR') holidays = COMMEMORATIVE_DATES_BR[iso] || [];
          else if(country === 'US') holidays = COMMEMORATIVE_DATES_US[iso] || [];
          if(textFilter) holidays = holidays.filter(h=>h.toLowerCase().includes(textFilter));
        }
        const cellClasses = ['cal-cell'];
        if(isWeekend) cellClasses.push('weekend');
        if(inMonth){
          if(isToday) cellClasses.push('today');
        }else{
          cellClasses.push('out');
        }
        const holidayHtml = holidays.map(h=>`<div>${esc(h)}</div>`).join("");
        const thumbs = items.map(post => {
          let cls = "cal-thumb";
          if(post.status === "aprovado"){
            cls += post.approvedBy === 'interno' ? " aprovado-interno" : " aprovado";
          }else if(post.status === "revisar"){
            cls += " revisar";
          }
          const first = (post.thumbUrl || post.mediaUrls?.[0] || "");
          const ext = first.split("?")[0].split(".").pop().toLowerCase();
          const isVideo = ["mp4","mov","webm","m4v","avi"].includes(ext);
          const label = post.type==="carousel" ? "C" : (isVideo ? "V" : "");
          if(first){
            if(isVideo){
              // Se j√° tem thumbUrl personalizada (capa), usa ela
              if(post.thumbUrl && !post.thumbUrl.includes('.mp4') && !post.thumbUrl.includes('.mov') && !post.thumbUrl.includes('.webm')) {
                return `<div class="${cls}" data-id="${post.id}" title="${(post.desc||'').replace(/"/g,'&quot;')}"><img src="${post.thumbUrl}" alt="" crossorigin="anonymous"></div>`;
              }
              // Sen√£o, renderiza com data-video-url para gerar thumbnail autom√°tica
              return `<div class="${cls}" data-id="${post.id}" data-video-url="${first}" title="${(post.desc||'').replace(/"/g,'&quot;')}"><span>${label||"V"}</span></div>`;
            }else{
              return `<div class="${cls}" data-id="${post.id}" title="${(post.desc||'').replace(/"/g,'&quot;')}"><img src="${first}" alt="" crossorigin="anonymous"></div>`;
            }
          }else{
            return `<div class="${cls}" data-id="${post.id}" title="${(post.desc||'').replace(/"/g,'&quot;')}"><span>${label||"+"}</span></div>`;
          }
        }).join("");

        const demandasHtml = inMonth ? renderCalendarDemandaItems(demandas, esc, textFilter) : '';
        const note = inMonth ? esc(CAL_NOTES[iso] || '') : '';
        cells.push(`
          <div class="${cellClasses.join(' ')}" data-iso="${iso}">
            ${inMonth?`<div class="daynum">${dayNum}</div>`:''}
            ${holidayHtml?`<div class="cal-holidays">${holidayHtml}</div>`:''}
            <div class="cal-items">${thumbs}</div>
            ${demandasHtml}
            ${inMonth?`<textarea class="cal-note">${note}</textarea>`:''}
          </div>`);
      }
      calDays.innerHTML = cells.join("");
      renderCalendarMobileDemandas(demandaMap, esc, textFilter, monthKey);
      calDays.querySelectorAll('.cal-note').forEach(el=>{
        const iso = el.closest('.cal-cell')?.getAttribute('data-iso');
        el.value = CAL_NOTES[iso] || '';
        const h = ()=> saveCalNote(el);
        el.addEventListener('change', h);
        el.addEventListener('blur', h);
      });

      // Bind clicks
      calDays.querySelectorAll(".cal-thumb").forEach(el=>{
        el.addEventListener("click",()=>{
          const id = el.getAttribute("data-id");
          const post = POSTS.find(p=>p.id===id);
          if(post) openPostModal(post);
        });
      });

      // Gera thumbnails autom√°ticas para v√≠deos
      console.log('[Calendar] Agendando applyVideoThumbnails em 100ms');
      setTimeout(() => {
        console.log("[Calendar] Executando applyVideoThumbnails agora");
        try { if (typeof applyVideoThumbnails !== "undefined") applyVideoThumbnails(); else if (typeof window.applyVideoThumbnails !== "undefined") window.applyVideoThumbnails(); } catch(_e) {}
      }, 100);
    }

    function renderPlanilha(){
      if(!feedGrid && !storiesGrid) return;
      let items = [...POSTS];
      const filt = (calFilterStatus?.value||"").trim();
      if(filt){ items = items.filter(p=>p.status===filt); }
      items.sort((a,b)=> (a.dateISO<b.dateISO?1:a.dateISO>b.dateISO?-1: (b.updatedAt||0)-(a.updatedAt||0)));

      const feedItems = items.filter(p=> (p.target||"feed") !== "stories");
      if(feedGrid){
        feedGrid.innerHTML = feedItems.map(p=>{
          const first = p.thumbUrl || p.mediaUrls?.[0] || "";
          const ext = first.split("?")[0].split(".").pop().toLowerCase();
          const isVideo = ["mp4","mov","webm","m4v","avi"].includes(ext);
          const label = p.type==="carousel" ? "C" : (isVideo ? "V" : "");
          const showCoverBtn = (p.type === 'video');
          const coverBtn = showCoverBtn ? `<button class="cover-upload-btn" type="button" data-id="${p.id}">üì∑ Capa</button>` : "";
          let cls = "feed-item";
          if(p.status === "aprovado"){
            cls += p.approvedBy === 'interno' ? " aprovado-interno" : " aprovado";
          }else if(p.status === "revisar"){
            cls += " revisar";
          }else{
            cls += " pendente";
          }
          if(first){
            if(isVideo){
              // Se j√° tem thumbUrl personalizada (capa), usa ela
              if(p.thumbUrl && !p.thumbUrl.includes('.mp4') && !p.thumbUrl.includes('.mov') && !p.thumbUrl.includes('.webm')) {
                return `<div class="${cls}" data-id="${p.id}">${coverBtn}<img src="${p.thumbUrl}" alt="" crossorigin="anonymous"></div>`;
              }
              // Sen√£o, renderiza com data-video-url para gerar thumbnail autom√°tica
              return `<div class="${cls}" data-id="${p.id}" data-video-url="${first}">${coverBtn}<span>${label||"V"}</span></div>`;
            }else{
              return `<div class="${cls}" data-id="${p.id}">${coverBtn}<img src="${first}" alt="" crossorigin="anonymous"></div>`;
            }
          }else{
            return `<div class="${cls}" data-id="${p.id}">${coverBtn}<span>${label||"+"}</span></div>`;
          }
        }).join("");
        feedGrid.querySelectorAll(".feed-item").forEach(el=>{
          el.addEventListener("click",()=>{
            const id = el.getAttribute("data-id");
            const post = POSTS.find(p=>p.id===id);
            if(post) openPostModal(post);
          });
        });
        feedGrid.querySelectorAll('.cover-upload-btn').forEach(btn=>{
          if(btn.dataset.coverBound === '1') return;
          btn.dataset.coverBound = '1';
          btn.addEventListener('click', ev=>{
            ev.stopPropagation();
            const id = btn.getAttribute('data-id');
            if(id) promptCoverUpload(id);
          });
        });
      }

      if(storiesGrid){
        const storyItems = items.filter(p=> (p.target||"feed") === "stories");
        storiesGrid.innerHTML = storyItems.map(p=>{
          const first = p.thumbUrl || p.mediaUrls?.[0] || "";
          const ext = first.split("?")[0].split(".").pop().toLowerCase();
          const isVideo = ["mp4","mov","webm","m4v","avi"].includes(ext);
          const label = p.type==="carousel" ? "C" : (isVideo ? "V" : "");
          const showCoverBtn = (p.type === 'video');
          const coverBtn = showCoverBtn ? `<button class="cover-upload-btn" type="button" data-id="${p.id}">üì∑ Capa</button>` : "";
          let cls = "story-item";
          if(p.status === "aprovado"){
            cls += p.approvedBy === 'interno' ? " aprovado-interno" : " aprovado";
          }else if(p.status === "revisar"){
            cls += " revisar";
          }else{
            cls += " pendente";
          }
          const [y,m,d] = (p.dateISO||'').split('-');
          const dateLabel = d && m ? `${d}/${m}` : '';
          if(first){
            if(isVideo){
              // Se j√° tem thumbUrl personalizada (capa), usa ela
              if(p.thumbUrl && !p.thumbUrl.includes('.mp4') && !p.thumbUrl.includes('.mov') && !p.thumbUrl.includes('.webm')) {
                return `<div class="${cls}" data-id="${p.id}">${coverBtn}<img src="${p.thumbUrl}" alt="" crossorigin="anonymous"><div class="story-date">${dateLabel}</div></div>`;
              }
              // Sen√£o, renderiza com data-video-url para gerar thumbnail autom√°tica
              return `<div class="${cls}" data-id="${p.id}" data-video-url="${first}">${coverBtn}<span>${label||"V"}</span><div class="story-date">${dateLabel}</div></div>`;
            }else{
              return `<div class="${cls}" data-id="${p.id}">${coverBtn}<img src="${first}" alt="" crossorigin="anonymous"><div class="story-date">${dateLabel}</div></div>`;
            }
          }else{
            return `<div class="${cls}" data-id="${p.id}">${coverBtn}<span>${label||"+"}</span><div class="story-date">${dateLabel}</div></div>`;
          }
        }).join("");
        storiesGrid.querySelectorAll(".story-item").forEach(el=>{
          el.addEventListener("click",()=>{
            const id = el.getAttribute("data-id");
            const post = POSTS.find(p=>p.id===id);
            if(post) openPostModal(post);
          });
        });
        storiesGrid.querySelectorAll('.cover-upload-btn').forEach(btn=>{
          if(btn.dataset.coverBound === '1') return;
          btn.dataset.coverBound = '1';
          btn.addEventListener('click', ev=>{
            ev.stopPropagation();
            const id = btn.getAttribute('data-id');
            if(id) promptCoverUpload(id);
          });
        });

      // Gera thumbnails autom√°ticas para v√≠deos no feed e stories
      setTimeout(() => applyVideoThumbnails(), 150);
      }
    }

    async function saveCalNote(el){
      const iso = el.closest('.cal-cell')?.getAttribute('data-iso');
      const uid = auth.currentUser?.uid;
      if(!iso || !uid) return;
      const clientKey = (typeof window.TENANT === 'string' && window.TENANT)
        || document.body.getAttribute('data-client-id');
      if (!clientKey || clientKey === 'no-client') {
        console.warn('Cliente n√£o definido na URL.');
        return;
      }
      const note = el.value.trim();
      const ref = doc(db, 'usuarios', uid, 'clients', clientKey, 'calendarNotes', iso);
      try{
        if(note){
          await setDoc(ref, { note, updatedAt: Date.now() }, { merge:true });
        }else{
          await deleteDoc(ref);
        }
      }catch(err){ console.error('saveCalNote', err); }
    }

    function subscribeCalNotes(){
      const uid = auth.currentUser?.uid;
      if(!uid) return;
      const clientKey = (typeof window.TENANT === 'string' && window.TENANT)
        || document.body.getAttribute('data-client-id');
      if (!clientKey || clientKey === 'no-client') {
        console.warn('Cliente n√£o definido na URL.');
        return;
      }
      try{ calNotesUnsub && calNotesUnsub(); }catch(_){ }
      const col = collection(db, 'usuarios', uid, 'clients', clientKey, 'calendarNotes');
      calNotesUnsub = onSnapshot(col, snap=>{
        CAL_NOTES = {};
        snap.forEach(docSnap=>{
          const d = docSnap.data() || {};
          if(d.note) CAL_NOTES[docSnap.id] = d.note;
        });
        renderCalendarDays();
        refreshStorageUsage();
      }, err=> console.error('onSnapshot calNotes', err));
    }

    function subscribePosts(){
      const uid = auth.currentUser?.uid; if(!uid) return;
      try{ postsUnsub && postsUnsub(); }catch(_){}
      const col = collection(db, "usuarios", uid, "posts");
      const qy = query(col, orderBy("dateISO","asc")); // sem √≠ndice composto
      postsUnsub = onSnapshot(qy, snap=>{
        POSTS = [];
        snap.forEach(docSnap => {
          const d = docSnap.data() || {};
          POSTS.push({
            id: docSnap.id,
            dateISO: d.dateISO||"",
            desc: d.desc||"",
            mediaUrls: d.mediaUrls||[],
            thumbUrl: d.thumbUrl||"",
            type: d.type||"",
            status: d.status||"pendente",
            target: d.target||"feed",
            reviewNotes: d.reviewNotes||[],
            approvedSlides: d.approvedSlides||[],
            internalApprovedSlides: d.internalApprovedSlides||[],
            approvedBy: d.approvedBy||"",
            createdAt: d.createdAt?.toMillis?.()||0,
            updatedAt: d.updatedAt?.toMillis?.()||0,
            mediaMeta: Array.isArray(d.mediaMeta) ? d.mediaMeta : [],
            coverMeta: d.coverMeta && typeof d.coverMeta === 'object' ? d.coverMeta : null,
            tenant: d.tenant || '',
            googleEventId: d.googleEventId || ''
          });
        });
        renderCalendarDays();
        renderPlanilha();
        refreshStorageUsage();
        try{ refreshMacroInsights(); }catch(_){ }
        if(window.googleCalendarIntegration){
          window.googleCalendarIntegration.notifyPostsLoaded(POSTS);
        }
        try{ scheduleNotificationRefresh({ immediate: true }); }catch(_err){}
      }, err=> console.error("onSnapshot posts", err));
    }

    async function handleUpload(){
      const btn = calUpload;
      try{
        const uid = auth.currentUser?.uid; if(!uid) return alert("Fa√ßa login.");
        const dateISO = (calDate.value||"").trim() || localDateISO(new Date());
        const desc = (calDesc.value||"").trim();
        const target = (calTarget.value||"feed");
        const files = calFiles.files;
        if(!files || files.length===0) return alert("Selecione ao menos 1 m√≠dia.");

        // whitelist de formatos
        const okExt = ["jpg","jpeg","png","mp4","mov"];
        for(let i=0;i<files.length;i++){
          const f = files[i];
          const ext = (f.name.split(".").pop()||"").toLowerCase();
          const mime = (f.type||"").toLowerCase();
          const isImage = mime.startsWith("image/");
          const isVideo = mime.startsWith("video/");
          if(!okExt.includes(ext) || (!isImage && !isVideo)){
            return alert("Formato n√£o suportado. Use JPG, JPEG, PNG, MP4 ou MOV.");
          }
        }

        if(!db) return alert("Banco de dados n√£o inicializado.");
        if(!STORAGE){ try{ STORAGE = getStorage(app); }catch(e){ console.error(e); return alert("Storage n√£o inicializado."); } }

        btn && (btn.disabled=true, btn.textContent="Enviando...");
        const safeTenant = (typeof TENANT!=="undefined" && TENANT) ? TENANT : null;
        if (!safeTenant || safeTenant === 'no-client') {
          console.warn('Cliente n√£o definido na URL.');
          btn && (btn.disabled=false, btn.textContent='Enviar');
          return;
        }
        const col = collection(db, "usuarios", uid, "posts");
        const newRef = await addDoc(col, { dateISO, desc, mediaUrls: [], thumbUrl: "", type: files.length>1 ? "carousel" : guessType(files[0]?.name||""), status: "pendente", target, createdAt: serverTimestamp(), updatedAt: serverTimestamp(), tenant: safeTenant });

        const urls = [];
        const mediaMeta = [];
        let thumb = "";
        for(let i=0;i<files.length;i++){
          const f = files[i];
          const safe = (f.name||'file').replace(/[^a-zA-Z0-9._-]/g,'_');
          const path = `users/${uid}/tenant-${safeTenant}/posts/${newRef.id}/${Date.now()}_${safe}`;
          const r = sRef(STORAGE, path);
          await uploadBytes(r, f);
          const url = await getDownloadURL(r);
          urls.push(url);
          const sizeValue = Number(f?.size);
          mediaMeta.push({
            path,
            size: Number.isFinite(sizeValue) && sizeValue > 0 ? sizeValue : null,
            contentType: f?.type || ''
          });
          if(!thumb) thumb = url;
        }
        await updateDoc(newRef, { mediaUrls: urls, thumbUrl: thumb, mediaMeta, updatedAt: serverTimestamp() });
        if(window.googleCalendarIntegration){
          const newPost = {
            id: newRef.id,
            dateISO,
            desc,
            target,
            status: 'pendente',
            googleEventId: '',
            tenant: safeTenant
          };
          try{ await window.googleCalendarIntegration.handlePostCreated(newPost); }
          catch(err){ console.warn('googleCalendarIntegration.handlePostCreated', err); }
        }
        sendWebhook('calendar', { action:'upload', id: newRef.id, dateISO, desc, target, mediaUrls: urls, thumbUrl: thumb });
        calFiles.value=""; calDesc.value=""; if(calTarget) calTarget.value="feed";
        alert("Post cadastrado!");
        await refreshStorageUsage();
      }catch(e){
        console.error("upload error", e);
        const msg = (e && (e.message||e.code)) ? (e.message||e.code) : String(e);
        alert("Falha no upload: "+ msg);
      }finally{
        btn && (btn.disabled=false, btn.textContent="Enviar");
      }
    }
    function guessType(name){
      const ext = (name.split(".").pop()||"").toLowerCase();
      if(["mp4","mov","webm","m4v","avi"].includes(ext)) return "video";
      return "image";
    }

    function openPostModal(post){
      selectedPost = post;
      SLIDES = Array.isArray(post.mediaUrls) && post.mediaUrls.length ? post.mediaUrls.slice() : [post.thumbUrl || (post.mediaUrls?.[0]||"")];
      SLIDE_IDX = 0;
      APPROVED_CLIENT_SET = new Set(Array.isArray(post.approvedSlides)? post.approvedSlides : []);
      APPROVED_INTERNAL_SET = new Set(Array.isArray(post.internalApprovedSlides)? post.internalApprovedSlides : []);
      REVIEWED_SET = new Set(Array.isArray(post.reviewedSlides)? post.reviewedSlides : (Array.isArray(post.reviewNotes)? post.reviewNotes.map(n=> Number.isInteger(n.slide)? n.slide : null).filter(n=> Number.isInteger(n)) : []));
      selectedPost.approvedSlides = Array.from(APPROVED_CLIENT_SET);
      selectedPost.internalApprovedSlides = Array.from(APPROVED_INTERNAL_SET);

      modalTitle.textContent = post.desc ? (post.desc.slice(0,60)+(post.desc.length>60?"‚Ä¶":"")) : "Post";
      modalDate.textContent = post.dateISO || "";
      modalDesc.value = post.desc || "";
      if(modalTarget) modalTarget.value = post.target || "feed";
      if(modalTarget) modalTarget.value = post.target || "feed";
      setModalStatus(post.status||"pendente");

      function renderSlide(){
        const url = SLIDES[SLIDE_IDX] || "";
        const ext = (url.split("?")[0].split(".").pop()||"").toLowerCase();
        const isVideo = ["mp4","mov","webm","m4v","avi"].includes(ext);
        const hasMany = SLIDES.length > 1;
        let arrows = hasMany ? `<div class="pv-arrow left" id="pvLeft">‚Äπ</div><div class="pv-arrow right" id="pvRight">‚Ä∫</div>` : "";
        const approvals = [];
        if(APPROVED_CLIENT_SET.has(SLIDE_IDX)) approvals.push('cliente');
        if(APPROVED_INTERNAL_SET.has(SLIDE_IDX)) approvals.push('time interno');
        const approvalInfo = approvals.length ? `‚úîÔ∏è aprovado (${approvals.join(' + ')})` : '';
        modalPreview.innerHTML = `<div class="pv-stage"><div class="pv-media">${isVideo?`<video src="${url}" controls playsinline crossorigin="anonymous"></video>`:`<img src="${url}" alt="" crossorigin="anonymous">`}</div>${arrows}</div><div class=\"muted\" style=\"margin-top:6px;display:flex;justify-content:space-between\"><span>Item ${SLIDE_IDX+1}/${SLIDES.length}</span><span>${approvalInfo}</span></div>`;
        modalPreview.classList.toggle('pv-has-many', hasMany);
        // render historic only on first slide
        const cn = document.getElementById('clientNotesList');
        if(cn){ if(SLIDE_IDX===0){ cn.style.display='block'; renderClientNotesInCard(selectedPost); } else { cn.style.display='none'; } }
        // bind arrows
        const L = document.getElementById("pvLeft"), R = document.getElementById("pvRight");
        if(L) L.onclick = ()=>{ SLIDE_IDX = (SLIDE_IDX>0? SLIDE_IDX-1 : 0); renderSlide(); syncApproveButtons(); };
        if(R) R.onclick = ()=>{ SLIDE_IDX = (SLIDE_IDX<SLIDES.length-1? SLIDE_IDX+1 : SLIDE_IDX); renderSlide(); syncApproveButtons(); };
        syncApproveButtons();
      }

      function syncApproveButtons(){
        const total = SLIDES.length;
        if(btnApprove){
          const aprovados = APPROVED_CLIENT_SET.size;
          if(APPROVED_CLIENT_SET.has(SLIDE_IDX)){
            btnApprove.textContent = `Cliente aprovou (${aprovados}/${total})`;
            btnApprove.disabled = true;
          }else{
            const nextCount = aprovados + 1;
            const lastPending = (nextCount===total);
            btnApprove.textContent = lastPending? `Cliente aprovar e finalizar (${nextCount}/${total})` : `Cliente aprovar (${nextCount}/${total})`;
            btnApprove.disabled = false;
          }
        }
        if(btnApproveInternal){
          const aprovadosInternos = APPROVED_INTERNAL_SET.size;
          const internalComplete = ((aprovadosInternos >= total) && total>0) || selectedPost?.approvedBy === 'interno';
          if(APPROVED_INTERNAL_SET.has(SLIDE_IDX)){
            btnApproveInternal.textContent = `Time interno aprovou (${aprovadosInternos}/${total})`;
            btnApproveInternal.disabled = true;
          }else{
            const nextInternal = aprovadosInternos + 1;
            const lastInternal = (nextInternal===total);
            btnApproveInternal.textContent = lastInternal? `Aprova√ß√£o interna e finalizar (${nextInternal}/${total})` : `Aprova√ß√£o interna (${nextInternal}/${total})`;
            btnApproveInternal.disabled = false;
          }
          btnApproveInternal.classList.toggle('btn-interno-concluido', internalComplete);
        }
      }

      // exp√µe helpers dentro do escopo
      openPostModal._renderSlide = renderSlide;
      openPostModal._syncApproveButtons = syncApproveButtons;

      renderSlide();
      postModal.classList.add("show"); postModal.setAttribute("aria-hidden","false");
      renderReviewNotes(post);
      renderClientNotesPanel(post);
    }
    function closePostModal(){ postModal.classList.remove("show"); postModal.setAttribute("aria-hidden","true"); selectedPost=null; }
    modalClose.onclick = closePostModal;
    postModal.addEventListener("click",(e)=>{ if(e.target===postModal) closePostModal(); });

    function setModalStatus(s){
      modalStatus.textContent = s;
      const approvedBy = selectedPost?.approvedBy || "";
      const statusClass = s === "aprovado"
        ? (approvedBy === "interno" ? "status-aprovado-interno" : "status-aprovado")
        : (s === "revisar" ? "status-revisar" : "status-pendente");
      modalStatus.className = "status-pill " + statusClass;
    }

    async function updatePostStatus(post, status){
      try{
        const uid = auth.currentUser?.uid; if(!uid) return;
        const ref = doc(db, "usuarios", uid, "posts", post.id);
        await updateDoc(ref, { status, updatedAt: serverTimestamp() });
        if(status === 'aprovado' || status === 'revisar'){
          const payload = { action:'status', id: post.id, status };
          if(status === 'revisar'){
            payload.dateISO = post.dateISO || '';
            payload.postName = post.desc || '';
            payload.postDesc = post.desc || '';
            payload.reviewNotes = Array.isArray(post.reviewNotes) ? post.reviewNotes.map(n => n.text) : [];
          }
          sendWebhook('calendar', payload);
        }
        post.status = status;
        if(selectedPost && selectedPost.id===post.id){ setModalStatus(status); }
        if(window.googleCalendarIntegration){
          try{ await window.googleCalendarIntegration.handlePostUpdated(post); }
          catch(err){ console.warn('googleCalendarIntegration.handlePostUpdated', err); }
        }
      }catch(e){ console.error(e); alert("Falha ao atualizar status: "+(e.message||String(e))); }
    }
    async function savePostMeta(post, desc, target){
      try{
        const uid = auth.currentUser?.uid; if(!uid) return;
        const ref = doc(db, "usuarios", uid, "posts", post.id);
        await updateDoc(ref, { desc: desc||"", target: target||"feed", updatedAt: serverTimestamp() });
        post.desc = desc||"";
        post.target = target||"feed";
        if(window.googleCalendarIntegration){
          try{ await window.googleCalendarIntegration.handlePostUpdated(post); }
          catch(err){ console.warn('googleCalendarIntegration.handlePostUpdated', err); }
        }
      }catch(e){ console.error(e); alert("Falha ao salvar: "+(e.message||String(e))); }
    }
    async function deletePost(post){
      if(!confirm("Excluir este post?")) return;
      try{
        const uid = auth.currentUser?.uid; if(!uid) return;
        const ref = doc(db, "usuarios", uid, "posts", post.id);
        if(window.googleCalendarIntegration){
          try{ await window.googleCalendarIntegration.handlePostDeleted(post); }
          catch(err){ console.warn('googleCalendarIntegration.handlePostDeleted', err); }
        }
        await deleteDoc(ref);
        if(selectedPost?.id===post.id) closePostModal();
      }catch(e){ console.error(e); alert("Falha ao excluir: "+(e.message||String(e))); }
    }

    async function approveSlide(kind){
      if(!selectedPost) return;
      try{
        const uid = auth.currentUser?.uid; if(!uid) return;
        const ref = doc(db, "usuarios", uid, "posts", selectedPost.id);
        const payload = { updatedAt: serverTimestamp() };
        const isInternal = kind === 'interno';
        if(isInternal){
          payload.internalApprovedSlides = arrayUnion(SLIDE_IDX);
        }else{
          payload.approvedSlides = arrayUnion(SLIDE_IDX);
        }
        await updateDoc(ref, payload);

        const targetSet = isInternal ? APPROVED_INTERNAL_SET : APPROVED_CLIENT_SET;
        targetSet.add(SLIDE_IDX);
        if(isInternal){
          selectedPost.internalApprovedSlides = Array.from(targetSet);
        }else{
          selectedPost.approvedSlides = Array.from(targetSet);
        }

        const totalSlides = SLIDES.length;
        const fullyApproved = (APPROVED_CLIENT_SET.size >= totalSlides) || (APPROVED_INTERNAL_SET.size >= totalSlides);
        if(fullyApproved){
          await updateDoc(ref, { status: "aprovado", updatedAt: serverTimestamp(), approvedBy: isInternal ? 'interno' : 'cliente' });
          selectedPost.status = "aprovado";
          selectedPost.approvedBy = isInternal ? 'interno' : 'cliente';
          sendWebhook('calendar', { action:'status', id: selectedPost.id, status: 'aprovado', approvedBy: isInternal ? 'interno' : 'cliente' });
          setModalStatus("aprovado");
          if(window.googleCalendarIntegration){
            try{ await window.googleCalendarIntegration.handlePostUpdated(selectedPost); }
            catch(err){ console.warn('googleCalendarIntegration.handlePostUpdated', err); }
          }
          if(typeof mgToast === 'function'){
            mgToast(isInternal ? 'Post aprovado pelo time interno.' : 'Post aprovado pelo cliente.');
          }
        }else{
          let next = SLIDE_IDX;
          for(let i=0;i<SLIDES.length;i++){
            const j = (SLIDE_IDX + 1 + i) % SLIDES.length;
            if(!targetSet.has(j)){ next = j; break; }
          }
          SLIDE_IDX = next;
        }
        if(typeof openPostModal._renderSlide === "function"){ openPostModal._renderSlide(); }
        if(typeof openPostModal._syncApproveButtons === "function"){ openPostModal._syncApproveButtons(); }
      }catch(e){
        console.error(e);
        alert("Falha ao aprovar: " + (e.message||String(e)));
      }
    }
    if(btnApprove) btnApprove.onclick = ()=> approveSlide('cliente');
    if(btnApproveInternal) btnApproveInternal.onclick = ()=> approveSlide('interno');
    if(btnReview)  btnReview.onclick  = ()=>{ if(selectedPost) openReviewPrompt(selectedPost); };
    if(btnCopyApprovalLink) btnCopyApprovalLink.onclick = ()=>{ copyApprovalLinkForPost(); };
    if(btnSave)    btnSave.onclick    = ()=>{ if(selectedPost) savePostMeta(selectedPost, modalDesc.value||"", modalTarget.value||"feed"); };
    if(btnDelete)  btnDelete.onclick  = ()=>{ if(selectedPost) deletePost(selectedPost); };

    if(calUpload) calUpload.onclick = handleUpload;
    if(btnShareCalendar) btnShareCalendar.onclick = ()=> generateCalendarShare();
    if(btnCopyPlanningLink) btnCopyPlanningLink.onclick = ()=> generatePlanningShare();
    if(btnCopyPlanningLink) btnCopyPlanningLink.onclick = ()=> generatePlanningShare();


    /* ======= Revis√£o: observa√ß√µes do cliente ======= */
    const reviewModal = $("reviewModal"), reviewText = $("reviewText"), reviewSend = $("reviewSend"), reviewCancel = $("reviewCancel");
    function fmtDateTime(d){
      try{
        const pad=n=>String(n).padStart(2,"0");
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }catch(_){ return ""; }
    }
    function renderClientNotesPanel(post){
      const panel = document.getElementById("clientNotesPanel");
      if(!panel) return;
      const notes = Array.isArray(post.reviewNotes)? post.reviewNotes : [];
      if(notes.length===0){
        panel.innerHTML = `<div class="muted">Sem observa√ß√µes.</div>`;
        return;
      }
      panel.innerHTML = notes.map(n=>{
        const when = n.at ? (typeof n.at==='number'? n.at : (n.at.toMillis? n.at.toMillis() : Date.parse(n.at)||Date.now())) : Date.now();
        const dt = new Date(when);
        const pad = x => String(x).padStart(2,'0');
        const dstr = `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())} ${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
        const who = (n.by||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const text = renderMarkdownText(n.text||'');
        const slide = Number.isInteger(n.slide)? ` ‚Ä¢ Slide ${n.slide+1}` : '';
        return `<div class="note-item"><div class="note-head"><span>${who||"cliente"}</span><span>‚Ä¢</span><span>${dstr}${slide}</span></div><div class="note-body markdown-view">${text}</div></div>`;
      }).join("");
    }

    function renderClientNotesInCard(post){
  const box = document.getElementById("clientNotesList");
  if(!box) return;
  const notes = Array.isArray(post.reviewNotes)? post.reviewNotes : [];
  if(notes.length===0){ box.innerHTML = `<div class="muted">Sem observa√ß√µes.</div>`; return; }
  const rows = notes.map(n=>{
    const dt = n.at?.toMillis ? new Date(n.at.toMillis()) : (typeof n.at==="number"? new Date(n.at) : (n.at? new Date(n.at): new Date()));
    const pad = x=> String(x).padStart(2,"0");
    const when = `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())} ${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
    const who = (n.by||"").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    const text = renderMarkdownText(n.text||"");
    return `<div class="client-note"><div class="dot"></div><div class="txt markdown-view">${text}<div class="meta">${who||"cliente"} ‚Ä¢ ${when}</div></div></div>`;
  }).join("");
  box.innerHTML = rows;
}

function renderReviewNotes(post){
      const box = $("notesList"); if(!box) return;
      const notes = Array.isArray(post.reviewNotes)? post.reviewNotes : [];
      if(notes.length===0){ box.innerHTML = `<div class="muted">Sem observa√ß√µes.</div>`; return; }
      box.innerHTML = notes.map(n=>{
        const when = n.at?.toMillis ? fmtDateTime(new Date(n.at.toMillis())) : (typeof n.at==="number" ? fmtDateTime(new Date(n.at)) : (n.at ? fmtDateTime(new Date(n.at)):""));
        const who = (n.by||"").replace(/</g,"&lt;").replace(/>/g,"&gt;");
        const origin = resolveReviewOrigin(n);
        const originLabel = origin === 'interno' ? 'Time interno' : 'Cliente';
        const text = renderMarkdownText(n.text||"");
        return `<div class="note-item"><div class="note-head"><span>${who||originLabel.toLowerCase()}</span><span>‚Ä¢</span><span>${when}</span><span class="origin-pill origin-${origin}">${originLabel}</span></div><div class="note-body markdown-view">${text}</div></div>`;
      }).join("");
    }
    function openReviewPrompt(post){
      selectedPost = post;
      if(reviewText) reviewText.value = "";
      if(reviewModal){ reviewModal.classList.add("show"); reviewModal.setAttribute("aria-hidden","false"); setTimeout(()=>reviewText?.focus(), 50); }
    }
    function closeReviewPrompt(){
      if(reviewModal){ reviewModal.classList.remove("show"); reviewModal.setAttribute("aria-hidden","true"); }
    }
    if(reviewCancel) reviewCancel.onclick = closeReviewPrompt;
    async function addReviewNote(post, text){
      const uid = auth.currentUser?.uid; if(!uid) return alert("Fa√ßa login.");
      const email = auth.currentUser?.email || "";
      try{
        const ref = doc(db, "usuarios", uid, "posts", post.id);
        const note = { text, by: email, uid, at: Date.now(), slide: SLIDE_IDX, origin: getCurrentReviewOrigin() };
        await updateDoc(ref, {
          status: "revisar",
          updatedAt: serverTimestamp(),
          reviewNotes: arrayUnion(note),
          lastReviewAt: serverTimestamp()
        });
        // local state
        if(!Array.isArray(post.reviewNotes)) post.reviewNotes=[];
        post.reviewNotes.push(note);
        const before = REVIEWED_SET.size;
        REVIEWED_SET.add(SLIDE_IDX);
        // close only the review modal, keep post modal open and move to next media
        closeReviewPrompt();
        // advance to next slide if exists
        if(typeof SLIDE_IDX === 'number' && Array.isArray(SLIDES)){
          if(SLIDE_IDX < SLIDES.length - 1){
            SLIDE_IDX = SLIDE_IDX + 1;
          }
        }
        // re-render media and (if on first slide) the card notes
        if(typeof openPostModal._renderSlide === "function"){ openPostModal._renderSlide(); }
        renderClientNotesInCard(post); renderReviewNotes(post);
        if(REVIEWED_SET.size === SLIDES.length && before !== SLIDES.length){
          sendWebhook('calendar', {
            action:'status',
            id: post.id,
            status: 'revisar',
            dateISO: post.dateISO || '',
            postName: post.desc || '',
            postDesc: post.desc || '',
            reviewNotes: Array.isArray(post.reviewNotes) ? post.reviewNotes.map(n => n.text) : []
          });
        }
        if(window.googleCalendarIntegration){
          try{ await window.googleCalendarIntegration.handlePostUpdated(post); }
          catch(err){ console.warn('googleCalendarIntegration.handlePostUpdated', err); }
        }
        mgToast('Observa√ß√£o salva. Avance para o pr√≥ximo item do carrossel.');
      }catch(e){ console.error(e); alert("Falha ao enviar observa√ß√£o: "+(e.message||String(e))); }
    }
    if(reviewSend) reviewSend.onclick = ()=>{
      if(!selectedPost) return;
      const text = (reviewText?.value||"").trim();
      if(!text) return alert("Descreva o que precisa ser ajustado.");
      addReviewNote(selectedPost, text);
    };


<style id="calendar-review-css">
/* ======= Observa√ß√µes & Review modal ======= */

/* ===== Ajuste modal revis√£o no mobile ===== */
@media (max-width: 820px){
  #reviewModal .modal-card{
    width: 100% !important;
    height: 70vh !important;
    max-height: 70vh !important;
    margin: auto 0 0 0; /* bottom sheet */
    border-radius: 14px 14px 0 0;
    display: flex;
    flex-direction: column;
  }
  #reviewModal .modal-body{
    flex: 1 1 auto;
    overflow-y: auto;
    padding: 12px;
  }
  #reviewModal textarea{
    min-height: 100px;
  }
  #reviewModal .modal-foot{
    position: sticky;
    bottom: 0;
    background: #111;
    padding: 12px;
    border-top: 1px solid #333;
  }
  #reviewSend{
    width: 100%;
    font-size: 1rem;
    min-height: 44px;
  }
}

.notes-block{ margin-top:12px; }
.notes-list{ display:flex; flex-direction:column; gap:8px; background:#121212; border:1px solid var(--shell-border,rgba(255,255,255,.14)); border-radius:8px; padding:10px; max-height:220px; overflow:auto; }
.note-item{ background:#0d0d0d; border:1px solid #2a2a2a; border-radius:8px; padding:8px; }
.note-head{ display:flex; gap:8px; font-size:.8rem; color:#bbb; margin-bottom:4px; }
.note-body{ white-space:normal; }
.modal-card.small{ width:min(560px, 96vw); }

/* ===== MOBILE MODAL OPTIMIZA√á√ïES (fullscreen + v√≠deo responsivo) ===== */
@media (max-width: 820px){
  .modal-card{
    width: 100vw !important;
    max-width: 100vw !important;
    height: 100vh !important;
    max-height: 100vh !important;
    border-radius: 0 !important;
    display: flex;
    flex-direction: column;
  }
  .modal-head{
    position: sticky;
    top: 0;
    z-index: 2;
    background: rgba(0,0,0,.8);
    backdrop-filter: blur(6px);
  }
  .modal-body{
    flex: 1 1 auto;
    overflow: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 12px;
    grid-template-columns: 1fr !important;
  }
  .modal-foot{
    position: sticky;
    bottom: 0;
    z-index: 2;
    background: rgba(0,0,0,.85);
    backdrop-filter: blur(6px);
    padding-bottom: calc(env(safe-area-inset-bottom,0) + 10px) !important;
  }
  .modal-body .preview{
    min-height: 0 !important;
    height: auto !important;
    padding: 0 !important;
    border: 0 !important;
    background: #000;
  }
  .modal-body .preview video,
  .modal-body .preview img{
    width: 100% !important;
    height: auto !important;
    max-height: 56vh !important;
    object-fit: contain !important;
    display: block !important;
  }
  .modal-foot .btn{
    flex: 1 1 auto;
    min-height: 44px;
  }
  .modal-foot{
    display: grid !important;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }
  #btnDelete{ grid-column: span 2; }
}
/* When any modal opens, lock underlying scroll to avoid "zoom" issues */
.modal.show ~ *,
.modal.show body{ overscroll-behavior: contain; }

/* ===== POPUP MOBILE: sair f√°cil, bot√µes n√£o colam nas bordas, sem "mexer" laterais ===== */
@media (max-width: 820px){
  html, body{ overflow-x: hidden; }
  .modal{ padding: 0 !important; }
  .modal-card{
    width: 100% !important;              /* evita 100vw causar "vai-e-volta" lateral */
    height: 100dvh !important;           /* usa altura din√¢mica da viewport (iOS/Android) */
    max-height: 100dvh !important;
    border-radius: 0 !important;
    display: flex; flex-direction: column;
  }
  .modal-head{
    position: sticky; top: 0; z-index: 3;
    background: rgba(0,0,0,.9);
    backdrop-filter: blur(6px);
    padding-top: calc(env(safe-area-inset-top,0) + 8px) !important;
  }
  .modal-head .btn{ min-height: 40px; }
  .modal-body{
    flex: 1 1 auto; overflow: auto; -webkit-overflow-scrolling: touch;
    padding: 12px 14px 12px 14px;
    grid-template-columns: 1fr !important;
  }
  .modal-foot{
    position: sticky; bottom: 0; z-index: 3;
    background: rgba(0,0,0,.9);
    backdrop-filter: blur(6px);
    padding: 10px 12px calc(env(safe-area-inset-bottom,0) + 12px) 12px !important;
    box-shadow: 0 -6px 24px rgba(0,0,0,.5);
    display: grid !important; grid-template-columns: 1fr 1fr; gap: 10px;
  }
  .modal-foot .btn{ min-height: 48px; }
  #btnDelete{ grid-column: span 2; }
  /* Preview responsivo e sem saltos */
  .modal-body .preview{ background:#000; padding:0 !important; border:0 !important; }
  .modal-body .preview video, .modal-body .preview img{
    width: 100% !important; height: auto !important; max-height: 56vh; object-fit: contain;
  }
  /* Review modal em formato de bottom sheet com "handle" */
  #reviewModal .modal-card{
    height: 78dvh !important; max-height: 78dvh !important;
    border-radius: 16px 16px 0 0 !important;
    margin: auto 0 0 0 !important;
  }
  #reviewModal .modal-head:before{
    content: ""; display:block; width: 44px; height: 4px; border-radius: 999px;
    background: rgba(255,255,255,.25); margin: 6px auto 8px;
  }
  #reviewModal .modal-foot{ grid-template-columns: 1fr; } /* bot√£o largo quando revisando */
  #reviewSend{ width: 100%; }
}
/* Fechar ao tocar fora do cart√£o (backdrop) ‚Äì cursor vis√≠vel */
.modal{ cursor: default; }
.modal.show{ cursor: pointer; }
.modal .modal-card{ cursor: auto; }

/* ===== Reels preview: center, contain, overlays (mobile-friendly) ===== */
.modal-body .preview{
  position: relative;
  background: #000;
  border-radius: 12px;
  overflow: hidden;
}
.modal-body .preview video,
.modal-body .preview img{
  display: block;
  width: 100% !important;
  height: auto !important;
  max-height: 62dvh !important; /* usa viewport din√¢mica */
  object-fit: contain !important; /* n√£o corta o v√≠deo vertical (reels) */
  margin: 0 auto;
  background:#000;
}
/* Play overlay central */
#reelsPlayOverlay{
  position:absolute; left:50%; top:50%;
  transform: translate(-50%, -50%);
  width: 64px; height: 64px;
  border-radius: 50%;
  background: rgba(0,0,0,.55);
  border: 2px solid rgba(255,255,255,.25);
  display: none; /* aparece quando pausado */
  align-items:center; justify-content:center;
  z-index: 4;
}
#reelsPlayOverlay:after{
  content: "";
  border-style: solid;
  border-width: 12px 0 12px 18px;
  border-color: transparent transparent transparent #fff;
  margin-left: 4px;
  display:block;
}
/* Close X overlay no canto superior direito do preview */
#reelsCloseOverlay{
  position: absolute; right: 10px; top: 10px;
  padding: 6px 10px;
  border-radius: 10px;
  background: rgba(0,0,0,.55);
  border: 1px solid rgba(255,255,255,.25);
  color: #fff; font-weight: 800;
  z-index: 4;
  -webkit-tap-highlight-color: transparent;
}
@supports(padding: max(0px)){
  #reelsCloseOverlay{ right: max(10px, env(safe-area-inset-right)); top: max(10px, env(safe-area-inset-top)); }
}
#reelsCloseOverlay:active{ transform: scale(.98); }

/* ===== Fullscreen UX for Reels ===== */
#fsCloseOverlay{
  position: fixed;
  right: max(12px, env(safe-area-inset-right));
  top: max(12px, env(safe-area-inset-top));
  z-index: 999999;
  padding: 8px 12px;
  border-radius: 12px;
  background: rgba(0,0,0,.55);
  border: 1px solid rgba(255,255,255,.25);
  color:#fff;
  font-weight:800;
  display:none;
  -webkit-tap-highlight-color: transparent;
}
#fsCloseOverlay:active{ transform: scale(.98); }

/* ===== Imagens no preview: sem corte (contain), centralizadas, com letterbox ===== */
.modal-body .preview{
  position: relative;
  background:#000;
  border-radius: 12px;
  overflow: hidden;
}
.modal-body .preview img{
  display:block !important;
  width:100% !important;
  height:auto !important;
  max-height:62dvh !important;
  object-fit:contain !important;   /* nunca corta */
  object-position:center center !important;
  background:#000;
  margin:0 auto;
}

/* ===== Lista de observa√ß√µes do cliente no modal ===== */
#clientNotesList{
  margin-top: 8px;
  max-height: 28vh;
  overflow: auto;
  border: 1px solid var(--border, #333);
  border-radius: 10px;
  padding: 10px;
  background: rgba(255,255,255,.03);
}
.client-note{ display:flex; gap:10px; padding:8px 0; border-bottom:1px dashed rgba(255,255,255,.12); }
.client-note:last-child{ border-bottom:0; }
.client-note .dot{ width:8px; height:8px; border-radius:50%; background:#ff6600; margin-top:7px; flex:0 0 8px; }
.client-note .txt{ font-size:.95rem; line-height:1.25rem; }
.client-note .txt.markdown-view{ line-height:1.45; }
.client-note .txt.markdown-view > :last-child{ margin-bottom:0; }
.client-note .meta{ color:var(--muted,#bbb); font-size:.8rem; margin-top:2px; }
</style>
<style>
/* Esconde observa√ß√µes dentro do pop-up do Post (hist√≥rico ficar√° na p√°gina) */
#postModal .notes-block{ display:none !important; }
</style>
<style>
#btnApprove{background:#2e7d32 !important;border-color:#2e7d32 !important;color:#fff;}
#btnApproveInternal{background:#7c4dff !important;border-color:#7c4dff !important;color:#fff;}
#btnApproveInternal:disabled{background:#b39ddb !important;border-color:#b39ddb !important;color:#4527a0 !important;}
#btnApproveInternal.btn-interno-concluido{background:#5e35b1 !important;border-color:#5e35b1 !important;color:#fff !important;}
#btnApprove:hover,#btnApproveInternal:hover{filter:brightness(1.1)}
</style>
<style>
/* === In-modal carousel arrows (reliable) === */
#modalPreview{ position:relative; }
#modalPreview .pv-stage{ position:relative; background:#000; border-radius:12px; overflow:hidden; }
#modalPreview .pv-media{ display:flex; align-items:center; justify-content:center; min-height:220px; }
#modalPreview .pv-media img,
#modalPreview .pv-media video{
  display:block; background:#000;
  max-width:100%; max-height:62vh; width:auto; height:auto; object-fit:contain;
}
#modalPreview .pv-arrow{
  position:absolute; top:50%; transform:translateY(-50%);
  width:42px; height:42px; border-radius:999px;
  display:none; align-items:center; justify-content:center;
  color:#fff; font-weight:900; font-size:22px;
  background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.25);
  cursor:pointer; z-index:10; user-select:none; -webkit-user-select:none;
  -webkit-tap-highlight-color:transparent;
}
#modalPreview.pv-has-many .pv-arrow{ display:flex; }
#modalPreview .pv-arrow.left{ left:10px; } 
#modalPreview .pv-arrow.right{ right:10px; }
@keyframes pvBlink {0%,100%{opacity:.45} 50%{opacity:1}}
#modalPreview.pv-hint .pv-arrow{ animation: pvBlink 1s ease-in-out infinite; }
#modalPreview.pv-hint-end .pv-arrow{ animation: none; }
</style>
<style id="demandas-css">
  .demandas-wrap{margin-left:var(--margin-left);margin-right:var(--margin-right);display:flex;flex-direction:column;gap:8px}
  .demandas-filters{display:flex;flex-wrap:wrap;gap:6px;align-items:flex-start;background:var(--title-bg);border:1px solid var(--shell-border);padding:8px;border-radius:10px}
  .demandas-filters input[type="text"],.demandas-filters select{background:#222;color:#fff;border:1px solid #333;border-radius:8px;padding:6px 8px;flex:1 1 160px;min-width:140px}
  .demanda-month-filter{display:flex;flex-direction:column;gap:6px;flex:1 1 100%;min-width:260px}
  .demanda-year-controls{display:flex;align-items:center;gap:8px;font-weight:800;color:#fff}
  .demanda-year-label{min-width:64px;text-align:center;font-size:.9rem}
  .demanda-year-btn{background:#222;border:1px solid #333;border-radius:6px;color:#fff;padding:4px 8px;font-weight:700;cursor:pointer;transition:background .2s,border-color .2s,color .2s}
  .demanda-year-btn:hover{border-color:var(--accent)}
  .demanda-year-btn:disabled{opacity:.4;cursor:not-allowed}
  .demanda-month-buttons{display:flex;flex-wrap:wrap;gap:6px}
  .demanda-month-button{background:#222;border:1px solid #333;border-radius:999px;color:#fff;padding:6px 10px;font-size:.8rem;font-weight:700;cursor:pointer;transition:background .2s,border-color .2s,color .2s}
  .demanda-month-button:hover{border-color:var(--accent)}
  .demanda-month-button.active{background:var(--accent);color:#000;border-color:var(--accent)}
  .demanda-month-button.has-data{box-shadow:0 0 0 1px rgba(255,255,255,.12) inset}
  /* Dropdown alternativo de meses (oculto por padr√£o no desktop) */
  .demanda-month-select{display:none}
  /* Mobile: busca menor e meses por dropdown */
  @media (max-width: 820px){
    /* Tornar os campos mais "finos" no mobile */
    /* Rebate o min-height global de 44px e a apar√™ncia nativa do iOS/Safari */
    .demandas-filters input[type="text"],
    .demandas-filters select{
      -webkit-appearance:none!important;
      appearance:none!important;
      height:28px!important;
      min-height:28px!important;
      padding:3px 8px!important;
      line-height:22px!important;
      border-radius:6px!important;
    }
    #demandaSearch{font-size:16px!important;padding:3px 8px!important;min-height:28px!important;height:28px!important;line-height:22px!important}
    #demandaMonthButtons{display:none}
    .demanda-month-select{display:block;width:100%;font-size:16px!important;padding:3px 28px 3px 8px!important;min-height:28px!important;height:28px!important;line-height:22px!important;-webkit-appearance:none!important;appearance:none!important}
    /* seta do select com espa√ßamento √† direita */
    .demanda-month-select{background-image:linear-gradient(45deg,transparent 50%, #bbb 50%),linear-gradient(135deg,#bbb 50%, transparent 50%);background-position:right 12px center,right 8px center;background-size:8px 8px,8px 8px;background-repeat:no-repeat}
  }
  .prazo-alert{background:#7f1d1d;color:#fff;padding:6px 8px;border-radius:8px}
  .demandas-wrap,
  .demandas-wrap *{
    color:#fff!important;
    -webkit-text-fill-color:#fff!important;
  }
  .demandas-wrap ::placeholder{color:rgba(255,255,255,.65)!important}
  .demandas-table{width:100%;border-collapse:collapse;table-layout:fixed}
  .demandas-table th,.demandas-table td{border:1px solid var(--shell-border);padding:4px;font-size:.85rem}
  .demandas-table input,.demandas-table select,.demandas-table textarea{width:100%;background:#1a1a1a;color:#fff;border:1px solid #333;border-radius:4px;padding:4px;font-size:.85rem}
  .demandas-table .periodo-field{display:flex;gap:10px;align-items:center;flex-wrap:nowrap}
  .demandas-table .periodo-field input{flex:1 1 150px;min-width:140px}
  .demandas-table .periodo-field .periodo-sep{display:none;font-size:.8rem;color:#bbb;white-space:nowrap}
  .demandas-table .periodo-field .periodo-toggle{flex:0 0 auto;background:#222;border:1px solid #444;color:#fff;border-radius:4px;padding:4px 6px;cursor:pointer;font-size:.75rem;white-space:nowrap;position:relative;z-index:2}
  .demandas-table .periodo-field.range-active .periodo-sep,
  .demandas-table .periodo-field.range-active .periodo-fim{display:block}
  .demandas-table .periodo-field .periodo-fim{display:none;flex:1 1 150px;min-width:140px}
  .demandas-table .filter-row th{background:var(--title-bg);padding:6px}
  .demandas-table .filter-row select,
  .demandas-table .filter-row input{background:#111827;border:1px solid #374151;color:#e5e7eb;border-radius:6px;padding:4px 6px;font-size:.78rem}
  .demandas-table .filter-row input[type="date"]{min-width:0}
  .demandas-table .filter-row .demanda-period-filter{display:flex;align-items:center;gap:8px}
  .demandas-table .filter-row .demanda-period-filter span{font-size:.75rem;color:#9ca3af;white-space:nowrap}
  .demandas-table .filter-row .demanda-period-filter input[type="date"]{min-width:140px}
  .demandas-table .filter-row .demanda-period-filter button{margin-left:6px;position:relative;z-index:2}
  .demandas-table .filter-clear-btn{width:100%;background:#1f2937;border:1px solid #374151;color:#e5e7eb;border-radius:6px;padding:4px 6px;font-size:.75rem;cursor:pointer;transition:background .2s ease,border-color .2s ease}
  .demandas-table .filter-clear-btn:hover{background:#111827;border-color:#4b5563}
  .demandas-table th{background:var(--title-bg)}
  
  /* Sele√ß√£o m√∫ltipla de demandas */
  .demandas-table .col-checkbox{width:40px;text-align:center}
  .demandas-table .col-checkbox input[type="checkbox"]{width:auto;margin:0;cursor:pointer}
  .demandas-table .col-plano{width:80px;text-align:center}
  .demandas-table .col-plano button{background:#1e293b;border:1px solid #334155;color:#94a3b8;border-radius:6px;padding:6px 12px;font-size:.8rem;cursor:pointer;transition:all .2s ease;white-space:nowrap}
  .demandas-table .col-plano button:hover{background:#334155;color:#fff;border-color:#475569}
  .demandas-table .col-plano button.has-plan{background:#1e3a5f;border-color:#3b82f6;color:#60a5fa}
  .demandas-table .col-plano button.has-plan:hover{background:#1e40af;color:#93c5fd}
  .demandas-bulk-actions{display:none;margin:10px 0;padding:10px;background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.3);border-radius:8px;gap:10px;align-items:center;flex-wrap:wrap}
  .demandas-bulk-actions.active{display:flex}
  .demandas-bulk-actions .bulk-count{font-size:.9rem;color:#60a5fa;font-weight:600}
  .demandas-bulk-actions button{background:#3b82f6;color:#fff;border:none;border-radius:6px;padding:6px 14px;font-size:.85rem;cursor:pointer;transition:background .2s ease}
  .demandas-bulk-actions button:hover{background:#2563eb}
  .demandas-bulk-actions button.btn-secondary{background:#6b7280}
  .demandas-bulk-actions button.btn-secondary:hover{background:#4b5563}
  
  /* Modal de edi√ß√£o em massa */
  #bulkEditModal,
  #bulkEditStatusModal,
  #bulkEditResponsavelModal,
  #demandaPlanModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.85);z-index:10000;align-items:center;justify-content:center}
  #bulkEditModal.active,
  #bulkEditStatusModal.active,
  #bulkEditResponsavelModal.active,
  #demandaPlanModal.active{display:flex}
  .bulk-edit-content,
  .demanda-plan-modal-content{background:#1a1a1a;border:1px solid #333;border-radius:12px;padding:24px;max-width:500px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.5)}
  .demanda-plan-modal-content{max-width:700px}
  .demanda-plan-modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
  .demanda-plan-modal-header h3{margin:0;font-size:1.3rem;color:#fff}
  .demanda-plan-modal-close{background:transparent;border:none;color:#999;font-size:1.5rem;cursor:pointer;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:4px;transition:all .2s ease}
  .demanda-plan-modal-close:hover{background:#333;color:#fff}
  .demanda-plan-modal-body{margin-bottom:20px}
  .demanda-plan-modal-footer{display:flex;gap:10px;justify-content:flex-end}
  .bulk-edit-content h3{margin:0 0 20px 0;font-size:1.3rem;color:#fff}
  .bulk-edit-content .form-group,
  .demanda-plan-modal-body .form-group{margin-bottom:16px}
  .bulk-edit-content label,
  .demanda-plan-modal-body label{display:block;margin-bottom:6px;font-size:.9rem;color:#aaa}
  .bulk-edit-content input[type="datetime-local"],
  .bulk-edit-content input[type="date"],
  .bulk-edit-content input[type="time"],
  .bulk-edit-content select,
  .demanda-plan-modal-body input[type="text"],
  .demanda-plan-modal-body textarea{width:100%;background:#0f172a;border:1px solid #334155;border-radius:8px;color:#f8fafc;padding:10px;font-size:.9rem}
  .demanda-plan-modal-body textarea{resize:vertical;min-height:200px;font-family:inherit;line-height:1.5}
  .bulk-edit-content .form-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:24px}
  .bulk-edit-content .btn,
  .demanda-plan-modal-footer .btn{padding:10px 20px;border:none;border-radius:8px;font-size:.9rem;cursor:pointer;transition:all .2s ease}
  .bulk-edit-content .btn-primary,
  .demanda-plan-modal-footer .btn-primary{background:#3b82f6;color:#fff}
  .bulk-edit-content .btn-primary:hover,
  .demanda-plan-modal-footer .btn-primary:hover{background:#2563eb}
  .bulk-edit-content .btn-cancel,
  .demanda-plan-modal-footer .btn-cancel{background:#374151;color:#fff}
  .bulk-edit-content .btn-cancel:hover,
  .demanda-plan-modal-footer .btn-cancel:hover{background:#4b5563}
  .bulk-edit-content .help-text,
  .demanda-plan-modal-body .help-text{font-size:.8rem;color:#6b7280;margin-top:4px}
  
  /* Destaque para demandas atrasadas */
  .demandas-table tr.demanda-atrasada{
    animation: pulseOverdue 2s ease-in-out infinite;
  }
  @keyframes pulseOverdue{
    0%, 100%{
      box-shadow: 0 0 10px rgba(255, 68, 68, 0.5), inset 0 0 10px rgba(255, 68, 68, 0.2);
      border-color: #ff4444;
    }
    50%{
      box-shadow: 0 0 20px rgba(255, 68, 68, 0.8), inset 0 0 15px rgba(255, 68, 68, 0.3);
      border-color: #ff6666;
    }
  }
  
  .demandas-table .col-status{width:8%}
  .demandas-table .col-demanda{width:42%}
  .demandas-table .col-demanda input{min-width:200px}
  .demandas-table .col-resp{width:10%}
  .demandas-table .col-prazo{width:32%}
  .demandas-table .del-cell{width:52px;text-align:center;display:flex;align-items:center;justify-content:center;gap:10px}
  .demandas-table .del-cell button{background:#550000;border:1px solid #880000;color:#fff;border-radius:4px;padding:2px 6px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;margin:0 auto}
  .demanda-plans{margin-top:16px;display:flex;flex-direction:column;gap:16px}
  .demanda-ai-actions{margin-top:18px;display:flex;justify-content:flex-end;align-items:center;gap:12px}
  
  /* Resumo de demandas para WhatsApp */
  .demandas-summary-box{margin-top:24px;background:rgba(15,23,42,.35);border:1px solid rgba(255,255,255,.14);border-radius:12px;padding:16px}
  .demandas-summary-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:10px}
  .demandas-summary-title{font-size:1rem;font-weight:700;color:#fff;margin:0}
  .demandas-summary-buttons{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .demandas-summary-textarea{width:100%;min-height:400px;max-height:600px;background:#0a0a0a;color:#e5e7eb;border:1px solid #374151;border-radius:8px;padding:12px;font-size:.85rem;font-family:'Courier New',monospace;line-height:1.6;resize:vertical;display:none}
  .demandas-summary-preview{width:100%;min-height:400px;max-height:600px;background:#0b141a;color:#e9edef;border:1px solid #374151;border-radius:8px;padding:16px;font-size:.9rem;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;line-height:1.5;overflow-y:auto;white-space:pre-wrap;word-wrap:break-word}
  .demandas-summary-preview .wa-bold{font-weight:700}
  .demandas-summary-preview .wa-italic{font-style:italic;color:#8696a0}
  .demandas-summary-preview .wa-strike{text-decoration:line-through;color:#8696a0}
  .demandas-summary-preview .wa-link{color:#53bdeb;text-decoration:none}
  .demandas-summary-preview .wa-link:hover{text-decoration:underline}
  .demandas-summary-preview .wa-atrasada{color:#ff6b6b;font-weight:700}
  .demandas-summary-preview .wa-separator{color:#3b4a54;display:block;margin:4px 0}
  .demandas-preview-with-buttons{display:flex;gap:24px;align-items:flex-start;justify-content:center}
  .demandas-preview-text{flex:1;max-width:50%;min-width:0}
  .demandas-copy-buttons{width:480px;display:flex;flex-direction:column;gap:8px;padding-left:24px;border-left:1px solid rgba(255,255,255,.1)}
  .demandas-copy-buttons-header{font-size:.9rem;font-weight:600;color:#8696a0;margin-bottom:10px;text-align:center}
  .demandas-copy-buttons-list{display:flex;flex-direction:column;gap:6px;max-height:550px;overflow-y:auto;padding-right:6px}
  .demandas-copy-buttons-list::-webkit-scrollbar{width:8px}
  .demandas-copy-buttons-list::-webkit-scrollbar-track{background:rgba(255,255,255,.05);border-radius:4px}
  .demandas-copy-buttons-list::-webkit-scrollbar-thumb{background:rgba(255,255,255,.2);border-radius:4px}
  .demandas-copy-buttons-list::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.3)}
  .demandas-copy-group-header{font-size:.82rem;font-weight:700;color:#e9edef;margin-top:8px;margin-bottom:4px;padding:6px 10px;background:rgba(255,255,255,.05);border-radius:4px;display:flex;align-items:center;gap:6px}
  .demandas-copy-separator{height:1px;background:rgba(255,255,255,.1);margin:10px 0}
  .btn-copy-individual-inline{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.1);border-radius:6px;padding:10px 12px;font-size:.82rem;cursor:pointer;transition:all .2s ease;text-align:left;color:#e9edef;width:100%}
  .btn-copy-individual-inline:hover{background:rgba(37,211,102,.1);border-color:#25d366;transform:translateX(2px)}
  .btn-copy-individual-inline:active{transform:translateX(0)}
  .btn-copy-status{font-size:1.1rem;flex-shrink:0}
  .btn-copy-text{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:.82rem;line-height:1.3}
  .btn-copy-icon{font-size:1.1rem;flex-shrink:0;opacity:.7}
  .btn-copy-individual-inline:hover .btn-copy-icon{opacity:1}
  @media(max-width:1200px){.demandas-copy-buttons{width:400px}}
  @media(max-width:1024px){.demandas-copy-buttons{width:350px}}
  @media(max-width:768px){.demandas-preview-with-buttons{flex-direction:column}.demandas-preview-text{max-width:100%}.demandas-copy-buttons{width:100%;border-left:none;border-top:1px solid rgba(255,255,255,.1);padding-left:0;padding-top:16px}}
  .demandas-summary-btn{background:#25d366;color:#fff;border:none;border-radius:8px;padding:8px 16px;font-size:.9rem;font-weight:600;cursor:pointer;transition:background .2s ease;display:inline-flex;align-items:center;gap:6px}
  .demandas-summary-btn:hover{background:#1eb054}
  .demandas-summary-btn:active{transform:scale(.98)}
  .demandas-summary-btn.refresh{background:#3b82f6}
  .demandas-summary-btn.refresh:hover{background:#2563eb}
  .demandas-summary-btn.user-copy{background:#8b5cf6;border-radius:0 8px 8px 0;padding:8px 12px}
  .demandas-summary-btn.user-copy:hover{background:#7c3aed}
  .demandas-summary-btn.user-copy:disabled{background:#4b5563;cursor:not-allowed;opacity:.6}
  .demandas-summary-user-filter{display:flex;align-items:center}
  .demandas-user-select{background:#1f2937;color:#fff;border:1px solid #374151;border-right:none;border-radius:8px 0 0 8px;padding:8px 12px;font-size:.85rem;cursor:pointer;min-width:140px}
  .demandas-user-select:focus{outline:none;border-color:#8b5cf6}
  .demanda-plan-month{border:1px solid var(--shell-border);background:rgba(255,255,255,.04);border-radius:12px;padding:14px}
  .demanda-plan-month-title{margin:0 0 12px;font-size:1rem;font-weight:700;text-transform:capitalize;color:#fff}
  .demanda-plan-month-content{display:flex;flex-direction:column;gap:14px}
  .demanda-plan-month-plans{background:rgba(15,23,42,.55);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:12px}
  .demanda-plan-tabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
  .demanda-plan-tab{background:#1f2937;border:1px solid #374151;color:#fff;border-radius:999px;padding:6px 12px;cursor:pointer;font-size:.8rem;transition:background .2s,border-color .2s}
  .demanda-plan-tab.active{background:#2563eb;border-color:#2563eb}
  .demanda-plan-notes{position:relative}
  .demanda-plan-note{display:none}
  .demanda-plan-note.active{display:block}
  .demanda-plan-note-editor{display:flex;flex-direction:column;gap:8px}
  .demanda-plan-note-editor-area{width:100%;min-height:220px;background:rgba(15,23,42,.78);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:14px 16px;color:#f8fafc;overflow:auto;font-size:.95rem;line-height:1.65;outline:none;transition:border-color .2s,box-shadow .2s,background .2s;word-break:break-word}
  .demanda-plan-note-editor-area:focus{border-color:var(--accent,#7c4dff);box-shadow:0 0 0 2px rgba(124,77,255,.3),0 10px 24px rgba(0,0,0,.35);background:rgba(15,23,42,.88)}
  .demanda-plan-note-editor-area:empty::before{content:attr(data-placeholder);color:rgba(248,250,252,.45);font-weight:500}
  .demanda-plan-note-editor-area.markdown-view{display:block}
  .demanda-plan-note-editor-area.markdown-view > :first-child{margin-top:0}
  .demanda-plan-note-editor-area.markdown-view > :last-child{margin-bottom:0}
  .demanda-plan-note-editor-area.markdown-view h1,.demanda-plan-note-editor-area.markdown-view h2,.demanda-plan-note-editor-area.markdown-view h3,.demanda-plan-note-editor-area.markdown-view h4,.demanda-plan-note-editor-area.markdown-view h5,.demanda-plan-note-editor-area.markdown-view h6{color:#fff;margin:1.4em 0 .65em;font-weight:700;line-height:1.2}
  .demanda-plan-note-editor-area.markdown-view h1{font-size:1.55rem}
  .demanda-plan-note-editor-area.markdown-view h2{font-size:1.35rem}
  .demanda-plan-note-editor-area.markdown-view h3{font-size:1.2rem}
  .demanda-plan-note-editor-area.markdown-view h4{font-size:1.08rem}
  .demanda-plan-note-editor-area.markdown-view ul,.demanda-plan-note-editor-area.markdown-view ol{margin:0 0 .85em 1.4em;padding-left:1.1em}
  .demanda-plan-note-editor-area.markdown-view li{margin:.35em 0}
  .demanda-plan-note-editor-area.markdown-view blockquote{margin:0 0 1em;padding-left:14px;border-left:3px solid rgba(255,255,255,.24);color:rgba(226,232,240,.85)}
  .demanda-plan-note-editor-area.markdown-view code{background:rgba(148,163,184,.18);padding:0 4px;border-radius:4px;font-family:"Fira Code",monospace;font-size:.85em}
  .demanda-plan-note-editor-area.markdown-view pre{margin:0 0 1em;background:#0b1120;border:1px solid rgba(148,163,184,.25);border-radius:10px;padding:12px;overflow:auto;font-family:"Fira Code",monospace;font-size:.85rem}
  .demanda-plan-note-actions{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:4px 0}
  .demanda-plan-note-actions .btn{white-space:normal}
  .markdown-toolbar{display:flex;flex-wrap:wrap;gap:6px}
  .markdown-toolbar button{background:#1f2937;border:1px solid #374151;border-radius:6px;color:#e5e7eb;padding:6px 10px;font-weight:700;font-size:.75rem;cursor:pointer;transition:background .2s,border-color .2s,color .2s}
  .markdown-toolbar button:hover{background:#2563eb;border-color:#2563eb;color:#0b1120}
  .demanda-plan-demand-list{display:flex;flex-direction:column;gap:12px}
  .demanda-plan-item{background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:12px}
  .demanda-plan-header{display:flex;flex-direction:column;gap:4px;margin-bottom:4px}
  .demanda-plan-title{font-weight:700;font-size:.95rem;color:#fff}
  .demanda-plan-date{font-size:.8rem;color:#cbd5f5}
  .demanda-plan-demand-meta{font-size:.78rem;color:#9ca3af}
  .demanda-plan-action{margin-top:10px;display:flex;flex-direction:column;gap:6px}
  .demanda-plan-action-label{font-size:.78rem;font-weight:700;color:#bfdbfe;text-transform:uppercase;letter-spacing:.04em}
  .demanda-plan-action-editor{min-height:90px;background:rgba(15,23,42,.65);border:1px dashed rgba(148,163,184,.35);border-radius:10px;padding:10px 12px;color:#f8fafc;font-size:.85rem;line-height:1.55;outline:none;transition:border-color .2s,box-shadow .2s,background .2s;word-break:break-word}
  .demanda-plan-action-editor:focus{border-color:var(--accent,#7c4dff);box-shadow:0 0 0 2px rgba(124,77,255,.28);background:rgba(15,23,42,.82)}
  .demanda-plan-action-editor:empty::before{content:attr(data-placeholder);color:rgba(148,163,184,.6);font-weight:500}
  .demanda-plan-empty-demands{font-size:.85rem;color:#cbd5f5;background:rgba(15,23,42,.35);border:1px dashed rgba(255,255,255,.12);border-radius:8px;padding:10px}
  .demanda-plan-empty{color:#ccc;font-size:.9rem}
  @media (max-width:820px){
    .demandas-table th:not(.col-status):not(.col-demanda),
    .demandas-table td:not(.col-status):not(.col-demanda){display:none}
    .demandas-table .col-status{width:25%}
    .demandas-table .col-demanda{width:75%}
  }
</style>
<style id="notifications-css">
  .notification-widget{position:fixed;bottom:16px;right:16px;z-index:9999;display:none;flex-direction:column;align-items:flex-end;gap:10px;font-family:inherit;pointer-events:none}
  .notification-widget.open .notification-panel{opacity:1;transform:translateY(0);pointer-events:auto}
  .notification-button{position:relative;width:60px;height:60px;border-radius:50%;border:none;background:linear-gradient(135deg,#3b82f6 0%,#1d4ed8 50%,#1e40af 100%);color:#fff;display:flex;align-items:center;justify-content:center;font-size:28px;cursor:pointer;box-shadow:0 10px 30px rgba(29,78,216,.5),0 0 20px rgba(59,130,246,.3);transition:all .3s cubic-bezier(.4,0,.2,1);pointer-events:auto;animation:pulse-glow 2s ease-in-out infinite}
  .notification-button:focus-visible{outline:3px solid rgba(99,102,241,.6);outline-offset:2px}
  .notification-button:hover{transform:translateY(-4px) scale(1.05);box-shadow:0 15px 40px rgba(29,78,216,.6),0 0 30px rgba(59,130,246,.5)}
  .notification-button:active{transform:translateY(-2px) scale(1.02);transition:all .1s ease}
  .notification-icon{pointer-events:none;filter:drop-shadow(0 2px 4px rgba(0,0,0,.3))}
  .notification-badge{position:absolute;top:4px;right:4px;min-width:24px;height:24px;padding:0 7px;border-radius:999px;background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);color:#fff;font-weight:900;font-size:.8rem;display:none;align-items:center;justify-content:center;box-shadow:0 0 0 3px rgba(12,17,34,.92),0 4px 12px rgba(239,68,68,.6);animation:badge-bounce 1.5s ease-in-out infinite}
  .notification-badge:not([hidden]){display:flex}
  @keyframes pulse-glow{0%,100%{box-shadow:0 10px 30px rgba(29,78,216,.5),0 0 20px rgba(59,130,246,.3)}50%{box-shadow:0 12px 35px rgba(29,78,216,.6),0 0 30px rgba(59,130,246,.5)}}
  @keyframes badge-bounce{0%,100%{transform:scale(1)}10%,30%{transform:scale(1.15)}20%{transform:scale(.95)}40%{transform:scale(1.05)}50%,100%{transform:scale(1)}}
  .notification-panel{width:min(420px,92vw);max-height:60vh;overflow:auto;background:#0b1120;border:1px solid rgba(148,163,184,.25);border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:12px;box-shadow:0 18px 40px rgba(2,6,23,.65);opacity:0;transform:translateY(6px);pointer-events:none;transition:opacity .18s ease,transform .18s ease}
  .notification-header{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .notification-title{font-weight:800;font-size:1rem;color:#e2e8f0;margin:0}
  .notification-list{display:flex;flex-direction:column;gap:10px}
  .notification-item{display:flex;gap:10px;padding:10px;border-radius:10px;background:rgba(148,163,184,.08);border:1px solid rgba(148,163,184,.18);color:#cbd5f5;font-size:.85rem;line-height:1.35}
  .notification-item.unseen{border-color:rgba(96,165,250,.4);box-shadow:0 0 0 1px rgba(37,99,235,.45)}
  .notification-item.critical{background:rgba(153,27,27,.45);border-color:rgba(239,68,68,.85);color:#fee2e2;box-shadow:0 0 8px rgba(239,68,68,.4);animation:pulseNotification 2s ease-in-out infinite}
  .notification-item.alert{background:rgba(127,29,29,.32);border-color:rgba(248,113,113,.65);color:#fee2e2}
  .notification-item.warn{background:rgba(120,53,15,.32);border-color:rgba(251,191,36,.55);color:#fef3c7}
  .notification-icon-wrap{flex:0 0 34px;height:34px;border-radius:50%;background:rgba(59,130,246,.18);display:flex;align-items:center;justify-content:center;font-size:18px}
  .notification-item.critical .notification-icon-wrap{background:rgba(239,68,68,.35);color:#fca5a5}
  .notification-item.alert .notification-icon-wrap{background:rgba(248,113,113,.25)}
  .notification-item.warn .notification-icon-wrap{background:rgba(251,191,36,.25);color:#fde68a}
  @keyframes pulseNotification{0%,100%{opacity:1}50%{opacity:.85}}
  .notification-content{flex:1;min-width:0;display:flex;flex-direction:column;gap:4px}
  .notification-item-title{font-weight:700;color:#f8fafc;font-size:.9rem}
  .notification-item-meta{font-size:.75rem;color:rgba(226,232,240,.7)}
  .notification-item-time{font-size:.72rem;color:rgba(148,163,184,.75);font-weight:600}
  .notification-actions{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .notification-action{background:#1d4ed8;border:1px solid rgba(59,130,246,.6);color:#fff;border-radius:999px;padding:4px 10px;font-weight:700;font-size:.75rem;cursor:pointer;transition:filter .2s ease}
  .notification-action:hover{filter:brightness(1.1)}
  .notification-empty{padding:20px;text-align:center;border-radius:12px;background:rgba(15,23,42,.6);border:1px dashed rgba(148,163,184,.35);color:#94a3b8;font-size:.9rem}
  @media (max-width:640px){
    .notification-panel{right:0;width:min(360px,92vw)}
  }
</style>
<style id="refsocial-css">
  .refsocial-wrap{margin-left:var(--margin-left);margin-right:var(--margin-right);display:flex;flex-direction:column;gap:8px}
  .refsocial-top{display:flex;flex-direction:column;gap:12px}
  .refsocial-form{display:flex;flex-direction:column;gap:10px;background:var(--title-bg);border:1px solid var(--shell-border);padding:10px;border-radius:12px}
  .refsocial-form[data-mode="link"] .refsocial-field-upload{display:none}
  .refsocial-form[data-mode="upload"] .refsocial-field-link{display:none}
  .refsocial-form[data-mode="upload"] #refSocialLinkPreview{display:none}
  .refsocial-mode{display:inline-flex;align-self:flex-start;background:#131313;border:1px solid rgba(255,255,255,.08);border-radius:999px;padding:4px;gap:4px}
  .refsocial-mode button{border:0;border-radius:999px;padding:6px 14px;background:transparent;color:#bbb;font-weight:700;cursor:pointer;transition:background .2s,color .2s}
  .refsocial-mode button.active{background:var(--accent,#2e7d32);color:#fff;box-shadow:0 0 0 1px rgba(0,0,0,.35)}
  .refsocial-grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .refsocial-field{display:flex;flex-direction:column;gap:4px}
  .refsocial-field span{font-size:.7rem;letter-spacing:.08em;color:#bbb;text-transform:uppercase}
  .refsocial-field input[type="url"],.refsocial-field input[type="file"],.refsocial-field select,.refsocial-field textarea{background:#222;color:#fff;border:1px solid #333;border-radius:8px;padding:8px}
  .refsocial-field input[type="file"]{padding:10px 8px}
  .refsocial-field textarea{min-height:90px;resize:vertical}
  .refsocial-submit{display:flex;justify-content:flex-end}
  .refsocial-link-preview{border:1px dashed rgba(255,255,255,.2);border-radius:10px;padding:10px;min-height:160px;display:flex;flex-direction:column;gap:10px;justify-content:center;align-items:center;text-align:center;background:#0d0d0d}
  .refsocial-link-preview[data-state="loading"]{opacity:.7}
  .refsocial-link-preview-media{width:100%;display:flex;justify-content:center}
  .refsocial-link-preview-media iframe,
  .refsocial-link-preview-media img{width:100%;border:0;border-radius:10px;background:#000;display:block}
  .refsocial-link-preview-media iframe{height:auto;min-height:610px}
  .refsocial-link-preview-meta{display:flex;flex-direction:column;gap:4px;font-size:.8rem;width:100%;text-align:left}
  .refsocial-link-preview-meta strong{font-size:.75rem;color:#ffd9bf;letter-spacing:.06em}
  .refsocial-link-preview-meta a{color:#8ecbff;text-decoration:underline;font-size:.75rem;align-self:flex-start}
  .refsocial-list{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
  .ref-item{position:relative;background:#0d0d0d;border:1px solid var(--shell-border);border-radius:8px;padding:6px;width:min(340px,100%);display:flex;flex-direction:column;gap:6px}
  .ref-item-media{position:relative;border-radius:6px;overflow:hidden;background:#000;display:flex;align-items:stretch;justify-content:center}
  .ref-item-media img,.ref-item-media video{width:100%;height:auto;display:block}
  .ref-item-media iframe{width:100%;border:0;background:#000;display:block;height:auto;min-height:610px}
  .ref-item-details{font-size:.75rem;display:flex;flex-direction:column;gap:4px}
  .ref-item-details strong{display:block;font-size:.8rem}
  .ref-item-details p{margin:0}
  .ref-item-details .markdown-view{font-size:.8rem}
  .ref-item-details .markdown-view > :last-child{margin-bottom:0}
  .ref-link-info{display:flex;flex-direction:column;gap:4px;font-size:.72rem}
  .ref-link-provider{font-weight:700;letter-spacing:.05em;color:#ffd9bf;font-size:.7rem}
  .ref-link-actions{display:flex;gap:8px;flex-wrap:wrap;font-size:.72rem}
  .ref-link-actions a{color:#8ecbff;text-decoration:underline}
  .ref-item-actions{margin-top:2px;display:flex;gap:6px;flex-wrap:wrap}
  .ref-item button.ref-edit{flex:1;background:#1f1f1f;color:#fff;border:1px solid #333;border-radius:6px;padding:4px 6px;cursor:pointer;font-size:.75rem;transition:background .2s ease}
  .ref-item button.ref-edit:hover{background:#2a2a2a}
  .ref-item textarea.ref-edit-input{width:100%;min-height:80px;background:#1a1a1a;color:#fff;border:1px solid #333;border-radius:6px;padding:6px;font-size:.75rem;resize:vertical;font-family:inherit}
  .ref-item button.ref-save{flex:1;background:#2e7d32;border:1px solid #1b5e20;color:#fff;border-radius:6px;padding:4px 6px;cursor:pointer;font-size:.75rem;transition:filter .2s ease}
  .ref-item button.ref-save:hover{filter:brightness(1.1)}
  .ref-item button.ref-cancel{flex:1;background:#333;border:1px solid #555;color:#fff;border-radius:6px;padding:4px 6px;cursor:pointer;font-size:.75rem;transition:background .2s ease}
  .ref-item button.ref-cancel:hover{background:#3d3d3d}
  .ref-item button.ref-remove{position:absolute;top:2px;right:2px;background:#c00;color:#fff;border:none;border-radius:50%;width:20px;height:20px;cursor:pointer;font-size:12px;line-height:20px;padding:0}
</style>
<style id="competitors-css">
  .competitors-wrap{margin-left:var(--margin-left);margin-right:var(--margin-right);display:flex;flex-direction:column;gap:8px}
  .competitors-controls{display:flex;flex-wrap:wrap;gap:6px;align-items:center;background:var(--title-bg);border:1px solid var(--shell-border);padding:8px;border-radius:10px}
  .competitors-controls input{background:#222;color:#fff;border:1px solid #333;border-radius:8px;padding:6px 8px}
  .competitors-table{width:100%;border-collapse:collapse}
  .competitors-table th,.competitors-table td{border:1px solid var(--shell-border);padding:4px;font-size:.85rem}
  .competitors-table th{background:var(--title-bg)}
  .competitors-table td a{color:var(--accent);text-decoration:none}
  .competitors-table td a:hover{text-decoration:underline}
  .competitors-table .del-cell button{background:#550000;border:1px solid #880000;color:#fff;border-radius:4px;padding:2px 6px;cursor:pointer}
</style>
<style id="files-css">
  .hidden{display:none!important}
  .files-wrap{margin-left:var(--margin-left);margin-right:var(--margin-right);display:flex;flex-direction:column;gap:16px}
  .files-layout{display:flex;gap:16px;align-items:stretch}
  .files-sidebar{width:240px;min-width:220px;display:flex;flex-direction:column;gap:12px;background:var(--title-bg);border:1px solid var(--shell-border);border-radius:12px;padding:12px}
  .files-sidebar-head{display:flex;justify-content:space-between;align-items:center}
  .folder-tree{display:flex;flex-direction:column;gap:4px}
  .folder-tree-item{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:8px;cursor:pointer;background:transparent;transition:background .2s,color .2s;position:relative;padding-left:calc(12px + var(--depth,0)*16px)}
  .folder-tree-item .tree-icon{opacity:.7;font-size:1rem}
  .folder-tree-item .tree-label{flex:1;min-width:0;text-overflow:ellipsis;overflow:hidden;white-space:nowrap;font-size:.85rem}
  .folder-tree-item:hover{background:rgba(255,255,255,.08)}
  .folder-tree-item.active{background:var(--accent);color:var(--black)}
  .folder-tree-item.active .tree-icon{opacity:1}
  .folder-actions{display:flex;align-items:center;gap:4px;opacity:0;transition:opacity .2s}
  .folder-tree-item:hover .folder-actions,.folder-tree-item.active .folder-actions{opacity:.85}
  .folder-action{background:none;border:0;color:inherit;cursor:pointer;font-size:.8rem;padding:0}
  .folder-tree-item.active .folder-action{color:var(--black)}
  .folder-tree-empty{font-size:.8rem;color:var(--muted);padding:8px 12px}
  .files-main{flex:1;display:flex;flex-direction:column;gap:16px;background:var(--title-bg);border:1px solid var(--shell-border);border-radius:12px;padding:16px}
  .files-breadcrumb{display:flex;flex-wrap:wrap;align-items:center;gap:6px;font-size:.85rem}
  .files-breadcrumb .crumb{cursor:pointer;color:var(--accent);font-weight:600}
  .files-breadcrumb .crumb.current{cursor:default;color:#fff}
  .files-breadcrumb .crumb-sep{opacity:.5}
  .files-actions{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  .files-actions .left-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .files-actions input[type="file"]{display:none}
  .files-actions .btn.active{background:var(--accent);color:var(--black);border-color:var(--accent)}
  .files-select-tools{display:flex;align-items:center;gap:6px;font-size:.8rem;color:var(--muted);flex-wrap:wrap}
  .files-select-tools .select-all-box{display:flex;align-items:center;gap:6px;cursor:pointer;font-weight:600}
  .files-select-tools input{width:18px;height:18px;cursor:pointer;accent-color:var(--accent)}
  .upload-progress{margin-left:auto;display:flex;align-items:center;gap:8px;font-size:.75rem;color:var(--muted)}
  .upload-progress.hidden{display:none}
  .upload-progress-text{max-width:180px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .upload-progress-track{width:160px;max-width:40vw;height:6px;background:rgba(255,255,255,.16);border-radius:999px;overflow:hidden;position:relative}
  .upload-progress-fill{height:100%;width:0;background:var(--accent);transition:width .2s ease}
  .upload-progress-percent{min-width:38px;text-align:right;font-variant-numeric:tabular-nums;color:#fff;font-weight:700}
    .storage-usage-hint{margin-left:auto}
  .files-view-toggle{display:inline-flex;border:1px solid var(--shell-border);border-radius:10px;overflow:hidden;background:#111}
  .files-view-toggle .view-btn{appearance:none;border:0;background:transparent;color:#fff;padding:6px 12px;display:flex;align-items:center;gap:6px;cursor:pointer;font-size:.8rem;font-weight:700;line-height:1}
  .files-view-toggle .view-btn:not(:last-child){border-right:1px solid var(--shell-border)}
  .files-view-toggle .view-btn.active{background:var(--accent);color:var(--black)}
  .files-empty{font-size:.85rem;color:var(--muted)}
  .subfolders-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}
  .subfolders-grid.hidden{display:none}
  .subfolder-card{background:#111;border:1px solid #333;border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:8px;cursor:pointer;transition:transform .2s,border-color .2s}
  .subfolder-card:hover{transform:translateY(-2px);border-color:var(--accent)}
  .subfolder-icon{font-size:24px}
  .subfolder-name{font-size:.85rem;font-weight:600;word-break:break-word}
  .files-list{display:flex;flex-direction:column;gap:12px}
  .files-list.hidden{display:none}
  .files-table{width:100%;border:1px solid var(--shell-border);border-radius:12px;overflow:hidden;background:rgba(0,0,0,.18)}
  .files-table-head{display:grid;grid-template-columns:40px minmax(220px,2fr) minmax(150px,1fr) minmax(120px,.8fr) minmax(150px,1fr);gap:12px;padding:10px 12px;font-size:.75rem;text-transform:uppercase;letter-spacing:.04em;color:var(--muted);background:rgba(255,255,255,.06)}
  .files-table-body{display:flex;flex-direction:column}
  .files-table-row{display:grid;grid-template-columns:40px minmax(220px,2fr) minmax(150px,1fr) minmax(120px,.8fr) minmax(150px,1fr);gap:12px;padding:10px 12px;align-items:center;border-top:1px solid rgba(255,255,255,.06);cursor:pointer;transition:background .2s}
  .files-table-row:hover{background:rgba(255,255,255,.04)}
  .file-info{display:flex;align-items:center;gap:10px;min-width:0}
  .file-thumb{width:48px;height:48px;border-radius:12px;background:#090909;border:1px solid rgba(255,255,255,.1);display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0}
  .file-thumb img,.file-thumb video{width:100%;height:100%;object-fit:cover;display:block}
  .file-thumb video{pointer-events:none}
  .file-icon{font-size:1.6rem}
  .file-text{display:flex;flex-direction:column;gap:4px;min-width:0}
  .file-name{font-size:.9rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .file-type{font-size:.75rem;color:var(--muted)}
  .file-meta{font-size:.8rem;color:var(--muted)}
  .file-meta strong{display:block;font-size:.7rem;text-transform:uppercase;letter-spacing:.04em;color:var(--muted)}
  .file-actions{justify-self:end;display:flex;justify-content:flex-end;align-items:center;gap:8px;flex-wrap:wrap}
  .file-action-buttons{display:flex;gap:6px;flex-wrap:wrap}
  .file-action-move{display:flex}
  .file-select-head{display:flex;justify-content:center;align-items:center}
  .file-select-col{display:flex;align-items:center;justify-content:center}
  .file-select-box{display:inline-flex;align-items:center;gap:6px;font-size:.75rem;font-weight:600;color:var(--muted);cursor:pointer}
  .file-select-box input{width:18px;height:18px;cursor:pointer;accent-color:var(--accent)}
  .file-select-box .file-select-label{pointer-events:none}
  .file-select-box.compact{gap:0;padding:6px;background:rgba(0,0,0,.55);border-radius:999px}
  .file-select-box.compact input{width:16px;height:16px}
  .file-select-box.compact .file-select-label{display:none}
  .file-checkbox:disabled{opacity:.4;cursor:not-allowed}
  .file-entry.selected{background:rgba(46,125,50,.12)}
  .files-table-row.selected{background:rgba(46,125,50,.12);border-color:rgba(46,125,50,.35)}
  .files-table-row.selected:hover{background:rgba(46,125,50,.18)}
  .file-card.selected{border-color:var(--accent);box-shadow:0 0 0 2px rgba(46,125,50,.35)}
  .file-card .file-select-box{position:absolute;top:12px;left:12px}
  .file-actions .move-select{background:#1f1f1f;color:#fff;border:1px solid #333;border-radius:8px;padding:6px;font-size:.75rem;cursor:pointer;min-width:150px}
  .file-actions .move-select:focus{outline:2px solid var(--accent)}
  .files-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:16px;align-items:start}
  .file-entry.uploading{opacity:.8}
  .file-status{margin-top:6px;display:flex;flex-direction:column;gap:4px;font-size:.7rem;color:var(--accent)}
  .file-status-bar{width:100%;height:4px;background:rgba(255,255,255,.15);border-radius:999px;overflow:hidden}
  .file-status-fill{height:100%;width:0;background:var(--accent);transition:width .2s ease}
  .file-card{background:#111;border:1px solid #333;border-radius:16px;padding:16px;display:flex;flex-direction:column;align-items:center;gap:12px;cursor:pointer;transition:border-color .2s,transform .2s;text-align:center;position:relative}
  .file-card:hover{border-color:var(--accent);transform:translateY(-2px)}
  .file-card .file-thumb{width:72px;height:72px;border-radius:16px;margin:0 auto}
  .file-card .file-name{font-size:.85rem;font-weight:600;width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .file-card .file-meta{font-size:.75rem}
  .file-card .file-actions{width:100%;flex-direction:column;align-items:stretch;gap:10px}
  .file-card .file-action-buttons{justify-content:center}
  .file-card .file-action-move{width:100%}
  .file-card .move-select{width:100%}
  .file-details{display:flex;flex-direction:column;gap:4px;font-size:.72rem;color:var(--muted);width:100%}
  .file-details span{display:block}
  .file-folder{font-size:.75rem;color:var(--muted);display:flex;align-items:center;gap:4px}
  .file-card .file-folder{justify-content:center}
  .file-preview-body{grid-template-columns:minmax(0,2fr) minmax(0,1fr)}
  .file-preview-info{display:flex;flex-direction:column;gap:10px;font-size:.85rem}
  .file-preview-info strong{display:block;font-size:.7rem;text-transform:uppercase;letter-spacing:.04em;color:var(--muted)}
  .file-preview-info .btn{align-self:flex-start}
  .file-preview-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .file-preview-placeholder{color:var(--muted);text-align:center;padding:24px;display:flex;align-items:center;justify-content:center;flex:1}
  .file-preview-placeholder a{color:var(--accent);font-weight:700}
  .files-bulk-bar{position:sticky;bottom:0;display:flex;justify-content:space-between;align-items:center;gap:16px;background:rgba(8,8,8,.95);border:1px solid var(--accent);border-radius:14px;padding:12px 16px;box-shadow:0 12px 30px rgba(0,0,0,.35);z-index:20}
  .files-bulk-info{display:flex;flex-direction:column;gap:2px;font-size:.8rem}
  .files-bulk-info strong{text-transform:uppercase;letter-spacing:.08em;font-size:.72rem;color:var(--accent)}
  .files-bulk-count{font-weight:700}
  .files-bulk-status{color:var(--muted);font-size:.75rem}
  .files-bulk-status.hidden{display:none}
  .files-bulk-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .files-bulk-actions .btn[disabled]{opacity:.6;cursor:not-allowed}
  .files-bulk-bar.hidden{display:none}
  @media (max-width:900px){
    .files-layout{flex-direction:column}
    .files-sidebar{width:100%}
    .files-table-head,.files-table-row{grid-template-columns:40px minmax(200px,2fr) minmax(120px,1fr) minmax(100px,.8fr) minmax(150px,1fr)}
    .file-actions{justify-content:flex-start}
    .file-preview-body{grid-template-columns:1fr}
  }
  @media (max-width:640px){
    .files-view-toggle{width:100%}
    .files-view-toggle .view-btn{flex:1;justify-content:center}
    .files-table{border-radius:10px}
    .files-table-head{grid-template-columns:minmax(0,1fr)}
    .files-table-head .file-select-head{display:none}
    .files-table-body{gap:10px;padding:6px}
    .files-table-row{grid-template-columns:minmax(0,1fr);border:1px solid rgba(255,255,255,.08);border-radius:10px}
    .file-select-col{justify-content:flex-start}
    .files-table-row > :not(.file-info){justify-self:flex-start}
    .files-table-row .file-actions{width:100%;justify-content:flex-start}
    .files-table-row .file-action-move{width:100%}
    .files-table-row .file-meta{font-size:.75rem}
    .file-card .file-thumb{height:120px}
    .files-bulk-bar{flex-direction:column;align-items:flex-start;gap:10px}
  }
  @media (max-width:540px){
    .files-actions{justify-content:flex-start}
    .upload-progress{width:100%;margin-left:0;flex-direction:column;align-items:flex-start;gap:4px}
    .upload-progress-track{width:100%;max-width:none}
    .upload-progress-percent{align-self:flex-end}
    .upload-progress-text{max-width:none}
    .storage-usage{flex:1 1 100%;max-width:none}
    .storage-usage-hint{margin-left:0}
    .storage-usage-footer{flex-direction:column;align-items:flex-start}
  }
</style>
<style id="metas-css">
  .metas-wrap{margin-left:var(--margin-left);margin-right:var(--margin-right);display:flex;flex-direction:column;gap:8px;overflow-x:auto;padding-bottom:16px}
  .metas-toolbar{display:flex;gap:6px;align-items:center;background:var(--title-bg);border:1px solid var(--shell-border);padding:8px;border-radius:10px;flex-wrap:wrap}
  .metas-year-selector{display:flex;align-items:center;gap:8px;margin-right:auto;padding:4px 8px;background:rgba(59,130,246,.1);border-radius:8px;border:1px solid rgba(59,130,246,.3)}
  .metas-year-selector label{margin:0;white-space:nowrap}
  .metas-summary{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin-bottom:8px}
  .metas-summary .meta-panel{background:var(--title-bg);border:1px solid var(--shell-border);border-radius:8px;padding:12px;display:flex;flex-direction:column;gap:12px}
  .metas-summary .meta-panel select{margin-bottom:8px;font-size:.9rem}
  .metas-summary .meta-panel .stats{display:flex;flex-direction:column;gap:8px}
  .metas-summary .meta-panel .stat-line{display:flex;flex-direction:column}
  .metas-summary .meta-panel .stat-label{font-size:.75rem;color:var(--muted)}
  .metas-summary .meta-panel .stat-value{font-size:1.4rem;font-weight:700}
  .metas-table{width:100%;border-collapse:collapse;font-size:.75rem;table-layout:fixed}
  .metas-table col.meta-col-info{width:220px}
  .metas-table col.meta-col-month{width:80px}
  .metas-table col.meta-col-total{width:90px}
  .metas-table th,.metas-table td{border:1px solid var(--shell-border);padding:1px;text-align:center;white-space:nowrap;vertical-align:middle}
  .metas-table th.meta-name{background:#333;color:#fff;width:220px}
  .metas-table td.meta-info{background:#333;color:#fff;text-align:left;vertical-align:top;min-width:220px;width:220px;white-space:normal;font-weight:600}
  .metas-table th:not(.meta-name),.metas-table td:not(.meta-info){min-width:80px}
  .metas-table tr.projetado td{background:#d1d5db;color:#000}
  .metas-table tr.realizado td{background:#fff;color:#000}
  .metas-table tr.conclusao td{font-weight:700}
  .metas-table tr.evolucao td{background:#111;color:#fff}
  .metas-table td.meta-info input,.metas-table td.meta-info select{width:100%;margin-bottom:2px;background:#1a1a1a;color:#fff;border:1px solid #333;border-radius:4px;padding:2px}
  .metas-table td.meta-info .actions{display:flex;gap:2px;margin-top:2px}
  .metas-table td.meta-info .actions button.paste-values{background:rgba(59,130,246,.15);border-color:rgba(59,130,246,.3);color:#60a5fa}
  .metas-table td.meta-info .actions button.paste-values:hover{background:rgba(59,130,246,.25);border-color:rgba(59,130,246,.5)}
  .metas-table td.meta-info .actions button.auto-fill{background:rgba(16,185,129,.15);border-color:rgba(16,185,129,.3);color:#34d399;font-weight:600}
  .metas-table td.meta-info .actions button.auto-fill:hover{background:rgba(16,185,129,.25);border-color:rgba(16,185,129,.5);transform:translateY(-1px);box-shadow:0 4px 8px rgba(16,185,129,.2)}
  .metas-table td.meta-info .actions button.view-analysis{background:rgba(139,92,246,.15);border-color:rgba(139,92,246,.3);color:#a78bfa;font-weight:600}
  .metas-table td.meta-info .actions button.view-analysis:hover{background:rgba(139,92,246,.25);border-color:rgba(139,92,246,.5);transform:translateY(-1px);box-shadow:0 4px 8px rgba(139,92,246,.2)}
  
  /* Modal de An√°lise - Backdrop e Bot√£o Fechar */
  #metaAnalysisModal .close-modal-btn:hover{color:#f1f5f9;transform:scale(1.1)}
  #metaAnalysisModal.show{animation:fadeIn 0.2s ease-out}
  #metaAnalysisModal .modal-card{animation:slideIn 0.3s ease-out}
  @keyframes fadeIn{
    from{opacity:0}
    to{opacity:1}
  }
  @keyframes slideIn{
    from{opacity:0;transform:translateY(-30px) scale(0.95)}
    to{opacity:1;transform:translateY(0) scale(1)}
  }
  
  .metas-table td:not(.meta-info) input{width:100%;text-align:center}
  .metas-table tr.meta-inactive td,.metas-table tr.meta-inactive th{background:#374151!important;color:#cbd5f5!important}
  .metas-table tr.meta-inactive td.meta-info{background:#1f2937!important;color:#cbd5f5!important}
  .metas-table tr.meta-inactive td input,.metas-table tr.meta-inactive td select{background:#1f2937;color:#cbd5f5;border-color:#4b5563}
  .metas-table tr.meta-inactive td .meta-bulk-btn{background:#1f2937;color:#e2e8f0;border-color:#4b5563}
  .meta-cell{position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;padding:8px 4px}
  .meta-cell input{width:100%;min-width:80px;text-align:center;padding:6px 8px;font-size:.9rem}
  .meta-bulk-btn{background:rgba(255,255,255,.05);border:1px solid var(--shell-border);border-radius:4px;color:#f9fafb;cursor:pointer;font-size:.65rem;padding:2px 6px;line-height:1;opacity:.65;transition:opacity .2s ease;position:relative;width:auto;align-self:center}
  .meta-bulk-btn:hover,.meta-bulk-btn:focus{opacity:1}
  .meta-bulk-menu{position:absolute;z-index:10000;display:none;flex-direction:column;gap:8px;width:240px;background:#0f172a;border:1px solid var(--shell-border);border-radius:10px;padding:10px;box-shadow:0 12px 30px rgba(15,23,42,.6)}
  .meta-bulk-menu.show{display:flex}
  .meta-bulk-header{font-size:.75rem;font-weight:700;color:#f9fafb}
  .meta-bulk-quick{display:flex;flex-wrap:wrap;gap:6px}
  .meta-bulk-quick button{background:rgba(255,255,255,.08);border:1px solid var(--shell-border);border-radius:6px;color:#e2e8f0;cursor:pointer;font-size:.7rem;padding:4px 6px;line-height:1}
  .meta-bulk-quick button:hover,.meta-bulk-quick button:focus{filter:brightness(1.1)}
  .meta-bulk-quick button:disabled{opacity:.4;cursor:default;filter:none}
  .meta-bulk-list{display:grid;grid-template-columns:1fr;gap:4px;max-height:220px;overflow:auto;padding:2px}
  .meta-bulk-list label{display:flex;align-items:center;gap:6px;font-size:.75rem;color:#e2e8f0}
  .meta-bulk-footer{display:flex;justify-content:flex-end;gap:6px}
  .meta-bulk-footer button{background:#2563eb;border:1px solid #1d4ed8;border-radius:6px;color:#fff;cursor:pointer;font-size:.75rem;padding:5px 10px;line-height:1}
  .meta-bulk-footer .cancel{background:rgba(255,255,255,.08);border-color:var(--shell-border);color:#e2e8f0}
  .meta-title-content{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .meta-title-text{font-weight:700;flex:1}
  .meta-activation{display:flex;align-items:center;gap:6px;margin-bottom:4px}
  .meta-title-cell .meta-activation{margin-bottom:0;margin-left:auto}
  .meta-toggle{border:1px solid #4b5563;border-radius:999px;padding:4px 12px;font-weight:700;cursor:pointer;background:#1f2937;color:#e5e7eb;transition:background .2s ease,color .2s ease,border-color .2s ease}
  .meta-toggle.on{background:#166534;border-color:#16a34a;color:#f0fdf4}
  .meta-toggle.off{background:#374151;border-color:#4b5563;color:#cbd5f5}
  .metas-table tr.meta-inactive .meta-toggle{background:#4b5563;border-color:#6b7280;color:#e5e7eb}
  @media (max-width:820px){.meta-bulk-btn{opacity:1}}
  .metas-table thead{position:sticky;top:0;z-index:2}
  .metas-table thead th{background:#1f2937;color:#fff;z-index:2}
  @media (max-width:820px){
    .metas-table{font-size:.7rem;min-width:900px}
    .metas-table col.meta-col-month{width:72px}
    .metas-table col.meta-col-total{width:84px}
  }
  @media (max-width:600px){
    .metas-table{font-size:.6rem;min-width:600px}
    .metas-table col.meta-col-month{width:68px}
    .metas-table col.meta-col-total{width:80px}
    .metas-table th.meta-name,.metas-table td.meta-info{display:none}
    .metas-toolbar{flex-wrap:wrap}
    .metas-toolbar .btn{font-size:.75rem;padding:4px 8px}
  }
  .concl-azul{background:#1e40af;color:#fff}
  .concl-verde{background:#2e7d32;color:#fff}
  .concl-amarelo{background:#f6e05e;color:#000}
  .concl-laranja{background:#fb923c;color:#000}
  .concl-vermelho{background:#dc2626;color:#fff}
  .meta-setor{margin-bottom:8px}
  .meta-setor h3{margin:0 0 4px}
  .meta-setor.marketing h3{color:purple}
  .meta-setor.comercial h3{color:blue}
  .meta-setor.marketing .metas-table th.meta-name,
  .meta-setor.marketing .metas-table td.meta-info{background:purple;color:#fff}
  .meta-setor.comercial .metas-table th.meta-name,
  .meta-setor.comercial .metas-table td.meta-info{background:blue;color:#fff}
  .metas-table .meta-title-spacer{border:none;background:transparent;width:220px}
  .metas-table tr.meta-title-row td.meta-title-cell{background:#f59e0b;color:#000;font-weight:700;text-align:center}
  .metas-table tr.meta-months-row td{background:#1f2937;color:#fff;font-weight:700}
  .metas-table tr.meta-gap td{border:none;height:4px;padding:0;background:transparent}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.9/dist/purify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="commemorative_dates_2025.js"></script>
<script src="sendgrid-integration.js"></script>
<style>
  #refreshBtn {
    position: fixed;
    top: 10px;
    right: 10px;
    padding: 8px 12px;
    border: 0;
    border-radius: 8px;
    background: #333;
    color: #fff;
    cursor: pointer;
    z-index: 1000;
    display: none;
  }
  /* Remove completamente o bot√£o de atualizar no mobile (aba/slice superior) */
  @media (max-width: 820px){
    #refreshBtn{ display:none !important; visibility:hidden !important; }
    /* Esconde o card de uso de armazenamento apenas no mobile */
    .storage-usage{ display:none !important; }
  }
</style>
<style>
  /* Futuristic loading overlay */
  #loadingScreen{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background:rgba(0,0,0,0.85);
    z-index:10000;
  }
  #loadingScreen .loader{
    width:80px;
    height:80px;
    border:4px solid rgba(255,255,255,0.1);
    border-top:4px solid #00ffff;
    border-radius:50%;
    animation:spin 1s linear infinite;
  }
  @keyframes spin{to{transform:rotate(360deg);}}
  </style>
<style id="mobile-optimizations">
  @media (max-width: 430px) {
    :root {
      --margin-left: 10px;
      --margin-right: 10px;
      --iframe-h: 420px;
    }

    body {
      width: 100%;
      overflow-x: hidden;
    }

    #userArea {
      padding: 10px;
    }

    [class$="-wrap"],
    [class$="Wrap"] {
      margin-left: var(--margin-left);
      margin-right: var(--margin-right);
    }

    .tabs {
      padding: 0;
      margin: 8px 0;
      gap: 6px;
      justify-content: flex-start;
      overflow-x: auto;
      width: 100%;
    }

    .tabs::-webkit-scrollbar {
      display: none;
    }

    .topbar,
    [class$="-toolbar"],
    [class$="-filters"],
    .macro-actions,
    .widget-actions,
    .ia-docs-actions,
    .ia-main-actions,
    .access-toolbar .access-actions,
    .files-actions {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      width: 100%;
      gap: 10px;
    }

    .topbar > *,
    [class$="-toolbar"] > *,
    [class$="-filters"] > *,
    .macro-actions > *,
    .widget-actions > *,
    .ia-docs-actions > *,
    .ia-main-actions > *,
    .access-toolbar .access-actions > *,
    .files-actions > * {
      width: 100%;
    }

    .right-tools,
    .profile-area,
    .actions-inline,
    .actions {
      width: 100%;
      justify-content: flex-start;
      gap: 8px;
    }

    input:not([type="checkbox"]):not([type="radio"]),
    select,
    textarea,
    .input,
    .btn,
    button {
      width: 100%;
      max-width: 100%;
    }

    .btn.small {
      padding: 10px;
    }

    .calendar,
    .frame-shell,
    iframe {
      width: 100%;
    }

    .dashboard,
    .widgets-grid {
      grid-template-columns: 1fr;
      width: 100%;
    }

    .modal {
      padding: 0;
    }

    .modal-card {
      width: 100dvw;
      height: 100dvh;
      max-width: none;
      max-height: none;
      border-radius: 0;
      display: flex;
      flex-direction: column;
    }

    .modal-body {
      display: flex;
      flex-direction: column;
      flex: 1;
      overflow: auto;
    }

    .modal-foot {
      flex-wrap: wrap;
      width: 100%;
      gap: 8px;
    }

    .access-row,
    .form-inline {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .access-row .cell,
    .form-inline > * {
      width: 100%;
    }

    .table-wrap {
      overflow: visible;
    }

    table {
      width: 100%;
      display: block;
      border-collapse: separate;
      border-spacing: 0;
    }

    table thead {
      display: none;
    }

    table tbody {
      display: block;
      width: 100%;
    }

    table tr {
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--shell-border, rgba(255, 255, 255, 0.14));
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 12px;
    }

    table td {
      width: 100%;
      display: block;
    }

    table td[data-label]::before {
      content: attr(data-label);
      display: block;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--muted, #bbb);
      margin-bottom: 4px;
      font-weight: 700;
    }

    table td:first-child:not([data-label]) {
      font-weight: 700;
    }
  }

  /* Aba Relat√≥rio */
  .relatorio-wrap{
    margin-left:var(--margin-left);
    margin-right:var(--margin-right);
    display:flex;
    flex-direction:column;
    gap:20px;
  }
  .relatorio-container{
    background:var(--panel);
    border:1px solid var(--shell-border);
    border-radius:16px;
    padding:24px;
    box-shadow:0 10px 28px rgba(0,0,0,.35);
  }
  /* Estilos para tabelas nos relat√≥rios - bordas verticais (pipe |) */
  .relatorio-container table{
    width:100%;
    border-collapse:collapse;
    margin:16px 0;
    font-size:.85rem;
    background:rgba(15,23,42,.4);
    border-radius:8px;
    overflow:hidden;
  }
  .relatorio-container table th,
  .relatorio-container table td{
    border:1px solid rgba(255,255,255,.15);
    padding:10px 12px;
    text-align:left;
  }
  .relatorio-container table th{
    background:rgba(99,102,241,.2);
    color:#fff;
    font-weight:700;
    text-transform:uppercase;
    font-size:.75rem;
    letter-spacing:.03em;
  }
  .relatorio-container table tr:nth-child(even){
    background:rgba(255,255,255,.03);
  }
  .relatorio-container table tr:hover{
    background:rgba(99,102,241,.1);
  }
  .relatorio-container table td{
    color:rgba(255,255,255,.85);
  }
  .relatorio-header{
    margin-bottom:24px;
  }
  .relatorio-header h2{
    margin:0 0 8px;
    font-size:1.8rem;
    font-weight:900;
    background:linear-gradient(135deg,#ff6633,#ff944d);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text;
  }
  .relatorio-subtitle{
    margin:0;
    color:#94a3b8;
    font-size:.95rem;
  }
  .relatorio-desc{
    margin:14px auto 0;
    color:#e5ecff;
    font-size:1.06rem;
    line-height:1.6;
    text-align:center;
    font-weight:700;
    letter-spacing:.01em;
    max-width:980px;
  }
  .relatorio-filters{
    display:flex;
    flex-wrap:wrap;
    gap:16px;
    align-items:flex-end;
    padding:20px;
    background:rgba(255,255,255,.02);
    border:1px solid rgba(255,255,255,.08);
    border-radius:12px;
    margin-bottom:24px;
  }
  .relatorio-filter-group{
    display:flex;
    flex-direction:column;
    gap:8px;
    min-width:180px;
  }
  .relatorio-filter-group label{
    font-size:.85rem;
    font-weight:700;
    color:#cbd5f5;
    text-transform:uppercase;
    letter-spacing:.06em;
  }
  .relatorio-preview{
    min-height:400px;
    background:rgba(255,255,255,.02);
    border:1px solid rgba(255,255,255,.08);
    border-radius:12px;
    padding:32px;
  }
  .relatorio-preview.has-meta{
    min-height:auto;
    padding:12px;
  }
  .relatorio-preview-meta{
    display:flex;
    align-items:center;
    gap:10px;
    color:#cbd5f5;
    font-size:.95rem;
    background:rgba(255,255,255,.02);
    border:1px dashed rgba(255,255,255,.12);
    border-radius:10px;
    padding:10px 12px;
  }
  .relatorio-preview-meta .meta-item.ok{ color:#86efac; font-weight:800; }
  .relatorio-preview-meta .meta-sep{ opacity:.6 }
  
  /* Hist√≥rico de Relat√≥rios */
  .relatorio-history-tab{
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 14px;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(147, 51, 234, 0.15));
    border: 1px solid rgba(59, 130, 246, 0.3);
    border-radius: 10px;
    color: #cbd5e1;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .relatorio-history-tab:hover{
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.25), rgba(147, 51, 234, 0.25));
    border-color: rgba(59, 130, 246, 0.5);
    transform: translateY(-2px);
  }
  .relatorio-history-tab .tab-date{
    color: #f8fafc;
    font-weight: 700;
  }
  .relatorio-history-tab .tab-badge{
    background: rgba(34, 197, 94, 0.2);
    color: #86efac;
    padding: 2px 8px;
    border-radius: 6px;
    font-size: 0.7rem;
    font-weight: 700;
  }
  
  @media (max-width:820px){
    .relatorio-preview-meta{ flex-wrap:wrap; justify-content:center; text-align:center; }
    .relatorio-preview-meta .meta-sep{ display:none }
  }
  .relatorio-empty{
    display:flex;
    align-items:center;
    justify-content:center;
    min-height:300px;
    text-align:center;
  }
  .relatorio-empty p{
    font-size:1.1rem;
    color:#94a3b8;
    margin:0;
  }
  .relatorio-content{
    display:flex;
    flex-direction:column;
    gap:24px;
  }
  .relatorio-section{
    background:rgba(0,0,0,.3);
    border:1px solid rgba(255,255,255,.12);
    border-radius:12px;
    padding:20px;
  }
  .relatorio-section h3{
    margin:0 0 16px;
    font-size:1.3rem;
    font-weight:800;
    color:#ff6633;
    border-bottom:2px solid #ff6633;
    padding-bottom:8px;
  }
  .relatorio-metric{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:12px 0;
    border-bottom:1px solid rgba(255,255,255,.08);
  }
  .relatorio-metric:last-child{
    border-bottom:none;
  }
  .relatorio-metric-label{
    font-weight:700;
    color:#cbd5f5;
  }
  .relatorio-metric-value{
    font-size:1.2rem;
    font-weight:800;
    color:#ff6633;
  }
  @media (max-width:768px){
    .relatorio-filters{
      flex-direction:column;
      align-items:stretch;
    }
    .relatorio-filter-group{
      width:100%;
    }
    .relatorio-filters .btn{
      width:100%;
    }
  }
  
  /* Carrossel de Stories do Relat√≥rio */
  .relatorio-stories-carousel{
    position:relative;
    display:flex;
    align-items:center;
    gap:12px;
  }
  .relatorio-stories-grid{
    flex:1;
    display:flex;
    gap:12px;
    overflow-x:auto;
    scroll-behavior:smooth;
    padding:12px 4px;
    -webkit-overflow-scrolling:touch;
  }
  .relatorio-stories-grid::-webkit-scrollbar{
    height:8px;
  }
  .relatorio-stories-grid::-webkit-scrollbar-track{
    background:rgba(255,255,255,.05);
    border-radius:4px;
  }
  .relatorio-stories-grid::-webkit-scrollbar-thumb{
    background:#ff6633;
    border-radius:4px;
  }
  .relatorio-stories-grid::-webkit-scrollbar-thumb:hover{
    background:#ff7744;
  }
  .relatorio-story-item{
    min-width:120px;
    width:120px;
    height:200px;
    border-radius:12px;
    overflow:hidden;
    position:relative;
    cursor:pointer;
    background:rgba(0,0,0,.4);
    border:2px solid rgba(255,255,255,.1);
    transition:all .3s ease;
    flex-shrink:0;
  }
  .relatorio-story-item:hover{
    transform:translateY(-4px);
    border-color:#ff6633;
    box-shadow:0 8px 24px rgba(255,102,51,.3);
  }
  .relatorio-story-item img{
    width:100%;
    height:100%;
    object-fit:cover;
  }
  .relatorio-story-item.video::before{
    content:"‚ñ∂";
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    font-size:2rem;
    color:#fff;
    text-shadow:0 2px 8px rgba(0,0,0,.8);
    z-index:2;
  }
  .relatorio-story-date{
    position:absolute;
    bottom:0;
    left:0;
    right:0;
    background:linear-gradient(to top,rgba(0,0,0,.9),transparent);
    color:#fff;
    font-size:.75rem;
    font-weight:700;
    padding:8px 6px 6px;
    text-align:center;
  }
  .relatorio-story-status{
    position:absolute;
    top:6px;
    right:6px;
    width:12px;
    height:12px;
    border-radius:50%;
    border:2px solid #fff;
    box-shadow:0 2px 4px rgba(0,0,0,.5);
  }
  .relatorio-story-item.aprovado .relatorio-story-status{
    background:#4ade80;
  }
  .relatorio-story-item.aprovado-interno .relatorio-story-status{
    background:#60a5fa;
  }
  .relatorio-story-item.revisar .relatorio-story-status{
    background:#fbbf24;
  }
  .relatorio-story-item.pendente .relatorio-story-status{
    background:#94a3b8;
  }
  .relatorio-stories-empty{
    width:100%;
    text-align:center;
    padding:40px 20px;
    color:#94a3b8;
  }
  .carousel-nav{
    background:rgba(255,102,51,.2);
    border:2px solid #ff6633;
    color:#ff6633;
    width:40px;
    height:40px;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:1.5rem;
    font-weight:700;
    cursor:pointer;
    transition:all .3s ease;
    flex-shrink:0;
  }
  .carousel-nav:hover{
    background:#ff6633;
    color:#fff;
    transform:scale(1.1);
  }
  .carousel-nav:active{
    transform:scale(.95);
  }
  @media (max-width:768px){
    .carousel-nav{
      width:32px;
      height:32px;
      font-size:1.2rem;
    }
    .relatorio-story-item{
      min-width:100px;
      width:100px;
      height:170px;
    }
  }
  
  /* Objetivos do m√™s (Planejamento) */
  .relatorio-goals-summary{
    display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin:10px 0 18px;
  }
  .goal-pill{ border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.05); color:#e2e8f0; padding:8px 12px; border-radius:999px; font-size:.9rem; }
  .goal-pill strong{ color:#fff; margin-left:4px; }
  .goal-done{ border-color:#14532d; background:rgba(20,83,45,.25); }
  .goal-progress{ border-color:#b45309; background:rgba(180,83,9,.22); }
  .goal-todo{ border-color:#1e3a8a; background:rgba(30,58,138,.22); }
  .goals-columns{ display:grid; grid-template-columns: repeat(3,1fr); gap:16px; }
  .goals-col{ border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:12px; }
  .goals-col[data-status="concluido"]{ background: rgba(22,163,74,.12); border-color: rgba(22,163,74,.35); }
  .goals-col[data-status="em-andamento"]{ background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.35); }
  .goals-col[data-status="nao-iniciado"]{ background: rgba(59,130,246,.12); border-color: rgba(59,130,246,.35); }
  .goals-col h3{ margin:0 0 10px; font-size:1rem; font-weight:800; color:#e2e8f0; border-bottom:2px solid rgba(255,255,255,.2); padding-bottom:8px; }
  .goals-list{ display:flex; flex-direction:column; gap:10px; }
  .goal-card{ border:1px solid rgba(255,255,255,.12); border-left:4px solid #64748b; background:rgba(255,255,255,.03); border-radius:10px; padding:10px 12px; cursor:pointer; transition:.2s ease; }
  .goal-card:hover{ transform:translateY(-2px); box-shadow:0 10px 24px rgba(0,0,0,.25); }
  .goal-title{ font-weight:800; color:#fff; margin:0 0 4px; font-size:.98rem; }
  .goal-meta{ font-size:.85rem; color:#cbd5f5; opacity:.9; display:flex; gap:8px; flex-wrap:wrap; }
  .goal-card.done{ border-left-color:#16a34a; }
  .goal-card.progress{ border-left-color:#f59e0b; }
  .goal-card.todo{ border-left-color:#3b82f6; }
  .goal-tag{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:.75rem; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); }
  @media(max-width:900px){ .goals-columns{ grid-template-columns:1fr; } }

  /* ===================== NOTAS TIME (Kanban Style) ===================== */
  .team-notes-wrap{
    margin-left:var(--margin-left);
    margin-right:var(--margin-right);
    display:flex;
    flex-direction:column;
    gap:16px;
    padding-bottom:40px;
  }
  .team-notes-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    flex-wrap:wrap;
    gap:12px;
    padding:16px 20px;
    background:linear-gradient(135deg, rgba(99,102,241,.12), rgba(168,85,247,.12));
    border:1px solid rgba(99,102,241,.25);
    border-radius:14px;
  }
  .team-notes-header h2{
    margin:0;
    font-size:1.4rem;
    font-weight:800;
    color:#fff;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .team-notes-header p{
    margin:0;
    color:#a5b4fc;
    font-size:.9rem;
  }
  .team-notes-board{
    display:flex;
    gap:16px;
    overflow-x:auto;
    padding-bottom:16px;
    scroll-behavior:smooth;
    -webkit-overflow-scrolling:touch;
    scrollbar-width:thin;
    scrollbar-color:rgba(99,102,241,.4) transparent;
  }
  .team-notes-board::-webkit-scrollbar{
    height:8px;
  }
  .team-notes-board::-webkit-scrollbar-track{
    background:rgba(255,255,255,.05);
    border-radius:4px;
  }
  .team-notes-board::-webkit-scrollbar-thumb{
    background:rgba(99,102,241,.4);
    border-radius:4px;
  }
  .team-notes-board::-webkit-scrollbar-thumb:hover{
    background:rgba(99,102,241,.6);
  }
  .team-notes-column{
    flex:0 0 320px;
    min-width:320px;
    background:rgba(15,23,42,.6);
    border:1px solid rgba(99,102,241,.2);
    border-radius:14px;
    display:flex;
    flex-direction:column;
    max-height:calc(100vh - 280px);
  }
  .team-notes-column-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:14px 16px;
    border-bottom:1px solid rgba(99,102,241,.2);
    background:rgba(99,102,241,.1);
    border-radius:14px 14px 0 0;
  }
  .team-notes-column-title{
    font-size:1rem;
    font-weight:700;
    color:#e2e8f0;
    margin:0;
    display:flex;
    align-items:center;
    gap:8px;
  }
  .team-notes-column-title .column-icon{
    font-size:1.1rem;
  }
  .team-notes-column-count{
    background:rgba(99,102,241,.3);
    color:#a5b4fc;
    font-size:.75rem;
    font-weight:700;
    padding:2px 8px;
    border-radius:999px;
  }
  .team-notes-column-cards{
    flex:1;
    overflow-y:auto;
    padding:12px;
    display:flex;
    flex-direction:column;
    gap:10px;
    scrollbar-width:thin;
    scrollbar-color:rgba(255,255,255,.2) transparent;
  }
  .team-notes-column-cards::-webkit-scrollbar{
    width:6px;
  }
  .team-notes-column-cards::-webkit-scrollbar-track{
    background:transparent;
  }
  .team-notes-column-cards::-webkit-scrollbar-thumb{
    background:rgba(255,255,255,.2);
    border-radius:3px;
  }
  .team-notes-add-btn{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:6px;
    padding:12px;
    margin:12px;
    background:rgba(99,102,241,.15);
    border:1px dashed rgba(99,102,241,.4);
    border-radius:10px;
    color:#a5b4fc;
    font-size:.9rem;
    font-weight:600;
    cursor:pointer;
    transition:all .2s ease;
  }
  .team-notes-add-btn:hover{
    background:rgba(99,102,241,.25);
    border-color:rgba(99,102,241,.6);
    color:#fff;
    transform:translateY(-1px);
  }
  .team-notes-card{
    background:rgba(30,41,59,.8);
    border:1px solid rgba(99,102,241,.2);
    border-radius:10px;
    padding:12px;
    cursor:pointer;
    transition:all .2s ease;
    position:relative;
  }
  .team-notes-card:hover{
    background:rgba(30,41,59,1);
    border-color:rgba(99,102,241,.4);
    transform:translateY(-2px);
    box-shadow:0 8px 20px rgba(0,0,0,.3);
  }
  .team-notes-card-content{
    font-size:.9rem;
    color:#e2e8f0;
    line-height:1.5;
    word-break:break-word;
    white-space:pre-wrap;
    max-height:200px;
    overflow:hidden;
    position:relative;
  }
  .team-notes-card-content.expanded{
    max-height:none;
  }
  .team-notes-card-content img{
    max-width:100%;
    border-radius:8px;
    margin:8px 0;
  }
  .team-notes-card-content a{
    color:#60a5fa;
    text-decoration:underline;
  }
  .team-notes-card-meta{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-top:10px;
    padding-top:10px;
    border-top:1px solid rgba(255,255,255,.08);
    font-size:.75rem;
    color:#94a3b8;
  }
  .team-notes-card-author{
    display:flex;
    align-items:center;
    gap:6px;
  }
  .team-notes-card-author img{
    width:20px;
    height:20px;
    border-radius:50%;
    object-fit:cover;
  }
  .team-notes-card-actions{
    display:flex;
    gap:6px;
    opacity:0;
    transition:opacity .2s ease;
  }
  .team-notes-card:hover .team-notes-card-actions{
    opacity:1;
  }
  .team-notes-card-actions button{
    background:rgba(255,255,255,.1);
    border:none;
    border-radius:6px;
    padding:4px 8px;
    color:#94a3b8;
    cursor:pointer;
    font-size:.8rem;
    transition:all .15s ease;
  }
  .team-notes-card-actions button:hover{
    background:rgba(255,255,255,.2);
    color:#fff;
  }
  .team-notes-card-actions button.delete:hover{
    background:rgba(239,68,68,.3);
    color:#fca5a5;
  }
  /* Modal de edi√ß√£o de nota */
  .team-notes-modal{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.7);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:100000;
    padding:20px;
  }
  .team-notes-modal.show{
    display:flex;
  }
  .team-notes-modal-content{
    width:min(600px, 95vw);
    max-height:85vh;
    background:#1e293b;
    border:1px solid rgba(99,102,241,.3);
    border-radius:16px;
    display:flex;
    flex-direction:column;
    overflow:hidden;
  }
  .team-notes-modal-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:16px 20px;
    border-bottom:1px solid rgba(99,102,241,.2);
    background:rgba(99,102,241,.1);
  }
  .team-notes-modal-header h3{
    margin:0;
    font-size:1.1rem;
    font-weight:700;
    color:#fff;
  }
  .team-notes-modal-close{
    background:rgba(255,255,255,.1);
    border:none;
    border-radius:8px;
    padding:8px 12px;
    color:#94a3b8;
    cursor:pointer;
    transition:all .15s ease;
  }
  .team-notes-modal-close:hover{
    background:rgba(239,68,68,.3);
    color:#fca5a5;
  }
  .team-notes-modal-body{
    flex:1;
    overflow-y:auto;
    padding:20px;
    display:flex;
    flex-direction:column;
    gap:16px;
  }
  .team-notes-modal-body label{
    font-size:.85rem;
    font-weight:600;
    color:#94a3b8;
    display:block;
    margin-bottom:6px;
  }
  .team-notes-modal-body textarea{
    width:100%;
    min-height:180px;
    background:rgba(15,23,42,.6);
    border:1px solid rgba(99,102,241,.3);
    border-radius:10px;
    padding:12px;
    color:#e2e8f0;
    font-size:.95rem;
    line-height:1.6;
    resize:vertical;
    font-family:inherit;
    white-space:pre-wrap;
    word-wrap:break-word;
    overflow-wrap:break-word;
  }
  .team-notes-modal-body textarea:focus{
    outline:none;
    border-color:rgba(99,102,241,.6);
    box-shadow:0 0 0 3px rgba(99,102,241,.15);
  }
  .team-notes-modal-attachments{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    padding:12px;
    background:rgba(15,23,42,.4);
    border:1px dashed rgba(99,102,241,.3);
    border-radius:10px;
  }
  .team-notes-modal-attachments-label{
    width:100%;
    font-size:.8rem;
    color:#64748b;
    margin-bottom:4px;
  }
  .team-notes-attachment-preview{
    position:relative;
    width:80px;
    height:80px;
    border-radius:8px;
    overflow:hidden;
    border:1px solid rgba(255,255,255,.1);
  }
  .team-notes-attachment-preview img{
    width:100%;
    height:100%;
    object-fit:cover;
  }
  .team-notes-attachment-preview .remove-attachment{
    position:absolute;
    top:4px;
    right:4px;
    width:20px;
    height:20px;
    background:rgba(239,68,68,.9);
    border:none;
    border-radius:50%;
    color:#fff;
    font-size:12px;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .team-notes-modal-upload-btn{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:6px;
    width:80px;
    height:80px;
    background:rgba(99,102,241,.15);
    border:1px dashed rgba(99,102,241,.4);
    border-radius:8px;
    color:#a5b4fc;
    font-size:1.5rem;
    cursor:pointer;
    transition:all .2s ease;
  }
  .team-notes-modal-upload-btn:hover{
    background:rgba(99,102,241,.25);
    border-color:rgba(99,102,241,.6);
  }
  .team-notes-modal-footer{
    display:flex;
    justify-content:flex-end;
    gap:10px;
    padding:16px 20px;
    border-top:1px solid rgba(99,102,241,.2);
    background:rgba(15,23,42,.4);
  }
  .team-notes-modal-footer .btn{
    padding:10px 20px;
    font-weight:600;
  }
  /* CR√çTICO: Prevenir iframes dentro do modal */
  .team-notes-modal iframe,
  .team-notes-modal-content iframe,
  .team-notes-modal-body iframe{
    display:none !important;
    visibility:hidden !important;
    pointer-events:none !important;
  }
  
  /* ========== TEMPLATE TR√ÅFEGO ========== */
  .template-question{
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 16px;
    background: rgba(15, 23, 42, 0.4);
    border: 1px solid rgba(99, 102, 241, 0.2);
    border-radius: 10px;
  }
  .template-label{
    font-size: 0.95rem;
    font-weight: 700;
    color: #e2e8f0;
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
  }
  .template-select, .template-input{
    width: 100%;
    background: rgba(15, 23, 42, 0.6);
    border: 1px solid rgba(99, 102, 241, 0.3);
    border-radius: 8px;
    padding: 10px 12px;
    color: #e2e8f0;
    font-size: 0.9rem;
    font-family: inherit;
    transition: all 0.2s ease;
  }
  .template-select:focus, .template-input:focus{
    outline: none;
    border-color: rgba(99, 102, 241, 0.6);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
  }
  .template-select option{
    background: #0f172a;
    color: #e2e8f0;
  }
  .template-question textarea{
    width: 100%;
    min-height: 80px;
    background: rgba(15, 23, 42, 0.6);
    border: 1px solid rgba(99, 102, 241, 0.3);
    border-radius: 8px;
    padding: 10px 12px;
    color: #e2e8f0;
    font-size: 0.9rem;
    line-height: 1.5;
    resize: vertical;
    font-family: inherit;
  }
  .template-question textarea:focus{
    outline: none;
    border-color: rgba(99, 102, 241, 0.6);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
  }
  .traffic-template-modal .team-notes-modal-content{
    scrollbar-width: thin;
    scrollbar-color: rgba(99, 102, 241, 0.4) transparent;
  }
  .traffic-template-modal .team-notes-modal-content::-webkit-scrollbar{
    width: 8px;
  }
  .traffic-template-modal .team-notes-modal-content::-webkit-scrollbar-track{
    background: rgba(255, 255, 255, 0.05);
    border-radius: 4px;
  }
  .traffic-template-modal .team-notes-modal-content::-webkit-scrollbar-thumb{
    background: rgba(99, 102, 241, 0.4);
    border-radius: 4px;
  }
  .team-notes-add-btn.secondary{
    font-size: 0.85rem;
    padding: 8px 14px;
  }
  /* ========== FIM TEMPLATE TR√ÅFEGO ========== */
  
  /* ========== MODAL DE VISUALIZA√á√ÉO/EXPANS√ÉO ========== */
  #expandNoteModal .team-notes-modal-content{
    max-width: 800px;
  }
  #expandNoteContent{
    padding: 20px;
    background: rgba(15, 23, 42, 0.4);
    border: 1px solid rgba(99, 102, 241, 0.2);
    border-radius: 10px;
    line-height: 1.8;
    color: #e2e8f0;
    font-size: 1rem;
  }
  #expandNoteContent a{
    color: #60a5fa;
    text-decoration: underline;
  }
  #expandNoteContent a:hover{
    color: #93c5fd;
  }
  #expandNoteAttachments img{
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  #expandNoteAttachments img:hover{
    transform: scale(1.02);
    box-shadow: 0 8px 16px rgba(0,0,0,0.3);
  }
  #expandNoteAuthor img{
    border: 2px solid rgba(99, 102, 241, 0.3);
  }
  #expandNoteModal .team-notes-modal-footer{
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  /* ========== FIM MODAL DE VISUALIZA√á√ÉO ========== */
  
  @media(max-width:820px){
    .team-notes-column{
      flex:0 0 280px;
      min-width:280px;
    }
    .team-notes-board{
      padding:0 8px 16px;
    }
    #expandNoteModal .team-notes-modal-content{
      max-width: 95vw;
    }
  }
  /* ===================== FIM NOTAS TIME ===================== */

  /* ===================== REUNI√ïES ===================== */
  .reunioes-wrap{
    display:flex;
    flex-direction:column;
    gap:16px;
    padding:16px;
    margin-left:var(--margin-left);
    margin-right:var(--margin-right);
  }
  .reunioes-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    flex-wrap:wrap;
    gap:12px;
    background:linear-gradient(135deg, rgba(59,130,246,0.1), rgba(99,102,241,0.1));
    border:1px solid rgba(59,130,246,0.3);
    border-radius:12px;
    padding:16px;
  }
  .reunioes-header h2{
    margin:0;
    font-size:1.2rem;
    color:#e2e8f0;
    display:flex;
    align-items:center;
    gap:8px;
  }
  .reunioes-header p{
    margin:4px 0 0;
    color:#94a3b8;
    font-size:0.85rem;
  }
  .reunioes-add-btn{
    background:linear-gradient(135deg, #3b82f6, #6366f1);
    border:none;
    border-radius:8px;
    padding:10px 20px;
    color:#fff;
    font-weight:600;
    cursor:pointer;
    display:flex;
    align-items:center;
    gap:8px;
    transition:all 0.2s ease;
  }
  .reunioes-add-btn:hover{
    transform:translateY(-2px);
    box-shadow:0 6px 20px rgba(59,130,246,0.4);
  }
  .reunioes-grid{
    display:flex;
    flex-wrap:wrap;
    gap:16px;
    align-items:flex-start;
  }
  .reuniao-card{
    flex:0 0 280px;
    min-width:280px;
    max-width:320px;
    background:rgba(30,41,59,0.8);
    border:1px solid rgba(59,130,246,0.2);
    border-radius:12px;
    padding:16px;
    cursor:pointer;
    transition:all 0.2s ease;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .reuniao-card:hover{
    background:rgba(30,41,59,1);
    border-color:rgba(59,130,246,0.4);
    transform:translateY(-2px);
    box-shadow:0 8px 24px rgba(0,0,0,0.3);
  }
  .reuniao-card-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
  }
  .reuniao-card-date{
    font-size:0.8rem;
    color:#60a5fa;
    font-weight:600;
    background:rgba(59,130,246,0.15);
    padding:4px 10px;
    border-radius:6px;
  }
  .reuniao-card-actions{
    display:flex;
    gap:6px;
    opacity:0;
    transition:opacity 0.2s ease;
  }
  .reuniao-card:hover .reuniao-card-actions{
    opacity:1;
  }
  .reuniao-card-actions button{
    background:rgba(255,255,255,0.1);
    border:none;
    border-radius:6px;
    padding:4px 8px;
    color:#94a3b8;
    cursor:pointer;
    font-size:0.8rem;
    transition:all 0.15s ease;
  }
  .reuniao-card-actions button:hover{
    background:rgba(255,255,255,0.2);
    color:#fff;
  }
  .reuniao-card-actions button.delete:hover{
    background:rgba(239,68,68,0.3);
    color:#fca5a5;
  }
  .reuniao-card-objetivo{
    font-size:0.95rem;
    color:#e2e8f0;
    font-weight:600;
    line-height:1.4;
    display:-webkit-box;
    -webkit-line-clamp:2;
    -webkit-box-orient:vertical;
    overflow:hidden;
  }
  .reuniao-card-resumo{
    font-size:0.85rem;
    color:#94a3b8;
    line-height:1.5;
    display:-webkit-box;
    -webkit-line-clamp:3;
    -webkit-box-orient:vertical;
    overflow:hidden;
    background:rgba(15,23,42,0.5);
    padding:10px;
    border-radius:8px;
    border-left:3px solid rgba(59,130,246,0.4);
  }
  .reuniao-card-resumo.empty{
    color:#64748b;
    font-style:italic;
    border-left-color:rgba(100,116,139,0.3);
  }
  .reuniao-card-footer{
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-top:auto;
    padding-top:10px;
    border-top:1px solid rgba(255,255,255,0.08);
  }
  .reuniao-view-btn{
    background:rgba(59,130,246,0.2);
    border:1px solid rgba(59,130,246,0.4);
    border-radius:6px;
    padding:6px 12px;
    color:#60a5fa;
    font-size:0.8rem;
    cursor:pointer;
    display:flex;
    align-items:center;
    gap:6px;
    transition:all 0.2s ease;
  }
  .reuniao-view-btn:hover{
    background:rgba(59,130,246,0.3);
    color:#fff;
  }
  /* Modal Reuni√£o */
  .reuniao-modal{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.75);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:100000;
    padding:20px;
  }
  .reuniao-modal.show{
    display:flex;
  }
  .reuniao-modal-content{
    width:min(950px, 95vw);
    max-height:92vh;
    background:#1e293b;
    border:1px solid rgba(59,130,246,0.3);
    border-radius:16px;
    display:flex;
    flex-direction:column;
    overflow:hidden;
  }
  .reuniao-modal-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:16px 20px;
    background:rgba(15,23,42,0.6);
    border-bottom:1px solid rgba(59,130,246,0.2);
  }
  .reuniao-modal-header h3{
    margin:0;
    color:#e2e8f0;
    font-size:1.1rem;
    display:flex;
    align-items:center;
    gap:8px;
  }
  .reuniao-modal-close{
    background:transparent;
    border:none;
    color:#94a3b8;
    font-size:1.5rem;
    cursor:pointer;
    padding:4px;
    line-height:1;
    transition:color 0.2s;
  }
  .reuniao-modal-close:hover{
    color:#fff;
  }
  .reuniao-modal-body{
    flex:1;
    overflow-y:auto;
    padding:20px;
    display:flex;
    flex-direction:column;
    gap:16px;
  }
  .reuniao-modal-body label{
    display:block;
    color:#cbd5e1;
    font-size:0.85rem;
    margin-bottom:6px;
    font-weight:500;
  }
  .reuniao-modal-body input,
  .reuniao-modal-body textarea{
    width:100%;
    background:rgba(15,23,42,0.6);
    border:1px solid rgba(99,102,241,0.3);
    border-radius:8px;
    padding:12px;
    color:#e2e8f0;
    font-size:0.95rem;
    transition:border-color 0.2s;
  }
  .reuniao-modal-body input:focus,
  .reuniao-modal-body textarea:focus{
    outline:none;
    border-color:rgba(59,130,246,0.6);
  }
  .reuniao-modal-body textarea{
    min-height:200px;
    resize:vertical;
    font-family:inherit;
    line-height:1.6;
  }
  .reuniao-modal-footer{
    display:flex;
    align-items:center;
    justify-content:flex-end;
    gap:12px;
    padding:16px 20px;
    background:rgba(15,23,42,0.4);
    border-top:1px solid rgba(59,130,246,0.2);
  }
  /* Modal Ver Resumo */
  .reuniao-resumo-section{
    background:rgba(15,23,42,0.5);
    border:1px solid rgba(59,130,246,0.2);
    border-radius:10px;
    padding:16px;
  }
  .reuniao-resumo-section h4{
    margin:0 0 12px;
    color:#60a5fa;
    font-size:0.95rem;
    display:flex;
    align-items:center;
    gap:8px;
  }
  .reuniao-resumo-content{
    color:#e2e8f0;
    font-size:0.9rem;
    line-height:1.7;
    white-space:pre-wrap;
    word-break:break-word;
  }
  .reuniao-transcricao-section{
    background:rgba(15,23,42,0.3);
    border:1px solid rgba(100,116,139,0.2);
    border-radius:10px;
    padding:16px;
  }
  .reuniao-transcricao-section h4{
    margin:0 0 12px;
    color:#94a3b8;
    font-size:0.9rem;
    display:flex;
    align-items:center;
    justify-content:space-between;
  }
  .reuniao-transcricao-content{
    color:#cbd5e1;
    font-size:0.85rem;
    line-height:1.6;
    white-space:pre-wrap;
    word-break:break-word;
    max-height:300px;
    overflow-y:auto;
  }
  .reuniao-generating{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    color:#60a5fa;
    font-size:0.9rem;
    padding:20px;
  }
  .reuniao-generating .spinner{
    width:20px;
    height:20px;
    border:2px solid rgba(59,130,246,0.3);
    border-top-color:#3b82f6;
    border-radius:50%;
    animation:spin 0.8s linear infinite;
  }
  @keyframes spin{
    to{transform:rotate(360deg);}
  }
  .reuniao-empty-state{
    text-align:center;
    padding:40px 20px;
    color:#64748b;
  }
  .reuniao-empty-state .icon{
    font-size:3rem;
    margin-bottom:16px;
    opacity:0.5;
  }
  .reuniao-empty-state p{
    margin:8px 0;
    font-size:0.95rem;
  }
  @media(max-width:820px){
    .reunioes-grid{
      justify-content:center;
    }
    .reuniao-card{
      flex:1 1 100%;
      max-width:100%;
    }
    .reuniao-modal-content{
      max-width:98vw;
      max-height:95vh;
    }
  }
  
  /* ========== CHAT IA REUNI√ïES - ESTILO CHATGPT ========== */
  .reunioes-chat-section{
    margin-top:32px;
    background:#0f172a;
    border:1px solid rgba(99,102,241,0.3);
    border-radius:16px;
    overflow:hidden;
    display:flex;
    height:700px;
    min-height:600px;
  }
  /* Sidebar lateral estilo ChatGPT - SEMPRE VIS√çVEL */
  .reunioes-chat-sidebar{
    width:280px;
    background:#1e1e2e;
    border-right:1px solid rgba(99,102,241,0.2);
    display:flex;
    flex-direction:column;
    flex-shrink:0;
  }
  .reunioes-chat-sidebar-header{
    padding:16px;
    border-bottom:1px solid rgba(255,255,255,0.1);
    background:rgba(99,102,241,0.1);
  }
  .reunioes-chat-sidebar-header-title{
    display:flex;
    align-items:center;
    gap:8px;
    color:#e2e8f0;
    font-size:0.95rem;
    font-weight:500;
    margin-bottom:12px;
  }
  .reunioes-chat-new-btn{
    width:100%;
    background:transparent;
    border:1px solid rgba(255,255,255,0.2);
    color:#fff;
    padding:12px 16px;
    border-radius:8px;
    font-size:0.9rem;
    cursor:pointer;
    display:flex;
    align-items:center;
    gap:10px;
    transition:all 0.2s;
  }
  .reunioes-chat-new-btn:hover{
    background:rgba(255,255,255,0.1);
  }
  .reunioes-chat-new-btn span{
    font-size:1.1rem;
    font-weight:300;
  }
  .reunioes-chat-sidebar-list{
    flex:1;
    overflow-y:auto;
    padding:8px;
  }
  .reunioes-chat-sidebar-list::-webkit-scrollbar{
    width:6px;
  }
  .reunioes-chat-sidebar-list::-webkit-scrollbar-thumb{
    background:rgba(255,255,255,0.2);
    border-radius:3px;
  }
  .reunioes-chat-history-item{
    display:flex;
    align-items:center;
    gap:10px;
    padding:10px 12px;
    border-radius:8px;
    cursor:pointer;
    transition:background 0.15s;
    margin-bottom:2px;
    position:relative;
  }
  .reunioes-chat-history-item:hover{
    background:rgba(255,255,255,0.1);
  }
  .reunioes-chat-history-item.active{
    background:rgba(99,102,241,0.3);
  }
  .reunioes-chat-history-item-icon{
    font-size:1rem;
    opacity:0.7;
  }
  .reunioes-chat-history-item-content{
    flex:1;
    min-width:0;
  }
  .reunioes-chat-history-item-title{
    font-size:0.82rem;
    color:#e2e8f0;
    line-height:1.3;
    display:-webkit-box;
    -webkit-line-clamp:2;
    -webkit-box-orient:vertical;
    overflow:hidden;
    word-break:break-word;
  }
  .reunioes-chat-history-item-date{
    font-size:0.7rem;
    color:#64748b;
    margin-top:2px;
  }
  .reunioes-chat-history-item-actions{
    display:none;
    gap:4px;
  }
  .reunioes-chat-history-item:hover .reunioes-chat-history-item-actions{
    display:flex;
  }
  .reunioes-chat-history-item-btn{
    background:transparent;
    border:none;
    color:#94a3b8;
    cursor:pointer;
    padding:4px;
    border-radius:4px;
    font-size:0.8rem;
    transition:all 0.15s;
  }
  .reunioes-chat-history-item-btn:hover{
    background:rgba(255,255,255,0.1);
    color:#fff;
  }
  .reunioes-chat-history-item-btn.delete:hover{
    background:rgba(239,68,68,0.2);
    color:#f87171;
  }
  .reunioes-chat-sidebar-footer{
    padding:12px;
    border-top:1px solid rgba(255,255,255,0.1);
    font-size:0.8rem;
    color:#64748b;
    display:flex;
    align-items:center;
    gap:6px;
  }
  .reunioes-chat-sidebar-footer strong{
    color:#a5b4fc;
  }
  .reunioes-chat-sidebar-empty{
    text-align:center;
    padding:40px 16px;
    color:#64748b;
  }
  .reunioes-chat-sidebar-empty-icon{
    font-size:2.5rem;
    margin-bottom:12px;
    opacity:0.5;
  }
  .reunioes-chat-sidebar-empty p{
    margin:0;
    font-size:0.85rem;
  }
  /* √Årea principal */
  .reunioes-chat-main{
    flex:1;
    display:flex;
    flex-direction:column;
    min-width:0;
    background:#0f172a;
  }
  .reunioes-chat-header{
    display:flex;
    align-items:center;
    gap:12px;
    padding:12px 16px;
    background:rgba(30,41,59,0.8);
    border-bottom:1px solid rgba(99,102,241,0.2);
  }
  .reunioes-chat-menu-btn{
    background:transparent;
    border:none;
    color:#94a3b8;
    font-size:1.3rem;
    cursor:pointer;
    padding:8px;
    border-radius:8px;
    transition:all 0.15s;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .reunioes-chat-menu-btn:hover{
    background:rgba(255,255,255,0.1);
    color:#fff;
  }
  .reunioes-chat-title{
    display:flex;
    align-items:center;
    gap:8px;
    font-size:1rem;
    color:#e2e8f0;
    font-weight:500;
  }
  .reunioes-chat-header-actions{
    margin-left:auto;
  }
  .reunioes-chat-count-badge{
    font-size:0.8rem;
    color:#64748b;
    background:rgba(30,41,59,0.8);
    padding:6px 12px;
    border-radius:20px;
  }
  .reunioes-chat-count-badge strong{
    color:#a5b4fc;
  }
  /* √Årea de mensagens */
  .reunioes-chat-messages{
    flex:1;
    overflow-y:auto;
    padding:20px;
    display:flex;
    flex-direction:column;
    gap:20px;
  }
  .reunioes-chat-messages::-webkit-scrollbar{
    width:8px;
  }
  .reunioes-chat-messages::-webkit-scrollbar-thumb{
    background:rgba(99,102,241,0.3);
    border-radius:4px;
  }
  .reunioes-chat-message{
    display:flex;
    gap:16px;
    max-width:100%;
    padding:16px 20px;
    border-radius:12px;
  }
  .reunioes-chat-message.user{
    background:rgba(59,130,246,0.1);
    flex-direction:row-reverse;
  }
  .reunioes-chat-message.assistant{
    background:rgba(30,41,59,0.6);
  }
  .reunioes-chat-message-avatar{
    width:32px;
    height:32px;
    border-radius:6px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:1rem;
    flex-shrink:0;
  }
  .reunioes-chat-message.user .reunioes-chat-message-avatar{
    background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  }
  .reunioes-chat-message.assistant .reunioes-chat-message-avatar{
    background:linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
  }
  .reunioes-chat-message-content{
    flex:1;
    color:#e2e8f0;
    font-size:0.95rem;
    line-height:1.7;
    min-width:0;
  }
  .reunioes-chat-message-content p{
    margin:0 0 12px;
  }
  .reunioes-chat-message-content p:last-child{
    margin-bottom:0;
  }
  .reunioes-chat-message-content ul,
  .reunioes-chat-message-content ol{
    margin:12px 0;
    padding-left:24px;
  }
  .reunioes-chat-message-content li{
    margin:6px 0;
  }
  .reunioes-chat-message-content strong{
    color:#60a5fa;
  }
  /* Bot√£o Copiar - Tudo */
  .reunioes-chat-copy-btn{
    display:inline-flex;
    align-items:center;
    gap:6px;
    margin-top:12px;
    padding:8px 14px;
    background:rgba(99,102,241,0.1);
    border:1px solid rgba(99,102,241,0.3);
    border-radius:8px;
    color:#94a3b8;
    font-size:0.8rem;
    cursor:pointer;
    transition:all 0.2s;
  }
  .reunioes-chat-copy-btn:hover{
    background:rgba(99,102,241,0.2);
    border-color:rgba(99,102,241,0.5);
    color:#e2e8f0;
  }
  /* Bloco de resposta com bot√£o copiar */
  .reunioes-chat-block{
    position:relative;
    display:flex;
    align-items:flex-start;
    gap:8px;
    padding:8px 10px;
    margin:4px -10px;
    border-radius:8px;
    transition:background 0.2s;
  }
  .reunioes-chat-block:hover{
    background:rgba(99,102,241,0.08);
  }
  .reunioes-chat-block-content{
    flex:1;
  }
  .reunioes-chat-block-content p{ margin:0; }
  .reunioes-chat-block-content ul{ margin:4px 0; padding-left:20px; }
  .reunioes-chat-block-content li{ margin:2px 0; }
  /* Bot√£o copiar linha */
  .reunioes-chat-copy-line-btn{
    flex-shrink:0;
    padding:4px 6px;
    background:rgba(99,102,241,0.15);
    border:1px solid rgba(99,102,241,0.3);
    border-radius:6px;
    color:#94a3b8;
    font-size:0.7rem;
    cursor:pointer;
    transition:all 0.2s;
    opacity:0.4;
  }
  .reunioes-chat-block:hover .reunioes-chat-copy-line-btn{
    opacity:1;
  }
  .reunioes-chat-copy-line-btn:hover{
    background:rgba(99,102,241,0.3);
    border-color:rgba(99,102,241,0.5);
    color:#e2e8f0;
    transform:scale(1.05);
  }
  /* Container copiar tudo */
  .reunioes-chat-copy-all{
    display:flex;
    gap:8px;
    margin-top:16px;
    padding-top:12px;
    border-top:1px solid rgba(99,102,241,0.15);
  }
  .reunioes-chat-copy-all .reunioes-chat-copy-btn{
    flex:1;
  }
  /* Input */
  .reunioes-chat-input-container{
    padding:12px 20px 20px;
    background:rgba(15,23,42,0.8);
    border-top:1px solid rgba(99,102,241,0.15);
  }
  .reunioes-chat-filter-row{
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom:12px;
    padding:0 4px;
  }
  .reunioes-chat-filter-row label{
    font-size:0.8rem;
    color:#94a3b8;
    white-space:nowrap;
  }
  .reunioes-chat-filter-row select{
    flex:1;
    background:rgba(30,41,59,0.9);
    border:1px solid rgba(99,102,241,0.3);
    border-radius:8px;
    padding:8px 12px;
    color:#e2e8f0;
    font-size:0.85rem;
    cursor:pointer;
    transition:all 0.2s;
    max-width:400px;
  }
  .reunioes-chat-filter-row select:hover{
    border-color:rgba(99,102,241,0.5);
  }
  .reunioes-chat-filter-row select:focus{
    outline:none;
    border-color:#6366f1;
  }
  .reunioes-chat-filter-row select option{
    background:#1e293b;
    color:#e2e8f0;
    padding:8px;
  }
  .reunioes-chat-input-wrapper{
    display:flex;
    align-items:flex-end;
    gap:12px;
    background:rgba(30,41,59,0.8);
    border:1px solid rgba(99,102,241,0.3);
    border-radius:16px;
    padding:8px 8px 8px 16px;
    transition:border-color 0.2s;
  }
  .reunioes-chat-input-wrapper:focus-within{
    border-color:rgba(99,102,241,0.6);
  }
  .reunioes-chat-input-wrapper textarea{
    flex:1;
    background:transparent;
    border:none;
    color:#e2e8f0;
    font-size:0.95rem;
    resize:none;
    min-height:24px;
    max-height:150px;
    font-family:inherit;
    line-height:1.5;
    padding:4px 0;
  }
  .reunioes-chat-input-wrapper textarea:focus{
    outline:none;
  }
  .reunioes-chat-input-wrapper textarea::placeholder{
    color:#64748b;
  }
  .reunioes-chat-send-btn{
    width:40px;
    height:40px;
    background:linear-gradient(135deg, #6366f1 0%, #3b82f6 100%);
    border:none;
    border-radius:10px;
    color:#fff;
    font-size:1.1rem;
    cursor:pointer;
    transition:all 0.2s;
    display:flex;
    align-items:center;
    justify-content:center;
    flex-shrink:0;
  }
  .reunioes-chat-send-btn:hover{
    transform:scale(1.05);
    box-shadow:0 4px 15px rgba(99,102,241,0.4);
  }
  .reunioes-chat-send-btn:disabled{
    opacity:0.5;
    cursor:not-allowed;
    transform:none;
  }
  /* Loading */
  .reunioes-chat-loading{
    display:flex;
    align-items:center;
    gap:8px;
    color:#94a3b8;
    font-size:0.85rem;
    padding:16px 20px;
    background:rgba(30,41,59,0.6);
    border-radius:12px;
  }
  .reunioes-chat-loading .dot{
    width:8px;
    height:8px;
    background:#6366f1;
    border-radius:50%;
    animation:chatDotPulse 1.4s ease-in-out infinite;
  }
  .reunioes-chat-loading .dot:nth-child(2){ animation-delay:0.2s; }
  .reunioes-chat-loading .dot:nth-child(3){ animation-delay:0.4s; }
  @keyframes chatDotPulse{
    0%,80%,100%{ transform:scale(0.6); opacity:0.5; }
    40%{ transform:scale(1); opacity:1; }
  }
  /* Welcome */
  .reunioes-chat-welcome{
    text-align:center;
    padding:60px 20px;
    color:#94a3b8;
    max-width:600px;
    margin:auto;
  }
  .reunioes-chat-welcome-icon{
    font-size:4rem;
    margin-bottom:20px;
  }
  .reunioes-chat-welcome h4{
    color:#e2e8f0;
    font-size:1.5rem;
    margin:0 0 12px;
    font-weight:600;
  }
  .reunioes-chat-welcome p{
    margin:0 0 28px;
    font-size:1rem;
    color:#94a3b8;
  }
  .reunioes-chat-suggestions{
    display:grid;
    grid-template-columns:repeat(3, 1fr);
    gap:10px;
    max-width:700px;
    margin:0 auto;
  }
  .reunioes-chat-suggestions button{
    background:rgba(30,41,59,0.8);
    border:1px solid rgba(99,102,241,0.3);
    border-radius:12px;
    padding:12px 14px;
    color:#e2e8f0;
    font-size:0.85rem;
    cursor:pointer;
    transition:all 0.2s;
    text-align:left;
  }
  .reunioes-chat-suggestions button:hover{
    background:rgba(99,102,241,0.15);
    border-color:rgba(99,102,241,0.5);
    transform:translateY(-2px);
  }
  /* Responsivo */
  @media(max-width:900px){
    .reunioes-chat-section{
      height:550px;
      flex-direction:column;
    }
    .reunioes-chat-sidebar{
      width:100%;
      height:auto;
      max-height:200px;
      border-right:none;
      border-bottom:1px solid rgba(99,102,241,0.3);
    }
    .reunioes-chat-sidebar-list{
      max-height:100px;
    }
    .reunioes-chat-suggestions{
      grid-template-columns:repeat(2, 1fr);
    }
  }
  @media(max-width:600px){
    .reunioes-chat-suggestions{
      grid-template-columns:1fr;
    }
  }
  /* ========== FIM CHAT IA REUNI√ïES ========== */
  
  /* ===================== FIM REUNI√ïES ===================== */
</style>
</meta></head>
<body>
<div id="loadingScreen"><div class="loader"></div></div>
<button id="refreshBtn" title="Atualizar" onclick="location.reload()">‚ü≥</button>
<h1 class="site-logo"><img src="./logosite.svg" alt="Sa√∫de do Marketing" loading="lazy"/></h1>
<!-- LOGIN -->
<div aria-hidden="false" class="center-box" id="authArea">
<div class="auth-box">
<button class="btn" id="loginGoogle">Entrar com Google</button>
<div class="divider"></div>
<div class="field"><input autocomplete="username" class="input" id="email" placeholder="E-mail" type="email"/></div>
<div class="password-group" style="position:relative;margin:10px 0">
<input autocomplete="current-password" class="input" id="password" placeholder="Senha" style="padding-right:44px" type="password"/>
<span id="togglePassword" role="button" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;cursor:pointer;user-select:none;font-size:18px;line-height:1;color:var(--accent);" title="Mostrar/ocultar">üëÅ</span>
</div>
<button class="btn" id="loginEmail">Entrar com E-mail</button>
<button class="btn secondary" id="signupEmail">Criar Conta</button>
<p class="link" id="forgotPassword">Esqueci a senha</p>
<p id="status" style="font-size:.85rem;color:#bbb;margin:6px 0 0"></p>
</div>
</div>
<!-- √ÅREA LOGADA -->
<div aria-hidden="true" id="userArea">
  <div class="topbar">
    <div class="topbar-left">
      <div id="userInfo" class="user-info"></div>
      <div id="socialIcons" class="social-icons"></div>
    </div>
    <div class="right-tools">
      <div class="profile-area" id="profileArea" aria-hidden="true">
        <button type="button" class="profile-avatar" id="profileAvatar" aria-label="Adicionar logo do cliente" title="Adicionar logo do cliente">
          <img id="profileAvatarImg" alt="Logo do cliente" loading="lazy" />
          <span class="avatar-placeholder" id="profileAvatarPlaceholder">+</span>
        </button>
        <div class="profile-meta">
          <strong id="profileClientName"></strong>
          <small>Logo da marca</small>
        </div>
        <input type="file" id="profileAvatarInput" accept="image/*" hidden />
      </div>
      <button class="settings-tab" id="settingsToggle" type="button" aria-expanded="false" aria-controls="settingsPanel" title="Configura√ß√µes" aria-label="Abrir configura√ß√µes">‚öô</button>
      <div class="storage-usage hidden" id="storageUsage" role="status" aria-live="polite">
        <div class="storage-usage-header">
          <span class="storage-usage-title">Uso de armazenamento</span>
          <span class="storage-usage-percent" id="storageUsagePercent"></span>
        </div>
        <div aria-hidden="true" class="storage-usage-bar">
          <div class="storage-usage-fill" id="storageUsageFill"></div>
        </div>
        <div class="storage-usage-footer">
          <span class="storage-usage-summary" id="storageUsageSummary"></span>
          <span class="storage-usage-hint" id="storageUsageHint"></span>
        </div>
      </div>
      <div class="mini-total" data-tip="" id="totalCard">
        <span class="dot"></span><span class="total-score" id="totalScore">0</span><span class="total-sub">/100</span>
      </div>
      <button class="user-btn" id="adminPanelBtn" style="display:none; background:#ff6b35; margin-right:10px;">‚Üê Painel Admin</button>
      <button class="user-btn" id="logoutBtn">Sair</button>
    </div>
  </div>
  <div class="settings-panel" id="settingsPanel" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div class="settings-panel-inner">
      <aside class="settings-sidebar" id="settingsSidebar" aria-label="Se√ß√µes de configura√ß√µes">
        <div class="settings-sidebar-title">Configura√ß√µes</div>
        <button type="button" class="settings-nav-btn active" data-section="general">Geral</button>
        <button type="button" class="settings-nav-btn" data-section="clients">Gerenciar Clientes</button>
        <button type="button" class="settings-nav-btn" data-section="integrations">Integra√ß√µes</button>
  <button type="button" class="settings-nav-btn" data-section="users">Time</button>
        <button type="button" class="settings-nav-btn" data-section="plans">Planos</button>
        <button type="button" class="settings-nav-btn" data-section="notifications">Notifica√ß√µes</button>
        <button type="button" class="settings-nav-btn" data-section="preferences">Prefer√™ncias</button>
      </aside>
      <div class="settings-content">
        <header class="settings-content-header">
          <div>
            <h2 id="settingsTitle">Geral</h2>
            <p class="settings-subtitle" id="settingsSubtitle">Personalize as informa√ß√µes principais da sua conta.</p>
          </div>
          <button type="button" class="settings-close" id="settingsClose" aria-label="Fechar configura√ß√µes">√ó</button>
        </header>
        <div class="settings-mobile-nav" id="settingsMobileNav">
          <label for="settingsSectionSelect">Se√ß√£o</label>
          <select id="settingsSectionSelect" aria-label="Selecionar se√ß√£o de configura√ß√µes">
            <option value="general">Geral</option>
            <option value="clients">Gerenciar Clientes</option>
            <option value="integrations">Integra√ß√µes</option>
            <option value="users">Time</option>
            <option value="plans">Planos</option>
            <option value="notifications">Notifica√ß√µes</option>
            <option value="preferences">Prefer√™ncias</option>
          </select>
        </div>
        <div class="settings-body" id="settingsBody"></div>
      </div>
    </div>
  </div>
  <div class="section-title">üß© Sa√∫de dos blocos</div>
  <div aria-hidden="true" class="header-calendar-bar" id="headerCalendarBar">
  <strong class="header-calendar-month" id="headerCalendarMonth"></strong>
  <div class="header-calendar-days" id="headerCalendarDays" role="list"></div>
</div>
<!-- ABAS -->
<div class="tabs-container" id="tabsContainer">
  <button class="menu-toggle" id="mainMenuToggle" type="button" aria-expanded="false" aria-haspopup="true" aria-controls="sectionTabs">‚ò∞ Menu</button>
  <div aria-label="Setores" class="tabs" id="sectionTabs" role="tablist"></div>
</div>
<section id="macroSection" data-section="macro">
  <div class="dashboard" id="dashboard"></div>
  <div class="macro-actions" id="macroActions" style="display:none">
    <div class="macro-insight-badges" id="macroBadges"></div>
  </div>
  <!-- GRID IFRAMES -->
  <div id="historyLegend"></div>
  <div id="historyControls"><label class="muted" for="historyMonthSelect">Meses:</label> <select id="historyMonthSelect" multiple></select></div>
  <canvas id="historyChart"></canvas>
</section>
<div class="widgets-grid" id="widgetsGrid"></div>
<!-- Refer√™ncias Redes -->
<div aria-hidden="true" class="refsocial-wrap" id="refSocialWrap" style="display:none">
  <div class="refsocial-top">
    <form id="refSocialForm" class="refsocial-form" data-mode="link">
      <div class="refsocial-mode" id="refSocialModeToggle" role="radiogroup">
        <button type="button" data-mode="link" class="active">Adicionar link</button>
        <button type="button" data-mode="upload">Enviar arquivo</button>
      </div>
      <div class="refsocial-grid">
        <label class="refsocial-field refsocial-field-link">
          <span>Link da refer√™ncia</span>
          <input type="url" id="refSocialLinkInput" placeholder="Cole o link do Instagram, YouTube ou TikTok" autocomplete="off" spellcheck="false">
        </label>
        <label class="refsocial-field refsocial-field-upload">
          <span>Arquivo da refer√™ncia</span>
          <input type="file" id="refSocialFile" accept="image/*,video/*">
        </label>
        <label class="refsocial-field">
          <span>Categoria</span>
          <select id="refSocialCategory">
            <option value="stories">Stories</option>
            <option value="feed">Feed</option>
            <option value="youtube">YouTube</option>
            <option value="banner">Banner</option>
            <option value="folder">Folder</option>
            <option value="an√∫ncios">An√∫ncios</option>
            <option value="outros">Outros</option>
          </select>
        </label>
      </div>
      <label class="refsocial-field">
        <span>Detalhes</span>
        <textarea id="refSocialDetails" placeholder="Detalhes do material"></textarea>
      </label>
      <div class="refsocial-link-preview" id="refSocialLinkPreview" data-state="empty">
        <p class="muted" style="margin:0">Cole um link para gerar a pr√©-visualiza√ß√£o.</p>
      </div>
      <div class="refsocial-submit">
        <button type="submit" class="btn small">Adicionar refer√™ncia</button>
      </div>
    </form>
  </div>
  <div id="refSocialList" class="refsocial-list"></div>
</div>
<!-- IA -->
<div aria-hidden="true" class="ia-wrap" id="iaWrap" style="display:none">
  <div class="ia-shell">
    <aside class="ia-sidebar">
      <div class="ia-sidebar-header">
        <button class="btn small" id="iaNewChat" type="button">Nova conversa</button>
      </div>
      <div class="ia-sidebar-search">
        <input type="text" class="input" id="iaChatSearch" placeholder="Buscar conversas">
      </div>
      <div class="ia-sidebar-content">
        <div class="ia-chat-list" id="iaChatList"></div>
        <details class="ia-knowledge" id="iaKnowledge">
          <summary>
            <span>üìÑ Documentos para a IA</span>
            <span class="ia-doc-count" id="iaDocsCount">0</span>
          </summary>
          <div class="ia-knowledge-content">
            <p>Envie arquivos de texto, planilhas ou documentos para treinar o contexto da IA deste cliente. Cada arquivo ser√° convertido para TXT automaticamente.</p>
            <div class="ia-docs-actions">
              <input type="file" id="iaDocsInput" multiple accept=".txt,.md,.csv,.tsv,.json,.doc,.docx,.odt,.rtf,.xls,.xlsx,.ods,.pdf,.ppt,.pptx,.xml,.html,.htm" style="display:none">
              <button class="btn small" id="iaDocsPick" type="button">Selecionar arquivos</button>
              <button class="btn ghost small" id="iaDocsUpload" type="button">Enviar</button>
            </div>
            <div class="ia-docs-status" id="iaDocsStatus">Nenhum arquivo selecionado.</div>
            <div class="ia-docs-list" id="iaDocsList"></div>
          </div>
        </details>
      </div>
    </aside>
    <section class="ia-main">
      <header class="ia-main-head">
        <div class="ia-title" id="iaCurrentTitle">Selecione uma conversa</div>
        <div class="ia-main-actions">
          <button class="btn ghost small" id="iaRenameChat" type="button">Renomear</button>
          <button class="btn ghost small danger" id="iaDeleteChat" type="button">Excluir</button>
        </div>
      </header>
      <div class="ia-history" id="iaHistory"></div>
      <div class="ia-empty" id="iaEmptyState">Comece uma nova conversa ou escolha uma existente ao lado.</div>
      <form class="ia-composer" id="iaComposer">
        <div class="ia-composer-top">
          <div class="ia-response-size">
            <span class="ia-response-size-label">Tamanho:</span>
            <button type="button" class="ia-size-btn active" data-size="pequena" title="Resposta curta: at√© 150 palavras, 3-5 t√≥picos">üìù Pequena</button>
            <button type="button" class="ia-size-btn" data-size="media" title="Resposta equilibrada: at√© 400 palavras, 6-10 t√≥picos">üìÑ M√©dia</button>
            <button type="button" class="ia-size-btn" data-size="longa" title="Resposta detalhada: 600-1000 palavras, an√°lise completa">üìö Longa</button>
          </div>
          <div class="ia-sources-select">
            <span class="ia-sources-label">Buscar em:</span>
            <span id="iaCostBadge" class="ia-cost-badge" style="display:none;">üí∞ $0.0000</span>
            <div class="ia-sources-dropdown">
              <button type="button" class="ia-sources-btn" id="iaSourcesBtn">
                <span id="iaSourcesText">Todas as Abas (32)</span>
                <span>‚ñæ</span>
              </button>
              <div class="ia-sources-menu" id="iaSourcesMenu">
                <div class="ia-source-option">
                  <input type="checkbox" id="source-all" checked>
                  <label for="source-all">‚ú® Todas as Abas</label>
                </div>
                
                <div class="ia-source-separator">üéØ Estrutura√ß√£o - Notas</div>
                <div class="ia-source-option">
                  <input type="checkbox" id="source-estruturacao" data-source="estruturacao" checked>
                  <label for="source-estruturacao">üìù Notas das 6 Semanas</label>
                </div>
                
                <div class="ia-source-separator">üî¨ Estrutura√ß√£o - Entreg√°veis</div>
                <div class="ia-source-option">
                  <input type="checkbox" id="source-analise-todos" data-source="analise-todos">
                  <label for="source-analise-todos">üìö Todos os Entreg√°veis</label>
                </div>
                <div class="ia-source-option">
                  <input type="checkbox" id="source-diagnostico" data-source="diagnostico">
                  <label for="source-diagnostico">1Ô∏è‚É£ Diagn√≥stico Estrat√©gico Completo</label>
                </div>
                <div class="ia-source-option">
                  <input type="checkbox" id="source-direcionamento" data-source="direcionamento">
                  <label for="source-direcionamento">2Ô∏è‚É£ Direcionamento Estrat√©gico e Metas</label>
                </div>
                <div class="ia-source-option">
                  <input type="checkbox" id="source-concorrencia" data-source="concorrencia">
                  <label for="source-concorrencia">3Ô∏è‚É£ An√°lise de Concorr√™ncia e Mercado</label>
                </div>
                <div class="ia-source-option">
                  <input type="checkbox" id="source-cdt" data-source="cdt">
                  <label for="source-cdt">4Ô∏è‚É£ Matriz CDT</label>
                </div>
                <div class="ia-source-option">
                  <input type="checkbox" id="source-puv" data-source="puv">
                  <label for="source-puv">5Ô∏è‚É£ PUV - Proposta √önica de Valor</label>
                </div>
                <div class="ia-source-option">
                  <input type="checkbox" id="source-pai" data-source="pai">
                  <label for="source-pai">6Ô∏è‚É£ PAI - P√∫blico Alvo Ideal</label>
                </div>
                <div class="ia-source-option">
                  <input type="checkbox" id="source-anuncios" data-source="anuncios">
                  <label for="source-anuncios">7Ô∏è‚É£ Estrutura√ß√£o de An√∫ncios Pagos</label>
                </div>
                <div class="ia-source-option">
                  <input type="checkbox" id="source-seo" data-source="seo">
                  <label for="source-seo">8Ô∏è‚É£ Estrutura√ß√£o Site & SEO</label>
                </div>
                <div class="ia-source-option">
                  <input type="checkbox" id="source-redes" data-source="redes">
                  <label for="source-redes">9Ô∏è‚É£ Estrat√©gias para Redes Sociais</label>
                </div>
                <div class="ia-source-option">
                  <input type="checkbox" id="source-copy" data-source="copy">
                  <label for="source-copy">üîü Copywriting Estrat√©gico</label>
                </div>
                <div class="ia-source-option">
                  <input type="checkbox" id="source-conteudo" data-source="conteudo">
                  <label for="source-conteudo">1Ô∏è‚É£1Ô∏è‚É£ Produ√ß√£o de Conte√∫do Guiada</label>
                </div>
                <div class="ia-source-option">
                  <input type="checkbox" id="source-criativos" data-source="criativos">
                  <label for="source-criativos">1Ô∏è‚É£2Ô∏è‚É£ Criativos para An√∫ncios Patrocinados</label>
                </div>
                <div class="ia-source-option">
                  <input type="checkbox" id="source-crm" data-source="crm">
                  <label for="source-crm">1Ô∏è‚É£3Ô∏è‚É£ CRM e Automa√ß√µes</label>
                </div>
                <div class="ia-source-option">
                  <input type="checkbox" id="source-comercial" data-source="comercial">
                  <label for="source-comercial">1Ô∏è‚É£4Ô∏è‚É£ Estrutura√ß√£o do Processo Comercial</label>
                </div>
                <div class="ia-source-option">
                  <input type="checkbox" id="source-lp" data-source="lp">
                  <label for="source-lp">1Ô∏è‚É£5Ô∏è‚É£ Landing Pages Estrat√©gicas</label>
                </div>
                <div class="ia-source-option">
                  <input type="checkbox" id="source-website" data-source="website">
                  <label for="source-website">1Ô∏è‚É£6Ô∏è‚É£ Constru√ß√£o ou Atualiza√ß√£o de Website</label>
                </div>
                <div class="ia-source-option">
                  <input type="checkbox" id="source-visual" data-source="visual">
                  <label for="source-visual">1Ô∏è‚É£7Ô∏è‚É£ Padroniza√ß√£o Visual e de Comunica√ß√£o</label>
                </div>
                <div class="ia-source-option">
                  <input type="checkbox" id="source-plataforma" data-source="plataforma">
                  <label for="source-plataforma">1Ô∏è‚É£8Ô∏è‚É£ Plataforma Mediagrowth</label>
                </div>
                
                <div class="ia-source-separator">ÔøΩ Outras Abas</div>
                <div class="ia-source-option">
                  <input type="checkbox" id="source-macro" data-source="macro" checked>
                  <label for="source-macro">ÔøΩ Macro</label>
                </div>
                <div class="ia-source-option">
                  <input type="checkbox" id="source-planejamento" data-source="planejamento" checked>
                  <label for="source-planejamento">üìã Planejamento</label>
                </div>
                <div class="ia-source-option">
                  <input type="checkbox" id="source-calendario" data-source="calendario" checked>
                  <label for="source-calendario">üìÖ Calend√°rio</label>
                </div>
                <div class="ia-source-option">
                  <input type="checkbox" id="source-metas" data-source="metas" checked>
                  <label for="source-metas">üéØ Metas</label>
                </div>
                <div class="ia-source-option">
                  <input type="checkbox" id="source-leads" data-source="leads" checked>
                  <label for="source-leads">üë• Leads</label>
                </div>
                <div class="ia-source-option">
                  <input type="checkbox" id="source-posts" data-source="posts" checked>
                  <label for="source-posts">ÔøΩ Posts</label>
                </div>
                <div class="ia-source-option">
                  <input type="checkbox" id="source-anotacoes" data-source="anotacoes" checked>
                  <label for="source-anotacoes">ÔøΩ Anota√ß√µes</label>
                </div>
                <div class="ia-source-option">
                  <input type="checkbox" id="source-acessos" data-source="acessos" checked>
                  <label for="source-acessos">ÔøΩ Acessos</label>
                </div>
                <div class="ia-source-option">
                  <input type="checkbox" id="source-arquivos" data-source="arquivos" checked>
                  <label for="source-arquivos">ÔøΩ Arquivos</label>
                </div>
                <div class="ia-source-option">
                  <input type="checkbox" id="source-relatorio" data-source="relatorio" checked>
                  <label for="source-relatorio">ÔøΩ Relat√≥rio</label>
                </div>
                <div class="ia-source-option">
                  <input type="checkbox" id="source-demandas" data-source="demandas" checked>
                  <label for="source-demandas">‚úÖ Demandas</label>
                </div>
                
                <div class="ia-sources-actions">
                  <button type="button" class="ia-sources-action-btn" id="iaSourcesSelectAll">Marcar Todas</button>
                  <button type="button" class="ia-sources-action-btn" id="iaSourcesClearAll">Limpar</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="ia-image-preview-wrapper" id="iaImagePreviewWrapper">
          <div class="ia-image-preview-container">
            <img class="ia-image-preview-img" id="iaImagePreviewImg" src="" alt="Preview">
            <div class="ia-image-preview-info">
              <div class="ia-image-preview-name" id="iaImagePreviewName">imagem.png</div>
              <div class="ia-image-preview-size" id="iaImagePreviewSize">0 KB</div>
            </div>
            <button type="button" class="ia-image-preview-remove" id="iaImagePreviewRemove">üóëÔ∏è Remover</button>
          </div>
        </div>
        <textarea id="iaQuestion" class="input ia-input" rows="1" placeholder="Digite uma mensagem ou cole uma imagem (Ctrl+V)" autocomplete="off"></textarea>
        <button class="btn" id="iaSend" type="submit">Enviar</button>
        <p class="ia-source-note" id="iaSourceNote" aria-live="polite"></p>
      </form>
    </section>
  </div>
</div>
<style>
  /* LEADS */
  .leads-wrap{
    padding: 20px;
    margin-left: var(--margin-left);
    margin-right: var(--margin-right);
  }
  .leads-toolbar{
    background: var(--title-bg, rgba(0, 0, 0, 0.35));
    border: 1px solid var(--shell-border, rgba(255, 255, 255, 0.14));
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
  }
  .leads-toolbar h2{
    margin: 0 0 8px 0;
    font-size: 1.35rem;
    color: #fff;
  }
  .leads-toolbar p{
    margin: 0;
    color: #cbd5f5;
    font-size: 0.9rem;
  }
  .leads-content{
    background: var(--panel);
    border: 1px solid var(--shell-border);
    border-radius: 12px;
    padding: 20px;
    min-height: 400px;
  }
  .leads-webhook{
    display: grid;
    grid-template-columns: 1.2fr auto auto;
    gap: 10px;
    align-items: center;
    background: rgba(255,255,255,0.04);
    border: 1px solid var(--shell-border);
    border-radius: 12px;
    padding: 12px;
    margin-bottom: 16px;
  }
  .leads-webhook label{
    display: block;
    font-size: .78rem;
    color: #cbd5f5;
    margin-bottom: 6px;
    letter-spacing: .04em;
    text-transform: uppercase;
    font-weight: 800;
  }
  #leadsWebhookUrl{
    width: 100%;
    background: #0f172a;
    color: #e2e8f0;
    border: 1px solid rgba(148,163,184,.28);
    border-radius: 10px;
    padding: 10px 12px;
    font-size: .9rem;
  }
  .leads-webhook .btn{
    white-space: nowrap;
  }
  .leads-hint{ font-size: .8rem; color: #94a3b8; margin: 6px 0 0; }
  .leads-list{ display:flex; flex-direction:column; gap:8px; }
  .lead-row{
    display:grid;
    /* Checkbox + 7 colunas de dados + a√ß√µes */
    grid-template-columns: 40px 1.2fr 1.2fr .9fr 2fr .7fr .8fr .8fr 110px;
    gap:10px;
    align-items:center;
    background: rgba(15,23,42,.45);
    border: 1px solid rgba(148,163,184,.24);
    border-radius: 12px;
    padding: 10px 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,.28);
  }
  .lead-row .lead-cell{ min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .lead-name{ font-weight: 800; color: #f8fafc; }
  .lead-email{ color:#cbd5f5; }
  .lead-phone{ color:#e5e7eb; }
  .lead-question{ color:#cbd5f5; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .lead-plataforma{ 
    color:#fbbf24; 
    font-size:.9rem; 
    font-weight:900; 
    text-transform:uppercase; 
    background: rgba(251,191,36,.15);
    padding: 4px 8px;
    border-radius: 6px;
    border: 1px solid rgba(251,191,36,.3);
  }
  .lead-fonte{ color:#94a3b8; font-size:.85rem; }
  .lead-when{ color:#94a3b8; font-size:.8rem; text-align:right; }
  .leads-header{ display:grid; grid-template-columns: 40px 1.2fr 1.2fr .9fr 2fr .7fr .8fr .8fr 110px; gap:10px; padding: 8px; color:#94a3b8; font-size:.8rem; letter-spacing:.04em; text-transform:uppercase; font-weight:800; align-items:center; }
  .leads-header > div{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .leads-empty{ color:#94a3b8; padding: 20px; text-align:center; border:1px dashed rgba(148,163,184,.28); border-radius:12px; }
  
  /* Bulk Edit */
  .leads-bulk-toolbar{
    display: none;
    background: rgba(56,189,248,.12);
    border: 1px solid rgba(56,189,248,.35);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
    gap: 12px;
    align-items: center;
  }
  .leads-bulk-toolbar.active{ display: flex; }
  .leads-bulk-info{
    font-weight: 700;
    color: #bae6fd;
    font-size: .95rem;
  }
  .leads-bulk-actions{
    display: flex;
    gap: 8px;
    flex: 1;
    justify-content: flex-end;
  }
  .leads-bulk-actions .btn{
    font-size: .85rem;
    padding: 8px 12px;
  }
  .lead-checkbox{
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: var(--accent, #ff6600);
  }
  .lead-row.selected{
    background: rgba(56,189,248,.15);
    border-color: rgba(56,189,248,.45);
  }
  
  /* Import Modal */
  .leads-import-actions{
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
    margin-top: 12px;
  }
  .leads-import-dropzone{
    border: 2px dashed rgba(148,163,184,.35);
    border-radius: 12px;
    padding: 40px 20px;
    text-align: center;
    background: rgba(15,23,42,.45);
    cursor: pointer;
    transition: all .2s ease;
  }
  .leads-import-dropzone:hover{
    border-color: var(--accent);
    background: rgba(15,23,42,.65);
  }
  .leads-import-dropzone.dragover{
    border-color: var(--accent);
    background: rgba(255,102,0,.1);
  }
  .leads-import-icon{
    font-size: 3rem;
    margin-bottom: 12px;
    opacity: .7;
  }
  .leads-import-text{
    color: #cbd5f5;
    font-size: .95rem;
    margin-bottom: 8px;
  }
  .leads-import-hint{
    color: #94a3b8;
    font-size: .8rem;
  }
  .leads-preview-table{
    width: 100%;
    border-collapse: collapse;
    font-size: .85rem;
    margin-top: 16px;
  }
  .leads-preview-table th{
    background: rgba(15,23,42,.6);
    padding: 10px 12px;
    text-align: left;
    color: #cbd5f5;
    font-weight: 700;
    border-bottom: 2px solid rgba(148,163,184,.28);
  }
  .leads-preview-table td{
    padding: 8px 12px;
    border-bottom: 1px solid rgba(148,163,184,.18);
    color: #e2e8f0;
  }
  .leads-preview-table tr:hover{
    background: rgba(255,255,255,.04);
  }
  .leads-preview-container{
    max-height: 400px;
    overflow: auto;
    border: 1px solid rgba(148,163,184,.28);
    border-radius: 10px;
  }
  .leads-import-status{
    padding: 14px 18px;
    border-radius: 10px;
    margin-top: 16px;
    display: none;
    font-size: 0.95rem;
    font-weight: 500;
    text-align: center;
    animation: statusFadeIn 0.3s ease;
  }
  @keyframes statusFadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .leads-import-status.success{
    background: rgba(34,197,94,.15);
    border: 2px solid rgba(34,197,94,.5);
    color: #bbf7d0;
    display: block;
    box-shadow: 0 4px 12px rgba(34,197,94,.2);
  }
  .leads-import-status.error{
    background: rgba(248,113,113,.15);
    border: 2px solid rgba(248,113,113,.5);
    color: #fecaca;
    display: block;
    box-shadow: 0 4px 12px rgba(248,113,113,.2);
  }
  .leads-import-status.warning{
    background: rgba(251,191,36,.15);
    border: 2px solid rgba(251,191,36,.5);
    color: #fde68a;
    display: block;
    box-shadow: 0 4px 12px rgba(251,191,36,.2);
  }
  .leads-import-status.info{
    background: rgba(59,130,246,.15);
    border: 2px solid rgba(59,130,246,.5);
    color: #bfdbfe;
    display: block;
    box-shadow: 0 4px 12px rgba(59,130,246,.2);
  }
  .lead-delete-btn{ 
    background: rgba(220,38,38,.16); 
    border: 1px solid rgba(220,38,38,.45); 
    color: #fecaca; 
    border-radius: 8px; 
    padding: 6px 10px; 
    font-size: .85rem; 
    font-weight: 700; 
    cursor: pointer; 
    transition: background .2s ease, transform .1s ease;
  }
  .lead-delete-btn:hover{ 
    background: rgba(220,38,38,.28); 
    transform: scale(1.05); 
  }
  .lead-delete-btn:active{ 
    transform: scale(.98); 
  }
  /* Bot√µes de edi√ß√£o (inline) */
  .lead-edit-btn, .lead-save-btn, .lead-cancel-btn{
    background: rgba(56,189,248,.16);
    border:1px solid rgba(56,189,248,.45);
    color:#bae6fd;
    border-radius:8px;
    padding:6px 8px;
    font-size:.75rem;
    font-weight:700;
    cursor:pointer;
    margin-right:4px;
    transition: background .2s ease, transform .1s ease;
  }
  .lead-edit-btn:hover, .lead-save-btn:hover, .lead-cancel-btn:hover{ background: rgba(56,189,248,.28); transform:scale(1.05); }
  .lead-edit-btn:active, .lead-save-btn:active, .lead-cancel-btn:active{ transform:scale(.95); }
  .lead-save-btn{ background: rgba(34,197,94,.18); border-color: rgba(34,197,94,.5); color:#bbf7d0; }
  .lead-save-btn:hover{ background: rgba(34,197,94,.3); }
  .lead-cancel-btn{ background: rgba(248,113,113,.16); border-color: rgba(248,113,113,.45); color:#fecaca; }
  .lead-cancel-btn:hover{ background: rgba(248,113,113,.28); }
  .lead-edit-input{
    width:100%;
    background:#0f172a;
    border:1px solid rgba(148,163,184,.35);
    color:#f8fafc;
    border-radius:6px;
    padding:6px 8px;
    font-size:.75rem;
  }
  .lead-edit-input[type="date"]{
    cursor: pointer;
    color-scheme: dark;
  }
  .lead-edit-input[type="date"]::-webkit-calendar-picker-indicator{
    filter: invert(1);
    cursor: pointer;
  }
  .lead-editing .lead-cell{ white-space:normal; }
  /* Pain√©is de m√©tricas de leads */
  .leads-metrics{
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 20px;
  }
  .leads-metric-panel{
    background: rgba(15,23,42,.65);
    border: 1px solid rgba(148,163,184,.28);
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,.2);
    transition: all .2s ease;
    cursor: pointer;
    position: relative;
  }
  .leads-metric-panel:hover{
    border-color: rgba(148,163,184,.45);
    box-shadow: 0 6px 16px rgba(0,0,0,.3);
    transform: translateY(-2px);
  }
  .leads-metric-panel.active{
    background: rgba(56,189,248,.15);
    border-color: rgba(56,189,248,.6);
    box-shadow: 0 8px 24px rgba(56,189,248,.3);
  }
  .leads-metric-panel.active::after{
    content: '‚úì Filtro ativo';
    position: absolute;
    top: 8px;
    right: 8px;
    font-size: .65rem;
    color: #7dd3fc;
    background: rgba(56,189,248,.2);
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .02em;
  }
  .leads-metric-label{
    font-size: .8rem;
    color: #94a3b8;
    text-transform: uppercase;
    letter-spacing: .04em;
    font-weight: 800;
    margin-bottom: 8px;
  }
  .leads-metric-value{
    font-size: 2rem;
    font-weight: 900;
    color: #f8fafc;
    line-height: 1.2;
  }
  .leads-metric-change{
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: .85rem;
    font-weight: 700;
    margin-top: 8px;
    padding: 4px 8px;
    border-radius: 6px;
  }
  .leads-metric-change.up{
    background: rgba(34,197,94,.15);
    color: #86efac;
  }
  .leads-metric-change.down{
    background: rgba(248,113,113,.15);
    color: #fca5a5;
  }
  .leads-metric-change.neutral{
    background: rgba(148,163,184,.15);
    color: #cbd5e1;
  }
  .leads-metric-icon{
    font-size: 1.2rem;
  }
  
  /* Relat√≥rio de fontes e plataformas */
  .leads-sources-report{
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    margin-bottom: 20px;
  }
  .leads-sources-section{
    background: rgba(15,23,42,.45);
    border: 1px solid rgba(148,163,184,.2);
    border-radius: 10px;
    padding: 14px;
  }
  .leads-sources-title{
    font-size: .75rem;
    color: #94a3b8;
    text-transform: uppercase;
    letter-spacing: .04em;
    font-weight: 800;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .leads-sources-title-icon{
    font-size: .9rem;
  }
  .leads-sources-list{
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .leads-source-item{
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 10px;
    background: rgba(0,0,0,.2);
    border-radius: 6px;
    font-size: .85rem;
  }
  .leads-source-name{
    color: #cbd5f5;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .leads-source-badge{
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--badge-color, #64748b);
  }
  .leads-source-count{
    color: #f8fafc;
    font-weight: 800;
    font-size: .9rem;
  }
  .leads-source-bar{
    height: 4px;
    background: rgba(148,163,184,.2);
    border-radius: 2px;
    margin-top: 4px;
    overflow: hidden;
  }
  .leads-source-bar-fill{
    height: 100%;
    background: var(--badge-color, #64748b);
    border-radius: 2px;
    transition: width .3s ease;
  }
  .leads-sources-empty{
    color: #64748b;
    font-size: .8rem;
    text-align: center;
    padding: 10px;
  }
  
  /* Relat√≥rio R√°pido para Cliente */
  .leads-quick-report{
    animation: fadeInUp .4s ease;
  }
  @keyframes fadeInUp{
    from{
      opacity: 0;
      transform: translateY(10px);
    }
    to{
      opacity: 1;
      transform: translateY(0);
    }
  }
  #leadsQuickReportContent{
    user-select: text;
    cursor: text;
  }
  #leadsQuickReportCopy{
    transition: all .2s ease;
  }
  #leadsQuickReportCopy:hover{
    background: rgba(34,197,94,.35);
    transform: scale(1.05);
  }
  #leadsQuickReportCopy:active{
    transform: scale(0.95);
  }
  
  @media (max-width: 1200px){
    .leads-metrics{
      grid-template-columns: repeat(2, 1fr);
    }
  }
  @media (max-width: 900px){
    .leads-webhook{ grid-template-columns: 1fr; }
    .leads-header{ display:none; }
    .leads-metrics{
      grid-template-columns: 1fr;
    }
    .leads-sources-report{
      grid-template-columns: 1fr;
    }
    .lead-row{ 
      grid-template-columns: 40px 1fr auto; 
      gap:6px; 
      align-items:flex-start; 
    }
    .lead-row .lead-cell:first-child {
      grid-column: 1;
      grid-row: 1;
      align-self: start;
      padding-top: 4px;
    }
    .lead-row .lead-cell:nth-child(n+2):nth-child(-n+7) {
      grid-column: 2;
    }
    .lead-row .lead-cell:last-child {
      grid-column: 3;
      grid-row: 1;
      align-self: center;
    }
    .lead-when{ text-align:left; }
    .leads-bulk-toolbar{
      flex-direction: column;
      align-items: stretch;
    }
    .leads-bulk-actions{
      flex-direction: column;
      width: 100%;
    }
    .leads-bulk-actions .btn{
      width: 100%;
    }
  }
</style>
<!-- LEADS -->
<div aria-hidden="true" class="leads-wrap" id="leadsWrap" style="display:none">
  <div class="leads-toolbar">
    <h2>Gest√£o de Leads</h2>
    <p>Gerencie e acompanhe seus leads de forma organizada</p>
  </div>
  
  <!-- Pain√©is de m√©tricas -->
  <div class="leads-metrics">
    <div class="leads-metric-panel" data-filter="lastMonth">
      <div class="leads-metric-label">M√™s Passado</div>
      <div class="leads-metric-value" id="leadsLastMonth">0</div>
    </div>
    <div class="leads-metric-panel" data-filter="thisMonth">
      <div class="leads-metric-label">Este M√™s</div>
      <div class="leads-metric-value" id="leadsThisMonth">0</div>
      <div class="leads-metric-change neutral" id="leadsMonthChange">
        <span class="leads-metric-icon">‚Üí</span>
        <span>0%</span>
      </div>
    </div>
    <div class="leads-metric-panel" data-filter="thisWeek">
      <div class="leads-metric-label">Esta Semana</div>
      <div class="leads-metric-value" id="leadsThisWeek">0</div>
    </div>
    <div class="leads-metric-panel" data-filter="today">
      <div class="leads-metric-label">Hoje</div>
      <div class="leads-metric-value" id="leadsToday">0</div>
    </div>
  </div>
  
  <!-- Bot√£o de limpar filtro -->
  <div id="leadsFilterBar" style="display:none; background: rgba(56,189,248,.12); border: 1px solid rgba(56,189,248,.35); border-radius: 10px; padding: 12px; margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between;">
    <div style="display: flex; align-items: center; gap: 8px;">
      <span style="font-size: .85rem; color: #bae6fd; font-weight: 700;">üîç Filtro ativo:</span>
      <span id="leadsFilterText" style="font-size: .85rem; color: #f0f9ff; font-weight: 600;"></span>
    </div>
    <button id="leadsClearFilter" class="btn small ghost" style="font-size: .8rem; padding: 6px 12px;">Limpar Filtro</button>
  </div>
  
  <!-- Relat√≥rio de Fontes e Plataformas -->
  <div class="leads-sources-report">
    <div class="leads-sources-section">
      <div class="leads-sources-title">
        <span class="leads-sources-title-icon">üéØ</span>
        Plataformas
      </div>
      <div class="leads-sources-list" id="leadsPlataformasList">
        <div class="leads-sources-empty">Carregando...</div>
      </div>
    </div>
    <div class="leads-sources-section">
      <div class="leads-sources-title">
        <span class="leads-sources-title-icon">üìç</span>
        Fontes
      </div>
      <div class="leads-sources-list" id="leadsSourcesList">
        <div class="leads-sources-empty">Carregando...</div>
      </div>
    </div>
  </div>
  
  <!-- Relat√≥rio R√°pido para Cliente -->
  <div class="leads-quick-report" id="leadsQuickReport" style="background: linear-gradient(135deg, rgba(59,130,246,.15), rgba(147,51,234,.12)); border: 2px solid rgba(99,102,241,.4); border-radius: 12px; padding: 20px; margin: 20px 0; position: relative;">
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
      <div>
        <h3 style="margin: 0 0 8px; font-size: 1.2rem; color: #f0f9ff; font-weight: 700;">üìä Relat√≥rio R√°pido</h3>
        <p style="margin: 0; font-size: 0.85rem; color: #cbd5e1; opacity: 0.8;">Copie e envie para seus clientes</p>
      </div>
      <button class="btn small" id="leadsQuickReportCopy" type="button" style="background: rgba(34,197,94,.25); border-color: rgba(34,197,94,.5); font-weight: 600;">
        üìã Copiar Relat√≥rio
      </button>
    </div>
    
    <div id="leadsQuickReportContent" style="background: rgba(15,23,42,.6); border: 1px solid rgba(71,85,105,.4); border-radius: 8px; padding: 20px; color: #e2e8f0; font-size: 0.92rem; line-height: 1.7; white-space: pre-wrap; min-height: 120px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; max-height: 400px; overflow-y: auto;">
      Carregando relat√≥rio...
    </div>
  </div>
  
  <div class="leads-content">
    <div class="leads-webhook">
      <div>
        <label>Webhook do Make.com</label>
        <input id="leadsWebhookUrl" type="text" readonly value="Gerando..." />
        <div class="leads-hint">Use este endpoint no Make.com (module Webhook/HTTP) para enviar name, email, phone, question, plataforma (Google ou Meta) e source por POST (JSON).</div>
      </div>
      <button class="btn small" id="leadsWebhookCopy" type="button">Copiar URL</button>
      <button class="btn small ghost" id="leadsWebhookRegenerate" type="button" title="Gera um novo token de seguran√ßa">Regenerar token</button>
    </div>
    
    <!-- A√ß√µes de importa√ß√£o -->
    <div class="leads-import-actions">
      <button class="btn small" id="leadsImportBtn" type="button">üì§ Importar Planilha</button>
      <button class="btn small ghost" id="leadsDownloadTemplate" type="button">üì• Baixar Template</button>
      <span class="leads-hint">Importe leads em massa de outras plataformas via CSV/Excel</span>
    </div>
    <!-- Barra de ferramentas de edi√ß√£o em lote -->
    <div id="leadsBulkToolbar" class="leads-bulk-toolbar">
      <div class="leads-bulk-info">
        <span id="leadsBulkCount">0</span> selecionado(s)
      </div>
      <div class="leads-bulk-actions">
        <button class="btn small" id="leadsBulkEdit" type="button">‚úé Editar Selecionados</button>
        <button class="btn small danger" id="leadsBulkDelete" type="button">√ó Remover Selecionados</button>
        <button class="btn small ghost" id="leadsBulkClear" type="button">Limpar Sele√ß√£o</button>
      </div>
    </div>

    <div class="leads-header">
      <div><input type="checkbox" id="leadsSelectAll" class="lead-checkbox" title="Selecionar todos"/></div>
      <div>Nome</div>
      <div>E-mail</div>
      <div>Telefone</div>
      <div>Pergunta</div>
      <div>Plataforma</div>
      <div>Fonte</div>
      <div>Quando</div>
      <div></div>
    </div>
    <div id="leadsList" class="leads-list"></div>
    <p id="leadsEmpty" class="leads-empty" style="display:none">Nenhum lead recebido ainda.</p>
  </div>
</div>
<!-- METAS -->
<div aria-hidden="true" class="metas-wrap" id="metasWrap" style="display:none">
  <div class="metas-toolbar">
    <div class="metas-year-selector" style="display: flex; align-items: center; gap: 8px; margin-right: auto;">
      <label for="metasYearSelect" style="font-weight: 600; color: #cbd5e1; font-size: 0.9rem;">üìÖ Ano:</label>
      <select id="metasYearSelect" style="background: #1e293b; border: 1px solid #334155; border-radius: 8px; color: #f8fafc; padding: 6px 12px; font-size: 0.9rem; font-weight: 600; min-width: 100px;">
        <!-- Anos ser√£o adicionados dinamicamente -->
      </select>
    </div>
    <button class="btn small" id="addMeta" type="button">Adicionar meta</button>
    <button class="btn small" id="sendMetasLink" type="button">Enviar link para cliente</button>
    <button class="btn small danger" id="clearMetas" type="button">Limpar tudo</button>
    <button class="btn small secondary" id="resetMetas" type="button">Resetar Metas</button>
  </div>
  <div id="metasSummary" class="metas-summary"></div>
  <div id="metasContainer"></div>
</div>
<!-- DEMANDAS -->
<div aria-hidden="true" class="demandas-wrap" id="demandasWrap" style="display:none">
  <div class="demandas-filters">
    <input type="text" id="demandaSearch" placeholder="Buscar...">
    <div class="demanda-month-filter" id="demandaMonthFilter">
      <div class="demanda-year-controls">
        <button class="demanda-year-btn" id="demandaYearPrev" type="button" aria-label="Ano anterior">‚óÄ</button>
        <span class="demanda-year-label" id="demandaYearLabel"></span>
        <button class="demanda-year-btn" id="demandaYearNext" type="button" aria-label="Pr√≥ximo ano">‚ñ∂</button>
      </div>
      <div class="demanda-month-buttons" id="demandaMonthButtons"></div>
      <select id="demandaMonthSelect" class="demanda-month-select" aria-label="Selecionar m√™s"></select>
    </div>
    <button class="btn small" id="addDemanda">Adicionar linha</button>
    <input type="url" id="demandasWebhook" placeholder="Webhook URL">
  </div>
  <div id="prazoAlert" class="prazo-alert" style="display:none">H√° demandas com per√≠odo vencido!</div>
  
  <!-- Barra de a√ß√µes em massa -->
  <div class="demandas-bulk-actions" id="demandaBulkActions">
    <span class="bulk-count"><span id="bulkSelectedCount">0</span> selecionada(s)</span>
    <button type="button" id="btnBulkEditDate">üìÖ Alterar Data</button>
    <button type="button" id="btnBulkEditStatus">üîÑ Alterar Status</button>
    <button type="button" id="btnBulkEditResponsavel">üë§ Alterar Respons√°vel</button>
    <button type="button" class="btn-secondary" id="btnBulkClearSelection">Desselecionar Todas</button>
  </div>
  
  <div class="table-wrap">
    <table class="demandas-table" id="demandasTable">
      <thead>
        <tr>
          <th class="col-checkbox"><input type="checkbox" id="demandaSelectAll" aria-label="Selecionar todas"></th>
          <th class="col-status">STATUS</th>
          <th class="col-demanda">OBJETIVO</th>
          <th class="col-resp">RESPONS√ÅVEL</th>
          <th class="col-prazo">PER√çODO</th>
          <th class="col-plano">PLANO</th>
          <th class="del-cell"></th>
        </tr>
        <tr class="filter-row">
          <th class="col-checkbox"></th>
          <th class="col-status">
            <select id="demandaStatusColumnFilter">
              <option value="">Status</option>
              <option value="nao-iniciado">N√£o iniciado</option>
              <option value="em-andamento">Em andamento</option>
              <option value="bloqueado">Bloqueado</option>
              <option value="concluido">Conclu√≠do</option>
              <option value="prioridade">Prioridade</option>
              <option value="prioridade-grupo">Prioridade/Grupo</option>
              <option value="concluido-grupo">Conclu√≠do/Grupo</option>
            </select>
          </th>
          <th class="col-demanda">
            <input type="text" id="demandaObjetivoFilter" placeholder="Filtrar objetivo...">
          </th>
          <th class="col-resp">
            <select id="demandaResponsavelFilter">
              <option value="">Respons√°vel</option>
              <option value="Bruno">Bruno</option>
              <option value="Camilla">Camilla</option>
              <option value="Clailton">Clailton</option>
              <option value="Guilherme">Guilherme</option>
              <option value="Mediagrowth">Mediagrowth</option>
              <option value="Cliente">Cliente</option>
              <option value="Theo">Theo</option>
            </select>
          </th>
          <th class="col-prazo">
            <div class="demanda-period-filter">
              <input type="date" id="demandaPeriodoInicioFilter" aria-label="Filtrar per√≠odo inicial">
              <span>at√©</span>
              <input type="date" id="demandaPeriodoFimFilter" aria-label="Filtrar per√≠odo final">
            </div>
          </th>
          <th class="col-plano"></th>
          <th class="del-cell">
            <button type="button" id="demandaFilterClear" class="filter-clear-btn">Limpar</button>
          </th>
        </tr>
      </thead>
      <tbody id="demandasBody"></tbody>
  </table>
  </div>
  <div class="demanda-ai-actions">
    <button class="btn small secondary" id="demandaObjectiveAIButton" type="button">Gerar Planejamento</button>
    <button class="btn small secondary" id="btnCopyPlanningLink" type="button">Copiar link do planejamento</button>
  </div>
  
  <!-- Resumo de demandas para WhatsApp -->
  <div class="demandas-summary-box">
    <div class="demandas-summary-header">
      <h4 class="demandas-summary-title">üì± Resumo para WhatsApp</h4>
      <div class="demandas-summary-buttons">
        <button class="demandas-summary-btn refresh" id="btnRefreshDemandasSummary">
          <span>üîÑ</span>
          <span>Atualizar</span>
        </button>
        <div class="demandas-summary-user-filter">
          <select id="selectDemandasUser" class="demandas-user-select">
            <option value="">üë§ Por usu√°rio...</option>
          </select>
          <button class="demandas-summary-btn user-copy" id="btnCopyDemandasByUser" disabled>
            <span>üìã</span>
            <span>Copiar</span>
          </button>
        </div>
        <button class="demandas-summary-btn" id="btnCopyDemandasSummary">
          <span>üìã</span>
          <span>Copiar Tudo</span>
        </button>
      </div>
    </div>
    <div id="demandasSummaryPreview" class="demandas-summary-preview">
      <span style="color:#8696a0">O resumo das demandas aparecer√° aqui...</span>
    </div>
    <textarea id="demandasSummaryText" class="demandas-summary-textarea" readonly placeholder="O resumo das demandas aparecer√° aqui..."></textarea>
  </div>
</div>

<!-- Modal de Ver/Editar Plano da Demanda -->
<div id="demandaPlanModal">
  <div class="demanda-plan-modal-content">
    <div class="demanda-plan-modal-header">
      <h3>üìù Plano da Demanda</h3>
      <button type="button" class="demanda-plan-modal-close" id="btnCloseDemandaPlan">‚úï</button>
    </div>
    <div class="demanda-plan-modal-body">
      <div class="form-group">
        <label for="demandaPlanTitle">Objetivo</label>
        <input type="text" id="demandaPlanTitle" readonly style="background:#0a0a0a;border:1px solid #222;color:#999;cursor:default;">
      </div>
      <div class="form-group">
        <label for="demandaPlanText">Plano / Anota√ß√µes</label>
        <textarea id="demandaPlanText" rows="12" placeholder="Descreva o plano, passos necess√°rios, observa√ß√µes..."></textarea>
        <p class="help-text">Use este espa√ßo para documentar o plano de a√ß√£o, requisitos, links √∫teis, etc.</p>
      </div>
    </div>
    <div class="demanda-plan-modal-footer">
      <button type="button" class="btn btn-ai" id="btnGenerateAIPlan" style="background:#7c3aed;margin-right:auto;">ü§ñ Gerar Plano com IA</button>
      <button type="button" class="btn btn-cancel" id="btnCancelDemandaPlan">Cancelar</button>
      <button type="button" class="btn btn-primary" id="btnSaveDemandaPlan">Salvar Plano</button>
    </div>
  </div>
</div>

<!-- Modal de Edi√ß√£o em Massa - Data -->
<div id="bulkEditModal">
  <div class="bulk-edit-content">
    <h3>üìÖ Alterar Data em Massa</h3>
    <div class="form-group">
      <label for="bulkEditDateType">Tipo de Data</label>
      <select id="bulkEditDateType" style="width:100%;background:#0f172a;border:1px solid #334155;border-radius:8px;color:#f8fafc;padding:10px;font-size:.9rem;">
        <option value="inicio">Data de In√≠cio</option>
        <option value="fim">Data de Fim</option>
        <option value="ambas">Ambas (In√≠cio e Fim)</option>
      </select>
      <p class="help-text">Escolha qual data deseja alterar nas demandas selecionadas</p>
    </div>
    <div class="form-group" id="bulkEditInicioGroup">
      <label for="bulkEditInicio">Data de In√≠cio</label>
      <input type="datetime-local" id="bulkEditInicio">
      <p class="help-text">Nova data de in√≠cio para as demandas selecionadas</p>
    </div>
    <div class="form-group" id="bulkEditFimGroup" style="display:none;">
      <label for="bulkEditFim">Data de Fim</label>
      <input type="datetime-local" id="bulkEditFim">
      <p class="help-text">Nova data de fim para as demandas selecionadas</p>
    </div>
    <div class="form-actions">
      <button type="button" class="btn btn-cancel" id="btnBulkEditCancel">Cancelar</button>
      <button type="button" class="btn btn-primary" id="btnBulkEditSave">Aplicar Altera√ß√µes</button>
    </div>
  </div>
</div>

<!-- Modal de Edi√ß√£o em Massa - Status -->
<div id="bulkEditStatusModal">
  <div class="bulk-edit-content">
    <h3>üîÑ Alterar Status em Massa</h3>
    <div class="form-group">
      <label for="bulkEditStatus">Novo Status</label>
      <select id="bulkEditStatus" style="width:100%;background:#0f172a;border:1px solid #334155;border-radius:8px;color:#f8fafc;padding:10px;font-size:.9rem;">
        <option value="">Selecione um status...</option>
        <option value="nao-iniciado">‚ö™ N√£o iniciado</option>
        <option value="em-andamento">üîµ Em andamento</option>
        <option value="bloqueado">üü° Bloqueado</option>
        <option value="concluido">üü¢ Conclu√≠do</option>
        <option value="prioridade">üî¥ Prioridade</option>
      </select>
      <p class="help-text">Este status ser√° aplicado a todas as demandas selecionadas</p>
    </div>
    <div class="form-actions">
      <button type="button" class="btn btn-cancel" id="btnBulkEditStatusCancel">Cancelar</button>
      <button type="button" class="btn btn-primary" id="btnBulkEditStatusSave">Aplicar Altera√ß√µes</button>
    </div>
  </div>
</div>

<!-- Modal de Edi√ß√£o em Massa - Respons√°vel -->
<div id="bulkEditResponsavelModal">
  <div class="bulk-edit-content">
    <h3>üë§ Alterar Respons√°vel em Massa</h3>
    <div class="form-group">
      <label for="bulkEditResponsavel">Novo Respons√°vel</label>
      <select id="bulkEditResponsavel" style="width:100%;background:#0f172a;border:1px solid #334155;border-radius:8px;color:#f8fafc;padding:10px;font-size:.9rem;">
        <option value="">Selecione um respons√°vel...</option>
        <option value="Bruno">Bruno</option>
        <option value="Camilla">Camilla</option>
        <option value="Clailton">Clailton</option>
        <option value="Guilherme">Guilherme</option>
        <option value="Mediagrowth">Mediagrowth</option>
        <option value="Cliente">Cliente</option>
        <option value="Theo">Theo</option>
      </select>
      <p class="help-text">Este respons√°vel ser√° atribu√≠do a todas as demandas selecionadas</p>
    </div>
    <div class="form-actions">
      <button type="button" class="btn btn-cancel" id="btnBulkEditResponsavelCancel">Cancelar</button>
      <button type="button" class="btn btn-primary" id="btnBulkEditResponsavelSave">Aplicar Altera√ß√µes</button>
    </div>
  </div>
</div>

<!-- ARQUIVOS -->
<div aria-hidden="true" class="files-wrap" id="filesWrap" style="display:none">
  <div class="files-layout">
    <aside aria-label="Pastas" class="files-sidebar">
      <div class="files-sidebar-head">
        <button class="btn small" id="newFolder" type="button">Nova pasta</button>
      </div>
      <div class="folder-tree" id="foldersList"></div>
    </aside>
    <section aria-label="Gerenciador de arquivos" class="files-main" id="filesPane">
      <div class="files-breadcrumb" id="filesBreadcrumb"></div>
      <div class="files-actions">
        <div class="left-actions">
          <button class="btn small" id="uploadFilesBtn" type="button">Adicionar arquivos</button>
          <input id="fileInput" multiple type="file">
          <button aria-pressed="false" class="btn small secondary" id="viewAllFilesBtn" type="button">Ver todos os arquivos</button>
        </div>
        <div aria-label="Alternar visualiza√ß√£o" class="files-view-toggle" id="filesViewToggle" role="group">
          <button aria-pressed="true" class="view-btn active" data-mode="list" type="button">Lista</button>
          <button aria-pressed="false" class="view-btn" data-mode="grid" type="button">√çcones</button>
        </div>
        <div class="files-select-tools">
          <label class="select-all-box" for="filesSelectAll">
            <input id="filesSelectAll" type="checkbox">
            <span>Selecionar todos</span>
          </label>
        </div>
        <div class="upload-progress hidden" id="uploadProgress" role="status" aria-live="polite">
          <span class="upload-progress-text" id="uploadProgressText"></span>
          <div class="upload-progress-track">
            <div class="upload-progress-fill" id="uploadProgressBar"></div>
          </div>
          <span class="upload-progress-percent" id="uploadProgressPercent"></span>
        </div>
      </div>
      <div class="files-empty" id="filesEmpty"></div>
      <div class="subfolders-grid hidden" id="subfoldersGrid"></div>
      <div class="files-list hidden" id="filesList"></div>
      <div class="files-bulk-bar hidden" id="filesBulkBar">
        <div class="files-bulk-info">
          <strong>A√ß√µes</strong>
          <span class="files-bulk-count" id="filesBulkCount"></span>
          <span class="files-bulk-status" id="filesBulkStatus"></span>
        </div>
        <div class="files-bulk-actions">
          <button class="btn small danger" data-action="delete" type="button">Excluir</button>
          <button class="btn small" data-action="move" type="button">Mover</button>
          <button class="btn small secondary" data-action="rename" type="button">Renomear</button>
          <button class="btn small ghost hidden" id="filesBulkUndo" type="button">Desfazer</button>
        </div>
      </div>
    </section>
  </div>
</div>
<div aria-hidden="true" class="modal" id="filePreviewModal">
  <div aria-modal="true" class="modal-card" role="dialog">
    <div class="modal-head">
      <strong id="filePreviewTitle">Pr√©-visualiza√ß√£o</strong>
      <button class="btn small secondary" id="filePreviewClose" type="button">Fechar</button>
    </div>
    <div class="modal-body file-preview-body">
      <div class="preview" id="filePreviewContent"></div>
      <div class="file-preview-info" id="filePreviewInfo"></div>
    </div>
  </div>
</div>
<!-- MODAL COLAR METAS -->
<div aria-hidden="true" class="modal" id="colarMetasModal" style="display:none">
  <div aria-modal="true" class="modal-card" role="dialog" style="max-width: 700px;">
    <div class="modal-head">
      <strong>üìã Colar Valores Mensais</strong>
      <button class="btn small secondary" id="colarMetasClose" type="button">Fechar</button>
    </div>
    <div class="modal-body" style="display: flex; flex-direction: column; gap: 16px; padding: 20px;">
      <div style="padding: 12px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px;">
        <strong id="colarMetasMetaName" style="color: #60a5fa; font-size: 0.95rem;">Meta</strong>
      </div>
      
      <!-- Abas de entrada -->
      <div style="display: flex; gap: 8px; border-bottom: 1px solid #334155;">
        <button id="colarMetasTabText" class="colar-metas-tab active" style="flex: 1; padding: 10px; background: transparent; border: none; color: #60a5fa; border-bottom: 2px solid #60a5fa; cursor: pointer; font-weight: 600;">
          üìù Colar Texto
        </button>
        <button id="colarMetasTabImage" class="colar-metas-tab" style="flex: 1; padding: 10px; background: transparent; border: none; color: #94a3b8; border-bottom: 2px solid transparent; cursor: pointer; font-weight: 600;">
          üñºÔ∏è Upload Imagem
        </button>
      </div>
      
      <!-- Conte√∫do da aba Texto -->
      <div id="colarMetasTextContent" style="display: flex; flex-direction: column; gap: 16px;">
        <p style="margin: 0; color: #94a3b8; font-size: 0.9rem;">
          Cole os valores mensais (planejados) abaixo. Aceita valores <strong style="color: #60a5fa;">separados por v√≠rgula</strong> ou <strong style="color: #60a5fa;">quebra de linha</strong>. 
          Cada n√∫mero ser√° aplicado sequencialmente nos 12 meses (Jan a Dez) desta meta.
        </p>
        <textarea 
          id="colarMetasTextarea" 
          placeholder="Exemplo com v√≠rgulas:&#10;5000, 5500, 6000, 6500, 7000, 7500, 8000, 8500, 9000, 9500, 10000, 10500&#10;&#10;Ou quebra de linha:&#10;5000&#10;5500&#10;6000&#10;..."
          style="min-height: 280px; resize: vertical; font-family: monospace; background: #111827; border: 1px solid #334155; border-radius: 10px; color: #f8fafc; padding: 12px; font-size: 0.9rem;"
        ></textarea>
      </div>
      
      <!-- Conte√∫do da aba Imagem -->
      <div id="colarMetasImageContent" style="display: none; flex-direction: column; gap: 16px;">
        <p style="margin: 0; color: #94a3b8; font-size: 0.9rem;">
          <strong style="color: #60a5fa;">Cole uma imagem</strong> (Ctrl+V ou Cmd+V) contendo os valores mensais. 
          O sistema usar√° OCR (reconhecimento de texto) para extrair automaticamente os n√∫meros.
        </p>
        
        <div 
          id="colarMetasImagePasteArea" 
          tabindex="0"
          style="border: 2px dashed #334155; border-radius: 10px; padding: 30px; text-align: center; background: #111827; cursor: text; min-height: 150px; display: flex; align-items: center; justify-content: center; flex-direction: column; transition: all 0.2s ease;">
          <div id="colarMetasImagePlaceholder">
            <div style="font-size: 3rem; margin-bottom: 10px;">üìãüñºÔ∏è</div>
            <p style="color: #94a3b8; margin: 0; font-weight: 600;">Clique aqui e cole uma imagem (Ctrl+V)</p>
            <p style="color: #64748b; font-size: 0.85rem; margin-top: 8px;">A imagem da √°rea de transfer√™ncia ser√° processada automaticamente</p>
          </div>
          <div id="colarMetasImagePreview" style="display: none; max-width: 100%;">
            <img id="colarMetasImagePreviewImg" style="max-width: 100%; max-height: 300px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);" />
            <p style="color: #94a3b8; margin-top: 10px; font-size: 0.9rem;" id="colarMetasImageName">Imagem colada da √°rea de transfer√™ncia</p>
            <div style="display: flex; gap: 10px; margin-top: 10px; justify-content: center;">
              <button type="button" id="colarMetasImageExtract" style="padding: 10px 20px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border: none; border-radius: 8px; color: white; cursor: pointer; font-size: 0.9rem; font-weight: 600; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3); transition: all 0.2s ease;">
                üîç Extrair N√∫meros
              </button>
              <button type="button" id="colarMetasImageRemove" style="padding: 10px 20px; background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; color: #f87171; cursor: pointer; font-size: 0.9rem; font-weight: 600;">
                ‚úï Remover
              </button>
            </div>
          </div>
        </div>
        
        <div id="colarMetasImageStatus" style="display: none; padding: 12px; border-radius: 8px; font-size: 0.9rem;">
          <div id="colarMetasImageStatusText"></div>
        </div>
        
        <div id="colarMetasExtractedNumbers" style="display: none;">
          <p style="margin: 0 0 8px 0; color: #60a5fa; font-weight: 600; font-size: 0.9rem;">üìä N√∫meros extra√≠dos:</p>
          <textarea 
            id="colarMetasExtractedTextarea" 
            placeholder="N√∫meros extra√≠dos aparecer√£o aqui..."
            style="min-height: 150px; resize: vertical; font-family: monospace; background: #111827; border: 1px solid #334155; border-radius: 10px; color: #f8fafc; padding: 12px; font-size: 0.9rem;"
          ></textarea>
          <p style="margin-top: 8px; color: #94a3b8; font-size: 0.85rem;">
            ‚ÑπÔ∏è Voc√™ pode editar os n√∫meros extra√≠dos antes de aplicar
          </p>
        </div>
      </div>
      
      <div style="display: flex; gap: 8px; align-items: center; color: #94a3b8; font-size: 0.85rem;">
        <span>N√∫meros encontrados: <strong id="colarMetasCount">0</strong></span>
        <span style="margin-left: auto;">Esperado: <strong>12 (Jan-Dez)</strong></span>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn small secondary" id="colarMetasCancel" type="button">Cancelar</button>
      <button class="btn small" id="colarMetasApply" type="button">Aplicar Valores</button>
    </div>
  </div>
</div>
<!-- CONCORRENTES -->
<div aria-hidden="true" class="competitors-wrap" id="competitorsWrap" style="display:none">
  <div class="competitors-controls">
    <input type="text" id="competitorName" placeholder="Nome do concorrente">
    <input type="url" id="competitorLink" placeholder="Link">
    <input type="text" id="competitorTags" placeholder="Tags">
    <button class="btn small" id="addCompetitor">Adicionar</button>
  </div>
  <div class="table-wrap">
    <table class="competitors-table" id="competitorsTable">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Link</th>
          <th>Tags</th>
          <th class="del-cell"></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
<!-- NOTAS / ESTRAT√âGIAS -->
<div aria-hidden="true" class="notes-wrap" id="notesWrap" style="display:none">
<div class="note-toolbar">
<button class="tool" data-cmd="bold"><b>B</b></button>
<button class="tool" data-cmd="italic"><i>I</i></button>
<button class="tool" data-cmd="underline"><u>U</u></button>
<input class="tool" id="noteColor" title="Cor do texto" type="color" value="#ffffff"/>
<button class="tool" data-cmd="insertUnorderedList">‚Ä¢ Lista</button>
<button class="tool" data-cmd="insertOrderedList">1. Lista</button>
<button class="tool" data-cmd="formatBlock" data-value="H1">H1</button>
<button class="tool" data-cmd="formatBlock" data-value="H2">H2</button>
  <button class="tool" id="makeLink">üîó Link (texto)</button>
  <button class="tool" id="btnImg">üñºÔ∏è Imagem</button>
  <button class="tool" id="btnImgLink">üîó Link da imagem</button>
  <button class="tool" id="btnVideo">üé¨ V√≠deo</button>
  <button class="tool" id="btnVideoLink">üîó Link do v√≠deo</button>
  <input accept="image/*" id="imgInput" style="display:none" type="file"/>
  <input accept="video/*" id="videoInput" style="display:none" type="file"/>
  <span style="flex:1"></span>
<label>Nome (gerado automaticamente): <input id="noteTitle" placeholder="T√≠tulo gerado automaticamente" type="text"/></label>
<label>Setor:
          <select id="noteSector">
<option value="roi">ROI</option><option value="vitrine-engajamento">Vitrine/Engajamento</option>
<option value="novasideias">Novas Ideias</option><option value="relacionamento">Relacionamento</option>
<option value="ia">I.A</option><option value="gbp">Google Business Profile</option>
</select>
</label>
<label>Data (auto): <input id="noteDate" type="date"/></label>
<div class="note-template-actions">
  <select id="noteTemplateSelect" title="Templates salvos">
    <option value="">Selecionar template...</option>
  </select>
  <button class="btn small secondary" id="insertTemplateBtn" type="button" disabled>Inserir Template</button>
  <button class="btn small" id="saveTemplateBtn" type="button">Salvar como Template</button>
</div>
<span class="muted" id="noteAutoSaveStatus">Altera√ß√µes s√£o salvas automaticamente.</span>
<button class="btn small" id="newNoteBtn" type="button">Nova anota√ß√£o</button>
</div>
<div aria-label="Editor de notas" class="note-editor" contenteditable="true" id="noteEditor"></div>
<div class="note-toolbar" style="justify-content:space-between">
<div style="display:flex;gap:8px;align-items:center">
<strong>Filtrar:</strong>
<select id="filterSector">
<option value="">Todos</option>
<option value="roi">ROI</option><option value="vitrine-engajamento">Vitrine/Engajamento</option>
<option value="novasideias">Novas Ideias</option><option value="relacionamento">Relacionamento</option>
<option value="ia">I.A</option><option value="gbp">Google Business Profile</option>
</select>
<input id="filterFrom" title="De" type="date"/><input id="filterTo" title="At√©" type="date"/>
<button class="btn small" id="applyFilter">Aplicar</button>
<button class="btn small secondary" id="clearFilter">Limpar</button>
</div>
<div class="muted">Dica: cole prints com <b>Ctrl/‚åò+V</b>, redimensione e adicione link.</div>
</div>
<div class="notes-list" id="notesList"></div>
</div>

<!-- ESTRUTURA√á√ÉO -->
<div aria-hidden="true" class="estruturacao-wrap" id="estruturacaoWrap" style="display:none">
  <div class="estruturacao-header">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <h2 class="estruturacao-title" style="margin:0;">üéØ Estrutura√ß√£o de Marketing e Comercial</h2>
      <button class="btn" id="clearAllEstruturacaoBtn" onclick="clearAllEstruturacao()" style="background:#dc2626;border:none;padding:8px 16px;font-size:0.85rem;white-space:nowrap;">
        üóëÔ∏è Limpar Tudo
      </button>
    </div>
    <p class="estruturacao-subtitle">Acompanhe o progresso de cada etapa do processo de estrutura√ß√£o</p>
    
    <!-- Informa√ß√µes do Neg√≥cio para IA -->
    <div class="estruturacao-business-info" id="estruturacaoBusinessInfo">
      <div class="estruturacao-business-info-header">
        <span class="estruturacao-business-info-title">üìã Contexto do Neg√≥cio</span>
        <button class="estruturacao-business-save-btn" id="saveBusinessInfoBtn" onclick="saveBusinessInfo()">üíæ Salvar</button>
        <span class="estruturacao-business-save-status" id="businessSaveStatus"></span>
      </div>
      
      <div class="estruturacao-business-info-fields">
        <div class="estruturacao-business-info-field">
          <label class="estruturacao-business-label">Nome do Neg√≥cio</label>
          <input type="text" id="businessName" class="estruturacao-business-input" placeholder="Ex: Cl√≠nica Sorriso Perfeito" />
        </div>
        <div class="estruturacao-business-info-field">
          <label class="estruturacao-business-label">Nicho/Segmento</label>
          <input type="text" id="businessNiche" class="estruturacao-business-input" placeholder="Ex: odontologia, advocacia, e-commerce" />
        </div>
        <div class="estruturacao-business-info-field">
          <label class="estruturacao-business-label">üìç Localiza√ß√£o/Endere√ßo</label>
          <input type="text" id="businessLocation" class="estruturacao-business-input" placeholder="Ex: S√£o Paulo, SP - Brasil / Miami, FL - USA" />
        </div>
        <div class="estruturacao-business-info-field">
          <label class="estruturacao-business-label">üåç Pa√≠s de Atua√ß√£o</label>
          <select id="businessCountry" class="estruturacao-business-input" style="cursor:pointer;">
            <option value="">Selecione o pa√≠s...</option>
            <option value="BR">üáßüá∑ Brasil (R$ - Real)</option>
            <option value="US">üá∫üá∏ Estados Unidos ($ - D√≥lar)</option>
            <option value="PT">üáµüáπ Portugal (‚Ç¨ - Euro)</option>
            <option value="OTHER">üåç Outro pa√≠s</option>
          </select>
        </div>
        <div class="estruturacao-business-info-field">
          <label class="estruturacao-business-label">Tempo de Mercado</label>
          <input type="text" id="businessTime" class="estruturacao-business-input" placeholder="Ex: 3 anos" />
        </div>
        <div class="estruturacao-business-info-field">
          <label class="estruturacao-business-label">Or√ßamento de Marketing/m√™s</label>
          <input type="text" id="businessBudget" class="estruturacao-business-input" placeholder="Ex: R$ 5.000 (investimento em an√∫ncios)" />
        </div>
        <div class="estruturacao-business-info-field">
          <label class="estruturacao-business-label">üíº Valor Pago para Ag√™ncia/m√™s</label>
          <input type="text" id="businessAgencyFee" class="estruturacao-business-input" placeholder="Ex: R$ 3.000 (fee da ag√™ncia)" />
        </div>
        <div class="estruturacao-business-info-field">
          <label class="estruturacao-business-label">Ticket M√©dio</label>
          <input type="text" id="businessTicket" class="estruturacao-business-input" placeholder="Ex: R$ 500, R$ 2.000" />
        </div>
        <div class="estruturacao-business-info-field estruturacao-business-info-field-obs">
          <label class="estruturacao-business-label">Observa√ß√µes Importantes</label>
          <textarea id="businessObservations" class="estruturacao-business-input estruturacao-business-textarea" placeholder="Modelo de neg√≥cio, desafios, diferenciais..." rows="3" style="resize: vertical; min-height: 60px; max-height: 300px; overflow-y: auto;"></textarea>
        </div>
      </div>
    </div>
    
    <div class="estruturacao-progress-bar">
      <div class="estruturacao-progress-fill" id="estruturacaoProgressFill" style="width:0%"></div>
    </div>
    <div class="estruturacao-progress-text">
      <span id="estruturacaoProgressText">0% conclu√≠do</span>
      <span id="estruturacaoProgressCount">0 de 0 itens</span>
    </div>
    
    <!-- Barra de Pesquisa -->
    <div class="estruturacao-search-wrap">
      <input type="text" class="estruturacao-search-input" id="estruturacaoSearchInput" placeholder="üîç Pesquisar em todas as semanas, blocos e itens...">
      <span class="estruturacao-search-icon">üîç</span>
      <button class="estruturacao-search-clear" id="estruturacaoSearchClear" title="Limpar pesquisa">‚úï</button>
      <div class="estruturacao-search-results" id="estruturacaoSearchResults"></div>
    </div>
    
    <!-- Bot√µes de Filtro de M√≠dia -->
    <div class="estruturacao-media-filters">
      <button class="estruturacao-media-filter-btn" id="filterImagesBtn" title="Ver galeria de imagens">
        <span class="filter-icon">üñºÔ∏è</span>
        <span>Imagens</span>
        <span class="filter-count" id="filterImagesCount">0</span>
      </button>
      <button class="estruturacao-media-filter-btn" id="filterVideosBtn" title="Ver galeria de v√≠deos">
        <span class="filter-icon">üé¨</span>
        <span>V√≠deos</span>
        <span class="filter-count" id="filterVideosCount">0</span>
      </button>
      <button class="estruturacao-media-filter-btn" id="filterDocumentsBtn" title="Ver galeria de arquivos">
        <span class="filter-icon">üìÅ</span>
        <span>Arquivos</span>
        <span class="filter-count" id="filterDocumentsCount">0</span>
      </button>
    </div>
  </div>
  
  <!-- Galeria de M√≠dia -->
  <div class="estruturacao-media-gallery" id="estruturacaoMediaGallery">
    <div class="estruturacao-media-gallery-header">
      <h3 class="estruturacao-media-gallery-title">
        <span class="gallery-icon" id="galleryIcon">üñºÔ∏è</span>
        <span id="galleryTitle">Galeria de Imagens</span>
      </h3>
      <button class="estruturacao-media-gallery-close" id="closeGalleryBtn" title="Fechar galeria">‚úï</button>
    </div>
    <div class="estruturacao-media-gallery-grid" id="estruturacaoMediaGalleryGrid">
      <!-- Itens da galeria ser√£o inseridos aqui -->
    </div>
  </div>
  
  <!-- Lightbox para visualiza√ß√£o em tela cheia -->
  <div class="estruturacao-lightbox" id="estruturacaoLightbox">
    <div class="estruturacao-lightbox-content" id="estruturacaoLightboxContent">
      <button class="estruturacao-lightbox-close" id="closeLightboxBtn" title="Fechar">‚úï</button>
      <!-- Conte√∫do do lightbox ser√° inserido aqui -->
    </div>
    <div class="estruturacao-lightbox-info" id="estruturacaoLightboxInfo"></div>
  </div>

  <div class="estruturacao-weeks" id="estruturacaoWeeks"></div>

  <!-- SE√á√ÉO DE LEMBRETES - Itens marcados para lembrar depois -->
  <div class="estruturacao-reminders" id="estruturacaoReminders" style="display:none">
    <div class="estruturacao-reminders-header">
      <h3>Lembrar Depois</h3>
      <span class="estruturacao-reminders-count" id="estruturacaoRemindersCount">0</span>
    </div>
    <div class="estruturacao-reminders-list" id="estruturacaoRemindersList">
      <div class="estruturacao-reminders-empty">Nenhum item marcado para lembrar.</div>
    </div>
  </div>

  <!-- ENTREG√ÅVEIS MEDIAGROWTH - DROPDOWN ESTILO SEMANA -->
  <div class="estruturacao-week entregaveis-week" id="entregaveisWeek">
    <div class="estruturacao-week-header" onclick="document.getElementById('entregaveisWeek').classList.toggle('open')">
      <div class="estruturacao-week-badge" style="background:linear-gradient(135deg,#00c853,#1b5e20)">üéÅ</div>
      <div class="estruturacao-week-info">
        <h3 class="estruturacao-week-title">Tudo que voc√™ vai receber</h3>
        <p class="estruturacao-week-desc">Conhe√ßa todos os entreg√°veis inclusos na sua estrutura√ß√£o</p>
      </div>
      <div class="estruturacao-week-progress">
        <span>18 entreg√°veis</span>
      </div>
      <span class="estruturacao-week-chevron">‚ñæ</span>
    </div>
    <div class="estruturacao-week-body">
      <div class="estruturacao-week-content">
        <div class="entregaveis-intro">
          <p>Durante as semanas de estrutura√ß√£o, voc√™ receber√° todos estes materiais e servi√ßos profissionais para transformar seu marketing e comercial.</p>
        </div>

        <!-- Bot√£o Relat√≥rio Completo -->
        <div class="relatorio-completo-section">
          <div class="relatorio-completo-info">
            <h4>üìã Relat√≥rio Unificado de An√°lises</h4>
            <p>Visualize ou baixe todas as an√°lises geradas em um √∫nico documento</p>
          </div>
          <div class="relatorio-completo-btns">
            <button class="btn-relatorio-completo btn-relatorio-visualizar" onclick="abrirRelatorioCompleto()">
              <span>üëÅÔ∏è</span> Visualizar Relat√≥rio
            </button>
            <button class="btn-relatorio-completo btn-relatorio-pdf" onclick="baixarRelatorioPDF()">
              <span>üì•</span> Baixar PDF
            </button>
          </div>
        </div>

        <!-- Galeria de Entreg√°veis -->
        <div class="entregaveis-gallery" id="entregaveisGallery">
          
          <!-- 1. Diagn√≥stico Estrat√©gico Completo -->
          <div class="entregavel-card" data-entregavel="diagnostico_estrategico">
            <div class="entregavel-image">
              <img src="assets/entregaveis mediagrwoth/Diagn√≥stico Estrat√©gico Completo.png" alt="Diagn√≥stico Estrat√©gico Completo">
              <div class="entregavel-image-placeholder" style="display:none">ÔøΩ</div>
            </div>
            <div class="entregavel-info">
              <h4 class="entregavel-name">Diagn√≥stico Estrat√©gico Completo</h4>
              <p class="entregavel-desc">‚≠êÔ∏è An√°lise completa do modelo de neg√≥cio</p>
              <p class="entregavel-desc">‚≠êÔ∏è Diagn√≥stico de marketing e vendas</p>
              <p class="entregavel-desc">‚≠êÔ∏è Identifica√ß√£o de gargalos de convers√£o</p>
              <p class="entregavel-desc">‚≠êÔ∏è An√°lise de posicionamento da marca</p>
              <span class="entregavel-value">Valor: R$ 1.000</span>
              <div class="entregavel-buttons-row">
                <button class="entregavel-analise-btn" onclick="abrirAnaliseEntregavel('diagnostico_estrategico')">ÔøΩ An√°lise</button>
                <button class="entregavel-gerar-btn" onclick="gerarAnaliseRapida('diagnostico_estrategico', this)">‚ú® Gerar</button>
              </div>
            </div>
          </div>

          <!-- 2. Direcionamento Estrat√©gico e Metas -->
          <div class="entregavel-card" data-entregavel="direcionamento_metas">
            <div class="entregavel-image">
              <img src="assets/entregaveis mediagrwoth/Direcionamento Estrat√©gico e Metas.png" alt="Direcionamento Estrat√©gico e Metas">
              <div class="entregavel-image-placeholder" style="display:none">üéØ</div>
            </div>
            <div class="entregavel-info">
              <h4 class="entregavel-name">Direcionamento Estrat√©gico e Metas</h4>
              <p class="entregavel-desc">‚≠êÔ∏è Defini√ß√£o de objetivo financeiro</p>
              <p class="entregavel-desc">‚≠êÔ∏è Metas anuais, mensais e por canal</p>
              <p class="entregavel-desc">‚≠êÔ∏è Defini√ß√£o de KPIs</p>
              <p class="entregavel-desc">‚≠êÔ∏è M√©tricas m√≠nimas de viabilidade</p>
              <span class="entregavel-value">Valor: R$ 1.000</span>
              <div class="entregavel-buttons-row">
                
                <button class="entregavel-analise-btn" onclick="abrirAnaliseEntregavel('direcionamento_metas')">üìä An√°lise</button>
                <button class="entregavel-gerar-btn" onclick="gerarAnaliseRapida('direcionamento_metas', this)">‚ú® Gerar</button>
              </div>
            </div>
          </div>

          <!-- 3. An√°lise de Concorr√™ncia e Mercado -->
          <div class="entregavel-card" data-entregavel="analise_concorrencia">
            <div class="entregavel-image">
              <img src="assets/entregaveis mediagrwoth/An√°lise de Concorr√™ncia e Mercado.png" alt="An√°lise de Concorr√™ncia e Mercado">
              <div class="entregavel-image-placeholder" style="display:none">ÔøΩ</div>
            </div>
            <div class="entregavel-info">
              <h4 class="entregavel-name">An√°lise de Concorr√™ncia e Mercado</h4>
              <p class="entregavel-desc">‚≠êÔ∏è An√°lise de concorrentes diretos e indiretos</p>
              <p class="entregavel-desc">‚≠êÔ∏è Estudo de promessas e ofertas do mercado</p>
              <p class="entregavel-desc">‚≠êÔ∏è Identifica√ß√£o de pontos fracos explor√°veis</p>
              <p class="entregavel-desc">‚≠êÔ∏è Oportunidades de diferencia√ß√£o</p>
              <span class="entregavel-value">Valor: R$ 1.000</span>
              <div class="entregavel-buttons-row">
                
                <button class="entregavel-analise-btn" onclick="abrirAnaliseEntregavel('analise_concorrencia')">üìä An√°lise</button>
                <button class="entregavel-gerar-btn" onclick="gerarAnaliseRapida('analise_concorrencia', this)">‚ú® Gerar</button>
              </div>
            </div>
          </div>

          <!-- 4. Matriz CDT -->
          <div class="entregavel-card" data-entregavel="matriz_cdt">
            <div class="entregavel-image">
              <img src="assets/entregaveis mediagrwoth/matriz cdt.png" alt="Matriz CDT">
              <div class="entregavel-image-placeholder" style="display:none">üìã</div>
            </div>
            <div class="entregavel-info">
              <h4 class="entregavel-name">Matriz CDT</h4>
              <p class="entregavel-desc">‚≠êÔ∏è Mapeamento completo do neg√≥cio</p>
              <p class="entregavel-desc">‚≠êÔ∏è Identifica√ß√£o das dores reais do cliente</p>
              <p class="entregavel-desc">‚≠êÔ∏è Mapeamento de obje√ß√µes</p>
              <p class="entregavel-desc">‚≠êÔ∏è Defini√ß√£o das transforma√ß√µes prometidas</p>
              <span class="entregavel-value">Valor: R$ 750</span>
              <div class="entregavel-buttons-row">
                
                <button class="entregavel-analise-btn" onclick="abrirAnaliseEntregavel('matriz_cdt')">üìä An√°lise</button>
                <button class="entregavel-gerar-btn" onclick="gerarAnaliseRapida('matriz_cdt', this)">‚ú® Gerar</button>
              </div>
            </div>
          </div>

          <!-- 5. PUV - Proposta √önica de Valor -->
          <div class="entregavel-card" data-entregavel="puv">
            <div class="entregavel-image">
              <img src="assets/entregaveis mediagrwoth/puv Proposta √∫nica de valor.png" alt="PUV - Proposta √önica de Valor">
              <div class="entregavel-image-placeholder" style="display:none">ÔøΩ</div>
            </div>
            <div class="entregavel-info">
              <h4 class="entregavel-name">PUV - Proposta √önica de Valor</h4>
              <p class="entregavel-desc">‚≠êÔ∏è Defini√ß√£o do diferencial competitivo</p>
              <p class="entregavel-desc">‚≠êÔ∏è Constru√ß√£o da mensagem central da marca</p>
              <p class="entregavel-desc">‚≠êÔ∏è Direcionamento de posicionamento</p>
              <span class="entregavel-value">Valor: R$ 750</span>
              <div class="entregavel-buttons-row">
                
                <button class="entregavel-analise-btn" onclick="abrirAnaliseEntregavel('puv')">üìä An√°lise</button>
                <button class="entregavel-gerar-btn" onclick="gerarAnaliseRapida('puv', this)">‚ú® Gerar</button>
              </div>
            </div>
          </div>

          <!-- 6. PAI - P√∫blico Alvo Ideal -->
          <div class="entregavel-card" data-entregavel="pai">
            <div class="entregavel-image">
              <img src="assets/entregaveis mediagrwoth/p.a.i p√∫blico alvo ideal.png" alt="PAI - P√∫blico Alvo Ideal">
              <div class="entregavel-image-placeholder" style="display:none">üë•</div>
            </div>
            <div class="entregavel-info">
              <h4 class="entregavel-name">PAI - P√∫blico Alvo Ideal</h4>
              <p class="entregavel-desc">‚≠êÔ∏è Defini√ß√£o do perfil do cliente ideal</p>
              <p class="entregavel-desc">‚≠êÔ∏è Mapeamento de comportamento de compra</p>
              <p class="entregavel-desc">‚≠êÔ∏è Identifica√ß√£o de obje√ß√µes</p>
              <p class="entregavel-desc">‚≠êÔ∏è An√°lise do momento de decis√£o</p>
              <span class="entregavel-value">Valor: R$ 1.000</span>
              <div class="entregavel-buttons-row">
                
                <button class="entregavel-analise-btn" onclick="abrirAnaliseEntregavel('pai')">üìä An√°lise</button>
                <button class="entregavel-gerar-btn" onclick="gerarAnaliseRapida('pai', this)">‚ú® Gerar</button>
              </div>
            </div>
          </div>

          <!-- 7. Estrutura√ß√£o de An√∫ncios Pagos -->
          <div class="entregavel-card" data-entregavel="anuncios_pagos">
            <div class="entregavel-image">
              <img src="assets/entregaveis mediagrwoth/estrutura√ß√£o  an√∫ncios pagos.png" alt="Estrutura√ß√£o de An√∫ncios Pagos">
              <div class="entregavel-image-placeholder" style="display:none">ÔøΩ</div>
            </div>
            <div class="entregavel-info">
              <h4 class="entregavel-name">Estrutura√ß√£o de An√∫ncios Pagos</h4>
              <p class="entregavel-desc">‚≠êÔ∏è Estrutura√ß√£o de campanhas Meta Ads e Google Ads</p>
              <p class="entregavel-desc">‚≠êÔ∏è Defini√ß√£o de funis de inten√ß√£o</p>
              <p class="entregavel-desc">‚≠êÔ∏è Planejamento de p√∫blicos e palavras-chave</p>
              <p class="entregavel-desc">‚≠êÔ∏è Estrat√©gia de capta√ß√£o de demanda</p>
              <span class="entregavel-value">Valor: R$ 700</span>
              <div class="entregavel-buttons-row">
                
                <button class="entregavel-analise-btn" onclick="abrirAnaliseEntregavel('anuncios_pagos')">üìä An√°lise</button>
                <button class="entregavel-gerar-btn" onclick="gerarAnaliseRapida('anuncios_pagos', this)">‚ú® Gerar</button>
              </div>
            </div>
          </div>

          <!-- 8. Estrutura√ß√£o Site & SEO -->
          <div class="entregavel-card" data-entregavel="site_seo">
            <div class="entregavel-image">
              <img src="assets/entregaveis mediagrwoth/Estrutura√ß√£o  Site & SEO.png" alt="Estrutura√ß√£o Site & SEO">
              <div class="entregavel-image-placeholder" style="display:none">üåê</div>
            </div>
            <div class="entregavel-info">
              <h4 class="entregavel-name">Estrutura√ß√£o Site & SEO</h4>
              <p class="entregavel-desc">‚≠êÔ∏è Defini√ß√£o da arquitetura do site</p>
              <p class="entregavel-desc">‚≠êÔ∏è Estrutura√ß√£o de p√°ginas de venda</p>
              <p class="entregavel-desc">‚≠êÔ∏è Direcionamento estrat√©gico de SEO</p>
              <p class="entregavel-desc">‚≠êÔ∏è Planejamento de conte√∫dos para ranqueamento</p>
              <p class="entregavel-desc">‚≠êÔ∏è Planejamento de conte√∫dos para os blogs</p>
              <span class="entregavel-value">Valor: R$ 1.500</span>
              <div class="entregavel-buttons-row">
                
                <button class="entregavel-analise-btn" onclick="abrirAnaliseEntregavel('site_seo')">üìä An√°lise</button>
                <button class="entregavel-gerar-btn" onclick="gerarAnaliseRapida('site_seo', this)">‚ú® Gerar</button>
              </div>
            </div>
          </div>

          <!-- 9. Estrat√©gias para Redes Sociais -->
          <div class="entregavel-card" data-entregavel="redes_sociais">
            <div class="entregavel-image">
              <img src="assets/entregaveis mediagrwoth/Estrat√©gias para as  Redes Sociais.png" alt="Estrat√©gias para Redes Sociais">
              <div class="entregavel-image-placeholder" style="display:none">üì±</div>
            </div>
            <div class="entregavel-info">
              <h4 class="entregavel-name">Estrat√©gias para Redes Sociais</h4>
              <p class="entregavel-desc">‚≠êÔ∏è Defini√ß√£o do objetivo das redes</p>
              <p class="entregavel-desc">‚≠êÔ∏è Planejamento de tipos de conte√∫do</p>
              <p class="entregavel-desc">‚≠êÔ∏è Defini√ß√£o de frequ√™ncia ideal</p>
              <p class="entregavel-desc">‚≠êÔ∏è Alinhamento da linguagem da marca</p>
              <span class="entregavel-value">Valor: R$ 525</span>
              <div class="entregavel-buttons-row">
                
                <button class="entregavel-analise-btn" onclick="abrirAnaliseEntregavel('redes_sociais')">üìä An√°lise</button>
                <button class="entregavel-gerar-btn" onclick="gerarAnaliseRapida('redes_sociais', this)">‚ú® Gerar</button>
              </div>
            </div>
          </div>

          <!-- 10. Copywriting Estrat√©gico -->
          <div class="entregavel-card" data-entregavel="copywriting">
            <div class="entregavel-image">
              <img src="assets/entregaveis mediagrwoth/Copywriting Estrat√©gico.png" alt="Copywriting Estrat√©gico">
              <div class="entregavel-image-placeholder" style="display:none">‚úçÔ∏è</div>
            </div>
            <div class="entregavel-info">
              <h4 class="entregavel-name">Copywriting Estrat√©gico</h4>
              <p class="entregavel-desc">‚≠êÔ∏è Cria√ß√£o de copy/script para an√∫ncios</p>
              <p class="entregavel-desc">‚≠êÔ∏è Cria√ß√£o de copy/script para site</p>
              <p class="entregavel-desc">‚≠êÔ∏è Cria√ß√£o de copy/script para mensagens comerciais</p>
              <p class="entregavel-desc">‚≠êÔ∏è Desenvolvimento de scripts de venda</p>
              <span class="entregavel-value">Valor: R$ 600</span>
              <div class="entregavel-buttons-row">
                
                <button class="entregavel-analise-btn" onclick="abrirAnaliseEntregavel('copywriting')">üìä An√°lise</button>
                <button class="entregavel-gerar-btn" onclick="gerarAnaliseRapida('copywriting', this)">‚ú® Gerar</button>
              </div>
            </div>
          </div>

          <!-- 11. Produ√ß√£o de Conte√∫do Guiada -->
          <div class="entregavel-card" data-entregavel="producao_conteudo">
            <div class="entregavel-image">
              <img src="assets/entregaveis mediagrwoth/Produ√ß√£o de Conte√∫do Guiada.png" alt="Produ√ß√£o de Conte√∫do Guiada">
              <div class="entregavel-image-placeholder" style="display:none">üé¨</div>
            </div>
            <div class="entregavel-info">
              <h4 class="entregavel-name">Produ√ß√£o de Conte√∫do Guiada</h4>
              <p class="entregavel-desc">‚≠êÔ∏è Cria√ß√£o de roteiros de v√≠deo</p>
              <p class="entregavel-desc">‚≠êÔ∏è Dire√ß√£o estrat√©gica de grava√ß√£o</p>
              <p class="entregavel-desc">‚≠êÔ∏è Planejamento de conte√∫dos institucionais, meio e fundo de funil</p>
              <span class="entregavel-value">Valor: R$ 1.000</span>
              <div class="entregavel-buttons-row">
                
                <button class="entregavel-analise-btn" onclick="abrirAnaliseEntregavel('producao_conteudo')">üìä An√°lise</button>
                <button class="entregavel-gerar-btn" onclick="gerarAnaliseRapida('producao_conteudo', this)">‚ú® Gerar</button>
              </div>
            </div>
          </div>

          <!-- 12. Criativos para An√∫ncios Patrocinados -->
          <div class="entregavel-card" data-entregavel="criativos_anuncios">
            <div class="entregavel-image">
              <img src="assets/entregaveis mediagrwoth/Criativos para  an√∫ncios patrocinados.png" alt="Criativos para An√∫ncios Patrocinados">
              <div class="entregavel-image-placeholder" style="display:none">üé®</div>
            </div>
            <div class="entregavel-info">
              <h4 class="entregavel-name">Criativos para An√∫ncios</h4>
              <p class="entregavel-desc">‚≠êÔ∏è Cria√ß√£o de criativo institucional</p>
              <p class="entregavel-desc">‚≠êÔ∏è Cria√ß√£o de criativo de meio de funil</p>
              <p class="entregavel-desc">‚≠êÔ∏è Cria√ß√£o de criativo de fundo de funil</p>
              <p class="entregavel-desc">‚≠êÔ∏è Varia√ß√µes para testes de performance</p>
              <span class="entregavel-value">Valor: R$ 700</span>
              <div class="entregavel-buttons-row">
                
                <button class="entregavel-analise-btn" onclick="abrirAnaliseEntregavel('criativos_anuncios')">üìä An√°lise</button>
                <button class="entregavel-gerar-btn" onclick="gerarAnaliseRapida('criativos_anuncios', this)">‚ú® Gerar</button>
              </div>
            </div>
          </div>

          <!-- 13. CRM e Automa√ß√µes -->
          <div class="entregavel-card" data-entregavel="crm_automacoes">
            <div class="entregavel-image">
              <img src="assets/entregaveis mediagrwoth/acesso CRM e Automa√ß√µes.png" alt="CRM e Automa√ß√µes">
              <div class="entregavel-image-placeholder" style="display:none">‚öôÔ∏è</div>
            </div>
            <div class="entregavel-info">
              <h4 class="entregavel-name">CRM e Automa√ß√µes</h4>
              <p class="entregavel-desc">‚≠êÔ∏è Configura√ß√£o do CRM</p>
              <p class="entregavel-desc">‚≠êÔ∏è Estrutura√ß√£o do funil de vendas</p>
              <p class="entregavel-desc">‚≠êÔ∏è Implementa√ß√£o de automa√ß√µes de mensagens</p>
              <p class="entregavel-desc">‚≠êÔ∏è Configura√ß√£o de follow-ups e nutri√ß√£o</p>
              <p class="entregavel-desc">‚≠êÔ∏è Disponibilidade de 1 ano de uso CRM mediagrowth</p>
              <span class="entregavel-value">Valor: R$ 950</span>
              <div class="entregavel-buttons-row">
                
                <button class="entregavel-analise-btn" onclick="abrirAnaliseEntregavel('crm_automacoes')">üìä An√°lise</button>
                <button class="entregavel-gerar-btn" onclick="gerarAnaliseRapida('crm_automacoes', this)">‚ú® Gerar</button>
              </div>
            </div>
          </div>

          <!-- 14. Estrutura√ß√£o do Processo Comercial -->
          <div class="entregavel-card" data-entregavel="processo_comercial">
            <div class="entregavel-image">
              <img src="assets/entregaveis mediagrwoth/Estrutura√ß√£o do Processo Comercial.png" alt="Estrutura√ß√£o do Processo Comercial">
              <div class="entregavel-image-placeholder" style="display:none">üíº</div>
            </div>
            <div class="entregavel-info">
              <h4 class="entregavel-name">Estrutura√ß√£o do Processo Comercial</h4>
              <p class="entregavel-desc">‚≠êÔ∏è Mapeamento do processo de vendas</p>
              <p class="entregavel-desc">‚≠êÔ∏è Identifica√ß√£o de pontos de perda</p>
              <p class="entregavel-desc">‚≠êÔ∏è An√°lise do ciclo de vendas</p>
              <p class="entregavel-desc">‚≠êÔ∏è Estrutura√ß√£o de obje√ß√µes comerciais</p>
              <span class="entregavel-value">Valor: R$ 1.000</span>
              <div class="entregavel-buttons-row">
                
                <button class="entregavel-analise-btn" onclick="abrirAnaliseEntregavel('processo_comercial')">üìä An√°lise</button>
                <button class="entregavel-gerar-btn" onclick="gerarAnaliseRapida('processo_comercial', this)">‚ú® Gerar</button>
              </div>
            </div>
          </div>

          <!-- 15. Landing Pages Estrat√©gicas -->
          <div class="entregavel-card" data-entregavel="landing_pages">
            <div class="entregavel-image">
              <img src="assets/entregaveis mediagrwoth/Landing pages estrat√©gicas.png" alt="Landing Pages Estrat√©gicas">
              <div class="entregavel-image-placeholder" style="display:none">üöÄ</div>
            </div>
            <div class="entregavel-info">
              <h4 class="entregavel-name">Landing Pages Estrat√©gicas</h4>
              <p class="entregavel-desc">‚≠êÔ∏è Cria√ß√£o de at√© 3 landing pages</p>
              <p class="entregavel-desc">‚≠êÔ∏è Estrutura focada em convers√£o</p>
              <p class="entregavel-desc">‚≠êÔ∏è Copy alinhada √† estrat√©gia definida</p>
              <span class="entregavel-value">Valor: R$ 1.750</span>
              <div class="entregavel-buttons-row">
                
                <button class="entregavel-analise-btn" onclick="abrirAnaliseEntregavel('landing_pages')">üìä An√°lise</button>
                <button class="entregavel-gerar-btn" onclick="gerarAnaliseRapida('landing_pages', this)">‚ú® Gerar</button>
              </div>
            </div>
          </div>

          <!-- 16. Constru√ß√£o ou Atualiza√ß√£o de Website -->
          <div class="entregavel-card" data-entregavel="website">
            <div class="entregavel-image">
              <img src="assets/entregaveis mediagrwoth/Constru√ß√£o ou atualiza√ß√£o de website.png" alt="Constru√ß√£o ou Atualiza√ß√£o de Website">
              <div class="entregavel-image-placeholder" style="display:none">üñ•Ô∏è</div>
            </div>
            <div class="entregavel-info">
              <h4 class="entregavel-name">Constru√ß√£o ou Atualiza√ß√£o de Website</h4>
              <p class="entregavel-desc">‚≠êÔ∏è Constru√ß√£o ou atualiza√ß√£o do site institucional</p>
              <p class="entregavel-desc">‚≠êÔ∏è Estrutura alinhada √† estrat√©gia</p>
              <p class="entregavel-desc">‚≠êÔ∏è Design funcional e responsivo</p>
              <p class="entregavel-desc">‚≠êÔ∏è Prepara√ß√£o para tr√°fego e SEO</p>
              <span class="entregavel-value">Valor: R$ 2.000</span>
              <div class="entregavel-buttons-row">
                
                <button class="entregavel-analise-btn" onclick="abrirAnaliseEntregavel('website')">üìä An√°lise</button>
                <button class="entregavel-gerar-btn" onclick="gerarAnaliseRapida('website', this)">‚ú® Gerar</button>
              </div>
            </div>
          </div>

          <!-- 17. Padroniza√ß√£o Visual e de Comunica√ß√£o -->
          <div class="entregavel-card" data-entregavel="padronizacao_visual">
            <div class="entregavel-image">
              <img src="assets/entregaveis mediagrwoth/Padroniza√ß√£o visual  e de comunica√ß√£o.png" alt="Padroniza√ß√£o Visual e de Comunica√ß√£o">
              <div class="entregavel-image-placeholder" style="display:none">‚ú®</div>
            </div>
            <div class="entregavel-info">
              <h4 class="entregavel-name">Padroniza√ß√£o Visual e de Comunica√ß√£o</h4>
              <p class="entregavel-desc">‚≠êÔ∏è Padroniza√ß√£o visual da marca</p>
              <p class="entregavel-desc">‚≠êÔ∏è Padroniza√ß√£o de linguagem e tom de voz</p>
              <p class="entregavel-desc">‚≠êÔ∏è Alinhamento de comunica√ß√£o em todos os canais</p>
              <span class="entregavel-value">Valor: R$ 1.250</span>
              <div class="entregavel-buttons-row">
                
                <button class="entregavel-analise-btn" onclick="abrirAnaliseEntregavel('padronizacao_visual')">üìä An√°lise</button>
                <button class="entregavel-gerar-btn" onclick="gerarAnaliseRapida('padronizacao_visual', this)">‚ú® Gerar</button>
              </div>
            </div>
          </div>

          <!-- 18. Plataforma Mediagrowth -->
          <div class="entregavel-card" data-entregavel="plataforma_mediagrowth">
            <div class="entregavel-image">
              <img src="assets/entregaveis mediagrwoth/_plataforma mediagrowth.png" alt="Plataforma Mediagrowth">
              <div class="entregavel-image-placeholder" style="display:none">üöÄ</div>
            </div>
            <div class="entregavel-info">
              <h4 class="entregavel-name">Plataforma Mediagrowth</h4>
              <p class="entregavel-desc">‚≠êÔ∏è Vis√£o macro vendas e marketing</p>
              <p class="entregavel-desc">‚≠êÔ∏è Acesso planejamento</p>
              <p class="entregavel-desc">‚≠êÔ∏è IA treinada com dados da empresa</p>
              <p class="entregavel-desc">‚≠êÔ∏è Calend√°rio de conte√∫do/planejamento</p>
              <p class="entregavel-desc">‚≠êÔ∏è Gest√£o de metas</p>
              <p class="entregavel-desc">‚≠êÔ∏è Gest√£o de leads</p>
              <p class="entregavel-desc">‚≠êÔ∏è Gest√£o de refer√™ncias</p>
              <p class="entregavel-desc">‚≠êÔ∏è Bloco de notas estrat√©gico</p>
              <p class="entregavel-desc">‚≠êÔ∏è Gest√£o de senhas e acessos</p>
              <p class="entregavel-desc">‚≠êÔ∏è Gest√£o de arquivos</p>
              <span class="entregavel-value">Valor: R$ 197</span>
              <div class="entregavel-buttons-row">
                
                <button class="entregavel-analise-btn" onclick="abrirAnaliseEntregavel('plataforma_mediagrowth')">üìä An√°lise</button>
                <button class="entregavel-gerar-btn" onclick="gerarAnaliseRapida('plataforma_mediagrowth', this)">‚ú® Gerar</button>
              </div>
            </div>
          </div>

        </div>

        <!-- Se√ß√£o de Valor -->
        <div class="entregaveis-valor-section">
          <div class="entregaveis-country-toggle">
            <button class="entregaveis-country-btn active" data-country="BR" id="entregaveisBtnBR">üáßüá∑ Brasil</button>
            <button class="entregaveis-country-btn" data-country="US" id="entregaveisBtnUS">üá∫üá∏ USA</button>
          </div>

          <div class="entregaveis-valor-comparativo">
            <div class="entregaveis-valor-item">
              <span class="entregaveis-valor-label">Investimento necess√°rio</span>
              <span class="entregaveis-valor-original" id="entregaveisValorOriginal">R$ 17.672</span>
            </div>
            <span class="entregaveis-valor-divider">‚Üí</span>
            <div class="entregaveis-valor-item entregaveis-valor-final">
              <span class="entregaveis-valor-label">Seu investimento</span>
              <span class="entregaveis-valor-main" id="entregaveisValorFinal">R$ 5.000</span>
              <span class="entregaveis-valor-parcelado" id="entregaveisValorParcelado">ou 5x de R$ 1.000,00</span>
            </div>
          </div>

          <span class="entregaveis-valor-urgencia">üî• V√°lida somente hoje</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Script para toggle de pa√≠s nos entreg√°veis (deve estar fora do module) -->
<script>
function toggleEntregaveisCountry(country){
  const valorOriginal = document.getElementById('entregaveisValorOriginal');
  const valorFinal = document.getElementById('entregaveisValorFinal');
  const valorParcelado = document.getElementById('entregaveisValorParcelado');
  const btns = document.querySelectorAll('.entregaveis-country-btn');
  
  btns.forEach(btn => {
    btn.classList.toggle('active', btn.dataset.country === country);
  });
  
  const cards = document.querySelectorAll('.entregavel-value');
  
  if(country === 'US'){
    if(valorOriginal) valorOriginal.textContent = '$ 3,495';
    if(valorFinal) valorFinal.textContent = '$ 1,000';
    if(valorParcelado) valorParcelado.textContent = 'or 5x of $ 200.00';
    
    const valoresUSD = [
      '$ 200', '$ 200', '$ 200', '$ 150', '$ 150', '$ 200',
      '$ 140', '$ 300', '$ 105', '$ 120', '$ 200', '$ 140',
      '$ 190', '$ 200', '$ 350', '$ 400', '$ 250', '$ 40'
    ];
    cards.forEach((card, idx) => {
      if(valoresUSD[idx]) card.textContent = 'Value: ' + valoresUSD[idx];
    });
  } else {
    if(valorOriginal) valorOriginal.textContent = 'R$ 17.672';
    if(valorFinal) valorFinal.textContent = 'R$ 5.000';
    if(valorParcelado) valorParcelado.textContent = 'ou 5x de R$ 1.000,00';
    
    const valoresBRL = [
      'R$ 1.000', 'R$ 1.000', 'R$ 1.000', 'R$ 750', 'R$ 750', 'R$ 1.000',
      'R$ 700', 'R$ 1.500', 'R$ 525', 'R$ 600', 'R$ 1.000', 'R$ 700',
      'R$ 950', 'R$ 1.000', 'R$ 1.750', 'R$ 2.000', 'R$ 1.250', 'R$ 197'
    ];
    cards.forEach((card, idx) => {
      if(valoresBRL[idx]) card.textContent = 'Valor: ' + valoresBRL[idx];
    });
  }
}

// Adicionar event listeners quando o DOM estiver pronto
document.addEventListener('DOMContentLoaded', function(){
  const btnBR = document.getElementById('entregaveisBtnBR');
  const btnUS = document.getElementById('entregaveisBtnUS');
  
  if(btnBR){
    btnBR.addEventListener('click', function(e){
      e.preventDefault();
      e.stopPropagation();
      toggleEntregaveisCountry('BR');
    });
  }
  
  if(btnUS){
    btnUS.addEventListener('click', function(e){
      e.preventDefault();
      e.stopPropagation();
      toggleEntregaveisCountry('US');
    });
  }
});
</script>

<!-- ACESSOS -->
<div aria-hidden="true" class="access-wrap" id="accessWrap" style="display:none">
  <div class="access-header">
    <div class="access-toolbar">
      <div class="access-search">
        <input id="accessSearch" placeholder="Buscar por nome, URL, usu√°rio ou tag..." type="text"/>
      </div>
      <div class="access-actions">
        <button class="btn small ghost" id="accessExport">Exportar CSV</button>
        <button class="btn small" id="accessAdd">+ Novo acesso</button>
      </div>
    </div>
    <div class="help-note">Clique em <b>üëÅ</b> para mostrar/ocultar senha ‚Ä¢ <span class="warn">Evite guardar senhas cr√≠ticas.</span></div>
  </div>
<div class="form-inline" id="accessForm" style="display:none">
<input id="fName" placeholder="Nome (ex: Instagram)"/>
<input id="fUrl" placeholder="URL (https://...)"/>
<input id="fUser" placeholder="Usu√°rio / E-mail"/>
<input id="fPass" placeholder="Senha"/>
<input id="fTags" placeholder="Tags (separe por v√≠rgula)"/>
<div class="actions">
<button class="btn small" id="fSave">Salvar</button>
<button class="btn small secondary" id="fCancel">Cancelar</button>
</div>
</div>
<div id="accessList"></div>
<div class="help-note">Voc√™ pode <b>editar</b>, <b>copiar</b> usu√°rio/senha, <b>abrir</b> o link e <b>filtrar</b> por tags.</div>
</div>
<!-- CALEND√ÅRIO / POSTS -->
<div aria-hidden="true" class="calendar-wrap" id="calendarWrap" style="display:none">
<div class="cal-toolbar">
<strong>Cadastro de Post</strong>
<input id="calDate" title="Data do post" type="date"/>
<input id="calDesc" placeholder="Descri√ß√£o do post (legenda/observa√ß√µes)" style="min-width:260px" type="text"/>
<input accept="image/*,video/*" id="calFiles" multiple="" type="file"/>
<select id="calTarget">
  <option value="feed">Feed</option>
  <option value="stories">Stories</option>
</select>
<button class="btn small" id="calUpload" type="button">Enviar</button>
<button class="btn small secondary" id="btnShareCalendar" type="button">Compartilhar calend√°rio</button>
<input id="calendarWebhook" placeholder="Webhook URL" type="url" style="min-width:220px"/>
<div class="cal-google-sync" id="googleCalendarSync">
  <button class="btn small secondary" id="googleCalendarConnect" type="button">Conectar Google Calendar</button>
  <button class="btn small ghost" id="googleCalendarDisconnect" style="display:none" type="button">Desconectar</button>
  <span class="status muted" id="googleCalendarStatus">N√£o conectado.</span>
</div>
<span class="muted">Dica: voc√™ pode selecionar v√°rias imagens/v√≠deos para um carrossel.</span>
</div>
<div style="display:flex; justify-content:space-between; align-items:center; gap:10px">
<div class="cal-legend">
<span><span class="cal-badge b-pendente"></span>Pendente</span>
<span><span class="cal-badge b-aprovado"></span>Aprovado (cliente)</span>
<span><span class="cal-badge b-aprovado-interno"></span>Aprovado (time interno)</span>
<span><span class="cal-badge b-revisar"></span>Revisar</span>
</div>
<div class="cal-filters">
<label>Status:
            <select id="calFilterStatus">
<option value="">Todos</option>
<option value="pendente">Pendente</option>
<option value="aprovado">Aprovado</option>
<option value="revisar">Revisar</option>
</select>
</label>
<label>Pa√≠s:
  <select id="calFilterCountry">
    <option value="">Todos</option>
    <option value="BR">Brasil</option>
    <option value="US">Estados Unidos</option>
    <option value="notes">Anota√ß√µes</option>
  </select>
</label>
<label>Busca:
  <input id="calFilterText" type="text" placeholder="Filtrar feriados"/>
</label>
</div>
</div>
<div class="calendar">
<div class="cal-head">
<div class="nav"><button id="calPrev">&lt;</button></div>
<div class="cal-title" id="calTitle">M√™s Ano</div>
<div class="nav"><button id="calNext">&gt;</button></div>
</div>
<div class="cal-grid" id="calWeekdays"></div>
<div class="cal-grid" id="calDays"></div>
</div>
<div class="insta-preview">
  <div class="insta-phone">
    <div class="insta-stories-wrapper">
      <button class="stories-arrow left" id="storiesPrev">&#8249;</button>
      <div class="insta-stories" id="storiesGrid"></div>
      <button class="stories-arrow right" id="storiesNext">&#8250;</button>
    </div>
    <div class="insta-feed" id="feedGrid"></div>
  </div>
</div>
<div aria-live="polite" class="calendar-demandas-mobile" id="calendarDemandasMobile"></div>
<!-- Hist√≥rico de observa√ß√µes do cliente (fora do pop-up) -->
<div class="notes-block" id="clientNotesPanelWrap" style="margin-top:10px">
<label class="muted" style="display:block; margin:6px 0">Hist√≥rico do cliente (observa√ß√µes)</label>
<div class="notes-list" id="clientNotesPanel"><div class="muted">Abra um post para ver o hist√≥rico.</div></div>
</div>
</div>
<!-- Modal de Post -->
<div aria-hidden="true" class="modal" id="postModal">
<div aria-modal="true" class="modal-card" role="dialog">
<div class="modal-head">
<strong id="modalTitle">Post</strong>
<button class="btn small secondary" id="modalClose">Fechar</button>
</div>
<div class="modal-body">
<div class="preview" id="modalPreview"></div>
<div aria-live="polite" id="clientNotesList"></div>
<div class="info">
<div style="display:flex; gap:8px; align-items:center; margin-bottom:8px">
<span class="muted">Data:</span> <span id="modalDate" style="font-weight:800"></span>
<span class="muted" style="margin-left:10px">Status:</span> <span class="status-pill status-pendente" id="modalStatus">pendente</span>
<span class="muted" style="margin-left:10px">Destino:</span>
<select id="modalTarget">
  <option value="feed">Feed</option>
  <option value="stories">Stories</option>
</select>
</div>
<label class="muted" style="display:block; margin:6px 0">Descri√ß√£o</label>
<textarea id="modalDesc"></textarea>
<div class="notes-block">
<label class="muted" style="display:block; margin:6px 0">Observa√ß√µes do cliente</label>
<div class="notes-list" id="notesList"></div>
</div>
</div>
<!-- Checklist de publica√ß√£o (vis√≠vel apenas no desktop) -->
<div id="postChecklistBlock" class="post-checklist">
  <label class="muted" style="display:block; margin:6px 0">Checklist de publica√ß√£o</label>
  <div class="post-checklist-grid">
    <label><input type="checkbox" data-platform="instagram"> Instagram</label>
    <label><input type="checkbox" data-platform="facebook"> Facebook</label>
    <label><input type="checkbox" data-platform="tiktok"> TikTok</label>
    <label><input type="checkbox" data-platform="linkedin"> LinkedIn</label>
    <label><input type="checkbox" data-platform="youtube"> YouTube</label>
    <label><input type="checkbox" data-platform="gmb"> Google Meu Neg√≥cio</label>
  </div>
  <p class="muted" style="margin-top:8px">Marque as plataformas onde este post ser√° publicado.</p>
</div>
</div>
<div class="modal-foot">
<button class="btn small" id="btnReview">Pedir revis√£o</button>
<button class="btn small" id="btnApprove">Aprova√ß√£o do cliente</button>
<button class="btn small" id="btnApproveInternal">Aprova√ß√£o interna</button>
<button class="btn small secondary" id="btnCopyApprovalLink">Copiar link de aprova√ß√£o</button>
<button class="btn small secondary" id="btnSave" title="Salvar altera√ß√µes de descri√ß√£o">Salvar</button>
<button class="btn small secondary" id="btnDelete" title="Excluir post">Excluir</button>
</div>
</div>
</div>

<!-- Modal para adicionar ao planejamento -->
<div class="ia-planning-modal" id="iaPlanningModal">
  <div class="ia-planning-modal-content">
    <div class="ia-planning-modal-header">
      <h3>‚ú® Adicionar ao Planejamento</h3>
      <button class="ia-planning-modal-close" id="iaPlanningModalClose">Fechar</button>
    </div>
    <div class="ia-planning-modal-body">
      <div class="ia-planning-form-group">
        <label for="iaPlanningText">Conte√∫do da demanda / Objetivo</label>
        <textarea id="iaPlanningText" placeholder="Selecione qualquer parte do texto gerado pela IA ou digite aqui..."></textarea>
        <p class="ia-planning-form-help">Voc√™ pode editar o texto antes de adicionar ao planejamento</p>
      </div>
      <div class="ia-planning-form-group">
        <label for="iaPlanningStatus">Status</label>
        <select id="iaPlanningStatus">
          <option value="">Selecione um status</option>
        </select>
      </div>
      <div class="ia-planning-form-group">
        <label for="iaPlanningResponsavel">Respons√°vel</label>
        <select id="iaPlanningResponsavel">
          <option value="">Selecione um respons√°vel</option>
        </select>
      </div>
      <div class="ia-planning-form-group">
        <label>Per√≠odo</label>
        <div class="ia-planning-periodo-field" id="iaPlanningPeriodoField">
          <input type="datetime-local" class="ia-planning-periodo-inicio" id="iaPlanningPrazoInicio" placeholder="Data de in√≠cio">
          <span class="ia-planning-periodo-sep">at√©</span>
          <input type="datetime-local" class="ia-planning-periodo-fim" id="iaPlanningPrazoFim" placeholder="Data de fim">
          <button type="button" class="ia-planning-periodo-toggle" id="iaPlanningPeriodoToggle">Adicionar intervalo</button>
        </div>
        <p class="ia-planning-form-help">Defina a data de in√≠cio e opcionalmente um per√≠odo com data de t√©rmino</p>
      </div>
    </div>
    <div class="ia-planning-modal-footer">
      <div class="ia-planning-add-more">
        <input type="checkbox" id="iaPlanningAddMore" />
        <label for="iaPlanningAddMore">Adicionar outra demanda ap√≥s salvar</label>
      </div>
      <button class="btn small secondary" id="iaPlanningCancel">Cancelar</button>
      <button class="btn small" id="iaPlanningSubmit">Adicionar ao Planejamento</button>
    </div>
  </div>
</div>

<!-- Modal para selecionar m√™s/ano para adicionar todas as linhas -->
<div class="ia-month-picker-modal" id="iaMonthPickerModal">
  <div class="ia-month-picker-content">
    <div class="ia-month-picker-header">
      <h3>üìÖ Selecione o M√™s e Ano</h3>
      <button class="ia-month-picker-close" id="iaMonthPickerClose">‚úï</button>
    </div>
    <div class="ia-month-picker-body">
      <p class="ia-month-picker-info">
        <span id="iaMonthPickerCount">0</span> linhas ser√£o adicionadas ao planejamento
      </p>
      
      <div class="ia-month-picker-selectors">
        <div class="ia-year-selector">
          <label>Ano</label>
          <div class="ia-year-buttons">
            <button type="button" class="ia-year-btn" data-offset="-1">‚óÄ</button>
            <span class="ia-year-display" id="iaYearDisplay">2025</span>
            <button type="button" class="ia-year-btn" data-offset="1">‚ñ∂</button>
          </div>
        </div>

        <div class="ia-month-grid">
          <button type="button" class="ia-month-btn" data-month="0">Janeiro</button>
          <button type="button" class="ia-month-btn" data-month="1">Fevereiro</button>
          <button type="button" class="ia-month-btn" data-month="2">Mar√ßo</button>
          <button type="button" class="ia-month-btn" data-month="3">Abril</button>
          <button type="button" class="ia-month-btn" data-month="4">Maio</button>
          <button type="button" class="ia-month-btn" data-month="5">Junho</button>
          <button type="button" class="ia-month-btn" data-month="6">Julho</button>
          <button type="button" class="ia-month-btn" data-month="7">Agosto</button>
          <button type="button" class="ia-month-btn" data-month="8">Setembro</button>
          <button type="button" class="ia-month-btn" data-month="9">Outubro</button>
          <button type="button" class="ia-month-btn" data-month="10">Novembro</button>
          <button type="button" class="ia-month-btn" data-month="11">Dezembro</button>
        </div>
      </div>
    </div>
    <div class="ia-month-picker-footer">
      <button class="btn small secondary" id="iaMonthPickerCancel">Cancelar</button>
      <button class="btn small" id="iaMonthPickerConfirm" disabled>Confirmar</button>
    </div>
  </div>
</div>

<!-- Modal para mapear n√∫meros √†s metas -->
<div class="ia-metas-mapper-modal" id="iaMetasMapperModal">
  <div class="ia-metas-mapper-content">
    <div class="ia-metas-mapper-header">
      <h3>üìà Adicionar N√∫meros √†s Metas</h3>
      <button class="ia-metas-mapper-close" id="iaMetasMapperClose">‚úï</button>
    </div>
    <div class="ia-metas-mapper-body" id="iaMetasMapperBody">
      <!-- N√∫meros mapeados ser√£o inseridos aqui -->
    </div>
    <div class="ia-metas-mapper-footer">
      <div class="ia-metas-mapper-bulk-actions">
        <button class="btn small secondary" id="iaMetasMapperSelectAll">‚úì Selecionar Todos</button>
        <button class="btn small secondary" id="iaMetasMapperApplyToSelected" style="background:rgba(16,185,129,.12);border-color:rgba(16,185,129,.3);color:#10b981">Aplicar aos Selecionados</button>
      </div>
      <div style="display:flex;gap:10px;">
        <button class="btn small secondary" id="iaMetasMapperCancel">Cancelar</button>
        <button class="btn small" id="iaMetasMapperConfirm">Adicionar √†s Metas</button>
      </div>
    </div>
  </div>
</div>

<p class="muted" id="iframedica" style="display:none">Dica: d√™ <b>duplo clique</b> em um painel para editar t√≠tulo e link.</p>
</div>
<!-- BRIEFING DO CLIENTE -->
<div aria-hidden="true" class="notes-wrap" id="briefWrap" style="display:none">
<!-- Toolbar for webhook & save -->
<div class="brief-toolbar" style="gap:10px; align-items:flex-start">
<div class="brief-toolbar-main">
<strong>Briefing do Cliente</strong>
<button class="btn small" id="briefSave">Salvar</button>
<div class="brief-webhook-area brief-webhook-controls">
<button class="btn small secondary" id="briefImportJson" title="Colar JSON de um formul√°rio">Importar JSON</button>
<input id="briefWebhookUrl" placeholder="Webhook URL (POST)" style="min-width:280px" type="text"/>
<button class="btn small" id="briefSendWebhook">Enviar Webhook</button>
</div>
</div>
<div class="muted brief-webhook-area">As respostas abaixo s√£o edit√°veis. Voc√™ pode importar dados (JSON) de um Google Forms/Make/Zapier e tamb√©m enviar via webhook.</div>
</div>
<!-- Bloco de notas -->
<label class="muted" style="margin:6px 2px; display:block">Bloco de notas (texto livre)</label>
<div class="brief-note-actions" style="display:flex; justify-content:flex-end; margin:4px 2px 8px; gap:8px">
  <button class="btn small secondary" id="briefCopy" type="button">Copiar briefing</button>
  <button class="btn small" id="briefGenerateAI" type="button">Gerar Briefing com I.A</button>
</div>
<textarea class="input" id="briefText" style="min-height:220px; resize:vertical"></textarea>
<!-- Respostas estruturadas (webhook-ready) -->
<div class="brief-toolbar" style="margin-top:10px">
<strong>Respostas do Briefing (edit√°veis + webhook-ready)</strong>
</div>
<div id="briefForm" style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
<!-- EMPRESA -->
<div><label>1. Nome da empresa*<br/><input class="input" id="q1" placeholder="" type="text"/></label></div>
<div><label>2. Cidade e estado*<br/><input class="input" id="q2" placeholder="" type="text"/></label></div>
<div><label>3. Cidades principais de atua√ß√£o*<br/><input class="input" id="q3" placeholder="" type="text"/></label></div>
<div style="grid-column:1 / -1"><label>4. Descri√ß√£o detalhada (1 frase)<br/><textarea class="input" id="q4" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>5. Servi√ßos/produtos*<br/><textarea class="input" id="q5" style="min-height:90px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>6. Como entregam (ex: loja f√≠sica, or√ßamento gratuito, etc.)<br/><input class="input" id="q6" type="text"/></label></div>
<div><label>7. Slogan/frase de efeito*<br/><input class="input" id="q7" type="text"/></label></div>
<div><label>8. Dias e hor√°rios de funcionamento<br/><input class="input" id="q8" placeholder="Seg a Sex 9h‚Äì18h, S√°b 9h‚Äì13h" type="text"/></label></div>
<!-- DIFERENCIAIS -->
<div style="grid-column:1 / -1"><label>9. Diferenciais (3 itens)<br/><textarea class="input" id="q9" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>10. Tecnologia/atendimento/experi√™ncia superior<br/><textarea class="input" id="q10" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>11. 3 empresas refer√™ncia/inspira√ß√£o<br/><input class="input" id="q11" placeholder="Marca A, Marca B, Marca C" type="text"/></label></div>
<!-- P√öBLICO-ALVO -->
<div style="grid-column:1 / -1"><label>12. Cliente ideal (idade, profiss√£o, regi√£o...)<br/><textarea class="input" id="q12" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>13. Dores/problemas antes de contratar<br/><textarea class="input" id="q13" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>14. Desejos/resultados esperados<br/><textarea class="input" id="q14" style="min-height:70px"></textarea></label></div>
<div><label>15. Tom de abordagem preferido<br/><input class="input" id="q15" placeholder="formal, direto, descontra√≠do..." type="text"/></label></div>
<!-- M√âTRICAS -->
<div><label>16. Ticket m√©dio*<br/><input class="input" id="q16" type="text"/></label></div>
<div><label>17. Taxa de convers√£o (or√ßamento‚Üívenda)<br/><input class="input" id="q17" placeholder="Ex: 3/10" type="text"/></label></div>
<div><label>18. Faturamento m√©dio mensal<br/><input class="input" id="q18" type="text"/></label></div>
<div><label>19. Meta de crescimento (6 meses)<br/><input class="input" id="q19" type="text"/></label></div>
<div><label>20. Promo√ß√µes atuais<br/><input class="input" id="q20" type="text"/></label></div>
<div><label>21. Pacotes/planos/condi√ß√µes especiais<br/><input class="input" id="q21" type="text"/></label></div>
<div><label>22. Sazonalidade (vende mais quando?)<br/><input class="input" id="q22" type="text"/></label></div>
<div><label>23. Per√≠odos fracos<br/><input class="input" id="q23" type="text"/></label></div>
<!-- REDES SOCIAIS -->
<div style="grid-column:1 / -1"><label>24. O que mais chama aten√ß√£o nas redes<br/><textarea class="input" id="q24" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>25. Conte√∫do que deseja publicar<br/><textarea class="input" id="q25" style="min-height:70px"></textarea></label></div>
<!-- MATRIZ CDT -->
<div style="grid-column:1 / -1"><label>26. Caracter√≠sticas (3 a 5)<br/><textarea class="input" id="q26" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>27. Dores/frustra√ß√µes antes de contratar<br/><textarea class="input" id="q27" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>28. Transforma√ß√£o ap√≥s contratar<br/><textarea class="input" id="q28" style="min-height:70px"></textarea></label></div>
<!-- PUV -->
<div style="grid-column:1 / -1"><label>29. Se sumisse do mercado, o que fariam falta?<br/><textarea class="input" id="q29" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>30. O que promete e cumpre como ningu√©m<br/><textarea class="input" id="q30" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>31. Como quer ser lembrado<br/><textarea class="input" id="q31" style="min-height:70px"></textarea></label></div>
<!-- VIS√ÉO -->
<div><label>32. Onde quer estar em 1 ano<br/><input class="input" id="q32" type="text"/></label></div>
<div><label>33. Principais desafios<br/><input class="input" id="q33" type="text"/></label></div>
<!-- Observa√ß√µes -->
<div style="grid-column:1 / -1"><label>34. Observa√ß√µes gerais<br/><textarea class="input" id="q34" style="min-height:70px"></textarea></label></div>
<!-- NOVAS PERGUNTAS DO BRIEFING -->
<div style="grid-column:1 / -1"><label>35. Sobre o cliente e o neg√≥cio ‚Äì PlayBook<br/><input class="input" id="q35" placeholder="Link ou observa√ß√µes sobre o playbook" type="text"/></label></div>
<div style="grid-column:1 / -1"><label>36. Miss√£o e valores da empresa<br/><textarea class="input" id="q36" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>37. Produtos/servi√ßos e Core Business<br/><textarea class="input" id="q37" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>38. P√∫blico-alvo ideal (ICP/Persona)<br/><textarea class="input" id="q38" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>39. Diferenciais da marca<br/><textarea class="input" id="q39" style="min-height:70px"></textarea></label></div>
<!-- OBJETIVOS DO PROJETO -->
<div style="grid-column:1 / -1"><label>40. J√° existe um planejamento da atua√ß√£o?<br/><textarea class="input" id="q40" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>41. Principal objetivo com este trabalho<br/><textarea class="input" id="q41" style="min-height:70px" placeholder="Ex: atrair leads, vender mais, posicionar a marca"></textarea></label></div>
<div style="grid-column:1 / -1"><label>42. Metas espec√≠ficas a alcan√ßar<br/><textarea class="input" id="q42" style="min-height:70px"></textarea></label></div>
<div><label>43. Prazo ideal para ver resultados<br/><input class="input" id="q43" type="text"/></label></div>
<!-- IDENTIDADE E COMUNICA√á√ÉO -->
<div><label>44. Manual da marca dispon√≠vel?<br/><input class="input" id="q44" placeholder="Link ou localiza√ß√£o do manual" type="text"/></label></div>
<div style="grid-column:1 / -1"><label>45. Tom de voz ou linguagem espec√≠fica<br/><textarea class="input" id="q45" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>46. Refer√™ncias de marcas ou campanhas<br/><textarea class="input" id="q46" style="min-height:70px"></textarea></label></div>
<!-- CONCORR√äNCIA E MERCADO -->
<div style="grid-column:1 / -1"><label>47. Principais concorrentes<br/><textarea class="input" id="q47" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>48. O que admira ou deseja evitar no mercado<br/><textarea class="input" id="q48" style="min-height:70px"></textarea></label></div>
<!-- PRESEN√áA DIGITAL ATUAL -->
<div style="grid-column:1 / -1"><label>49. Canais em que a marca est√° presente<br/><textarea class="input" id="q49" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>50. Canais que funcionam melhor atualmente<br/><textarea class="input" id="q50" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>51. O que manter ou mudar na presen√ßa digital<br/><textarea class="input" id="q51" style="min-height:70px"></textarea></label></div>
<!-- INVESTIMENTO E RECURSOS -->
<div><label>52. Or√ßamento dispon√≠vel<br/><input class="input" id="q52" type="text"/></label></div>
<div style="grid-column:1 / -1"><label>53. Equipe interna ou parceiros envolvidos<br/><textarea class="input" id="q53" style="min-height:70px"></textarea></label></div>
<!-- ENTREG√ÅVEIS -->
<div><label>54. Frequ√™ncia esperada de entregas/resultados<br/><input class="input" id="q54" type="text"/></label></div>
<div><label>55. Ponto de contato direto<br/><input class="input" id="q55" type="text"/></label></div>
<div style="grid-column:1 / -1"><label>56. Aprova√ß√£o dos materiais<br/><textarea class="input" id="q56" style="min-height:70px" placeholder="Descreva como ser√° o fluxo de aprova√ß√£o"></textarea></label></div>
</div>
<!-- IFRAME -->
<div class="brief-toolbar" style="margin-top:12px; align-items:center; gap:8px">
<strong>Iframe do Briefing</strong>
<input class="input" id="briefIframeUrl" placeholder="Cole o link (https://...)" style="min-width:320px" type="text"/>
<button class="btn small" id="briefApplyIframe">Aplicar</button>
</div>
<div class="frame-shell" id="briefFrameShell" style="height:600px">
<iframe class="widget-iframe" id="briefIframe" loading="lazy" referrerpolicy="no-referrer" sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox" title="Briefing Iframe"></iframe>
</div>
</div>
<!-- RELAT√ìRIO -->
<div aria-hidden="true" class="relatorio-wrap" id="relatorioWrap" style="display:none">
  <div class="relatorio-container">
    <div class="relatorio-header">
      <h2>Relat√≥rio Consolidado</h2>
      <p class="relatorio-subtitle">Visualize e exporte relat√≥rios completos do desempenho do cliente</p>
    </div>
    
    <!-- Hist√≥rico de Relat√≥rios Salvos -->
    <div class="relatorio-history" id="relatorioHistory" style="margin-bottom: 20px;">
      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
        <h3 style="margin: 0; font-size: 1rem; color: #cbd5e1;">üìÇ Relat√≥rios Salvos</h3>
        <button type="button" id="toggleHistoryBtn" class="btn ghost small" style="padding: 4px 10px;">Mostrar/Ocultar</button>
      </div>
      <div class="relatorio-history-tabs" id="relatorioHistoryTabs" style="display: flex; gap: 8px; flex-wrap: wrap; padding: 12px; background: rgba(15, 23, 42, 0.4); border-radius: 12px; border: 1px solid rgba(100, 116, 139, 0.2);">
        <p style="color: #94a3b8; font-size: 0.85rem; margin: 0;">Nenhum relat√≥rio salvo ainda</p>
      </div>
    </div>
    
    <div class="relatorio-filters">
      <div class="relatorio-filter-group">
        <label for="relatorioMes">üìÖ Selecione o M√™s:</label>
        <input type="month" id="relatorioMes" class="input" />
      </div>
      <button type="button" id="relatorioGerar" class="btn">üìä Gerar Relat√≥rio</button>
      <button type="button" id="relatorioExportar" class="btn secondary">‚¨á Exportar PDF</button>
    </div>
    
    <div class="relatorio-preview" id="relatorioPreview">
      <div class="relatorio-empty">
        <p>üìã Selecione um m√™s e clique em "Gerar Relat√≥rio" para visualizar os dados</p>
      </div>
    </div>
  </div>

  <!-- Carrossel de Stories -->
  <div class="relatorio-container" id="relatorioStoriesSection" style="display:none">
    <div class="relatorio-header">
      <h2>üì± Stories Produzidos</h2>
      <p class="relatorio-subtitle" id="relatorioStoriesSubtitle">Stories criados pelo time de marketing</p>
    </div>
    
    <div class="relatorio-stories-carousel">
      <button type="button" class="carousel-nav carousel-prev" id="relatorioStoriesPrev">‚Äπ</button>
      <div class="relatorio-stories-grid" id="relatorioStoriesGrid">
        <div class="relatorio-stories-empty">
          <p>Nenhum story encontrado para este per√≠odo</p>
        </div>
      </div>
      <button type="button" class="carousel-nav carousel-next" id="relatorioStoriesNext">‚Ä∫</button>
    </div>
    <p class="relatorio-desc" id="relatorioStoriesDesc" style="display:none"></p>
  </div>

  <!-- Carrossel de Posts (Feed) -->
  <div class="relatorio-container" id="relatorioPostsSection" style="display:none">
    <div class="relatorio-header">
      <h2>üì∞ Posts Produzidos</h2>
      <p class="relatorio-subtitle" id="relatorioPostsSubtitle">Posts de feed criados pelo time de marketing</p>
    </div>

    <div class="relatorio-stories-carousel">
      <button type="button" class="carousel-nav carousel-prev" id="relatorioPostsPrev">‚Äπ</button>
      <div class="relatorio-stories-grid" id="relatorioPostsGrid">
        <div class="relatorio-stories-empty">
          <p>Nenhum post de feed encontrado para este per√≠odo</p>
        </div>
      </div>
      <button type="button" class="carousel-nav carousel-next" id="relatorioPostsNext">‚Ä∫</button>
    </div>
    <p class="relatorio-desc" id="relatorioPostsDesc" style="display:none"></p>
  </div>

  <!-- Objetivos do m√™s (Planejamento) -->
  <div class="relatorio-container" id="relatorioGoalsSection" style="display:none">
    <div class="relatorio-header">
      <h2>üéØ Objetivos do m√™s</h2>
      <p class="relatorio-subtitle" id="relatorioGoalsSubtitle">Status das demandas do Planejamento no m√™s selecionado</p>
    </div>
    
    <div class="relatorio-goals-summary">
      <div class="goal-pill goal-done" id="relatorioGoalsDonePill">Conclu√≠dos: <strong>-</strong></div>
      <div class="goal-pill goal-progress" id="relatorioGoalsProgressPill">Em andamento: <strong>-</strong></div>
      <div class="goal-pill goal-todo" id="relatorioGoalsTodoPill">N√£o iniciados: <strong>-</strong></div>
      <button type="button" class="btn small secondary" id="relatorioGoalsClearFilter">Limpar filtro</button>
    </div>

    <div class="goals-columns" id="relatorioGoalsColumns">
      <div class="goals-col" data-status="concluido">
        <h3>Conclu√≠dos</h3>
        <div class="goals-list" id="relatorioGoalsDone"></div>
      </div>
      <div class="goals-col" data-status="em-andamento">
        <h3>Em andamento</h3>
        <div class="goals-list" id="relatorioGoalsProgress"></div>
      </div>
      <div class="goals-col" data-status="nao-iniciado">
        <h3>N√£o iniciados</h3>
        <div class="goals-list" id="relatorioGoalsTodo"></div>
      </div>
    </div>
    <p class="relatorio-desc" id="relatorioGoalsDesc"></p>
    
  </div>

  <!-- Relat√≥rio de Metas do m√™s -->
  <div class="relatorio-container" id="relatorioMetasSection" style="display:none">
    <div class="relatorio-header">
      <h2>üìà Metas do m√™s</h2>
      <p class="relatorio-subtitle" id="relatorioMetasSubtitle">Metas ativas (aba Metas) no m√™s selecionado</p>
    </div>

    <div class="relatorio-goals-summary">
      <div class="goal-pill goal-done" id="relatorioMetasAchievedPill">Atingidas: <strong>-</strong></div>
      <div class="goal-pill goal-progress" id="relatorioMetasProgressPill">Em andamento: <strong>-</strong></div>
      <div class="goal-pill goal-todo" id="relatorioMetasMissingPill">Precisa colocar: <strong>-</strong></div>
      <button type="button" class="btn small secondary" id="relatorioMetasClearFilter">Limpar filtro</button>
    </div>

    <div class="goals-columns" id="relatorioMetasColumns">
      <div class="goals-col" data-status="concluido">
        <h3>Atingidas</h3>
        <div class="goals-list" id="relatorioMetasAchieved"></div>
      </div>
      <div class="goals-col" data-status="em-andamento">
        <h3>Em andamento</h3>
        <div class="goals-list" id="relatorioMetasProgress"></div>
      </div>
      <div class="goals-col" data-status="nao-iniciado">
        <h3>Precisa colocar</h3>
        <div class="goals-list" id="relatorioMetasMissing"></div>
      </div>
    </div>
    <p class="relatorio-desc" id="relatorioMetasDesc"></p>
    
  </div>
  
  <!-- Leads Gerados no M√™s -->
  <div class="relatorio-container" id="relatorioLeadsSection" style="display:none">
    <div class="relatorio-header">
      <h2>üéØ Leads Gerados</h2>
      <p class="relatorio-subtitle" id="relatorioLeadsSubtitle">Leads captados durante o m√™s selecionado</p>
    </div>
    
    <!-- Contador Principal -->
    <div class="relatorio-preview">
      <div class="relatorio-preview-meta" style="justify-content: center; font-size: 1.4rem; padding: 20px;">
        <span class="meta-item" style="color: #86efac; font-weight: 900; font-size: 2rem;">
          üìä <span id="relatorioLeadsCount">0</span> leads
        </span>
      </div>
    </div>
    
    <!-- An√°lise Detalhada -->
    <div class="relatorio-leads-analysis" id="relatorioLeadsAnalysis" style="display:none; margin-top: 20px;">
      
      <!-- Por Plataforma (Google/Meta) -->
      <div class="relatorio-container" style="margin-bottom: 16px;">
        <h3 style="margin: 0 0 12px; font-size: 1.1rem; color: #e2e8f0;">üì± Por Plataforma</h3>
        <div class="relatorio-goals-summary" id="relatorioLeadsPlatforms">
          <!-- Ser√° preenchido dinamicamente -->
        </div>
      </div>
      
      <!-- Por Fonte -->
      <div class="relatorio-container" style="margin-bottom: 16px;">
        <h3 style="margin: 0 0 12px; font-size: 1.1rem; color: #e2e8f0;">üåê Por Fonte</h3>
        <div class="relatorio-goals-summary" id="relatorioLeadsSources">
          <!-- Ser√° preenchido dinamicamente -->
        </div>
      </div>
      
      <!-- Principais Perguntas -->
      <div class="relatorio-container" style="margin-bottom: 16px;">
        <h3 style="margin: 0 0 12px; font-size: 1.1rem; color: #e2e8f0;">üí¨ Principais Perguntas</h3>
        <div id="relatorioLeadsQuestions" style="display: flex; flex-direction: column; gap: 8px;">
          <!-- Ser√° preenchido dinamicamente -->
        </div>
      </div>
      
      <!-- An√°lise IA -->
      <div class="relatorio-container" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1)); border: 1px solid rgba(139, 92, 246, 0.3);">
        <h3 style="margin: 0 0 12px; font-size: 1.1rem; color: #c4b5fd;">ü§ñ An√°lise Inteligente</h3>
        <div id="relatorioLeadsAIAnalysis" style="color: #e9d5ff; line-height: 1.6; font-size: 0.95rem;">
          <!-- Ser√° preenchido dinamicamente -->
        </div>
      </div>
      
    </div>
    
    <p class="relatorio-desc" id="relatorioLeadsDesc"></p>
  </div>
  
  <!-- Relat√≥rio de redes trabalhadas (apenas redes com link configurado) -->
  <div class="relatorio-container" id="relatorioRedesSection" style="display:none">
    <div class="relatorio-header">
      <h2>üîó Redes trabalhadas no m√™s</h2>
      <p class="relatorio-subtitle" id="relatorioRedesSubtitle">Listagem das redes com link configurado (aba Macro)</p>
    </div>
    <div class="macro-social-grid" id="relatorioRedesGrid"></div>
    <p class="relatorio-desc" id="relatorioRedesDesc"></p>
  </div>
  
  <!-- Resumo em Texto (Copi√°vel) -->
  <div class="relatorio-container" id="relatorioResumoTextoSection" style="display:none; background: rgba(30, 41, 59, 0.6); border: 1px solid rgba(100, 116, 139, 0.3);">
    <div class="relatorio-header">
      <h2>üìã Resumo em Texto</h2>
      <p class="relatorio-subtitle">Copie este resumo para compartilhar facilmente</p>
    </div>
    
    <div style="position: relative;">
      <button type="button" id="btnCopiarResumo" class="btn secondary small" style="position: absolute; top: 8px; right: 8px; z-index: 10; background: rgba(59, 130, 246, 0.2); border-color: rgba(59, 130, 246, 0.4);">
        üìã Copiar Texto
      </button>
      
      <div id="relatorioResumoTextoContent" style="
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(71, 85, 105, 0.4);
        border-radius: 8px;
        padding: 24px;
        color: #e2e8f0;
        font-family: 'Courier New', monospace;
        font-size: 0.95rem;
        line-height: 1.8;
        white-space: pre-wrap;
        overflow-x: auto;
        min-height: 200px;
      ">
        <!-- Ser√° preenchido dinamicamente -->
      </div>
    </div>
  </div>
  
</div>

<!-- NOTAS TIME (Kanban Board) -->
<div aria-hidden="true" class="team-notes-wrap" id="teamNotesWrap" style="display:none">
  <div class="team-notes-header">
    <div>
      <h2>üìù Notas do Time</h2>
      <p>Anota√ß√µes di√°rias para manter o controle das contas. Todos do time podem adicionar e visualizar.</p>
    </div>
  </div>
  
  <div class="team-notes-board" id="teamNotesBoard">
    <!-- Coluna Tr√°fego -->
    <div class="team-notes-column" data-column="trafego">
      <div class="team-notes-column-header">
        <h3 class="team-notes-column-title"><span class="column-icon">üéØ</span> Tr√°fego</h3>
        <span class="team-notes-column-count" id="teamNotesCountTrafego">0</span>
      </div>
      <div class="team-notes-column-cards" id="teamNotesCardsTrafego"></div>
      <button type="button" class="team-notes-add-btn" data-column="trafego" onclick="openTrafficTemplateModal()">
        <span>üìã</span> Template Tr√°fego
      </button>
    </div>
    
    <!-- Coluna Canais de Tra√ß√£o -->
    <div class="team-notes-column" data-column="canais">
      <div class="team-notes-column-header">
        <h3 class="team-notes-column-title"><span class="column-icon">üì¢</span> Canais de Tra√ß√£o</h3>
        <span class="team-notes-column-count" id="teamNotesCountCanais">0</span>
      </div>
      <div class="team-notes-column-cards" id="teamNotesCardsCanais"></div>
      <button type="button" class="team-notes-add-btn" data-column="canais" onclick="openContentTemplateModal()">
        <span>üìã</span> Template Conte√∫do
      </button>
    </div>
    
    <!-- Coluna Lideran√ßa -->
    <div class="team-notes-column" data-column="lideranca">
      <div class="team-notes-column-header">
        <h3 class="team-notes-column-title"><span class="column-icon">üëî</span> Lideran√ßa</h3>
        <span class="team-notes-column-count" id="teamNotesCountLideranca">0</span>
      </div>
      <div class="team-notes-column-cards" id="teamNotesCardsLideranca"></div>
      <button type="button" class="team-notes-add-btn" data-column="lideranca" onclick="openLeadershipTemplateModal()">
        <span>üìã</span> Template Lideran√ßa
      </button>
    </div>
    
    <!-- Coluna Outros -->
    <div class="team-notes-column" data-column="outros">
      <div class="team-notes-column-header">
        <h3 class="team-notes-column-title"><span class="column-icon">üìå</span> Outros</h3>
        <span class="team-notes-column-count" id="teamNotesCountOutros">0</span>
      </div>
      <div class="team-notes-column-cards" id="teamNotesCardsOutros"></div>
      <button type="button" class="team-notes-add-btn" data-column="outros" onclick="openTeamNoteModal('outros')">
        <span>+</span> Adicionar nota
      </button>
    </div>
  </div>
  
  <!-- BLOCO DE RESUMO AUTOM√ÅTICO (ABAIXO DAS COLUNAS) -->
  <div class="team-notes-summary-block" id="teamNotesSummaryBlock" style="background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(139,92,246,0.1)); border: 1px solid rgba(99,102,241,0.3); border-radius: 12px; padding: 16px; margin: 16px;">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; margin-bottom: 16px;">
      <h3 style="color: #e2e8f0; font-size: 1rem; margin: 0; display: flex; align-items: center; gap: 8px;">
        <span>üìä</span> Resumo Autom√°tico
      </h3>
      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
        <button type="button" class="summary-filter-btn" data-filter="dia" onclick="setSummaryFilter('dia')" style="padding: 6px 14px; border-radius: 6px; border: 1px solid rgba(99,102,241,0.3); background: transparent; color: #94a3b8; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;">
          üìÖ Hoje
        </button>
        <button type="button" class="summary-filter-btn active" data-filter="semana" onclick="setSummaryFilter('semana')" style="padding: 6px 14px; border-radius: 6px; border: 1px solid rgba(99,102,241,0.5); background: rgba(99,102,241,0.3); color: #e2e8f0; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;">
          üìÜ Semana
        </button>
        <button type="button" class="summary-filter-btn" data-filter="mes" onclick="setSummaryFilter('mes')" style="padding: 6px 14px; border-radius: 6px; border: 1px solid rgba(99,102,241,0.3); background: transparent; color: #94a3b8; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;">
          üóìÔ∏è M√™s
        </button>
      </div>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
      <!-- Card Resumo Tr√°fego -->
      <div class="summary-card" style="background: rgba(15,23,42,0.6); border: 1px solid rgba(251,191,36,0.3); border-radius: 10px; padding: 14px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <h4 style="color: #fbbf24; font-size: 0.95rem; margin: 0; display: flex; align-items: center; gap: 6px;">
            <span>üéØ</span> Tr√°fego
          </h4>
          <button type="button" onclick="copySummary('trafego')" style="background: rgba(251,191,36,0.2); border: 1px solid rgba(251,191,36,0.4); border-radius: 6px; padding: 4px 10px; color: #fbbf24; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 4px;">
            üìã Copiar
          </button>
        </div>
        <div id="summaryTrafegoContent" style="color: #cbd5e1; font-size: 0.85rem; line-height: 1.6; max-height: 200px; overflow-y: auto;">
          <p style="color: #64748b; font-style: italic; margin: 0;">Nenhuma nota de tr√°fego no per√≠odo selecionado.</p>
        </div>
      </div>
      
      <!-- Card Resumo Conte√∫do -->
      <div class="summary-card" style="background: rgba(15,23,42,0.6); border: 1px solid rgba(34,197,94,0.3); border-radius: 10px; padding: 14px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <h4 style="color: #22c55e; font-size: 0.95rem; margin: 0; display: flex; align-items: center; gap: 6px;">
            <span>üì¢</span> Conte√∫do
          </h4>
          <button type="button" onclick="copySummary('conteudo')" style="background: rgba(34,197,94,0.2); border: 1px solid rgba(34,197,94,0.4); border-radius: 6px; padding: 4px 10px; color: #22c55e; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 4px;">
            üìã Copiar
          </button>
        </div>
        <div id="summaryConteudoContent" style="color: #cbd5e1; font-size: 0.85rem; line-height: 1.6; max-height: 200px; overflow-y: auto;">
          <p style="color: #64748b; font-style: italic; margin: 0;">Nenhuma nota de conte√∫do no per√≠odo selecionado.</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- BLOCO RESUMO GERAL DA SEMANA (TODAS AS COLUNAS) -->
  <div class="team-notes-summary-block" id="teamNotesWeeklyResumeBlock" style="background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(99,102,241,0.1)); border: 1px solid rgba(59,130,246,0.3); border-radius: 12px; padding: 16px; margin: 0 16px 16px;">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; margin-bottom: 16px;">
      <h3 style="color: #3b82f6; font-size: 1rem; margin: 0; display: flex; align-items: center; gap: 8px;">
        <span>üìÜ</span> Resumo Geral da Semana
        <span style="font-size: 0.75rem; color: #94a3b8; font-weight: normal;" id="weeklyResumeWeekLabel"></span>
      </h3>
      <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
        <button type="button" onclick="copyWeeklyResume()" id="copyWeeklyResumeBtn" style="padding: 6px 14px; border-radius: 6px; border: 1px solid rgba(59,130,246,0.4); background: rgba(59,130,246,0.2); color: #3b82f6; font-size: 0.85rem; cursor: pointer; display: none;">
          üìã Copiar
        </button>
        <button type="button" onclick="generateWeeklyResume()" id="generateWeeklyResumeBtn" style="padding: 8px 16px; border-radius: 6px; border: none; background: linear-gradient(135deg, #3b82f6, #6366f1); color: white; font-size: 0.85rem; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 6px;">
          <i class="fas fa-magic"></i> Gerar Resumo da Semana
        </button>
      </div>
    </div>
    
    <div id="weeklyResumeContent" style="color: #cbd5e1; font-size: 0.9rem; line-height: 1.7; background: rgba(15,23,42,0.6); border-radius: 10px; padding: 16px; min-height: 80px;">
      <p style="color: #64748b; font-style: italic; margin: 0; text-align: center;">
        Clique em "Gerar Resumo da Semana" para consolidar todas as anota√ß√µes de Tr√°fego, Conte√∫do, Lideran√ßa e Outros dos √∫ltimos 7 dias.
      </p>
    </div>
  </div>

  <!-- BLOCO RESUMO GERAL DO M√äS (TODAS AS COLUNAS) -->
  <div class="team-notes-summary-block" id="teamNotesMonthlyResumeBlock" style="background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(234,88,12,0.1)); border: 1px solid rgba(245,158,11,0.3); border-radius: 12px; padding: 16px; margin: 0 16px 16px;">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; margin-bottom: 16px;">
      <h3 style="color: #fbbf24; font-size: 1rem; margin: 0; display: flex; align-items: center; gap: 8px;">
        <span>üìÖ</span> Resumo Geral do M√™s
        <span style="font-size: 0.75rem; color: #94a3b8; font-weight: normal;" id="monthlyResumeMonthLabel"></span>
      </h3>
      <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
        <button type="button" onclick="copyMonthlyResume()" id="copyMonthlyResumeBtn" style="padding: 6px 14px; border-radius: 6px; border: 1px solid rgba(245,158,11,0.4); background: rgba(245,158,11,0.2); color: #fbbf24; font-size: 0.85rem; cursor: pointer; display: none;">
          üìã Copiar
        </button>
        <button type="button" onclick="generateMonthlyResume()" id="generateMonthlyResumeBtn" style="padding: 8px 16px; border-radius: 6px; border: none; background: linear-gradient(135deg, #f59e0b, #ea580c); color: white; font-size: 0.85rem; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 6px;">
          <i class="fas fa-magic"></i> Gerar Resumo do M√™s
        </button>
      </div>
    </div>
    
    <div id="monthlyResumeContent" style="color: #cbd5e1; font-size: 0.9rem; line-height: 1.7; background: rgba(15,23,42,0.6); border-radius: 10px; padding: 16px; min-height: 80px;">
      <p style="color: #64748b; font-style: italic; margin: 0; text-align: center;">
        Clique em "Gerar Resumo do M√™s" para consolidar todas as anota√ß√µes de Tr√°fego, Conte√∫do, Lideran√ßa e Outros em um √∫nico resumo.
      </p>
    </div>
  </div>
</div>

<!-- Modal Notas Time -->
<div class="team-notes-modal" id="teamNotesModal">
  <div class="team-notes-modal-content">
    <div class="team-notes-modal-header">
      <h3 id="teamNotesModalTitle">Nova Nota</h3>
      <button type="button" class="team-notes-modal-close" onclick="closeTeamNoteModal()">‚úï</button>
    </div>
    <div class="team-notes-modal-body">
      <div>
        <label for="teamNoteContent">Conte√∫do da nota</label>
        <textarea id="teamNoteContent" placeholder="Digite sua anota√ß√£o aqui... 

Voc√™ pode adicionar links (https://...) e colar imagens."></textarea>
      </div>
      <div class="team-notes-modal-attachments" id="teamNoteAttachments">
        <div class="team-notes-modal-attachments-label">üìé Anexos (clique ou arraste imagens)</div>
        <label class="team-notes-modal-upload-btn" for="teamNoteFileInput">+</label>
        <input type="file" id="teamNoteFileInput" accept="image/*" multiple style="display:none" onchange="handleTeamNoteFileSelect(event)">
      </div>
    </div>
    <div class="team-notes-modal-footer">
      <button type="button" class="btn secondary" onclick="closeTeamNoteModal()">Cancelar</button>
      <button type="button" class="btn" id="teamNoteSaveBtn" onclick="saveTeamNote()">üíæ Salvar</button>
    </div>
  </div>
</div>

<!-- Modal Template Tr√°fego -->
<div class="team-notes-modal traffic-template-modal" id="trafficTemplateModal">
  <div class="team-notes-modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
    <div class="team-notes-modal-header">
      <h3>üìã Relat√≥rio de Tr√°fego - Template</h3>
      <button type="button" class="team-notes-modal-close" onclick="closeTrafficTemplateModal()">‚úï</button>
    </div>
    <div class="team-notes-modal-body" style="display: flex; flex-direction: column; gap: 16px;">
      
      <!-- 1. Campanhas rodando -->
      <div class="template-question">
        <label class="template-label">üéØ Campanhas est√£o rodando? Quais?</label>
        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
          <label style="display: flex; align-items: center; gap: 6px; color: #cbd5e1; font-size: 0.85rem; background: rgba(99,102,241,0.1); padding: 6px 12px; border-radius: 6px; cursor: pointer;">
            <input type="checkbox" id="trafficCampGoogle" style="width: 16px; height: 16px;">
            <span>Google Ads</span>
          </label>
          <label style="display: flex; align-items: center; gap: 6px; color: #cbd5e1; font-size: 0.85rem; background: rgba(99,102,241,0.1); padding: 6px 12px; border-radius: 6px; cursor: pointer;">
            <input type="checkbox" id="trafficCampMeta" style="width: 16px; height: 16px;">
            <span>Meta Ads</span>
          </label>
          <label style="display: flex; align-items: center; gap: 6px; color: #cbd5e1; font-size: 0.85rem; background: rgba(239,68,68,0.1); padding: 6px 12px; border-radius: 6px; cursor: pointer;">
            <input type="checkbox" id="trafficCampNenhuma" style="width: 16px; height: 16px;" onchange="if(this.checked){ document.getElementById('trafficCampGoogle').checked=false; document.getElementById('trafficCampMeta').checked=false; }">
            <span>Nenhuma</span>
          </label>
        </div>
        <input type="text" id="trafficCampDetails" class="template-input" placeholder="Especificar campanhas (opcional)..." style="margin-top: 8px;">
      </div>

      <!-- 2. Gerando leads -->
      <div class="template-question">
        <label class="template-label">üìä Est√£o gerando leads?</label>
        <select id="trafficLeadsGerando" class="template-select">
          <option value="">Selecione...</option>
          <option value="Sim">‚úÖ Sim</option>
          <option value="N√£o">‚ùå N√£o</option>
          <option value="Aguardando aprova√ß√£o">‚è≥ Aguardando aprova√ß√£o</option>
          <option value="Em otimiza√ß√£o">üîß Em otimiza√ß√£o</option>
        </select>
      </div>

      <!-- 3. Leads ontem -->
      <div class="template-question">
        <label class="template-label">üìà Quantos leads ontem?</label>
        <input type="number" id="trafficLeadsOntem" class="template-input" placeholder="Ex: 5" min="0">
      </div>

      <!-- 4. Leads no m√™s -->
      <div class="template-question">
        <label class="template-label">üìÖ Quantos leads no m√™s?</label>
        <input type="number" id="trafficLeadsMes" class="template-input" placeholder="Ex: 120" min="0">
      </div>

      <!-- 5. Investimento total -->
      <div class="template-question">
        <label class="template-label">üí∞ Investimento total at√© agora?</label>
        <input type="text" id="trafficInvestimento" class="template-input" placeholder="Ex: R$ 2.500">
      </div>

      <!-- 6. CPL m√©dio -->
      <div class="template-question">
        <label class="template-label">üíµ CPL m√©dio por campanha</label>
        <input type="text" id="trafficCPL" class="template-input" placeholder="Ex: R$ 25 Google | R$ 18 Meta">
      </div>

      <!-- 7. Leads caindo corretamente -->
      <div class="template-question">
        <label class="template-label">‚úÖ Leads est√£o caindo corretamente na plataforma e no CRM?</label>
        <select id="trafficLeadsCaindo" class="template-select">
          <option value="">Selecione...</option>
          <option value="Sim">‚úÖ Sim, tudo ok</option>
          <option value="N√£o">‚ùå N√£o</option>
          <option value="Apenas na plataforma">‚ö†Ô∏è Apenas na plataforma</option>
          <option value="Verificando integra√ß√£o">üîç Verificando</option>
        </select>
      </div>

      <!-- 8. CTR por campanha -->
      <div class="template-question">
        <label class="template-label">üéØ CTR por campanha</label>
        <input type="text" id="trafficCTR" class="template-input" placeholder="Ex: Google 3,5% | Meta 2,1%">
      </div>

      <!-- 9. Melhores an√∫ncios -->
      <div class="template-question">
        <label class="template-label">‚≠ê Quais s√£o os melhores an√∫ncios hoje?</label>
        <select id="trafficMelhoresAnuncios" class="template-select" onchange="if(this.value==='personalizado'){ document.getElementById('trafficMelhoresAnunciosCustom').style.display='block'; } else { document.getElementById('trafficMelhoresAnunciosCustom').style.display='none'; }">
          <option value="">Selecione...</option>
          <option value="Todos performando bem">‚úÖ Todos performando bem</option>
          <option value="An√∫ncios de convers√£o">üéØ An√∫ncios de convers√£o</option>
          <option value="Remarketing">üîÑ Remarketing</option>
          <option value="Carrossel/Imagem">üñºÔ∏è Carrossel/Imagem</option>
          <option value="V√≠deo">üé¨ V√≠deo</option>
          <option value="personalizado">‚úèÔ∏è Especificar...</option>
        </select>
        <input type="text" id="trafficMelhoresAnunciosCustom" class="template-input" placeholder="Especifique..." style="margin-top: 8px; display: none;">
      </div>

      <!-- 10. Coment√°rios nos an√∫ncios -->
      <div class="template-question">
        <label class="template-label">üí¨ Algum an√∫ncio com coment√°rios relevantes?</label>
        <select id="trafficComentarios" class="template-select" onchange="if(this.value==='Sim'){ document.getElementById('trafficComentariosDetails').style.display='block'; } else { document.getElementById('trafficComentariosDetails').style.display='none'; }">
          <option value="">Selecione...</option>
          <option value="N√£o">‚ùå N√£o</option>
          <option value="Apenas Google rodando">üìä Apenas Google (sem coment√°rios)</option>
          <option value="Sim">‚úÖ Sim</option>
        </select>
        <input type="text" id="trafficComentariosDetails" class="template-input" placeholder="Quais coment√°rios?" style="margin-top: 8px; display: none;">
      </div>

      <!-- 11. Otimiza√ß√£o hoje -->
      <div class="template-question">
        <label class="template-label">üõ†Ô∏è Otimiza√ß√£o hoje? Qual foi/ser√° feita</label>
        <select id="trafficOtimizacao" class="template-select" onchange="if(this.value==='Sim' || this.value==='Feita'){ document.getElementById('trafficOtimizacaoDetails').style.display='block'; } else { document.getElementById('trafficOtimizacaoDetails').style.display='none'; }">
          <option value="">Selecione...</option>
          <option value="N√£o">‚ùå N√£o precisa hoje</option>
          <option value="Feita">‚úÖ J√° foi feita</option>
          <option value="Sim">üîß Ser√° feita</option>
          <option value="Aguardando dados">‚è≥ Aguardando dados</option>
        </select>
        <input type="text" id="trafficOtimizacaoDetails" class="template-input" placeholder="O que foi/ser√° feito?" style="margin-top: 8px; display: none;">
      </div>

      <!-- 12. Insight geral -->
      <div class="template-question">
        <label class="template-label">üí° Insight geral da conta</label>
        <select id="trafficInsight" class="template-select" onchange="if(this.value==='personalizado'){ document.getElementById('trafficInsightCustom').style.display='block'; } else { document.getElementById('trafficInsightCustom').style.display='none'; }">
          <option value="">Selecione...</option>
          <option value="Conta saud√°vel, manter estrat√©gia">‚úÖ Conta saud√°vel, manter estrat√©gia</option>
          <option value="Precisa mais investimento">üí∞ Precisa mais investimento</option>
          <option value="Necess√°rio ajustes urgentes">‚ö†Ô∏è Ajustes urgentes</option>
          <option value="Aguardando resultados da otimiza√ß√£o">‚è≥ Aguardando resultados</option>
          <option value="Escalar campanhas que performam">üöÄ Escalar campanhas boas</option>
          <option value="personalizado">‚úèÔ∏è Insight personalizado...</option>
        </select>
        <input type="text" id="trafficInsightCustom" class="template-input" placeholder="Seu insight..." style="margin-top: 8px; display: none;">
      </div>

      <!-- 13. Decis√£o tomada hoje -->
      <div class="template-question">
        <label class="template-label">üéØ Decis√£o tomada hoje</label>
        <select id="trafficDecisao" class="template-select" onchange="if(this.value==='personalizado'){ document.getElementById('trafficDecisaoCustom').style.display='block'; } else { document.getElementById('trafficDecisaoCustom').style.display='none'; }">
          <option value="">Selecione...</option>
          <option value="Manter como est√°">‚úÖ Manter como est√°</option>
          <option value="Aumentar or√ßamento">üí∞ Aumentar or√ßamento</option>
          <option value="Pausar campanhas fracas">‚è∏Ô∏è Pausar campanhas fracas</option>
          <option value="Testar novos criativos">üé® Testar novos criativos</option>
          <option value="Ajustar p√∫blico-alvo">üéØ Ajustar p√∫blico-alvo</option>
          <option value="Criar novas campanhas">‚ûï Criar novas campanhas</option>
          <option value="Nenhuma a√ß√£o necess√°ria">‚ûñ Nenhuma a√ß√£o necess√°ria</option>
          <option value="personalizado">‚úèÔ∏è Outra decis√£o...</option>
        </select>
        <input type="text" id="trafficDecisaoCustom" class="template-input" placeholder="Qual decis√£o?" style="margin-top: 8px; display: none;">
      </div>

    </div>
    <div class="team-notes-modal-footer">
      <button type="button" class="btn secondary" onclick="closeTrafficTemplateModal()">Cancelar</button>
      <button type="button" class="btn" onclick="saveTrafficTemplate()">üíæ Salvar Relat√≥rio</button>
    </div>
  </div>
</div>

<!-- Modal Template Conte√∫do/Canais -->
<div class="team-notes-modal traffic-template-modal" id="contentTemplateModal">
  <div class="team-notes-modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
    <div class="team-notes-modal-header">
      <h3>üì¢ Relat√≥rio de Conte√∫do e Canais - Template</h3>
      <button type="button" class="team-notes-modal-close" onclick="closeContentTemplateModal()">‚úï</button>
    </div>
    <div class="team-notes-modal-body" style="display: flex; flex-direction: column; gap: 16px;">
      
      <!-- 1. Alcance total m√™s | ontem -->
      <div class="template-question">
        <label class="template-label">üåê Alcance total ‚Äì m√™s | ontem (todas as redes)</label>
        <div style="display: flex; gap: 12px;">
          <input type="text" id="contentAlcanceMes" class="template-input" placeholder="M√™s: 15k" style="flex: 1;">
          <input type="text" id="contentAlcanceOntem" class="template-input" placeholder="Ontem: 2.5k" style="flex: 1;">
        </div>
      </div>

      <!-- 2. Instagram alcance | Google intera√ß√µes -->
      <div class="template-question">
        <label class="template-label">üì± Instagram ‚Äì alcance | üîç Google ‚Äì intera√ß√µes</label>
        <div style="display: flex; gap: 12px;">
          <input type="text" id="contentAlcanceInstagram" class="template-input" placeholder="IG: 12k" style="flex: 1;">
          <input type="text" id="contentAlcanceGoogle" class="template-input" placeholder="Google: 350" style="flex: 1;">
        </div>
      </div>

      <!-- 3. Material dispon√≠vel -->
      <div class="template-question">
        <label class="template-label">üì¶ Material dispon√≠vel (semana/m√™s)</label>
        <select id="contentMaterialDisponivel" class="template-select" onchange="if(this.value==='personalizado'){ document.getElementById('contentMaterialDetails').style.display='block'; } else { document.getElementById('contentMaterialDetails').style.display='none'; }">
          <option value="">Selecione...</option>
          <option value="Temos material para a semana toda">‚úÖ Temos material para a semana toda</option>
          <option value="Temos material para o m√™s">‚úÖ Temos material para o m√™s</option>
          <option value="Precisamos de mais material">‚ö†Ô∏è Precisamos de mais material</option>
          <option value="Pouco material, precisa gravar">üìπ Pouco material, precisa gravar</option>
          <option value="Sem material dispon√≠vel">‚ùå Sem material dispon√≠vel</option>
          <option value="personalizado">‚úèÔ∏è Especificar...</option>
        </select>
        <input type="text" id="contentMaterialDetails" class="template-input" placeholder="Especifique..." style="margin-top: 8px; display: none;">
      </div>

      <!-- 4. Pr√≥ximos conte√∫dos planejados -->
      <div class="template-question">
        <label class="template-label">üóìÔ∏è Pr√≥ximos conte√∫dos planejados</label>
        <select id="contentProximosConteudos" class="template-select" onchange="if(this.value==='personalizado'){ document.getElementById('contentProximosDetails').style.display='block'; } else { document.getElementById('contentProximosDetails').style.display='none'; }">
          <option value="">Selecione...</option>
          <option value="Conte√∫dos da semana j√° programados">‚úÖ Conte√∫dos da semana j√° programados</option>
          <option value="Precisa planejar pr√≥ximos conte√∫dos">üìù Precisa planejar pr√≥ximos</option>
          <option value="Aguardando aprova√ß√£o do cliente">‚è≥ Aguardando aprova√ß√£o do cliente</option>
          <option value="Calend√°rio atualizado">üìÖ Calend√°rio atualizado</option>
          <option value="personalizado">‚úèÔ∏è Especificar...</option>
        </select>
        <input type="text" id="contentProximosDetails" class="template-input" placeholder="Quais conte√∫dos?" style="margin-top: 8px; display: none;">
      </div>

      <!-- 5. Resultado de ontem -->
      <div class="template-question">
        <label class="template-label">üìà Resultado de ontem (posts, reels, stories)</label>
        <select id="contentResultadoOntem" class="template-select" onchange="if(this.value==='personalizado'){ document.getElementById('contentResultadoOntemDetails').style.display='block'; } else { document.getElementById('contentResultadoOntemDetails').style.display='none'; }">
          <option value="">Selecione...</option>
          <option value="Nenhum conte√∫do postado">‚ûñ Nenhum conte√∫do postado</option>
          <option value="Alcance baixo (menos de 500)">üìâ Alcance baixo (&lt;500)</option>
          <option value="Alcance m√©dio (500-2k)">üìä Alcance m√©dio (500-2k)</option>
          <option value="Alcance bom (2k-5k)">üìà Alcance bom (2k-5k)</option>
          <option value="Alcance excelente (5k+)">üöÄ Alcance excelente (5k+)</option>
          <option value="Reel viralizou">üî• Reel viralizou</option>
          <option value="personalizado">‚úèÔ∏è Especificar...</option>
        </select>
        <input type="text" id="contentResultadoOntemDetails" class="template-input" placeholder="Detalhes do resultado..." style="margin-top: 8px; display: none;">
      </div>

      <!-- 6. Conte√∫dos postados no m√™s -->
      <div class="template-question">
        <label class="template-label">üìÖ Conte√∫dos postados no m√™s</label>
        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
          <div style="display: flex; align-items: center; gap: 6px;">
            <span style="color: #94a3b8; font-size: 0.85rem;">Posts:</span>
            <input type="number" id="contentPostsMes" class="template-input" placeholder="0" min="0" style="width: 70px;">
          </div>
          <div style="display: flex; align-items: center; gap: 6px;">
            <span style="color: #94a3b8; font-size: 0.85rem;">Reels:</span>
            <input type="number" id="contentReelsMes" class="template-input" placeholder="0" min="0" style="width: 70px;">
          </div>
          <div style="display: flex; align-items: center; gap: 6px;">
            <span style="color: #94a3b8; font-size: 0.85rem;">Stories:</span>
            <input type="number" id="contentStoriesMes" class="template-input" placeholder="0" min="0" style="width: 70px;">
          </div>
        </div>
      </div>

      <!-- 7. Melhor reel | Conte√∫dos fracos -->
      <div class="template-question">
        <label class="template-label">üé• Melhor reel do dia | üìâ Conte√∫dos fracos</label>
        <div style="display: flex; gap: 12px;">
          <input type="text" id="contentMelhorReel" class="template-input" placeholder="Melhor: Reel de dicas" style="flex: 1;">
          <input type="text" id="contentConteudosFracos" class="template-input" placeholder="Fracos: Post institucional" style="flex: 1;">
        </div>
      </div>

      <!-- 8. DMs respondidas -->
      <div class="template-question">
        <label class="template-label">üíå DMs ontem respondidas?</label>
        <select id="contentDMsRespondidas" class="template-select">
          <option value="">Selecione...</option>
          <option value="Sim, todas">‚úÖ Sim, todas</option>
          <option value="N√£o houve DMs">‚ûñ N√£o houve DMs</option>
          <option value="Parcialmente">‚ö†Ô∏è Parcialmente</option>
          <option value="N√£o respondidas">‚ùå N√£o respondidas</option>
          <option value="Cliente responde">üë§ Cliente responde</option>
        </select>
      </div>

      <!-- 9. Coment√°rios respondidos -->
      <div class="template-question">
        <label class="template-label">üí¨ Coment√°rios respondidos?</label>
        <select id="contentComentariosRespondidos" class="template-select">
          <option value="">Selecione...</option>
          <option value="Sim, todos">‚úÖ Sim, todos</option>
          <option value="N√£o houve coment√°rios">‚ûñ N√£o houve coment√°rios</option>
          <option value="Parcialmente">‚ö†Ô∏è Parcialmente</option>
          <option value="N√£o respondidos">‚ùå N√£o respondidos</option>
          <option value="Cliente responde">üë§ Cliente responde</option>
        </select>
      </div>

      <!-- 10. Coment√°rio negativo ou relevante -->
      <div class="template-question">
        <label class="template-label">‚ö†Ô∏è Coment√°rio negativo ou relevante?</label>
        <select id="contentComentarioNegativo" class="template-select" onchange="if(this.value==='Sim'){ document.getElementById('contentComentarioNegativoDetails').style.display='block'; } else { document.getElementById('contentComentarioNegativoDetails').style.display='none'; }">
          <option value="">Selecione...</option>
          <option value="N√£o">‚ùå N√£o</option>
          <option value="Coment√°rio positivo relevante">üíö Coment√°rio positivo relevante</option>
          <option value="Sim">‚ö†Ô∏è Sim, tem coment√°rio negativo</option>
        </select>
        <input type="text" id="contentComentarioNegativoDetails" class="template-input" placeholder="Qual coment√°rio?" style="margin-top: 8px; display: none;">
      </div>

      <!-- 11. Insight do dia -->
      <div class="template-question">
        <label class="template-label">üí° Insight do dia</label>
        <select id="contentInsight" class="template-select" onchange="if(this.value==='personalizado'){ document.getElementById('contentInsightCustom').style.display='block'; } else { document.getElementById('contentInsightCustom').style.display='none'; }">
          <option value="">Selecione...</option>
          <option value="Conte√∫dos com pessoas performam melhor">üë§ Conte√∫dos com pessoas performam melhor</option>
          <option value="Reels t√™m mais alcance que posts">üé¨ Reels t√™m mais alcance que posts</option>
          <option value="Melhor hor√°rio de postagem identificado">‚è∞ Melhor hor√°rio identificado</option>
          <option value="Engajamento aumentando">üìà Engajamento aumentando</option>
          <option value="Precisa variar tipos de conte√∫do">üîÑ Precisa variar conte√∫dos</option>
          <option value="Tudo normal, manter estrat√©gia">‚úÖ Tudo normal, manter estrat√©gia</option>
          <option value="personalizado">‚úèÔ∏è Insight personalizado...</option>
        </select>
        <input type="text" id="contentInsightCustom" class="template-input" placeholder="Seu insight..." style="margin-top: 8px; display: none;">
      </div>

      <!-- 12. A√ß√£o decidida hoje -->
      <div class="template-question">
        <label class="template-label">üéØ A√ß√£o decidida hoje</label>
        <select id="contentAcaoDecidida" class="template-select" onchange="if(this.value==='personalizado'){ document.getElementById('contentAcaoDecididaCustom').style.display='block'; } else { document.getElementById('contentAcaoDecididaCustom').style.display='none'; }">
          <option value="">Selecione...</option>
          <option value="Manter estrat√©gia atual">‚úÖ Manter estrat√©gia atual</option>
          <option value="Aumentar frequ√™ncia de postagens">üìà Aumentar frequ√™ncia de postagens</option>
          <option value="Focar em reels">üé¨ Focar em reels</option>
          <option value="Solicitar mais material ao cliente">üìπ Solicitar mais material ao cliente</option>
          <option value="Testar novos formatos">üß™ Testar novos formatos</option>
          <option value="Ajustar hor√°rios de postagem">‚è∞ Ajustar hor√°rios de postagem</option>
          <option value="Nenhuma a√ß√£o necess√°ria">‚ûñ Nenhuma a√ß√£o necess√°ria</option>
          <option value="personalizado">‚úèÔ∏è Outra a√ß√£o...</option>
        </select>
        <input type="text" id="contentAcaoDecididaCustom" class="template-input" placeholder="Qual a√ß√£o?" style="margin-top: 8px; display: none;">
      </div>

    </div>
    <div class="team-notes-modal-footer">
      <button type="button" class="btn secondary" onclick="closeContentTemplateModal()">Cancelar</button>
      <button type="button" class="btn" onclick="saveContentTemplate()">üíæ Salvar Relat√≥rio</button>
    </div>
  </div>
</div>

<!-- Modal Template Lideran√ßa (Check-in Di√°rio) -->
<div class="team-notes-modal traffic-template-modal" id="leadershipTemplateModal">
  <div class="team-notes-modal-content" style="max-width: 600px;">
    <div class="team-notes-modal-header" style="background: linear-gradient(135deg, rgba(139,92,246,0.3), rgba(168,85,247,0.2)); border-bottom: 1px solid rgba(139,92,246,0.3);">
      <h3>üß≠ Check-in Di√°rio ‚Äî Vis√£o Macro</h3>
      <button type="button" class="team-notes-modal-close" onclick="closeLeadershipTemplateModal()">‚úï</button>
    </div>
    <div class="team-notes-modal-body" style="padding: 20px; display: flex; flex-direction: column; gap: 16px; max-height: 65vh; overflow-y: auto;">
      
      <!-- Se√ß√£o Check-in -->
      <div class="template-section" style="background: rgba(15,23,42,0.6); border: 1px solid rgba(139,92,246,0.2); border-radius: 10px; padding: 16px;">
        <h4 style="color: #a78bfa; margin: 0 0 12px 0; font-size: 0.95rem;">üß≠ Check-in Di√°rio</h4>
        
        <div style="display: flex; flex-direction: column; gap: 12px;">
          <!-- Leads entraram -->
          <div style="padding: 8px 12px; background: rgba(30,41,59,0.5); border-radius: 6px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="color: #e2e8f0;">Leads entraram?</span>
              <select id="leadershipLeadsEntraram" class="template-input" style="width: auto; min-width: 100px;" onchange="toggleLeadershipObs(this, 'leadershipLeadsEntraramObs')">
                <option value="">Selecione</option>
                <option value="Sim">‚úÖ Sim</option>
                <option value="N√£o">‚ùå N√£o</option>
              </select>
            </div>
            <input type="text" id="leadershipLeadsEntraramObs" class="template-input" placeholder="Observa√ß√£o (opcional)" style="width: 100%; margin-top: 8px; display: none; font-size: 0.85rem;">
          </div>
          
          <!-- Leads atendidos -->
          <div style="padding: 8px 12px; background: rgba(30,41,59,0.5); border-radius: 6px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="color: #e2e8f0;">Leads foram atendidos?</span>
              <select id="leadershipLeadsAtendidos" class="template-input" style="width: auto; min-width: 100px;" onchange="toggleLeadershipObs(this, 'leadershipLeadsAtendidosObs')">
                <option value="">Selecione</option>
                <option value="Sim">‚úÖ Sim</option>
                <option value="N√£o">‚ùå N√£o</option>
              </select>
            </div>
            <input type="text" id="leadershipLeadsAtendidosObs" class="template-input" placeholder="Observa√ß√£o (opcional)" style="width: 100%; margin-top: 8px; display: none; font-size: 0.85rem;">
          </div>
          
          <!-- Custo ok -->
          <div style="padding: 8px 12px; background: rgba(30,41,59,0.5); border-radius: 6px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="color: #e2e8f0;">Custo est√° ok?</span>
              <select id="leadershipCustoOk" class="template-input" style="width: auto; min-width: 120px;" onchange="toggleLeadershipObs(this, 'leadershipCustoOkObs')">
                <option value="">Selecione</option>
                <option value="Sim">‚úÖ Sim</option>
                <option value="Aten√ß√£o">‚ö†Ô∏è Aten√ß√£o</option>
                <option value="N√£o">‚ùå N√£o</option>
              </select>
            </div>
            <input type="text" id="leadershipCustoOkObs" class="template-input" placeholder="Observa√ß√£o (opcional)" style="width: 100%; margin-top: 8px; display: none; font-size: 0.85rem;">
          </div>
          
          <!-- Conte√∫do ativo -->
          <div style="padding: 8px 12px; background: rgba(30,41,59,0.5); border-radius: 6px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="color: #e2e8f0;">Conte√∫do ativo?</span>
              <select id="leadershipConteudoAtivo" class="template-input" style="width: auto; min-width: 100px;" onchange="toggleLeadershipObs(this, 'leadershipConteudoAtivoObs')">
                <option value="">Selecione</option>
                <option value="Sim">‚úÖ Sim</option>
                <option value="N√£o">‚ùå N√£o</option>
              </select>
            </div>
            <input type="text" id="leadershipConteudoAtivoObs" class="template-input" placeholder="Observa√ß√£o (opcional)" style="width: 100%; margin-top: 8px; display: none; font-size: 0.85rem;">
          </div>
          
          <!-- Marca vis√≠vel -->
          <div style="padding: 8px 12px; background: rgba(30,41,59,0.5); border-radius: 6px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="color: #e2e8f0;">Marca vis√≠vel hoje?</span>
              <select id="leadershipMarcaVisivel" class="template-input" style="width: auto; min-width: 100px;" onchange="toggleLeadershipObs(this, 'leadershipMarcaVisivelObs')">
                <option value="">Selecione</option>
                <option value="Sim">‚úÖ Sim</option>
                <option value="N√£o">‚ùå N√£o</option>
              </select>
            </div>
            <input type="text" id="leadershipMarcaVisivelObs" class="template-input" placeholder="Observa√ß√£o (opcional)" style="width: 100%; margin-top: 8px; display: none; font-size: 0.85rem;">
          </div>
        </div>
      </div>
      
      <!-- Se√ß√£o Status Geral -->
      <div class="template-section" style="background: rgba(15,23,42,0.6); border: 1px solid rgba(139,92,246,0.2); border-radius: 10px; padding: 16px;">
        <h4 style="color: #a78bfa; margin: 0 0 12px 0; font-size: 0.95rem;">üö¶ Status Geral</h4>
        <select id="leadershipStatusGeral" class="template-input" style="width: 100%;" onchange="toggleLeadershipObs(this, 'leadershipStatusGeralObs')">
          <option value="">Selecione o status</option>
          <option value="üü¢ Verde, tudo rodando">üü¢ Verde, tudo rodando</option>
          <option value="üü° Amarelo, ajustar algo">üü° Amarelo, ajustar algo</option>
          <option value="üî¥ Vermelho, agir agora">üî¥ Vermelho, agir agora</option>
        </select>
        <input type="text" id="leadershipStatusGeralObs" class="template-input" placeholder="Detalhe o status (opcional)" style="width: 100%; margin-top: 8px; display: none; font-size: 0.85rem;">
      </div>
      
      <!-- Se√ß√£o Insight do Dia -->
      <div class="template-section" style="background: rgba(15,23,42,0.6); border: 1px solid rgba(139,92,246,0.2); border-radius: 10px; padding: 16px;">
        <h4 style="color: #a78bfa; margin: 0 0 12px 0; font-size: 0.95rem;">üí° Insight do Dia</h4>
        <input type="text" id="leadershipInsight" class="template-input" placeholder="1 frase clara sobre o dia" style="width: 100%;">
      </div>
      
      <!-- Se√ß√£o Decis√£o de Hoje -->
      <div class="template-section" style="background: rgba(15,23,42,0.6); border: 1px solid rgba(139,92,246,0.2); border-radius: 10px; padding: 16px;">
        <h4 style="color: #a78bfa; margin: 0 0 12px 0; font-size: 0.95rem;">üéØ Decis√£o de Hoje</h4>
        <select id="leadershipDecisao" class="template-input" style="width: 100%;" onchange="toggleLeadershipObs(this, 'leadershipDecisaoObs')">
          <option value="">Selecione a decis√£o</option>
          <option value="Manter">‚úÖ Manter</option>
          <option value="Ajustar">üîß Ajustar</option>
          <option value="Escalar">üìà Escalar</option>
          <option value="Corrigir">üõ†Ô∏è Corrigir</option>
        </select>
        <input type="text" id="leadershipDecisaoObs" class="template-input" placeholder="O que vai manter/ajustar/escalar/corrigir? (opcional)" style="width: 100%; margin-top: 8px; display: none; font-size: 0.85rem;">
      </div>

      <!-- Se√ß√£o A√ß√£o R√°pida (permite salvar apenas com esta a√ß√£o) -->
      <div class="template-section" style="background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(16,185,129,0.1)); border: 2px solid rgba(34,197,94,0.4); border-radius: 10px; padding: 16px;">
        <h4 style="color: #22c55e; margin: 0 0 8px 0; font-size: 0.95rem;">‚ö° Adicionar uma A√ß√£o</h4>
        <p style="color: #94a3b8; font-size: 0.8rem; margin: 0 0 12px 0;">Preencha apenas esta a√ß√£o para salvar rapidamente (n√£o precisa preencher o resto do template)</p>
        <textarea id="leadershipAcaoRapida" class="template-input" placeholder="Ex: Ligar para cliente X, Revisar campanha Y, Cobrar equipe sobre Z..." style="width: 100%; min-height: 80px; resize: vertical; font-size: 0.95rem;"></textarea>
      </div>

    </div>
    <div class="team-notes-modal-footer">
      <button type="button" class="btn secondary" onclick="closeLeadershipTemplateModal()">Cancelar</button>
      <button type="button" class="btn" onclick="saveLeadershipTemplate()" style="background: linear-gradient(135deg, #8b5cf6, #a855f7);">üíæ Salvar Check-in</button>
    </div>
  </div>
</div>

<!-- Modal Visualizar Nota Completa -->
<div class="team-notes-modal" id="expandNoteModal">
  <div class="team-notes-modal-content" style="max-width: 800px; max-height: 85vh;">
    <div class="team-notes-modal-header">
      <h3 id="expandNoteModalTitle">üìù Nota Completa</h3>
      <button type="button" class="team-notes-modal-close" onclick="closeExpandNoteModal()">‚úï</button>
    </div>
    <div class="team-notes-modal-body" style="overflow-y: auto; max-height: calc(85vh - 140px);">
      <div id="expandNoteContent" style="line-height: 1.8; color: #e2e8f0; font-size: 1rem;"></div>
      <div id="expandNoteAttachments" style="display: flex; flex-wrap: wrap; gap: 12px; margin-top: 20px;"></div>
    </div>
    <div class="team-notes-modal-footer" style="border-top: 1px solid rgba(99,102,241,.2); padding: 16px 20px; background: rgba(15,23,42,.4);">
      <div id="expandNoteAuthor" style="flex: 1; display: flex; align-items: center; gap: 10px; color: #94a3b8; font-size: 0.9rem;"></div>
      <button type="button" class="btn secondary" onclick="closeExpandNoteModal()">Fechar</button>
    </div>
  </div>
</div>

<!-- REUNI√ïES -->
<div aria-hidden="true" class="reunioes-wrap" id="reunioesWrap" style="display:none">
  <div class="reunioes-header">
    <div>
      <h2>üìÖ Reuni√µes</h2>
      <p>Adicione transcri√ß√µes de reuni√µes e gere resumos autom√°ticos com IA. Organize por data para f√°cil consulta.</p>
    </div>
    <button type="button" class="reunioes-add-btn" onclick="openReuniaoModal()">
      <span>+</span> Nova Reuni√£o
    </button>
  </div>
  
  <div class="reunioes-grid" id="reunioesGrid">
    <!-- Cards de reuni√µes ser√£o inseridos aqui dinamicamente -->
  </div>
  
  <div class="reuniao-empty-state" id="reunioesEmptyState" style="display:none;">
    <div class="icon">üìÖ</div>
    <p><strong>Nenhuma reuni√£o registrada ainda</strong></p>
    <p>Clique em "Nova Reuni√£o" para adicionar a transcri√ß√£o de uma reuni√£o e gerar um resumo autom√°tico.</p>
  </div>
  
  <!-- ========== CHAT IA PARA CONSULTAR REUNI√ïES ========== -->
  <div class="reunioes-chat-section" id="reunioesChatSection" style="display:none;">
    <!-- Sidebar lateral - SEMPRE VIS√çVEL -->
    <div class="reunioes-chat-sidebar" id="reunioesChatSidebar">
      <div class="reunioes-chat-sidebar-header">
        <div class="reunioes-chat-sidebar-header-title">üìÇ Hist√≥rico de Conversas</div>
        <button type="button" onclick="startNewReuniaoChat()" class="reunioes-chat-new-btn">
          <span>+</span> Nova conversa
        </button>
      </div>
      <div class="reunioes-chat-sidebar-list" id="reunioesChatHistoryList">
        <!-- Lista de conversas -->
      </div>
      <div class="reunioes-chat-sidebar-footer">
        <span>üìä <strong id="reunioesChatCountSidebar">0</strong> reuni√µes indexadas</span>
      </div>
    </div>
    
    <!-- √Årea principal do chat -->
    <div class="reunioes-chat-main">
      <div class="reunioes-chat-header">
        <div class="reunioes-chat-title">
          <span>ü§ñ</span>
          <span>Assistente de Reuni√µes</span>
        </div>
        <div class="reunioes-chat-header-actions">
          <span class="reunioes-chat-count-badge"><strong id="reunioesChatCount">0</strong> reuni√µes</span>
        </div>
      </div>
      
      <div class="reunioes-chat-messages" id="reunioesChatMessages">
        <div class="reunioes-chat-welcome">
          <div class="reunioes-chat-welcome-icon">ü§ñ</div>
          <h4>Assistente de Reuni√µes</h4>
          <p>Pergunte sobre qualquer assunto discutido nas suas reuni√µes</p>
          <div class="reunioes-chat-suggestions">
            <button onclick="askReuniaoSuggestion('Quais foram as principais decis√µes tomadas?')">üìã Principais decis√µes</button>
            <button onclick="askReuniaoSuggestion('Quais tarefas ficaram pendentes?')">‚è≥ Tarefas pendentes</button>
            <button onclick="askReuniaoSuggestion('Resuma os principais t√≥picos discutidos')">üìå T√≥picos discutidos</button>
            <button onclick="askReuniaoSuggestion('Quais problemas foram identificados?')">‚ö†Ô∏è Problemas</button>
            <button onclick="askReuniaoSuggestion('Quem ficou respons√°vel por cada tarefa?')">üë§ Respons√°veis</button>
            <button onclick="askReuniaoSuggestion('Quais foram os prazos definidos?')">üìÖ Prazos</button>
            <button onclick="askReuniaoSuggestion('O que foi discutido sobre metas e resultados?')">üéØ Metas e Resultados</button>
            <button onclick="askReuniaoSuggestion('Houve algum pr√≥ximo passo ou a√ß√£o combinada?')">‚û°Ô∏è Pr√≥ximos passos</button>
            <button onclick="askReuniaoSuggestion('Fa√ßa um resumo geral de todas as reuni√µes')">üìä Resumo geral</button>
          </div>
        </div>
      </div>
      
      <div class="reunioes-chat-input-container">
        <div class="reunioes-chat-filter-row">
          <label for="reunioesChatFilter">üîç Filtrar por reuni√£o:</label>
          <select id="reunioesChatFilter" onchange="updateReunioesChatFilter()">
            <option value="">üìÇ Todas as reuni√µes</option>
          </select>
        </div>
        <div class="reunioes-chat-input-wrapper">
          <textarea 
            id="reunioesChatInput" 
            placeholder="Pergunte sobre as reuni√µes..."
            rows="1"
            onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendReuniaoChat(); }"
            oninput="this.style.height = 'auto'; this.style.height = Math.min(this.scrollHeight, 150) + 'px';"
          ></textarea>
          <button type="button" class="reunioes-chat-send-btn" onclick="sendReuniaoChat()" id="reunioesChatSendBtn">
            ‚û§
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- ========== FIM CHAT IA REUNI√ïES ========== -->
</div>

<!-- Modal Nova/Editar Reuni√£o -->
<div class="reuniao-modal" id="reuniaoModal">
  <div class="reuniao-modal-content">
    <div class="reuniao-modal-header">
      <h3 id="reuniaoModalTitle">üìÖ Nova Reuni√£o</h3>
      <button type="button" class="reuniao-modal-close" onclick="closeReuniaoModal()">‚úï</button>
    </div>
    <div class="reuniao-modal-body">
      <div>
        <label for="reuniaoData">Data da reuni√£o</label>
        <input type="date" id="reuniaoData" />
      </div>
      <div>
        <label for="reuniaoObjetivo">T√≠tulo / Objetivo da reuni√£o <span style="font-size:0.75rem;color:#64748b;font-weight:normal;">(gerado automaticamente ao colar transcri√ß√£o)</span></label>
        <input type="text" id="reuniaoObjetivo" placeholder="Ex: Alinhamento de metas do m√™s, Revis√£o de campanhas, etc." />
      </div>
      <div>
        <label for="reuniaoTranscricao">Transcri√ß√£o da reuni√£o</label>
        <textarea id="reuniaoTranscricao" placeholder="Cole aqui a transcri√ß√£o completa da conversa da reuni√£o..."></textarea>
      </div>
    </div>
    <div class="reuniao-modal-footer">
      <button type="button" class="btn secondary" onclick="closeReuniaoModal()">Cancelar</button>
      <button type="button" class="btn" id="reuniaoSaveBtn" onclick="saveReuniao()">üíæ Salvar e Gerar Resumo</button>
    </div>
  </div>
</div>

<!-- Modal Ver Resumo da Reuni√£o -->
<div class="reuniao-modal" id="reuniaoViewModal">
  <div class="reuniao-modal-content" style="max-width: 900px;">
    <div class="reuniao-modal-header">
      <h3 id="reuniaoViewModalTitle">üìã Resumo da Reuni√£o</h3>
      <button type="button" class="reuniao-modal-close" onclick="closeReuniaoViewModal()">‚úï</button>
    </div>
    <div class="reuniao-modal-body">
      <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px; margin-bottom: 16px;">
        <div>
          <span id="reuniaoViewData" class="reuniao-card-date" style="font-size: 0.9rem;"></span>
        </div>
        <div>
          <strong id="reuniaoViewObjetivo" style="color: #e2e8f0; font-size: 1.1rem;"></strong>
        </div>
      </div>
      
      <div class="reuniao-resumo-section">
        <h4>‚ú® Resumo Gerado por IA</h4>
        <div id="reuniaoViewResumo" class="reuniao-resumo-content"></div>
        <div id="reuniaoViewGenerating" class="reuniao-generating" style="display: none;">
          <div class="spinner"></div>
          <span>Gerando resumo com IA...</span>
        </div>
      </div>
      
      <details class="reuniao-transcricao-section" style="margin-top: 16px;">
        <summary style="cursor: pointer; color: #94a3b8; font-size: 0.9rem; padding: 8px 0;">
          üìú Ver Transcri√ß√£o Completa
        </summary>
        <div id="reuniaoViewTranscricao" class="reuniao-transcricao-content" style="margin-top: 12px;"></div>
      </details>
    </div>
    <div class="reuniao-modal-footer">
      <button type="button" class="btn secondary" onclick="copyReuniaoResumo()" style="margin-right: auto;">üìã Copiar p/ WhatsApp</button>
      <button type="button" class="btn secondary" onclick="copyReuniaoResumoTexto()">üìÑ Copiar Texto</button>
      <button type="button" class="btn secondary" onclick="regenerateReuniaoResumo()" id="regenerateResumoBtn">üîÑ Regenerar Resumo</button>
      <button type="button" class="btn" onclick="closeReuniaoViewModal()">Fechar</button>
    </div>
  </div>
</div>

<!-- EmailJS SDK -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script type="text/javascript">
  (function(){
    emailjs.init({
      publicKey: "WCx9UE2gI8EHSfAYE",
    });
  })();
</script>

<!-- Firebase + App -->
<script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged,
      signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail,
      setPersistence, browserLocalPersistence, inMemoryPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getStorage, ref as sRef, uploadBytes, uploadBytesResumable, getDownloadURL, deleteObject, getMetadata } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";
    import { getFirestore, doc, setDoc, getDoc, getDocs, collection, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, where, serverTimestamp, arrayUnion, Timestamp, writeBatch, deleteField } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-functions.js";

    /* ========= SERVICE WORKER - Notifica√ß√µes em Background ========= */
    let serviceWorkerRegistration = null;
    
    async function registerServiceWorker() {
      if (!('serviceWorker' in navigator)) {
        console.log('‚ö†Ô∏è Service Worker n√£o suportado neste navegador');
        return;
      }
      
      try {
        serviceWorkerRegistration = await navigator.serviceWorker.register('/service-worker.js');
        console.log('‚úÖ Service Worker registrado:', serviceWorkerRegistration);
        
        // Solicitar permiss√£o de notifica√ß√£o
        if ('Notification' in window && Notification.permission === 'default') {
          const permission = await Notification.requestPermission();
          console.log('üîî Permiss√£o de notifica√ß√£o:', permission);
        }
        
        // Esperar o Service Worker estar ativo
        await navigator.serviceWorker.ready;
        console.log('üöÄ Service Worker ativo e pronto!');
        
      } catch (error) {
        console.error('‚ùå Erro ao registrar Service Worker:', error);
      }
    }
    
    // Registrar Service Worker imediatamente
    registerServiceWorker();
    
    /* ========= helpers ========= */
    function mountEmbed(shell, html){
      if(!shell) return;
      shell.innerHTML = html || "";
      const scripts = Array.from(shell.querySelectorAll("script"));
      scripts.forEach(oldS => {
        const s = document.createElement("script");
        for(const attr of Array.from(oldS.attributes||[])){ s.setAttribute(attr.name, attr.value); }
        s.textContent = oldS.textContent || "";
        oldS.parentNode.replaceChild(s, oldS);
      });
    }
    const uuid = ()=> crypto.randomUUID ? crypto.randomUUID() : ('id-'+Math.random().toString(36).slice(2)+Date.now());
function mgToast(msg){ try{ const el=document.createElement('div'); el.className='mg-toast'; el.textContent=msg; document.body.appendChild(el); setTimeout(()=>{ el.remove(); }, 3000);}catch(_){} }

    /**
     * Fun√ß√£o robusta para copiar texto que funciona em iframes e diferentes contextos de permiss√£o
     * @param {string} text - Texto a ser copiado
     * @returns {Promise<boolean>} - Retorna true se a c√≥pia foi bem-sucedida
     */
    async function mgCopyToClipboard(text) {
      if(!text && text !== '') return false;
      
      let copiado = false;
      
      // M√©todo 1: Clipboard API moderna (funciona com https e permiss√µes)
      if(navigator?.clipboard?.writeText) {
        try {
          await navigator.clipboard.writeText(text);
          copiado = true;
        } catch(clipErr) {
          console.warn('[mgCopyToClipboard] Clipboard API falhou, tentando fallback:', clipErr);
        }
      }
      
      // M√©todo 2: Fallback com textarea + execCommand (funciona em iframes sem permiss√£o clipboard-write)
      if(!copiado) {
        try {
          const textarea = document.createElement('textarea');
          textarea.value = text;
          textarea.style.position = 'fixed';
          textarea.style.left = '-9999px';
          textarea.style.top = '-9999px';
          textarea.style.opacity = '0';
          textarea.style.pointerEvents = 'none';
          textarea.setAttribute('readonly', '');
          textarea.setAttribute('aria-hidden', 'true');
          document.body.appendChild(textarea);
          
          // Focus e select completo
          textarea.focus();
          textarea.select();
          textarea.setSelectionRange(0, text.length);
          
          // Executar comando de c√≥pia
          const sucesso = document.execCommand('copy');
          if(sucesso) copiado = true;
          
          document.body.removeChild(textarea);
        } catch(execErr) {
          console.error('[mgCopyToClipboard] execCommand falhou:', execErr);
        }
      }
      
      return copiado;
    }
    
    // Expor globalmente para uso em qualquer contexto
    window.mgCopyToClipboard = mgCopyToClipboard;

    /**
     * Copia texto formatado (HTML) para clipboard - Google Docs reconhece a formata√ß√£o
     * @param {string} html - HTML formatado
     * @param {string} plainText - Texto plano (fallback)
     * @returns {Promise<boolean>}
     */
    async function mgCopyFormattedToClipboard(html, plainText) {
      if (!html && !plainText) return false;
      
      let copiado = false;
      
      // M√©todo 1: Clipboard API com suporte a m√∫ltiplos formatos (HTML + texto)
      if (navigator?.clipboard?.write) {
        try {
          const blob = new Blob([html], { type: 'text/html' });
          const textBlob = new Blob([plainText || html.replace(/<[^>]*>/g, '')], { type: 'text/plain' });
          
          const clipboardItem = new ClipboardItem({
            'text/html': blob,
            'text/plain': textBlob
          });
          
          await navigator.clipboard.write([clipboardItem]);
          copiado = true;
          console.log('[mgCopyFormattedToClipboard] Copiado com formata√ß√£o HTML');
        } catch(err) {
          console.warn('[mgCopyFormattedToClipboard] Clipboard API falhou:', err);
        }
      }
      
      // M√©todo 2: Fallback usando div contenteditable + execCommand
      if (!copiado) {
        try {
          const container = document.createElement('div');
          container.contentEditable = 'true';
          container.innerHTML = html;
          container.style.position = 'fixed';
          container.style.left = '-9999px';
          container.style.top = '-9999px';
          container.style.opacity = '0';
          container.style.pointerEvents = 'none';
          
          document.body.appendChild(container);
          
          // Selecionar todo o conte√∫do
          const range = document.createRange();
          range.selectNodeContents(container);
          const selection = window.getSelection();
          selection.removeAllRanges();
          selection.addRange(range);
          
          // Copiar
          const sucesso = document.execCommand('copy');
          if (sucesso) copiado = true;
          
          // Limpar
          selection.removeAllRanges();
          document.body.removeChild(container);
          
          console.log('[mgCopyFormattedToClipboard] Copiado com execCommand');
        } catch(err) {
          console.error('[mgCopyFormattedToClipboard] execCommand falhou:', err);
        }
      }
      
      // M√©todo 3: Fallback para texto plano se HTML n√£o funcionar
      if (!copiado && plainText) {
        copiado = await mgCopyToClipboard(plainText);
      }
      
      return copiado;
    }
    
    window.mgCopyFormattedToClipboard = mgCopyFormattedToClipboard;

    const __scriptLoadCache = new Map();
    function loadExternalScript(src, check){
      if(typeof check === 'function'){
        try{
          if(check()){
            return Promise.resolve();
          }
        }catch(_err){}
      }
      if(__scriptLoadCache.has(src)){
        return __scriptLoadCache.get(src);
      }
      const promise = new Promise((resolve, reject)=>{
        try{
          if(typeof check === 'function'){
            try{
              if(check()){
                resolve();
                return;
              }
            }catch(_){ }
          }
          const existing = Array.from(document.getElementsByTagName('script')).find(el=> el.src === src);
          if(existing){
            if(typeof check === 'function'){
              try{
                if(check()){
                  resolve();
                  return;
                }
              }catch(_){ }
            }
            existing.addEventListener('load', ()=> resolve());
            existing.addEventListener('error', ()=> reject(new Error(`Falha ao carregar ${src}`)));
            return;
          }
          const script = document.createElement('script');
          script.src = src;
          script.async = true;
          script.defer = true;
          script.onload = ()=> resolve();
          script.onerror = ()=> reject(new Error(`Falha ao carregar ${src}`));
          document.head.appendChild(script);
        }catch(err){
          reject(err);
        }
      });
      __scriptLoadCache.set(src, promise);
      return promise;
    }

    const GOOGLE_CALENDAR_SCOPES = 'https://www.googleapis.com/auth/calendar https://www.googleapis.com/auth/userinfo.email';
    const GOOGLE_CALENDAR_DISCOVERY_URL = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';

    const googleCalendarIntegration = (()=>{
      const state = {
        connectBtn: null,
        disconnectBtn: null,
        statusEl: null,
        clientId: '',
        calendarId: 'primary',
        tokenClient: null,
        tokenClientClientId: '',
        accessToken: null,
        tokenExpiresAt: 0,
        email: '',
        connected: false,
        loading: false,
        statusMessage: '',
        loadError: null,
        activeRequests: 0,
        syncing: false,
        posts: [],
        pendingCreates: {},
        pendingUpdates: {},
        pendingDeletes: {},
        processingPending: false
      };
      let googleApisPromise = null;

      function copyPost(post){
        if(!post) return null;
        const clone = { ...post };
        if(Array.isArray(post.mediaUrls)) clone.mediaUrls = [...post.mediaUrls];
        if(Array.isArray(post.reviewNotes)) clone.reviewNotes = [...post.reviewNotes];
        if(Array.isArray(post.approvedSlides)) clone.approvedSlides = [...post.approvedSlides];
        if(Array.isArray(post.internalApprovedSlides)) clone.internalApprovedSlides = [...post.internalApprovedSlides];
        return clone;
      }

      function beginSync(){
        state.activeRequests += 1;
        state.syncing = state.activeRequests > 0;
        updateUi();
      }
      function endSync(){
        state.activeRequests = Math.max(0, state.activeRequests - 1);
        state.syncing = state.activeRequests > 0;
        updateUi();
      }

      function updateUi(){
        if(state.connectBtn){
          state.connectBtn.disabled = state.loading || (!state.connected && !state.clientId);
          state.connectBtn.textContent = state.connected ? (state.loading ? 'Conectando...' : 'Atualizar conex√£o') : (state.loading ? 'Conectando...' : 'Conectar Google Calendar');
        }
        if(state.disconnectBtn){
          state.disconnectBtn.style.display = state.connected ? '' : 'none';
          state.disconnectBtn.disabled = state.loading;
        }
        if(state.statusEl){
          const parts = [];
          if(state.statusMessage){
            parts.push(state.statusMessage);
          }else if(!state.clientId){
            parts.push('Configure o Client ID do Google Calendar para habilitar a integra√ß√£o.');
          }else if(state.connected){
            parts.push(state.email ? `Conectado como ${state.email}` : 'Conectado ao Google Calendar.');
          }else if(state.loadError){
            parts.push('Integra√ß√£o do Google Calendar indispon√≠vel no momento.');
          }else{
            parts.push('N√£o conectado.');
          }
          if(state.syncing){
            parts.push('Sincronizando‚Ä¶');
          }
          state.statusEl.textContent = parts.join(' ‚Ä¢ ');
        }
      }

      function setStatusMessage(message, options = {}){
        state.statusMessage = message || '';
        updateUi();
        if(options.toast && typeof mgToast === 'function' && message){
          mgToast(message);
        }
      }

      async function ensureApisLoaded(){
        if(googleApisPromise){
          return googleApisPromise;
        }
        googleApisPromise = (async ()=>{
          await loadExternalScript('https://accounts.google.com/gsi/client', ()=> typeof window !== 'undefined' && window.google && window.google.accounts);
          await loadExternalScript('https://apis.google.com/js/api.js', ()=> typeof window !== 'undefined' && window.gapi && typeof window.gapi.load === 'function');
          await new Promise((resolve, reject)=>{
            try{
              window.gapi.load('client', { callback: resolve, onerror: ()=> reject(new Error('Falha ao carregar cliente Google API')) });
            }catch(err){
              reject(err);
            }
          });
          await window.gapi.client.load(GOOGLE_CALENDAR_DISCOVERY_URL);
          state.loadError = null;
        })();
        try{
          await googleApisPromise;
        }catch(err){
          state.loadError = err;
          googleApisPromise = null;
          throw err;
        }
        return googleApisPromise;
      }

      function ensureTokenClient(){
        if(!state.clientId){
          throw new Error('Client ID do Google Calendar n√£o configurado.');
        }
        if(state.tokenClient && state.tokenClientClientId === state.clientId){
          return state.tokenClient;
        }
        const oauth2 = window.google?.accounts?.oauth2;
        if(!oauth2 || typeof oauth2.initTokenClient !== 'function'){
          throw new Error('Biblioteca de autentica√ß√£o Google indispon√≠vel.');
        }
        state.tokenClient = oauth2.initTokenClient({
          client_id: state.clientId,
          scope: GOOGLE_CALENDAR_SCOPES,
          callback: ()=>{}
        });
        state.tokenClientClientId = state.clientId;
        return state.tokenClient;
      }

      async function requestAccessToken({ interactive = false } = {}){
        await ensureApisLoaded();
        ensureTokenClient();
        return new Promise((resolve, reject)=>{
          try{
            state.tokenClient.callback = (response)=>{
              if(response?.error){
                reject(new Error(response.error));
                return;
              }
              const token = response?.access_token || '';
              if(token){
                state.accessToken = token;
                const expires = Number(response?.expires_in);
                state.tokenExpiresAt = Number.isFinite(expires) ? Date.now() + (expires * 1000) - 60000 : Date.now() + 1800000;
                try{
                  if(window.gapi?.client){
                    window.gapi.client.setToken({ access_token: token });
                  }
                }catch(_err){}
              }
              resolve(token);
            };
            state.tokenClient.requestAccessToken({ prompt: interactive ? 'consent' : '' });
          }catch(err){
            reject(err);
          }
        });
      }

      async function ensureAccessToken({ interactive = false } = {}){
        if(state.accessToken && state.tokenExpiresAt && Date.now() < state.tokenExpiresAt){
          return state.accessToken;
        }
        try{
          return await requestAccessToken({ interactive });
        }catch(err){
          if(interactive){
            throw err;
          }
          console.warn('Falha ao obter token do Google Calendar', err);
          return '';
        }
      }

      async function fetchGoogleEmail(token){
        if(!token) return '';
        try{
          const response = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
            headers: { Authorization: `Bearer ${token}` }
          });
          if(!response.ok) return '';
          const data = await response.json();
          return (data && data.email) ? data.email : '';
        }catch(_err){
          return '';
        }
      }

      function formatStatusLabel(status){
        switch((status||'').toLowerCase()){
          case 'aprovado': return 'Aprovado';
          case 'revisar': return 'Revisar';
          case 'pendente': return 'Pendente';
          default:
            return status ? (status.charAt(0).toUpperCase() + status.slice(1)) : '';
        }
      }

      function formatTargetLabel(target){
        return (target||'').toLowerCase() === 'stories' ? 'Stories' : 'Feed';
      }

      function computeEventDates(dateISO){
        const base = dateISO ? new Date(`${dateISO}T00:00:00`) : new Date();
        if(Number.isNaN(base.getTime())){
          const today = new Date();
          today.setHours(0,0,0,0);
          base.setTime(today.getTime());
        }
        const start = new Date(base.getTime());
        start.setHours(0,0,0,0);
        const end = new Date(start.getTime());
        end.setDate(end.getDate() + 1);
        const fmt = (d)=> d.toISOString().slice(0,10);
        return { start: fmt(start), end: fmt(end) };
      }

      function buildEventPayload(post){
        const safe = post || {};
        const { start, end } = computeEventDates(safe.dateISO);
        const statusLabel = formatStatusLabel(safe.status || '');
        const targetLabel = formatTargetLabel(safe.target || '');
        const summaryParts = [];
        if(statusLabel) summaryParts.push(statusLabel);
        if(targetLabel) summaryParts.push(targetLabel);
        const firstLine = (safe.desc || '').split(/\r?\n/).map(t=>t.trim()).find(Boolean) || '';
        if(firstLine){
          summaryParts.push(firstLine);
        }else if(!summaryParts.length){
          summaryParts.push('Post agendado');
        }
        let summary = summaryParts.join(' ‚Ä¢ ').trim();
        if(summary.length > 120){
          summary = summary.slice(0, 117).trimEnd() + '‚Ä¶';
        }
        const descriptionParts = [];
        descriptionParts.push(`Destino: ${targetLabel}`);
        if(statusLabel) descriptionParts.push(`Status: ${statusLabel}`);
        const tenant = (typeof TENANT === 'string' && TENANT) ? TENANT : '';
        const clientKey = (typeof getClientKey === 'function') ? (getClientKey() || '') : '';
        if(tenant) descriptionParts.push(`Cliente: ${tenant}`);
        if(clientKey && clientKey !== tenant) descriptionParts.push(`Chave: ${clientKey}`);
        if(safe.desc){
          descriptionParts.push('');
          descriptionParts.push(safe.desc);
        }
        const panelUrl = (typeof location !== 'undefined' && location?.href) ? location.href.split('#')[0] : '';
        if(panelUrl){
          descriptionParts.push('');
          descriptionParts.push(`Painel: ${panelUrl}`);
        }
        return {
          summary,
          description: descriptionParts.join('\n'),
          start: { date: start },
          end: { date: end },
          extendedProperties: {
            private: {
              mgPostId: safe.id || '',
              mgTenant: tenant || ''
            }
          }
        };
      }

      async function updatePostDoc(postId, data){
        const uid = auth.currentUser?.uid;
        if(!uid || !postId || !data) return;
        try{
          await updateDoc(doc(db, 'usuarios', uid, 'posts', postId), data);
        }catch(err){
          console.warn('updatePostDoc (Google Calendar)', err);
        }
      }

      async function syncEvent(post, mode){
        if(!post || !post.id || !state.connected){
          return false;
        }
        if(!state.clientId){
          setStatusMessage('Client ID do Google Calendar n√£o configurado.');
          return false;
        }
        if(mode !== 'delete' && !post.dateISO){
          console.warn('Post sem data n√£o ser√° sincronizado com o Google Calendar.', post);
          return false;
        }
        beginSync();
        try{
          const token = await ensureAccessToken({ interactive: false });
          if(!token){
            throw new Error('Token do Google Calendar ausente.');
          }
          const calendarId = encodeURIComponent(state.calendarId || 'primary');
          if(mode === 'delete'){
            if(!post.googleEventId){
              return true;
            }
            const response = await fetch(`https://www.googleapis.com/calendar/v3/calendars/${calendarId}/events/${encodeURIComponent(post.googleEventId)}`,{
              method: 'DELETE',
              headers: { Authorization: `Bearer ${token}` }
            });
            if(response.status !== 204 && response.status !== 200 && response.status !== 404){
              const txt = await response.text();
              throw new Error(txt || 'Falha ao excluir evento.');
            }
            return true;
          }
          const payload = buildEventPayload(post);
          const headers = {
            Authorization: `Bearer ${token}`,
            'Content-Type': 'application/json'
          };
          if(mode === 'update' && post.googleEventId){
            const response = await fetch(`https://www.googleapis.com/calendar/v3/calendars/${calendarId}/events/${encodeURIComponent(post.googleEventId)}`, {
              method: 'PATCH',
              headers,
              body: JSON.stringify(payload)
            });
            if(response.status === 404){
              post.googleEventId = '';
              await updatePostDoc(post.id, { googleEventId: '', googleCalendarSyncedAt: serverTimestamp() });
              return await syncEvent(post, 'create');
            }
            if(!response.ok){
              const txt = await response.text();
              throw new Error(txt || 'Falha ao atualizar evento.');
            }
            await updatePostDoc(post.id, { googleCalendarSyncedAt: serverTimestamp() });
            return true;
          }else{
            const response = await fetch(`https://www.googleapis.com/calendar/v3/calendars/${calendarId}/events`, {
              method: 'POST',
              headers,
              body: JSON.stringify(payload)
            });
            if(!response.ok){
              const txt = await response.text();
              throw new Error(txt || 'Falha ao criar evento.');
            }
            const data = await response.json();
            if(data?.id){
              post.googleEventId = data.id;
              await updatePostDoc(post.id, { googleEventId: data.id, googleCalendarSyncedAt: serverTimestamp() });
            }
            return true;
          }
        }catch(err){
          console.error('syncEvent Google Calendar', err);
          setStatusMessage('Falha ao sincronizar com o Google Calendar.');
          return false;
        }finally{
          endSync();
        }
      }

      async function processPendingActions(){
        if(!state.connected || state.processingPending){
          return;
        }
        state.processingPending = true;
        updateUi();
        try{
          const snapshotMap = new Map();
          if(Array.isArray(state.posts)){
            state.posts.forEach(p=>{
              if(p && p.id){
                snapshotMap.set(p.id, copyPost(p));
              }
            });
          }
          const deletes = Object.values(state.pendingDeletes||{});
          for(const pending of deletes){
            if(!pending) continue;
            await syncEvent(pending, 'delete');
            delete state.pendingDeletes[pending.id];
            snapshotMap.delete(pending.id);
          }
          const creates = Object.values(state.pendingCreates||{});
          for(const pending of creates){
            if(!pending) continue;
            const latest = snapshotMap.get(pending.id) || pending;
            await syncEvent(latest, latest.googleEventId ? 'update' : 'create');
            delete state.pendingCreates[pending.id];
            delete state.pendingUpdates[pending.id];
            snapshotMap.set(latest.id, copyPost(latest));
          }
          const updates = Object.values(state.pendingUpdates||{});
          for(const pending of updates){
            if(!pending) continue;
            const latest = snapshotMap.get(pending.id) || pending;
            await syncEvent(latest, latest.googleEventId ? 'update' : 'create');
            delete state.pendingUpdates[pending.id];
            snapshotMap.set(latest.id, copyPost(latest));
          }
          for(const post of snapshotMap.values()){
            if(post && post.id && !post.googleEventId){
              await syncEvent(post, 'create');
            }
          }
        }catch(err){
          console.error('processPendingActions Google Calendar', err);
          setStatusMessage('Falha ao sincronizar pend√™ncias do Google Calendar.');
        }finally{
          state.processingPending = false;
          updateUi();
        }
      }

      async function connect(interactive = true){
        if(state.loading){
          return state.connected;
        }
        if(!state.clientId){
          setStatusMessage('Client ID do Google Calendar n√£o configurado.');
          return false;
        }
        state.loading = true;
        updateUi();
        try{
          await ensureApisLoaded();
          const token = await ensureAccessToken({ interactive });
          if(!token){
            throw new Error('Token ausente.');
          }
          const email = await fetchGoogleEmail(token);
          if(email) state.email = email;
          state.connected = true;
          if(!state.statusMessage){
            setStatusMessage(email ? `Conectado como ${email}` : 'Google Calendar conectado.');
          }else{
            updateUi();
          }
          await processPendingActions();
          return true;
        }catch(err){
          console.error('Google Calendar connect', err);
          state.connected = false;
          if(interactive){
            setStatusMessage('N√£o foi poss√≠vel conectar ao Google Calendar.');
          }else{
            updateUi();
          }
          return false;
        }finally{
          state.loading = false;
          updateUi();
        }
      }

      function disconnect(){
        if(state.loading){
          return;
        }
        try{
          if(state.accessToken && window.google?.accounts?.oauth2?.revoke){
            window.google.accounts.oauth2.revoke(state.accessToken, ()=>{});
          }
        }catch(err){
          console.warn('Falha ao revogar token do Google Calendar', err);
        }
        state.accessToken = null;
        state.tokenExpiresAt = 0;
        state.connected = false;
        state.email = '';
        state.tokenClient = null;
        state.tokenClientClientId = '';
        try{
          if(window.gapi?.client){
            window.gapi.client.setToken(null);
          }
        }catch(_err){}
        setStatusMessage('Google Calendar desconectado.');
      }

      return {
        setDomRefs({ connectBtn, disconnectBtn, statusEl } = {}){
          if(connectBtn && !connectBtn.dataset.googleCalendarBound){
            connectBtn.dataset.googleCalendarBound = '1';
            connectBtn.addEventListener('click', ()=> connect(true));
          }
          if(disconnectBtn && !disconnectBtn.dataset.googleCalendarBound){
            disconnectBtn.dataset.googleCalendarBound = '1';
            disconnectBtn.addEventListener('click', ()=> disconnect());
          }
          if(connectBtn) state.connectBtn = connectBtn;
          if(disconnectBtn) state.disconnectBtn = disconnectBtn;
          if(statusEl) state.statusEl = statusEl;
          updateUi();
        },
        updateConfigFromProfile(profile){
          const dataset = document.body?.dataset || {};
          const globalClientId = typeof window !== 'undefined' ? (window.GOOGLE_CALENDAR_CLIENT_ID || '') : '';
          const globalCalendarId = typeof window !== 'undefined' ? (window.GOOGLE_CALENDAR_CALENDAR_ID || window.GOOGLE_CALENDAR_ID || '') : '';
          const profileIntegration = profile?.integrations?.googleCalendar || {};
          const profileRoot = profile?.googleCalendar || {};
          const newClientId = (profileIntegration.clientId || profileIntegration.clientID || profile?.googleCalendarClientId || profile?.googleCalendarClientID || profileRoot.clientId || profileRoot.clientID || dataset.googleCalendarClientId || globalClientId || '').trim();
          const newCalendarIdRaw = profileIntegration.calendarId || profile?.googleCalendarCalendarId || profile?.googleCalendarId || profileRoot.calendarId || dataset.googleCalendarCalendarId || dataset.googleCalendarId || globalCalendarId || '';
          const newCalendarId = (newCalendarIdRaw || '').trim() || 'primary';
          const prevClientId = state.clientId;
          state.clientId = newClientId;
          state.calendarId = newCalendarId;
          if(prevClientId && newClientId && prevClientId !== newClientId){
            disconnect();
          }else{
            updateUi();
          }
        },
        notifyPostsLoaded(posts){
          state.posts = Array.isArray(posts) ? posts.map(copyPost) : [];
          if(state.connected){
            processPendingActions();
          }
        },
        handlePostCreated(post){
          const copy = copyPost(post);
          if(!copy || !copy.id) return Promise.resolve(false);
          if(state.connected){
            return syncEvent(copy, copy.googleEventId ? 'update' : 'create');
          }
          state.pendingCreates[copy.id] = copy;
          return Promise.resolve(false);
        },
        handlePostUpdated(post){
          const copy = copyPost(post);
          if(!copy || !copy.id) return Promise.resolve(false);
          if(state.connected){
            return syncEvent(copy, copy.googleEventId ? 'update' : 'create');
          }
          state.pendingUpdates[copy.id] = copy;
          return Promise.resolve(false);
        },
        handlePostDeleted(post){
          const copy = copyPost(post);
          if(!copy || !copy.id) return Promise.resolve(false);
          delete state.pendingCreates[copy.id];
          delete state.pendingUpdates[copy.id];
          if(state.connected){
            return syncEvent(copy, 'delete');
          }
          if(copy.googleEventId){
            state.pendingDeletes[copy.id] = { id: copy.id, googleEventId: copy.googleEventId };
          }
          return Promise.resolve(false);
        },
        ensureConnected(){
          return connect(false);
        },
        isConnected(){
          return state.connected;
        },
        setStatusMessage: setStatusMessage
      };
    })();
    window.googleCalendarIntegration = googleCalendarIntegration;

    // ================================================================
    // üîê API KEY REMOVIDA DO FRONTEND POR SEGURAN√áA
    // A API key agora fica no backend (Firebase Functions)
    // Use a fun√ß√£o callAIProxy() para fazer chamadas √† IA
    // ================================================================

    // ================================================================
    // CONFIGURA√á√ÉO CENTRALIZADA DE IA - F√ÅCIL TROCA DE MODELOS
    // ================================================================
    // Para trocar o modelo, basta alterar o valor de 'model' abaixo
    // Lista de modelos dispon√≠veis em: https://openrouter.ai/models
    // 
    // MODELOS RECOMENDADOS (custo/benef√≠cio):
    // - 'google/gemini-2.5-flash'        ‚Üí R√°pido e barato ($0.15/M in, $0.60/M out)
    // - 'google/gemini-2.5-pro'          ‚Üí Mais inteligente ($1.25/M in, $10/M out)
    // - 'anthropic/claude-sonnet-4'      ‚Üí Muito inteligente ($3/M in, $15/M out)
    // - 'openai/gpt-4o-mini'             ‚Üí Barato ($0.15/M in, $0.60/M out)
    // - 'openai/gpt-4o'                  ‚Üí Poderoso ($5/M in, $15/M out)
    // ================================================================
    window.IA_CONFIG = {
      model: 'google/gemini-2.5-flash',
      pricing: {
        input: 0.15,   // Custo por milh√£o de tokens de entrada
        output: 0.60   // Custo por milh√£o de tokens de sa√≠da
      },
      maxTokens: 8000,
      temperature: {
        default: 0.7,
        creative: 0.85,
        longform: 0.8
      }
    };


    // Fun√ß√£o global para extrair TENANT
    window.getTenantFromHostOrPath = function getTenantFromHostOrPath(){
      const host = location.hostname, parts = host.split(".");
      if(parts.length>=3 && parts[0]!=="dashboard") return parts[0].replace(/[^a-zA-Z0-9]/g,"").toLowerCase();
      const seg = location.pathname.split("/").filter(Boolean)[0] || "";
      return seg ? seg.replace(/[^a-zA-Z0-9]/g,"").toLowerCase() : null;
    };
    
    let TENANT = window.getTenantFromHostOrPath();
    window.TENANT = TENANT;
    if (TENANT) {
      try {
        document.documentElement.dataset.tenant = TENANT;
        document.body.setAttribute('data-client-id', TENANT);
      } catch(_) {}
    } else {
      console.warn('TENANT ausente; recursos de cliente ser√£o ocultados.');
    }


    const firebaseConfig = {
      apiKey: "AIzaSyD4CbPQWrwOcfANX3ar0ibmGN20ffsRCqo",
      authDomain: "mediagrowth-a5349.firebaseapp.com",
      projectId: "mediagrowth-a5349",
      storageBucket: "mediagrowth-a5349.firebasestorage.app",
      messagingSenderId: "1074237637946",
      appId: "1:1074237637946:web:cf5008b649bbb4d7d13c03"
    };

    let app;
    if (TENANT) {
      console.log('üè¢ Initializing Firebase with TENANT:', TENANT);
      app = getApps().find(a => a.name === TENANT) || initializeApp(firebaseConfig, TENANT);
    } else {
      console.log('üè¢ Initializing Firebase without TENANT');
      app = getApps()[0] || initializeApp(firebaseConfig);
    }
  const auth = getAuth(app); const db = getFirestore(app); const functions = getFunctions(app);
    console.log('‚úÖ Firebase initialized successfully');
    console.log('Auth:', auth);
    console.log('DB:', db);
    // exp√µe inst√¢ncias globais para outros scripts (ex.: planilha Macro)
    window.auth = auth;
    window.onAuthStateChanged = onAuthStateChanged;
    
    // ================================================================
    // üîê FUN√á√ÉO PARA CHAMAR A IA VIA BACKEND (API KEY SEGURA)
    // ================================================================
    // Esta fun√ß√£o usa Firebase Functions como proxy para a API OpenRouter
    // A API key nunca √© exposta no frontend
    // ================================================================
    window.callAIProxy = async function(model, messages, userId, maxTokens, temperature) {
      // URLs dos proxies (tentar√° alternativas se uma falhar)
      const AI_PROXY_URLS = [
        'https://us-central1-mediagrowth-a5349.cloudfunctions.net/aiProxy',
        'https://aiproxy-2uquufjjxa-uc.a.run.app'
      ];
      
      let lastError = null;
      
      for (const AI_PROXY_URL of AI_PROXY_URLS) {
        try {
          const requestBody = {
            model: model || window.IA_CONFIG.model,
            messages: messages,
            userId: userId || (auth.currentUser?.uid || 'anonymous'),
            stream: false
          };
          
          // Adicionar par√¢metros opcionais se fornecidos
          if (maxTokens) requestBody.max_tokens = maxTokens;
          if (temperature !== undefined) requestBody.temperature = temperature;
          
          console.log('ü§ñ [AI Proxy] Tentando URL:', AI_PROXY_URL);
          
          const response = await fetch(AI_PROXY_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
          });
          
          const data = await response.json();
          
          // Verificar erros espec√≠ficos de API key
          if (data?.error) {
            const errorMsg = (data.error || '').toLowerCase();
            // Erros de API key - n√£o tentar outras URLs, reportar erro claro
            if (errorMsg.includes('user not found') || 
                errorMsg.includes('api key') || 
                errorMsg.includes('unauthorized') ||
                errorMsg.includes('invalid_api_key') ||
                errorMsg.includes('not configured')) {
              console.error('üî¥ [AI Proxy] Erro de API Key:', data.error);
              const errorDetalhado = new Error(
                '‚ö†Ô∏è Servi√ßo de I.A. temporariamente indispon√≠vel. ' +
                'A chave de API precisa ser reconfigurada. ' +
                'Por favor, entre em contato com o suporte t√©cnico.'
              );
              errorDetalhado.isAPIKeyError = true;
              errorDetalhado.originalError = data.error;
              throw errorDetalhado;
            }
          }
          
          if (!response.ok) {
            lastError = new Error(data?.error || `HTTP ${response.status}`);
            console.warn('üü° [AI Proxy] URL falhou, tentando pr√≥xima...', lastError.message);
            continue; // Tentar pr√≥xima URL
          }
          
          console.log('üü¢ [AI Proxy] Sucesso via:', AI_PROXY_URL);
          return data;
          
        } catch (error) {
          lastError = error;
          // Se for erro de API key, n√£o tentar outras URLs
          if (error.isAPIKeyError) {
            throw error;
          }
          console.warn('üü° [AI Proxy] Erro na URL, tentando pr√≥xima...', error.message);
        }
      }
      
      // Se chegou aqui, todas as URLs falharam
      console.error('üî¥ [AI Proxy] Todas as URLs falharam:', lastError);
      throw lastError || new Error('Servi√ßo de I.A. indispon√≠vel');
    };
    
    // Vari√°vel global para sess√£o admin fake
    window._adminFakeUser = null;
    window.getCurrentUser = function() {
      return window._adminFakeUser || auth.currentUser;
    };
    
    const provider = new GoogleAuthProvider(); setPersistence(auth, browserLocalPersistence).catch(console.error);
    let storageInitTried=false;
    let userDocUnsub = null;

    // ====== CONSTANTES GLOBAIS (usadas em v√°rias partes do sistema) ======
    const STATUS_OPTIONS = [
      {value:'nao-iniciado', label:'N√£o iniciado', color:'#1e3a8a'},
      {value:'em-andamento', label:'Em andamento', color:'#b45309'},
      {value:'bloqueado', label:'Bloqueado', color:'#7f1d1d'},
      {value:'concluido', label:'Conclu√≠do', color:'#14532d'},
      {value:'prioridade', label:'Prioridade', color:'#374151'},
      {value:'prioridade-grupo', label:'Prioridade/Grupo', color:'#374151'},
      {value:'concluido-grupo', label:'Conclu√≠do/Grupo', color:'#14532d'}
    ];
    const TAG_OPTIONS = ['ROI','VITRINE/ENGAJAMENTO','NOVAS IDEIAS','RELACIONAMENTO','I.A','GOOGLE BUSINESS'];
    let RESP_OPTIONS = ['Bruno','Camilla','Clailton','Guilherme','Mediagrowth','Cliente','Theo'];
    
    // ===== SINCRONIZA√á√ÉO TIME <-> PLANEJAMENTO =====
    function syncTeamToRespOptions(teamMembers) {
      // Pega nomes √∫nicos dos membros do time
      const teamNames = teamMembers.map(m => m.name).filter(Boolean);
      
      // Combina com membros existentes em RESP_OPTIONS (evita duplicatas)
      const combined = new Set([...RESP_OPTIONS, ...teamNames]);
      RESP_OPTIONS = Array.from(combined).sort();
      
      // Atualiza todos os selects de respons√°vel na p√°gina
      updateAllResponsavelSelects();
    }
    
    // Fun√ß√£o para carregar membros do time silenciosamente (apenas para sincroniza√ß√£o)
    async function loadTeamMembersSilently() {
      if(!auth?.currentUser) return;
      try {
        const teamSnapshot = await getDocs(collection(db, 'usuarios', auth.currentUser.uid, 'team'));
        const allMembers = [];
        teamSnapshot.forEach(doc => {
          allMembers.push({ id: doc.id, ...doc.data() });
        });
        
        // Sincroniza membros com RESP_OPTIONS
        syncTeamToRespOptions(allMembers);
        console.log('‚úÖ Membros do time carregados e sincronizados com RESP_OPTIONS');
      } catch(err) {
        console.error('Erro ao carregar membros do time:', err);
      }
    }
    
    function updateAllResponsavelSelects() {
      // Atualiza select do modal IA
      if(typeof populatePlanningDropdowns === 'function') {
        populatePlanningDropdowns();
      }
      
      // Atualiza selects na tabela de planejamento
      document.querySelectorAll('.demandas-table .col-resp select').forEach(select => {
        const currentValue = select.value;
        select.innerHTML = '<option value=""></option>' + 
          RESP_OPTIONS.map(r => `<option value="${r}" ${currentValue === r ? 'selected' : ''}>${r}</option>`).join('');
      });
      
      // Atualiza filtro de respons√°vel
      const filterSelect = document.getElementById('demandaResponsavelFilter');
      if(filterSelect) {
        const currentValue = filterSelect.value;
        const options = filterSelect.querySelectorAll('option:not(:first-child)');
        options.forEach(opt => opt.remove());
        RESP_OPTIONS.forEach(resp => {
          const opt = document.createElement('option');
          opt.value = resp;
          opt.textContent = resp;
          if(currentValue === resp) opt.selected = true;
          filterSelect.appendChild(opt);
        });
      }
    }
    
    async function loadExistingResponsaveisToTeam() {
      // Carrega respons√°veis √∫nicos do planejamento para o time
      if(!auth?.currentUser || !DEMANDAS) return;
      
      try {
        const uniqueResponsaveis = [...new Set(
          DEMANDAS.map(d => d.responsavel).filter(r => r && r.trim())
        )];
        
        // Verifica quais j√° existem no time
        const teamSnapshot = await getDocs(collection(db, 'usuarios', auth.currentUser.uid, 'team'));
        const existingNames = new Set();
        teamSnapshot.forEach(doc => {
          const member = doc.data();
          if(member.name) existingNames.add(member.name);
        });
        
        // Adiciona respons√°veis que n√£o est√£o no time
        const batch = [];
        for(const resp of uniqueResponsaveis) {
          if(!existingNames.has(resp)) {
            batch.push(addDoc(collection(db, 'usuarios', auth.currentUser.uid, 'team'), {
              name: resp,
              email: '',
              role: 'editor',
              addedAt: serverTimestamp(),
              autoImported: true
            }));
          }
        }
        
        if(batch.length > 0) {
          await Promise.all(batch);
          console.log(`‚úÖ Importados ${batch.length} respons√°veis do planejamento para o time`);
        }
      } catch(err) {
        console.error('Erro ao importar respons√°veis:', err);
      }
    }
    // ====================================================================

  let inviteHelperApp = null;
  let inviteHelperAuth = null;
  let inviteAuthPersistenceReady = false;
  let clientInviteSubmitting = false;
  let clientRoleActionRunning = false;
  let clientAccountsLoading = false;
  let clientAccountsError = null;
  let clientAccountsUnsub = null;
  let clientAccountsNavigationKey = '';
  let clientAccounts = [];
  let clientAccountsStatusMessage = { text: '', type: null };
  const clientAccountsTargets = new Set();
  const clientAccountsStatusEls = new Set();

    function setClientInviteStatus(statusEl, message, type){
      if(!statusEl) return;
      statusEl.textContent = message || '';
      statusEl.classList.remove('success','error');
      if(type === 'success' || type === 'error'){
        statusEl.classList.add(type);
      }
    }

    async function ensureInviteAuth(){
      if(inviteHelperAuth) return inviteHelperAuth;
      const baseName = `${app?.name || 'default'}-client-invite`;
      inviteHelperApp = getApps().find(a => a.name === baseName) || initializeApp(firebaseConfig, baseName);
      inviteHelperAuth = getAuth(inviteHelperApp);
      if(!inviteAuthPersistenceReady){
        try{
          await setPersistence(inviteHelperAuth, inMemoryPersistence);
        }catch(err){
          console.warn('client invite persistence', err);
        }
        inviteAuthPersistenceReady = true;
      }
      return inviteHelperAuth;
    }

    async function tornarAgencia(){
      const user = auth.currentUser;
      if(!user) throw new Error('Sess√£o expirada. Fa√ßa login novamente.');
      const func = httpsCallable(functions, 'becomeAgency');
      await func();
      await user.getIdToken(true);
    }

    async function entrarCliente(clientId){
      const user = auth.currentUser;
      if(!user) throw new Error('Sess√£o expirada. Fa√ßa login novamente.');
      const func = httpsCallable(functions, 'selectClient');
      await func({ clientId });
      await user.getIdToken(true);
    }

    function buildClientKeyCandidates(name, email){
      const candidates = [];
      const normalizedName = normalizeClientKey(name || '');
      if(normalizedName) candidates.push(normalizedName.toLowerCase());
      const emailLocal = (email || '').split('@')[0] || '';
      const normalizedEmail = normalizeClientKey(emailLocal);
      if(normalizedEmail){
        const lower = normalizedEmail.toLowerCase();
        if(!candidates.includes(lower)) candidates.push(lower);
      }
      candidates.push(`client-${Date.now()}`);
      candidates.push(`client-${uuid().slice(0,6)}`);
      return candidates;
    }

    async function resolveUniqueClientKey(agencyUid, name, email){
      const candidates = buildClientKeyCandidates(name, email);
      for(const base of candidates){
        if(!base) continue;
        let attempt = base;
        let suffix = 0;
        while(suffix < 6){
          const ref = doc(db, 'usuarios', agencyUid, 'clients', attempt);
          const snap = await getDoc(ref);
          if(!snap.exists()){
            return attempt;
          }
          suffix += 1;
          attempt = `${base}-${suffix}`;
        }
      }
      throw new Error('N√£o foi poss√≠vel gerar uma chave √∫nica para o cliente.');
    }

    async function createOrUpdateClientDoc(agencyUid, clientKey, payload){
      const ref = doc(db, 'usuarios', agencyUid, 'clients', clientKey);
      const basePayload = {
        agencyId: agencyUid,
        clientId: clientKey
      };
      await setDoc(ref, { ...basePayload, ...payload }, { merge: true });
      return ref;
    }

    async function persistClientUserProfile(clientUid, agencyUid, clientKey, displayName, email){
      const now = serverTimestamp();
      await setDoc(doc(db, 'usuarios', clientUid), {
        role: 'client',
        agencyId: agencyUid,
        clientId: clientKey,
        displayName,
        email,
        updatedAt: now,
        createdAt: now
      }, { merge: true });
    }

    async function grantClientClaimsToUser(clientUid, agencyUid, clientKey){
      try{
        const callable = httpsCallable(functions, 'grantClientClaims');
        await callable({ clientUid, agencyUid, clientId: clientKey });
      }catch(err){
        console.warn('grantClientClaims', err);
        throw new Error('Convite criado, mas houve falha ao aplicar as permiss√µes do cliente.');
      }
    }

    async function registerClientUser(email, password){
      const inviteAuth = await ensureInviteAuth();
      const cred = await createUserWithEmailAndPassword(inviteAuth, email, password);
      return { auth: inviteAuth, user: cred.user };
    }

    async function inviteClientAccount({ name, email, password }){
      const agency = auth.currentUser;
      if(!agency) throw new Error('Sess√£o expirada. Fa√ßa login novamente para convidar o cliente.');
      const agencyUid = agency.uid;
      const clientKey = await resolveUniqueClientKey(agencyUid, name, email);
      let inviteAuthInstance = null;
      try{
        const { auth: inviteAuth, user: clientUser } = await registerClientUser(email, password);
        inviteAuthInstance = inviteAuth;
        const timestamp = serverTimestamp();
        await createOrUpdateClientDoc(agencyUid, clientKey, {
          displayName: name,
          contactEmail: email,
          clientUid: clientUser.uid,
          status: 'active',
          createdAt: timestamp,
          updatedAt: timestamp,
          createdBy: agencyUid,
          clientKey,
          slug: clientKey,
          lastInvitationAt: timestamp
        });
        await persistClientUserProfile(clientUser.uid, agencyUid, clientKey, name, email);
        await grantClientClaimsToUser(clientUser.uid, agencyUid, clientKey);
        return { clientKey, clientUid: clientUser.uid };
      }finally{
        if(inviteAuthInstance){
          try{ await signOut(inviteAuthInstance); }catch(_err){}
        }
      }
    }

    function attachClientInviteForm(form){
      if(!form || form.dataset.bound === 'true') return;
      form.dataset.bound = 'true';
      const nameInput = form.querySelector('#inviteClientName');
      const emailInput = form.querySelector('#inviteClientEmail');
      const passwordInput = form.querySelector('#inviteClientPassword');
      const statusEl = form.querySelector('#inviteClientStatus');
      const submitBtn = form.querySelector('button[type="submit"]');
      form.addEventListener('submit', async (event)=>{
        event.preventDefault();
        if(clientInviteSubmitting) return;
        const name = nameInput?.value?.trim();
        const email = emailInput?.value?.trim();
        const password = passwordInput?.value || '';
        if(!name || !email || !password){
          setClientInviteStatus(statusEl, 'Preencha nome, e-mail e senha inicial.', 'error');
          return;
        }
        if(password.length < 6){
          setClientInviteStatus(statusEl, 'A senha inicial precisa ter ao menos 6 caracteres.', 'error');
          return;
        }
        clientInviteSubmitting = true;
        submitBtn?.setAttribute('disabled', 'true');
        setClientInviteStatus(statusEl, 'Criando acesso para o cliente...', null);
        try{
          await inviteClientAccount({ name, email, password });
          form.reset();
          setClientInviteStatus(statusEl, 'Convite criado e permiss√µes aplicadas.', 'success');
          try{ mgToast('Cliente convidado com sucesso!'); }catch(_toastErr){}
        }catch(err){
          console.error('inviteClientAccount', err);
          let message = 'N√£o foi poss√≠vel concluir o convite. Tente novamente.';
          if(err?.code === 'auth/email-already-in-use'){
            message = 'O e-mail informado j√° possui cadastro ativo.';
          }else if(err?.code === 'auth/invalid-email'){
            message = 'Informe um e-mail v√°lido para o cliente.';
          }else if(typeof err?.message === 'string' && err.message){
            message = err.message;
          }
          setClientInviteStatus(statusEl, message, 'error');
        }finally{
          clientInviteSubmitting = false;
          submitBtn?.removeAttribute('disabled');
        }
      });
    }

    function attachClientRoleActions(container){
      if(!container) return;
      const becomeBtn = container.querySelector('#becomeAgencyBtn');
      const enterBtn = container.querySelector('#enterClientBtn');
      const statusEl = container.querySelector('#clientRoleStatus') || container.querySelector('#inviteClientStatus');
      if(becomeBtn && !becomeBtn.dataset.bound){
        becomeBtn.dataset.bound = 'true';
        becomeBtn.addEventListener('click', async ()=>{
          if(clientRoleActionRunning) return;
          if(!auth?.currentUser){
            setClientInviteStatus(statusEl, 'Fa√ßa login para continuar.', 'error');
            return;
          }
          clientRoleActionRunning = true;
          becomeBtn.setAttribute('disabled', 'true');
          enterBtn?.setAttribute('disabled', 'true');
          setClientInviteStatus(statusEl, 'Atualizando permiss√µes da conta...', null);
          try{
            await tornarAgencia();
            setClientInviteStatus(statusEl, 'Agora sua conta √© uma Ag√™ncia ‚úÖ', 'success');
            try{ mgToast('Conta configurada como ag√™ncia.'); }catch(_err){}
          }catch(err){
            console.error('tornarAgencia', err);
            const message = typeof err?.message === 'string' && err.message
              ? err.message
              : 'N√£o foi poss√≠vel atualizar a conta para ag√™ncia.';
            setClientInviteStatus(statusEl, message, 'error');
          }finally{
            clientRoleActionRunning = false;
            becomeBtn.removeAttribute('disabled');
            enterBtn?.removeAttribute('disabled');
          }
        });
      }
      if(enterBtn && !enterBtn.dataset.bound){
        enterBtn.dataset.bound = 'true';
        enterBtn.addEventListener('click', async ()=>{
          if(clientRoleActionRunning) return;
          if(!auth?.currentUser){
            setClientInviteStatus(statusEl, 'Fa√ßa login para continuar.', 'error');
            return;
          }
          let clientId = prompt('Informe o ID do cliente:');
          if(clientId === null) return; // cancelado
          clientId = clientId.trim();
          if(!clientId){
            setClientInviteStatus(statusEl, 'Informe um ID de cliente v√°lido.', 'error');
            return;
          }
          clientRoleActionRunning = true;
          enterBtn.setAttribute('disabled', 'true');
          becomeBtn?.setAttribute('disabled', 'true');
          setClientInviteStatus(statusEl, `Entrando no cliente ${clientId}...`, null);
          try{
            await entrarCliente(clientId);
            const successMsg = `Voc√™ entrou no cliente: ${clientId}`;
            setClientInviteStatus(statusEl, successMsg, 'success');
            try{ mgToast(successMsg); }catch(_err){}
          }catch(err){
            console.error('entrarCliente', err);
            const message = typeof err?.message === 'string' && err.message
              ? err.message
              : 'N√£o foi poss√≠vel entrar no cliente informado.';
            setClientInviteStatus(statusEl, message, 'error');
          }finally{
            clientRoleActionRunning = false;
            enterBtn.removeAttribute('disabled');
            becomeBtn?.removeAttribute('disabled');
          }
        });
      }
    }

    function updateClientAccountsStatusEls(message, type){
      const text = message || '';
      const normalizedType = type === 'success' || type === 'error' ? type : null;
      [...clientAccountsStatusEls].forEach((el)=>{
        if(!el || !el.isConnected){
          clientAccountsStatusEls.delete(el);
          return;
        }
        setClientInviteStatus(el, text, normalizedType);
      });
    }

    function setClientAccountsStatus(message, type){
      clientAccountsStatusMessage = { text: message || '', type: type || null };
      updateClientAccountsStatusEls(clientAccountsStatusMessage.text, clientAccountsStatusMessage.type);
    }

    function ensureClientAccountsStatusForState(){
      if(clientAccountsStatusMessage.text){
        updateClientAccountsStatusEls(clientAccountsStatusMessage.text, clientAccountsStatusMessage.type);
        return;
      }
      if(clientAccountsLoading){
        updateClientAccountsStatusEls('Carregando clientes...', null);
        return;
      }
      if(clientAccountsError){
        updateClientAccountsStatusEls('N√£o foi poss√≠vel carregar os clientes no momento.', 'error');
        return;
      }
      updateClientAccountsStatusEls('', null);
    }

    function buildClientManagementUrl(clientKey){
      const raw = (clientKey || '').trim();
      if(!raw){
        return window.location.origin;
      }
      const safe = raw.replace(/[^a-zA-Z0-9-]/g, '').toLowerCase() || raw;
      const { protocol, hostname, origin } = window.location;
      const parts = hostname.split('.');
      if(parts.length >= 3){
        const newParts = [...parts];
        newParts[0] = safe;
        return `${protocol}//${newParts.join('.')}/`;
      }
      return `${origin.replace(/\/$/, '')}/${safe}/`;
    }

    async function handleClientAccountLaunch(button, clientKey){
      const targetKey = (clientKey || '').trim();
      if(!targetKey){
        setClientAccountsStatus('Cliente selecionado inv√°lido.', 'error');
        return;
      }
      if(!auth?.currentUser){
        setClientAccountsStatus('Fa√ßa login para entrar no cliente.', 'error');
        return;
      }
      if(clientAccountsNavigationKey){
        return;
      }
      let newTab = null;
      clientAccountsNavigationKey = targetKey;
      try{
        if(button){
          button.disabled = true;
        }
        setClientAccountsStatus(`Preparando acesso ao cliente ${targetKey}...`, null);
        newTab = window.open('', '_blank');
        if(newTab){
          try{ newTab.opener = null; }catch(_err){}
          try{
            newTab.document.write('<p style="font-family:Arial,Helvetica,sans-serif;padding:16px;color:#0f172a;">Carregando cliente...</p>');
          }catch(_err){}
        }
        await entrarCliente(targetKey);
        const destination = buildClientManagementUrl(targetKey);
        if(newTab){
          newTab.location.href = destination;
          setClientAccountsStatus(`Cliente ${targetKey} aberto em uma nova aba.`, 'success');
        }else{
          setClientAccountsStatus('Habilite pop-ups para abrir o cliente automaticamente. Abrindo link em nova aba.', 'error');
          window.open(destination, '_blank');
        }
      }catch(err){
        console.error('handleClientAccountLaunch', err);
        if(newTab && !newTab.closed){
          newTab.close();
        }
        const message = typeof err?.message === 'string' && err.message
          ? err.message
          : 'N√£o foi poss√≠vel abrir o cliente selecionado.';
        setClientAccountsStatus(message, 'error');
      }finally{
        clientAccountsNavigationKey = '';
        if(button){
          button.disabled = false;
        }
        ensureClientAccountsStatusForState();
      }
    }

    function renderClientAccountsList(target){
      if(!target){
        return;
      }
      if(!target.isConnected){
        clientAccountsTargets.delete(target);
        return;
      }
      if(!auth?.currentUser){
        target.innerHTML = '<p class="client-accounts-empty">Fa√ßa login para visualizar os clientes dispon√≠veis.</p>';
        return;
      }
      if(clientAccountsLoading){
        target.innerHTML = '<p class="client-accounts-empty">Carregando clientes...</p>';
        return;
      }
      if(clientAccountsError){
        target.innerHTML = '<p class="client-accounts-empty">N√£o foi poss√≠vel carregar os clientes agora.</p>';
        return;
      }
      if(!Array.isArray(clientAccounts) || clientAccounts.length === 0){
        const hint = USER_DATA?.role === 'agency'
          ? 'Convide um novo cliente para que ele apare√ßa nesta lista.'
          : 'Nenhum cliente vinculado √† sua conta ainda.';
        target.innerHTML = `<p class="client-accounts-empty">${escapeHtml(hint)}</p>`;
        return;
      }
      target.innerHTML = '';
      const fragment = document.createDocumentFragment();
      clientAccounts.forEach((client)=>{
        const key = client.clientKey || client.slug || client.id;
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'client-account-trigger';
        button.dataset.clientKey = key;
        const nameEl = document.createElement('span');
        nameEl.className = 'client-account-name';
        nameEl.textContent = client.displayName || client.name || key || 'Cliente';
        button.appendChild(nameEl);
        const metaParts = [];
        if(client.contactEmail){
          metaParts.push(client.contactEmail);
        }
        if(key){
          metaParts.push(key);
        }
        if(client.status && client.status !== 'active'){
          metaParts.push(client.status);
        }
        if(metaParts.length){
          const metaEl = document.createElement('span');
          metaEl.className = 'client-account-meta';
          metaEl.textContent = metaParts.join(' ‚Ä¢ ');
          button.appendChild(metaEl);
        }
        button.addEventListener('click', ()=>{
          handleClientAccountLaunch(button, key);
        });
        fragment.appendChild(button);
      });
      target.appendChild(fragment);
    }

    function notifyClientAccountsChanged(){
      [...clientAccountsTargets].forEach((target)=>{
        renderClientAccountsList(target);
      });
      ensureClientAccountsStatusForState();
    }

    function startClientAccountsListener(){
      if(clientAccountsUnsub || !auth?.currentUser){
        ensureClientAccountsStatusForState();
        return;
      }
      clientAccountsLoading = true;
      clientAccountsError = null;
      ensureClientAccountsStatusForState();
      try{
        const colRef = collection(db, 'usuarios', auth.currentUser.uid, 'clients');
        clientAccountsUnsub = onSnapshot(colRef, (snapshot)=>{
          clientAccounts = snapshot.docs.map((docSnap)=>{
            const data = docSnap.data() || {};
            return {
              id: docSnap.id,
              clientKey: data.clientKey || docSnap.id,
              slug: data.slug || '',
              displayName: data.displayName || data.name || docSnap.id,
              contactEmail: data.contactEmail || data.email || '',
              status: data.status || ''
            };
          }).sort((a, b)=>{
            const aLabel = (a.displayName || a.clientKey || '').toLowerCase();
            const bLabel = (b.displayName || b.clientKey || '').toLowerCase();
            if(aLabel < bLabel) return -1;
            if(aLabel > bLabel) return 1;
            return 0;
          });
          clientAccountsLoading = false;
          clientAccountsError = null;
          notifyClientAccountsChanged();
        }, (error)=>{
          console.warn('clientAccounts listener', error);
          clientAccountsLoading = false;
          clientAccountsError = error;
          clientAccounts = [];
          notifyClientAccountsChanged();
        });
      }catch(err){
        console.warn('startClientAccountsListener', err);
        clientAccountsLoading = false;
        clientAccountsError = err;
        clientAccounts = [];
        notifyClientAccountsChanged();
      }
    }

    function stopClientAccountsListener(){
      if(clientAccountsUnsub){
        try{ clientAccountsUnsub(); }catch(_err){}
        clientAccountsUnsub = null;
      }
      clientAccounts = [];
      clientAccountsLoading = false;
      clientAccountsError = null;
      clientAccountsNavigationKey = '';
      setClientAccountsStatus('', null);
      notifyClientAccountsChanged();
    }

    function attachClientAccountsList(container){
      if(!container) return;
      const listEl = container.querySelector('#clientAccountsList');
      const statusEl = container.querySelector('#clientAccountsStatus');
      if(statusEl){
        clientAccountsStatusEls.add(statusEl);
      }
      if(listEl){
        clientAccountsTargets.add(listEl);
        renderClientAccountsList(listEl);
      }
      ensureClientAccountsStatusForState();
      startClientAccountsListener();
    }

    /**
     * üõ°Ô∏è SISTEMA DE PROTE√á√ÉO CONTRA LIMITE DE 1MB
     * Valida tamanho do documento ANTES de salvar
     * Limpa automaticamente se necess√°rio
     */
    async function safeWriteUserDoc(fields, options = {}) {
      if(!auth?.currentUser) return { success: false, error: 'N√£o autenticado' };
      
      const MAX_SIZE = 1048576; // 1MB em bytes
      const WARNING_SIZE = 900000; // 900KB - ponto de alerta
      const CRITICAL_SIZE = 1000000; // ~976KB - limpeza autom√°tica
      
      try {
        // 1Ô∏è‚É£ Calcular tamanho do que vai ser salvo
        const dataStr = JSON.stringify(fields);
        const newDataSize = new Blob([dataStr]).size;
        
        console.log(`üõ°Ô∏è [safeWriteUserDoc] Validando salvamento...`);
        console.log(`üìè Tamanho dos novos dados: ${(newDataSize / 1024).toFixed(2)} KB`);
        
        // 2Ô∏è‚É£ Tentar obter documento atual para calcular tamanho total
        let currentDocSize = 0;
        try {
          const currentDoc = await getDoc(doc(db, 'usuarios', auth.currentUser.uid));
          if(currentDoc.exists()) {
            const currentDataStr = JSON.stringify(currentDoc.data());
            currentDocSize = new Blob([currentDataStr]).size;
            console.log(`üì¶ Tamanho do documento atual: ${(currentDocSize / 1024).toFixed(2)} KB`);
          }
        } catch(err) {
          console.warn('‚ö†Ô∏è N√£o foi poss√≠vel obter tamanho do documento atual:', err);
        }
        
        // 3Ô∏è‚É£ Estimar tamanho final (aproximado, pois merge pode sobrescrever)
        const estimatedSize = currentDocSize + newDataSize;
        console.log(`üìä Tamanho estimado final: ${(estimatedSize / 1024).toFixed(2)} KB / ${(MAX_SIZE / 1024).toFixed(2)} KB`);
        
        // 4Ô∏è‚É£ Se ultrapassar o limite, BLOQUEAR e for√ßar limpeza
        if(estimatedSize > MAX_SIZE) {
          console.error('üö® BLOQUEADO! Documento excederia 1MB');
          console.error(`üìè Estimativa: ${(estimatedSize / 1024).toFixed(2)} KB (limite: ${(MAX_SIZE / 1024).toFixed(2)} KB)`);
          console.error('üßπ Executando limpeza autom√°tica...');
          
          // Tentar reduzir documento automaticamente
          if(typeof reduzirDocumentoUsuario === 'function') {
            await reduzirDocumentoUsuario();
            console.log('‚úÖ Limpeza autom√°tica conclu√≠da. Tentando salvar novamente...');
            
            // Tentar novamente ap√≥s limpeza
            await setDoc(doc(db, "usuarios", auth.currentUser.uid), fields, { merge: true });
            console.log('‚úÖ Salvamento bem-sucedido ap√≥s limpeza!');
            
            if(typeof invalidateIAContextCache === 'function') invalidateIAContextCache();
            
            mgToast('‚úÖ Documento reduzido automaticamente e salvo!', 'success', 5000);
            return { success: true, autoCleanup: true };
          } else {
            mgToast('üö® DOCUMENTO > 1MB! Execute: await reduzirDocumentoUsuario()', 'error', 15000);
            return { success: false, error: 'Documento excedeu 1MB', needsCleanup: true };
          }
        }
        
        // 5Ô∏è‚É£ Se estiver pr√≥ximo do limite, AVISAR
        if(estimatedSize > CRITICAL_SIZE && !options.skipAutoCleanup) {
          console.warn(`‚ö†Ô∏è CR√çTICO! Documento pr√≥ximo de 1MB: ${(estimatedSize / 1024).toFixed(2)} KB`);
          console.warn('üßπ Executando limpeza preventiva...');
          
          if(typeof reduzirDocumentoUsuario === 'function') {
            await reduzirDocumentoUsuario();
            console.log('‚úÖ Limpeza preventiva conclu√≠da.');
          }
        } else if(estimatedSize > WARNING_SIZE) {
          console.warn(`‚ö†Ô∏è Documento grande: ${(estimatedSize / 1024).toFixed(2)} KB`);
          console.warn('üí° Considere executar: await reduzirDocumentoUsuario()');
        }
        
        // 6Ô∏è‚É£ Salvar normalmente
        await setDoc(doc(db, "usuarios", auth.currentUser.uid), fields, { merge: true });
        console.log(`‚úÖ Salvamento bem-sucedido!`);
        
        if(typeof invalidateIAContextCache === 'function') invalidateIAContextCache();
        
        return { success: true };
        
      } catch(err) {
        console.error('‚ùå Erro ao salvar:', err);
        
        // Se for erro de tamanho, tentar limpeza de emerg√™ncia
        if(err.message && err.message.includes('exceeds')) {
          console.error('üö® ERRO DE TAMANHO! Tentando limpeza de emerg√™ncia...');
          
          if(typeof reduzirDocumentoUsuario === 'function') {
            try {
              await reduzirDocumentoUsuario();
              console.log('‚úÖ Limpeza de emerg√™ncia conclu√≠da. Tentando salvar novamente...');
              
              await setDoc(doc(db, "usuarios", auth.currentUser.uid), fields, { merge: true });
              console.log('‚úÖ Salvamento bem-sucedido ap√≥s limpeza de emerg√™ncia!');
              
              if(typeof invalidateIAContextCache === 'function') invalidateIAContextCache();
              
              mgToast('‚úÖ Documento reduzido e salvo automaticamente!', 'success', 5000);
              return { success: true, emergencyCleanup: true };
            } catch(cleanupErr) {
              console.error('‚ùå Falha na limpeza de emerg√™ncia:', cleanupErr);
              mgToast('üö® FALHA CR√çTICA! Entre em contato com suporte.', 'error', 20000);
              return { success: false, error: cleanupErr, criticalFailure: true };
            }
          }
        }
        
        return { success: false, error: err };
      }
    }
    
    async function writeUserDoc(fields){
      if(!auth?.currentUser) return;
      try{
        await setDoc(doc(db, "usuarios", auth.currentUser.uid), fields, { merge: true });
        if(typeof invalidateIAContextCache === 'function') invalidateIAContextCache();
      }catch(err){
        console.warn('writeUserDoc', err);
      }
    }

    const $ = (id)=>document.getElementById(id);
    const headerCalendarBar = $("headerCalendarBar"), headerCalendarMonth = $("headerCalendarMonth"), headerCalendarDays = $("headerCalendarDays");
    const statusBox = $("status"), authArea = $("authArea"), userArea = $("userArea"), userInfo = $("userInfo");
    const profileArea = $("profileArea"), profileAvatar = $("profileAvatar"), profileAvatarImg = $("profileAvatarImg"), profileAvatarPlaceholder = $("profileAvatarPlaceholder"), profileAvatarInput = $("profileAvatarInput"), profileClientName = $("profileClientName");
    const settingsToggle = $("settingsToggle"), settingsPanel = $("settingsPanel"), settingsSidebar = $("settingsSidebar"), settingsBody = $("settingsBody"), settingsTitle = $("settingsTitle"), settingsSubtitle = $("settingsSubtitle"), settingsClose = $("settingsClose"), settingsSectionSelect = $("settingsSectionSelect");
    if (!TENANT) {
      statusBox.textContent = 'Fa√ßa login para continuar.';
    }
  const dashboard = $("dashboard"), totalScore = $("totalScore"), totalCard = $("totalCard"), macroActions = $("macroActions"), macroBadges = $("macroBadges");
  const sectionTabs = $("sectionTabs"), widgetsGrid = $("widgetsGrid"), demandasWrap = $("demandasWrap"), notesWrap = $("notesWrap"), metasWrap = $("metasWrap"), iframeDica = $("iframedica"), filesWrap = $("filesWrap"), foldersList = $("foldersList"), filesPane = $("filesPane"), filesList = $("filesList"), fileInput = $("fileInput"), uploadFilesBtn = $("uploadFilesBtn"), newFolderBtn = $("newFolder"), filesBreadcrumb = $("filesBreadcrumb"), subfoldersGrid = $("subfoldersGrid"), filesEmpty = $("filesEmpty"), filesViewToggle = $("filesViewToggle"), viewAllFilesBtn = $("viewAllFilesBtn"), filePreviewModal = $("filePreviewModal"), filePreviewTitle = $("filePreviewTitle"), filePreviewContent = $("filePreviewContent"), filePreviewInfo = $("filePreviewInfo"), filePreviewClose = $("filePreviewClose"), uploadProgress = $("uploadProgress"), uploadProgressText = $("uploadProgressText"), uploadProgressBar = $("uploadProgressBar"), uploadProgressPercent = $("uploadProgressPercent"), storageUsage = $("storageUsage"), storageUsagePercent = $("storageUsagePercent"), storageUsageFill = $("storageUsageFill"), storageUsageSummary = $("storageUsageSummary"), storageUsageHint = $("storageUsageHint"), filesBulkBar = $("filesBulkBar"), filesBulkCount = $("filesBulkCount"), filesBulkStatus = $("filesBulkStatus"), filesBulkUndo = $("filesBulkUndo"), filesSelectAll = $("filesSelectAll");
    // Vari√°veis de tr√°fego mantidas para compatibilidade (funcionalidade removida)
    const trafegoWrap = null, trafegoDemandasBody = null, trafegoAddDemanda = null, trafegoMetricsBody = null, trafegoAddMetricRow = null, trafegoCampaignsBody = null, trafegoAddCampaign = null, trafegoCampaignStatusFilter = null, trafegoCampaignSearch = null, trafegoCampaignsEmpty = null, trafegoOptimizationsBody = null, trafegoAddOptimization = null, trafegoOptimizationPlatformFilter = null, trafegoOptimizationRecurrenceFilter = null, trafegoOptimizationSearch = null, trafegoOptimizationsEmpty = null, trafegoHistoryBody = null, trafegoHistoryPlatformFilter = null, trafegoHistorySearch = null, trafegoHistoryEmpty = null;
    const trafegoCampaignsEmptyDefault = '';
    const trafegoOptimizationsEmptyDefault = '';
    const estruturacaoWrap = $("estruturacaoWrap");
    let macroTabBadgeEl = null;
    let macroTabHasUpdate = false;
    let macroAutoOpenPending = false; // Desativado - iniciar na aba estrutura√ß√£o
    const tabsContainer = $("tabsContainer"), mainMenuToggle = $("mainMenuToggle");
    const calendarWrap = $("calendarWrap"), iaWrap = $("iaWrap"), competitorsWrap = $("competitorsWrap"), refSocialWrap = $("refSocialWrap"), leadsWrap = $("leadsWrap"), relatorioWrap = $("relatorioWrap"), teamNotesWrap = $("teamNotesWrap"), reunioesWrap = $("reunioesWrap"), refSocialList = $("refSocialList"), refSocialForm = $("refSocialForm"), refSocialFile = $("refSocialFile"), refSocialDetails = $("refSocialDetails"), refSocialCategory = $("refSocialCategory"), refSocialLinkInput = $("refSocialLinkInput"), refSocialLinkPreview = $("refSocialLinkPreview"), refSocialModeToggle = $("refSocialModeToggle");
    const notesList = $("notesList"), noteEditor = $("noteEditor"), noteSector = $("noteSector"), noteTitle = $("noteTitle"), noteDate = $("noteDate"), noteAutoSaveStatus = $("noteAutoSaveStatus"), noteTemplateSelect = $("noteTemplateSelect"), insertTemplateBtn = $("insertTemplateBtn"), saveTemplateBtn = $("saveTemplateBtn");
    const newNoteBtn = $("newNoteBtn"), filterSector = $("filterSector"), filterFrom = $("filterFrom"), filterTo = $("filterTo");
    const applyFilter = $("applyFilter"), clearFilter = $("clearFilter"), scrollHint = $("scrollHint");
    const refreshBtn = $("refreshBtn"), notificationWidgetWrap = $("notificationWidget"), noteWidget = $("noteWidget");
      const btnImg = $("btnImg"), btnImgLink = $("btnImgLink"), imgInput = $("imgInput"),
            btnVideo = $("btnVideo"), btnVideoLink = $("btnVideoLink"), videoInput = $("videoInput");

    const calendarWebhookInput = $("calendarWebhook"), demandasWebhookInput = $("demandasWebhook");

    const SETTINGS_SECTIONS = {
      general: {
        title: "Geral",
        subtitle: "Personalize as informa√ß√µes principais da sua conta.",
        blocks: [
          {
            title: "Identidade da marca",
            description: "Centralize dados que definem como a marca aparece para o time e nos relat√≥rios compartilhados.",
            items: [
              { label: "Nome do cliente", description: "Atualize o t√≠tulo exibido no cabe√ßalho e nos dashboards." },
              { label: "Logo e cores", description: "Envie um novo logotipo e ajuste a cor de destaque que acompanha os cards." },
              { label: "Dados p√∫blicos", description: "Configure telefone, site e redes sociais apresentadas nas entregas." }
            ]
          },
          {
            title: "Experi√™ncia da plataforma",
            description: "Ajuste prefer√™ncias gerais como idioma, fuso hor√°rio e formatos utilizados nos pain√©is.",
            items: [
              { label: "Idioma", description: "Escolha a l√≠ngua padr√£o para a equipe visualizar a plataforma." },
              { label: "Fuso hor√°rio", description: "Garanta que calend√°rios e alertas sigam o hor√°rio do cliente." },
              { label: "Formato de data", description: "Defina o padr√£o de datas que ser√° exibido nos m√≥dulos." }
            ]
          },
          {
            title: "Seguran√ßa b√°sica",
            description: "Mantenha os dados seguros com autentica√ß√£o atualizada e revis√µes recorrentes de acesso.",
            items: [
              { label: "Senha da conta", description: "Altere a senha periodicamente para refor√ßar a seguran√ßa." },
              { label: "Recupera√ß√£o", description: "Cadastre e valide e-mails e telefones alternativos." },
              { label: "Alertas cr√≠ticos", description: "Ative notifica√ß√µes sobre tentativas de acesso suspeitas." }
            ]
          }
        ]
      },
      clients: {
        title: "Gerenciar Clientes",
        subtitle: "Organize contas, pastas e permiss√µes espec√≠ficas para cada cliente atendido.",
        blocks: [
          {
            title: "Estrutura de contas",
            description: "Crie novos clientes, arquive contratos inativos e mantenha os dados sempre alinhados.",
            items: [
              { label: "Cadastro r√°pido", description: "Inclua informa√ß√µes essenciais como CNPJ, segmento e respons√°vel." },
              { label: "Status da conta", description: "Atualize o est√°gio do cliente para alinhar relat√≥rios e metas." },
              { label: "Modelos de briefing", description: "Defina documentos base que facilitam o kick-off com novas marcas." }
            ]
          },
          {
            title: "Convidar e ativar cliente",
            description: "Crie e libere rapidamente o acesso do cliente com as permiss√µes corretas.",
            customContent: `
              <div class="client-role-actions">
                <button type="button" class="btn ghost" id="becomeAgencyBtn">Tornar minha conta uma ag√™ncia</button>
                <button type="button" class="btn secondary" id="enterClientBtn">Entrar no cliente</button>
                <span class="client-invite-status" id="clientRoleStatus"></span>
              </div>
              <form id="inviteClientForm" class="client-invite-form">
                <div class="client-invite-grid">
                  <label>
                    Nome do cliente
                    <input id="inviteClientName" type="text" required placeholder="Ex: Acme Co.">
                  </label>
                  <label>
                    E-mail do respons√°vel
                    <input id="inviteClientEmail" type="email" required placeholder="contato@cliente.com">
                  </label>
                  <label>
                    Senha inicial
                    <input id="inviteClientPassword" type="password" required minlength="6" placeholder="Min. 6 caracteres">
                  </label>
                </div>
                <div class="client-invite-actions">
                  <button type="submit" class="btn">Convidar cliente</button>
                  <span class="client-invite-status" id="inviteClientStatus"></span>
                </div>
              </form>
              <div class="client-accounts-section" data-client-accounts-root>
                <h4>Contas com acesso</h4>
                <div class="client-accounts-list" id="clientAccountsList" role="list"></div>
                <span class="client-invite-status" id="clientAccountsStatus"></span>
              </div>
            `
          }
        ]
      },
      integrations: {
        title: "Integra√ß√µes",
        subtitle: "Conecte ferramentas externas para enriquecer dados e automatizar rotinas.",
        blocks: [
          {
            title: "Fontes de dados",
            description: "Ative integra√ß√µes com plataformas que alimentam dashboards automaticamente.",
            items: [
              { label: "Google e Meta", description: "Sincronize campanhas, m√©tricas e p√∫blicos em tempo real." },
              { label: "RD Station e CRMs", description: "Conecte leads, oportunidades e status de vendas." },
              { label: "Planilhas externas", description: "Importe bases personalizadas via Google Sheets ou CSV." }
            ]
          },
          {
            title: "Automa√ß√£o de tarefas",
            description: "Dispare a√ß√µes autom√°ticas quando eventos espec√≠ficos acontecerem na plataforma.",
            items: [
              { label: "Webhooks", description: "Acione rotinas personalizadas a cada entrega conclu√≠da." },
              { label: "Bots de aprova√ß√£o", description: "Integre com Slack, Discord ou Teams para aprova√ß√µes instant√¢neas." },
              { label: "Sincroniza√ß√£o de arquivos", description: "Envie m√≠dias aprovadas direto para drives compartilhados." }
            ]
          }
        ]
      },
      users: {
        title: "Time",
        subtitle: "Gerencie membros da equipe, permiss√µes e convites.",
        blocks: [
          {
            title: "Membros da Equipe",
            description: "Adicione e gerencie os membros ativos do seu time.",
            customContent: `
              <div class="team-manager">
                <div class="team-sync-notice">
                  <p>üí° <strong>Sincroniza√ß√£o autom√°tica:</strong> Os membros adicionados aqui aparecem automaticamente como op√ß√µes de "Respons√°vel" na aba Planejamento.</p>
                  <button type="button" class="btn-secondary" id="importPlanningResponsaveis" style="margin-top: 8px;">
                    üìã Importar respons√°veis do planejamento
                  </button>
                </div>
                <form class="team-form" id="addTeamMemberForm">
                  <div class="team-form-row">
                    <input type="text" id="teamMemberName" placeholder="Nome do membro" required>
                    <input type="email" id="teamMemberEmail" placeholder="E-mail" required>
                    <select id="teamMemberRole" required>
                      <option value="">Selecionar fun√ß√£o</option>
                      <option value="admin">Administrador</option>
                      <option value="manager">Gerente</option>
                      <option value="editor">Editor</option>
                      <option value="viewer">Visualizador</option>
                    </select>
                    <button type="submit" class="btn-primary">Adicionar</button>
                  </div>
                </form>
                <div class="team-list" id="teamMembersList">
                  <div class="team-list-header">
                    <div>Nome</div>
                    <div>E-mail</div>
                    <div>Fun√ß√£o</div>
                    <div>A√ß√µes</div>
                  </div>
                  <!-- Team members will be inserted here -->
                </div>
              </div>
            `
          }
        ]
      },
      plans: {
        title: "Planos",
        subtitle: "Acompanhe a assinatura ativa e ajuste a capacidade conforme o crescimento da opera√ß√£o.",
        blocks: [
          {
            title: "Resumo da assinatura",
            description: "Visualize o plano atual, limites contratados e pr√≥ximos ciclos de faturamento.",
            items: [
              { label: "Status", description: "Veja se a assinatura est√° ativa, em teste ou aguardando pagamento." },
              { label: "Limites", description: "Consulte quantidade de usu√°rios, clientes e espa√ßo dispon√≠veis." },
              { label: "Hist√≥rico de cobran√ßa", description: "Acesse notas fiscais e comprovantes anteriores." }
            ]
          },
          {
            title: "Upgrade e add-ons",
            description: "Simule novas faixas de uso e contrate recursos extras em poucos cliques.",
            items: [
              { label: "Comparativo de planos", description: "Avalie funcionalidades antes de migrar." },
              { label: "Add-ons", description: "Inclua m√≥dulos adicionais como IA, relat√≥rios premium ou suporte dedicado." },
              { label: "Condi√ß√µes comerciais", description: "Negocie pacotes anuais e obtenha descontos progressivos." }
            ]
          }
        ]
      },
      preferences: {
        title: "Prefer√™ncias",
        subtitle: "Defina alertas, notifica√ß√µes e experi√™ncias personalizadas para o time.",
        blocks: [
          {
            title: "Alertas e notifica√ß√µes",
            description: "Escolha canais e frequ√™ncia das comunica√ß√µes que mant√™m o time atualizado.",
            items: [
              { label: "Canais", description: "Ative notifica√ß√µes por e-mail, push e mensagens em apps conectados." },
              { label: "Ritmo", description: "Configure resumos di√°rios, semanais ou apenas alertas cr√≠ticos." },
              { label: "Silenciar hor√°rios", description: "Defina janelas sem notifica√ß√µes para focar em entregas." }
            ]
          },
          {
            title: "Personaliza√ß√£o",
            description: "Ajuste detalhes visuais e escolhas individuais para cada membro da equipe.",
            items: [
              { label: "Tema", description: "Selecione varia√ß√µes de contraste ou modo alto para apresenta√ß√µes." },
              { label: "Widgets favoritos", description: "Fixe m√≥dulos priorit√°rios na primeira dobra do dashboard." },
              { label: "Assistentes inteligentes", description: "Habilite sugest√µes autom√°ticas baseadas em IA para demandas." }
            ]
          }
        ]
      },
      notifications: {
        title: "Notifica√ß√µes",
        subtitle: "Configure alertas autom√°ticos por email das notifica√ß√µes da plataforma.",
        blocks: [
          {
            title: "Envio de notifica√ß√µes por email",
            description: "Receba um resumo de todas as notifica√ß√µes da plataforma no seu email em hor√°rios programados.",
            customContent: `
              <div class="notifications-email-manager">
                <div class="notification-info">
                  <p>üìß Configure abaixo os emails que receber√£o resumos autom√°ticos de todas as notifica√ß√µes ativas da plataforma (demandas pendentes, metas em risco, posts programados e novos leads).</p>
                </div>
                
                <form id="emailNotificationForm" class="email-notification-form">
                  <div class="form-section">
                    <label>
                      <strong>Emails destinat√°rios</strong>
                      <small>Adicione um ou mais emails separados por v√≠rgula</small>
                      <textarea id="notificationEmails" rows="3" placeholder="email1@exemplo.com, email2@exemplo.com" required></textarea>
                    </label>
                  </div>

                  <div class="form-section">
                    <label>
                      <strong>Frequ√™ncia de envio</strong>
                      <select id="notificationFrequency" required>
                        <option value="">Selecione a frequ√™ncia</option>
                        <option value="daily">Di√°rio</option>
                        <option value="weekly">Semanal</option>
                        <option value="monthly">Mensal</option>
                      </select>
                    </label>
                  </div>

                  <div class="form-section schedule-section" id="scheduleSection" style="display:none;">
                    <div class="schedule-grid">
                      <label id="dayOfWeekLabel" style="display:none;">
                        <strong>Dia da semana</strong>
                        <select id="notificationDayOfWeek">
                          <option value="1">Segunda-feira</option>
                          <option value="2">Ter√ßa-feira</option>
                          <option value="3">Quarta-feira</option>
                          <option value="4">Quinta-feira</option>
                          <option value="5">Sexta-feira</option>
                          <option value="6">S√°bado</option>
                          <option value="0">Domingo</option>
                        </select>
                      </label>

                      <label id="dayOfMonthLabel" style="display:none;">
                        <strong>Dia do m√™s</strong>
                        <select id="notificationDayOfMonth">
                          ${Array.from({length:28}, (_,i)=>i+1).map(d=>`<option value="${d}">${d}</option>`).join('')}
                        </select>
                      </label>

                      <label>
                        <strong>Hor√°rio</strong>
                        <input type="time" id="notificationTime" value="09:00" required>
                      </label>
                    </div>
                  </div>

                  <div class="form-actions">
                    <button type="submit" class="btn-primary">üíæ Salvar configura√ß√£o</button>
                    <button type="button" class="btn-secondary" id="testEmailNotificationBtn">üì® Enviar email de teste</button>
                    <button type="button" class="btn-ghost" id="clearEmailNotificationBtn">üóëÔ∏è Limpar configura√ß√£o</button>
                  </div>
                  
                  <div class="notification-status" id="emailNotificationStatus"></div>
                </form>

                <div class="current-config-section" id="currentEmailConfig" style="display:none;">
                  <h4>üìã Configura√ß√£o atual</h4>
                  <div class="config-display" id="configDisplay"></div>
                </div>
              </div>

              <style>
                .notifications-email-manager { padding: 16px; }
                .notification-info { 
                  background: #f0f9ff; 
                  border-left: 4px solid #3b82f6; 
                  padding: 12px 16px; 
                  margin-bottom: 24px;
                  border-radius: 4px;
                }
                .notification-info p { margin: 0; color: #1e40af; font-size: 14px; line-height: 1.6; }
                
                .email-notification-form { display: flex; flex-direction: column; gap: 20px; }
                .form-section { display: flex; flex-direction: column; gap: 8px; }
                .form-section label { display: flex; flex-direction: column; gap: 6px; }
                .form-section label strong { color: #1f2937; font-size: 14px; }
                .form-section label small { color: #6b7280; font-size: 12px; }
                
                .form-section textarea,
                .form-section select,
                .form-section input[type="time"] {
                  padding: 10px 12px;
                  border: 1px solid #d1d5db;
                  border-radius: 6px;
                  font-size: 14px;
                  font-family: inherit;
                  background: white;
                  transition: all 0.2s;
                }
                
                .form-section textarea:focus,
                .form-section select:focus,
                .form-section input[type="time"]:focus {
                  outline: none;
                  border-color: #3b82f6;
                  box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
                }

                .schedule-grid {
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                  gap: 16px;
                }

                .form-actions {
                  display: flex;
                  gap: 12px;
                  flex-wrap: wrap;
                  align-items: center;
                  padding-top: 8px;
                }

                .btn-primary, .btn-secondary, .btn-ghost {
                  padding: 10px 20px;
                  border-radius: 6px;
                  font-size: 14px;
                  font-weight: 500;
                  cursor: pointer;
                  transition: all 0.2s;
                  border: none;
                  display: inline-flex;
                  align-items: center;
                  gap: 6px;
                }

                .btn-primary {
                  background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
                  color: white;
                }
                .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(59,130,246,0.4); }

                .btn-secondary {
                  background: white;
                  color: #3b82f6;
                  border: 1px solid #3b82f6;
                }
                .btn-secondary:hover { background: #eff6ff; }

                .btn-ghost {
                  background: transparent;
                  color: #6b7280;
                  border: 1px solid #d1d5db;
                }
                .btn-ghost:hover { background: #f9fafb; color: #1f2937; }

                .notification-status {
                  padding: 12px 16px;
                  border-radius: 6px;
                  font-size: 14px;
                  display: none;
                  animation: slideDown 0.3s ease;
                }
                .notification-status.success { background: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; display: block; }
                .notification-status.error { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; display: block; }
                .notification-status.info { background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; display: block; }

                .current-config-section {
                  margin-top: 32px;
                  padding: 16px;
                  background: #f9fafb;
                  border-radius: 8px;
                  border: 1px solid #e5e7eb;
                }
                .current-config-section h4 { margin: 0 0 12px 0; color: #1f2937; font-size: 14px; }
                .config-display { 
                  background: white; 
                  padding: 12px; 
                  border-radius: 6px; 
                  font-size: 13px;
                  line-height: 1.8;
                  color: #374151;
                }
                .config-display strong { color: #1f2937; }

                @keyframes slideDown {
                  from { opacity: 0; transform: translateY(-10px); }
                  to { opacity: 1; transform: translateY(0); }
                }
              </style>
            `
          }
        ]
      }
    };

    let currentSettingsSection = "general";
    let previousBodyOverflow = "";

    function updateSettingsNav(sectionKey){
      if(settingsSidebar){
        const buttons = settingsSidebar.querySelectorAll('.settings-nav-btn');
        buttons.forEach((btn)=>{
          const isActive = btn instanceof HTMLButtonElement && btn.dataset.section === sectionKey;
          btn.classList.toggle('active', !!isActive);
          btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
        });
      }
      if(settingsSectionSelect){
        settingsSectionSelect.value = sectionKey;
      }
    }

    function renderSettingsSection(sectionKey){
      const safeKey = Object.prototype.hasOwnProperty.call(SETTINGS_SECTIONS, sectionKey) ? sectionKey : 'general';
      const section = SETTINGS_SECTIONS[safeKey];
      currentSettingsSection = safeKey;
      if(settingsTitle){
        settingsTitle.textContent = section.title;
      }
      if(settingsSubtitle){
        settingsSubtitle.textContent = section.subtitle;
      }
      if(settingsBody){
        settingsBody.innerHTML = '';
        const frag = document.createDocumentFragment();
        section.blocks.forEach((block)=>{
          const card = document.createElement('div');
          card.className = 'settings-card';
          if(block.title){
            const h3 = document.createElement('h3');
            h3.textContent = block.title;
            card.appendChild(h3);
          }
          if(block.description){
            const p = document.createElement('p');
            p.textContent = block.description;
            card.appendChild(p);
          }
          if(block.customContent){
            const div = document.createElement('div');
            div.innerHTML = block.customContent;
            card.appendChild(div);

            const teamForm = div.querySelector('#addTeamMemberForm');
            if(teamForm) {
              teamForm.addEventListener('submit', async e => {
                e.preventDefault();
                const nameInput = teamForm.querySelector('#teamMemberName');
                const emailInput = teamForm.querySelector('#teamMemberEmail');
                const roleInput = teamForm.querySelector('#teamMemberRole');

                if(!nameInput?.value || !emailInput?.value || !roleInput?.value) {
                  alert('Por favor, preencha todos os campos.');
                  return;
                }

                const newMember = {
                  name: nameInput.value,
                  email: emailInput.value,
                  role: roleInput.value,
                  addedAt: serverTimestamp()
                };

                try {
                  await addDoc(collection(db, 'usuarios', auth.currentUser.uid, 'team'), newMember);
                  nameInput.value = '';
                  emailInput.value = '';
                  roleInput.value = '';
                  loadTeamMembers();
                  if(typeof mgToast === 'function') {
                    mgToast('‚úÖ Membro adicionado e sincronizado com o planejamento!');
                  } else {
                    alert('Membro adicionado com sucesso!');
                  }
                } catch(err) {
                  console.error('Erro ao adicionar membro:', err);
                  alert('Erro ao adicionar membro. Tente novamente.');
                }
              });
            }
            
            // Bot√£o de importar respons√°veis do planejamento
            const importBtn = div.querySelector('#importPlanningResponsaveis');
            if(importBtn) {
              importBtn.addEventListener('click', async () => {
                importBtn.disabled = true;
                importBtn.textContent = '‚è≥ Importando...';
                try {
                  await loadExistingResponsaveisToTeam();
                  await loadTeamMembers();
                  if(typeof mgToast === 'function') {
                    mgToast('‚úÖ Respons√°veis do planejamento importados com sucesso!');
                  } else {
                    alert('Respons√°veis importados com sucesso!');
                  }
                } catch(err) {
                  console.error('Erro ao importar:', err);
                  alert('Erro ao importar respons√°veis.');
                } finally {
                  importBtn.disabled = false;
                  importBtn.textContent = 'üìã Importar respons√°veis do planejamento';
                }
              });
            }

            const inviteForm = div.querySelector('#inviteClientForm');
            if(inviteForm){
              attachClientInviteForm(inviteForm);
            }
            attachClientRoleActions(div);
            attachClientAccountsList(div);
          }
          if(Array.isArray(block.items) && block.items.length){
            const ul = document.createElement('ul');
            block.items.forEach((item)=>{
              if(!item) return;
              const li = document.createElement('li');
              if(typeof item === 'string'){
                li.textContent = item;
              }else if(typeof item === 'object'){
                const label = 'label' in item ? item.label : '';
                const description = 'description' in item ? item.description : '';
                if(label){
                  const strong = document.createElement('strong');
                  strong.textContent = label;
                  li.appendChild(strong);
                  if(description){
                    li.appendChild(document.createTextNode(` ‚Äî ${description}`));
                  }
                }else if(description){
                  li.textContent = description;
                }else{
                  return;
                }
              }else{
                return;
              }
              ul.appendChild(li);
            });
            if(ul.childElementCount){
              card.appendChild(ul);
            }
          }
          frag.appendChild(card);
        });
        settingsBody.appendChild(frag);
      }
      updateSettingsNav(safeKey);
    }

    function openSettingsPanel(){
      if(!settingsPanel || settingsPanel.classList.contains('open')) return;
      renderSettingsSection(currentSettingsSection);
      previousBodyOverflow = document.body.style.overflow;
      document.body.style.overflow = 'hidden';
      settingsPanel.classList.add('open');
      settingsPanel.setAttribute('aria-hidden', 'false');
      settingsToggle?.setAttribute('aria-expanded', 'true');
      
      // Se estiver na se√ß√£o "users", carrega os membros da equipe
      if(currentSettingsSection === 'users') {
        setTimeout(() => loadTeamMembers(), 100);
      }
      
      requestAnimationFrame(()=>{
        settingsClose?.focus();
      });
    }

    function closeSettingsPanel(){
      if(!settingsPanel || !settingsPanel.classList.contains('open')) return;
      settingsPanel.classList.remove('open');
      settingsPanel.setAttribute('aria-hidden', 'true');
      settingsToggle?.setAttribute('aria-expanded', 'false');
      document.body.style.overflow = previousBodyOverflow;
      settingsToggle?.focus({ preventScroll: true });
    }

    settingsToggle?.addEventListener('click', ()=>{
      if(settingsPanel?.classList.contains('open')){
        closeSettingsPanel();
      }else{
        openSettingsPanel();
      }
    });

    settingsClose?.addEventListener('click', closeSettingsPanel);

    settingsPanel?.addEventListener('click', (event)=>{
      if(event.target === settingsPanel){
        closeSettingsPanel();
      }
    });

    document.addEventListener('keydown', (event)=>{
      if(event.key === 'Escape' && settingsPanel?.classList.contains('open')){
        closeSettingsPanel();
      }
    });

    settingsSidebar?.addEventListener('click', (event)=>{
      const target = event.target;
      if(!(target instanceof Element)) return;
      const button = target.closest('.settings-nav-btn');
      if(button instanceof HTMLButtonElement){
        const section = button.dataset.section;
        if(section){
          renderSettingsSection(section);
        }
      }
    });

    settingsSectionSelect?.addEventListener('change', (event)=>{
      const value = event.target?.value;
      if(typeof value === 'string'){
        renderSettingsSection(value);
      }
    });

    // Team management functionality
    async function loadTeamMembers() {
      if(!auth?.currentUser) return;
      try {
        const teamSnapshot = await getDocs(collection(db, 'usuarios', auth.currentUser.uid, 'team'));
        const teamList = document.getElementById('teamMembersList');
        if(!teamList) return;
        
        // Coleta todos os membros para sincroniza√ß√£o
        const allMembers = [];
        teamSnapshot.forEach(doc => {
          allMembers.push({ id: doc.id, ...doc.data() });
        });
        
        // Sincroniza membros com RESP_OPTIONS
        syncTeamToRespOptions(allMembers);
        
        // Keep header
        const header = teamList.querySelector('.team-list-header');
        teamList.innerHTML = '';
        if(header) teamList.appendChild(header);

        allMembers.forEach(member => {
          const div = document.createElement('div');
          div.className = 'team-member';
          div.dataset.id = member.id;
          
          // Adiciona badge se foi auto-importado
          const badge = member.autoImported ? '<span class="auto-imported-badge" title="Importado do planejamento">üìã</span> ' : '';
          
          div.innerHTML = `
            <div>${badge}${member.name}</div>
            <div>${member.email || '‚Äî'}</div>
            <div>${member.role}</div>
            <div class="team-member-actions">
              <button type="button" class="edit-btn" data-id="${member.id}">Editar</button>
              <button type="button" class="remove-btn" data-id="${member.id}">Remover</button>
            </div>
          `;
          teamList.appendChild(div);
        });

        // Add event listeners
        teamList.querySelectorAll('.edit-btn').forEach(btn => {
          btn.addEventListener('click', e => {
            const id = e.target.dataset.id;
            const member = e.target.closest('.team-member');
            if(!member) return;
            
            // Transform row into edit form
            const memberData = {
              name: member.children[0].textContent,
              email: member.children[1].textContent,
              role: member.children[2].textContent
            };
            
            member.innerHTML = `
              <div><input type="text" value="${memberData.name}" class="edit-name"></div>
              <div><input type="email" value="${memberData.email}" class="edit-email"></div>
              <div>
                <select class="edit-role">
                  <option value="admin" ${memberData.role === 'admin' ? 'selected' : ''}>Administrador</option>
                  <option value="manager" ${memberData.role === 'manager' ? 'selected' : ''}>Gerente</option>
                  <option value="editor" ${memberData.role === 'editor' ? 'selected' : ''}>Editor</option>
                  <option value="viewer" ${memberData.role === 'viewer' ? 'selected' : ''}>Visualizador</option>
                </select>
              </div>
              <div class="team-member-actions">
                <button type="button" class="btn-primary save-edit" data-id="${id}">Salvar</button>
                <button type="button" class="btn-secondary cancel-edit">Cancelar</button>
              </div>
            `;

            // Add handlers for save/cancel
            member.querySelector('.save-edit').addEventListener('click', async () => {
              const newData = {
                name: member.querySelector('.edit-name').value,
                email: member.querySelector('.edit-email').value,
                role: member.querySelector('.edit-role').value
              };
              await updateDoc(doc(db, 'usuarios', auth.currentUser.uid, 'team', id), newData);
              loadTeamMembers(); // Reload list
            });

            member.querySelector('.cancel-edit').addEventListener('click', () => {
              loadTeamMembers(); // Reload list to cancel
            });
          });
        });

        teamList.querySelectorAll('.remove-btn').forEach(btn => {
          btn.addEventListener('click', async e => {
            const id = e.target.dataset.id;
            if(!confirm('Tem certeza que deseja remover este membro?')) return;
            await deleteDoc(doc(db, 'usuarios', auth.currentUser.uid, 'team', id));
            loadTeamMembers(); // Reload list
          });
        });
      } catch(err) {
        console.error('Error loading team members:', err);
      }
    }

    // Handle form submission for adding new team members
    const addTeamMemberForm = document.getElementById('addTeamMemberForm');
    if(addTeamMemberForm) {
      addTeamMemberForm.addEventListener('submit', async e => {
        e.preventDefault();
        const nameInput = document.getElementById('teamMemberName');
        const emailInput = document.getElementById('teamMemberEmail');
        const roleInput = document.getElementById('teamMemberRole');

        if(!nameInput || !emailInput || !roleInput) return;

        const newMember = {
          name: nameInput.value,
          email: emailInput.value,
          role: roleInput.value,
          addedAt: serverTimestamp()
        };

        try {
          await addDoc(collection(db, 'usuarios', auth.currentUser.uid, 'team'), newMember);
          nameInput.value = '';
          emailInput.value = '';
          roleInput.value = '';
          loadTeamMembers(); // Reload list
        } catch(err) {
          console.error('Error adding team member:', err);
        }
      });
    }

    // Email Notification Configuration
    async function loadEmailNotificationSettings() {
      const clientKey = getClientKey();
      if(!auth.currentUser || !clientKey) return;
      
      try {
        const settingsRef = doc(db, 'usuarios', auth.currentUser.uid, 'clients', clientKey);
        const settingsSnap = await getDoc(settingsRef);
        
        if(settingsSnap.exists()) {
          const data = settingsSnap.data();
          const emailSettings = data.emailNotifications || {};
          
          const emailsInput = document.getElementById('notificationEmails');
          const frequencySelect = document.getElementById('notificationFrequency');
          const dayOfWeekSelect = document.getElementById('notificationDayOfWeek');
          const dayOfMonthSelect = document.getElementById('notificationDayOfMonth');
          const timeInput = document.getElementById('notificationTime');
          const configDisplay = document.getElementById('configDisplay');
          const currentConfigSection = document.getElementById('currentEmailConfig');
          
          if(emailSettings.emails && emailSettings.emails.length > 0) {
            if(emailsInput) emailsInput.value = emailSettings.emails.join(', ');
            if(frequencySelect) {
              frequencySelect.value = emailSettings.frequency || '';
              updateScheduleVisibility(emailSettings.frequency);
            }
            if(dayOfWeekSelect && emailSettings.dayOfWeek !== undefined) dayOfWeekSelect.value = emailSettings.dayOfWeek;
            if(dayOfMonthSelect && emailSettings.dayOfMonth) dayOfMonthSelect.value = emailSettings.dayOfMonth;
            if(timeInput && emailSettings.time) timeInput.value = emailSettings.time;
            
            // Show current config
            if(configDisplay && currentConfigSection) {
              const freqLabels = {daily:'Di√°rio', weekly:'Semanal', monthly:'Mensal'};
              const dayLabels = {0:'Domingo',1:'Segunda',2:'Ter√ßa',3:'Quarta',4:'Quinta',5:'Sexta',6:'S√°bado'};
              
              let scheduleText = `√†s ${emailSettings.time || '09:00'}`;
              if(emailSettings.frequency === 'weekly' && emailSettings.dayOfWeek !== undefined) {
                scheduleText = `${dayLabels[emailSettings.dayOfWeek]} ${scheduleText}`;
              } else if(emailSettings.frequency === 'monthly' && emailSettings.dayOfMonth) {
                scheduleText = `Dia ${emailSettings.dayOfMonth} ${scheduleText}`;
              }
              
              configDisplay.innerHTML = `
                <strong>Emails:</strong> ${emailSettings.emails.join(', ')}<br>
                <strong>Frequ√™ncia:</strong> ${freqLabels[emailSettings.frequency] || emailSettings.frequency}<br>
                <strong>Programa√ß√£o:</strong> ${scheduleText}
              `;
              currentConfigSection.style.display = 'block';
            }
          }
        }
      } catch(err) {
        console.error('Error loading email notification settings:', err);
      }
    }

    function updateScheduleVisibility(frequency) {
      const scheduleSection = document.getElementById('scheduleSection');
      const dayOfWeekLabel = document.getElementById('dayOfWeekLabel');
      const dayOfMonthLabel = document.getElementById('dayOfMonthLabel');
      
      if(!scheduleSection) return;
      
      if(frequency) {
        scheduleSection.style.display = 'block';
        if(dayOfWeekLabel) dayOfWeekLabel.style.display = frequency === 'weekly' ? 'flex' : 'none';
        if(dayOfMonthLabel) dayOfMonthLabel.style.display = frequency === 'monthly' ? 'flex' : 'none';
      } else {
        scheduleSection.style.display = 'none';
      }
    }

    function showNotificationStatus(message, type = 'info') {
      const statusEl = document.getElementById('emailNotificationStatus');
      if(!statusEl) return;
      
      statusEl.textContent = message;
      statusEl.className = `notification-status ${type}`;
      statusEl.style.display = 'block';
      
      setTimeout(() => {
        statusEl.style.display = 'none';
      }, 5000);
    }

    // Fun√ß√£o para inicializar event listeners da se√ß√£o de notifica√ß√µes
    function initEmailNotificationListeners() {
      console.log('üîß Inicializando event listeners de notifica√ß√µes por email...');
      
      // Frequency change handler
      const frequencySelect = document.getElementById('notificationFrequency');
      if(frequencySelect) {
        console.log('‚úÖ Frequency select encontrado');
        frequencySelect.removeEventListener('change', handleFrequencyChange); // Remove listener antigo se existir
        frequencySelect.addEventListener('change', handleFrequencyChange);
      } else {
        console.warn('‚ö†Ô∏è Frequency select n√£o encontrado');
      }

      // Email notification form submission
      const emailNotificationForm = document.getElementById('emailNotificationForm');
      if(emailNotificationForm) {
        console.log('‚úÖ Form de notifica√ß√£o encontrado');
        emailNotificationForm.removeEventListener('submit', handleEmailFormSubmit);
        emailNotificationForm.addEventListener('submit', handleEmailFormSubmit);
      } else {
        console.warn('‚ö†Ô∏è Form de notifica√ß√£o n√£o encontrado');
      }

      // Test email button
      const testEmailBtn = document.getElementById('testEmailNotificationBtn');
      if(testEmailBtn) {
        console.log('‚úÖ Bot√£o de teste encontrado');
        testEmailBtn.removeEventListener('click', handleTestEmailClick);
        testEmailBtn.addEventListener('click', handleTestEmailClick);
      } else {
        console.warn('‚ö†Ô∏è Bot√£o de teste n√£o encontrado');
      }

      // Clear configuration button
      const clearEmailBtn = document.getElementById('clearEmailNotificationBtn');
      if(clearEmailBtn) {
        console.log('‚úÖ Bot√£o de limpar encontrado');
        clearEmailBtn.removeEventListener('click', handleClearEmailClick);
        clearEmailBtn.addEventListener('click', handleClearEmailClick);
      } else {
        console.warn('‚ö†Ô∏è Bot√£o de limpar n√£o encontrado');
      }
    }

    // Handler functions (definidas fora para poderem ser removidas e readicionadas)
    function handleFrequencyChange(e) {
      updateScheduleVisibility(e.target.value);
    }

    async function handleEmailFormSubmit(e) {
      e.preventDefault();
      
      const clientKey = getClientKey();
      if(!auth.currentUser || !clientKey) {
        showNotificationStatus('Erro: Usu√°rio n√£o autenticado', 'error');
        return;
      }
      
      const emailsInput = document.getElementById('notificationEmails');
      const frequencySelect = document.getElementById('notificationFrequency');
      const dayOfWeekSelect = document.getElementById('notificationDayOfWeek');
      const dayOfMonthSelect = document.getElementById('notificationDayOfMonth');
      const timeInput = document.getElementById('notificationTime');
      
      if(!emailsInput || !frequencySelect || !timeInput) return;
      
      // Parse and validate emails
      const emailsText = emailsInput.value.trim();
      const emails = emailsText.split(',').map(e => e.trim()).filter(e => e.length > 0);
      
      if(emails.length === 0) {
        showNotificationStatus('Por favor, adicione pelo menos um email', 'error');
        return;
      }
      
      // Basic email validation
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      const invalidEmails = emails.filter(e => !emailRegex.test(e));
      if(invalidEmails.length > 0) {
        showNotificationStatus(`Emails inv√°lidos: ${invalidEmails.join(', ')}`, 'error');
        return;
      }
      
      const frequency = frequencySelect.value;
      if(!frequency) {
        showNotificationStatus('Por favor, selecione a frequ√™ncia de envio', 'error');
        return;
      }
      
      const emailSettings = {
        emails,
        frequency,
        time: timeInput.value || '09:00',
        enabled: true,
        updatedAt: serverTimestamp()
      };
      
      if(frequency === 'weekly' && dayOfWeekSelect) {
        emailSettings.dayOfWeek = parseInt(dayOfWeekSelect.value);
      } else if(frequency === 'monthly' && dayOfMonthSelect) {
        emailSettings.dayOfMonth = parseInt(dayOfMonthSelect.value);
      }
      
      try {
        const settingsRef = doc(db, 'usuarios', auth.currentUser.uid, 'clients', clientKey);
        await setDoc(settingsRef, {
          emailNotifications: emailSettings
        }, { merge: true });
        
        // ============================================
        // SINCRONIZAR COM SERVICE WORKER
        // ============================================
        await syncConfigWithServiceWorker(clientKey, emailSettings);
        
        showNotificationStatus('‚úÖ Configura√ß√£o salva com sucesso!', 'success');
        loadEmailNotificationSettings(); // Reload to update display
      } catch(err) {
        console.error('Error saving email notification settings:', err);
        showNotificationStatus('Erro ao salvar configura√ß√£o: ' + err.message, 'error');
      }
    }

    async function sendTestEmailViaBackend() {
      console.log('üß™ Iniciando envio de email de teste via Cloud Function');
      
      const clientKey = getClientKey();
      if(!auth.currentUser || !clientKey) {
        showNotificationStatus('‚ùå Erro: Usu√°rio n√£o autenticado ou cliente n√£o selecionado', 'error');
        return;
      }

      const emailsInput = document.getElementById('notificationEmails');
      if(!emailsInput || !emailsInput.value.trim()) {
        showNotificationStatus('‚ùå Por favor, adicione pelo menos um email antes de testar', 'error');
        return;
      }

      const emails = emailsInput.value.split(',').map(e => e.trim()).filter(e => e.length > 0);
      
      showNotificationStatus('üì® Enviando email de teste...', 'info');
      
      try {
        const widgetNotifications = window.getNotificationItems ? window.getNotificationItems() : notificationItems || [];
        
        console.log('üìß Preparando email de teste com', widgetNotifications.length, 'notifica√ß√µes');
        console.log('üîç Notifica√ß√µes cr√≠ticas:', widgetNotifications.filter(n => n.severity === 'critical').length);
        console.log('üìß Detalhes das notifica√ß√µes cr√≠ticas:', 
          widgetNotifications.filter(n => n.severity === 'critical').map(n => ({ 
            titulo: n.title, 
            mensagem: n.message,
            severidade: n.severity 
          }))
        );
        
        // Mapa de estilos para cada severidade (usado pela Cloud Function)
        const severityStyles = {
          critical: { bg: '#FEE2E2', border: '#DC2626', text: '#991B1B', label: 'Cr√≠tica' },
          alert:    { bg: '#FFF3E0', border: '#F97316', text: '#C2410C', label: 'Alerta' },
          warn:     { bg: '#FFFBEB', border: '#F59E0B', text: '#92400E', label: 'Aviso' },
          info:     { bg: '#DBEAFE', border: '#3B82F6', text: '#1E40AF', label: 'Info' }
        };
        
        // Adiciona estilos expl√≠citos a cada notifica√ß√£o para a Cloud Function usar
        const notificationsWithStyles = widgetNotifications.map(n => ({
          ...n,
          style: severityStyles[n.severity] || severityStyles.info
        }));
        
        // Contagem de severidades para o resumo do email
        const severityCounts = {
          critical: widgetNotifications.filter(n => n.severity === 'critical').length,
          alert: widgetNotifications.filter(n => n.severity === 'alert').length,
          warn: widgetNotifications.filter(n => n.severity === 'warn').length,
          info: widgetNotifications.filter(n => n.severity === 'info').length
        };
        
        const functionUrl = 'https://us-central1-mediagrowth-a5349.cloudfunctions.net/sendDailyNotifications';
        
        const payload = {
          test: true,
          testEmails: emails,
          clientKey: clientKey,
          userId: auth.currentUser.uid,
          notifications: notificationsWithStyles,
          severityCounts: severityCounts, // Contagem para o resumo
          severityStyles: severityStyles   // Estilos para aplicar no template
        };
        
        console.log('üì¶ [EMAIL TESTE] Payload completo:', JSON.stringify(payload, null, 2));
        console.log('üì¶ [EMAIL TESTE] Total de notifica√ß√µes no payload:', payload.notifications.length);
        console.log('üì¶ [EMAIL TESTE] Notifica√ß√µes por severidade:', {
          critical: payload.notifications.filter(n => n.severity === 'critical').length,
          alert: payload.notifications.filter(n => n.severity === 'alert').length,
          warn: payload.notifications.filter(n => n.severity === 'warn').length,
          info: payload.notifications.filter(n => n.severity === 'info').length
        });
        console.log('üì¶ [EMAIL TESTE] Enviando para:', functionUrl);
        
        const response = await fetch(functionUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        console.log('üì° [EMAIL TESTE] Status da resposta:', response.status, response.statusText);
        
        if(response.ok) {
          const result = await response.json();
          console.log('‚úÖ [EMAIL TESTE] Resposta completa da Cloud Function:', result);
          console.log('‚úÖ [EMAIL TESTE] Emails enviados para:', result.emailsSent || emails);
          console.log('‚úÖ [EMAIL TESTE] Total de notifica√ß√µes processadas:', result.notificationsCount || payload.notifications.length);
          console.log('‚úÖ Email de teste enviado com sucesso:', result);
          showNotificationStatus('‚úÖ Email de teste enviado com sucesso para: ' + emails.join(', '), 'success');
        } else {
          const errorText = await response.text();
          console.error('‚ùå [EMAIL TESTE] Status HTTP:', response.status);
          console.error('‚ùå [EMAIL TESTE] Headers:', Object.fromEntries(response.headers.entries()));
          console.error('‚ùå [EMAIL TESTE] Corpo da resposta:', errorText);
          console.error('‚ùå Erro ao enviar email de teste:', errorText);
          showNotificationStatus('‚ùå Erro ao enviar email (HTTP ' + response.status + '): ' + errorText, 'error');
        }
      } catch(err) {
        console.error('‚ùå [EMAIL TESTE] Erro completo:', err);
        console.error('‚ùå [EMAIL TESTE] Stack trace:', err.stack);
        console.error('‚ùå [EMAIL TESTE] Tipo de erro:', err.name);
        console.error('‚ùå Erro ao enviar email de teste:', err);
        showNotificationStatus('‚ùå Erro ao enviar email: ' + err.message, 'error');
      }
    }

    async function handleTestEmailClick() {
      // Usar SendGrid Backend
      await sendTestEmailViaBackend();
      return;
      
      // C√ìDIGO ANTIGO (EmailJS) - Comentado
      console.log('üîµ Bot√£o de teste clicado');
      
      const clientKey = getClientKey();
      console.log('üîµ ClientKey:', clientKey);
      console.log('üîµ Auth user:', auth.currentUser?.email);
      
      if(!auth.currentUser) {
        showNotificationStatus('‚ùå Erro: Usu√°rio n√£o autenticado', 'error');
        console.error('‚ùå Usu√°rio n√£o autenticado');
        return;
      }
      
      if(!clientKey) {
        showNotificationStatus('‚ùå Erro: Cliente n√£o selecionado', 'error');
        console.error('‚ùå ClientKey n√£o encontrado');
        return;
      }

      // Pegar o primeiro email da lista
      const emailsInput = document.getElementById('notificationEmails');
      if(!emailsInput || !emailsInput.value.trim()) {
        showNotificationStatus('‚ùå Por favor, adicione pelo menos um email antes de testar', 'error');
        return;
      }

      const emails = emailsInput.value.split(',').map(e => e.trim()).filter(e => e.length > 0);
      const testEmail = emails[0];
      
      showNotificationStatus('üì® Enviando email de teste para ' + testEmail + '...', 'info');
      console.log('üì® Iniciando envio de email de teste para:', testEmail);
      
      try {
        // Verificar se emailjs est√° carregado
        if(typeof emailjs === 'undefined') {
          throw new Error('EmailJS n√£o foi carregado. Atualize a p√°gina (F5) e tente novamente.');
        }
        
        // Usar EmailJS para enviar email diretamente do frontend
        const templateParams = {
          to_email: testEmail,
          client_name: clientKey,
          test_message: 'Este √© um email de teste do sistema de notifica√ß√µes MediaGrowth.',
          test_date: new Date().toLocaleDateString('pt-BR'),
          test_time: new Date().toLocaleTimeString('pt-BR')
        };
        
        console.log('üîç Verificando EmailJS...');
        console.log('ÔøΩ emailjs dispon√≠vel:', typeof emailjs !== 'undefined');
        console.log('üì§ Service ID: service_mediagrowth');
        console.log('ÔøΩüì§ Template ID: template_usmtdo5');
        console.log('üì§ Enviando via EmailJS com params:', templateParams);
        
        const response = await emailjs.send(
          'service_mediagrowth', // Service ID
          'template_snobcgl', // Template ID correto
          templateParams
        );
        
        console.log('‚úÖ Resposta completa do EmailJS:', response);
        console.log('‚úÖ Email enviado com sucesso!', response);
        showNotificationStatus('‚úÖ Email de teste enviado com sucesso para ' + testEmail, 'success');
        
      } catch(err) {
        console.error('‚ùå Erro ao enviar email:', err);
        
        let errorMessage = 'Erro ao enviar email de teste: ';
        if(err.text) {
          errorMessage += err.text;
        } else if(err.message) {
          errorMessage += err.message;
        } else {
          errorMessage += 'Erro desconhecido. Verifique se voc√™ criou o Service e Template no EmailJS.';
        }
        
        showNotificationStatus(errorMessage, 'error');
      }
    }

    async function handleClearEmailClick() {
      const clientKey = getClientKey();
      if(!auth.currentUser || !clientKey) return;
      
      if(!confirm('Tem certeza que deseja limpar toda a configura√ß√£o de notifica√ß√µes por email?')) {
        return;
      }
      
      try {
        const settingsRef = doc(db, 'usuarios', auth.currentUser.uid, 'clients', clientKey);
        await updateDoc(settingsRef, {
          emailNotifications: deleteField()
        });
        
        // ============================================
        // REMOVER DO SERVICE WORKER
        // ============================================
        await removeConfigFromServiceWorker(clientKey);
        
        // Clear form
        const emailsInput = document.getElementById('notificationEmails');
        const frequencySelect = document.getElementById('notificationFrequency');
        const timeInput = document.getElementById('notificationTime');
        
        if(emailsInput) emailsInput.value = '';
        if(frequencySelect) {
          frequencySelect.value = '';
          updateScheduleVisibility('');
        }
        if(timeInput) timeInput.value = '09:00';
        
        const currentConfigSection = document.getElementById('currentEmailConfig');
        if(currentConfigSection) currentConfigSection.style.display = 'none';
        
        showNotificationStatus('‚úÖ Configura√ß√£o removida com sucesso!', 'success');
      } catch(err) {
        console.error('Error clearing email notification settings:', err);
        showNotificationStatus('Erro ao limpar configura√ß√£o: ' + err.message, 'error');
      }
    }

    // ============================================
    // FUN√á√ÉO AUTOM√ÅTICA DE ENVIO DE NOTIFICA√á√ïES
    // ============================================
    async function sendScheduledNotifications() {
      const timestamp = new Date().toLocaleString('pt-BR');
      console.log('üîî [' + timestamp + '] Verificando notifica√ß√µes agendadas...');
      
      const clientKey = getClientKey();
      if(!auth.currentUser || !clientKey) {
        console.log('‚ùå [' + timestamp + '] Usu√°rio n√£o autenticado ou cliente n√£o selecionado');
        console.log('   ‚îî‚îÄ auth.currentUser:', !!auth.currentUser);
        console.log('   ‚îî‚îÄ clientKey:', clientKey);
        return;
      }

      try {
        const settingsRef = doc(db, 'usuarios', auth.currentUser.uid, 'clients', clientKey);
        const settingsDoc = await getDoc(settingsRef);
        
        console.log('üìÑ Documento de configura√ß√£o existe?', settingsDoc.exists());
        
        if(!settingsDoc.exists() || !settingsDoc.data().emailNotifications) {
          console.log('‚ö†Ô∏è Nenhuma configura√ß√£o de email encontrada');
          console.log('   ‚îî‚îÄ settingsDoc.exists():', settingsDoc.exists());
          console.log('   ‚îî‚îÄ emailNotifications:', settingsDoc.exists() ? settingsDoc.data().emailNotifications : 'N/A');
          return;
        }

        const emailConfig = settingsDoc.data().emailNotifications;
        const { emails, frequency, time } = emailConfig;
        
        console.log('‚öôÔ∏è Configura√ß√£o de email encontrada:', {
          emails: emails,
          frequency: frequency,
          time: time,
          configCompleta: emailConfig
        });

        if(!emails || emails.length === 0) {
          console.log('‚ö†Ô∏è Nenhum email configurado');
          console.log('   ‚îî‚îÄ emails:', emails);
          return;
        }

        const now = new Date();
        const currentHour = now.getHours();
        const currentMinute = now.getMinutes();
        const currentTime = String(currentHour).padStart(2, '0') + ':' + String(currentMinute).padStart(2, '0');
        
        const configParts = (time || '09:00').split(':');
        const configHour = parseInt(configParts[0], 10);
        const configMinute = parseInt(configParts[1], 10);
        
        console.log('‚è∞ Hora atual: ' + currentTime + ', Hora configurada: ' + time);
        
        // Verificar dia da semana/m√™s ANTES de verificar hor√°rio
        const dayOfWeek = now.getDay();
        const dayOfMonth = now.getDate();
        
        if(frequency === 'weekly' && dayOfWeek !== 1) {
          console.log('üìÖ Envio semanal configurado para segundas-feiras (dia atual: ' + dayOfWeek + ')');
          return;
        }
        
        if(frequency === 'monthly' && dayOfMonth !== 1) {
          console.log('üìÖ Envio mensal configurado para o dia 1 (dia atual: ' + dayOfMonth + ')');
          return;
        }
        
        // Verificar se j√° enviou hoje/esta semana/este m√™s
        const lastSentKey = 'mediagrowth_last_email_sent_' + clientKey + '_' + time;
        const lastSent = localStorage.getItem(lastSentKey);
        if(lastSent) {
          const lastSentDate = new Date(lastSent);
          
          if(frequency === 'daily') {
            if(lastSentDate.toDateString() === now.toDateString()) {
              console.log('‚úÖ Email di√°rio j√° foi enviado hoje √†s ' + time);
              return;
            }
          } else if(frequency === 'weekly') {
            const daysSince = Math.floor((now - lastSentDate) / (1000 * 60 * 60 * 24));
            if(daysSince < 7) {
              console.log('‚úÖ Email semanal j√° foi enviado esta semana');
              return;
            }
          } else if(frequency === 'monthly') {
            if(lastSentDate.getMonth() === now.getMonth() && lastSentDate.getFullYear() === now.getFullYear()) {
              console.log('‚úÖ Email mensal j√° foi enviado este m√™s');
              return;
            }
          }
        }
        
        // Verificar se j√° passou do hor√°rio configurado (e ainda n√£o enviou)
        const currentTimeInMinutes = currentHour * 60 + currentMinute;
        const configTimeInMinutes = configHour * 60 + configMinute;
        
        if(currentTimeInMinutes < configTimeInMinutes) {
          console.log('‚è≥ Ainda n√£o √© hora de enviar. Aguardando ' + time + '...');
          return;
        }
        
        console.log('üöÄ Hor√°rio atingido! (' + currentTime + ' >= ' + time + ') Enviando email ' + frequency + '...');
        
        const widgetNotifications = window.getNotificationItems ? window.getNotificationItems() : notificationItems || [];
        console.log('üìã ' + widgetNotifications.length + ' notifica√ß√µes para enviar');
        console.log('üîç Notifica√ß√µes cr√≠ticas (atrasadas):', widgetNotifications.filter(n => n.severity === 'critical').length);
        console.log('üìß Detalhes das notifica√ß√µes cr√≠ticas:', 
          widgetNotifications.filter(n => n.severity === 'critical').map(n => ({ 
            titulo: n.title, 
            mensagem: n.message,
            severidade: n.severity 
          }))
        );
        
        // Mapa de estilos para cada severidade (usado pela Cloud Function)
        const severityStyles = {
          critical: { bg: '#FEE2E2', border: '#DC2626', text: '#991B1B', label: 'Cr√≠tica' },
          alert:    { bg: '#FFF3E0', border: '#F97316', text: '#C2410C', label: 'Alerta' },
          warn:     { bg: '#FFFBEB', border: '#F59E0B', text: '#92400E', label: 'Aviso' },
          info:     { bg: '#DBEAFE', border: '#3B82F6', text: '#1E40AF', label: 'Info' }
        };
        
        // Adiciona estilos expl√≠citos a cada notifica√ß√£o para a Cloud Function usar
        const notificationsWithStyles = widgetNotifications.map(n => ({
          ...n,
          style: severityStyles[n.severity] || severityStyles.info
        }));
        
        // Contagem de severidades para o resumo do email
        const severityCounts = {
          critical: widgetNotifications.filter(n => n.severity === 'critical').length,
          alert: widgetNotifications.filter(n => n.severity === 'alert').length,
          warn: widgetNotifications.filter(n => n.severity === 'warn').length,
          info: widgetNotifications.filter(n => n.severity === 'info').length
        };
        
        let functionName = 'sendDailyNotifications';
        if(frequency === 'weekly') functionName = 'sendWeeklyNotifications';
        if(frequency === 'monthly') functionName = 'sendMonthlyNotifications';
        
        const functionUrl = 'https://us-central1-mediagrowth-a5349.cloudfunctions.net/' + functionName;
        
        const payload = {
          test: false,
          testEmails: emails,
          clientKey: clientKey,
          userId: auth.currentUser.uid,
          notifications: notificationsWithStyles,
          severityCounts: severityCounts, // Contagem para o resumo
          severityStyles: severityStyles   // Estilos para aplicar no template
        };
        
        console.log('üì¶ [EMAIL AUTOM√ÅTICO] Payload completo:', JSON.stringify(payload, null, 2));
        console.log('üì¶ [EMAIL AUTOM√ÅTICO] Total de notifica√ß√µes no payload:', payload.notifications.length);
        console.log('üì¶ [EMAIL AUTOM√ÅTICO] Notifica√ß√µes cr√≠ticas no payload:', 
          payload.notifications.filter(n => n.severity === 'critical').length
        );
        console.log('üì¶ [EMAIL AUTOM√ÅTICO] Lista de severidades:', 
          payload.notifications.map(n => n.severity)
        );
        
        console.log('üì§ Enviando para Cloud Function:', functionUrl);
        
        try {
          const response = await fetch(functionUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          
          if(response.ok) {
            const result = await response.json();
            console.log('‚úÖ [EMAIL AUTOM√ÅTICO] Resposta da Cloud Function:', result);
            console.log('‚úÖ [EMAIL AUTOM√ÅTICO] Emails enviados:', result.sent || 'n√£o especificado');
            console.log('‚úÖ [EMAIL AUTOM√ÅTICO] Notifica√ß√µes processadas:', result.notificationsCount || 'n√£o especificado');
            console.log('‚úÖ Emails agendados enviados com sucesso √†s ' + currentTime + ':', result);
            localStorage.setItem(lastSentKey, now.toISOString());
            console.log('üíæ Marcado como enviado em:', lastSentKey, '=', now.toISOString());
            
            if(window.showNotificationStatus) {
              const freqLabel = frequency === 'daily' ? 'di√°rio' : frequency === 'weekly' ? 'semanal' : 'mensal';
              window.showNotificationStatus('‚úÖ Email ' + freqLabel + ' enviado √†s ' + currentTime + '!', 'success');
            }
          } else {
            const errorText = await response.text();
            console.error('‚ùå [EMAIL AUTOM√ÅTICO] Status HTTP:', response.status);
            console.error('‚ùå [EMAIL AUTOM√ÅTICO] Resposta de erro:', errorText);
            console.error('‚ùå Erro ao enviar emails agendados:', errorText);
            
            if(window.showNotificationStatus) {
              window.showNotificationStatus('‚ùå Erro ao enviar email: HTTP ' + response.status, 'error');
            }
          }
        } catch(fetchErr) {
          console.error('‚ùå [EMAIL AUTOM√ÅTICO] Erro de rede completo:', fetchErr);
          console.error('‚ùå [EMAIL AUTOM√ÅTICO] Stack trace:', fetchErr.stack);
          console.error('‚ùå Erro de rede ao enviar emails:', fetchErr);
        }

      } catch(err) {
        console.error('‚ùå Erro ao enviar notifica√ß√µes agendadas:', err);
      }
    }

    // ============================================
    // SINCRONIZA√á√ÉO COM SERVICE WORKER
    // ============================================
    async function syncConfigWithServiceWorker(clientKey, emailSettings) {
      if (!navigator.serviceWorker || !navigator.serviceWorker.controller) {
        console.log('‚ö†Ô∏è Service Worker n√£o dispon√≠vel para sincronizar');
        return;
      }
      
      try {
        const config = {
          clientKey: clientKey,
          userId: auth.currentUser.uid,
          emails: emailSettings.emails,
          frequency: emailSettings.frequency,
          time: emailSettings.time,
          lastSent: localStorage.getItem(`mediagrowth_last_email_sent_${clientKey}_${emailSettings.time}`)
        };
        
        console.log('üì§ Sincronizando configura√ß√£o com Service Worker:', config);
        navigator.serviceWorker.controller.postMessage({
          type: 'SAVE_CONFIG',
          config: config
        });
        
        // Tamb√©m sincronizar notifica√ß√µes do widget
        await syncNotificationsWithServiceWorker(clientKey);
        
      } catch (error) {
        console.error('‚ùå Erro ao sincronizar com Service Worker:', error);
      }
    }
    
    async function syncNotificationsWithServiceWorker(clientKey) {
      if (!navigator.serviceWorker || !navigator.serviceWorker.controller) {
        return;
      }
      
      try {
        const notifications = window.getNotificationItems ? window.getNotificationItems() : notificationItems || [];
        
        console.log('üì§ Sincronizando notifica√ß√µes com Service Worker:', notifications.length);
        navigator.serviceWorker.controller.postMessage({
          type: 'SAVE_NOTIFICATIONS',
          clientKey: clientKey,
          notifications: notifications
        });
        
      } catch (error) {
        console.error('‚ùå Erro ao sincronizar notifica√ß√µes:', error);
      }
    }
    
    async function removeConfigFromServiceWorker(clientKey) {
      if (!navigator.serviceWorker || !navigator.serviceWorker.controller) {
        return;
      }
      
      try {
        console.log('üì§ Removendo configura√ß√£o do Service Worker:', clientKey);
        navigator.serviceWorker.controller.postMessage({
          type: 'DELETE_CONFIG',
          clientKey: clientKey
        });
      } catch (error) {
        console.error('‚ùå Erro ao remover config do Service Worker:', error);
      }
    }

    setInterval(sendScheduledNotifications, 60 * 1000);
    
    setTimeout(sendScheduledNotifications, 5000);


    // Load team members when settings panel opens or when switching to team section
    const originalRenderSettingsSection = renderSettingsSection;
    function enhancedRenderSettingsSection(sectionKey) {
      originalRenderSettingsSection(sectionKey);
      if(sectionKey === 'users') {
        loadTeamMembers();
      } else if(sectionKey === 'notifications') {
        // Aguardar um momento para o DOM ser renderizado
        setTimeout(() => {
          loadEmailNotificationSettings();
          initEmailNotificationListeners();
        }, 100);
      }
    }
    renderSettingsSection = enhancedRenderSettingsSection;

    if(settingsPanel && settingsBody){
      renderSettingsSection(currentSettingsSection);
      settingsPanel.setAttribute('aria-hidden', 'true');
    }

    if(tabsContainer && mainMenuToggle){
      const mobileMenuMedia = window.matchMedia("(max-width: 820px)");
      const closeMainMenu = ()=>{
        tabsContainer.classList.remove("menu-open");
        mainMenuToggle.setAttribute("aria-expanded", "false");
      };
      mainMenuToggle.addEventListener("click", ()=>{
        const isOpen = tabsContainer.classList.toggle("menu-open");
        mainMenuToggle.setAttribute("aria-expanded", isOpen ? "true" : "false");
      });
      sectionTabs?.addEventListener("click", (event)=>{
        if(event.target instanceof Element && event.target.closest(".tab-btn") && mobileMenuMedia.matches){
          closeMainMenu();
        }
      });
      const handleMenuMedia = (event)=>{
        if(!event.matches){
          closeMainMenu();
        }
      };
      if(typeof mobileMenuMedia.addEventListener === "function"){
        mobileMenuMedia.addEventListener("change", handleMenuMedia);
      }else if(typeof mobileMenuMedia.addListener === "function"){
        mobileMenuMedia.addListener(handleMenuMedia);
      }
      document.addEventListener("click", (event)=>{
        if(!mobileMenuMedia.matches || !tabsContainer.classList.contains("menu-open")) return;
        const target = event.target;
        if(!(target instanceof Element)) return;
        if(target === mainMenuToggle) return;
        if(tabsContainer.contains(target)) return;
        closeMainMenu();
      });
    }

    function renderHeaderCalendarBar(){
      if(!headerCalendarDays || !headerCalendarMonth) return;
      const now = new Date();
      const totalDays = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
      const formatter = new Intl.DateTimeFormat('pt-BR', { month: 'long', year: 'numeric' });
      let label = formatter.format(now);
      if(label){
        label = label.charAt(0).toUpperCase() + label.slice(1);
      }
      headerCalendarMonth.textContent = label;
      headerCalendarDays.innerHTML = '';
      const frag = document.createDocumentFragment();
      for(let day = 1; day <= totalDays; day++){
        const cell = document.createElement('div');
        cell.className = 'header-calendar-day';
        cell.setAttribute('role', 'listitem');
        cell.textContent = String(day);
        if(day === now.getDate()){
          cell.classList.add('today');
          cell.setAttribute('aria-current', 'date');
        }
        frag.appendChild(cell);
      }
      headerCalendarDays.appendChild(frag);
      headerCalendarBar?.setAttribute('aria-hidden', 'false');
    }
    renderHeaderCalendarBar();
    const WEBHOOKS = {
      calendar: localStorage.getItem('webhook_calendar') || '',
      demandas: localStorage.getItem('webhook_demandas') || ''
    };
    if (calendarWebhookInput) calendarWebhookInput.value = WEBHOOKS.calendar;
    if (demandasWebhookInput) demandasWebhookInput.value = WEBHOOKS.demandas;
    function persistWebhook(type, value){
      WEBHOOKS[type] = (value||'').trim();
      localStorage.setItem('webhook_'+type, WEBHOOKS[type]);
    }
    calendarWebhookInput?.addEventListener('change', ()=> persistWebhook('calendar', calendarWebhookInput.value));
    demandasWebhookInput?.addEventListener('change', ()=> persistWebhook('demandas', demandasWebhookInput.value));
    async function sendWebhook(type, payload){
      const url = WEBHOOKS[type];
      if(!url) return;
      const finalPayload = { email: auth.currentUser?.email || null, ...payload };
      try{
        await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(finalPayload) });
      }catch(err){ console.warn('Webhook', err); }
    }

    // ===== IA =====
    const iaQuestion = $("iaQuestion"), iaSend = $("iaSend"),
          iaHistory = $("iaHistory"), iaChatList = $("iaChatList"),
          iaNewChat = $("iaNewChat"), iaChatSearch = $("iaChatSearch"),
          iaCurrentTitle = $("iaCurrentTitle"), iaRenameChat = $("iaRenameChat"),
          iaDeleteChat = $("iaDeleteChat"), iaEmptyState = $("iaEmptyState"),
          iaComposer = $("iaComposer"), iaDocsInput = $("iaDocsInput"),
          iaDocsPick = $("iaDocsPick"), iaDocsUpload = $("iaDocsUpload"),
          iaDocsStatus = $("iaDocsStatus"), iaDocsList = $("iaDocsList"),
          iaKnowledge = $("iaKnowledge"), iaDocsCount = $("iaDocsCount"),
          iaSourceNote = $("iaSourceNote");
    
    // Elementos do preview de imagem na aba IA
    const iaImagePreviewWrapper = $("iaImagePreviewWrapper"),
          iaImagePreviewImg = $("iaImagePreviewImg"),
          iaImagePreviewName = $("iaImagePreviewName"),
          iaImagePreviewSize = $("iaImagePreviewSize"),
          iaImagePreviewRemove = $("iaImagePreviewRemove");
    
    // Vari√°vel global para armazenar a imagem atual na aba IA
    let IA_CURRENT_IMAGE = null;
    
    // Modal de planejamento
    const iaPlanningModal = $("iaPlanningModal"),
          iaPlanningModalClose = $("iaPlanningModalClose"),
          iaPlanningText = $("iaPlanningText"),
          iaPlanningStatus = $("iaPlanningStatus"),
          iaPlanningResponsavel = $("iaPlanningResponsavel"),
          iaPlanningPrazoInicio = $("iaPlanningPrazoInicio"),
          iaPlanningPrazoFim = $("iaPlanningPrazoFim"),
          iaPlanningPeriodoField = $("iaPlanningPeriodoField"),
          iaPlanningPeriodoToggle = $("iaPlanningPeriodoToggle"),
          iaPlanningAddMore = $("iaPlanningAddMore"),
          iaPlanningCancel = $("iaPlanningCancel"),
          iaPlanningSubmit = $("iaPlanningSubmit"),
          iaMonthPickerModal = $("iaMonthPickerModal"),
          iaMonthPickerClose = $("iaMonthPickerClose"),
          iaMonthPickerCancel = $("iaMonthPickerCancel"),
          iaMonthPickerConfirm = $("iaMonthPickerConfirm"),
          iaMonthPickerCount = $("iaMonthPickerCount"),
          iaYearDisplay = $("iaYearDisplay");
    // Modal de metas
    const iaMetasMapperModal = $("iaMetasMapperModal"),
          iaMetasMapperClose = $("iaMetasMapperClose"),
          iaMetasMapperCancel = $("iaMetasMapperCancel"),
          iaMetasMapperConfirm = $("iaMetasMapperConfirm"),
          iaMetasMapperBody = $("iaMetasMapperBody"),
          iaMetasMapperSelectAll = $("iaMetasMapperSelectAll"),
          iaMetasMapperApplyToSelected = $("iaMetasMapperApplyToSelected");
    let IA_CHATS = [], CURRENT_CHAT = null;
    let IA_DOCS = [];
    let IA_DOCS_PENDING = [];
    let PLATFORM_CODE = "";
    let PLATFORM_TEXT = "";
    let IA_RESPONSE_SIZE = "pequena"; // Tamanho padr√£o da resposta
    let IA_SELECTED_SOURCES = ['all']; // Fontes selecionadas: 'all' ou array espec√≠fico
    
    // Estado do month picker
    let MONTH_PICKER_STATE = {
      selectedMonth: null,
      selectedYear: new Date().getFullYear(),
      linesToAdd: [],
      callback: null
    };
    
    // Estado do metas mapper
    let METAS_MAPPER_STATE = {
      numbers: [], // Array de { value, context, metaId, monthKey }
      text: '',
      selectedIndices: new Set() // Rastrear checkboxes marcados
    };
    
    const IA_CONTEXT_CACHE = { ts: 0, data: null };
    const IA_CONTEXT_TTL = 10000;
    
    // ================================================================
    // üéØ CONFIGURA√á√ïES DE OTIMIZA√á√ÉO DE TOKENS (Economia de ~60%)
    // ================================================================
    const IA_MAX_CONTEXT_CHARS = 50000;  // Reduzido de 150k para 50k (economia de ~67%)
    const IA_MAX_PLATFORM_CHARS = 15000; // Reduzido de 60k para 15k (economia de ~75%)
    const IA_DOC_SNIPPET_CHARS = 8000;   // Reduzido de 20k para 8k (economia de ~60%)
    const IA_MAX_DOC_CHARS = 40000;      // Reduzido de 120k para 40k (economia de ~67%)
    
    // Limites INDIVIDUAIS por aba (mais granular)
    // üéØ LIMITES OTIMIZADOS v2 - Reduzidos para economia de tokens
    // Meta: ~10k tokens input por consulta (antes era ~32k)
    const IA_LIMITS = {
      estruturacaoNotes: 6000,     // Reduzido de 15k - Anota√ß√µes resumidas
      estruturacaoAnalyses: 12000, // Reduzido de 25k - An√°lises principais
      posts: 3000,                 // Reduzido de 8k - Posts recentes/relevantes
      demandas: 3000,              // Reduzido de 6k - Demandas ativas
      metas: 5000,                 // Reduzido de 10k - Metas principais
      cac: 3000,                   // Reduzido de 6k - CAC resumido
      anotacoes: 2500,             // Reduzido de 5k - √öltimas anota√ß√µes
      acessos: 1500,               // Reduzido de 3k - Credenciais essenciais
      macro: 4000,                 // Reduzido de 8k - Macro resumido
      planejamento: 4000,          // Reduzido de 8k - Planejamento atual
      arquivos: 1000,              // Reduzido de 2k - Estrutura m√≠nima
      calendario: 2500,            // Reduzido de 5k - Eventos pr√≥ximos
      iframes: 1500                // Reduzido de 3k - Widgets ativos
    };
    
    // Cache de contexto comprimido para evitar reprocessamento
    const IA_COMPRESSED_CACHE = { ts: 0, data: null, hash: '' };
    const IA_COMPRESSED_TTL = 30000; // 30 segundos de cache
    
    // Fun√ß√£o para criar hash simples do conte√∫do
    function simpleHash(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return hash.toString(16);
    }
    
    // Fun√ß√£o para comprimir texto removendo redund√¢ncias
    function compressContextText(text, maxChars) {
      if (!text || text.length <= maxChars) return text;
      
      // 1. Remover espa√ßos m√∫ltiplos e linhas em branco excessivas
      let compressed = text
        .replace(/\n{3,}/g, '\n\n')           // M√∫ltiplas quebras ‚Üí duas
        .replace(/[ \t]{2,}/g, ' ')            // M√∫ltiplos espa√ßos ‚Üí um
        .replace(/(\n\s*){3,}/g, '\n\n')       // Linhas vazias excessivas
        .replace(/\.{3,}/g, '...')             // M√∫ltiplos pontos
        .replace(/={3,}/g, '===')              // M√∫ltiplos iguais
        .replace(/-{3,}/g, '---')              // M√∫ltiplos tra√ßos
        .replace(/_{3,}/g, '___')              // M√∫ltiplos underscores
        .trim();
      
      // 2. Se ainda muito grande, remover se√ß√µes menos importantes
      if (compressed.length > maxChars) {
        // Remover logs de debug e timestamps detalhados
        compressed = compressed
          .replace(/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z/g, '[data]')
          .replace(/\[\d{2}\/\d{2}\/\d{4}, \d{2}:\d{2}:\d{2}\]/g, '[data]')
          .replace(/console\.log\([^)]+\)/g, '')
          .replace(/Atualizado em:.*$/gm, '')
          .replace(/Criado em:.*$/gm, '');
      }
      
      // 3. Truncar se ainda necess√°rio
      if (compressed.length > maxChars) {
        const cutPoint = compressed.lastIndexOf('\n', maxChars - 50);
        compressed = compressed.slice(0, cutPoint > maxChars * 0.8 ? cutPoint : maxChars - 50);
        compressed += '\n...[resumido para economia de tokens]';
      }
      
      return compressed;
    }
    
    // Fun√ß√£o para sumarizar an√°lises longas mantendo pontos-chave
    function summarizeAnalysis(analysisText, maxChars = 8000) {
      if (!analysisText || analysisText.length <= maxChars) return analysisText;
      
      // Extrair se√ß√µes importantes (t√≠tulos em negrito, bullets principais)
      const lines = analysisText.split('\n');
      const importantLines = [];
      let currentSection = '';
      let charCount = 0;
      
      for (const line of lines) {
        const trimmed = line.trim();
        
        // Sempre incluir t√≠tulos e cabe√ßalhos
        if (trimmed.startsWith('**') || trimmed.startsWith('üìä') || 
            trimmed.startsWith('üéØ') || trimmed.startsWith('üìã') ||
            trimmed.startsWith('‚úÖ') || trimmed.startsWith('‚ùå') ||
            trimmed.startsWith('‚Ä¢') || trimmed.match(/^\d+\./)) {
          
          if (charCount + trimmed.length < maxChars) {
            importantLines.push(line);
            charCount += line.length + 1;
          }
        }
        // Incluir primeiras linhas de cada se√ß√£o
        else if (trimmed && importantLines.length < 100 && charCount < maxChars * 0.9) {
          // Limitar linhas de conte√∫do a 200 chars cada
          const shortLine = trimmed.length > 200 ? trimmed.slice(0, 197) + '...' : trimmed;
          if (charCount + shortLine.length < maxChars) {
            importantLines.push(shortLine);
            charCount += shortLine.length + 1;
          }
        }
      }
      
      return importantLines.join('\n') + '\n...[an√°lise resumida]';
    }
    
    // üéØ OTIMIZA√á√ÉO: Detectar relev√¢ncia do contexto com base na pergunta
    function detectRelevantSources(question) {
      const q = question.toLowerCase();
      const relevant = new Set(['estruturacao']); // Sempre incluir estrutura√ß√£o base
      
      // Mapeamento de palavras-chave para fontes
      const keywordMap = {
        metas: ['meta', 'objetivo', 'target', 'resultado', 'faturamento', 'vendas', 'leads', 'convers√£o', 'conversao'],
        cac: ['cac', 'custo', 'investimento', 'gasto', 'budget', 'roi', 'roas', 'retorno'],
        calendario: ['post', 'publica√ß√£o', 'publicacao', 'conte√∫do', 'conteudo', 'agend', 'calend√°rio', 'calendario'],
        posts: ['post', 'publica√ß√£o', 'publicacao', 'feed', 'stories', 'reels', 'carrossel'],
        demandas: ['tarefa', 'demanda', 'projeto', 'pend√™ncia', 'pendencia', 'to-do', 'todo', 'atividade'],
        macro: ['mensal', 'an√°lise macro', 'analise macro', 'desempenho', 'performance', 'hist√≥rico', 'historico'],
        planejamento: ['planejamento', 'plano', 'estrat√©gia', 'estrategia', 'roadmap', 'trimestre', 'semestre'],
        anotacoes: ['anota√ß√£o', 'anotacao', 'nota', 'observa√ß√£o', 'observacao', 'lembrete'],
        acessos: ['acesso', 'login', 'senha', 'credencial', 'ferramenta', 'conta'],
        arquivos: ['arquivo', 'documento', 'pasta', 'upload', 'anexo'],
        diagnostico: ['diagn√≥stico', 'diagnostico', 'problema', 'oportunidade', 'swot', 'for√ßas', 'fraquezas'],
        direcionamento: ['direcionamento', 'meta anual', 'proje√ß√£o', 'projecao', '12 meses'],
        concorrencia: ['concorrente', 'concorr√™ncia', 'concorrencia', 'mercado', 'competidor'],
        cdt: ['cdt', 'construir', 'diminuir', 'transformar', 'matriz'],
        puv: ['puv', 'proposta √∫nica', 'proposta unica', 'diferencial', 'valor'],
        pai: ['pai', 'p√∫blico alvo', 'publico alvo', 'persona', 'avatar', 'cliente ideal'],
        anuncios: ['an√∫ncio', 'anuncio', 'ads', 'tr√°fego', 'trafego', 'campanha paga', 'facebook ads', 'google ads'],
        seo: ['seo', 'org√¢nico', 'organico', 'google', 'busca', 'rankeamento'],
        redes: ['rede social', 'instagram', 'facebook', 'linkedin', 'tiktok', 'youtube'],
        copy: ['copy', 'copywriting', 'texto', 'headline', 'cta', 'persuas√£o', 'persuasao'],
        conteudo: ['conte√∫do', 'conteudo', 'blog', 'artigo', 'v√≠deo', 'video', 'podcast'],
        criativos: ['criativo', 'banner', 'imagem', 'visual', 'design'],
        crm: ['crm', 'automa√ß√£o', 'automacao', 'email', 'funil', 'nutri√ß√£o', 'nutricao'],
        comercial: ['comercial', 'vendas', 'script', 'obje√ß√£o', 'objecao', 'fechamento'],
        lp: ['landing page', 'lp', 'p√°gina de captura', 'pagina de captura', 'squeeze'],
        website: ['site', 'website', 'institucional', 'homepage']
      };
      
      // Detectar fontes relevantes baseado nas palavras-chave
      for (const [source, keywords] of Object.entries(keywordMap)) {
        if (keywords.some(kw => q.includes(kw))) {
          relevant.add(source);
        }
      }
      
      // Se a pergunta √© gen√©rica (curta ou sem palavras-chave espec√≠ficas), incluir mais fontes
      if (q.length < 30 || relevant.size <= 1) {
        relevant.add('metas');
        relevant.add('analise-todos');
      }
      
      return Array.from(relevant);
    }
    
    // Fun√ß√£o para filtrar contexto baseado em relev√¢ncia (ECONOMIA EXTRA)
    function filterContextByRelevance(contextText, question, maxChars) {
      if (!contextText || contextText.length <= maxChars) return contextText;
      
      const q = question.toLowerCase();
      const lines = contextText.split('\n');
      const scoredLines = [];
      
      // Palavras importantes da pergunta (excluindo stopwords)
      const stopwords = ['o', 'a', 'os', 'as', 'um', 'uma', 'de', 'da', 'do', 'para', 'com', 'em', 'que', '√©', 'e', 'ou'];
      const questionWords = q.split(/\s+/).filter(w => w.length > 2 && !stopwords.includes(w));
      
      for (const line of lines) {
        const lineLower = line.toLowerCase();
        let score = 0;
        
        // T√≠tulos e cabe√ßalhos = alta prioridade
        if (line.match(/^[\*üìäüéØüìãüî¨‚úÖ‚ùåüè¢üí∞üîëüìùüì¶üìÖüîé]/)) score += 10;
        if (line.includes('**')) score += 5;
        
        // Palavras da pergunta encontradas = alta prioridade
        for (const word of questionWords) {
          if (lineLower.includes(word)) score += 3;
        }
        
        // Linhas com dados num√©ricos = m√©dia prioridade
        if (line.match(/\d+[,.]?\d*%?|\$|R\$/)) score += 2;
        
        scoredLines.push({ line, score });
      }
      
      // Ordenar por relev√¢ncia e reconstruir
      scoredLines.sort((a, b) => b.score - a.score);
      
      let result = '';
      let charCount = 0;
      
      for (const { line } of scoredLines) {
        if (charCount + line.length + 1 > maxChars) break;
        result += line + '\n';
        charCount += line.length + 1;
      }
      
      return result.trim() + (result.length < contextText.length ? '\n...[filtrado por relev√¢ncia]' : '');
    }
    
    const IA_DEFAULT_SOURCE_LABEL = 'Conversa com o usu√°rio na aba I.A';
    function updateIASourceNote(sources){
      if(!iaSourceNote) return;
      const list = Array.isArray(sources) ? sources.map(source=>String(source||'').trim()).filter(Boolean) : [];
      const unique = Array.from(new Set(list));
      const label = unique.length ? unique.join(' ‚Ä¢ ') : IA_DEFAULT_SOURCE_LABEL;
      iaSourceNote.textContent = `Fontes: ${label}.`;
    }
    const joinPath = (parts)=> Array.isArray(parts) ? parts.join('/') : null;
    const invalidateIAContextCache = ()=>{ IA_CONTEXT_CACHE.ts = 0; IA_CONTEXT_CACHE.data = null; };
    if(iaDocsUpload) iaDocsUpload.disabled = true;
    renderIADocsList();
    updateIADocsStatus();
    updateIASourceNote();
    if(iaKnowledge){
      iaKnowledge.addEventListener('toggle', ()=>{
        if(iaKnowledge.open){
          delete iaKnowledge.dataset.userClosed;
        }else{
          iaKnowledge.dataset.userClosed = 'true';
        }
      });
    }

    iaHistory?.addEventListener('click', async (event)=>{
      // Bot√£o Copiar
      const copyBtn = event.target.closest('.ia-copy-btn');
      if(copyBtn){
        const index = Number(copyBtn.dataset.msgIndex);
        if(!CURRENT_CHAT || !Array.isArray(CURRENT_CHAT.messages)) return;
        if(Number.isNaN(index) || index < 0 || index >= CURRENT_CHAT.messages.length) return;
        const targetMsg = CURRENT_CHAT.messages[index];
        const text = typeof targetMsg?.content === 'string' ? targetMsg.content : '';
        try{
          const copiado = await mgCopyToClipboard(text);
          if(copiado && typeof mgToast === 'function'){ mgToast('Resposta copiada!'); }
          else if(!copiado && typeof mgToast === 'function'){ mgToast('N√£o foi poss√≠vel copiar.'); }
        }catch(err){
          console.error('copy ia message', err);
          if(typeof mgToast === 'function'){ mgToast('N√£o foi poss√≠vel copiar.'); }
        }
        return;
      }

      // Bot√£o Adicionar todas as linhas ao Planejamento
      const planningAllBtn = event.target.closest('.ia-add-all-planning-btn');
      if(planningAllBtn){
        const index = Number(planningAllBtn.dataset.msgIndex);
        if(!CURRENT_CHAT || !Array.isArray(CURRENT_CHAT.messages)) return;
        if(Number.isNaN(index) || index < 0 || index >= CURRENT_CHAT.messages.length) return;
        const targetMsg = CURRENT_CHAT.messages[index];
        const fullText = typeof targetMsg?.content === 'string' ? targetMsg.content : '';
        
        // Extrair todas as linhas (par√°grafos e listas)
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = renderMessageContent(fullText);
        
        const lines = [];
        // Extrair par√°grafos
        tempDiv.querySelectorAll('p').forEach(p => {
          const text = p.textContent.trim();
          if(text) lines.push(text);
        });
        // Extrair itens de lista
        tempDiv.querySelectorAll('li').forEach(li => {
          const text = li.textContent.trim();
          if(text) lines.push(text);
        });
        
        if(lines.length === 0){
          if(typeof mgToast === 'function'){ 
            mgToast('‚ùå Nenhuma linha encontrada na resposta da IA'); 
          }
          return;
        }
        
        // Abrir modal de sele√ß√£o de m√™s/ano
        openMonthPicker(lines);
        
        return;
      }

      // Bot√£o Adicionar √†s Metas
      const metasBtn = event.target.closest('.ia-add-metas-btn');
      if(metasBtn){
        console.log('üéØ [CLICK] Bot√£o "Adicionar √†s Metas" clicado!');
        
        const index = Number(metasBtn.dataset.msgIndex);
        console.log('üìç [CLICK] Index da mensagem:', index);
        
        if(!CURRENT_CHAT || !Array.isArray(CURRENT_CHAT.messages)){
          console.error('‚ùå [CLICK] CURRENT_CHAT inv√°lido!');
          return;
        }
        
        if(Number.isNaN(index) || index < 0 || index >= CURRENT_CHAT.messages.length){
          console.error('‚ùå [CLICK] Index inv√°lido:', index);
          return;
        }
        
        const targetMsg = CURRENT_CHAT.messages[index];
        const fullText = typeof targetMsg?.content === 'string' ? targetMsg.content : '';
        
        console.log('üìù [CLICK] Texto extra√≠do (primeiros 200 chars):', fullText.substring(0, 200));
        console.log('üìè [CLICK] Tamanho do texto:', fullText.length);
        
        // Extrair todos os n√∫meros do texto
        openMetasMapper(fullText);
        
        return;
      }

      // Bot√£o Editar Resposta
      const editBtn = event.target.closest('.ia-edit-btn');
      if(editBtn){
        const index = Number(editBtn.dataset.msgIndex);
        if(!CURRENT_CHAT || !Array.isArray(CURRENT_CHAT.messages)) return;
        if(Number.isNaN(index) || index < 0 || index >= CURRENT_CHAT.messages.length) return;
        
        toggleEditMode(index);
        return;
      }

      // Bot√£o inline em cada linha (+) - REMOVIDO, n√£o √© mais necess√°rio
      const lineBtn = event.target.closest('.ia-line-add-btn');
      if(lineBtn){
        event.preventDefault();
        event.stopPropagation();
        
        const lineText = lineBtn.getAttribute('data-line-text') || lineBtn.parentElement.textContent.trim();
        
        // Remover o "+" do texto se estiver no final
        const cleanText = lineText.replace(/\+\s*$/, '').trim();
        
        // Popular dropdowns antes de abrir
        populatePlanningDropdowns();
        
        // Abrir modal e preencher com o texto da linha
        if(iaPlanningModal && iaPlanningText && cleanText){
          iaPlanningText.value = cleanText;
          iaPlanningModal.classList.add('show');
          
          // Permitir edi√ß√£o
          setTimeout(() => {
            iaPlanningText.focus();
            iaPlanningText.select();
          }, 100);
        }
        return;
      }
    });

    // Event listeners do modal de planejamento
    function closePlanningModal(){
      if(iaPlanningModal){
        iaPlanningModal.classList.remove('show');
      }
    }

    function clearPlanningForm(){
      if(iaPlanningText) iaPlanningText.value = '';
      if(iaPlanningStatus) iaPlanningStatus.value = '';
      if(iaPlanningResponsavel) iaPlanningResponsavel.value = '';
      if(iaPlanningPrazoInicio) iaPlanningPrazoInicio.value = '';
      if(iaPlanningPrazoFim) iaPlanningPrazoFim.value = '';
      if(iaPlanningAddMore) iaPlanningAddMore.checked = false;
      if(iaPlanningPeriodoField) iaPlanningPeriodoField.classList.remove('range-active');
      updatePeriodoToggleButton();
    }

    function populatePlanningDropdowns(){
      // Popular status
      if(iaPlanningStatus && typeof STATUS_OPTIONS !== 'undefined'){
        iaPlanningStatus.innerHTML = '<option value="">Selecione um status</option>' +
          STATUS_OPTIONS.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('');
      }
      
      // Popular respons√°veis
      if(iaPlanningResponsavel && typeof RESP_OPTIONS !== 'undefined'){
        iaPlanningResponsavel.innerHTML = '<option value="">Selecione um respons√°vel</option>' +
          RESP_OPTIONS.map(resp => `<option value="${resp}">${resp}</option>`).join('');
      }
    }

    function updatePeriodoToggleButton(){
      if(!iaPlanningPeriodoToggle || !iaPlanningPeriodoField) return;
      const isRange = iaPlanningPeriodoField.classList.contains('range-active');
      iaPlanningPeriodoToggle.textContent = isRange ? 'Remover intervalo' : 'Adicionar intervalo';
    }

    // Popular dropdowns quando o DOM estiver pronto
    if(typeof STATUS_OPTIONS !== 'undefined'){
      populatePlanningDropdowns();
    }

    // ===== MONTH PICKER MODAL =====
    function openMonthPicker(lines){
      if(!iaMonthPickerModal) return;
      
      MONTH_PICKER_STATE.linesToAdd = lines;
      MONTH_PICKER_STATE.selectedMonth = null;
      MONTH_PICKER_STATE.selectedYear = new Date().getFullYear();
      
      // Atualizar contador
      if(iaMonthPickerCount){
        iaMonthPickerCount.textContent = lines.length;
      }
      
      // Atualizar ano
      if(iaYearDisplay){
        iaYearDisplay.textContent = MONTH_PICKER_STATE.selectedYear;
      }
      
      // Limpar sele√ß√£o de m√™s
      document.querySelectorAll('.ia-month-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      // Desabilitar bot√£o confirmar
      if(iaMonthPickerConfirm){
        iaMonthPickerConfirm.disabled = true;
      }
      
      // Mostrar modal
      iaMonthPickerModal.classList.add('show');
    }
    
    function closeMonthPicker(){
      if(!iaMonthPickerModal) return;
      iaMonthPickerModal.classList.remove('show');
      MONTH_PICKER_STATE = {
        selectedMonth: null,
        selectedYear: new Date().getFullYear(),
        linesToAdd: [],
        callback: null
      };
    }
    
    function confirmMonthPicker(){
      if(MONTH_PICKER_STATE.selectedMonth === null) return;
      
      const mesNum = MONTH_PICKER_STATE.selectedMonth;
      const ano = MONTH_PICKER_STATE.selectedYear;
      const lines = MONTH_PICKER_STATE.linesToAdd;
      
      const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                     'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
      
      // Criar data para o primeiro dia do m√™s escolhido
      const dataMes = new Date(ano, mesNum, 1);
      const dataISO = dataMes.toISOString().slice(0, 10); // YYYY-MM-DD
      
      // Adicionar todas as linhas como demandas
      let adicionadas = 0;
      lines.forEach(linha => {
        const novaDemanda = createDemanda();
        novaDemanda.demanda = linha;
        novaDemanda.prazo = `${dataISO}T12:00`; // Meio-dia do primeiro dia do m√™s
        novaDemanda.status = 'nao-iniciado';
        DEMANDAS.push(novaDemanda);
        adicionadas++;
      });
      
      scheduleDemandasPersist({ immediate: true });
      
      if(typeof mgToast === 'function'){ 
        mgToast(`‚úÖ ${adicionadas} objetivo(s) adicionado(s) ao planejamento de ${meses[mesNum]}/${ano}!`); 
      }
      
      // Fechar modal
      closeMonthPicker();
      
      // Mudar para a aba de planejamento
      const demandasTab = sectionTabs?.querySelector('.tab-btn[data-section="demandas"]');
      if(demandasTab){
        demandasTab.click();
      } else {
        currentSection = 'demandas';
        localStorage.setItem('mg_currentSection', currentSection);
        rerenderBySection();
      }
      
      // Navegar para o m√™s escolhido
      if(typeof setSelectedDemandaMonth === 'function'){
        setSelectedDemandaMonth(mesNum, ano);
      }
    }
    
    // Event listeners do month picker
    iaMonthPickerClose?.addEventListener('click', closeMonthPicker);
    iaMonthPickerCancel?.addEventListener('click', closeMonthPicker);
    iaMonthPickerConfirm?.addEventListener('click', confirmMonthPicker);
    
    // Bot√µes de ano
    document.addEventListener('click', (e) => {
      const yearBtn = e.target.closest('.ia-year-btn');
      if(yearBtn){
        const offset = parseInt(yearBtn.dataset.offset);
        if(!isNaN(offset)){
          MONTH_PICKER_STATE.selectedYear += offset;
          if(MONTH_PICKER_STATE.selectedYear < 2020) MONTH_PICKER_STATE.selectedYear = 2020;
          if(MONTH_PICKER_STATE.selectedYear > 2100) MONTH_PICKER_STATE.selectedYear = 2100;
          if(iaYearDisplay){
            iaYearDisplay.textContent = MONTH_PICKER_STATE.selectedYear;
          }
        }
      }
      
      const monthBtn = e.target.closest('.ia-month-btn');
      if(monthBtn){
        const month = parseInt(monthBtn.dataset.month);
        if(!isNaN(month)){
          MONTH_PICKER_STATE.selectedMonth = month;
          
          // Atualizar visual
          document.querySelectorAll('.ia-month-btn').forEach(btn => {
            btn.classList.remove('selected');
          });
          monthBtn.classList.add('selected');
          
          // Habilitar bot√£o confirmar
          if(iaMonthPickerConfirm){
            iaMonthPickerConfirm.disabled = false;
          }
        }
      }
    });
    
    // Fechar ao clicar fora
    iaMonthPickerModal?.addEventListener('click', (e) => {
      if(e.target === iaMonthPickerModal){
        closeMonthPicker();
      }
    });

    // ===== MODAL DE METAS MAPPER =====
    // =============================================================================
    // EXTRA√á√ÉO DE N√öMEROS PARA MAPEAMENTO DE METAS - v2.1 (DEBUG ENABLED)
    // =============================================================================
    
    function extractNumbersFromText(text){
      console.log('üîç [extractNumbersFromText] Texto recebido:', text.substring(0, 200) + '...');
      console.log('üîç [extractNumbersFromText] Tamanho total do texto:', text.length);
      
      // Remover markdown e HTML para pegar texto limpo
      const cleanText = text
        .replace(/```[\s\S]*?```/g, '') // Remove code blocks
        .replace(/`[^`]+`/g, '') // Remove inline code
        .replace(/<[^>]+>/g, '') // Remove HTML tags
        .replace(/[*_~]/g, ''); // Remove markdown formatting
      
      console.log('üßπ [extractNumbersFromText] Texto limpo:', cleanText.substring(0, 200) + '...');
      
      // Regex MELHORADA para encontrar n√∫meros completos
      // Captura: $2.000, 2000, $2,000, 2.500, 3.5%, 50, 85, etc.
      // Aceita: 1-3 d√≠gitos simples OU n√∫meros com separadores
      const regex = /(?:[$]?\s*)?(?:\d{1,3}(?:[.,]\d{3,})?|\d{4,})(?:[.,]\d+)?(?:\s*[+%])?/g;
      const matches = [...cleanText.matchAll(regex)];
      
      console.log(`üìä [extractNumbersFromText] ${matches.length} matches encontrados pela regex`);
      
      const numbers = [];
      const seen = new Set(); // Evitar n√∫meros duplicados muito pr√≥ximos
      
      matches.forEach((match, index) => {
        const numValue = match[0].trim(); // Remover espa√ßos e quebras de linha
        const matchIndex = match.index;
        
        // Pegar contexto mais inteligente (buscar por frases completas)
        let contextStart = matchIndex;
        let contextEnd = matchIndex + numValue.length;
        
        // Expandir para tr√°s at√© encontrar ponto, quebra de linha ou in√≠cio
        while(contextStart > 0 && cleanText[contextStart] !== '.' && cleanText[contextStart] !== '\n'){
          contextStart--;
        }
        if(cleanText[contextStart] === '.' || cleanText[contextStart] === '\n') contextStart++;
        
        // Expandir para frente at√© encontrar ponto, quebra de linha ou fim
        while(contextEnd < cleanText.length && cleanText[contextEnd] !== '.' && cleanText[contextEnd] !== '\n'){
          contextEnd++;
        }
        
        const context = cleanText.slice(contextStart, contextEnd).trim();
        
        // Criar chave √∫nica baseada em √çNDICE para permitir n√∫meros iguais
        // N√£o deduplica valores iguais - apenas garante que cada match seja processado uma vez
        const uniqueKey = `${matchIndex}_${numValue}`;
        
        if(seen.has(uniqueKey)){
          console.log(`‚ö†Ô∏è [extractNumbersFromText] DUPLICADO ignorado (j√° processado): "${numValue}" no √≠ndice ${matchIndex}`);
          return;
        }
        seen.add(uniqueKey);
        
        // Normalizar o n√∫mero (remover $, +, %, separadores de milhares, converter v√≠rgula em ponto)
        const normalizedValue = numValue
          .replace(/[$+%\s]/g, '') // Remove $, +, %, espa√ßos
          .replace(/\./g, '') // Remove pontos de separador de milhares (2.000 -> 2000)
          .replace(',', '.'); // Converte v√≠rgula decimal para ponto (se houver)
        
        const parsedValue = parseFloat(normalizedValue) || 0;
        
        // Validar que √© um n√∫mero v√°lido (n√£o aceitar 0 ou negativos)
        if(parsedValue <= 0){
          console.log(`‚ö†Ô∏è [extractNumbersFromText] Valor inv√°lido ignorado: "${numValue}" (parsed: ${parsedValue})`);
          return;
        }
        
        console.log(`‚úÖ [extractNumbersFromText] N√∫mero aceito: "${numValue}" ‚Üí ${parsedValue} | Contexto: "${context.substring(0, 50)}..."`);
        
        numbers.push({
          id: `num_${Date.now()}_${index}`,
          originalValue: numValue.trim(),
          normalizedValue: parsedValue,
          context: context || `...${numValue}...`,
          metaId: null,
          monthKey: null
        });
      });
      
      console.log(`‚ú® [extractNumbersFromText] TOTAL FINAL: ${numbers.length} n√∫meros √∫nicos v√°lidos`);
      
      return numbers;
    }
    
    function openMetasMapper(text){
      console.log('üöÄ [openMetasMapper] Iniciando extra√ß√£o de n√∫meros...');
      const numbers = extractNumbersFromText(text);
      
      console.log(`üìä [openMetasMapper] Resultado: ${numbers.length} n√∫meros extra√≠dos`);
      
      if(numbers.length === 0){
        if(typeof mgToast === 'function'){ 
          mgToast('‚ùå Nenhum n√∫mero encontrado na resposta da IA'); 
        }
        return;
      }
      
      METAS_MAPPER_STATE.numbers = numbers;
      METAS_MAPPER_STATE.text = text;
      METAS_MAPPER_STATE.selectedIndices.clear();
      
      console.log('üé® [openMetasMapper] Renderizando modal com', numbers.length, 'n√∫meros');
      renderMetasMapperBody();
      
      iaMetasMapperModal?.classList.add('show');
    }
    
    function closeMetasMapper(){
      iaMetasMapperModal?.classList.remove('show');
      METAS_MAPPER_STATE.numbers = [];
      METAS_MAPPER_STATE.text = '';
      METAS_MAPPER_STATE.selectedIndices.clear();
      if(iaMetasMapperBody) iaMetasMapperBody.innerHTML = '';
    }
    
    function renderMetasMapperBody(){
      if(!iaMetasMapperBody) return;
      
      const activeMetas = Array.isArray(METAS) ? METAS.filter(m => m.ativo !== false) : [];
      
      if(activeMetas.length === 0){
        iaMetasMapperBody.innerHTML = `
          <div style="text-align:center;padding:40px;color:rgba(255,255,255,.5)">
            <p style="font-size:1.2rem">üìä</p>
            <p>Nenhuma meta ativa encontrada.</p>
            <p style="font-size:.85rem;margin-top:8px">Crie metas na aba "Metas" primeiro.</p>
          </div>
        `;
        return;
      }
      
      // Banner informativo
      const banner = `
        <div style="background:linear-gradient(135deg,rgba(16,185,129,.2) 0%,rgba(16,185,129,.1) 100%);border:1px solid rgba(16,185,129,.3);border-radius:12px;padding:16px 20px;margin-bottom:16px;display:flex;align-items:center;gap:16px;">
          <div style="font-size:2rem;">üìä</div>
          <div style="flex:1;">
            <div style="font-size:1.1rem;font-weight:800;color:#10b981;margin-bottom:4px;">
              ${METAS_MAPPER_STATE.numbers.length} n√∫mero(s) encontrado(s)
            </div>
            <div style="font-size:.85rem;color:rgba(255,255,255,.7);line-height:1.4;">
              Para cada n√∫mero, selecione a meta e o m√™s que deseja atualizar
            </div>
          </div>
        </div>
        
        <div class="ia-metas-mapper-auto-order-info">
          <div style="font-size:1.2rem;">üí°</div>
          <div>
            <strong>Ordem Autom√°tica:</strong>
            Se voc√™ n√£o preencher o m√™s, os n√∫meros ser√£o adicionados em ordem crescente (Janeiro, Fevereiro, Mar√ßo...) na meta selecionada, seguindo a sequ√™ncia que aparecem na lista.
          </div>
        </div>
      `;
      
      const html = METAS_MAPPER_STATE.numbers.map((num, index) => {
        // Destacar o n√∫mero no contexto
        const escapedValue = num.originalValue.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const highlightedContext = num.context.replace(
          new RegExp(escapedValue, 'g'),
          `<span class="highlight-number">${num.originalValue}</span>`
        );
        
        // Verificar se estava selecionado antes
        const wasChecked = METAS_MAPPER_STATE.selectedIndices.has(index);
        const itemClass = wasChecked ? 'ia-metas-mapper-item selected' : 'ia-metas-mapper-item';
        
        return `
          <div class="${itemClass}" data-number-id="${num.id}" data-number-index="${index}">
            <input type="checkbox" class="ia-metas-mapper-item-checkbox ia-metas-mapper-checkbox" data-number-index="${index}" ${wasChecked ? 'checked' : ''}>
            <div class="ia-metas-mapper-index">#${index + 1}</div>
            <div class="ia-metas-mapper-item-header">
              <div class="ia-metas-mapper-number">
                <span>üìä</span>
                <span>${num.originalValue}</span>
              </div>
            </div>
            <div class="ia-metas-mapper-context">
              <div class="ia-metas-mapper-context-label">üí¨ Contexto onde aparece:</div>
              <div class="ia-metas-mapper-context-text">${highlightedContext}</div>
            </div>
            <div class="ia-metas-mapper-selectors">
              <div>
                <label>üéØ Qual meta atualizar?</label>
                <select class="metas-select" data-number-index="${index}">
                  <option value="">Selecionar meta...</option>
                  ${activeMetas.map(meta => {
                    const desc = meta.descricao || 'Meta sem nome';
                    const setor = meta.setor || 'comercial';
                    const unit = meta.unidade || '';
                    const selected = num.metaId === meta.id ? 'selected' : '';
                    return `<option value="${meta.id}" ${selected}>${setor.toUpperCase()}: ${desc}${unit ? ' (' + unit + ')' : ''}</option>`;
                  }).join('')}
                </select>
              </div>
              <div>
                <label>üìÖ Em qual m√™s? <span style="font-size:.7rem;color:rgba(255,255,255,.5);">(deixe vazio para ordem autom√°tica)</span></label>
                <select class="month-select" data-number-index="${index}">
                  <option value="">Ordem autom√°tica</option>
                  ${META_MONTHS.map((m, idx) => {
                    const label = META_MONTH_LABELS[m] || m.toUpperCase();
                    const selected = num.monthKey === m ? 'selected' : '';
                    return `<option value="${m}" ${selected}>${label}</option>`;
                  }).join('')}
                </select>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      iaMetasMapperBody.innerHTML = banner + html;
      
      // Event listeners para checkboxes
      iaMetasMapperBody.querySelectorAll('.ia-metas-mapper-item-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
          const index = parseInt(e.target.dataset.numberIndex);
          const item = e.target.closest('.ia-metas-mapper-item');
          
          if(e.target.checked){
            item.classList.add('selected');
            METAS_MAPPER_STATE.selectedIndices.add(index);
          } else {
            item.classList.remove('selected');
            METAS_MAPPER_STATE.selectedIndices.delete(index);
          }
        });
      });
      
      // Event listeners para os selects
      iaMetasMapperBody.querySelectorAll('.metas-select').forEach(select => {
        select.addEventListener('change', (e) => {
          const index = parseInt(e.target.dataset.numberIndex);
          if(!isNaN(index) && METAS_MAPPER_STATE.numbers[index]){
            METAS_MAPPER_STATE.numbers[index].metaId = e.target.value;
          }
        });
      });
      
      iaMetasMapperBody.querySelectorAll('.month-select').forEach(select => {
        select.addEventListener('change', (e) => {
          const index = parseInt(e.target.dataset.numberIndex);
          if(!isNaN(index) && METAS_MAPPER_STATE.numbers[index]){
            METAS_MAPPER_STATE.numbers[index].monthKey = e.target.value;
          }
        });
      });
    }
    
    async function confirmMetasMapper(){
      console.log('üéØ [confirmMetasMapper] Iniciando...');
      console.log('üéØ [confirmMetasMapper] CURRENT_METAS_YEAR:', CURRENT_METAS_YEAR);
      console.log('üéØ [confirmMetasMapper] METAS array:', METAS);
      console.log('üéØ [confirmMetasMapper] Total de metas:', METAS?.length || 0);
      
      // Filtrar n√∫meros que t√™m meta selecionada
      const numbersWithMeta = METAS_MAPPER_STATE.numbers.filter(n => n.metaId);
      
      console.log('üìä [confirmMetasMapper] N√∫meros totais:', METAS_MAPPER_STATE.numbers.length);
      console.log('üìä [confirmMetasMapper] N√∫meros com meta selecionada:', numbersWithMeta.length);
      console.log('üìä [confirmMetasMapper] Detalhes dos n√∫meros selecionados:', numbersWithMeta);
      
      if(numbersWithMeta.length === 0){
        console.warn('‚ö†Ô∏è [confirmMetasMapper] Nenhuma meta selecionada');
        if(typeof mgToast === 'function'){ 
          mgToast('‚ö†Ô∏è Selecione pelo menos uma meta para adicionar'); 
        }
        return;
      }
      
      // Processar ordem autom√°tica para n√∫meros sem m√™s definido
      let monthIndex = 0; // Come√ßar em Janeiro (0)
      const processedNumbers = [];
      
      numbersWithMeta.forEach(num => {
        if(!num.monthKey || num.monthKey === ''){
          // Ordem autom√°tica: atribuir m√™s sequencial
          num.monthKey = META_MONTHS[monthIndex % 12];
          monthIndex++;
        }
        processedNumbers.push(num);
      });
      
      console.log('üìä [confirmMetasMapper] N√∫meros processados:', processedNumbers);
      console.log('üìä [confirmMetasMapper] METAS dispon√≠veis:', METAS?.length || 0);
      console.log('üìä [confirmMetasMapper] CURRENT_METAS_YEAR:', CURRENT_METAS_YEAR);
      
      // Adicionar os n√∫meros √†s metas
      let addedCount = 0;
      processedNumbers.forEach(num => {
        const meta = METAS.find(m => m.id === num.metaId);
        console.log(`üîç [confirmMetasMapper] Buscando meta ID: ${num.metaId}, encontrada:`, !!meta);
        
        if(meta){
          console.log(`üìã [confirmMetasMapper] Meta encontrada:`, meta.descricao, 'Setor:', meta.setor);
          console.log(`üìã [confirmMetasMapper] meta.meses existe?`, !!meta.meses);
          console.log(`üìã [confirmMetasMapper] M√™s ${num.monthKey} existe?`, meta.meses ? !!meta.meses[num.monthKey] : false);
          
          if(meta.meses && meta.meses[num.monthKey]){
            // Adicionar ao valor planejado (P)
            const currentP = parseFloat(meta.meses[num.monthKey].p) || 0;
            const newP = currentP + num.normalizedValue;
            
            console.log(`‚ûï [confirmMetasMapper] Adicionando √† meta "${meta.descricao}" no m√™s ${num.monthKey}`);
            console.log(`   Valor atual (P): ${currentP}`);
            console.log(`   Valor a adicionar: ${num.normalizedValue}`);
            console.log(`   Novo valor (P): ${newP}`);
            
            meta.meses[num.monthKey].p = newP;
            addedCount++;
          } else {
            console.warn(`‚ö†Ô∏è [confirmMetasMapper] Meta n√£o tem estrutura de meses correta:`, meta);
          }
        } else {
          console.warn(`‚ö†Ô∏è [confirmMetasMapper] Meta n√£o encontrada com ID: ${num.metaId}`);
        }
      });
      
      console.log(`‚úÖ [confirmMetasMapper] Total adicionado: ${addedCount} de ${processedNumbers.length}`);
      
      if(addedCount > 0){
        // Salvar metas
        console.log('üíæ [confirmMetasMapper] Salvando metas...');
        await persistMetas();
        renderMetas();
        renderMetaSummary();
        
        if(typeof mgToast === 'function'){ 
          mgToast(`‚úÖ ${addedCount} n√∫mero(s) adicionado(s) √†s metas`); 
        }
      } else {
        console.error('‚ùå [confirmMetasMapper] Nenhum n√∫mero foi adicionado √†s metas!');
        if(typeof mgToast === 'function'){ 
          mgToast('‚ùå Erro: Nenhum n√∫mero foi adicionado. Verifique o console.'); 
        }
      }
      
      closeMetasMapper();
    }
    
    // Fun√ß√£o para selecionar/desselecionar todos
    function toggleSelectAllNumbers(){
      const checkboxes = document.querySelectorAll('.ia-metas-mapper-item-checkbox');
      const allChecked = Array.from(checkboxes).every(cb => cb.checked);
      
      checkboxes.forEach(checkbox => {
        const index = parseInt(checkbox.dataset.numberIndex);
        checkbox.checked = !allChecked;
        const item = checkbox.closest('.ia-metas-mapper-item');
        
        if(!allChecked){
          item.classList.add('selected');
          METAS_MAPPER_STATE.selectedIndices.add(index);
        } else {
          item.classList.remove('selected');
          METAS_MAPPER_STATE.selectedIndices.delete(index);
        }
      });
      
      // Se desmarcou todos, limpar o Set completamente
      if(allChecked){
        METAS_MAPPER_STATE.selectedIndices.clear();
      }
      
      // Atualizar texto do bot√£o
      if(iaMetasMapperSelectAll){
        iaMetasMapperSelectAll.textContent = allChecked ? '‚úì Selecionar Todos' : '‚úï Desmarcar Todos';
      }
    }
    
    // Fun√ß√£o para aplicar meta/m√™s aos selecionados
    function applyToSelectedNumbers(){
      const selectedCheckboxes = document.querySelectorAll('.ia-metas-mapper-item-checkbox:checked');
      
      if(selectedCheckboxes.length === 0){
        if(typeof mgToast === 'function'){ 
          mgToast('‚ö†Ô∏è Selecione pelo menos um n√∫mero primeiro'); 
        }
        return;
      }
      
      // Pedir meta e m√™s para aplicar
      const metaSelect = document.createElement('select');
      metaSelect.style.cssText = 'width:100%;padding:10px;background:#1a1f2e;border:1px solid rgba(255,255,255,.2);color:#fff;border-radius:8px;margin-bottom:10px;font-size:.9rem';
      
      const activeMetas = Array.isArray(METAS) ? METAS.filter(m => m.ativo !== false) : [];
      metaSelect.innerHTML = '<option value="">Selecionar meta...</option>' + 
        activeMetas.map(meta => {
          const desc = meta.descricao || 'Meta sem nome';
          const setor = meta.setor || 'comercial';
          const unit = meta.unidade || '';
          return `<option value="${meta.id}">${setor.toUpperCase()}: ${desc}${unit ? ' (' + unit + ')' : ''}</option>`;
        }).join('');
      
      const monthSelect = document.createElement('select');
      monthSelect.style.cssText = 'width:100%;padding:10px;background:#1a1f2e;border:1px solid rgba(255,255,255,.2);color:#fff;border-radius:8px;font-size:.9rem';
      monthSelect.innerHTML = '<option value="">Ordem autom√°tica</option>' +
        META_MONTHS.map(m => {
          const label = META_MONTH_LABELS[m] || m.toUpperCase();
          return `<option value="${m}">${label}</option>`;
        }).join('');
      
      const container = document.createElement('div');
      container.style.cssText = 'padding:20px';
      
      const title = document.createElement('div');
      title.style.cssText = 'font-weight:800;color:#10b981;margin-bottom:16px;font-size:1rem';
      title.textContent = `Aplicar a ${selectedCheckboxes.length} n√∫mero(s) selecionado(s)`;
      
      const metaLabel = document.createElement('label');
      metaLabel.style.cssText = 'display:block;font-size:.8rem;color:rgba(255,255,255,.7);margin-bottom:6px;font-weight:600';
      metaLabel.textContent = 'üéØ Meta:';
      
      const monthLabel = document.createElement('label');
      monthLabel.style.cssText = 'display:block;font-size:.8rem;color:rgba(255,255,255,.7);margin-bottom:6px;margin-top:12px;font-weight:600';
      monthLabel.textContent = 'üìÖ M√™s:';
      
      container.appendChild(title);
      container.appendChild(metaLabel);
      container.appendChild(metaSelect);
      container.appendChild(monthLabel);
      container.appendChild(monthSelect);
      
      // Criar modal simples
      const tempModal = document.createElement('div');
      tempModal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:999999';
      
      const tempContent = document.createElement('div');
      tempContent.style.cssText = 'background:linear-gradient(135deg,#1a1f2e 0%,#0f1419 100%);border:1px solid rgba(16,185,129,.3);border-radius:16px;max-width:450px;width:90%;box-shadow:0 25px 70px rgba(16,185,129,.25)';
      
      const tempFooter = document.createElement('div');
      tempFooter.style.cssText = 'padding:16px 20px;border-top:1px solid rgba(255,255,255,.08);display:flex;gap:10px;justify-content:flex-end;background:rgba(0,0,0,.3)';
      
      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'btn small secondary';
      cancelBtn.textContent = 'Cancelar';
      cancelBtn.onclick = () => tempModal.remove();
      
      const confirmBtn = document.createElement('button');
      confirmBtn.className = 'btn small';
      confirmBtn.textContent = 'Aplicar';
      confirmBtn.onclick = () => {
        const selectedMeta = metaSelect.value;
        const selectedMonth = monthSelect.value;
        
        if(!selectedMeta){
          if(typeof mgToast === 'function'){ 
            mgToast('‚ö†Ô∏è Selecione uma meta'); 
          }
          return;
        }
        
        // Aplicar aos selecionados
        selectedCheckboxes.forEach(checkbox => {
          const index = parseInt(checkbox.dataset.numberIndex);
          if(!isNaN(index) && METAS_MAPPER_STATE.numbers[index]){
            METAS_MAPPER_STATE.numbers[index].metaId = selectedMeta;
            METAS_MAPPER_STATE.numbers[index].monthKey = selectedMonth;
          }
        });
        
        // Re-renderizar para mostrar as mudan√ßas
        renderMetasMapperBody();
        
        if(typeof mgToast === 'function'){ 
          mgToast(`‚úÖ Aplicado a ${selectedCheckboxes.length} n√∫mero(s)`); 
        }
        
        tempModal.remove();
      };
      
      tempFooter.appendChild(cancelBtn);
      tempFooter.appendChild(confirmBtn);
      
      tempContent.appendChild(container);
      tempContent.appendChild(tempFooter);
      tempModal.appendChild(tempContent);
      document.body.appendChild(tempModal);
    }
    
    // Event listeners do modal de metas
    iaMetasMapperClose?.addEventListener('click', closeMetasMapper);
    iaMetasMapperCancel?.addEventListener('click', closeMetasMapper);
    iaMetasMapperConfirm?.addEventListener('click', () => {
      console.log('üîò [EVENT] Bot√£o "Adicionar √†s Metas" clicado no modal!');
      confirmMetasMapper();
    });
    iaMetasMapperSelectAll?.addEventListener('click', toggleSelectAllNumbers);
    iaMetasMapperApplyToSelected?.addEventListener('click', applyToSelectedNumbers);
    
    // Fechar ao clicar fora
    iaMetasMapperModal?.addEventListener('click', (e) => {
      if(e.target === iaMetasMapperModal){
        closeMetasMapper();
      }
    });

    // Toggle do per√≠odo
    iaPlanningPeriodoToggle?.addEventListener('click', ()=>{
      if(!iaPlanningPeriodoField) return;
      const isRange = iaPlanningPeriodoField.classList.contains('range-active');
      
      if(isRange){
        // Remover intervalo
        iaPlanningPeriodoField.classList.remove('range-active');
        if(iaPlanningPrazoFim) iaPlanningPrazoFim.value = '';
      } else {
        // Adicionar intervalo
        iaPlanningPeriodoField.classList.add('range-active');
      }
      
      updatePeriodoToggleButton();
    });

    function getSelectedTextFromMessage(){
      const selection = window.getSelection();
      if(!selection || selection.rangeCount === 0) return null;
      const selectedText = selection.toString().trim();
      if(!selectedText) return null;
      
      // Verificar se a sele√ß√£o est√° dentro de uma mensagem da IA
      let node = selection.anchorNode;
      while(node && node !== document.body){
        if(node.classList && node.classList.contains('ia-msg-assistant')){
          return selectedText;
        }
        node = node.parentNode;
      }
      return null;
    }

    iaPlanningModalClose?.addEventListener('click', ()=>{
      closePlanningModal();
      clearPlanningForm();
    });

    iaPlanningCancel?.addEventListener('click', ()=>{
      closePlanningModal();
      clearPlanningForm();
    });

    iaPlanningModal?.addEventListener('click', (event)=>{
      if(event.target === iaPlanningModal){
        closePlanningModal();
        clearPlanningForm();
      }
    });

    iaPlanningSubmit?.addEventListener('click', async ()=>{
      const demanda = (iaPlanningText?.value || '').trim();
      if(!demanda){
        if(typeof mgToast === 'function'){ mgToast('Digite o conte√∫do da demanda'); }
        return;
      }

      const status = iaPlanningStatus?.value || '';
      const responsavel = iaPlanningResponsavel?.value || '';
      const prazoInicio = iaPlanningPrazoInicio?.value || '';
      const prazoFim = iaPlanningPrazoFim?.value || '';

      // Criar nova demanda
      const novaDemanda = createDemanda();
      novaDemanda.demanda = demanda;
      novaDemanda.status = status;
      novaDemanda.responsavel = responsavel;
      novaDemanda.prazo = prazoInicio;
      novaDemanda.prazoFim = prazoFim;

      // Adicionar √† lista de demandas
      DEMANDAS.push(novaDemanda);
      scheduleDemandasPersist({ immediate: true });
      renderDemandas();

      if(typeof mgToast === 'function'){ 
        mgToast('‚úÖ Demanda adicionada ao planejamento!'); 
      }

      // Verificar se deve adicionar mais
      const addMore = iaPlanningAddMore?.checked || false;
      
      if(addMore){
        // Limpar apenas o campo de texto, manter os outros
        if(iaPlanningText) iaPlanningText.value = '';
        if(iaPlanningText) iaPlanningText.focus();
      } else {
        // Fechar modal e limpar tudo
        closePlanningModal();
        clearPlanningForm();
        
        // Mudar para a aba de planejamento
        const demandasTab = sectionTabs?.querySelector('.tab-btn[data-section="demandas"]');
        if(demandasTab){
          demandasTab.click();
        } else {
          currentSection = 'demandas';
          localStorage.setItem('mg_currentSection', currentSection);
          rerenderBySection();
        }
      }
    });

    function escHtml(str){ return (str ?? '').replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }
    function deriveTitleFromText(text){
      const clean = (text || '').replace(/\s+/g,' ').trim();
      if(!clean) return 'Nova conversa';
      return clean.length > 60 ? clean.slice(0,57)+'‚Ä¶' : clean;
    }
    function chatTitle(chat){
      if(!chat) return 'Nova conversa';
      const stored = (chat.title || '').trim();
      if(stored) return stored;
      const firstUser = (chat.messages || []).find(m=>m.role==='user' && (m.content||'').trim());
      return deriveTitleFromText(firstUser?.content || '');
    }
    function formatTimestamp(ts){
      if(!ts) return '';
      try{ return new Date(ts).toLocaleString(); }
      catch(_){ return ''; }
    }
    const SCRIPT_CACHE = {};
    function ensureExternalScript(src, check){
      if(typeof check === 'function' && check()) return Promise.resolve();
      if(SCRIPT_CACHE[src]) return SCRIPT_CACHE[src];
      SCRIPT_CACHE[src] = new Promise((resolve, reject)=>{
        const script = document.createElement('script');
        script.src = src;
        script.async = true;
        script.onload = ()=> resolve();
        script.onerror = ()=> reject(new Error('Falha ao carregar script: '+src));
        document.head.appendChild(script);
      }).then(()=>{ if(typeof check === 'function' && !check()) throw new Error('Biblioteca n√£o dispon√≠vel: '+src); });
      return SCRIPT_CACHE[src];
    }
    const JSZIP_SRC = 'https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js';
    const XLSX_SRC = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
    function ensureJSZip(){
      return ensureExternalScript(JSZIP_SRC, ()=> typeof JSZip !== 'undefined');
    }
    function ensureXLSX(){
      return ensureExternalScript(XLSX_SRC, ()=> typeof XLSX !== 'undefined');
    }
    function renderMessageContent(content){
      const text = typeof content === 'string' ? content : '';
      if(!text.trim()) return '';
      const html = renderMarkdownText(text);
      return addPlanningButtonsToContent(html);
    }
    
    function addPlanningButtonsToContent(html){
      // Criar um elemento tempor√°rio para processar o HTML
      const temp = document.createElement('div');
      temp.innerHTML = html;
      
      // Adicionar bot√µes aos par√°grafos
      const paragraphs = temp.querySelectorAll('p');
      paragraphs.forEach((p, idx) => {
        const textContent = p.textContent.trim();
        if(textContent && textContent.length > 10){ // Apenas se tiver conte√∫do significativo
          const btn = document.createElement('button');
          btn.className = 'ia-line-add-btn';
          btn.textContent = '+';
          btn.title = 'Adicionar ao planejamento';
          btn.setAttribute('data-line-text', textContent);
          btn.setAttribute('type', 'button');
          p.appendChild(btn);
        }
      });
      
      // Adicionar bot√µes aos itens de lista
      const listItems = temp.querySelectorAll('li');
      listItems.forEach((li, idx) => {
        const textContent = li.textContent.trim();
        if(textContent && textContent.length > 5){
          const btn = document.createElement('button');
          btn.className = 'ia-line-add-btn';
          btn.textContent = '+';
          btn.title = 'Adicionar ao planejamento';
          btn.setAttribute('data-line-text', textContent);
          btn.setAttribute('type', 'button');
          li.appendChild(btn);
        }
      });
      
      return temp.innerHTML;
    }
    function touchChat(chat){
      if(!chat) return;
      chat.updatedAt = Date.now();
      IA_CHATS.sort((a,b)=> (b.updatedAt || b.createdAt || 0) - (a.updatedAt || a.createdAt || 0));
    }
    function humanFileSize(bytes){
      if(!Number.isFinite(bytes) || bytes <= 0) return '0 B';
      const units = ['B','KB','MB','GB','TB'];
      let value = bytes;
      let unit = 0;
      while(value >= 1024 && unit < units.length-1){ value /= 1024; unit++; }
      const digits = value < 10 && unit > 0 ? 1 : 0;
      return `${value.toFixed(digits)} ${units[unit]}`;
    }
    function computeWordCount(text){
      if(!text) return 0;
      const trimmed = text.trim();
      if(!trimmed) return 0;
      return trimmed.split(/\s+/).length;
    }
    function normalizePlainText(text){
      return (text || '')
        .replace(/\r\n?/g,'\n')
        .replace(/\u0000/g,'')
        .replace(/[\t\f\v]+/g,' ')
        .replace(/\s+\n/g,'\n')
        .replace(/\n{3,}/g,'\n\n')
        .trim();
    }
    const decodeHelper = document.createElement('textarea');
    function decodeEntities(text){
      if(!text) return '';
      decodeHelper.innerHTML = text;
      return decodeHelper.value;
    }
    function extractXmlText(xml){
      if(!xml) return '';
      const replaced = xml
        .replace(/<w:p[^>]*>/g,'\n')
        .replace(/<text:p[^>]*>/g,'\n')
        .replace(/<[^>]+>/g,' ');
      return normalizePlainText(decodeEntities(replaced));
    }
    async function extractDocxText(file){
      await ensureJSZip();
      const zip = await JSZip.loadAsync(await file.arrayBuffer());
      const docFile = zip.file('word/document.xml');
      if(!docFile) throw new Error('Conte√∫do DOCX n√£o encontrado.');
      const xml = await docFile.async('string');
      return extractXmlText(xml);
    }
    async function extractOdtText(file){
      await ensureJSZip();
      const zip = await JSZip.loadAsync(await file.arrayBuffer());
      const content = zip.file('content.xml');
      if(!content) throw new Error('Conte√∫do ODT n√£o encontrado.');
      const xml = await content.async('string');
      return extractXmlText(xml);
    }
    function extractRtfText(raw){
      if(!raw) return '';
      let text = raw.replace(/\{\\\*\\generator[^}]+\}/gi,'');
      text = text.replace(/\{[^}]*\}/g,' ');
      text = text.replace(/\\'[0-9a-fA-F]{2}/g, m=>{
        const hex = m.slice(2);
        try{ return decodeURIComponent('%'+hex); }
        catch(_){ return ' '; }
      });
      text = text.replace(/\\par[d]?/g,'\n');
      text = text.replace(/\\(tab|line)/g,' ');
      text = text.replace(/\\[a-z]+-?\d*\s?/gi,'');
      text = text.replace(/[{}]/g,' ');
      return normalizePlainText(text);
    }
    async function extractSpreadsheetText(file){
      await ensureXLSX();
      const data = new Uint8Array(await file.arrayBuffer());
      const workbook = XLSX.read(data, { type:'array' });
      const parts = [];
      workbook.SheetNames.forEach(name=>{
        const sheet = workbook.Sheets[name];
        if(!sheet) return;
        const csv = XLSX.utils.sheet_to_csv(sheet);
        const normalized = normalizePlainText(csv);
        if(normalized){
          parts.push(`Planilha: ${name}\n${normalized}`);
        }
      });
      return parts.join('\n\n');
    }
    async function extractLegacyDocText(file){
      const buffer = await file.arrayBuffer();
      const bytes = new Uint8Array(buffer);
      let chars = '';
      for(let i=0;i<bytes.length;i++){
        const code = bytes[i];
        if(code === 0x0d || code === 0x0a){
          chars += '\n';
        } else if(code >= 32 && code <= 126){
          chars += String.fromCharCode(code);
        } else if(code >= 160){
          chars += String.fromCharCode(code);
        } else {
          chars += ' ';
        }
      }
      return normalizePlainText(chars);
    }
    async function extractPlainTextFromFile(file){
      const ext = (file.name.split('.').pop()||'').toLowerCase();
      if(['txt','md','csv','tsv','json','xml','html','htm'].includes(ext)){
        return normalizePlainText(await file.text());
      }
      if(ext === 'rtf'){
        return extractRtfText(await file.text());
      }
      if(ext === 'docx'){
        return await extractDocxText(file);
      }
      if(ext === 'odt'){
        return await extractOdtText(file);
      }
      if(['xls','xlsx','ods'].includes(ext)){
        return await extractSpreadsheetText(file);
      }
      if(ext === 'doc'){
        return await extractLegacyDocText(file);
      }
      throw new Error(`Formato ${ext ? ext.toUpperCase() : 'desconhecido'} n√£o suportado.`);
    }
    // üî• ARMAZENAMENTO H√çBRIDO ILIMITADO
    // - Conversas recentes (√∫ltimas 10): documento principal (r√°pido)
    // - Conversas antigas: subcole√ß√£o iaChats/{chatId} (ilimitado)
    // - Interface sempre mostra TODAS as conversas (principal + subcole√ß√£o)
    
    async function loadIAChatsFromUserData(){
      console.log('üìä Carregando hist√≥rico completo de conversas I.A...');
      
      // 1Ô∏è‚É£ Carregar conversas do documento principal (recentes)
      let mainChats = Array.isArray(USER_DATA.iaChats) ? USER_DATA.iaChats.map(chat=>({
        ...chat,
        title: typeof chat.title === 'string' ? chat.title : '',
        messages: Array.isArray(chat.messages) ? chat.messages
          .map(msg => {
            if (msg.loading === true) {
              return {
                ...msg,
                loading: false,
                content: msg.content || '‚ö†Ô∏è _Resposta perdida (a p√°gina foi recarregada antes da resposta ser recebida)_'
              };
            }
            return { ...msg };
          }) : [],
        createdAt: chat.createdAt || Date.now(),
        updatedAt: chat.updatedAt || chat.createdAt || Date.now(),
        lastSources: Array.isArray(chat.lastSources) ? chat.lastSources.map(source=>String(source||'').trim()).filter(Boolean) : [],
        location: 'main' // Marcador para saber onde est√°
      })) : [];
      
      console.log(`‚úÖ ${mainChats.length} conversas no documento principal`);
      
      // 2Ô∏è‚É£ Carregar conversas da subcole√ß√£o (antigas/arquivadas)
      let archivedChats = [];
      try {
        const userId = auth.currentUser?.uid;
        if (userId) {
          const archiveRef = collection(db, 'usuarios', userId, 'iaChats');
          const archiveSnapshot = await getDocs(archiveRef);
          
          archivedChats = archiveSnapshot.docs.map(doc => ({
            ...doc.data(),
            id: doc.id,
            location: 'archive' // Marcador para saber onde est√°
          }));
          
          console.log(`‚úÖ ${archivedChats.length} conversas arquivadas na subcole√ß√£o`);
        }
      } catch (err) {
        console.warn('‚ö†Ô∏è Erro ao carregar conversas arquivadas:', err);
        // N√£o √© cr√≠tico - continua com as conversas principais
      }
      
      // 3Ô∏è‚É£ Combinar TODAS as conversas
      IA_CHATS = [...mainChats, ...archivedChats];
      IA_CHATS.sort((a,b)=> (b.updatedAt || b.createdAt || 0) - (a.updatedAt || a.createdAt || 0));
      
      console.log(`üéâ TOTAL: ${IA_CHATS.length} conversas carregadas (${mainChats.length} recentes + ${archivedChats.length} arquivadas)`);
      
      // üî• PRESERVAR CURRENT_CHAT se ele tiver mais mensagens que a vers√£o carregada
      // Isso evita perder mensagens rec√©m-adicionadas durante o salvamento
      const currentChatId = CURRENT_CHAT?.id;
      const loadedCurrentChat = IA_CHATS[0];
      
      if (currentChatId && loadedCurrentChat && currentChatId === loadedCurrentChat.id) {
        const currentMessages = CURRENT_CHAT.messages?.length || 0;
        const loadedMessages = loadedCurrentChat.messages?.length || 0;
        
        if (currentMessages > loadedMessages) {
          console.log(`üîÑ Preservando CURRENT_CHAT (${currentMessages} msgs > ${loadedMessages} msgs carregadas)`);
          // Atualizar o chat em IA_CHATS com a vers√£o atual
          IA_CHATS[0] = CURRENT_CHAT;
        } else {
          CURRENT_CHAT = loadedCurrentChat;
        }
      } else {
        CURRENT_CHAT = IA_CHATS[0] || null;
      }
      
      // ‚ö†Ô∏è CR√çTICO: N√ÉO criar conversa vazia automaticamente se j√° existem conversas
      // Isso evita salvar no Firebase quando o documento est√° cheio
      if(!CURRENT_CHAT && IA_CHATS.length === 0) {
        console.log('üìù Criando primeira conversa vazia');
        newIAChat();
      } else if (CURRENT_CHAT) {
        console.log(`‚úÖ Conversa atual: "${CURRENT_CHAT.title}" (${CURRENT_CHAT.messages?.length || 0} mensagens)`);
      }
    }
    
    // üî• ARMAZENAMENTO H√çBRIDO ILIMITADO
    // Mant√©m apenas as 10 conversas mais recentes no documento principal
    // Move conversas antigas para subcole√ß√£o (ilimitado)
    
    async function saveIAChatsToUserData(){
      console.log('üíæ ========== SALVANDO CONVERSAS I.A. ==========');
      console.log(`üìä Total de conversas em IA_CHATS: ${IA_CHATS.length}`);
      
      // Log detalhado de cada conversa
      IA_CHATS.forEach((chat, idx) => {
        const msgCount = chat.messages?.length || 0;
        const loadingMsgs = chat.messages?.filter(m => m.loading === true).length || 0;
        console.log(`   ${idx + 1}. "${chat.title}" - ${msgCount} msgs (${loadingMsgs} em loading)`);
      });
      
      try {
      // 1Ô∏è‚É£ Limpar mensagens em loading
      let allChats = IA_CHATS.map(chat => ({
        ...chat,
        messages: (chat.messages || [])
          .map(msg => {
            if (msg.loading === true && (!msg.content || msg.content.trim() === '')) {
              console.log(`   üóëÔ∏è Removendo mensagem vazia em loading do chat "${chat.title}"`);
              return null; // Remove mensagens vazias em loading
            }
            if (msg.loading === true && msg.content) {
              console.log(`   ‚öôÔ∏è Removendo flag loading de mensagem com conte√∫do no chat "${chat.title}"`);
              return { ...msg, loading: false }; // Remove flag de loading
            }
            return msg;
          })
          .filter(msg => msg !== null)
      }));
      
      console.log(`üîÑ Ap√≥s limpeza: ${allChats.length} conversas`);
      
      // 2Ô∏è‚É£ Ordenar por data (mais recentes primeiro)
      allChats.sort((a, b) => (b.updatedAt || b.createdAt || 0) - (a.updatedAt || a.createdAt || 0));
      
      // 3Ô∏è‚É£ Separar: 10 mais recentes ficam no principal, o resto vai para subcole√ß√£o
      const recentChats = allChats.slice(0, 10);
      const chatsToArchive = allChats.slice(10);
      
      console.log(`üì¶ Mantendo ${recentChats.length} conversas recentes no documento principal`);
      console.log(`üóÇÔ∏è ${chatsToArchive.length} conversas ser√£o arquivadas na subcole√ß√£o`);
      
      // 4Ô∏è‚É£ Salvar conversas recentes no documento principal
      USER_DATA.iaChats = recentChats;
      
      // Calcular tamanho antes de salvar
      const dataStr = JSON.stringify({ iaChats: recentChats });
      const dataSize = new Blob([dataStr]).size;
      console.log(`üìè Tamanho do campo iaChats: ${(dataSize / 1024).toFixed(2)} KB`);
      
      // üõ°Ô∏è USAR FUN√á√ÉO PROTEGIDA QUE VALIDA TAMANHO
      console.log('üíæ Salvando no Firebase com prote√ß√£o...');
      const result = await safeWriteUserDoc({ iaChats: recentChats });
      
      if(!result.success) {
        console.error('‚ùå Falha ao salvar conversas:', result.error);
        
        if(result.needsCleanup) {
          console.error('üö® DOCUMENTO EXCEDEU 1MB!');
          console.error('üí° Sistema tentar√° limpar automaticamente...');
          mgToast('üö® Documento muito grande! Limpeza autom√°tica em andamento...', 'warning', 5000);
        }
        
        if(result.criticalFailure) {
          console.error('üÜò FALHA CR√çTICA! Sistema n√£o conseguiu limpar automaticamente.');
          console.error('üìû Entre em contato com suporte t√©cnico.');
        }
        
        throw new Error(result.error || 'Falha ao salvar conversas');
      }
      
      if(result.autoCleanup || result.emergencyCleanup) {
        console.log('üßπ Limpeza autom√°tica foi executada durante o salvamento');
      }
      
      console.log(`‚úÖ ${recentChats.length} conversas recentes salvas no documento principal`);
      
      // 5Ô∏è‚É£ Arquivar conversas antigas na subcole√ß√£o (se houver)
      if (chatsToArchive.length > 0) {
        console.log(`üóÇÔ∏è Arquivando ${chatsToArchive.length} conversas antigas na subcole√ß√£o...`);
        
        try {
          const userId = auth.currentUser?.uid;
          if (userId) {
            const archiveRef = collection(db, 'usuarios', userId, 'iaChats');
            
            // Salvar cada conversa antiga como documento separado
            for (const chat of chatsToArchive) {
              // Se j√° est√° na subcole√ß√£o (location='archive'), atualizar
              // Se √© nova, criar documento novo
              const chatId = chat.id || `chat_${chat.createdAt || Date.now()}`;
              const chatDocRef = doc(archiveRef, chatId);
              
              await setDoc(chatDocRef, {
                ...chat,
                id: chatId,
                location: 'archive'
              }, { merge: true });
            }
            
            console.log(`‚úÖ ${chatsToArchive.length} conversas arquivadas com sucesso`);
          }
        } catch (archiveErr) {
          console.error('‚ö†Ô∏è Erro ao arquivar conversas antigas:', archiveErr);
          // N√£o √© cr√≠tico - conversas recentes foram salvas
        }
      }
      
      console.log(`üéâ Salvamento completo! ${recentChats.length} recentes + ${chatsToArchive.length} arquivadas`);
      console.log('üíæ ========== FIM DO SALVAMENTO ==========');
      
      } catch (err) {
        console.error('‚ùå Erro ao salvar conversas recentes:', err);
        
        // Se for erro de tamanho, avisar o usu√°rio
        if(err.message && err.message.includes('exceeds')) {
          console.error('üö® ERRO DE TAMANHO DO DOCUMENTO!');
          
          // Recalcular tamanho para mostrar no erro
          try {
            const errorDataStr = JSON.stringify({ iaChats: recentChats });
            const errorDataSize = new Blob([errorDataStr]).size;
            console.error('üìè Campo iaChats: ' + (errorDataSize / 1024).toFixed(2) + ' KB');
          } catch(e) {
            console.error('üìè N√£o foi poss√≠vel calcular tamanho do campo iaChats');
          }
          
          console.error('üì¶ Documento completo excedeu 1MB (Firebase limit)');
          console.error('üí° SOLU√á√ÉO: Execute reduzirDocumentoUsuario() no console AGORA!');
          
          // Extrair tamanho do erro
          const match = err.message.match(/(\d+,?\d*) bytes/);
          if(match) {
            const docSizeBytes = parseInt(match[1].replace(/,/g, ''));
            const docSizeMB = (docSizeBytes / 1024 / 1024).toFixed(2);
            console.error(`üì¶ Tamanho total do documento: ${docSizeMB} MB (${docSizeBytes.toLocaleString()} bytes)`);
          }
          
          mgToast('üö® DOCUMENTO EXCEDEU 1MB! Execute: await reduzirDocumentoUsuario()', 'error', 10000);
        }
        
        throw err;
      }
    }
    
    // üî• Fun√ß√£o para salvar/atualizar uma conversa individual
    // Usado ao renomear ou adicionar mensagens
    async function saveIndividualChat(chat) {
      if (!chat) return;
      
      const chatIndex = IA_CHATS.findIndex(c => c.id === chat.id);
      if (chatIndex === -1) return;
      
      // Atualizar timestamp
      chat.updatedAt = Date.now();
      
      // Se √© uma das 10 mais recentes, salvar no documento principal
      const isRecent = chatIndex < 10;
      
      if (isRecent) {
        // Atualizar no documento principal com prote√ß√£o
        const recentChats = IA_CHATS.slice(0, 10);
        USER_DATA.iaChats = recentChats;
        const result = await safeWriteUserDoc({ iaChats: recentChats });
        if(!result.success) {
          console.error('‚ùå Falha ao atualizar conversa:', result.error);
          throw new Error(result.error);
        }
        console.log(`‚úÖ Conversa atualizada no documento principal`);
      } else {
        // Salvar na subcole√ß√£o
        try {
          const userId = auth.currentUser?.uid;
          if (userId) {
            const chatId = chat.id || `chat_${chat.createdAt}`;
            const chatDocRef = doc(db, 'usuarios', userId, 'iaChats', chatId);
            await setDoc(chatDocRef, {
              ...chat,
              id: chatId,
              location: 'archive'
            }, { merge: true });
            console.log(`‚úÖ Conversa atualizada na subcole√ß√£o`);
          }
        } catch (err) {
          console.error('‚ùå Erro ao salvar conversa na subcole√ß√£o:', err);
        }
      }
    }
    
    function renderIAChatList(){
      if(!iaChatList) return;
      const q = (iaChatSearch?.value || '').trim().toLowerCase();
      const filtered = IA_CHATS.filter(chat=>{
        if(!q) return true;
        const title = chatTitle(chat).toLowerCase();
        const lastContent = (chat.messages?.[chat.messages.length-1]?.content || '').toLowerCase();
        return title.includes(q) || lastContent.includes(q);
      });
      if(!filtered.length){
        iaChatList.innerHTML = `<div class="ia-chat-empty">${IA_CHATS.length ? 'Nenhuma conversa encontrada.' : 'Crie sua primeira conversa.'}</div>`;
        return;
      }
      iaChatList.innerHTML = filtered.map(chat=>{
        const isActive = CURRENT_CHAT && CURRENT_CHAT.id === chat.id;
        const lastMsg = chat.messages?.[chat.messages.length-1] || null;
        const rawContent = lastMsg ? (lastMsg.loading ? 'Digitando‚Ä¶' : (lastMsg.content || '')) : 'Sem mensagens';
        // Converter HTML para texto leg√≠vel no preview
        const rawPreview = htmlStringToText(rawContent);
        const preview = rawPreview.length > 80 ? rawPreview.slice(0,77)+'‚Ä¶' : rawPreview;
        const meta = formatTimestamp(chat.updatedAt || chat.createdAt);
        return `<button class="ia-chat-item${isActive ? ' active' : ''}" data-id="${chat.id}">
          <div class="ia-chat-title">${escHtml(chatTitle(chat))}</div>
          <div class="ia-chat-preview">${escHtml(preview)}</div>
          <div class="ia-chat-meta">${escHtml(meta)}</div>
        </button>`;
      }).join('');
    }
    function renderIADocsList(){
      if(iaDocsCount) iaDocsCount.textContent = String(IA_DOCS.length);
      if(!iaDocsList) return;
      if(iaKnowledge && IA_DOCS.length && iaKnowledge.dataset.userClosed !== 'true'){
        iaKnowledge.open = true;
      }
      if(!IA_DOCS.length){
        iaDocsList.innerHTML = `<div class="ia-doc-empty">Nenhum documento enviado ainda.</div>`;
        return;
      }
      const sorted = [...IA_DOCS].sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));
      iaDocsList.innerHTML = sorted.map(doc=>{
        let createdTs = doc.createdAt;
        if(createdTs && typeof createdTs.toMillis === 'function'){
          try{ createdTs = createdTs.toMillis(); }
          catch(_){ createdTs = Number(createdTs); }
        }
        const created = createdTs ? formatTimestamp(createdTs) : '';
        const createdLabel = created || 'Sem data';
        const size = humanFileSize(doc.size || doc.chars || 0);
        const words = doc.words || computeWordCount(doc.text || '');
        const truncated = doc.truncated ? '<span class="muted"> ‚Ä¢ texto truncado</span>' : '';
        return `<div class="ia-doc-item" data-id="${doc.id}">
          <h4>${escHtml(doc.name || doc.originalName || 'Documento')}</h4>
          <div class="ia-doc-meta">
            <span>${escHtml(size)}</span>
            <span>${words} palavras</span>
            <span>${escHtml(createdLabel)}</span>
            ${truncated}
          </div>
          <div class="ia-doc-buttons">
            <button class="btn ghost small ia-doc-download" type="button" data-id="${doc.id}">Baixar TXT</button>
            <button class="btn ghost small danger ia-doc-delete" type="button" data-id="${doc.id}">Excluir</button>
          </div>
        </div>`;
      }).join('');
    }
    function updateIADocsStatus(){
      if(!iaDocsStatus) return;
      if(!IA_DOCS_PENDING.length){
        iaDocsStatus.textContent = IA_DOCS.length ? 'Selecione novos arquivos para enviar.' : 'Nenhum arquivo selecionado.';
        if(iaDocsUpload) iaDocsUpload.disabled = true;
        if(iaKnowledge && !IA_DOCS.length && iaKnowledge.dataset.userClosed !== 'true'){
          iaKnowledge.open = false;
        }
        return;
      }
      const total = IA_DOCS_PENDING.reduce((sum,file)=> sum + (file.size||0), 0);
      iaDocsStatus.textContent = `${IA_DOCS_PENDING.length} arquivo(s) selecionado(s) ‚Ä¢ ${humanFileSize(total)}`;
      if(iaDocsUpload) iaDocsUpload.disabled = false;
      if(iaKnowledge){
        iaKnowledge.open = true;
        delete iaKnowledge.dataset.userClosed;
      }
    }
    async function loadIADocs(){
      if(!iaDocsList) return;
      const userKeys = getUserKeyCandidates();
      const clientKey = getClientKey();
      if(!userKeys.length || !clientKey){
        IA_DOCS = [];
        renderIADocsList();
        return;
      }
      const primaryKey = userKeys[0];
      let primaryDocs = [];
      const legacyDocs = [];
      for(let i=0;i<userKeys.length;i++){
        const key = userKeys[i];
        try{
          const col = collection(db, 'usuarios', key, 'clients', clientKey, 'iaDocs');
          const snap = await getDocs(col);
          const mapped = snap.docs.map(d=>{
            const data = d.data() || {};
            let createdAt = data.createdAt;
            if(createdAt && typeof createdAt.toMillis === 'function'){
              try{ createdAt = createdAt.toMillis(); }
              catch(_){ createdAt = Number(createdAt); }
            }
            return { id:d.id, ...data, createdAt, userKey: key, isLegacy: key !== primaryKey };
          });
          if(i === 0){
            primaryDocs = mapped;
          }else if(mapped.length){
            legacyDocs.push(...mapped);
          }
        }catch(err){
          console.warn('loadIADocs', key, err);
        }
      }
      IA_DOCS = [...primaryDocs, ...legacyDocs];
      renderIADocsList();
    }
    let iaDocsUploading = false;
    async function uploadPendingIADocs(){
      if(iaDocsUploading) return;
      if(!IA_DOCS_PENDING.length){ alert('Selecione ao menos um arquivo.'); return; }
      if(!auth.currentUser){ alert('Fa√ßa login para enviar documentos.'); return; }
      const uid = getUserKey();
      const clientKey = getClientKey();
      if(!uid || !clientKey){ alert('Cliente n√£o identificado.'); return; }
      iaDocsUploading = true;
      if(iaDocsUpload) iaDocsUpload.disabled = true;
      if(iaDocsPick) iaDocsPick.disabled = true;
      if(iaDocsStatus) iaDocsStatus.textContent = 'Convertendo documentos...';
      try{
        const col = collection(db, 'usuarios', uid, 'clients', clientKey, 'iaDocs');
        const errors = [];
        for(const file of IA_DOCS_PENDING){
          try{
            let text = await extractPlainTextFromFile(file);
            if(!text){ throw new Error('Nenhum texto detectado'); }
            let truncated = false;
            if(text.length > IA_MAX_DOC_CHARS){
              text = text.slice(0, IA_MAX_DOC_CHARS);
              truncated = true;
            }
            const payload = {
              name: file.name,
              originalName: file.name,
              size: file.size || text.length,
              type: file.type || (file.name.split('.').pop()||'').toLowerCase(),
              chars: text.length,
              words: computeWordCount(text),
              text,
              truncated,
              createdAt: Date.now()
            };
            await addDoc(col, payload);
          }catch(err){
            console.error('uploadPendingIADocs', err);
            errors.push({ file, message: err?.message || String(err) });
          }
        }
        IA_DOCS_PENDING = [];
        if(iaDocsInput) iaDocsInput.value = '';
        await loadIADocs();
        invalidateIAContextCache();
        if(iaDocsStatus){
          if(errors.length){
            iaDocsStatus.textContent = `Falhou em ${errors.length} arquivo(s): ${errors.map(e=>`${e.file.name} (${e.message})`).join('; ')}`;
          }else{
            iaDocsStatus.textContent = 'Documentos enviados com sucesso!';
          }
          setTimeout(()=> updateIADocsStatus(), 5000);
        }
      }finally{
        if(iaDocsUpload) iaDocsUpload.disabled = false;
        if(iaDocsPick) iaDocsPick.disabled = false;
        if(!IA_DOCS_PENDING.length && iaDocsUpload) iaDocsUpload.disabled = true;
        iaDocsUploading = false;
      }
    }
    
    // ===== EDI√á√ÉO DE MENSAGENS DA IA =====
    function toggleEditMode(msgIndex){
      if(!CURRENT_CHAT || !Array.isArray(CURRENT_CHAT.messages)) return;
      if(msgIndex < 0 || msgIndex >= CURRENT_CHAT.messages.length) return;
      
      const targetMsg = CURRENT_CHAT.messages[msgIndex];
      if(targetMsg.role !== 'assistant') return;
      
      // Encontrar o elemento da mensagem
      const msgElements = iaHistory?.querySelectorAll('.ia-msg-assistant');
      if(!msgElements) return;
      
      // Encontrar o √≠ndice correto (s√≥ mensagens assistant)
      const assistantMessages = CURRENT_CHAT.messages.filter(m => m.role === 'assistant');
      const assistantIndex = assistantMessages.indexOf(targetMsg);
      if(assistantIndex === -1 || assistantIndex >= msgElements.length) return;
      
      const msgElement = msgElements[assistantIndex];
      const bubble = msgElement.querySelector('.ia-msg-bubble');
      if(!bubble) return;
      
      // Se j√° est√° em modo de edi√ß√£o, n√£o fazer nada
      if(msgElement.classList.contains('ia-msg-editing')) return;
      
      // Adicionar modo de edi√ß√£o
      msgElement.classList.add('ia-msg-editing');
      
      // Criar √°rea de edi√ß√£o se n√£o existe
      let editArea = bubble.querySelector('.ia-msg-edit-area');
      if(!editArea){
        editArea = document.createElement('div');
        editArea.className = 'ia-msg-edit-area';
        
        const textarea = document.createElement('textarea');
        textarea.className = 'ia-msg-edit-textarea';
        textarea.value = targetMsg.content || '';
        
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'ia-msg-edit-actions';
        
        const saveBtn = document.createElement('button');
        saveBtn.className = 'ia-msg-edit-save';
        saveBtn.textContent = 'üíæ Salvar';
        saveBtn.onclick = () => saveEditedMessage(msgIndex, textarea.value);
        
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'ia-msg-edit-cancel';
        cancelBtn.textContent = '‚úï Cancelar';
        cancelBtn.onclick = () => cancelEditMode(msgIndex);
        
        actionsDiv.appendChild(cancelBtn);
        actionsDiv.appendChild(saveBtn);
        
        editArea.appendChild(textarea);
        editArea.appendChild(actionsDiv);
        
        bubble.insertBefore(editArea, bubble.firstChild);
        
        // Focar no textarea
        setTimeout(() => textarea.focus(), 100);
      }
    }
    
    function saveEditedMessage(msgIndex, newContent){
      if(!CURRENT_CHAT || !Array.isArray(CURRENT_CHAT.messages)) return;
      if(msgIndex < 0 || msgIndex >= CURRENT_CHAT.messages.length) return;
      
      const trimmedContent = newContent.trim();
      if(!trimmedContent){
        if(typeof mgToast === 'function'){
          mgToast('‚ö†Ô∏è O conte√∫do n√£o pode estar vazio');
        }
        return;
      }
      
      // Atualizar a mensagem
      CURRENT_CHAT.messages[msgIndex].content = trimmedContent;
      CURRENT_CHAT.updatedAt = Date.now();
      
      // Salvar no Firebase
      const uid = auth.currentUser?.uid;
      if(uid && CURRENT_CHAT.id){
        const chatRef = doc(db, 'usuarios', uid, 'iaChats', CURRENT_CHAT.id);
        updateDoc(chatRef, {
          messages: CURRENT_CHAT.messages,
          updatedAt: CURRENT_CHAT.updatedAt
        }).catch(err => {
          console.error('Erro ao salvar edi√ß√£o:', err);
          if(typeof mgToast === 'function'){
            mgToast('‚ùå Erro ao salvar altera√ß√µes');
          }
        });
      }
      
      // Re-renderizar
      renderIAHistory();
      
      if(typeof mgToast === 'function'){
        mgToast('‚úÖ Resposta atualizada com sucesso');
      }
    }
    
    function cancelEditMode(msgIndex){
      const msgElements = iaHistory?.querySelectorAll('.ia-msg-assistant');
      if(!msgElements) return;
      
      if(!CURRENT_CHAT || !Array.isArray(CURRENT_CHAT.messages)) return;
      
      const assistantMessages = CURRENT_CHAT.messages.filter(m => m.role === 'assistant');
      const assistantIndex = assistantMessages.findIndex((_, idx) => {
        let realIdx = 0;
        for(let i = 0; i < CURRENT_CHAT.messages.length; i++){
          if(CURRENT_CHAT.messages[i].role === 'assistant'){
            if(realIdx === idx) return i === msgIndex;
            realIdx++;
          }
        }
        return false;
      });
      
      if(assistantIndex === -1 || assistantIndex >= msgElements.length) return;
      
      const msgElement = msgElements[assistantIndex];
      msgElement.classList.remove('ia-msg-editing');
    }
    
    function renderIAHistory(autoScroll = true){
      if(!iaHistory) return;
      if(!CURRENT_CHAT){
        iaHistory.innerHTML = '';
        if(iaCurrentTitle) iaCurrentTitle.textContent = 'Selecione uma conversa';
        if(iaEmptyState) iaEmptyState.style.display = 'flex';
        updateIASourceNote();
        return;
      }
      const messages = CURRENT_CHAT.messages || [];
      updateIASourceNote(Array.isArray(CURRENT_CHAT.lastSources) ? CURRENT_CHAT.lastSources : []);
      if(iaCurrentTitle) iaCurrentTitle.textContent = chatTitle(CURRENT_CHAT);
      if(iaEmptyState) iaEmptyState.style.display = messages.length ? 'none' : 'flex';
      iaHistory.innerHTML = messages.map((msg, idx)=>{
        const cls = msg.role === 'user' ? 'ia-msg ia-msg-user' : 'ia-msg ia-msg-assistant';
        const meta = formatTimestamp(msg.ts);
        const isAssistant = msg.role === 'assistant';
        const isLoading = !!msg.loading;
        
        // Preparar conte√∫do com imagem se houver
        let imageHtml = '';
        if(msg.image){
          imageHtml = `<div style="margin-bottom: 10px;">
            <img src="${msg.image}" alt="Imagem anexada" style="max-width: 300px; max-height: 300px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2);">
          </div>`;
        }
        
        const content = isLoading
          ? '<div class="ia-typing"><span></span><span></span><span></span></div>'
          : `${imageHtml}<div class="ia-msg-content markdown-view">${renderMessageContent(msg.content)}</div>`;
        const actions = (!isLoading && isAssistant)
          ? `<div class="ia-msg-actions">
              <button type="button" class="ia-edit-btn" data-msg-index="${idx}">‚úèÔ∏è Editar</button>
              <button type="button" class="ia-copy-btn" data-msg-index="${idx}">Copiar</button>
              <button type="button" class="ia-add-all-planning-btn" data-msg-index="${idx}">üìã Adicionar todas as linhas ao planejamento</button>
              <button type="button" class="ia-add-metas-btn" data-msg-index="${idx}">üìà Adicionar √†s Metas</button>
            </div>`
          : '';
        return `<div class="${cls}">
          <div class="ia-msg-bubble">${content}${actions}</div>
          ${meta ? `<span class="ia-msg-meta">${escHtml(meta)}</span>` : ''}
        </div>`;
      }).join('');
      // S√≥ rolar para baixo se autoScroll = true (ex: nova mensagem)
      if(autoScroll){
        requestAnimationFrame(()=>{ 
          iaHistory.scrollTop = iaHistory.scrollHeight; 
          iaHistoryScrollPos = iaHistory.scrollHeight;
        });
      } else {
        // Restaurar posi√ß√£o anterior ao trocar de aba
        requestAnimationFrame(()=>{ 
          iaHistory.scrollTop = iaHistoryScrollPos;
        });
      }
    }
    function focusComposer(){ setTimeout(()=> iaQuestion?.focus(), 60); }
    function autoResizeComposer(){
      if(!iaQuestion) return;
      iaQuestion.style.height = 'auto';
      const minHeight = 48;
      const target = Math.max(minHeight, Math.min(180, iaQuestion.scrollHeight || minHeight));
      iaQuestion.style.height = `${target}px`;
    }
    function openIAWithPrompt(promptText){
      if(typeof promptText !== 'string') return;
      const trimmed = promptText.trim();
      if(!trimmed) return;
      const applyPrompt = ()=>{
        if(!iaQuestion) return;
        iaQuestion.value = trimmed;
        autoResizeComposer();
        focusComposer();
      };
      if(currentSection === 'ia'){
        applyPrompt();
        return;
      }
      const iaTab = sectionTabs?.querySelector('.tab-btn[data-section="ia"]');
      if(iaTab){
        iaTab.click();
        setTimeout(applyPrompt, 80);
      } else {
        currentSection = 'ia';
        localStorage.setItem('mg_currentSection', currentSection);
        rerenderBySection();
        setTimeout(applyPrompt, 80);
      }
    }
    function newIAChat(){
      console.log('‚ú® Nova conversa iniciada na aba I.A');
      const chat = { 
        id: uuid(), 
        title: 'Nova conversa', 
        createdAt: Date.now(), 
        updatedAt: Date.now(), 
        messages: [], 
        lastSources: [],
        location: 'main' // Nova conversa sempre come√ßa no documento principal
      };
      IA_CHATS.push(chat);
      touchChat(chat);
      CURRENT_CHAT = chat;
      renderIAChatList();
      renderIAHistory();
      saveIAChatsToUserData();
      // N√£o focar no composer para manter a visualiza√ß√£o no topo
    }
    
    // Fun√ß√£o para mostrar notifica√ß√£o de custo da resposta
    function showCostNotification(inputTokens, outputTokens, totalCost){
      const badge = document.getElementById('iaCostBadge');
      if(!badge) return;
      
      // Mostrar badge se estava oculto
      badge.style.display = 'inline-flex';
      
      // Atualizar texto com custo
      const costInCents = totalCost * 100;
      badge.textContent = ` $${totalCost.toFixed(4)}`;
      badge.title = `Input: ${inputTokens.toLocaleString()} tokens\nOutput: ${outputTokens.toLocaleString()} tokens\nTotal: $${totalCost.toFixed(4)} (~${costInCents.toFixed(2)}¬¢)`;
      
      // Adicionar anima√ß√£o flash
      badge.classList.remove('flash');
      void badge.offsetWidth; // Trigger reflow
      badge.classList.add('flash');
      
      // Remover classe flash ap√≥s anima√ß√£o
      setTimeout(() => badge.classList.remove('flash'), 500);
    }
    
    function htmlStringToText(html){
      if(!html) return "";
      try{
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const text = doc?.body?.innerText || doc?.documentElement?.innerText || "";
        return normalizePlainText(text);
      }catch(err){
        try{
          const temp = document.createElement('div');
          temp.innerHTML = html;
          return normalizePlainText(temp.textContent || temp.innerText || "");
        }catch(_err){
          console.warn('htmlStringToText', err);
          return "";
        }
      }
    }
    async function ensurePlatformCode(){
      if(PLATFORM_CODE && PLATFORM_TEXT) return;
      try{
        const [html, js, rotinaJs] = await Promise.all([
          fetch(location.pathname).then(r=>r.text()).catch(()=>""),
          fetch("comemorative_dates_2025.js").then(r=>r.text()).catch(()=>""),
          fetch("rotina_dropdowns.js").then(r=>r.text()).catch(()=>"")
        ]);
        PLATFORM_CODE = [html, js, rotinaJs].filter(Boolean).join("\n\n");
        if(!PLATFORM_TEXT){
          const htmlText = htmlStringToText(html);
          if(htmlText){
            PLATFORM_TEXT = htmlText;
          }
        }
      }catch(err){
        console.warn('erro carregando c√≥digo', err);
      }
      if(!PLATFORM_TEXT){
        try{
          const liveText = document?.body?.innerText || document?.documentElement?.innerText || "";
          PLATFORM_TEXT = normalizePlainText(liveText);
        }catch(err){
          console.warn('fallback platform text', err);
        }
      }
    }
    function firestoreReplacer(_key, value){
      if(value && typeof value === 'object'){
        if(typeof value.toDate === 'function'){
          try{ return value.toDate().toISOString(); }
          catch(_err){ try{ return value.toMillis(); }catch(_e){ return value; } }
        }
        if(value instanceof Date){
          try{ return value.toISOString(); }
          catch(_){ return value; }
        }
      }
      return value;
    }
    function deepClonePlain(value){
      if(value === undefined) return undefined;
      try{
        return JSON.parse(JSON.stringify(value, firestoreReplacer));
      }catch(err){
        console.warn('deepClonePlain', err);
        try{
          return JSON.parse(JSON.stringify(value));
        }catch(_){
          return value;
        }
      }
    }
    function trimLargeText(text, limit){
      if(!text) return '';
      if(text.length <= limit) return text;
      return text.slice(0, limit) + `\n...[conte√∫do truncado; ${text.length-limit} caracteres n√£o enviados]`;
    }
    function safeStringify(value){
      try{
        return JSON.stringify(value, firestoreReplacer, 2);
      }catch(err){
        console.warn('safeStringify', err);
        return '';
      }
    }
    async function fetchDocWithFallback(uid, rawKey, safeKey){
      const attempts = [
        rawKey ? ['usuarios', uid, 'clients', rawKey] : null,
        (safeKey && safeKey !== rawKey) ? ['usuarios', uid, 'clients', safeKey] : null
      ].filter(Boolean);
      for(const parts of attempts){
        try{
          const snap = await getDoc(doc(db, ...parts));
          if(snap.exists()){
            return { data: deepClonePlain(snap.data()), path: parts };
          }
        }catch(err){
          console.warn('fetchDocWithFallback', parts.join('/'), err);
        }
      }
      return { data: null, path: attempts[0] || null };
    }
    async function fetchCollectionWithFallback(paths){
      for(const parts of paths){
        if(!parts) continue;
        try{
          const col = collection(db, ...parts);
          const snap = await getDocs(col);
          return {
            data: snap.docs.map(docSnap => ({ id: docSnap.id, ...deepClonePlain(docSnap.data() || {}) })),
            path: parts
          };
        }catch(err){
          console.warn('fetchCollectionWithFallback', parts.join('/'), err);
        }
      }
      return { data: [], path: null };
    }
    async function fetchFileStructure(uid, rawKey, safeKey){
      const folderResult = await fetchCollectionWithFallback([
        rawKey ? ['usuarios', uid, 'clients', rawKey, 'fileFolders'] : null,
        (safeKey && safeKey !== rawKey) ? ['usuarios', uid, 'clients', safeKey, 'fileFolders'] : null
      ]);
      const folders = [];
      for(const folder of folderResult.data){
        const basePath = folderResult.path ? [...folderResult.path, folder.id, 'files'] : null;
        const altPath = (safeKey && safeKey !== rawKey && (!folderResult.path || folderResult.path[3] !== safeKey))
          ? ['usuarios', uid, 'clients', safeKey, 'fileFolders', folder.id, 'files']
          : null;
        const filesResult = await fetchCollectionWithFallback([
          basePath,
          altPath
        ]);
        folders.push({
          ...folder,
          sourceCollectionPath: joinPath(folderResult.path),
          filesCollectionPath: joinPath(filesResult.path),
          files: filesResult.data
        });
      }
      return {
        collectionPath: joinPath(folderResult.path),
        folders
      };
    }
    async function fetchIframeSnapshots(uid, rawKey, safeKey){
      const result = await fetchCollectionWithFallback([
        safeKey ? ['usuarios', uid, 'clients', safeKey, 'iframes'] : null,
        (rawKey && rawKey !== safeKey) ? ['usuarios', uid, 'clients', rawKey, 'iframes'] : null
      ]);
      return {
        collectionPath: joinPath(result.path),
        data: result.data
      };
    }
    async function fetchIADocuments(userKeys, rawKey, safeKey){
      const keys = Array.isArray(userKeys) ? userKeys.filter(Boolean) : [userKeys].filter(Boolean);
      if(!keys.length) return { collectionPath: null, data: [] };
      const primaryKey = keys[0];
      const aggregated = [];
      let primaryPath = null;
      for(const key of keys){
        const pathCandidates = [];
        if(safeKey) pathCandidates.push(['usuarios', key, 'clients', safeKey, 'iaDocs']);
        if(rawKey && rawKey !== safeKey) pathCandidates.push(['usuarios', key, 'clients', rawKey, 'iaDocs']);
        for(let i=0;i<pathCandidates.length;i++){
          const parts = pathCandidates[i];
          if(!parts) continue;
          if(!primaryPath && key === primaryKey) primaryPath = parts;
          try{
            const snap = await getDocs(collection(db, ...parts));
            if(!snap.empty){
              snap.docs.forEach(docSnap=>{
                aggregated.push({
                  id: docSnap.id,
                  ...deepClonePlain(docSnap.data() || {}),
                  userKey: key,
                  isLegacy: key !== primaryKey,
                  collectionPath: joinPath(parts)
                });
              });
            }
          }catch(err){
            console.warn('fetchIADocuments', parts.join('/'), err);
          }
        }
      }
      return {
        collectionPath: joinPath(primaryPath),
        data: aggregated
      };
    }
    async function fetchClientDataSnapshot(force){
      const now = Date.now();
      if(!force && IA_CONTEXT_CACHE.data && (now - IA_CONTEXT_CACHE.ts) < IA_CONTEXT_TTL){
        return IA_CONTEXT_CACHE.data;
      }
      const uid = auth.currentUser?.uid || null;
      const email = auth.currentUser?.email || null;
      const displayName = auth.currentUser?.displayName || null;
      const userKeysForRead = getUserKeyCandidates();
      const tenant = getClientKey() || null;
      const safeTenant = tenant ? tenant.replace(/[^\w-]/g, '_') : null;
      const snapshot = {
        fetchedAt: new Date().toISOString(),
        tenant,
        user: { uid, email, displayName },
        platformState: {
          userData: deepClonePlain(typeof USER_DATA !== 'undefined' ? USER_DATA : null),
          postsState: deepClonePlain(Array.isArray(POSTS) ? POSTS : []),
          calendarNotesState: deepClonePlain(typeof CAL_NOTES !== 'undefined' ? CAL_NOTES : {}),
          refSocialState: deepClonePlain(Array.isArray(REF_SOCIAL) ? REF_SOCIAL : []),
          socialLinksState: deepClonePlain(typeof SOCIAL_LINKS !== 'undefined' ? SOCIAL_LINKS : {}),
          demandasState: deepClonePlain(Array.isArray(DEMANDAS) ? DEMANDAS : []),
          metasState: deepClonePlain(Array.isArray(METAS) ? METAS : []),
          metaPanelsState: deepClonePlain(Array.isArray(META_PANELS) ? META_PANELS : []),
          notesState: deepClonePlain(Array.isArray(NOTES) ? NOTES : []),
          briefState: deepClonePlain(typeof BRIEF !== 'undefined' ? BRIEF : null),
          widgetsState: deepClonePlain(Array.isArray(WIDGETS) ? WIDGETS : [])
        }
      };
      if(!uid || !tenant){
        IA_CONTEXT_CACHE.data = snapshot;
        IA_CONTEXT_CACHE.ts = now;
        return snapshot;
      }
      const [userDoc, clientDoc, calendarNotes, postsCollection, fileStructure, iframeSnapshots, iaDocsCollection] = await Promise.all([
        (async ()=>{
          try{
            const snap = await getDoc(doc(db,'usuarios',uid));
            return snap.exists() ? deepClonePlain(snap.data()) : null;
          }catch(err){
            console.warn('fetch user doc', err);
            return null;
          }
        })(),
        fetchDocWithFallback(uid, tenant, safeTenant),
        fetchCollectionWithFallback([
          tenant ? ['usuarios', uid, 'clients', tenant, 'calendarNotes'] : null,
          (safeTenant && safeTenant !== tenant) ? ['usuarios', uid, 'clients', safeTenant, 'calendarNotes'] : null
        ]),
        (async ()=>{
          try{
            const colPath = ['usuarios', uid, 'posts'];
            const snap = await getDocs(collection(db, ...colPath));
            return {
              path: colPath,
              data: snap.docs.map(docSnap => ({ id: docSnap.id, ...deepClonePlain(docSnap.data() || {}) }))
            };
          }catch(err){
            console.warn('fetch posts collection', err);
            return { path: ['usuarios', uid, 'posts'], data: [] };
          }
        })(),
        fetchFileStructure(uid, tenant, safeTenant),
        fetchIframeSnapshots(uid, tenant, safeTenant),
        fetchIADocuments(userKeysForRead, tenant, safeTenant)
      ]);
      snapshot.firebase = {
        userDoc,
        userDocPath: joinPath(['usuarios', uid]),
        clientDoc: clientDoc.data,
        clientDocPath: joinPath(clientDoc.path),
        calendarNotes: calendarNotes.data,
        calendarNotesPath: joinPath(calendarNotes.path),
        posts: postsCollection.data,
        postsPath: joinPath(postsCollection.path),
        fileFolders: fileStructure.folders,
        fileFoldersPath: fileStructure.collectionPath,
        iframes: iframeSnapshots.data,
        iframesPath: iframeSnapshots.collectionPath,
        iaDocs: iaDocsCollection.data,
        iaDocsPath: iaDocsCollection.collectionPath
      };
      IA_CONTEXT_CACHE.data = snapshot;
      IA_CONTEXT_CACHE.ts = now;
      return snapshot;
    }
    function formatMonthLabel(monthKey){
      if(typeof monthKey !== 'string') return String(monthKey || '');
      const parts = monthKey.split('-');
      if(parts.length !== 2) return monthKey;
      const [year, month] = parts;
      const date = new Date(Number(year), Number(month) - 1, 1);
      if(Number.isNaN(date.getTime())) return monthKey;
      return date.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' });
    }
    function summarizeMetasForGuide(metas){
      const list = Array.isArray(metas) ? metas.filter(meta => meta && meta.ativo !== false) : [];
      if(!list.length){
        return 'Nenhuma meta cadastrada at√© o momento.';
      }
      return list.slice(0, 8).map(meta=>{
        const desc = meta?.descricao || 'Meta sem t√≠tulo';
        const unidade = meta?.unidade || '';
        const modo = meta?.modo === 'media' ? 'valor m√©dio' : 'valor total';
        const meses = meta?.meses && typeof meta.meses === 'object' ? Object.entries(meta.meses) : [];
        const recent = meses.sort((a,b)=>a[0].localeCompare(b[0])).slice(-6);
        const monthPieces = recent.map(([month, vals])=>{
          const planejado = vals?.p ?? '';
          const realizado = vals?.r ?? '';
          const partes = [];
          if(planejado !== '' && planejado !== null){ partes.push(`meta ${planejado}`); }
          if(realizado !== '' && realizado !== null){ partes.push(`realizado ${realizado}`); }
          if(!partes.length) partes.push('sem dados');
          return `${formatMonthLabel(month)}: ${partes.join(' / ')}`;
        });
        const detalheMeses = monthPieces.length ? monthPieces.join('; ') : 'nenhum m√™s preenchido';
        return `${desc} (${modo} ‚Ä¢ ${unidade || 'sem unidade'}). Meses: ${detalheMeses}.`;
      }).join('\n');
    }
    function summarizeRefSocial(refs){
      if(!Array.isArray(refs) || !refs.length){
        return 'Nenhuma refer√™ncia cadastrada.';
      }
      const counts = refs.reduce((acc, item)=>{
        const cat = (item?.category || 'sem categoria').toLowerCase();
        acc[cat] = (acc[cat] || 0) + 1;
        return acc;
      }, {});
      return Object.entries(counts).map(([cat, count])=>`${cat}: ${count}`).join(' ‚Ä¢ ');
    }
    function summarizePosts(posts){
      if(!Array.isArray(posts) || !posts.length){
        return 'Nenhum post registrado.';
      }
      const byStatus = posts.reduce((acc, post)=>{
        const st = (post?.status || 'pendente').toLowerCase();
        acc[st] = (acc[st] || 0) + 1;
        return acc;
      }, {});
      const total = posts.length;
      const detail = Object.entries(byStatus).map(([status, count])=>`${status}: ${count}`).join(' ‚Ä¢ ');
      return `Total de posts: ${total}. Distribui√ß√£o por status ‚Üí ${detail}.`;
    }
    function summarizeCalendarNotes(notes){
      if(!notes || typeof notes !== 'object') return 'Nenhuma anota√ß√£o no calend√°rio.';
      const entries = Object.keys(notes);
      if(!entries.length) return 'Nenhuma anota√ß√£o no calend√°rio.';
      const recent = entries.sort().slice(-6);
      return `Anota√ß√µes recentes (${recent.length}): ${recent.map(formatMonthLabel).join(', ')}.`;
    }
    function summarizeDemandas(demandas){
      if(!Array.isArray(demandas) || !demandas.length){
        return 'Nenhuma demanda cadastrada.';
      }
      const statusLabels = {
        'nao-iniciado': 'N√£o iniciado',
        'em-andamento': 'Em andamento',
        'bloqueado': 'Bloqueado',
        'concluido': 'Conclu√≠do',
        'prioridade': 'Prioridade',
        'prioridade-grupo': 'Prioridade/Grupo',
        'concluido-grupo': 'Conclu√≠do/Grupo'
      };
      const counters = demandas.reduce((acc, demanda)=>{
        const key = demanda?.status || 'sem status';
        acc[key] = (acc[key] || 0) + 1;
        return acc;
      }, {});
      const overdue = demandas.filter(d=>{
        const dueDate = getDemandaDueDate(d);
        if(!dueDate) return false;
        const due = dueDate.getTime();
        if(Number.isNaN(due)) return false;
        const done = d.status === 'concluido' || d.status === 'concluido-grupo';
        return !done && due < Date.now();
      }).length;
      const pieces = Object.entries(counters).map(([status, count])=>{
        const label = statusLabels[status] || status;
        return `${label}: ${count}`;
      });
      if(overdue){
        pieces.push(`Atrasadas: ${overdue}`);
      }
      return `Demandas registradas (${demandas.length}). ${pieces.join(' ‚Ä¢ ') || 'Distribui√ß√£o n√£o dispon√≠vel.'}`;
    }
    function formatDateForText(value){
      if(value && typeof value === 'object' && !Array.isArray(value)){
        const label = formatPrazoLabel(value);
        return label || 'sem per√≠odo';
      }
      if(!value) return 'sem per√≠odo';
      const date = new Date(value);
      if(Number.isNaN(date.getTime())){
        return String(value);
      }
      try{
        return date.toLocaleString('pt-BR', { hour12: false });
      }catch(_){
        return date.toISOString();
      }
    }
    function buildDemandasText(demandas){
      if(!Array.isArray(demandas) || !demandas.length){
        return '';
      }
      const statusLabels = {
        'nao-iniciado': 'N√£o iniciado',
        'em-andamento': 'Em andamento',
        'bloqueado': 'Bloqueado',
        'concluido': 'Conclu√≠do',
        'prioridade': 'Prioridade',
        'prioridade-grupo': 'Prioridade/Grupo',
        'concluido-grupo': 'Conclu√≠do/Grupo'
      };
      const sorted = [...demandas].sort((a,b)=>{
        const aDate = getDemandaStartDate(a);
        const bDate = getDemandaStartDate(b);
        const aDue = aDate ? aDate.getTime() : 0;
        const bDue = bDate ? bDate.getTime() : 0;
        if(aDue !== bDue) return aDue - bDue;
        return (a?.demanda || '').localeCompare(b?.demanda || '');
      });
      return sorted.map(item=>{
        const title = (item?.demanda || 'Sem t√≠tulo').trim();
        const status = statusLabels[item?.status] || item?.status || 'Sem status';
        const tag = item?.tag || 'Sem tag';
        const owner = item?.responsavel || 'Sem respons√°vel';
        const deadline = formatDateForText(item);
        const overdue = (()=>{
          const dueDate = getDemandaDueDate(item);
          if(!dueDate) return '';
          const due = dueDate.getTime();
          if(Number.isNaN(due)) return '';
          const done = item.status === 'concluido' || item.status === 'concluido-grupo';
          return (!done && due < Date.now()) ? ' (atrasada)' : '';
        })();
        return `‚Ä¢ ${title} | Status: ${status} | Tag: ${tag} | Respons√°vel: ${owner} | Per√≠odo: ${deadline}${overdue}`;
      }).join('\n');
    }
    function formatCalendarDate(key){
      if(!key) return '';
      if(/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(key)){
        const [y,m,d] = key.split('-');
        return `${d}/${m}/${y}`;
      }
      if(/^[0-9]{4}-[0-9]{2}$/.test(key)){
        return formatMonthLabel(key);
      }
      return key;
    }
    function buildCalendarNotesDetail(notes){
      if(!notes || typeof notes !== 'object') return '';
      const entries = Object.entries(notes);
      if(!entries.length) return '';
      return entries
        .sort(([a],[b])=>a.localeCompare(b))
        .map(([key, value])=>{
          const label = formatCalendarDate(key);
          const noteText = typeof value === 'string' ? value : safeStringify(value);
          return `${label}: ${noteText}`;
        }).join('\n');
    }
    function buildPostsText(posts){
      if(!Array.isArray(posts) || !posts.length){
        return '';
      }
      const toText = text=>{
        const clean = (text || '').replace(/\s+/g, ' ').trim();
        if(clean.length > 180) return clean.slice(0, 177) + '‚Ä¶';
        return clean;
      };
      const sorted = [...posts].sort((a,b)=>{
        return (a?.dateISO || '').localeCompare(b?.dateISO || '');
      });
      return sorted.map(post=>{
        const dateISO = post?.dateISO || '';
        const label = formatCalendarDate(dateISO) || dateISO || 'Sem data';
        const status = post?.status || 'sem status';
        const target = post?.target || 'feed';
        const mediaCount = Array.isArray(post?.mediaUrls) ? post.mediaUrls.length : 0;
        const caption = toText(post?.desc || 'Sem legenda');
        return `‚Ä¢ ${label} | Destino: ${target} | Status: ${status} | M√≠dias: ${mediaCount} | Legenda: ${caption}`;
      }).join('\n');
    }
    function buildIframeText(iframes){
      if(!Array.isArray(iframes) || !iframes.length) return '';
      return iframes.map((iframe, idx)=>{
        const name = iframe?.title || iframe?.name || iframe?.id || `iframe-${idx+1}`;
        const html = iframe?.html || iframe?.content || iframe?.embed || iframe?.code || '';
        const url = iframe?.url || iframe?.src || '';
        const pieces = [`Nome: ${name}`];
        if(url){ pieces.push(`URL: ${url}`); }
        if(typeof html === 'string' && html.trim()){
          const text = htmlStringToText(html);
          if(text){ pieces.push(`Conte√∫do: ${text}`); }
        }
        if(!url && (!html || typeof html !== 'string')){
          pieces.push(`Dados: ${safeStringify(iframe)}`);
        }
        return pieces.join('\n');
      }).join('\n\n');
    }
    function summarizeAccesses(accesses){
      if(!Array.isArray(accesses) || !accesses.length){
        return 'Nenhum acesso cadastrado.';
      }
      const tags = new Set();
      accesses.forEach(acc=>{
        (acc?.tags || '').split(',').map(t=>t.trim()).filter(Boolean).forEach(tag=>tags.add(tag.toLowerCase()));
      });
      return `Total de acessos: ${accesses.length}${tags.size ? `. Tags utilizadas: ${Array.from(tags).slice(0,12).join(', ')}.` : '.'}`;
    }
    function summarizeCAC(cac){
      if(!cac || typeof cac !== 'object') return 'Sem dados de CAC informados.';
      const currency = cac.currency || 'BRL';
      const months = Object.keys({
        ...(cac.sales||{}),
        ...(cac.revenue||{}),
        ...(cac.salesAds||{}),
        ...(cac.revenueAds||{})
      });
      if(!months.length) return 'Sem dados de CAC informados.';
      const list = months.sort().slice(-6).map(formatMonthLabel).join(', ');
      return `Moeda: ${currency}. Meses com lan√ßamentos: ${list}.`;
    }
    function summarizeNotes(notes){
      if(!Array.isArray(notes) || !notes.length){
        return 'Nenhuma estrat√©gia registrada.';
      }
      const sectors = notes.reduce((acc, note)=>{
        const setor = (note?.setor || 'sem setor').toLowerCase();
        acc[setor] = (acc[setor] || 0) + 1;
        return acc;
      }, {});
      return Object.entries(sectors).map(([sector, count])=>`${sector}: ${count}`).join(' ‚Ä¢ ');
    }
    function summarizeCompetitors(snapshot){
      const { platformState = {}, firebase = {} } = snapshot || {};
      const fromState = platformState?.userData?.competitors;
      const fromClientDoc = firebase?.clientDoc?.competitors;
      const list = Array.isArray(fromClientDoc) && fromClientDoc.length ? fromClientDoc
        : (Array.isArray(fromState) ? fromState : []);
      if(!list.length){
        return 'Nenhum concorrente salvo no Firebase. Ao responder, indique a necessidade de pesquisa externa quando solicitado.';
      }
      return `Concorrentes cadastrados (${list.length}): ${list.map(c=>c?.name||'-').slice(0,8).join(', ')}.`;
    }
    function buildTabGuide(snapshot){
      if(!snapshot || typeof snapshot !== 'object') return '';
      const { platformState = {}, firebase = {} } = snapshot;
      const userData = platformState?.userData || {};
      const metas = platformState?.metasState || [];
      const posts = platformState?.postsState || [];
      const notes = platformState?.notesState || [];
      const refs = platformState?.refSocialState || [];
      const accesses = Array.isArray(userData?.accesses) ? userData.accesses : [];
      const calendarNotes = platformState?.calendarNotesState || {};
      const cacData = userData?.cac || firebase?.userDoc?.cac;
      const macroNotes = Object.keys(userData).filter(k=>/^nota-\d+$/.test(k));
      const macroHist = Object.keys(userData).filter(k=>/^hist-\d+$/.test(k));
      const widgetsCount = Array.isArray(platformState?.widgetsState) ? platformState.widgetsState.length : 0;
      const lines = [];
      lines.push([
        'Macro ‚Üí',
        `  ‚Ä¢ Campos de avalia√ß√£o: notas em userData['nota-{i}'] e observa√ß√µes em userData['obs-{i}'] (${macroNotes.length} cart√µes preenchidos).`,
        `  ‚Ä¢ Hist√≥rico mensal: arrays em userData['hist-{i}'] (${macroHist.length} s√©ries).`,
        `  ‚Ä¢ Widgets conectados: ${widgetsCount}. Dados complementares tamb√©m aparecem em firebase.clientDoc.`
      ].join('\n'));
      lines.push([
        'Metas ‚Üí',
        `  ‚Ä¢ Utilize platformState.metasState (campos meses[AAAA-MM].p para planejado e meses[AAAA-MM].r para realizado).`,
        `  ‚Ä¢ Resumo: ${summarizeMetasForGuide(metas)}`
      ].join('\n'));
      lines.push([
        'CAC ‚Üí',
        `  ‚Ä¢ Dados consolidados em userData.cac (e replicados em firebase.userDoc.cac). ${summarizeCAC(cacData)}`,
        '  ‚Ä¢ Avise quando um m√™s n√£o tiver entradas e oriente o usu√°rio a preencher a planilha.'
      ].join('\n'));
      lines.push([
        'Refer√™ncia de Redes ‚Üí',
        `  ‚Ä¢ Materiais em platformState.refSocialState com campos category/details/url. ${summarizeRefSocial(refs)}`
      ].join('\n'));
      lines.push([
        'Estrat√©gias ‚Üí',
        `  ‚Ä¢ Notas estrat√©gicas no array platformState.notesState (t√≠tulo, setor, conte√∫do rich text). ${summarizeNotes(notes)}`
      ].join('\n'));
      lines.push([
        'Calend√°rio / Posts ‚Üí',
        `  ‚Ä¢ Posts em platformState.postsState com dateISO, status, m√≠dia e legendas. ${summarizePosts(posts)}`,
        `  ‚Ä¢ Observa√ß√µes de calend√°rio em platformState.calendarNotesState. ${summarizeCalendarNotes(calendarNotes)}`
      ].join('\n'));
      lines.push([
        'Demandas ‚Üí',
        `  ‚Ä¢ Demandas cadastradas em platformState.demandasState com status, respons√°veis e prazos. ${summarizeDemandas(platformState?.demandasState)}`
      ].join('\n'));
      lines.push([
        'Acessos ‚Üí',
        `  ‚Ä¢ Lista em userData.accesses com campos name, url, user, pass e tags. ${summarizeAccesses(accesses)}`
      ].join('\n'));
      lines.push([
        'Concorrentes ‚Üí',
        `  ‚Ä¢ Informa√ß√µes armazenadas no documento do cliente (firebase.clientDoc.competitors) e em userData.competitors. ${summarizeCompetitors(snapshot)}`
      ].join('\n'));
      return lines.join('\n\n');
    }
    
    // Fun√ß√£o para extrair todas as anota√ß√µes da aba Estrutura√ß√£o
    function buildEstruturacaoNotesText(){
      console.log('üìã buildEstruturacaoNotesText - Iniciando extra√ß√£o...');
      console.log('üìã ESTRUTURACAO_STATE dispon√≠vel:', !!ESTRUTURACAO_STATE);
      
      if(!ESTRUTURACAO_STATE || typeof ESTRUTURACAO_STATE !== 'object'){
        console.warn('‚ö†Ô∏è ESTRUTURACAO_STATE n√£o dispon√≠vel');
        return '';
      }
      
      // Log das keys dispon√≠veis
      console.log('üìã Keys em ESTRUTURACAO_STATE:', Object.keys(ESTRUTURACAO_STATE));
      
      const lines = [];
      
      // ADICIONAR INFORMA√á√ïES DO NEG√ìCIO PRIMEIRO (PRIORIDADE M√ÅXIMA)
      if(ESTRUTURACAO_STATE.businessInfo && typeof ESTRUTURACAO_STATE.businessInfo === 'object'){
        const info = ESTRUTURACAO_STATE.businessInfo;
        console.log('üè¢ Informa√ß√µes do Neg√≥cio encontradas:', Object.keys(info));
        const businessDetails = [];
        
        if(info.name && info.name.trim()) businessDetails.push(`**Nome da Empresa:** ${info.name.trim()}`);
        if(info.niche && info.niche.trim()) businessDetails.push(`**Nicho/Segmento:** ${info.niche.trim()}`);
        if(info.location && info.location.trim()) businessDetails.push(`**Localiza√ß√£o:** ${info.location.trim()}`);
        if(info.country && info.country.trim()) businessDetails.push(`**Pa√≠s:** ${info.country.trim()}`);
        if(info.time && info.time.trim()) businessDetails.push(`**Tempo no Mercado:** ${info.time.trim()}`);
        if(info.budget && info.budget.trim()) businessDetails.push(`**Investimento em Marketing:** ${info.budget.trim()}`);
        if(info.agencyFee && info.agencyFee.trim()) businessDetails.push(`**Taxa de Ag√™ncia:** ${info.agencyFee.trim()}`);
        if(info.ticket && info.ticket.trim()) businessDetails.push(`**Ticket M√©dio:** ${info.ticket.trim()}`);
        if(info.observations && info.observations.trim()) businessDetails.push(`**Observa√ß√µes Importantes:** ${info.observations.trim()}`);
        
        if(businessDetails.length > 0){
          lines.push(`\nüè¢ === INFORMA√á√ïES DO NEG√ìCIO (CONTEXTO FUNDAMENTAL) ===\n${businessDetails.join('\n')}`);
        }
      }
      
      // Mapear os dados da estrutura√ß√£o para obter os t√≠tulos corretos
      const getWeekInfo = (weekId) => {
        if(typeof ESTRUTURACAO_DATA !== 'undefined' && Array.isArray(ESTRUTURACAO_DATA)){
          const week = ESTRUTURACAO_DATA.find(w => w.id === weekId);
          if(week) return { title: week.title, subtitle: week.subtitle, description: week.description };
        }
        return { title: weekId, subtitle: '', description: '' };
      };
      
      const getBlockInfo = (weekId, blockId) => {
        if(typeof ESTRUTURACAO_DATA !== 'undefined' && Array.isArray(ESTRUTURACAO_DATA)){
          const week = ESTRUTURACAO_DATA.find(w => w.id === weekId);
          if(week && week.blocks){
            const block = week.blocks.find(b => b.id === blockId);
            if(block) return { title: block.title, items: block.items };
          }
        }
        return { title: blockId, items: [] };
      };
      
      // Iterar sobre cada semana no estado
      Object.keys(ESTRUTURACAO_STATE).forEach(weekId => {
        if(weekId === 'businessInfo') return; // J√° processamos acima
        
        const weekState = ESTRUTURACAO_STATE[weekId];
        if(!weekState || typeof weekState !== 'object') return;
        
        const weekInfo = getWeekInfo(weekId);
        const weekTitle = weekInfo.subtitle ? `${weekInfo.title}: ${weekInfo.subtitle}` : weekInfo.title;
        const weekDesc = weekInfo.description ? `\nüìã Objetivo: ${weekInfo.description}` : '';
        let weekContent = [];
        
        // Notas da semana inteira
        if(weekState.weekData?.note && weekState.weekData.note.trim()){
          weekContent.push(`üìù Notas Estrat√©gicas da Semana:\n${weekState.weekData.note.trim()}`);
        }
        
        // Checklist da semana
        if(weekState.weekData?.checklist && Array.isArray(weekState.weekData.checklist) && weekState.weekData.checklist.length > 0){
          const checkItems = weekState.weekData.checklist.map(item => 
            `  ${item.completed ? '‚úÖ' : '‚¨ú'} ${item.text}`
          ).join('\n');
          weekContent.push(`‚úÖ Checklist da Semana:\n${checkItems}`);
        }
        
        // Iterar sobre blocos
        if(weekState.blocks && typeof weekState.blocks === 'object'){
          Object.keys(weekState.blocks).forEach(blockId => {
            const blockState = weekState.blocks[blockId];
            if(!blockState || typeof blockState !== 'object') return;
            
            const blockInfo = getBlockInfo(weekId, blockId);
            const blockTitle = blockInfo.title;
            const blockItems = blockInfo.items || [];
            
            // Notas do bloco
            if(blockState.notes && blockState.notes.trim()){
              weekContent.push(`\nüì¶ **${blockTitle}**:\n${blockState.notes.trim()}`);
            }
            
            // Iterar sobre itens do bloco
            if(blockState.items && typeof blockState.items === 'object'){
              Object.keys(blockState.items).forEach(itemIdx => {
                const itemState = blockState.items[itemIdx];
                if(!itemState || typeof itemState !== 'object') return;
                
                // Pegar o nome do item da estrutura de dados
                const itemName = blockItems[parseInt(itemIdx)] || `Item ${parseInt(itemIdx) + 1}`;
                
                // Notas do item
                if(itemState.note && itemState.note.trim()){
                  const status = itemState.completed ? '‚úÖ' : '‚¨ú';
                  weekContent.push(`\n  ${status} **${itemName}**:\n    ${itemState.note.trim()}`);
                }
              });
            }
          });
        }
        
        // Se h√° conte√∫do nesta semana, adicionar √†s linhas
        if(weekContent.length > 0){
          lines.push(`\n\nüìÖ === ${weekTitle} ===${weekDesc}\n${weekContent.join('\n')}`);
        }
      });
      
      if(lines.length === 0){
        return '';
      }
      
      return `üéØ ANOTA√á√ïES COMPLETAS DA ABA ESTRUTURA√á√ÉO (Marketing e Vendas)\n${lines.join('\n')}`;
    }
    
    // Fun√ß√£o para extrair TODAS as an√°lises geradas na aba Estrutura√ß√£o
    function buildEstruturacaoAnalysesText(){
      console.log('üî¨ buildEstruturacaoAnalysesText - Iniciando extra√ß√£o de an√°lises...');
      console.log('üî¨ USER_DATA dispon√≠vel:', !!USER_DATA);
      console.log('üî¨ USER_DATA.analises dispon√≠vel:', !!(USER_DATA?.analises));
      console.log('üî¨ Total an√°lises em USER_DATA.analises:', Object.keys(USER_DATA?.analises || {}).length);
      
      if(!USER_DATA || typeof USER_DATA !== 'object'){
        console.warn('‚ö†Ô∏è USER_DATA n√£o dispon√≠vel para extrair an√°lises');
        return '';
      }
      
      const analyses = [];
      
      // 1. AN√ÅLISES SALVAS (estrutura principal em USER_DATA.analises)
      if(USER_DATA.analises && typeof USER_DATA.analises === 'object'){
        console.log('üìä Processando an√°lises salvas:', Object.keys(USER_DATA.analises));
        Object.keys(USER_DATA.analises).forEach(entregavelId => {
          const analise = USER_DATA.analises[entregavelId];
          if(!analise) return;
          
          // Extrair nome leg√≠vel do entreg√°vel
          const nomeLegivel = entregavelId
            .replace(/_/g, ' ')
            .replace(/semana(\d)/gi, 'Semana $1')
            .split(' ')
            .map(w => w.charAt(0).toUpperCase() + w.slice(1))
            .join(' ');
          
          const partes = [`\nüìä **AN√ÅLISE: ${nomeLegivel}**`];
          
          // Extrair conte√∫do da an√°lise
          if(typeof analise === 'string' && analise.trim()){
            partes.push(analise.trim());
          } else if(typeof analise === 'object'){
            // Campo principal: insightHtml (como salvo no Firebase)
            if(analise.insightHtml && typeof analise.insightHtml === 'string'){
              // Remover tags HTML para ficar mais limpo para I.A
              const textoLimpo = analise.insightHtml
                .replace(/<[^>]+>/g, ' ')
                .replace(/&nbsp;/g, ' ')
                .replace(/&amp;/g, '&')
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/\s+/g, ' ')
                .trim();
              partes.push(textoLimpo);
            }
            // Fallbacks para outros formatos
            if(analise.content && typeof analise.content === 'string'){
              partes.push(analise.content.trim());
            }
            if(analise.resultado && typeof analise.resultado === 'string'){
              partes.push(analise.resultado.trim());
            }
            if(analise.analise && typeof analise.analise === 'string'){
              partes.push(analise.analise.trim());
            }
            if(analise.texto && typeof analise.texto === 'string'){
              partes.push(analise.texto.trim());
            }
            
            // Extrair blocos/se√ß√µes se existirem
            if(analise.blocos && typeof analise.blocos === 'object'){
              Object.keys(analise.blocos).forEach(blocoKey => {
                const bloco = analise.blocos[blocoKey];
                if(typeof bloco === 'string' && bloco.trim()){
                  partes.push(`\n  üì¶ ${blocoKey}:\n  ${bloco.trim()}`);
                } else if(typeof bloco === 'object' && bloco.content){
                  partes.push(`\n  üì¶ ${blocoKey}:\n  ${bloco.content}`);
                }
              });
            }
            
            // Extrair planilhas/tabelas se existirem
            if(analise.planilha || analise.tabela || analise.spreadsheet){
              const planilhaData = analise.planilha || analise.tabela || analise.spreadsheet;
              if(typeof planilhaData === 'string'){
                partes.push(`\n  üìã Dados da Planilha:\n  ${planilhaData}`);
              } else if(typeof planilhaData === 'object'){
                partes.push(`\n  üìã Dados da Planilha:\n  ${JSON.stringify(planilhaData, null, 2)}`);
              }
            }
            
            // Se ainda n√£o extra√≠mos nada √∫til, converter todo o objeto
            if(partes.length === 1){
              const keys = Object.keys(analise).filter(k => !['id', 'createdAt', 'updatedAt', 'userId'].includes(k));
              keys.forEach(key => {
                const val = analise[key];
                if(typeof val === 'string' && val.trim()){
                  partes.push(`\n  ${key}: ${val.trim()}`);
                } else if(typeof val === 'object' && val !== null){
                  partes.push(`\n  ${key}: ${JSON.stringify(val)}`);
                }
              });
            }
          }
          
          if(partes.length > 1){
            analyses.push(partes.join('\n'));
          }
        });
      }
      
      // 2. AN√ÅLISES AVULSAS (campos que contenham "analise" ou "analysis" no nome)
      Object.keys(USER_DATA).forEach(key => {
        if(key === 'analises') return; // J√° processamos acima
        if(key.toLowerCase().includes('analise') || key.toLowerCase().includes('analysis')){
          const value = USER_DATA[key];
          if(value && typeof value === 'string' && value.trim()){
            analyses.push(`üìù ${key}:\n${value.trim()}`);
          } else if(value && typeof value === 'object' && !Array.isArray(value)){
            const texto = JSON.stringify(value, null, 2);
            if(texto.length < 10000){ // Evitar textos muito grandes
              analyses.push(`üìù ${key}:\n${texto}`);
            }
          }
        }
      });
      
      // 3. ESTRUTURA√á√ÉO STATE - an√°lises dentro das semanas/blocos
      if(ESTRUTURACAO_STATE && typeof ESTRUTURACAO_STATE === 'object'){
        Object.keys(ESTRUTURACAO_STATE).forEach(weekId => {
          if(weekId === 'businessInfo') return;
          const weekState = ESTRUTURACAO_STATE[weekId];
          if(!weekState || typeof weekState !== 'object') return;
          
          // Procurar an√°lises dentro dos blocos
          if(weekState.blocks && typeof weekState.blocks === 'object'){
            Object.keys(weekState.blocks).forEach(blockId => {
              const blockState = weekState.blocks[blockId];
              if(!blockState) return;
              
              // Verificar se h√° an√°lise salva no bloco
              if(blockState.analise && typeof blockState.analise === 'string' && blockState.analise.trim()){
                analyses.push(`üìä An√°lise ${weekId} - ${blockId}:\n${blockState.analise.trim()}`);
              }
              if(blockState.analysis && typeof blockState.analysis === 'string' && blockState.analysis.trim()){
                analyses.push(`üìä An√°lise ${weekId} - ${blockId}:\n${blockState.analysis.trim()}`);
              }
              if(blockState.resultado && typeof blockState.resultado === 'string' && blockState.resultado.trim()){
                analyses.push(`üìä Resultado ${weekId} - ${blockId}:\n${blockState.resultado.trim()}`);
              }
            });
          }
        });
      }
      
      if(analyses.length === 0){
        return '';
      }
      
      console.log(`üìä [I.A] Carregadas ${analyses.length} an√°lises da Estrutura√ß√£o`);
      return `üî¨ AN√ÅLISES GERADAS E SALVAS NA ABA ESTRUTURA√á√ÉO:\n${analyses.join('\n\n---\n')}`;
    }
    
    // Fun√ß√£o para extrair an√°lises espec√≠ficas por tipo de entreg√°vel
    function buildSpecificAnalysisText(analysisType){
      console.log(`üéØ buildSpecificAnalysisText CHAMADA com tipo: "${analysisType}"`);
      console.log('   USER_DATA:', USER_DATA);
      console.log('   USER_DATA?.analises:', USER_DATA?.analises);
      
      if(!USER_DATA?.analises) {
        console.log('‚ùå buildSpecificAnalysisText: USER_DATA.analises n√£o existe');
        return '';
      }
      
      // Mapeamento EXATO dos IDs da UI para as chaves do Firebase
      const typeMap = {
        'diagnostico': 'diagnostico_estrategico',
        'direcionamento': 'direcionamento_metas',
        'concorrencia': 'analise_concorrencia',
        'cdt': 'matriz_cdt',
        'puv': 'puv',
        'pai': 'pai',
        'anuncios': 'anuncios_pagos',
        'seo': 'site_seo',
        'redes': 'redes_sociais',
        'copy': 'copywriting',
        'conteudo': 'producao_conteudo',
        'criativos': 'criativos_anuncios',
        'crm': 'crm_automacoes',
        'comercial': 'processo_comercial',
        'lp': 'landing_pages',
        'website': 'website',
        'visual': 'padronizacao_visual',
        'plataforma': 'plataforma_mediagrowth'
      };
      
      const firebaseKey = typeMap[analysisType];
      if(!firebaseKey) {
        console.log(`‚ùå buildSpecificAnalysisText: tipo "${analysisType}" n√£o encontrado no typeMap`);
        return '';
      }
      
      console.log(`üîç Procurando por "${firebaseKey}" em USER_DATA.analises`);
      console.log('üìä Chaves dispon√≠veis:', Object.keys(USER_DATA.analises));
      
      const found = [];
      
      // Busca EXATA pela chave do Firebase
      if(USER_DATA.analises[firebaseKey]){
        const analise = USER_DATA.analises[firebaseKey];
        console.log(`‚úÖ Encontrou "${firebaseKey}":`, analise);
        
        const nomeLegivel = firebaseKey
          .replace(/_/g, ' ')
          .split(' ')
          .map(w => w.charAt(0).toUpperCase() + w.slice(1))
          .join(' ');
        
        const partes = [`üìä **${nomeLegivel}**`];
        
        if(typeof analise === 'string'){
          partes.push(analise.trim());
        } else if(typeof analise === 'object'){
          // O campo principal √© insightHtml (como salvo no Firebase)
          if(analise.insightHtml) {
            // Remover tags HTML para ficar mais limpo para I.A
            const textoLimpo = analise.insightHtml
              .replace(/<[^>]+>/g, ' ')
              .replace(/&nbsp;/g, ' ')
              .replace(/&amp;/g, '&')
              .replace(/&lt;/g, '<')
              .replace(/&gt;/g, '>')
              .replace(/\s+/g, ' ')
              .trim();
            partes.push(textoLimpo);
          }
          // Fallbacks para outros formatos
          if(analise.content) partes.push(analise.content);
          if(analise.resultado) partes.push(analise.resultado);
          if(analise.analise) partes.push(analise.analise);
          if(analise.texto) partes.push(analise.texto);
          
          if(analise.blocos){
            Object.keys(analise.blocos).forEach(blocoKey => {
              const bloco = analise.blocos[blocoKey];
              if(typeof bloco === 'string'){
                partes.push(`\nüì¶ ${blocoKey}:\n${bloco}`);
              } else if(bloco?.content){
                partes.push(`\nüì¶ ${blocoKey}:\n${bloco.content}`);
              }
            });
          }
          
          if(analise.planilha || analise.tabela){
            const planilhaData = analise.planilha || analise.tabela;
            if(typeof planilhaData === 'string'){
              partes.push(`\nüìã Planilha:\n${planilhaData}`);
            } else {
              partes.push(`\nüìã Planilha:\n${JSON.stringify(planilhaData, null, 2)}`);
            }
          }
        }
        
        if(partes.length > 1){
          found.push(partes.join('\n\n'));
        }
      } else {
        console.log(`‚ùå Chave "${firebaseKey}" N√ÉO encontrada em USER_DATA.analises`);
      }
      
      if(!found.length) {
        console.log(`‚ùå Nenhum conte√∫do encontrado para "${analysisType}"`);
        return '';
      }
      
      console.log(`‚úÖ Retornando ${found.length} an√°lise(s) para "${analysisType}"`);
      return `üî¨ AN√ÅLISE ESPEC√çFICA (${firebaseKey}):\n\n${found.join('\n\n---\n\n')}`;
    }
    
    // Fun√ß√µes para extrair dados de outras abas
    function buildMetasDetail(metasState){
      if(!Array.isArray(metasState) || !metasState.length){
        return '';
      }
      const metasTexto = metasState.map(meta => {
        const desc = meta?.description || 'Meta sem nome';
        const modo = meta?.mode || 'mensal';
        const unidade = meta?.unit || '';
        const meses = meta?.meses || {};
        const monthKeys = Object.keys(meses).sort();
        if(!monthKeys.length){
          return `üìä ${desc} (${modo} ‚Ä¢ ${unidade || 'sem unidade'}) - Nenhum dado preenchido`;
        }
        const monthPieces = monthKeys.map(month => {
          const vals = meses[month];
          const planejado = vals?.p ?? '';
          const realizado = vals?.r ?? '';
          const partes = [];
          if(planejado !== '' && planejado !== null){ partes.push(`meta ${planejado}`); }
          if(realizado !== '' && realizado !== null){ partes.push(`realizado ${realizado}`); }
          if(!partes.length) partes.push('sem dados');
          return `${formatMonthLabel(month)}: ${partes.join(' / ')}`;
        });
        return `üìä ${desc} (${modo} ‚Ä¢ ${unidade || 'sem unidade'})\n   ${monthPieces.join('\n   ')}`;
      }).join('\n\n');
      return `üéØ DADOS DA ABA METAS:\n\n${metasTexto}`;
    }
    
    function buildCACDetail(){
      if(!CAC_DATA || typeof CAC_DATA !== 'object'){
        return '';
      }
      const currency = CAC_DATA?.currency || 'BRL';
      const expenses = CAC_DATA?.expenses || {};
      const sales = CAC_DATA?.sales || {};
      const revenue = CAC_DATA?.revenue || {};
      const monthKeys = Array.from(new Set([
        ...Object.keys(expenses),
        ...Object.keys(sales),
        ...Object.keys(revenue)
      ])).sort();
      
      if(!monthKeys.length){
        return '';
      }
      
      const monthDetails = monthKeys.map(monthKey => {
        const monthExpenses = Array.isArray(expenses[monthKey]) ? expenses[monthKey] : [];
        const totalExpense = monthExpenses.reduce((sum, exp) => sum + (Number(exp?.value) || 0), 0);
        const monthSales = Number(sales[monthKey]) || 0;
        const monthRevenue = Number(revenue[monthKey]) || 0;
        const cac = monthSales > 0 ? (totalExpense / monthSales).toFixed(2) : 'N/A';
        
        const expensesList = monthExpenses.length > 0 
          ? monthExpenses.map(exp => `${exp?.name || 'Sem nome'}: ${currency} ${Number(exp?.value || 0).toFixed(2)}`).join(', ')
          : 'Nenhuma despesa';
        
        return `${formatMonthLabel(monthKey)}:\n   Investimento: ${currency} ${totalExpense.toFixed(2)} (${expensesList})\n   Vendas: ${monthSales}\n   Faturamento: ${currency} ${monthRevenue.toFixed(2)}\n   CAC: ${cac}`;
      }).join('\n\n');
      
      return `üí∞ DADOS DA ABA CAC (Custo de Aquisi√ß√£o de Cliente):\n\n${monthDetails}`;
    }
    
    function buildAnotacoesDetail(notesState){
      if(!Array.isArray(notesState) || !notesState.length){
        return '';
      }
      const notesText = notesState.map((note, idx) => {
        const title = note?.title || `Anota√ß√£o ${idx + 1}`;
        const content = note?.note || note?.content || '';
        const ts = note?.ts ? new Date(note.ts).toLocaleString('pt-BR') : '';
        return `üìù ${title}${ts ? ` (${ts})` : ''}:\n${content}`;
      }).join('\n\n');
      return `üìù ANOTA√á√ïES DA PLATAFORMA:\n\n${notesText}`;
    }
    
    function buildAcessosDetail(firebase){
      if(!firebase || typeof firebase !== 'object'){
        return '';
      }
      const accesses = firebase?.accesses || [];
      if(!Array.isArray(accesses) || !accesses.length){
        return '';
      }
      const accessText = accesses.map(acc => {
        const title = acc?.title || 'Sem t√≠tulo';
        const login = acc?.login || acc?.email || acc?.username || '';
        const password = acc?.password ? '***' : '';
        const url = acc?.url || '';
        const tag = acc?.tag || '';
        const obs = acc?.obs || acc?.notes || '';
        const parts = [`üîë ${title}`];
        if(tag) parts.push(`Tag: ${tag}`);
        if(login) parts.push(`Login: ${login}`);
        if(password) parts.push(`Senha: ${password}`);
        if(url) parts.push(`URL: ${url}`);
        if(obs) parts.push(`Obs: ${obs}`);
        return parts.join('\n   ');
      }).join('\n\n');
      return `üîë ACESSOS E CREDENCIAIS:\n\n${accessText}`;
    }
    
    function buildMacroDetail(firebase){
      if(!firebase || typeof firebase !== 'object'){
        return '';
      }
      const macro = firebase?.macro || {};
      const monthKeys = Object.keys(macro).sort();
      if(!monthKeys.length){
        return '';
      }
      const macroText = monthKeys.map(monthKey => {
        const data = macro[monthKey];
        if(!data || typeof data !== 'object') return '';
        const resume = data?.resume || '';
        const positive = data?.positive || '';
        const negative = data?.negative || '';
        const learning = data?.learning || '';
        const parts = [`üîé ${formatMonthLabel(monthKey)}:`];
        if(resume) parts.push(`Resumo: ${resume}`);
        if(positive) parts.push(`Pontos Positivos: ${positive}`);
        if(negative) parts.push(`Pontos Negativos: ${negative}`);
        if(learning) parts.push(`Aprendizados: ${learning}`);
        return parts.join('\n   ');
      }).filter(Boolean).join('\n\n');
      return macroText ? `üîé AN√ÅLISES MACRO (Mensal):\n\n${macroText}` : '';
    }
    
    function buildPlanejamentoDetail(firebase){
      if(!firebase || typeof firebase !== 'object'){
        return '';
      }
      const planejamento = firebase?.planejamento || firebase?.planning || {};
      if(!planejamento || typeof planejamento !== 'object' || Object.keys(planejamento).length === 0){
        return '';
      }
      const planText = Object.entries(planejamento).map(([key, value]) => {
        if(typeof value === 'string' && value.trim()){
          return `üìã ${key}:\n${value.trim()}`;
        } else if(value && typeof value === 'object'){
          return `üìã ${key}:\n${JSON.stringify(value, null, 2)}`;
        }
        return '';
      }).filter(Boolean).join('\n\n');
      return planText ? `üìã PLANEJAMENTO ESTRAT√âGICO:\n\n${planText}` : '';
    }
    
    function buildArquivosDetail(firebase){
      if(!firebase || typeof firebase !== 'object'){
        return '';
      }
      const fileStructure = firebase?.fileStructure;
      if(!fileStructure || typeof fileStructure !== 'object'){
        return '';
      }
      let fileCount = 0;
      let folderCount = 0;
      const countFiles = (node) => {
        if(!node || typeof node !== 'object') return;
        if(node.type === 'file') fileCount++;
        if(node.type === 'folder') folderCount++;
        if(Array.isArray(node.children)){
          node.children.forEach(countFiles);
        }
      };
      countFiles(fileStructure);
      return fileCount > 0 || folderCount > 0 
        ? `üìÅ ESTRUTURA DE ARQUIVOS:\nTotal de ${folderCount} pasta(s) e ${fileCount} arquivo(s) organizados.`
        : '';
    }
    
    async function buildIAContextMessages(){
      // Verificar quais fontes est√£o selecionadas
      const searchAll = IA_SELECTED_SOURCES.includes('all');
      const shouldInclude = (source) => searchAll || IA_SELECTED_SOURCES.includes(source);
      
      // Log para debug
      console.log('üîç buildIAContextMessages - IA_SELECTED_SOURCES:', IA_SELECTED_SOURCES);
      console.log('üîç searchAll:', searchAll);
      
      // Se Estrutura√ß√£o ou qualquer an√°lise espec√≠fica est√° selecionada, garantir que as an√°lises estejam carregadas
      const needsAnalises = shouldInclude('estruturacao') || 
                           shouldInclude('analise-todos') ||
                           shouldInclude('diagnostico') ||
                           shouldInclude('direcionamento') ||
                           shouldInclude('concorrencia') ||
                           shouldInclude('cdt') ||
                           shouldInclude('puv') ||
                           shouldInclude('pai') ||
                           shouldInclude('anuncios') ||
                           shouldInclude('seo') ||
                           shouldInclude('redes') ||
                           shouldInclude('copy') ||
                           shouldInclude('conteudo') ||
                           shouldInclude('criativos') ||
                           shouldInclude('crm') ||
                           shouldInclude('comercial') ||
                           shouldInclude('lp') ||
                           shouldInclude('website') ||
                           shouldInclude('visual');
                           
      if(needsAnalises){
        console.log('üìä Estrutura√ß√£o/An√°lises selecionadas - Verificando an√°lises...');
        const targetUid = USER_DATA?.uid || window.currentClientId || auth?.currentUser?.uid;
        if(targetUid && typeof carregarTodasAnalisesFirebase === 'function'){
          try {
            // For√ßar reload das an√°lises para garantir dados atualizados
            await carregarTodasAnalisesFirebase(targetUid);
            console.log('‚úÖ An√°lises carregadas/atualizadas para I.A');
            console.log('üìä Total de an√°lises dispon√≠veis:', Object.keys(USER_DATA?.analises || {}).length);
            console.log('üìä Chaves das an√°lises:', Object.keys(USER_DATA?.analises || {}));
            // Mostrar um preview de cada an√°lise
            if(USER_DATA?.analises){
              Object.keys(USER_DATA.analises).forEach(key => {
                const a = USER_DATA.analises[key];
                console.log(`   üîπ ${key}:`, {
                  temInsightHtml: !!a?.insightHtml,
                  tamanhoInsightHtml: (a?.insightHtml || '').length,
                  campos: Object.keys(a || {})
                });
              });
            }
          } catch(err) {
            console.warn('‚ö†Ô∏è Erro ao carregar an√°lises:', err);
          }
        } else {
          console.log('‚ö†Ô∏è N√£o foi poss√≠vel carregar an√°lises:', {
            targetUid: !!targetUid,
            temFuncao: typeof carregarTodasAnalisesFirebase === 'function'
          });
        }
      }
      
      let contextData;
      try{
        contextData = await fetchClientDataSnapshot(true);
      }catch(err){
        console.warn('buildIAContextMessages fetch', err);
        contextData = {
          fetchedAt: new Date().toISOString(),
          error: 'Falha ao coletar dados do Firebase automaticamente.'
        };
      }
      
      // üéØ OTIMIZA√á√ÉO: Usar limites individuais por aba + compress√£o
      // REMOVIDO: platformSnippet e platformTextSnippet - Economia de ~7.500 tokens!
      // C√≥digo da plataforma N√ÉO √â NECESS√ÅRIO para responder perguntas do usu√°rio
      const platformSnippet = ''; // Desativado para economia
      const platformTextSnippet = ''; // Desativado para economia
      
      // N√£o incluir snapshot completo quando busca √© focada (ECONOMIA SIGNIFICATIVA)
      // Reduzido de 20000 para 10000 chars
      const contextJson = searchAll ? compressContextText(safeStringify(contextData), 10000) : '';
      const tabGuide = ''; // REMOVIDO - Economia de ~5k tokens (IA j√° sabe navegar)
      
      // Extrair dados espec√≠ficos por aba COM LIMITES INDIVIDUAIS
      const postsDetail = (shouldInclude('posts') || shouldInclude('calendario')) 
        ? compressContextText(buildPostsText(contextData?.platformState?.postsState), IA_LIMITS.posts) 
        : '';
      const calendarNotesDetail = shouldInclude('calendario') 
        ? compressContextText(buildCalendarNotesDetail(contextData?.platformState?.calendarNotesState), IA_LIMITS.calendario) 
        : '';
      const demandasDetail = shouldInclude('demandas') 
        ? compressContextText(buildDemandasText(contextData?.platformState?.demandasState), IA_LIMITS.demandas) 
        : '';
      const iframeDetail = shouldInclude('arquivos') 
        ? compressContextText(buildIframeText(contextData?.firebase?.iframes), IA_LIMITS.iframes) 
        : '';
      
      // Anota√ß√µes da aba Estrutura√ß√£o COM LIMITE ESPEC√çFICO
      const estruturacaoNotes = shouldInclude('estruturacao') 
        ? compressContextText(buildEstruturacaoNotesText(), IA_LIMITS.estruturacaoNotes) 
        : '';
      
      // An√°lises espec√≠ficas ou todas - COM SUMARIZA√á√ÉO INTELIGENTE
      let estruturacaoAnalyses = '';
      
      // DEBUG: Verificar estado antes de buscar an√°lises
      if(shouldInclude('diagnostico') || shouldInclude('direcionamento') || shouldInclude('concorrencia') ||
         shouldInclude('cdt') || shouldInclude('puv') || shouldInclude('pai') ||
         shouldInclude('anuncios') || shouldInclude('seo') || shouldInclude('redes') ||
         shouldInclude('copy') || shouldInclude('conteudo') || shouldInclude('criativos') ||
         shouldInclude('crm') || shouldInclude('comercial') || shouldInclude('lp') ||
         shouldInclude('website') || shouldInclude('visual') || shouldInclude('plataforma') || shouldInclude('analise-todos')){
        console.log('üîç ========== DEBUG AN√ÅLISES ==========');
        console.log('USER_DATA existe?', !!USER_DATA);
        console.log('USER_DATA.analises existe?', !!USER_DATA?.analises);
        if(USER_DATA?.analises){
          console.log('Chaves em USER_DATA.analises:', Object.keys(USER_DATA.analises));
          console.log('Total de an√°lises:', Object.keys(USER_DATA.analises).length);
        }
        console.log('window.USER_DATA existe?', !!window.USER_DATA);
        console.log('window.USER_DATA.analises existe?', !!window.USER_DATA?.analises);
        if(window.USER_DATA?.analises){
          console.log('Chaves em window.USER_DATA.analises:', Object.keys(window.USER_DATA.analises));
        }
        console.log('======================================');
      }
      
      // üéØ OTIMIZA√á√ÉO: Usar sumariza√ß√£o inteligente para an√°lises
      const analysisLimit = IA_LIMITS.estruturacaoAnalyses;
      
      if(shouldInclude('analise-todos')){
        estruturacaoAnalyses = summarizeAnalysis(buildEstruturacaoAnalysesText(), analysisLimit);
      } else if(shouldInclude('diagnostico')){
        estruturacaoAnalyses = summarizeAnalysis(buildSpecificAnalysisText('diagnostico'), analysisLimit);
      } else if(shouldInclude('direcionamento')){
        estruturacaoAnalyses = summarizeAnalysis(buildSpecificAnalysisText('direcionamento'), analysisLimit);
      } else if(shouldInclude('concorrencia')){
        estruturacaoAnalyses = summarizeAnalysis(buildSpecificAnalysisText('concorrencia'), analysisLimit);
      } else if(shouldInclude('cdt')){
        estruturacaoAnalyses = summarizeAnalysis(buildSpecificAnalysisText('cdt'), analysisLimit);
      } else if(shouldInclude('puv')){
        estruturacaoAnalyses = summarizeAnalysis(buildSpecificAnalysisText('puv'), analysisLimit);
      } else if(shouldInclude('pai')){
        estruturacaoAnalyses = summarizeAnalysis(buildSpecificAnalysisText('pai'), analysisLimit);
      } else if(shouldInclude('anuncios')){
        estruturacaoAnalyses = summarizeAnalysis(buildSpecificAnalysisText('anuncios'), analysisLimit);
      } else if(shouldInclude('seo')){
        estruturacaoAnalyses = summarizeAnalysis(buildSpecificAnalysisText('seo'), analysisLimit);
      } else if(shouldInclude('redes')){
        estruturacaoAnalyses = summarizeAnalysis(buildSpecificAnalysisText('redes'), analysisLimit);
      } else if(shouldInclude('copy')){
        estruturacaoAnalyses = summarizeAnalysis(buildSpecificAnalysisText('copy'), analysisLimit);
      } else if(shouldInclude('conteudo')){
        estruturacaoAnalyses = summarizeAnalysis(buildSpecificAnalysisText('conteudo'), analysisLimit);
      } else if(shouldInclude('criativos')){
        estruturacaoAnalyses = summarizeAnalysis(buildSpecificAnalysisText('criativos'), analysisLimit);
      } else if(shouldInclude('crm')){
        estruturacaoAnalyses = summarizeAnalysis(buildSpecificAnalysisText('crm'), analysisLimit);
      } else if(shouldInclude('comercial')){
        estruturacaoAnalyses = summarizeAnalysis(buildSpecificAnalysisText('comercial'), analysisLimit);
      } else if(shouldInclude('lp')){
        estruturacaoAnalyses = summarizeAnalysis(buildSpecificAnalysisText('lp'), analysisLimit);
      } else if(shouldInclude('website')){
        estruturacaoAnalyses = summarizeAnalysis(buildSpecificAnalysisText('website'), analysisLimit);
      } else if(shouldInclude('visual')){
        estruturacaoAnalyses = summarizeAnalysis(buildSpecificAnalysisText('visual'), analysisLimit);
      } else if(shouldInclude('plataforma')){
        estruturacaoAnalyses = summarizeAnalysis(buildSpecificAnalysisText('plataforma'), analysisLimit);
      } else if(shouldInclude('estruturacao')){
        // Se "Estrutura√ß√£o (Notas)" estiver selecionado mas nenhuma an√°lise espec√≠fica, carregar todas
        estruturacaoAnalyses = summarizeAnalysis(buildEstruturacaoAnalysesText(), analysisLimit);
      }
      
      // Log detalhado do que ser√° enviado (REDUZIDO para economia de performance)
      if(shouldInclude('estruturacao') || needsAnalises){
        console.log('üìä DADOS ESTRUTURA√á√ÉO:', {
          notas: estruturacaoNotes ? `${estruturacaoNotes.length} chars` : 'vazio',
          analises: estruturacaoAnalyses ? `${estruturacaoAnalyses.length} chars` : 'vazio'
        });
      }
      
      // üéØ OTIMIZA√á√ÉO: Extrair dados das outras abas com limites espec√≠ficos
      const metasDetail = shouldInclude('metas') 
        ? compressContextText(buildMetasDetail(contextData?.platformState?.metasState), IA_LIMITS.metas) 
        : '';
      const cacDetail = shouldInclude('cac') 
        ? compressContextText(buildCACDetail(), IA_LIMITS.cac) 
        : '';
      const anotacoesDetail = shouldInclude('anotacoes') 
        ? compressContextText(buildAnotacoesDetail(contextData?.platformState?.notesState), IA_LIMITS.anotacoes) 
        : '';
      const acessosDetail = shouldInclude('acessos') 
        ? compressContextText(buildAcessosDetail(contextData?.firebase), IA_LIMITS.acessos) 
        : '';
      const macroDetail = shouldInclude('macro') 
        ? compressContextText(buildMacroDetail(contextData?.firebase), IA_LIMITS.macro) 
        : '';
      const planejamentoDetail = shouldInclude('planejamento') 
        ? compressContextText(buildPlanejamentoDetail(contextData?.firebase), IA_LIMITS.planejamento) 
        : '';
      const arquivosDetail = shouldInclude('arquivos') 
        ? compressContextText(buildArquivosDetail(contextData?.firebase), IA_LIMITS.arquivos) 
        : '';
      
      const sources = [];
      
      // üéØ OTIMIZA√á√ÉO: PROMPT DO SISTEMA REDUZIDO (~60% menor)
      const messages = [{
        role: 'system',
        content: `Voc√™ √© o Assistente de Marketing da Mediagrowth.

üéØ PAPEL: Consultor estrat√©gico de marketing digital e vendas.
‚úÖ PODE: Criar estrat√©gias, campanhas, ideias criativas, copies, sugest√µes.
‚ùå N√ÉO PODE: Inventar n√∫meros, m√©tricas ou dados n√£o fornecidos.

üìã PRIORIDADE DE FONTES:
1. ESTRUTURA√á√ÉO: Informa√ß√µes do neg√≥cio, semanas, blocos, an√°lises salvas
2. METAS/CAC: N√∫meros oficiais e objetivos
3. MACRO/CALEND√ÅRIO/DEMANDAS: Dados operacionais
4. DOCUMENTOS: Base de conhecimento do usu√°rio

‚ö†Ô∏è PROTOCOLO:
‚Ä¢ Leia TODO o contexto antes de responder
‚Ä¢ Busque em TODAS as mensagens de sistema (üìä, ÔøΩ, üìã, üî¨)
‚Ä¢ Se n√£o encontrar dados, diga claramente e sugira onde adicionar
‚Ä¢ Cite a fonte quando usar dados: "Segundo a Estrutura√ß√£o..."

üí° ESTILO: Profissional, acion√°vel, use bullets e exemplos pr√°ticos.`
      }];
      
      // Adicionar mensagem sobre fontes selecionadas se n√£o for "all"
      if (!searchAll && IA_SELECTED_SOURCES.length > 0) {
        const sourceNames = {
          'estruturacao': 'Estrutura√ß√£o (Notas)',
          'analise-todos': 'Todos os Entreg√°veis',
          'diagnostico': 'Diagn√≥stico Estrat√©gico Completo',
          'direcionamento': 'Direcionamento Estrat√©gico e Metas',
          'concorrencia': 'An√°lise de Concorr√™ncia e Mercado',
          'cdt': 'Matriz CDT (Construir, Diminuir, Transformar)',
          'puv': 'PUV - Proposta √önica de Valor',
          'pai': 'PAI - P√∫blico Alvo Ideal',
          'anuncios': 'Estrutura√ß√£o de An√∫ncios Pagos',
          'seo': 'Site e Estrat√©gia SEO',
          'redes': 'Gest√£o de Redes Sociais',
          'copy': 'Copywriting Estrat√©gico',
          'conteudo': 'Produ√ß√£o de Conte√∫do Guiada',
          'criativos': 'Criativos de An√∫ncios',
          'crm': 'CRM e Automa√ß√µes',
          'comercial': 'Processo Comercial',
          'lp': 'Landing Pages Estrat√©gicas',
          'website': 'Website Institucional',
          'visual': 'Padroniza√ß√£o Visual e Marca',
          'plataforma': 'Plataforma Mediagrowth',
          'macro': 'Macro',
          'planejamento': 'Planejamento',
          'calendario': 'Calend√°rio',
          'posts': 'Posts',
          'metas': 'Metas',
          'cac': 'CAC',
          'leads': 'Leads',
          'anotacoes': 'Anota√ß√µes',
          'acessos': 'Acessos',
          'arquivos': 'Arquivos',
          'relatorio': 'Relat√≥rio',
          'demandas': 'Demandas'
        };
        const selectedNames = IA_SELECTED_SOURCES.map(s => sourceNames[s] || s).join(', ');
        const focusedMessage = `‚ö†Ô∏è BUSCA FOCADA: O usu√°rio selecionou apenas as seguintes abas para consulta: ${selectedNames}. Utilize APENAS os dados dessas fontes espec√≠ficas. Se a informa√ß√£o n√£o estiver nessas abas, informe que n√£o est√° dispon√≠vel na busca atual e sugira incluir outras abas se necess√°rio.`;
        messages.push({ 
          role: 'system', 
          content: focusedMessage
        });
        console.log('‚úÖ Busca focada ativada:', selectedNames);
      } else {
        console.log('üåê Buscando em todas as abas');
      }
      
      if(platformSnippet){
        messages.push({ role: 'system', content: `C√≥digo da plataforma (trecho):\n${platformSnippet}` });
        sources.push('Trechos do c√≥digo da plataforma');
      }
      if(platformTextSnippet){
        messages.push({ role: 'system', content: `Descri√ß√£o textual da plataforma (trecho):\n${platformTextSnippet}` });
        sources.push('Descri√ß√£o textual da plataforma');
      }
      if(contextJson){
        messages.push({ role: 'system', content: `Dados coletados automaticamente do Firebase e da plataforma:\n${contextJson}` });
        sources.push('Snapshot do Firebase e estados da plataforma');
      }
      if(tabGuide){
        messages.push({ role: 'system', content: `Guia de abas e onde encontrar os dados dentro do contexto:\n${tabGuide}` });
        sources.push('Guia autom√°tico das abas da plataforma');
      }
      if(postsDetail){
        messages.push({ role: 'system', content: `Calend√°rio de posts detalhado:\n${postsDetail}` });
        sources.push('Calend√°rio de posts');
      }
      if(calendarNotesDetail){
        messages.push({ role: 'system', content: `Observa√ß√µes do calend√°rio:\n${calendarNotesDetail}` });
        sources.push('Observa√ß√µes recentes do calend√°rio');
      }
      if(demandasDetail){
        messages.push({ role: 'system', content: `Demandas registradas:\n${demandasDetail}` });
        sources.push('Demandas cadastradas na plataforma');
      }
      if(iframeDetail){
        messages.push({ role: 'system', content: `Conte√∫do dos iframes e widgets HTML do cliente:\n${iframeDetail}` });
        sources.push('Widgets e iframes salvos na plataforma');
      }
      
      // NOVO: Adicionar anota√ß√µes da aba Estrutura√ß√£o
      if(estruturacaoNotes){
        messages.push({ role: 'system', content: estruturacaoNotes });
        sources.push('Anota√ß√µes da aba Estrutura√ß√£o (Marketing e Vendas)');
      }
      
      // NOVO: Adicionar an√°lises geradas
      if(estruturacaoAnalyses){
        messages.push({ role: 'system', content: estruturacaoAnalyses });
        sources.push('An√°lises geradas na plataforma');
      }
      
      // Adicionar dados das outras abas espec√≠ficas
      if(metasDetail){
        messages.push({ role: 'system', content: metasDetail });
        sources.push('Dados da aba Metas');
      }
      
      if(cacDetail){
        messages.push({ role: 'system', content: cacDetail });
        sources.push('Dados da aba CAC (Custos e Investimentos)');
      }
      
      if(macroDetail){
        messages.push({ role: 'system', content: macroDetail });
        sources.push('An√°lises Macro (Mensal)');
      }
      
      if(planejamentoDetail){
        messages.push({ role: 'system', content: planejamentoDetail });
        sources.push('Planejamento Estrat√©gico');
      }
      
      if(anotacoesDetail){
        messages.push({ role: 'system', content: anotacoesDetail });
        sources.push('Anota√ß√µes da plataforma');
      }
      
      if(acessosDetail){
        messages.push({ role: 'system', content: acessosDetail });
        sources.push('Acessos e Credenciais');
      }
      
      if(arquivosDetail){
        messages.push({ role: 'system', content: arquivosDetail });
        sources.push('Estrutura de Arquivos');
      }
      
      if(IA_DOCS.length){
        IA_DOCS.slice(0, 10).forEach(doc=>{
          const text = trimLargeText(doc.text || '', IA_DOC_SNIPPET_CHARS);
          if(!text) return;
          const name = doc.name || doc.originalName || 'Documento sem t√≠tulo';
          messages.push({ role: 'system', content: `Documento de treinamento (${name}):\n${text}` });
          sources.push(`Documento da base IA: ${name}`);
        });
        if(IA_DOCS.length > 10){
          messages.push({ role: 'system', content: `Existem ${IA_DOCS.length - 10} documento(s) adicionais n√£o inclu√≠dos integralmente no contexto.` });
          sources.push(`Documentos adicionais da base IA (${IA_DOCS.length - 10})`);
        }
      }
      return { messages, sources };
    }
    function appendSourcesToResponse(text, sources){
      const base = typeof text === 'string' ? text : '';
      const list = Array.isArray(sources) ? sources.map(s=>String(s||'').trim()).filter(Boolean) : [];
      const unique = Array.from(new Set(list));
      if(CURRENT_CHAT){
        CURRENT_CHAT.lastSources = unique;
      }
      updateIASourceNote(unique);
      return base;
    }
async function sendIAQuestion(){
  console.log('üí¨ [sendIAQuestion] Iniciando envio de mensagem...');
  if(!iaQuestion) return;
  const question = iaQuestion.value.trim();
  if(!question && !IA_CURRENT_IMAGE) return; // Permitir envio s√≥ com imagem
  if(!auth.currentUser){ alert('Fa√ßa login.'); return; }
  if(!CURRENT_CHAT) newIAChat();
  const chat = CURRENT_CHAT;
  console.log(`üí¨ [sendIAQuestion] Chat atual: "${chat.title}" (${chat.messages.length} mensagens antes)`);
  const sendBtn = iaSend;
  if(sendBtn) sendBtn.disabled = true;
  
  // Processar imagem se houver
  let imageData = null;
  if(IA_CURRENT_IMAGE){
    console.log('üñºÔ∏è Processando imagem anexada...');
    try{
      // Converter imagem para base64
      const reader = new FileReader();
      imageData = await new Promise((resolve, reject) => {
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(IA_CURRENT_IMAGE);
      });
      console.log('‚úÖ Imagem convertida para base64');
    }catch(err){
      console.error('‚ùå Erro ao processar imagem:', err);
      alert('Erro ao processar imagem. Tente novamente.');
      if(sendBtn) sendBtn.disabled = false;
      return;
    }
  }
  
  const userMsg = { 
    role:'user', 
    content: question || 'üñºÔ∏è [Imagem anexada]', 
    ts: Date.now(),
    image: imageData // Armazenar base64 da imagem
  };
  chat.messages.push(userMsg);
  console.log(`üí¨ [sendIAQuestion] Mensagem do usu√°rio adicionada (${chat.messages.length} mensagens agora)`);
  if(!chat.title || chat.title === 'Nova conversa'){
    chat.title = deriveTitleFromText(question || 'An√°lise de imagem');
  }
  iaQuestion.value = '';
  autoResizeComposer();
  
  // Limpar preview da imagem
  if(IA_CURRENT_IMAGE){
    IA_CURRENT_IMAGE = null;
    if(iaImagePreviewWrapper) iaImagePreviewWrapper.style.display = 'none';
    if(iaImagePreviewImg) iaImagePreviewImg.src = '';
  }
  
  touchChat(chat);
  renderIAHistory();
  renderIAChatList();
  console.log('üíæ [sendIAQuestion] Salvando ap√≥s adicionar mensagem do usu√°rio...');
  
  try {
    await saveIAChatsToUserData();
  } catch(saveErr) {
    console.warn('‚ö†Ô∏è [sendIAQuestion] Erro ao salvar ap√≥s mensagem do usu√°rio (n√£o cr√≠tico, tentar√° novamente):', saveErr);
  }

  const loadingMsg = { role:'assistant', content:'', ts: Date.now(), loading:true };
  chat.messages.push(loadingMsg);
  console.log(`üí¨ [sendIAQuestion] Mensagem de loading adicionada (${chat.messages.length} mensagens agora)`);
  touchChat(chat);
  renderIAHistory();
  renderIAChatList();
  console.log('üíæ [sendIAQuestion] Salvando ap√≥s adicionar loading...');
  
  try {
    await saveIAChatsToUserData();
  } catch(saveErr) {
    console.warn('‚ö†Ô∏è [sendIAQuestion] Erro ao salvar ap√≥s loading (n√£o cr√≠tico, tentar√° novamente):', saveErr);
  }

  await ensurePlatformCode();
  let contextMessages = [];
  let contextSources = [];
  try{
    const payload = await buildIAContextMessages();
    contextMessages = Array.isArray(payload?.messages) ? payload.messages : [];
    contextSources = Array.isArray(payload?.sources) ? payload.sources : [];
    
    // Log detalhado do que est√° sendo enviado para a I.A
    console.log('üöÄ ========== ENVIANDO PARA I.A ==========');
    console.log('üìä Total de mensagens de contexto:', contextMessages.length);
    console.log('üìã Fontes inclu√≠das:', contextSources);
    
    // Calcular total de caracteres sendo enviados
    let totalChars = 0;
    contextMessages.forEach((msg, idx) => {
      totalChars += msg.content.length;
      if(msg.role === 'system'){
        const preview = msg.content.substring(0, 100).replace(/\n/g, ' ');
        console.log(`   ${idx}. [SYSTEM] ${preview}... (${msg.content.length.toLocaleString()} chars)`);
      }
    });
    console.log(`üìè TOTAL DE CARACTERES NO CONTEXTO: ${totalChars.toLocaleString()}`);
    console.log(`üìè Estimativa de tokens (~4 chars/token): ${Math.ceil(totalChars/4).toLocaleString()}`);
    console.log('üöÄ ========================================');
  }catch(err){
    console.warn('contextMessages', err);
    contextMessages = [{ role:'system', content:'Voc√™ √© o assistente de marketing da Mediagrowth. Use apenas as mensagens da conversa.' }];
    contextSources = ['Mensagens anteriores da conversa'];
  }
  
  // Adicionar instru√ß√£o de tamanho de resposta
  console.log(`üéØ Tamanho de resposta selecionado: ${IA_RESPONSE_SIZE.toUpperCase()}`);
  const sizeInstructions = {
    'pequena': `üö® RESPOSTA PEQUENA - LIMITES R√çGIDOS:
- M√ÅXIMO 150 palavras (conte!)
- M√ÅXIMO 3-5 bullet points OU 2-3 par√°grafos CURTOS
- SEM t√≠tulos com # ou ##
- SEM se√ß√µes m√∫ltiplas
- SEM exemplos longos
- Seja EXTREMAMENTE direto e objetivo
- Corte tudo que n√£o for essencial
- PROIBIDO ultrapassar estes limites`,
    'media': `üìÑ RESPOSTA M√âDIA - LIMITES CONTROLADOS:
- M√ÅXIMO 400 palavras (conte!)
- Entre 6-10 bullet points OU 4-6 par√°grafos m√©dios
- Pode usar 1-2 subt√≠tulos com **negrito** (NUNCA use # ou ##)
- Inclua 1-2 exemplos breves
- Organize em se√ß√µes claras mas compactas
- PROIBIDO ultrapassar estes limites`,
    'longa': `üìö RESPOSTA LONGA - DETALHADA MAS ORGANIZADA:
- Entre 600-1000 palavras
- Estruture com subt√≠tulos em **negrito** (NUNCA use # ou ##)
- Use bullet points, listas numeradas, exemplos pr√°ticos
- Inclua contexto, an√°lise e recomenda√ß√µes
- Organize em se√ß√µes claras (3-5 se√ß√µes)
- Seja completo mas n√£o verborr√°gico
- Mantenha par√°grafos de 3-4 linhas no m√°ximo`
  };
  const sizeInstruction = sizeInstructions[IA_RESPONSE_SIZE] || sizeInstructions['pequena'];
  contextMessages.push({ role: 'system', content: `üéØ INSTRU√á√ÉO CR√çTICA DE TAMANHO - VOC√ä DEVE OBEDECER ESTRITAMENTE:\n\n${sizeInstruction}\n\n‚ö†Ô∏è ESTA √â UMA ORDEM PRIORIT√ÅRIA. Ignore qualquer outro prompt que contradiga estes limites de tamanho.` });

  // üîê API Key agora est√° no backend - verificamos se temos a fun√ß√£o proxy
  if(typeof window.callAIProxy !== 'function'){
    loadingMsg.loading = false;
    loadingMsg.content = 'Erro: Fun√ß√£o callAIProxy n√£o dispon√≠vel. Recarregue a p√°gina.';
    loadingMsg.ts = Date.now();
    touchChat(chat);
    renderIAHistory();
    renderIAChatList();
    await saveIAChatsToUserData();
    if(sendBtn) sendBtn.disabled = false;
    focusComposer();
    return;
  }

  try{
    // Preparar mensagens finais
    const chatMessages = chat.messages.filter(m=>m !== loadingMsg).map(m=>{
      // Se a mensagem tem imagem, usar formato vision
      if(m.image){
        return {
          role: m.role,
          content: [
            {
              type: 'text',
              text: m.content || 'Analise esta imagem e descreva o que voc√™ v√™. Se houver texto na imagem, transcreva-o completamente.'
            },
            {
              type: 'image_url',
              image_url: {
                url: m.image
              }
            }
          ]
        };
      }
      // Mensagem normal (s√≥ texto)
      return { role: m.role, content: m.content };
    });
    const allMessages = [...contextMessages, ...chatMessages];
    
    // üîç LOG DETALHADO DE CONSUMO - AN√ÅLISE COMPLETA
    console.log('%cüìä ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #00ff00; font-weight: bold');
    console.log('%cüìä AN√ÅLISE DETALHADA DE TOKENS - ANTES DO ENVIO', 'color: #00ff00; font-size: 14px; font-weight: bold');
    console.log('%cüìä ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #00ff00; font-weight: bold');
    
    // Breakdown por tipo de mensagem
    const breakdown = {
      systemPrompt: 0,
      estruturacao: 0,
      analises: 0,
      metas: 0,
      cac: 0,
      posts: 0,
      demandas: 0,
      documentos: 0,
      outros: 0,
      chatHistory: 0
    };
    
    contextMessages.forEach((msg, idx) => {
      const chars = msg.content.length;
      const tokens = Math.ceil(chars / 4);
      const content = msg.content.toLowerCase();
      
      // Classificar por tipo
      if (idx === 0 && msg.role === 'system') {
        breakdown.systemPrompt = chars;
        console.log(`  üìù [${idx}] PROMPT SISTEMA: ${chars.toLocaleString()} chars (~${tokens.toLocaleString()} tokens)`);
      } else if (content.includes('estrutura√ß√£o') || content.includes('anota√ß√µes completas')) {
        breakdown.estruturacao += chars;
        console.log(`  üìã [${idx}] ESTRUTURA√á√ÉO: ${chars.toLocaleString()} chars (~${tokens.toLocaleString()} tokens)`);
      } else if (content.includes('an√°lise') || content.includes('analise')) {
        breakdown.analises += chars;
        console.log(`  üî¨ [${idx}] AN√ÅLISES: ${chars.toLocaleString()} chars (~${tokens.toLocaleString()} tokens)`);
      } else if (content.includes('metas')) {
        breakdown.metas += chars;
        console.log(`  üéØ [${idx}] METAS: ${chars.toLocaleString()} chars (~${tokens.toLocaleString()} tokens)`);
      } else if (content.includes('cac') || content.includes('custo')) {
        breakdown.cac += chars;
        console.log(`  üí∞ [${idx}] CAC: ${chars.toLocaleString()} chars (~${tokens.toLocaleString()} tokens)`);
      } else if (content.includes('post') || content.includes('calend√°rio')) {
        breakdown.posts += chars;
        console.log(`  üìÖ [${idx}] POSTS/CALEND√ÅRIO: ${chars.toLocaleString()} chars (~${tokens.toLocaleString()} tokens)`);
      } else if (content.includes('demanda') || content.includes('tarefa')) {
        breakdown.demandas += chars;
        console.log(`  ‚úÖ [${idx}] DEMANDAS: ${chars.toLocaleString()} chars (~${tokens.toLocaleString()} tokens)`);
      } else if (content.includes('documento') || content.includes('treinamento')) {
        breakdown.documentos += chars;
        console.log(`  üìÑ [${idx}] DOCUMENTOS: ${chars.toLocaleString()} chars (~${tokens.toLocaleString()} tokens)`);
      } else {
        breakdown.outros += chars;
        console.log(`  ‚ùì [${idx}] OUTRO: ${chars.toLocaleString()} chars (~${tokens.toLocaleString()} tokens) - "${msg.content.substring(0, 50)}..."`);
      }
    });
    
    // Chat history
    chatMessages.forEach((msg, idx) => {
      const chars = typeof msg.content === 'string' ? msg.content.length : JSON.stringify(msg.content).length;
      breakdown.chatHistory += chars;
    });
    
    // Totais
    const totalContextChars = Object.values(breakdown).reduce((a, b) => a + b, 0) - breakdown.chatHistory;
    const totalChatChars = breakdown.chatHistory;
    const totalChars = totalContextChars + totalChatChars;
    const totalTokensEstimated = Math.ceil(totalChars / 4);
    
    console.log('%cüìä ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'color: #ffaa00');
    console.log('%cÔøΩ RESUMO POR CATEGORIA:', 'color: #ffaa00; font-weight: bold');
    console.log('%cüìä ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'color: #ffaa00');
    
    const categories = [
      { name: 'Prompt Sistema', chars: breakdown.systemPrompt, icon: 'üìù' },
      { name: 'Estrutura√ß√£o', chars: breakdown.estruturacao, icon: 'üìã' },
      { name: 'An√°lises IA', chars: breakdown.analises, icon: 'üî¨' },
      { name: 'Metas', chars: breakdown.metas, icon: 'üéØ' },
      { name: 'CAC', chars: breakdown.cac, icon: 'üí∞' },
      { name: 'Posts/Calend√°rio', chars: breakdown.posts, icon: 'üìÖ' },
      { name: 'Demandas', chars: breakdown.demandas, icon: '‚úÖ' },
      { name: 'Documentos', chars: breakdown.documentos, icon: 'üìÑ' },
      { name: 'Outros', chars: breakdown.outros, icon: '‚ùì' },
      { name: 'Hist√≥rico Chat', chars: breakdown.chatHistory, icon: 'üí¨' }
    ];
    
    categories.sort((a, b) => b.chars - a.chars);
    
    categories.forEach(cat => {
      if (cat.chars > 0) {
        const tokens = Math.ceil(cat.chars / 4);
        const percent = ((cat.chars / totalChars) * 100).toFixed(1);
        const bar = '‚ñà'.repeat(Math.ceil(percent / 5)) + '‚ñë'.repeat(20 - Math.ceil(percent / 5));
        console.log(`  ${cat.icon} ${cat.name.padEnd(18)} ${bar} ${percent.padStart(5)}% | ${cat.chars.toLocaleString().padStart(8)} chars (~${tokens.toLocaleString()} tokens)`);
      }
    });
    
    console.log('%cÔøΩ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'color: #ff6600');
    console.log('%cüìä TOTAIS:', 'color: #ff6600; font-weight: bold');
    console.log('%cüìä ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'color: #ff6600');
    console.log(`  üì¶ Contexto total: ${totalContextChars.toLocaleString()} chars (~${Math.ceil(totalContextChars/4).toLocaleString()} tokens)`);
    console.log(`  üí¨ Chat hist√≥rico: ${totalChatChars.toLocaleString()} chars (~${Math.ceil(totalChatChars/4).toLocaleString()} tokens)`);
    console.log(`  üìè TOTAL ENVIADO: ${totalChars.toLocaleString()} chars (~${totalTokensEstimated.toLocaleString()} tokens)`);
    
    // Estimativa de custo ANTES
    const pricing = window.IA_CONFIG.pricing;
    const estimatedInputCost = (totalTokensEstimated / 1000000) * pricing.input;
    console.log(`  üíµ Custo estimado input: $${estimatedInputCost.toFixed(4)}`);
    
    // Sugest√µes de economia
    console.log('%cüìä ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'color: #ff0000');
    console.log('%cüí° OPORTUNIDADES DE ECONOMIA:', 'color: #ff0000; font-weight: bold');
    console.log('%cüìä ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'color: #ff0000');
    
    // Thresholds ajustados para os novos limites v2
    if (breakdown.analises > 12000) {
      console.log(`  ‚ö†Ô∏è AN√ÅLISES muito grandes (${Math.ceil(breakdown.analises/4).toLocaleString()} tokens) - Limite √© 12k chars`);
    }
    if (breakdown.estruturacao > 8000) {
      console.log(`  ‚ö†Ô∏è ESTRUTURA√á√ÉO grande (${Math.ceil(breakdown.estruturacao/4).toLocaleString()} tokens) - Selecione fontes espec√≠ficas`);
    }
    if (breakdown.documentos > 6000) {
      console.log(`  ‚ö†Ô∏è DOCUMENTOS ocupando muito (${Math.ceil(breakdown.documentos/4).toLocaleString()} tokens) - Remova docs n√£o usados`);
    }
    if (breakdown.chatHistory > 6000) {
      console.log(`  ‚ö†Ô∏è HIST√ìRICO DO CHAT longo (${Math.ceil(breakdown.chatHistory/4).toLocaleString()} tokens) - Inicie nova conversa`);
    }
    if (breakdown.outros > 3000) {
      console.log(`  ‚ö†Ô∏è CONTEXTO "OUTROS" grande (${Math.ceil(breakdown.outros/4).toLocaleString()} tokens) - Verifique dados redundantes`);
    }
    if (totalTokensEstimated < 8000) {
      console.log(`  ‚úÖ Consumo otimizado! Menos de 8k tokens de input.`);
    } else if (totalTokensEstimated > 15000) {
      console.log(`  üö® ALERTA: ${totalTokensEstimated.toLocaleString()} tokens √© MUITO! Meta √© <10k`);
    }
    
    console.log('%cüìä ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #00ff00; font-weight: bold');
    
    // üîê Chamada via proxy backend (API key segura no servidor)
    const data = await window.callAIProxy(window.IA_CONFIG.model, allMessages, auth.currentUser?.uid);
    
    loadingMsg.loading = false;
    const answer = data.choices?.[0]?.message?.content || 'Sem resposta da IA';
    loadingMsg.content = appendSourcesToResponse(answer, contextSources);
    loadingMsg.ts = Date.now();
    console.log(`‚úÖ [sendIAQuestion] Resposta recebida (${answer.length} chars)`);
    console.log(`üí¨ [sendIAQuestion] Chat agora tem ${chat.messages.length} mensagens`);
    
    // Calcular e mostrar custo da resposta
    if(data.usage){
      const inputTokens = data.usage.prompt_tokens || 0;
      const outputTokens = data.usage.completion_tokens || 0;
      const totalTokens = data.usage.total_tokens || 0;
      
      // Usa pre√ßos da configura√ß√£o centralizada (IA_CONFIG)
      const pricing = window.IA_CONFIG.pricing;
      const inputCost = (inputTokens / 1000000) * pricing.input;
      const outputCost = (outputTokens / 1000000) * pricing.output;
      const totalCost = inputCost + outputCost;
      
      // Log detalhado P√ìS-RESPOSTA
      console.log('%cüí∞ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #00ffff; font-weight: bold');
      console.log('%cüí∞ CUSTO REAL DA RESPOSTA (OpenRouter)', 'color: #00ffff; font-size: 14px; font-weight: bold');
      console.log('%cüí∞ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #00ffff; font-weight: bold');
      console.log(`  ü§ñ Modelo: ${window.IA_CONFIG.model}`);
      console.log(`  üì• Input tokens: ${inputTokens.toLocaleString()} tokens`);
      console.log(`  üì§ Output tokens: ${outputTokens.toLocaleString()} tokens`);
      console.log(`  üìä Total tokens: ${totalTokens.toLocaleString()} tokens`);
      console.log('%cüí∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'color: #ffff00');
      console.log(`  üíµ Custo input:  $${inputCost.toFixed(6)} (${inputTokens} √ó $${pricing.input}/1M)`);
      console.log(`  ÔøΩ Custo output: $${outputCost.toFixed(6)} (${outputTokens} √ó $${pricing.output}/1M)`);
      console.log(`  üí∞ CUSTO TOTAL:  $${totalCost.toFixed(6)}`);
      console.log('%cüí∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'color: #ffff00');
      
      // Compara√ß√£o com outros modelos
      const modelComparison = {
        'gemini-flash': { input: 0.15, output: 0.60 },
        'gemini-pro': { input: 1.25, output: 10.00 },
        'claude-sonnet': { input: 3.00, output: 15.00 },
        'gpt-4o-mini': { input: 0.15, output: 0.60 },
        'gpt-4o': { input: 5.00, output: 15.00 }
      };
      
      console.log('%cüí° COMPARATIVO - Quanto custaria em outros modelos:', 'color: #ff00ff');
      Object.entries(modelComparison).forEach(([model, prices]) => {
        const altInputCost = (inputTokens / 1000000) * prices.input;
        const altOutputCost = (outputTokens / 1000000) * prices.output;
        const altTotal = altInputCost + altOutputCost;
        const diff = altTotal - totalCost;
        const emoji = diff > 0 ? 'üìà' : 'üìâ';
        const diffStr = diff > 0 ? `+$${diff.toFixed(6)}` : `-$${Math.abs(diff).toFixed(6)}`;
        console.log(`  ${emoji} ${model.padEnd(15)} $${altTotal.toFixed(6)} (${diffStr})`);
      });
      
      // Hist√≥rico de custos da sess√£o
      if (!window.IA_SESSION_COSTS) window.IA_SESSION_COSTS = [];
      window.IA_SESSION_COSTS.push({
        timestamp: new Date().toISOString(),
        inputTokens,
        outputTokens,
        totalCost,
        question: question?.substring(0, 50) || 'imagem'
      });
      
      const sessionTotal = window.IA_SESSION_COSTS.reduce((sum, c) => sum + c.totalCost, 0);
      const avgCost = sessionTotal / window.IA_SESSION_COSTS.length;
      
      console.log('%cüí∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'color: #00ff00');
      console.log('%cüìà CUSTOS DA SESS√ÉO:', 'color: #00ff00; font-weight: bold');
      console.log(`  üìä Perguntas nesta sess√£o: ${window.IA_SESSION_COSTS.length}`);
      console.log(`  üíµ Custo total da sess√£o: $${sessionTotal.toFixed(6)}`);
      console.log(`  üìâ Custo m√©dio por pergunta: $${avgCost.toFixed(6)}`);
      console.log('%cüí∞ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'color: #00ffff; font-weight: bold');
      
      // Mostrar popup tempor√°rio com o custo
      showCostNotification(inputTokens, outputTokens, totalCost);
    }
  }catch(err){
    console.error('‚ùå [sendIAQuestion] Erro ao obter resposta da I.A.:', err);
    loadingMsg.loading = false;
    loadingMsg.content = appendSourcesToResponse(`Erro: ${err.message}`, contextSources);
    loadingMsg.ts = Date.now();
  }
  touchChat(chat);
  renderIAHistory();
  renderIAChatList();
  console.log('üíæ [sendIAQuestion] Salvando conversa final...');
  console.log(`üí¨ [sendIAQuestion] Total de mensagens no chat: ${chat.messages.length}`);
  console.log(`üí¨ [sendIAQuestion] Total de chats em IA_CHATS: ${IA_CHATS.length}`);
  
  try {
    await saveIAChatsToUserData();
    console.log('‚úÖ [sendIAQuestion] Conversa salva com sucesso!');
  } catch(saveErr) {
    console.error('‚ùå [sendIAQuestion] FALHA AO SALVAR CONVERSA:', saveErr);
    if(saveErr.message && saveErr.message.includes('exceeds')) {
      console.error('üö® SEU DOCUMENTO FIREBASE EXCEDEU 1MB!');
      console.error('üí° Execute AGORA no console: await reduzirDocumentoUsuario()');
      mgToast('üö® CONVERSA N√ÉO FOI SALVA! Documento > 1MB. Execute: await reduzirDocumentoUsuario()', 'error', 15000);
    }
  }
  
  if(sendBtn) sendBtn.disabled = false;
  focusComposer();
}
    iaNewChat?.addEventListener('click', ()=>{ newIAChat(); });
    iaComposer?.addEventListener('submit', (event)=>{ event.preventDefault(); sendIAQuestion(); });
    iaQuestion?.addEventListener('keydown', (event)=>{
      if(event.key === 'Enter' && !event.shiftKey){ event.preventDefault(); sendIAQuestion(); }
    });
    iaQuestion?.addEventListener('input', autoResizeComposer);
    iaChatSearch?.addEventListener('input', ()=>{ renderIAChatList(); });
    
    // Event listener para colar imagem (Ctrl+V ou Cmd+V)
    iaQuestion?.addEventListener('paste', async (e) => {
      const items = e.clipboardData?.items;
      if(!items || items.length === 0) return;
      
      // Procurar por imagem nos itens colados
      let imageItem = null;
      for(let i = 0; i < items.length; i++){
        if(items[i].type.startsWith('image/')){
          imageItem = items[i];
          break;
        }
      }
      
      if(!imageItem) return; // N√£o √© imagem, deixar comportamento padr√£o
      
      e.preventDefault(); // Prevenir colagem de texto quando for imagem
      
      const file = imageItem.getAsFile();
      if(!file){
        console.error('‚ùå Erro ao obter imagem da √°rea de transfer√™ncia');
        return;
      }
      
      // Validar tamanho (10MB)
      if(file.size > 10 * 1024 * 1024){
        alert('‚ö†Ô∏è A imagem √© muito grande. Tamanho m√°ximo: 10MB');
        return;
      }
      
      console.log('üñºÔ∏è Imagem colada na aba IA:', file.name || 'clipboard-image', `(${(file.size / 1024).toFixed(2)} KB)`);
      
      // Armazenar imagem
      IA_CURRENT_IMAGE = file;
      
      // Mostrar preview
      const reader = new FileReader();
      reader.onload = (e) => {
        if(iaImagePreviewImg) iaImagePreviewImg.src = e.target.result;
        if(iaImagePreviewName) iaImagePreviewName.textContent = file.name || 'Imagem colada';
        if(iaImagePreviewSize) iaImagePreviewSize.textContent = `${(file.size / 1024).toFixed(2)} KB`;
        if(iaImagePreviewWrapper) iaImagePreviewWrapper.style.display = 'block';
      };
      reader.readAsDataURL(file);
    });
    
    // Event listener para remover imagem
    iaImagePreviewRemove?.addEventListener('click', () => {
      IA_CURRENT_IMAGE = null;
      if(iaImagePreviewWrapper) iaImagePreviewWrapper.style.display = 'none';
      if(iaImagePreviewImg) iaImagePreviewImg.src = '';
      console.log('üóëÔ∏è Imagem removida');
    });
    
    // Event listeners para bot√µes de tamanho de resposta
    document.querySelectorAll('.ia-size-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        document.querySelectorAll('.ia-size-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        IA_RESPONSE_SIZE = btn.dataset.size;
      });
    });
    
    // Event listeners para seletor de fontes
    const iaSourcesBtn = $('iaSourcesBtn');
    const iaSourcesMenu = $('iaSourcesMenu');
    const iaSourcesText = $('iaSourcesText');
    const sourceAllCheckbox = $('source-all');
    const iaSourcesSelectAll = $('iaSourcesSelectAll');
    const iaSourcesClearAll = $('iaSourcesClearAll');
    
    // Debug: verificar se elementos foram encontrados
    console.log('üîß Debug Seletor de Fontes:');
    console.log('  iaSourcesBtn:', iaSourcesBtn ? '‚úÖ encontrado' : '‚ùå N√ÉO encontrado');
    console.log('  iaSourcesMenu:', iaSourcesMenu ? '‚úÖ encontrado' : '‚ùå N√ÉO encontrado');
    console.log('  iaSourcesText:', iaSourcesText ? '‚úÖ encontrado' : '‚ùå N√ÉO encontrado');
    console.log('  sourceAllCheckbox:', sourceAllCheckbox ? '‚úÖ encontrado' : '‚ùå N√ÉO encontrado');
    
    // Toggle dropdown - usando event delegation
    document.addEventListener('click', (e) => {
      // Bot√£o Marcar Todas
      if (e.target.closest('#iaSourcesSelectAll')) {
        e.preventDefault();
        e.stopPropagation();
        console.log('üìå Marcar Todas clicado');
        document.querySelectorAll('.ia-source-option input[type="checkbox"]').forEach(cb => {
          cb.checked = true;
        });
        // Aplicar automaticamente
        applySourceSelection();
        return;
      }
      
      // Bot√£o Limpar
      if (e.target.closest('#iaSourcesClearAll')) {
        e.preventDefault();
        e.stopPropagation();
        console.log('üóëÔ∏è Limpar clicado');
        document.querySelectorAll('.ia-source-option input[type="checkbox"]').forEach(cb => {
          cb.checked = false;
        });
        // Aplicar automaticamente
        applySourceSelection();
        return;
      }
      
      // Toggle dropdown ao clicar no bot√£o principal
      if (e.target.closest('#iaSourcesBtn')) {
        e.preventDefault();
        e.stopPropagation();
        const menu = document.getElementById('iaSourcesMenu');
        menu?.classList.toggle('show');
        console.log('üîΩ Toggle dropdown');
        return;
      }
      
      // Se clicou dentro do menu (em checkbox ou label), n√£o fechar
      if (e.target.closest('.ia-sources-menu')) {
        return;
      }
      
      // Fechar dropdown ao clicar fora
      const menu = document.getElementById('iaSourcesMenu');
      if (menu?.classList.contains('show')) {
        menu.classList.remove('show');
        console.log('üîº Dropdown fechado (clique fora)');
      }
    });
    
    // Fun√ß√£o para aplicar a sele√ß√£o automaticamente
    function applySourceSelection() {
      console.log('üéØ Aplicando sele√ß√£o automaticamente...');
      
      const allCheckboxes = document.querySelectorAll('.ia-source-option input[type="checkbox"]:not(#source-all)');
      const selectedCheckboxes = document.querySelectorAll('.ia-source-option input[type="checkbox"]:not(#source-all):checked');
      
      console.log('üìã Total de checkboxes:', allCheckboxes.length);
      console.log('‚úÖ Checkboxes marcados:', selectedCheckboxes.length);
      
      const selectedSources = [];
      selectedCheckboxes.forEach(cb => {
        const source = cb.getAttribute('data-source');
        if (source) selectedSources.push(source);
      });
      
      console.log('üéØ Fontes selecionadas:', selectedSources);
      
      if (selectedSources.length === 0 || selectedSources.length === allCheckboxes.length) {
        IA_SELECTED_SOURCES = ['all'];
        console.log('‚û°Ô∏è Definido: all');
      } else {
        IA_SELECTED_SOURCES = selectedSources;
        console.log('‚û°Ô∏è Definido:', selectedSources);
      }
      
      // Atualizar texto do bot√£o
      const textEl = document.getElementById('iaSourcesText');
      if (textEl) {
        if (IA_SELECTED_SOURCES.includes('all')) {
          textEl.textContent = 'Todas as Abas (32)';
        } else if (IA_SELECTED_SOURCES.length === 1) {
          const names = {
            'estruturacao': 'üìù Notas das 6 Semanas',
            'analise-todos': 'üìö Todos os Entreg√°veis',
            'diagnostico': '1Ô∏è‚É£ Diagn√≥stico Estrat√©gico',
            'direcionamento': '2Ô∏è‚É£ Direcionamento e Metas',
            'concorrencia': '3Ô∏è‚É£ An√°lise de Concorr√™ncia',
            'cdt': '4Ô∏è‚É£ Matriz CDT',
            'puv': '5Ô∏è‚É£ PUV',
            'pai': '6Ô∏è‚É£ PAI',
            'anuncios': '7Ô∏è‚É£ An√∫ncios Pagos',
            'seo': '8Ô∏è‚É£ Site e SEO',
            'redes': '9Ô∏è‚É£ Redes Sociais',
            'copy': 'üîü Copywriting',
            'conteudo': '1Ô∏è‚É£1Ô∏è‚É£ Produ√ß√£o de Conte√∫do',
            'criativos': '1Ô∏è‚É£2Ô∏è‚É£ Criativos de An√∫ncios',
            'crm': '1Ô∏è‚É£3Ô∏è‚É£ CRM e Automa√ß√µes',
            'comercial': '1Ô∏è‚É£4Ô∏è‚É£ Processo Comercial',
            'lp': '1Ô∏è‚É£5Ô∏è‚É£ Landing Pages',
            'website': '1Ô∏è‚É£6Ô∏è‚É£ Website',
            'visual': '1Ô∏è‚É£7Ô∏è‚É£ Padroniza√ß√£o Visual',
            'plataforma': '1Ô∏è‚É£8Ô∏è‚É£ Plataforma Mediagrowth',
            'macro': 'ÔøΩ Macro', 'planejamento': 'üìã Planejamento',
            'calendario': 'üìÖ Calend√°rio', 'posts': 'üì∏ Posts', 'metas': 'üéØ Metas',
            'cac': 'üí∞ CAC', 'leads': 'üë• Leads', 'anotacoes': 'üìù Anota√ß√µes',
            'acessos': 'ÔøΩ Acessos', 'arquivos': 'üìÅ Arquivos', 'relatorio': 'üìä Relat√≥rio', 'demandas': '‚úÖ Demandas'
          };
          textEl.textContent = names[IA_SELECTED_SOURCES[0]] || '1 Aba';
        } else {
          textEl.textContent = `${IA_SELECTED_SOURCES.length} Abas`;
        }
        console.log('üìù Texto atualizado:', textEl.textContent);
      }
      
      // Invalidar cache
      invalidateIAContextCache();
      
      console.log('‚úÖ IA_SELECTED_SOURCES final:', IA_SELECTED_SOURCES);
    }
    
    // Handle "Todas as Abas" checkbox
    document.addEventListener('change', (e) => {
      if (e.target.id === 'source-all') {
        console.log('‚òëÔ∏è Todas as Abas checkbox alterado:', e.target.checked);
        const checkboxes = document.querySelectorAll('.ia-source-option input[type="checkbox"]:not(#source-all)');
        checkboxes.forEach(cb => {
          cb.checked = e.target.checked;
        });
        // Aplicar automaticamente
        applySourceSelection();
        return;
      }
      
      // Handle individual checkbox changes
      if (e.target.closest('.ia-source-option') && e.target.type === 'checkbox' && e.target.id !== 'source-all') {
        const allCheckboxes = document.querySelectorAll('.ia-source-option input[type="checkbox"]:not(#source-all)');
        const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
        const noneChecked = Array.from(allCheckboxes).every(cb => !cb.checked);
        const sourceAll = document.getElementById('source-all');
        
        if (allChecked) {
          sourceAll.checked = true;
          sourceAll.indeterminate = false;
        } else if (noneChecked) {
          sourceAll.checked = false;
          sourceAll.indeterminate = false;
        } else {
          sourceAll.checked = false;
          sourceAll.indeterminate = true;
        }
        
        // Aplicar automaticamente
        applySourceSelection();
      }
    });
    
    iaDocsPick?.addEventListener('click', ()=>{ iaDocsInput?.click(); });
    iaDocsUpload?.addEventListener('click', ()=>{ uploadPendingIADocs(); });
    iaDocsInput?.addEventListener('change', ()=>{
      IA_DOCS_PENDING = Array.from(iaDocsInput?.files || []);
      updateIADocsStatus();
    });
    iaDocsList?.addEventListener('click', async (event)=>{
      const btn = event.target.closest('button');
      if(!btn) return;
      const id = btn.dataset.id;
      if(!id) return;
      if(btn.classList.contains('ia-doc-delete')){
        if(!auth.currentUser){ alert('Fa√ßa login para excluir documentos.'); return; }
        if(!confirm('Excluir este documento da base da IA?')) return;
        try{
          const clientKey = getClientKey();
          const docMeta = IA_DOCS.find(d=>d.id === id);
          const userKey = docMeta?.userKey || getUserKey();
          if(!userKey || !clientKey) throw new Error('Cliente n√£o identificado.');
          await deleteDoc(doc(db, 'usuarios', userKey, 'clients', clientKey, 'iaDocs', id));
          await loadIADocs();
          updateIADocsStatus();
          invalidateIAContextCache();
        }catch(err){
          console.error('delete ia doc', err);
          alert('Falha ao excluir: ' + (err?.message || String(err)));
        }
        return;
      }
      if(btn.classList.contains('ia-doc-download')){
        const item = IA_DOCS.find(d=>d.id === id);
        if(!item){ alert('Documento n√£o encontrado.'); return; }
        const text = item.text || '';
        const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        const base = (item.name || 'documento').replace(/\.[^/.]+$/,'');
        link.href = url;
        link.download = `${base || 'documento'}-ia.txt`;
        document.body.appendChild(link);
        link.click();
        setTimeout(()=>{
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        }, 0);
      }
    });
    iaChatList?.addEventListener('click', (event)=>{
      const item = event.target.closest('.ia-chat-item');
      if(!item) return;
      const chat = IA_CHATS.find(c=>c.id === item.dataset.id);
      if(chat){ CURRENT_CHAT = chat; renderIAChatList(); renderIAHistory(); focusComposer(); }
    });
    iaRenameChat?.addEventListener('click', async ()=>{
      if(!CURRENT_CHAT) return;
      const suggested = chatTitle(CURRENT_CHAT);
      const response = prompt('Novo t√≠tulo da conversa', suggested);
      if(response === null) return;
      const trimmed = response.trim();
      CURRENT_CHAT.title = trimmed ? deriveTitleFromText(trimmed) : 'Nova conversa';
      touchChat(CURRENT_CHAT);
      renderIAChatList();
      renderIAHistory();
      await saveIAChatsToUserData();
    });
    iaDeleteChat?.addEventListener('click', async ()=>{
      if(!CURRENT_CHAT) return;
      if(!confirm('Excluir esta conversa?')) return;
      const id = CURRENT_CHAT.id;
      const location = CURRENT_CHAT.location; // 'main' ou 'archive'
      
      // Remover da lista em mem√≥ria
      IA_CHATS = IA_CHATS.filter(chat=>chat.id !== id);
      
      // Se estava na subcole√ß√£o, deletar tamb√©m de l√°
      if (location === 'archive') {
        try {
          const userId = auth.currentUser?.uid;
          if (userId) {
            const chatDocRef = doc(db, 'usuarios', userId, 'iaChats', id);
            await deleteDoc(chatDocRef);
            console.log(`üóëÔ∏è Conversa ${id} removida da subcole√ß√£o`);
          }
        } catch (err) {
          console.error('‚ùå Erro ao deletar conversa da subcole√ß√£o:', err);
        }
      }
      
      if(!IA_CHATS.length){
        CURRENT_CHAT = null;
        renderIAChatList();
        renderIAHistory();
        await saveIAChatsToUserData();
        newIAChat();
        return;
      }
      CURRENT_CHAT = IA_CHATS[0];
      touchChat(CURRENT_CHAT);
      renderIAChatList();
      renderIAHistory();
      await saveIAChatsToUserData();
      focusComposer();
    });
    function renderIA(){
      if(iaQuestion){ iaQuestion.value=""; autoResizeComposer(); }
      renderIAChatList();
      renderIAHistory(false); // false = n√£o rolar automaticamente ao trocar de aba
      renderIADocsList();
      updateIADocsStatus();
      ensurePlatformCode();
    }

    // ===== BRIEFING =====
    const briefWrap = $("briefWrap");
    const briefText = $("briefText");
    const briefSave = $("briefSave");
    const briefImportJson = $("briefImportJson");
    const briefWebhookUrl = $("briefWebhookUrl");
    const briefSendWebhook = $("briefSendWebhook");
    const briefIframeUrl = $("briefIframeUrl");
    const briefApplyIframe = $("briefApplyIframe");
    const briefIframe = $("briefIframe");
    const briefFrameShell = $("briefFrameShell");
    const briefForm = $("briefForm");
    const briefGenerateAI = $("briefGenerateAI");
    const briefCopy = $("briefCopy");

    const BRIEF_FIELD_COUNT = 56;
    const BRIEFING_QUESTION_TITLES = [
      "Nome da empresa",
      "Cidade e estado",
      "Cidades principais de atua√ß√£o",
      "Descri√ß√£o detalhada (1 frase)",
      "Servi√ßos/produtos",
      "Como entregam (ex: loja f√≠sica, or√ßamento gratuito, etc.)",
      "Slogan/frase de efeito",
      "Dias e hor√°rios de funcionamento",
      "Diferenciais (3 itens)",
      "Tecnologia/atendimento/experi√™ncia superior",
      "3 empresas refer√™ncia/inspira√ß√£o",
      "Cliente ideal (idade, profiss√£o, regi√£o...)",
      "Dores/problemas antes de contratar",
      "Desejos/resultados esperados",
      "Tom de abordagem preferido",
      "Ticket m√©dio",
      "Taxa de convers√£o (or√ßamento‚Üívenda)",
      "Faturamento m√©dio mensal",
      "Meta de crescimento (6 meses)",
      "Promo√ß√µes atuais",
      "Pacotes/planos/condi√ß√µes especiais",
      "Sazonalidade (vende mais quando?)",
      "Per√≠odos fracos",
      "O que mais chama aten√ß√£o nas redes",
      "Conte√∫do que deseja publicar",
      "Caracter√≠sticas (3 a 5)",
      "Dores/frustra√ß√µes antes de contratar",
      "Transforma√ß√£o ap√≥s contratar",
      "Se sumisse do mercado, o que fariam falta?",
      "O que promete e cumpre como ningu√©m",
      "Como quer ser lembrado",
      "Onde quer estar em 1 ano",
      "Principais desafios",
      "Observa√ß√µes gerais",
      "Sobre o cliente e o neg√≥cio ‚Äì PlayBook",
      "Miss√£o e valores da empresa",
      "Produtos/servi√ßos e Core Business",
      "P√∫blico-alvo ideal (ICP/Persona)",
      "Diferenciais da marca",
      "J√° existe um planejamento da atua√ß√£o?",
      "Principal objetivo com este trabalho",
      "Metas espec√≠ficas a alcan√ßar",
      "Prazo ideal para ver resultados",
      "Manual da marca dispon√≠vel?",
      "Tom de voz ou linguagem espec√≠fica",
      "Refer√™ncias de marcas ou campanhas",
      "Principais concorrentes",
      "O que admira ou deseja evitar no mercado",
      "Canais em que a marca est√° presente",
      "Canais que funcionam melhor atualmente",
      "O que manter ou mudar na presen√ßa digital",
      "Or√ßamento dispon√≠vel",
      "Equipe interna ou parceiros envolvidos",
      "Frequ√™ncia esperada de entregas/resultados",
      "Ponto de contato direto",
      "Aprova√ß√£o dos materiais"
    ];
    let BRIEF = {
      text: "",
      iframeUrl: "",
      webhookUrl: "",
      answers: {}, // q1..q56
      updatedAt: 0
    };

    function briefFieldIds() { return Array.from({length:BRIEF_FIELD_COUNT}, (_,i)=>"q"+(i+1)); }
    function buildBriefClipboardText(){
      const sections = [];
      const noteText = (briefText?.value || "").trim();
      if(noteText){
        sections.push(`Bloco de notas (texto livre)\n${noteText}`);
      }
      briefFieldIds().forEach((fid, index)=>{
        const el = $(fid);
        if(!el) return;
        const title = `${index + 1}. ${BRIEFING_QUESTION_TITLES[index] || fid}`;
        const value = (el.value || "").trim();
        sections.push(`${title}\n${value}`);
      });
      return sections.join("\n\n").trim();
    }
    function buildBriefingIAPrompt(notesText){
      const normalizedNotes = normalizePlainText(notesText || "");
      const questionGuide = BRIEFING_QUESTION_TITLES
        .map((title, index)=> `q${index + 1}: ${title}`)
        .join('\n');
      const notesBlock = normalizedNotes || 'Sem anota√ß√µes fornecidas.';
      return [
        'Voc√™ √© o assistente de marketing da Mediagrowth encarregado de estruturar o briefing completo de um cliente.',
        'Analise cuidadosamente as anota√ß√µes e preencha cada resposta de q1 a q56 com base no contexto fornecido.',
        'Quando a informa√ß√£o estiver presente ou puder ser inferida de forma coerente, utilize-a. Quando n√£o houver dado relacionado, deixe a resposta como string vazia.',
        'Retorne exclusivamente um objeto JSON v√°lido contendo 56 pares chave-valor utilizando as chaves "q1" at√© "q56". Cada valor deve ser uma string em portugu√™s, sem bullet points ou coment√°rios extras.',
        'N√£o inclua texto fora do JSON nem blocos de c√≥digo.',
        `Perguntas do briefing (mapa de chaves):\n${questionGuide}`,
        `Anota√ß√µes do briefing:\n"""\n${notesBlock}\n"""`
      ].join('\n\n');
    }
    function coerceBriefingAnswerValue(value){
      if(value === null || value === undefined) return '';
      if(typeof value === 'string'){
        return normalizePlainText(value);
      }
      if(Array.isArray(value)){
        return value.map(coerceBriefingAnswerValue).filter(Boolean).join(', ');
      }
      if(typeof value === 'object'){
        return Object.values(value).map(coerceBriefingAnswerValue).filter(Boolean).join('; ');
      }
      return normalizePlainText(String(value));
    }
    function extractJsonObject(text){
      if(!text) return null;
      let raw = text.trim();
      const fenced = raw.match(/```(?:json)?([\s\S]*?)```/i);
      if(fenced){
        raw = fenced[1];
      }
      const braceMatch = raw.match(/\{[\s\S]*\}/);
      if(braceMatch){
        raw = braceMatch[0];
      }
      try{
        return JSON.parse(raw);
      }catch(_err){
        return null;
      }
    }
    function parseBriefingAIResponse(text){
      const data = extractJsonObject(text);
      if(!data || typeof data !== 'object') return null;
      if(data.answers && typeof data.answers === 'object'){ return data.answers; }
      return data;
    }
    function renderBrief() {
      briefText.value = BRIEF.text || "";
      briefWebhookUrl.value = BRIEF.webhookUrl || "";
      briefIframeUrl.value = BRIEF.iframeUrl || "";
      if (BRIEF.iframeUrl) {
        const u = sanitizeUrl(BRIEF.iframeUrl);
        if (u && briefIframe.src !== u) briefIframe.src = u;
      } else {
        briefIframe.removeAttribute("src");
      }
      briefFieldIds().forEach(fid=> { const el = $(fid); if (el) el.value = BRIEF.answers?.[fid] || ""; });
    }
    async function persistBrief() {
      const uid = auth.currentUser?.uid; if (!uid) return;
      BRIEF.text = briefText.value || "";
      BRIEF.webhookUrl = (briefWebhookUrl.value||"").trim();
      BRIEF.iframeUrl = (briefIframeUrl.value||"").trim();
      const answers = {};
      briefFieldIds().forEach(fid=> { const el=$(fid); answers[fid]=(el?.value||"").trim(); });
      BRIEF.answers = answers;
      BRIEF.updatedAt = Date.now();
      const key = `brief-${TENANT}`;
      await setDoc(doc(db, "usuarios", uid), { [key]: BRIEF }, { merge: true });
      USER_DATA[key] = BRIEF;
    }
    function loadBriefFromUserData() {
      const key = `brief-${TENANT}`;
      if (USER_DATA[key] && typeof USER_DATA[key] === 'object') {
        BRIEF = { ...BRIEF, ...USER_DATA[key] };
      } else if (USER_DATA.brief && typeof USER_DATA.brief === 'object') {
        BRIEF = { ...BRIEF, ...USER_DATA.brief };
      }
    }
    const debouncedPersistBrief = debounce(async () => { await persistBrief(); }, 1000);
    briefText?.addEventListener('input', debouncedPersistBrief);
    briefForm?.addEventListener('input', debouncedPersistBrief);
    briefWebhookUrl?.addEventListener('input', debouncedPersistBrief);
    briefIframeUrl?.addEventListener('input', debouncedPersistBrief);
    briefSave?.addEventListener("click", async ()=>{ await persistBrief(); alert("Briefing salvo!"); });
    briefCopy?.addEventListener('click', async ()=>{
      const text = buildBriefClipboardText();
      if(!text){
        alert('Nenhum conte√∫do para copiar.');
        return;
      }
      // Usar fun√ß√£o robusta de clipboard com fallback para iframes
      const copied = await mgCopyToClipboard(text);
      if(copied){
        if(typeof mgToast === 'function'){
          mgToast('Briefing copiado para a √°rea de transfer√™ncia');
        }else{
          alert('Briefing copiado para a √°rea de transfer√™ncia');
        }
      }else{
        alert('N√£o foi poss√≠vel copiar o briefing.');
      }
    });
    briefApplyIframe?.addEventListener("click", async ()=>{ const u = sanitizeUrl(briefIframeUrl.value||""); if(u) briefIframe.src=u; else briefIframe.removeAttribute("src"); await persistBrief(); });
    briefGenerateAI?.addEventListener('click', async ()=>{
      if(!auth?.currentUser){
        alert('Fa√ßa login para gerar o briefing com a I.A.');
        return;
      }
      // üîê API Key agora est√° no backend
      if(typeof window.callAIProxy !== 'function'){
        alert('Erro: Fun√ß√£o de IA n√£o dispon√≠vel. Recarregue a p√°gina.');
        return;
      }
      const prompt = buildBriefingIAPrompt(briefText?.value || "").trim();
      if(!prompt){
        alert('N√£o foi poss√≠vel montar o prompt para a I.A.');
        return;
      }
      const originalText = briefGenerateAI.textContent;
      briefGenerateAI.disabled = true;
      briefGenerateAI.textContent = 'Gerando...';
      try{
        // üîê Chamada via proxy backend (API key segura no servidor)
        const data = await window.callAIProxy('gpt-4o-mini', [
          { role: 'system', content: 'Voc√™ √© o assistente de marketing da Mediagrowth. Leia as instru√ß√µes e retorne apenas JSON v√°lido com as chaves q1 a q56.' },
          { role: 'user', content: prompt }
        ], auth.currentUser?.uid);
        
        const content = data?.choices?.[0]?.message?.content || '';
        const parsed = parseBriefingAIResponse(content);
        if(!parsed){
          throw new Error('N√£o foi poss√≠vel interpretar a resposta da I.A.');
        }
        const fieldIds = briefFieldIds();
        const newAnswers = {};
        fieldIds.forEach((fid, index)=>{
          const keyOptions = [fid, `q${index + 1}`, String(index + 1), BRIEFING_QUESTION_TITLES[index]];
          let value = '';
          for(const key of keyOptions){
            if(Object.prototype.hasOwnProperty.call(parsed, key)){
              value = coerceBriefingAnswerValue(parsed[key]);
              break;
            }
          }
          newAnswers[fid] = value;
        });
        BRIEF.text = briefText?.value || '';
        BRIEF.answers = newAnswers;
        BRIEF.updatedAt = Date.now();
        renderBrief();
        await persistBrief();
        if(typeof mgToast === 'function'){
          mgToast('Briefing atualizado com sucesso');
        } else {
          alert('Briefing atualizado com sucesso');
        }
      }catch(err){
        console.error('briefGenerateAI', err);
        alert(`Falha ao gerar briefing: ${err?.message || err}`);
      }finally{
        briefGenerateAI.disabled = false;
        if(typeof originalText === 'string'){
          briefGenerateAI.textContent = originalText;
        }
      }
    });
    briefImportJson?.addEventListener("click", async ()=>{
      try{ const str=prompt("Cole o JSON com as respostas do formul√°rio:"); if(!str) return;
        const data=JSON.parse(str); const answers={ ...(BRIEF.answers||{}) };
        Object.keys(data||{}).forEach(k=>{ const m=String(k).match(/(\d+)/); if(m){ const i=parseInt(m[1],10); if(i>=1&&i<=BRIEF_FIELD_COUNT) answers["q"+i]=String(data[k]??""); }
          if(answers[k]!==undefined) answers[k]=String(data[k]??""); });
        BRIEF.answers=answers; renderBrief(); await persistBrief(); alert("Dados importados no briefing.");
      }catch(e){ alert("JSON inv√°lido: "+(e.message||String(e))); }
    });
    briefSendWebhook?.addEventListener("click", async ()=>{
      const url=(briefWebhookUrl.value||"").trim(); if(!url){ alert("Informe o Webhook URL."); return; }
      await persistBrief();
      const payload={ tenant:TENANT, user:auth.currentUser?.email||null, brief:BRIEF };
      try{ const res=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
        alert("Webhook enviado: "+res.status);
      }catch(e){ alert("Falha ao enviar webhook: "+(e.message||String(e))); }
    });
    /* ========= cart√µes ========= */
    const MACRO_COMPONENTS = [
      { key: "planejamento", icon: "üóÇÔ∏è", title: "Planejamento", sub: "Demandas e planos em andamento", gradient: "linear-gradient(135deg,#2563eb,#7c3aed)" },
      { key: "metas", icon: "üéØ", title: "Metas", sub: "Objetivos e resultados", gradient: "linear-gradient(135deg,#16a34a,#65a30d)" },
      { key: "posts", icon: "üì£", title: "Posts", sub: "Publica√ß√µes e aprova√ß√µes", gradient: "linear-gradient(135deg,#f97316,#facc15)" }
    ];
    const HISTORY_COLORS = ['#e6194b','#3cb44b','#ffe119','#4363d8','#f58231','#911eb4'];
    const macroSectionRoot = document.getElementById('macroSection');
    let historyChart = null;
    let selectedMonths = [];
    let historyEventsBound = false;

    function getMacroHistoryElements(){
      if(!macroSectionRoot) return {};
      return {
        controls: macroSectionRoot.querySelector('#historyControls'),
        legend: macroSectionRoot.querySelector('#historyLegend'),
        canvas: macroSectionRoot.querySelector('#historyChart'),
        monthSelect: macroSectionRoot.querySelector('#historyMonthSelect')
      };
    }
    const MACRO_HISTORY_KEY_PREFIX = 'macro_history_v1';
    const MACRO_SETTINGS_KEY_PREFIX = 'macro_settings_v1';

    function resolveMacroClientIdentifier(){
      try{
        if(typeof getClientKey === 'function'){
          const key = getClientKey();
          if(key && key !== 'no-client') return key;
        }
      }catch(_){ }
      const bodyClient = document.body?.getAttribute('data-client-id');
      if(bodyClient && bodyClient !== 'no-client') return bodyClient;
      try{
        const search = new URLSearchParams(location.search || '');
        const searchClient = search.get('client');
        if(searchClient) return searchClient;
      }catch(_){ }
      if(location && typeof location.pathname === 'string'){
        const pathClient = location.pathname.replace(/^\/+/, '').split('/')[0];
        if(pathClient) return pathClient;
      }
      return null;
    }

    function getMacroHistoryStorageKey(){
      const uid = auth?.currentUser?.uid || window.auth?.currentUser?.uid || 'anon';
      const client = resolveMacroClientIdentifier() || 'anon';
      return `${MACRO_HISTORY_KEY_PREFIX}_${uid}_${client}`;
    }

    function getMacroSettingsStorageKey(){
      const uid = auth?.currentUser?.uid || window.auth?.currentUser?.uid || 'anon';
      const client = resolveMacroClientIdentifier() || 'anon';
      return `${MACRO_SETTINGS_KEY_PREFIX}_${uid}_${client}`;
    }

    function loadMacroHistory(){
      try{
        const raw = localStorage.getItem(getMacroHistoryStorageKey());
        const arr = raw ? JSON.parse(raw) : [];
        if(!Array.isArray(arr)) return [];
        return arr.filter(item => item && typeof item === 'object' && Number.isFinite(item.ts));
      }catch(_){
        return [];
      }
    }

    function saveMacroHistory(records){
      try{
        localStorage.setItem(getMacroHistoryStorageKey(), JSON.stringify(records));
      }catch(_){ }
    }

    function loadMacroSettings(){
      try{
        const raw = localStorage.getItem(getMacroSettingsStorageKey());
        if(!raw) return {};
        const parsed = JSON.parse(raw);
        return parsed && typeof parsed === 'object' ? parsed : {};
      }catch(_){
        return {};
      }
    }

    function saveMacroSettings(settings){
      try{
        if(!settings || typeof settings !== 'object') return;
        localStorage.setItem(getMacroSettingsStorageKey(), JSON.stringify(settings));
      }catch(_){ }
    }

    function computeDefaultMonthlyPostsTarget(referenceDate = new Date()){
      const date = safeDate(referenceDate) || new Date();
      const year = date.getFullYear();
      const month = date.getMonth();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const weeks = Math.max(4, Math.ceil(daysInMonth / 7));
      return weeks * 3;
    }

    function resolveMacroPostsTarget(referenceDate = new Date()){
      const date = safeDate(referenceDate) || new Date();
      const defaultTarget = computeDefaultMonthlyPostsTarget(date);
      const settings = loadMacroSettings();
      const stored = settings && typeof settings === 'object' ? Number(settings.postsMonthlyTarget) : NaN;
      const normalized = Number.isFinite(stored) && stored > 0 ? Math.round(stored) : null;
      return {
        target: normalized || defaultTarget,
        defaultTarget,
        isCustom: Boolean(normalized)
      };
    }

    function updateMacroPostsTarget(value){
      let settings = loadMacroSettings();
      if(!settings || typeof settings !== 'object') settings = {};
      const raw = typeof value === 'string' ? value.trim() : value;
      if(raw === '' || raw === null || raw === undefined){
        delete settings.postsMonthlyTarget;
        saveMacroSettings(settings);
        return;
      }
      const num = Number(raw);
      if(Number.isFinite(num) && num > 0){
        settings.postsMonthlyTarget = Math.round(num);
      }else{
        delete settings.postsMonthlyTarget;
      }
      saveMacroSettings(settings);
    }

    function handleMacroPostTargetInputEvent(event){
      const input = event?.target;
      if(!(input instanceof HTMLInputElement)) return;
      const raw = (input.value ?? '').toString().trim();
      if(!raw){
        if(input.value !== '') input.value = '';
        updateMacroPostsTarget('');
      }else{
        const num = Number(raw);
        if(Number.isFinite(num) && num > 0){
          const normalized = Math.round(num);
          if(String(normalized) !== input.value){
            input.value = String(normalized);
          }
          updateMacroPostsTarget(normalized);
        }else{
          input.value = '';
          updateMacroPostsTarget('');
        }
      }
      try{ refreshMacroInsights({ immediate: true }); }catch(_){ }
    }

    function handleMacroPostTargetKeydown(event){
      if(event?.key !== 'Enter') return;
      event.preventDefault();
      handleMacroPostTargetInputEvent(event);
      const target = event?.target;
      if(target && typeof target.blur === 'function') target.blur();
    }

    function clamp(value, min, max){
      const num = Number(value);
      if(Number.isNaN(num)) return min;
      return Math.min(Math.max(num, min), max);
    }

    function safeDate(value){
      if(!value) return null;
      try{
        const dt = value instanceof Date ? value : new Date(value);
        return Number.isNaN(dt.getTime()) ? null : dt;
      }catch(_){
        return null;
      }
    }

    function describePerformance(progress){
      if(progress >= 0.85) return 'excelente';
      if(progress >= 0.7) return 'bom';
      if(progress >= 0.5) return 'aten√ß√£o';
      return 'cr√≠tico';
    }

    function computePlanMetrics(demandasList, now){
      const tasks = [];
      const monthTasks = [];
      const source = Array.isArray(demandasList) ? demandasList : [];
      const monthKey = typeof buildMonthKey === 'function'
        ? buildMonthKey(now.getFullYear(), now.getMonth()+1)
        : null;
      source.forEach(item=>{
        if(!item) return;
        const copy = { ...item, planos: item.planos ? { ...item.planos } : {} };
        if(typeof normalizeDemanda === 'function'){
          try{ normalizeDemanda(copy); }catch(_){ }
        }
        const hasContent = (copy.demanda || '').trim() || (copy.status || '').trim() || (copy.responsavel || '').trim();
        if(!hasContent) return;
        tasks.push(copy);
        if(!monthKey){
          monthTasks.push(copy);
          return;
        }
        let matchesMonth = false;
        if(typeof getDemandMonthKeys === 'function'){
          try{
            const months = getDemandMonthKeys(copy);
            if(Array.isArray(months) && months.includes(monthKey)){
              matchesMonth = true;
            }
          }catch(_err){ }
        }
        if(!matchesMonth){
          const due = typeof getDemandaDueDate === 'function' ? getDemandaDueDate(copy) : null;
          if(due && due.getFullYear() === now.getFullYear() && due.getMonth() === now.getMonth()){
            matchesMonth = true;
          }else if(!due && typeof getDemandaStartDate === 'function'){
            const start = getDemandaStartDate(copy);
            if(start && start.getFullYear() === now.getFullYear() && start.getMonth() === now.getMonth()){
              matchesMonth = true;
            }
          }
        }
        if(matchesMonth){
          monthTasks.push(copy);
        }
      });
      const relevantTasks = monthTasks.length ? monthTasks : tasks;
      const total = relevantTasks.length;
      let completed = 0;
      let inProgress = 0;
      let blocked = 0;
      let withDates = 0;
      let withResponsible = 0;
      let lastEdited = 0;
      const timeline = [];
      let overdue = 0;
      relevantTasks.forEach(d=>{
        const status = (d.status || '').toLowerCase();
        if(status === 'concluido' || status === 'concluido-grupo'){ completed++; }
        else if(status === 'em-andamento' || status === 'prioridade' || status === 'prioridade-grupo'){ inProgress++; }
        else if(status === 'bloqueado'){ blocked++; }
        const due = typeof getDemandaDueDate === 'function' ? getDemandaDueDate(d) : null;
        const dueTs = due ? due.getTime() : null;
        if(dueTs !== null){
          withDates++;
          const done = status === 'concluido' || status === 'concluido-grupo';
          if(!done && dueTs < now.getTime()){ overdue++; }
          if(dueTs >= now.getTime() - 1000*60*60*24*2){
            timeline.push({ date: new Date(dueTs), type:'planejamento', title: d.demanda || 'Demanda sem t√≠tulo', meta: d.responsavel || '', status });
          }
        }
        if(d.responsavel && d.responsavel.trim()){ withResponsible++; }
        const edited = Number(d.edited) || 0;
        if(edited > lastEdited) lastEdited = edited;
      });
      const actionableTotal = completed + inProgress;
      const rawProgress = total ? (completed + inProgress * 0.5) / total : 0;
      const progress = clamp(rawProgress, 0, 1);
      const fill = total ? clamp((withDates/Math.max(total,1))*0.6 + (withResponsible/Math.max(total,1))*0.4, 0, 1) : 0;
      timeline.sort((a,b)=> a.date.getTime() - b.date.getTime());
      return {
        progress,
        total,
        completed,
        inProgress,
        actionable: actionableTotal,
        blocked,
        overdue,
        withDates,
        withResponsible,
        fill,
        timeline,
        lastEdited: lastEdited || null
      };
    }

    function normalizeMetaNumber(value){
      if(value === null || value === undefined) return 0;
      const num = typeof value === 'string' ? parseFloat(value) : Number(value);
      return Number.isFinite(num) ? num : 0;
    }

    function evaluateMetaGoal(planned, realized, direction){
      const p = Math.max(0, normalizeMetaNumber(planned));
      const r = normalizeMetaNumber(realized);
      
      // Se n√£o tem meta planejada ou realizado est√° vazio/zero, retorna 'missing' (precisa colocar)
      if(p <= 0 || (r === 0 && planned === 0) || (r === 0 && !realized && realized !== 0)) return 'missing';
      
      const dir = (direction || 'aumentar').toLowerCase();
      
      if(dir === 'diminuir'){
        // Para diminuir: se realizado <= planejado = atingida, sen√£o = em andamento
        return r <= p ? 'achieved' : 'in-progress';
      }
      if(dir === 'manter'){
        if(p === 0) return 'in-progress';
        const tolerance = Math.max(Math.abs(p) * 0.05, 0.01);
        return Math.abs(r - p) <= tolerance ? 'achieved' : 'in-progress';
      }
      // Para aumentar: se realizado >= planejado = atingida, sen√£o = em andamento
      return r >= p ? 'achieved' : 'in-progress';
    }

    function computeMetaMetrics(metasList, now){
      const metas = Array.isArray(metasList)
        ? metasList.filter(meta => meta && meta.ativo !== false)
        : [];
      const monthIndex = now.getMonth();
      const monthKey = Array.isArray(META_MONTHS) ? META_MONTHS[monthIndex] : null;
      const monthLabel = monthKey ? (META_MONTH_LABELS?.[monthKey] || monthKey.toUpperCase()) : '';
      const total = metas.length;
      const monthly = {
        total,
        defined: 0,
        achieved: 0,
        inProgress: 0,
        missing: 0,
        monthKey,
        monthLabel
      };
      const annual = {
        total,
        defined: 0,
        achieved: 0,
        inProgress: 0,
        missing: 0,
        year: now.getFullYear()
      };
      metas.forEach(meta=>{
        const meses = meta?.meses || {};
        const current = monthKey ? (meses[monthKey] || {}) : {};
        const planned = normalizeMetaNumber(current.p ?? current.P);
        const realized = normalizeMetaNumber(current.r ?? current.R);
        if(planned > 0){
          monthly.defined++;
          const status = evaluateMetaGoal(planned, realized, meta?.direcao);
          if(status === 'achieved') monthly.achieved++;
          else monthly.inProgress++;
        }

        let yearlyPlanned = 0;
        let yearlyRealized = 0;
        if(Array.isArray(META_MONTHS)){
          META_MONTHS.forEach(m=>{
            const info = meses[m] || {};
            yearlyPlanned += normalizeMetaNumber(info.p ?? info.P);
            yearlyRealized += normalizeMetaNumber(info.r ?? info.R);
          });
        }
        if(meta?.modo === 'media'){
          const divisor = Array.isArray(META_MONTHS) && META_MONTHS.length ? META_MONTHS.length : 1;
          yearlyPlanned = yearlyPlanned / divisor;
          yearlyRealized = yearlyRealized / divisor;
        }
        if(yearlyPlanned > 0){
          annual.defined++;
          const annualStatus = evaluateMetaGoal(yearlyPlanned, yearlyRealized, meta?.direcao);
          if(annualStatus === 'achieved') annual.achieved++;
          else annual.inProgress++;
        }
      });
      monthly.missing = Math.max(total - monthly.defined, 0);
      annual.missing = Math.max(total - annual.defined, 0);
      const filled = monthly.defined;
      const progress = monthly.defined ? clamp(monthly.achieved / monthly.defined, 0, 1) : 0;
      const fill = total ? clamp(monthly.defined / total, 0, 1) : 0;
      const summaryLines = [];
      if(total === 0){
        summaryLines.push('Nenhuma meta cadastrada.');
      }else{
        const monthTitle = monthLabel ? `Mensal (${monthLabel})` : 'Mensal';
        summaryLines.push(`${monthTitle}: Definidas ${monthly.defined} ‚Ä¢ Alcan√ßadas ${monthly.achieved} ‚Ä¢ Em andamento ${monthly.inProgress} ‚Ä¢ Por definir ${monthly.missing}`);
        const yearLabel = annual.year ? String(annual.year) : '';
        const annualTitle = yearLabel ? `Anual (${yearLabel})` : 'Anual';
        summaryLines.push(`${annualTitle}: Definidas ${annual.defined} ‚Ä¢ Alcan√ßadas ${annual.achieved} ‚Ä¢ Em andamento ${annual.inProgress} ‚Ä¢ Por definir ${annual.missing}`);
      }
      return {
        progress,
        total,
        filled,
        withPlan: monthly.defined,
        monthKey,
        monthly,
        annual,
        fill,
        summaryLines,
        ratios: []
      };
    }

    function computePostMetrics(postsList, now){
      const posts = Array.isArray(postsList) ? postsList : [];
      const referenceDate = safeDate(now) || new Date();
      const { target, defaultTarget, isCustom } = resolveMacroPostsTarget(referenceDate);
      const monthStart = new Date(referenceDate.getFullYear(), referenceDate.getMonth(), 1);
      const nextMonthStart = new Date(referenceDate.getFullYear(), referenceDate.getMonth() + 1, 1);
      const timeline = [];
      let registered = 0;
      let approved = 0;
      let needsReview = 0;
      let lastApproved = null;
      posts.forEach(post=>{
        if(!post) return;
        const status = (post.status || '').toLowerCase();
        let postDate = safeDate(post.dateISO);
        if(!postDate || !Number.isFinite(postDate.getTime())){
          if(post.createdAt){
            const created = safeDate(post.createdAt);
            if(created && Number.isFinite(created.getTime())) postDate = created;
          }
          if((!postDate || !Number.isFinite(postDate.getTime())) && post.updatedAt){
            const updated = safeDate(post.updatedAt);
            if(updated && Number.isFinite(updated.getTime())) postDate = updated;
          }
        }
        if(!postDate) return;
        const ts = postDate.getTime();
        if(ts < monthStart.getTime() || ts >= nextMonthStart.getTime()) return;
        registered++;
        if(status === 'aprovado'){
          approved++;
          if(!lastApproved || ts > lastApproved.getTime()) lastApproved = postDate;
        }else if(status === 'revisar'){
          needsReview++;
        }
        timeline.push({
          date: postDate,
          type:'posts',
          title: post.desc || 'Post sem descri√ß√£o',
          meta: post.target || 'feed',
          status
        });
      });
      timeline.sort((a,b)=> a.date.getTime() - b.date.getTime());
      const effectiveTarget = target > 0 ? target : 0;
      const plannedContribution = effectiveTarget > 0 ? Math.min(registered, effectiveTarget) * 0.5 : 0;
      const approvalContribution = effectiveTarget > 0 ? Math.min(approved, effectiveTarget) * 0.5 : 0;
      const progress = effectiveTarget > 0
        ? clamp((plannedContribution + approvalContribution) / effectiveTarget, 0, 1)
        : 0;
      const fill = effectiveTarget > 0 ? clamp(registered / effectiveTarget, 0, 1) : 0;
      const remaining = effectiveTarget > 0 ? Math.max(effectiveTarget - approved, 0) : 0;
      const monthLabel = referenceDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
      return {
        progress,
        total: registered,
        registered,
        approved,
        needsReview,
        fill,
        timeline: timeline.slice(0,6),
        lastApproved,
        target: effectiveTarget,
        defaultTarget,
        isCustomTarget: isCustom,
        plannedContribution,
        approvalContribution,
        monthLabel,
        remaining
      };
    }

    function computeBriefingMetrics(brief){
      const answers = brief && typeof brief === 'object' ? brief.answers : null;
      let answered = 0;
      if(answers && typeof answers === 'object'){
        Object.values(answers).forEach(value=>{
          if(typeof value === 'string' && value.trim()){ answered++; }
        });
      }
      const total = BRIEF_FIELD_COUNT || 56;
      const progress = total ? clamp(answered/total, 0, 1) : 0;
      return {
        progress,
        answered,
        total,
        updatedAt: brief?.updatedAt || null
      };
    }

    function buildMacroSupplementalData(){
      let cacState;
      try{ cacState = CAC_DATA; }catch(_){ cacState = null; }
      let refState;
      try{ refState = Array.isArray(REF_SOCIAL) ? REF_SOCIAL : []; }
      catch(_){ refState = []; }
      let notesState;
      try{ notesState = Array.isArray(NOTES) ? NOTES : []; }
      catch(_){ notesState = []; }
      let filesState = Array.isArray(recentFilesCache) ? recentFilesCache : [];
      let competitorsState;
      try{ competitorsState = Array.isArray(COMPETITORS) ? COMPETITORS : []; }
      catch(_){ competitorsState = []; }
      let socialState;
      try{
        socialState = SOCIAL_LINKS && typeof SOCIAL_LINKS === 'object' ? { ...SOCIAL_LINKS } : {};
      }catch(_){
        socialState = {};
      }

      const now = new Date();
      const monthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      const monthLabel = now.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
      const currency = cacState?.currency || 'BRL';
      const monthExpenses = Array.isArray(cacState?.expenses?.[monthKey]) ? cacState.expenses[monthKey] : [];
      const totalExpenses = monthExpenses.reduce((acc, item)=> acc + (Number(item?.val) || 0), 0);
      const monthSales = Number(cacState?.sales?.[monthKey]) || 0;
      const cacValue = monthSales > 0 ? totalExpenses / monthSales : null;
      const cacDisplay = cacValue !== null ? formatMacroCurrency(cacValue, currency) : '‚Äî';
      const expensesDisplay = totalExpenses > 0 ? formatMacroCurrency(totalExpenses, currency) : null;
      let cacDetail = '';
      if(monthSales > 0 && expensesDisplay){
        const salesLabel = monthSales.toLocaleString('pt-BR');
        cacDetail = `${salesLabel} venda(s) ‚Ä¢ Despesas: ${expensesDisplay}`;
      }else if(expensesDisplay){
        cacDetail = `Despesas: ${expensesDisplay} ‚Ä¢ Informe as vendas para calcular o CAC.`;
      }else{
        cacDetail = 'Cadastre despesas e vendas para calcular o CAC do m√™s.';
      }

      const referencesCount = refState.length;
      const categoryMap = new Map();
      refState.forEach(item=>{
        const raw = (item?.category || 'Sem categoria').toString().trim();
        const label = raw || 'Sem categoria';
        categoryMap.set(label, (categoryMap.get(label) || 0) + 1);
      });
      const topCategories = Array.from(categoryMap.entries())
        .sort((a,b)=> b[1] - a[1])
        .slice(0, 2)
        .map(([label, count])=> `${label}: ${count}`);
      let referencesDetail = '';
      if(referencesCount === 0){
        referencesDetail = 'Nenhuma refer√™ncia cadastrada.';
      }else if(topCategories.length){
        referencesDetail = `Principais categorias ‚Ä¢ ${topCategories.join(' ‚Ä¢ ')}`;
      }else{
        referencesDetail = 'Refer√™ncias registradas na plataforma.';
      }

      const sectorLabels = {
        roi: 'ROI',
        'vitrine-engajamento': 'Vitrine/Engajamento',
        novasideias: 'Novas Ideias',
        relacionamento: 'Relacionamento',
        ia: 'I.A',
        gbp: 'Google Business Profile'
      };
      const noteItems = notesState
        .map(note=>{
          if(!note || typeof note !== 'object') return null;
          const title = (note.title || '').trim() || 'Anota√ß√£o sem t√≠tulo';
          const timestamps = [note.updatedAt, note.createdAt]
            .map(val=> Number(val))
            .filter(val=> Number.isFinite(val));
          let date = null;
          if(timestamps.length){
            const ts = Math.max(...timestamps);
            date = new Date(ts);
          }else if(note.dateISO){
            const parsed = new Date(note.dateISO);
            if(Number.isFinite(parsed.getTime())) date = parsed;
          }
          const subtitleParts = [];
          if(date){
            subtitleParts.push(formatMacroDate(date));
          }
          const sector = (note.sector || '').toString().trim();
          if(sector){
            subtitleParts.push(sectorLabels[sector] || sector);
          }
          return {
            title,
            subtitle: subtitleParts.join(' ‚Ä¢ '),
            ts: date ? date.getTime() : 0
          };
        })
        .filter(Boolean)
        .sort((a,b)=> (b.ts || 0) - (a.ts || 0))
        .slice(0, 3);

      const fileItems = filesState
        .map(file=>{
          const name = (file?.name || '').trim() || 'Arquivo sem nome';
          const createdAt = Number(file?.createdAt);
          const date = Number.isFinite(createdAt) ? new Date(createdAt) : null;
          const subtitleParts = [];
          if(date){
            subtitleParts.push(formatMacroDate(date));
          }
          if(file?.folderLabel){
            subtitleParts.push(file.folderLabel);
          }
          return {
            title: name,
            subtitle: subtitleParts.join(' ‚Ä¢ '),
            ts: date ? date.getTime() : 0
          };
        })
        .filter(Boolean)
        .sort((a,b)=> (b.ts || 0) - (a.ts || 0))
        .slice(0, 4);

      const competitorItems = competitorsState
        .map((comp, idx)=>{
          const title = (comp?.name || comp?.link || `Concorrente ${idx + 1}`).toString().trim();
          const subtitleParts = [];
          if(comp?.tags){
            subtitleParts.push(comp.tags);
          }
          if(comp?.link){
            subtitleParts.push(comp.link);
          }
          return {
            title,
            subtitle: subtitleParts.join(' ‚Ä¢ ')
          };
        })
        .slice(0, 5);

      const socialNetworks = [
        { key: 'instagram', label: 'Instagram' },
        { key: 'facebook', label: 'Facebook' },
        { key: 'linkedin', label: 'LinkedIn' },
        { key: 'tiktok', label: 'TikTok' },
        { key: 'youtube', label: 'YouTube' },
        { key: 'whatsapp', label: 'WhatsApp' },
        { key: 'website', label: 'Site' }
      ];
      const socialItems = socialNetworks.map(meta=>{
        const raw = (socialState?.[meta.key] || '').toString().trim();
        const hasLink = raw.length > 0;
        let iconInfo = null;
        try{
          iconInfo = typeof SOCIAL_ICONS !== 'undefined' ? SOCIAL_ICONS[meta.key] || null : null;
        }catch(_){
          iconInfo = null;
        }
        return {
          key: meta.key,
          label: meta.label,
          hasLink,
          link: hasLink ? raw : null,
          status: hasLink ? 'ok' : 'missing',
          statusLabel: hasLink ? 'OK' : 'Indispon√≠vel',
          detail: hasLink ? 'Link conectado' : 'Falta adicionar',
          icon: {
            src: iconInfo && iconInfo.src ? iconInfo.src : null,
            emoji: iconInfo && iconInfo.emoji ? iconInfo.emoji : null
          }
        };
      });
      const socialConfigured = socialItems.filter(item=> item.hasLink).length;
      const socialTotal = socialItems.length;
      const socialPercent = socialTotal ? Math.round((socialConfigured / socialTotal) * 100) : 0;
      const socialSummaryText = socialTotal
        ? `${socialConfigured} de ${socialTotal} redes configuradas ‚Ä¢ ${socialPercent}% conclu√≠do`
        : 'Nenhuma rede social configurada.';

      return {
        cac: {
          title: `CAC do m√™s (${monthLabel})`,
          value: cacDisplay,
          detail: cacDetail
        },
        references: {
          title: 'Refer√™ncias cadastradas',
          value: referencesCount.toLocaleString('pt-BR'),
          detail: referencesDetail
        },
        notes: {
          items: noteItems,
          emptyMessage: 'Nenhuma anota√ß√£o registrada recentemente.'
        },
        files: {
          items: fileItems,
          emptyMessage: 'Nenhum arquivo enviado recentemente.'
        },
        competitors: {
          items: competitorItems,
          emptyMessage: 'Nenhum concorrente cadastrado.'
        },
        social: {
          items: socialItems,
          summary: {
            ready: socialConfigured,
            total: socialTotal,
            percent: socialPercent,
            text: socialSummaryText
          }
        }
      };
    }

    function computeMacroInsightsSources({ demandas = [], metas = [], posts = [], brief = null } = {}){
      const now = new Date();
      const plan = computePlanMetrics(demandas, now);
      const metasMetrics = computeMetaMetrics(metas, now);
      const postsMetrics = computePostMetrics(posts, now);
      const components = {};
      MACRO_COMPONENTS.forEach(comp=>{
        const base =
          comp.key === 'planejamento' ? plan :
          comp.key === 'metas' ? metasMetrics :
          postsMetrics;
        components[comp.key] = {
          ...base,
          label: comp.title,
          icon: comp.icon,
          gradient: comp.gradient,
          description: comp.sub,
          progress: clamp(base.progress ?? 0, 0, 1),
          status: describePerformance(base.progress ?? 0)
        };
      });
      const weights = { planejamento: 0.4, metas: 0.3, posts: 0.3 };
      let weighted = 0;
      let weightTotal = 0;
      MACRO_COMPONENTS.forEach(comp=>{
        const w = weights[comp.key] ?? (1/MACRO_COMPONENTS.length);
        const progress = components[comp.key]?.progress ?? 0;
        weighted += progress * w;
        weightTotal += w;
      });
      const normalized = weightTotal ? weighted/weightTotal : 0;
      const score = Math.round(normalized * 100);
      const levelKey = describePerformance(normalized);
      const level = levelKey === 'excelente' ? 'Excelente'
        : levelKey === 'bom' ? 'Bom'
        : levelKey === 'aten√ß√£o' ? 'Aten√ß√£o'
        : 'Cr√≠tico';
      const timeline = [...plan.timeline.slice(0,4), ...postsMetrics.timeline.slice(0,4)]
        .sort((a,b)=> a.date.getTime() - b.date.getTime())
        .slice(0,8);
      const checklist = [
        {
          label: 'Planejamento em dia',
          done: plan.progress >= 0.7 && plan.overdue === 0 && plan.total > 0,
          detail: plan.total ? `${plan.completed}/${plan.total} conclu√≠das ‚Ä¢ ${plan.overdue} atrasadas` : 'Cadastre as demandas estrat√©gicas do cliente.'
        },
        {
          label: 'Metas atualizadas',
          done: metasMetrics.progress >= 0.6 && metasMetrics.total > 0,
          detail: metasMetrics.total
            ? `${metasMetrics.monthly.achieved} metas alcan√ßadas ‚Ä¢ ${metasMetrics.monthly.inProgress} em andamento ‚Ä¢ ${metasMetrics.monthly.missing} sem defini√ß√£o`
            : 'Nenhuma meta cadastrada.'
        },
        {
          label: 'Posts aprovados',
          done: postsMetrics.target > 0 && postsMetrics.progress >= 0.6 && postsMetrics.registered > 0,
          detail: postsMetrics.registered > 0
            ? (postsMetrics.target > 0
              ? `Meta: ${postsMetrics.target} ‚Ä¢ Cadastrados: ${postsMetrics.registered} ‚Ä¢ Aprovados: ${postsMetrics.approved}${postsMetrics.needsReview ? ` ‚Ä¢ ${postsMetrics.needsReview} aguardando revis√£o` : ''}`
              : 'Defina a meta mensal de posts para calcular o progresso.')
            : 'Nenhum post cadastrado.'
        }
      ];
      const alerts = [];
      if(plan.total === 0){
        alerts.push({ type: 'warn', text: 'Nenhum planejamento cadastrado. Organize as a√ß√µes estrat√©gicas do cliente.' });
      }else{
        if(plan.overdue > 0){
          alerts.push({ type: 'warn', text: `${plan.overdue} demanda(s) est√°(√£o) atrasada(s). Reforce as responsabilidades.` });
        }
        if(plan.inProgress === 0 && plan.completed < plan.total){
          alerts.push({ type: 'warn', text: 'Nenhuma demanda em andamento. Verifique o status das entregas.' });
        }
      }
      if(metasMetrics.total === 0){
        alerts.push({ type: 'warn', text: 'Cadastre metas mensais para acompanhar o desempenho comercial.' });
      }else if(metasMetrics.progress < 0.5){
        alerts.push({ type: 'warn', text: 'As metas do m√™s est√£o com baixa execu√ß√£o. Revise os n√∫meros planejados vs realizados.' });
      }
      if(postsMetrics.registered === 0){
        alerts.push({ type: 'warn', text: 'Nenhum post cadastrado no calend√°rio. Adicione as publica√ß√µes planejadas.' });
      }else{
        if(postsMetrics.approved/Math.max(postsMetrics.registered,1) < 0.5){
          alerts.push({ type: 'warn', text: 'Menos da metade dos posts est√° aprovada. Ajuste o pipeline com o cliente.' });
        }
        if(postsMetrics.needsReview > 0){
          alerts.push({ type: 'warn', text: `${postsMetrics.needsReview} post(s) aguardam revis√£o.` });
        }
        const missingPlanned = Math.max(postsMetrics.target - postsMetrics.registered, 0);
        if(missingPlanned > 0){
          alerts.push({ type: 'warn', text: `Cadastre mais ${missingPlanned} post(s) para atingir a meta mensal.` });
        }
        const missingApproved = Math.max(postsMetrics.target - postsMetrics.approved, 0);
        if(missingApproved > 0){
          alerts.push({ type: 'warn', text: `${missingApproved} post(s) ainda precisam ser aprovados para cumprir a meta mensal.` });
        }
      }
      if(!alerts.length){
        alerts.push({ type: 'ok', text: 'Nenhum alerta cr√≠tico no momento. Continue monitorando os indicadores.' });
      }
      const actionable = plan.actionable || 0;
      const completionPercent = Math.round(clamp(plan.progress || 0, 0, 1) * 100);
      const completionDetail = plan.total === 0
        ? 'Cadastre novas demandas.'
        : actionable === 0
          ? `${plan.total} pendentes ‚Ä¢ ${plan.overdue} atrasadas`
          : `${plan.completed}/${actionable} conclu√≠das ‚Ä¢ ${plan.inProgress} em andamento ‚Ä¢ ${plan.overdue} atrasadas`;
      const postsMiniDetailParts = [];
      if(postsMetrics.registered > 0){
        postsMiniDetailParts.push(`Meta ${postsMetrics.isCustomTarget ? 'personalizada' : 'padr√£o'}: ${postsMetrics.target}`);
        postsMiniDetailParts.push(`Cadastrados: ${postsMetrics.registered}`);
        postsMiniDetailParts.push(`Aprovados: ${postsMetrics.approved}`);
        if(postsMetrics.needsReview > 0){
          postsMiniDetailParts.push(`${postsMetrics.needsReview} aguardando revis√£o`);
        }
      }
      const postsMiniDetail = postsMiniDetailParts.length ? postsMiniDetailParts.join(' ‚Ä¢ ') : 'Nenhum post cadastrado.';
      const postsMiniValue = postsMetrics.target > 0 ? `${postsMetrics.approved}/${postsMetrics.target}` : String(postsMetrics.approved);
      const miniCards = [
        { title: 'Demandas conclu√≠das', value: `${completionPercent}%`, detail: completionDetail },
        { title: 'Metas com dados', value: metasMetrics.total ? `${metasMetrics.monthly.defined}/${metasMetrics.total}` : '0', detail: metasMetrics.total ? `Alcan√ßadas: ${metasMetrics.monthly.achieved} ‚Ä¢ Em andamento: ${metasMetrics.monthly.inProgress} ‚Ä¢ Por definir: ${metasMetrics.monthly.missing}` : 'Inclua metas para o m√™s atual.' },
        { title: 'Posts do m√™s', value: postsMiniValue, detail: postsMiniDetail }
      ];
      const fillIndicators = [
        {
          label: 'Planejamento',
          percent: Math.round(plan.fill * 100),
          description: plan.total ? `${plan.withDates}/${plan.total} com prazo ‚Ä¢ ${plan.withResponsible}/${plan.total} com respons√°vel` : 'Nenhuma demanda cadastrada.'
        },
        {
          label: 'Metas',
          percent: Math.round(metasMetrics.fill * 100),
          description: metasMetrics.total ? `${metasMetrics.monthly.defined}/${metasMetrics.total} metas definidas ‚Ä¢ ${metasMetrics.monthly.missing} por definir` : 'Cadastre metas mensais.'
        },
        {
          label: 'Posts',
          percent: Math.round(postsMetrics.progress * 100),
          description: postsMetrics.registered > 0
            ? `Meta: ${postsMetrics.target} ‚Ä¢ Cadastrados: ${postsMetrics.registered} ‚Ä¢ Aprovados: ${postsMetrics.approved}${postsMetrics.needsReview ? ` ‚Ä¢ ${postsMetrics.needsReview} aguardando revis√£o` : ''}`
            : 'Nenhum post registrado.'
        }
      ];
      const scoreTip = MACRO_COMPONENTS.map(comp=>{
        const data = components[comp.key];
        const pct = Math.round(clamp(data?.progress ?? 0, 0, 1) * 100);
        return `${comp.title}: ${pct}%`;
      }).join(' ‚Ä¢ ');
      return {
        score,
        level,
        levelKey,
        components,
        checklist,
        alerts,
        miniCards,
        fillIndicators,
        timeline,
        generatedAt: now,
        scoreTip,
        supplemental: buildMacroSupplementalData()
      };
    }

    function computeMacroInsights(){
      return computeMacroInsightsSources({
        demandas: DEMANDAS,
        metas: METAS,
        posts: POSTS,
        brief: BRIEF
      });
    }

    let lastMacroInsights = null;
    const MACRO_REFRESH_DEBOUNCE = 140;
    let macroRefreshTimer = null;
    let macroPendingRender = false;
    let macroDomRefs = null;
    let recentFilesCache = [];
    const MACRO_DATE_TIME_FORMATTER = new Intl.DateTimeFormat('pt-BR', { dateStyle: 'short', timeStyle: 'short' });

    function formatMacroCurrency(value, currencyCode){
      const amount = Number(value);
      if(!Number.isFinite(amount)) return '‚Äî';
      const code = (currencyCode || 'BRL').toUpperCase();
      const locale = code === 'USD' ? 'en-US' : 'pt-BR';
      try{
        return new Intl.NumberFormat(locale, {
          style: 'currency',
          currency: code,
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }).format(amount);
      }catch(_){
        return `${code} ${amount.toFixed(2)}`;
      }
    }

    function formatMacroDate(value){
      if(!(value instanceof Date) || Number.isNaN(value.getTime())) return '';
      try{
        return MACRO_DATE_TIME_FORMATTER.format(value);
      }catch(_){
        return value.toLocaleString('pt-BR');
      }
    }

    function createMacroDom(){
      const root = document.createElement('div');
      root.className = 'macro-intel';

      const summary = document.createElement('section');
      summary.className = 'macro-summary';
      const left = document.createElement('div');
      left.className = 'macro-summary-left';
      const levelEl = document.createElement('div');
      levelEl.className = 'macro-summary-level';
      const scoreEl = document.createElement('div');
      scoreEl.className = 'macro-summary-score';
      const detail = document.createElement('div');
      detail.className = 'macro-summary-detail';
      detail.textContent = 'Monitoramento autom√°tico dos principais indicadores do cliente.';
      left.append(levelEl, scoreEl, detail);
      summary.appendChild(left);
      const metaWrap = document.createElement('div');
      metaWrap.className = 'macro-summary-meta';
      const generatedEl = document.createElement('span');
      const tipEl = document.createElement('span');
      metaWrap.append(generatedEl, tipEl);
      summary.appendChild(metaWrap);
      root.appendChild(summary);

      const progressGrid = document.createElement('div');
      progressGrid.className = 'macro-progress-grid';
      const progressRefs = new Map();
      MACRO_COMPONENTS.forEach(comp=>{
        const card = document.createElement('div');
        card.className = 'macro-progress-card';
        card.dataset.macroKey = comp.key;
        card.dataset.defaultGradient = comp.gradient || '';
        card.style.background = comp.gradient || '';
        const title = document.createElement('strong');
        title.textContent = `${comp.icon} ${comp.title}`;
        const sub = document.createElement('small');
        sub.textContent = comp.sub;
        const summaryBox = document.createElement('div');
        summaryBox.className = 'macro-progress-summary';
        let summaryMetric = null;
        if(comp.key === 'posts'){
          const valueDisplay = document.createElement('div');
          valueDisplay.className = 'macro-post-target-value';
          const valueNumber = document.createElement('span');
          valueNumber.textContent = '‚Äî';
          valueDisplay.appendChild(valueNumber);
          summaryBox.append(valueDisplay);
          summaryMetric = valueNumber;
        }
        const value = document.createElement('div');
        value.className = 'macro-progress-value';
        const bar = document.createElement('div');
        bar.className = 'macro-progress-bar';
        const fill = document.createElement('div');
        fill.className = 'macro-progress-fill';
        bar.appendChild(fill);
        const meta = document.createElement('div');
        meta.className = 'macro-progress-meta';
        const statusText = document.createElement('span');
        const statusIcon = document.createElement('span');
        meta.append(statusText, statusIcon);
        card.append(title, sub, summaryBox, value, bar, meta);
        progressGrid.appendChild(card);
        progressRefs.set(comp.key, {
          card,
          summaryEl: summaryBox,
          summaryMetricEl: summaryMetric,
          valueEl: value,
          fillEl: fill,
          statusTextEl: statusText,
          statusIconEl: statusIcon
        });
      });
      root.appendChild(progressGrid);

      function createGoalsCard(title){
        const card = document.createElement('div');
        card.className = 'macro-goals-card';
        const titleEl = document.createElement('h4');
        titleEl.className = 'macro-goals-card-title';
        titleEl.textContent = title;
        card.appendChild(titleEl);
        const rows = {};
        [
          ['defined', 'Definidas'],
          ['achieved', 'Alcan√ßadas'],
          ['inProgress', 'Em andamento'],
          ['missing', 'Por definir']
        ].forEach(([key, label])=>{
          const row = document.createElement('div');
          row.className = 'macro-goals-row';
          const labelEl = document.createElement('span');
          labelEl.className = 'macro-goals-label';
          labelEl.textContent = label;
          const valueEl = document.createElement('span');
          valueEl.className = 'macro-goals-value';
          valueEl.textContent = '0';
          row.append(labelEl, valueEl);
          card.appendChild(row);
          rows[key] = valueEl;
        });
        return { card, titleEl, rows };
      }

      const goalsDetail = document.createElement('section');
      goalsDetail.className = 'macro-goals-detail';
      const goalsTitle = document.createElement('h3');
      goalsTitle.className = 'macro-goals-detail-title';
      goalsTitle.textContent = 'Detalhes das metas';
      const goalsContent = document.createElement('div');
      goalsContent.className = 'macro-goals-detail-content';
      const monthlyCard = createGoalsCard('Metas mensais');
      const annualCard = createGoalsCard('Metas anuais');
      goalsContent.append(monthlyCard.card, annualCard.card);
      const goalsEmpty = document.createElement('div');
      goalsEmpty.className = 'macro-goals-empty';
      goalsEmpty.textContent = 'Nenhuma meta cadastrada.';
      goalsDetail.append(goalsTitle, goalsContent, goalsEmpty);
      root.appendChild(goalsDetail);

      const sections = document.createElement('div');
      sections.className = 'macro-sections';

      const timeline = document.createElement('div');
      timeline.className = 'macro-timeline';
      const tlTitle = document.createElement('h3');
      tlTitle.className = 'macro-section-title';
      tlTitle.textContent = 'Timeline de marcos';
      const timelineList = document.createElement('div');
      timelineList.className = 'macro-timeline-list';
      timelineList.style.display = 'none';
      const timelineEmpty = document.createElement('div');
      timelineEmpty.className = 'macro-empty';
      timelineEmpty.textContent = 'Sem eventos recentes. Cadastre novas demandas, posts ou atualiza√ß√µes para alimentar a timeline.';
      timeline.append(tlTitle, timelineList, timelineEmpty);
      sections.appendChild(timeline);

      const checklist = document.createElement('div');
      checklist.className = 'macro-checklist';
      const checkTitle = document.createElement('h3');
      checkTitle.className = 'macro-section-title';
      checkTitle.textContent = 'Checklist r√°pido';
      checklist.appendChild(checkTitle);
      sections.appendChild(checklist);

      root.appendChild(sections);

      const alertsWrap = document.createElement('div');
      alertsWrap.className = 'macro-alerts';
      root.appendChild(alertsWrap);

      const mini = document.createElement('div');
      mini.className = 'macro-mini-dashboard';
      root.appendChild(mini);

      const fill = document.createElement('div');
      fill.className = 'macro-fill';
      root.appendChild(fill);

      const supplemental = document.createElement('section');
      supplemental.className = 'macro-supplemental';

      function createMetricCard(label){
        const card = document.createElement('div');
        card.className = 'macro-metric-card';
        const titleEl = document.createElement('h4');
        titleEl.className = 'macro-metric-title';
        titleEl.textContent = label;
        const valueEl = document.createElement('div');
        valueEl.className = 'macro-metric-value';
        valueEl.textContent = '‚Äî';
        const detailEl = document.createElement('div');
        detailEl.className = 'macro-metric-detail';
        detailEl.textContent = ' ';
        card.append(titleEl, valueEl, detailEl);
        return { card, titleEl, valueEl, detailEl };
      }

      const metricsWrap = document.createElement('div');
      metricsWrap.className = 'macro-supplemental-grid';
      const cacMetric = createMetricCard('CAC do m√™s');
      const refsMetric = createMetricCard('Refer√™ncias cadastradas');
      metricsWrap.append(cacMetric.card, refsMetric.card);
      supplemental.appendChild(metricsWrap);

      function createListCard(label){
        const card = document.createElement('div');
        card.className = 'macro-list-card';
        const titleEl = document.createElement('h4');
        titleEl.className = 'macro-list-title';
        titleEl.textContent = label;
        const listEl = document.createElement('div');
        listEl.className = 'macro-list-items';
        listEl.style.display = 'none';
        const emptyEl = document.createElement('div');
        emptyEl.className = 'macro-list-empty';
        emptyEl.textContent = 'Nenhum registro encontrado.';
        emptyEl.style.display = 'block';
        card.append(titleEl, listEl, emptyEl);
        return { card, titleEl, listEl, emptyEl };
      }

      const notesCard = createListCard('√öltimas anota√ß√µes');
      const filesCard = createListCard('√öltimos arquivos adicionados');
      const competitorsCard = createListCard('Concorrentes cadastrados');
      const listsWrap = document.createElement('div');
      listsWrap.className = 'macro-supplemental-grid';
      listsWrap.append(notesCard.card, filesCard.card, competitorsCard.card);
      supplemental.appendChild(listsWrap);
      const socialCard = document.createElement('div');
      socialCard.className = 'macro-social-card';
      const socialTitle = document.createElement('h4');
      socialTitle.className = 'macro-social-title';
      socialTitle.textContent = 'Redes Sociais Dispon√≠veis na plataforma';
      const socialGrid = document.createElement('div');
      socialGrid.className = 'macro-social-grid';
      const socialSummary = document.createElement('div');
      socialSummary.className = 'macro-social-summary';
      socialSummary.textContent = 'Monitorando redes sociais configuradas.';
      socialCard.append(socialTitle, socialGrid, socialSummary);
      supplemental.appendChild(socialCard);
      root.appendChild(supplemental);

      return {
        root,
        summary: { levelEl, scoreEl, generatedEl, tipEl },
        progress: { grid: progressGrid, cards: progressRefs },
        goalsDetail: {
          container: goalsDetail,
          titleEl: goalsTitle,
          contentEl: goalsContent,
          emptyEl: goalsEmpty,
          monthly: { titleEl: monthlyCard.titleEl, values: monthlyCard.rows },
          annual: { titleEl: annualCard.titleEl, values: annualCard.rows }
        },
        timeline: { list: timelineList, empty: timelineEmpty },
        checklist: { container: checklist, titleEl: checkTitle },
        alerts: { container: alertsWrap },
        mini: { container: mini },
        fill: { container: fill },
        supplemental: {
          container: supplemental,
          metrics: {
            cac: { titleEl: cacMetric.titleEl, valueEl: cacMetric.valueEl, detailEl: cacMetric.detailEl },
            references: { titleEl: refsMetric.titleEl, valueEl: refsMetric.valueEl, detailEl: refsMetric.detailEl }
          },
          lists: {
            notes: { listEl: notesCard.listEl, emptyEl: notesCard.emptyEl },
            files: { listEl: filesCard.listEl, emptyEl: filesCard.emptyEl },
            competitors: { listEl: competitorsCard.listEl, emptyEl: competitorsCard.emptyEl }
          },
          social: {
            card: socialCard,
            gridEl: socialGrid,
            summaryEl: socialSummary
          }
        }
      };
    }

    function ensureMacroDom(){
      if(!dashboard) return null;
      if(macroDomRefs && macroDomRefs.root && dashboard.contains(macroDomRefs.root)){
        return macroDomRefs;
      }
      macroDomRefs = createMacroDom();
      dashboard.innerHTML = '';
      dashboard.appendChild(macroDomRefs.root);
      if(typeof updateMacroSocialFromHeader === 'function'){
        requestAnimationFrame(()=> updateMacroSocialFromHeader());
      }
      return macroDomRefs;
    }

    function updateMacroSummary(insights){
      if(!macroDomRefs || !macroDomRefs.summary) return;
      const { levelEl, scoreEl, generatedEl, tipEl } = macroDomRefs.summary;
      if(levelEl) levelEl.textContent = insights.level;
      if(scoreEl) scoreEl.textContent = `${insights.score}`;
      if(generatedEl){
        generatedEl.textContent = `Atualizado em ${insights.generatedAt.toLocaleString('pt-BR')}`;
      }
      if(tipEl) tipEl.textContent = insights.scoreTip;
    }

    function formatMacroStatusLabel(status){
      const raw = (status || '').toLowerCase();
      if(raw === 'excelente') return 'Excelente';
      if(raw === 'bom') return 'Bom';
      if(raw === 'aten√ß√£o') return 'Aten√ß√£o';
      if(raw === 'critico' || raw === 'cr√≠tico') return 'Cr√≠tico';
      if(!raw) return 'Sem status';
      return raw.charAt(0).toUpperCase() + raw.slice(1);
    }

    function updateMacroGoalsDetail(metaData){
      if(!macroDomRefs || !macroDomRefs.goalsDetail) return;
      const { container, contentEl, emptyEl, monthly, annual } = macroDomRefs.goalsDetail;
      if(!container) return;

      if(container.style.display === 'none'){
        container.style.display = '';
      }

      if(!metaData){
        if(contentEl) contentEl.style.display = 'none';
        if(emptyEl){
          emptyEl.style.display = 'block';
          emptyEl.textContent = 'Nenhuma meta cadastrada.';
        }
        return;
      }

      const hasData = (metaData.total ?? 0) > 0;
      if(contentEl) contentEl.style.display = 'grid';
      if(emptyEl){
        emptyEl.style.display = hasData ? 'none' : 'block';
        if(!hasData){
          emptyEl.textContent = 'Nenhuma meta cadastrada.';
        }
      }

      const numberFormat = (value)=>{
        const num = Number(value) || 0;
        return num.toLocaleString('pt-BR');
      };

      const monthlyData = metaData.monthly || {};
      if(monthly?.titleEl){
        const monthLabel = (monthlyData.monthLabel || '').trim();
        monthly.titleEl.textContent = monthLabel ? `Metas mensais (${monthLabel})` : 'Metas mensais';
      }
      if(monthly?.values){
        const { defined, achieved, inProgress, missing } = monthly.values;
        if(defined) defined.textContent = numberFormat(monthlyData.defined);
        if(achieved) achieved.textContent = numberFormat(monthlyData.achieved);
        if(inProgress) inProgress.textContent = numberFormat(monthlyData.inProgress);
        if(missing) missing.textContent = numberFormat(monthlyData.missing);
      }

      const annualData = metaData.annual || {};
      if(annual?.titleEl){
        const yearLabel = annualData.year ? ` (${annualData.year})` : '';
        annual.titleEl.textContent = `Metas anuais${yearLabel}`;
      }
      if(annual?.values){
        const { defined, achieved, inProgress, missing } = annual.values;
        if(defined) defined.textContent = numberFormat(annualData.defined);
        if(achieved) achieved.textContent = numberFormat(annualData.achieved);
        if(inProgress) inProgress.textContent = numberFormat(annualData.inProgress);
        if(missing) missing.textContent = numberFormat(annualData.missing);
      }
    }

    function updateMacroProgress(insights){
      if(!macroDomRefs || !macroDomRefs.progress) return;
      const { cards } = macroDomRefs.progress;
      let metasUpdated = false;
      cards.forEach((refs, key)=>{
        const data = insights.components?.[key];
        if(!data) return;
        const pct = Math.round(clamp(data.progress || 0, 0, 1) * 100);
        if(refs.valueEl && refs.valueEl.textContent !== `${pct}%`){
          refs.valueEl.textContent = `${pct}%`;
        }
        if(refs.valueEl){
          if(refs.valueEl.style.display !== ''){
            refs.valueEl.style.display = '';
          }
        }
        if(refs.fillEl){
          const width = `${pct}%`;
          if(refs.fillEl.style.width !== width){
            refs.fillEl.style.width = width;
          }
        }
        if(refs.summaryEl){
          if(key === 'metas'){
            if(refs.summaryEl.innerHTML !== ''){
              refs.summaryEl.innerHTML = '';
            }
            if(refs.summaryEl.style.display !== 'none'){
              refs.summaryEl.style.display = 'none';
            }
            refs.summaryEl.classList.remove('is-visible');
          }else if(key === 'posts'){
            if(!refs.summaryEl.classList.contains('is-visible')){
              refs.summaryEl.classList.add('is-visible');
            }
            if(refs.summaryEl.style.display !== ''){
              refs.summaryEl.style.display = '';
            }
            if(refs.summaryMetricEl){
              const targetValue = data.target > 0 ? data.target : data.defaultTarget;
              const metricText = targetValue > 0 ? `${targetValue} posts/m√™s` : '‚Äî';
              if(refs.summaryMetricEl.textContent !== metricText){
                refs.summaryMetricEl.textContent = metricText;
              }
            }
          }else{
            refs.summaryEl.classList.remove('is-visible');
            if(refs.summaryEl.style.display !== 'none'){
              refs.summaryEl.style.display = 'none';
            }
          }
        }
        if(refs.statusTextEl){
          const label = `Status: ${formatMacroStatusLabel(data.status)}`;
          if(refs.statusTextEl.textContent !== label){
            refs.statusTextEl.textContent = label;
          }
        }
        if(refs.statusIconEl){
          const icon = data.status === 'excelente' ? '‚úÖ'
            : data.status === 'bom' ? 'üü¢'
            : data.status === 'aten√ß√£o' ? '‚ö†Ô∏è'
            : 'üî¥';
          if(refs.statusIconEl.textContent !== icon){
            refs.statusIconEl.textContent = icon;
          }
        }
        if(refs.card){
          const bg = data.gradient || refs.card.dataset.defaultGradient || '';
          if(refs.card.style.background !== bg){
            refs.card.style.background = bg;
          }
        }
        if(key === 'metas'){
          metasUpdated = true;
          updateMacroGoalsDetail(data);
        }
      });
      if(!metasUpdated){
        updateMacroGoalsDetail(null);
      }
    }

    function buildTimelineKey(item, index = 0){
      const dt = safeDate(item?.date) || new Date(0);
      const meta = item?.meta || '';
      const status = item?.status || '';
      return `${dt.getTime()}|${item?.type || ''}|${item?.title || ''}|${meta}|${status}|${index}`;
    }

    function createTimelineRow(item, key){
      const row = document.createElement('div');
      row.className = 'macro-timeline-item';
      row.dataset.macroKey = key;
      const dateEl = document.createElement('div');
      dateEl.className = 'macro-timeline-date';
      const content = document.createElement('div');
      content.className = 'macro-timeline-content';
      const labelEl = document.createElement('div');
      labelEl.className = 'macro-timeline-label';
      const metaEl = document.createElement('div');
      metaEl.className = 'macro-timeline-meta';
      const tagEl = document.createElement('span');
      tagEl.className = 'macro-tag';
      content.append(labelEl, metaEl, tagEl);
      row.append(dateEl, content);
      row.__macroRefs = { dateEl, labelEl, metaEl, tagEl };
      updateTimelineRow(row, item);
      return row;
    }

    function updateTimelineRow(row, item){
      const refs = row.__macroRefs || {};
      const dt = safeDate(item?.date);
      const dateText = dt ? dt.toLocaleDateString('pt-BR', { day:'2-digit', month:'short' }) : '';
      if(refs.dateEl && refs.dateEl.textContent !== dateText){
        refs.dateEl.textContent = dateText;
      }
      const labelText = item?.title || 'Evento';
      if(refs.labelEl && refs.labelEl.textContent !== labelText){
        refs.labelEl.textContent = labelText;
      }
      const typeLabel = item?.type === 'planejamento' ? 'Planejamento' : item?.type === 'posts' ? 'Post' : 'Evento';
      const metaText = `${typeLabel}${item?.meta ? ` ‚Ä¢ ${item.meta}` : ''}`;
      if(refs.metaEl && refs.metaEl.textContent !== metaText){
        refs.metaEl.textContent = metaText;
      }
      const tagText = (item?.status ? item.status : typeLabel).toUpperCase();
      if(refs.tagEl && refs.tagEl.textContent !== tagText){
        refs.tagEl.textContent = tagText;
      }
    }

    function updateMacroTimeline(items){
      if(!macroDomRefs || !macroDomRefs.timeline) return;
      const { list, empty } = macroDomRefs.timeline;
      if(!list || !empty) return;
      const nextItems = Array.isArray(items) ? items : [];
      const existing = new Map(Array.from(list.children).map(el=>[el.dataset.macroKey, el]));
      const fragment = document.createDocumentFragment();
      nextItems.forEach((item, index)=>{
        const key = buildTimelineKey(item, index);
        let row = existing.get(key);
        if(row){
          existing.delete(key);
          updateTimelineRow(row, item);
        }else{
          row = createTimelineRow(item, key);
        }
        fragment.appendChild(row);
      });
      list.replaceChildren(fragment);
      empty.style.display = nextItems.length ? 'none' : '';
      list.style.display = nextItems.length ? '' : 'none';
    }

    function createChecklistRow(item, key){
      const row = document.createElement('div');
      row.className = 'macro-check-item';
      row.dataset.macroKey = key;
      const icon = document.createElement('div');
      icon.className = 'macro-check-icon';
      const text = document.createElement('div');
      text.className = 'macro-check-text';
      const strong = document.createElement('strong');
      const span = document.createElement('span');
      text.append(strong, span);
      row.append(icon, text);
      row.__macroRefs = { iconEl: icon, titleEl: strong, detailEl: span };
      updateChecklistRow(row, item);
      return row;
    }

    function updateChecklistRow(row, item){
      const refs = row.__macroRefs || {};
      const done = !!item?.done;
      if(refs.iconEl){
        const cls = 'macro-check-icon ' + (done ? 'done' : 'pending');
        if(refs.iconEl.className !== cls){
          refs.iconEl.className = cls;
        }
        const iconChar = done ? '‚úî' : '!';
        if(refs.iconEl.textContent !== iconChar){
          refs.iconEl.textContent = iconChar;
        }
      }
      if(refs.titleEl && refs.titleEl.textContent !== item?.label){
        refs.titleEl.textContent = item?.label || '';
      }
      if(refs.detailEl && refs.detailEl.textContent !== item?.detail){
        refs.detailEl.textContent = item?.detail || '';
      }
    }

    function updateMacroChecklist(items){
      if(!macroDomRefs || !macroDomRefs.checklist) return;
      const { container, titleEl } = macroDomRefs.checklist;
      if(!container || !titleEl) return;
      const nextItems = Array.isArray(items) ? items : [];
      const existing = new Map(Array.from(container.children)
        .filter(child=>child !== titleEl)
        .map(child=>[child.dataset.macroKey, child]));
      const rows = [];
      nextItems.forEach(item=>{
        const key = `${item?.label || ''}|${item?.detail || ''}`;
        let row = existing.get(key);
        if(row){
          existing.delete(key);
          updateChecklistRow(row, item);
        }else{
          row = createChecklistRow(item, key);
        }
        rows.push(row);
      });
      container.replaceChildren(titleEl, ...rows);
    }

    function createMiniCard(card, key){
      const box = document.createElement('div');
      box.className = 'macro-mini-card';
      box.dataset.macroKey = key;
      const title = document.createElement('strong');
      const value = document.createElement('div');
      value.className = 'macro-mini-value';
      value.style.fontSize = '1.4rem';
      value.style.fontWeight = '800';
      const detail = document.createElement('span');
      box.append(title, value, detail);
      box.__macroRefs = { titleEl: title, valueEl: value, detailEl: detail };
      updateMiniCard(box, card);
      return box;
    }

    function updateMiniCard(node, card){
      const refs = node.__macroRefs || {};
      if(refs.titleEl && refs.titleEl.textContent !== card?.title){
        refs.titleEl.textContent = card?.title || '';
      }
      if(refs.valueEl && refs.valueEl.textContent !== card?.value){
        refs.valueEl.textContent = card?.value || '';
      }
      if(refs.detailEl && refs.detailEl.textContent !== card?.detail){
        refs.detailEl.textContent = card?.detail || '';
      }
    }

    function updateMacroMiniCards(cards){
      if(!macroDomRefs || !macroDomRefs.mini) return;
      const { container } = macroDomRefs.mini;
      if(!container) return;
      const nextCards = Array.isArray(cards) ? cards : [];
      const existing = new Map(Array.from(container.children).map(child=>[child.dataset.macroKey, child]));
      const nodes = [];
      nextCards.forEach(card=>{
        const key = card?.title || '';
        let node = existing.get(key);
        if(node){
          existing.delete(key);
          updateMiniCard(node, card);
        }else{
          node = createMiniCard(card, key);
        }
        nodes.push(node);
      });
      container.replaceChildren(...nodes);
    }

    function updateMacroAlerts(alerts){
      if(!macroDomRefs || !macroDomRefs.alerts) return;
      const { container } = macroDomRefs.alerts;
      if(!container) return;
      const fragment = document.createDocumentFragment();
      (Array.isArray(alerts) ? alerts : []).forEach(alert=>{
        const item = document.createElement('div');
        item.className = 'macro-alert' + (alert?.type === 'ok' ? ' ok' : '');
        item.textContent = alert?.text || '';
        fragment.appendChild(item);
      });
      container.replaceChildren(fragment);
    }

    function updateMacroFill(fillIndicators){
      if(!macroDomRefs || !macroDomRefs.fill) return;
      const { container } = macroDomRefs.fill;
      if(!container) return;
      const fragment = document.createDocumentFragment();
      (Array.isArray(fillIndicators) ? fillIndicators : []).forEach(indicator=>{
        const block = document.createElement('div');
        block.className = 'macro-indicator';
        const head = document.createElement('div');
        head.className = 'macro-indicator-head';
        head.innerHTML = `<span>${indicator.label}</span><span>${indicator.percent}%</span>`;
        const bar = document.createElement('div');
        bar.className = 'macro-indicator-bar';
        const fillBar = document.createElement('div');
        fillBar.className = 'macro-indicator-fill';
        fillBar.style.width = `${indicator.percent}%`;
        bar.appendChild(fillBar);
        const desc = document.createElement('div');
        desc.className = 'macro-indicator-desc';
        desc.textContent = indicator.description;
        block.append(head, bar, desc);
        fragment.appendChild(block);
      });
      container.replaceChildren(fragment);
    }

    function deriveSocialLabel(title = ''){
      if(!title) return '';
      const cleaned = String(title).trim();
      const patterns = [
        /Abrir\s+(.+)/i,
        /Adicionar link para\s+(.+)/i
      ];
      for(const pattern of patterns){
        const match = cleaned.match(pattern);
        if(match && match[1]){
          return match[1].trim();
        }
      }
      return cleaned;
    }

    function collectHeaderSocialItems(){
      const wrap = document.getElementById('socialIcons');
      if(!wrap) return [];
      const nodes = [...wrap.querySelectorAll('.social-icon')];
      return nodes.map(node=>{
        const label = node.dataset.label || deriveSocialLabel(node.title) || node.dataset.socialKey || '';
        const hasLink = node.classList.contains('has-link');
        const href = node.dataset.href || node.getAttribute('data-href') || '';
        const iconImg = node.querySelector('img');
        let iconInfo;
        if(iconImg){
          iconInfo = { type: 'img', src: iconImg.src, alt: iconImg.alt || label };
        }else{
          const text = node.textContent ? node.textContent.trim() : '';
          iconInfo = { type: 'text', text, fontSize: node.style.fontSize };
        }
        return { label, hasLink, href, iconInfo };
      });
    }

    function updateMacroSocialFromHeader(){
      if(!macroDomRefs?.supplemental?.social) return;
      const { gridEl, summaryEl } = macroDomRefs.supplemental.social;
      if(!gridEl || !summaryEl) return;
      const items = collectHeaderSocialItems();
      if(!items.length){
        gridEl.replaceChildren();
        const empty = document.createElement('div');
        empty.className = 'macro-social-item';
        empty.innerHTML = '<div class="macro-social-info"><span class="macro-social-label">Nenhuma rede social mapeada.</span><span class="macro-social-detail">Adicione links nos √≠cones do topo para come√ßar.</span></div>';
        gridEl.appendChild(empty);
        summaryEl.textContent = 'Nenhuma rede social configurada.';
        return;
      }

      const frag = document.createDocumentFragment();
      let connected = 0;
      items.forEach(item=>{
        if(item.hasLink) connected += 1;
        const card = document.createElement('div');
        card.className = 'macro-social-item';
        card.dataset.status = item.hasLink ? 'ok' : 'missing';

        const icon = document.createElement('div');
        icon.className = 'macro-social-icon';
        if(item.iconInfo?.type === 'img' && item.iconInfo.src){
          const img = document.createElement('img');
          img.src = item.iconInfo.src;
          img.alt = item.iconInfo.alt || item.label || '';
          icon.appendChild(img);
        }else if(item.iconInfo?.type === 'text' && item.iconInfo.text){
          icon.textContent = item.iconInfo.text;
          if(item.iconInfo.fontSize){
            icon.style.fontSize = item.iconInfo.fontSize;
          }
        }

        const info = document.createElement('div');
        info.className = 'macro-social-info';
        const labelEl = document.createElement('span');
        labelEl.className = 'macro-social-label';
        labelEl.textContent = item.label || 'Rede social';
        const statusEl = document.createElement('span');
        const statusKey = item.hasLink ? 'ok' : 'missing';
        statusEl.className = `macro-social-status ${statusKey}`;
        statusEl.textContent = statusKey === 'ok' ? 'OK' : 'Indispon√≠vel';
        const detailEl = document.createElement('span');
        detailEl.className = 'macro-social-detail';
        detailEl.textContent = statusKey === 'ok' ? 'Link conectado' : 'Falta adicionar';
        info.append(labelEl, statusEl, detailEl);

        const actions = document.createElement('div');
        actions.className = 'macro-social-actions';
        const openBtn = document.createElement('button');
        openBtn.type = 'button';
        openBtn.className = 'macro-social-open';
        openBtn.textContent = 'Abrir';
        if(item.hasLink && item.href){
          openBtn.addEventListener('click', ()=>{
            const win = window.open(item.href, '_blank');
            if(win){
              win.opener = null;
            }else{
              window.location.href = item.href;
            }
          });
        }else{
          openBtn.disabled = true;
          openBtn.title = 'Falta adicionar link';
        }
        actions.appendChild(openBtn);

        card.append(icon, info, actions);
        frag.appendChild(card);
      });

      gridEl.replaceChildren(frag);
      const total = items.length;
      summaryEl.textContent = `${connected} de ${total} redes conectadas.`;
    }

    function updateMacroSupplemental(supplemental){
      if(!macroDomRefs || !macroDomRefs.supplemental) return;
      const { metrics, lists, social } = macroDomRefs.supplemental;

      const cacData = supplemental?.cac || {};
      if(metrics?.cac){
        if(metrics.cac.titleEl){
          metrics.cac.titleEl.textContent = cacData.title || 'CAC do m√™s';
        }
        if(metrics.cac.valueEl){
          metrics.cac.valueEl.textContent = cacData.value || '‚Äî';
        }
        if(metrics.cac.detailEl){
          metrics.cac.detailEl.textContent = cacData.detail || ' ';
        }
      }

      const referencesData = supplemental?.references || {};
      if(metrics?.references){
        if(metrics.references.titleEl){
          metrics.references.titleEl.textContent = referencesData.title || 'Refer√™ncias cadastradas';
        }
        if(metrics.references.valueEl){
          metrics.references.valueEl.textContent = referencesData.value || '0';
        }
        if(metrics.references.detailEl){
          metrics.references.detailEl.textContent = referencesData.detail || ' ';
        }
      }

      const renderList = (ref, payload)=>{
        if(!ref) return;
        const { listEl, emptyEl } = ref;
        if(!listEl || !emptyEl) return;
        const items = Array.isArray(payload?.items) ? payload.items : [];
        if(items.length){
          const frag = document.createDocumentFragment();
          items.forEach(item=>{
            const row = document.createElement('div');
            row.className = 'macro-list-item';
            const titleEl = document.createElement('strong');
            titleEl.textContent = item.title || '‚Äî';
            row.appendChild(titleEl);
            if(item.subtitle){
              const subtitleEl = document.createElement('span');
              subtitleEl.textContent = item.subtitle;
              row.appendChild(subtitleEl);
            }
            frag.appendChild(row);
          });
          listEl.replaceChildren(frag);
          listEl.style.display = '';
          emptyEl.textContent = '';
          emptyEl.style.display = 'none';
        }else{
          listEl.replaceChildren();
          listEl.style.display = 'none';
          emptyEl.textContent = payload?.emptyMessage || 'Nenhum registro encontrado.';
          emptyEl.style.display = 'block';
        }
      };

      renderList(lists?.notes, supplemental?.notes);
      renderList(lists?.files, supplemental?.files);
      renderList(lists?.competitors, supplemental?.competitors);

      if(social){
        updateMacroSocialFromHeader();
      }
    }

    function macroInsightsChanged(prev, next){
      if(prev === next) return false;
      if(!prev || !next) return true;
      try{
        return JSON.stringify(prev) !== JSON.stringify(next);
      }catch(err){
        console.warn('macro insights diff', err);
        return true;
      }
    }

    function applyMacroInsights(insights, { render = true } = {}){
      if(!insights) return;
      const previousInsights = lastMacroInsights;
      const changed = macroInsightsChanged(previousInsights, insights);
      lastMacroInsights = insights;
      if(totalScore){
        totalScore.textContent = String(insights.score);
      }
      if(totalCard){
        const rawLevel = (insights.levelKey || '').toLowerCase();
        const normalizedLevel = rawLevel ? rawLevel.normalize('NFD').replace(/[\u0300-\u036f]/g,'') : '';
        totalCard.dataset.level = normalizedLevel;
        totalCard.setAttribute('data-tip', insights.scoreTip || '');
        let levelEl = document.getElementById('totalLevel');
        if(!levelEl){
          levelEl = document.createElement('span');
          levelEl.id = 'totalLevel';
          levelEl.className = 'total-level';
          totalCard.appendChild(levelEl);
        }
        levelEl.textContent = insights.level;
      }
      if(macroBadges){
        const nodes = [];
        MACRO_COMPONENTS.forEach(comp=>{
          const data = insights.components[comp.key];
          if(!data) return;
          const badge = document.createElement('div');
          badge.className = 'macro-insight-badge';
          const dot = document.createElement('span');
          dot.className = 'dot';
          dot.style.background = data.status === 'excelente' ? '#22c55e' : data.status === 'bom' ? '#38bdf8' : data.status === 'aten√ß√£o' ? '#f97316' : '#ef4444';
          const span = document.createElement('span');
          span.textContent = `${comp.title}: ${Math.round(clamp(data.progress || 0, 0, 1)*100)}%`;
          badge.append(dot, span);
          nodes.push(badge);
        });
        macroBadges.replaceChildren(...nodes);
      }
      if(render){
        const dom = ensureMacroDom();
        if(dom){
          updateMacroSummary(insights);
          updateMacroProgress(insights);
          updateMacroTimeline(insights.timeline);
          updateMacroChecklist(insights.checklist);
          updateMacroAlerts(insights.alerts);
          updateMacroMiniCards(insights.miniCards);
          updateMacroFill(insights.fillIndicators);
          updateMacroSupplemental(insights.supplemental);
        }
        clearMacroTabBadge();
        macroPendingRender = false;
      }else if(!render && changed){
        markMacroTabUpdated();
        macroPendingRender = true;
      }
      recordMacroHistory(insights);
      renderHistoryChart();
      renderHistoryLegend();
    }

    function renderDashboard(){
      refreshMacroInsights({ immediate: true });
    }

    function refreshMacroInsights(options = {}){
      const immediate = !!(options && options.immediate);
      if(immediate){
        if(macroRefreshTimer){
          clearTimeout(macroRefreshTimer);
          macroRefreshTimer = null;
        }
        applyMacroInsights(computeMacroInsights(), { render: currentSection === 'macro' });
        try{ scheduleNotificationRefresh({ immediate: true }); }
        catch(_err){ }
        return;
      }
      if(macroRefreshTimer){
        clearTimeout(macroRefreshTimer);
      }
      macroRefreshTimer = setTimeout(()=>{
        macroRefreshTimer = null;
        try{
          applyMacroInsights(computeMacroInsights(), { render: currentSection === 'macro' });
        }catch(err){
          console.warn('refreshMacroInsights', err);
        }
        try{ scheduleNotificationRefresh(); }
        catch(_err){ }
      }, MACRO_REFRESH_DEBOUNCE);
    }

    function recordMacroHistory(insights){
      if(!insights) return;
      const records = loadMacroHistory();
      const now = Date.now();
      const snapshot = {
        ts: now,
        score: insights.score,
        components: {}
      };
      MACRO_COMPONENTS.forEach(comp=>{
        snapshot.components[comp.key] = { progress: clamp(insights.components?.[comp.key]?.progress ?? 0, 0, 1) };
      });
      const last = records[records.length-1];
      if(last){
        const diff = Math.abs(now - (last.ts || 0));
        const changed = Math.abs((last.score || 0) - snapshot.score) >= 1
          || MACRO_COMPONENTS.some(comp => Math.abs(((last.components?.[comp.key]?.progress) ?? 0) - snapshot.components[comp.key].progress) >= 0.05);
        if(diff < 1000 * 60 * 60){
          if(changed){
            records[records.length-1] = snapshot;
            saveMacroHistory(records);
          }
          return;
        }
        if(!changed) return;
      }
      records.push(snapshot);
      while(records.length > 120) records.shift();
      saveMacroHistory(records);
    }

    function debounce(fn, d){ let t=null; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),d);} }

    const monthKey = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    function getDefaultMonths(){
      const now=new Date(); const arr=[];
      for(let i=0;i<3;i++){ arr.push(monthKey(new Date(now.getFullYear(), now.getMonth()-i, 1))); }
      return arr;
    }

    function updateHistoryMonthSelect(){
      const { monthSelect } = getMacroHistoryElements();
      if(!monthSelect) return;
      const records = loadMacroHistory();
      const monthsSet = new Set(getDefaultMonths());
      records.forEach(rec=>{
        const dt = safeDate(rec.ts);
        if(!dt) return;
        monthsSet.add(monthKey(dt));
      });
      const months = Array.from(monthsSet).sort();
      monthSelect.innerHTML = '';
      const defaults = getDefaultMonths();
      if(selectedMonths.length === 0){
        selectedMonths = months.filter(m=>defaults.includes(m));
        if(!selectedMonths.length) selectedMonths = months.slice(-3);
      }
      months.forEach(m=>{
        const opt=document.createElement('option');
        opt.value=m;
        opt.textContent=new Date(m+'-01').toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
        if(selectedMonths.includes(m)) opt.selected=true;
        monthSelect.appendChild(opt);
      });
    }

    function bindHistoryMonthSelect(){
      const { monthSelect } = getMacroHistoryElements();
      if(!monthSelect || historyEventsBound) return;
      monthSelect.addEventListener('change', ()=>{
        selectedMonths = Array.from(monthSelect.selectedOptions).map(o=>o.value);
        renderHistoryChart();
      });
      historyEventsBound = true;
    }

    function renderHistoryChart(){
      const { canvas, controls } = getMacroHistoryElements();
      if(currentSection !== 'macro'){
        if(controls) controls.style.display = 'none';
        if(canvas) canvas.style.display = 'none';
        if(historyChart){ historyChart.destroy(); historyChart = null; }
        return;
      }
      if(!canvas || typeof Chart==='undefined') return;
      bindHistoryMonthSelect();
      updateHistoryMonthSelect();
      const records = loadMacroHistory();
      if(!records.length){
        if(historyChart){ historyChart.destroy(); historyChart = null; }
        if(controls) controls.style.display = 'none';
        canvas.style.display = 'none';
        return;
      }
      canvas.style.display = 'block';
      if(controls) controls.style.display = 'block';
      const filterSet = new Set(selectedMonths.length?selectedMonths:getDefaultMonths());
      const datasets = MACRO_COMPONENTS.map((comp,i)=>{
        const data = records
          .filter(rec=>{
            const dt = safeDate(rec.ts);
            return dt && filterSet.has(monthKey(dt));
          })
          .map(rec=>{
            const dt = safeDate(rec.ts);
            return { x: dt, y: Math.round(clamp(rec.components?.[comp.key]?.progress ?? 0, 0, 1) * 10) };
          });
        return {
          label: comp.title,
          data,
          borderColor: HISTORY_COLORS[i % HISTORY_COLORS.length],
          fill: false,
          tension: 0.25
        };
      });
      const cfg = {
        type: 'line',
        data: { datasets },
        options: {
          responsive: true,
          parsing: false,
          scales: {
            x: { type: 'time', time: { unit: 'month' } },
            y: { min: 0, max: 10 }
          },
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const pct = Math.round((ctx.raw?.y || 0) * 10);
                  return `${ctx.dataset.label}: ${pct}%`;
                }
              }
            }
          }
        }
      };
      if(historyChart){ historyChart.destroy(); }
      historyChart = new Chart(canvas, cfg);
    }

    function renderHistoryLegend(){
      const { legend } = getMacroHistoryElements();
      if(!legend) return;
      if(currentSection !== 'macro'){
        legend.style.display = 'none';
        return;
      }
      legend.style.display = 'flex';
      legend.innerHTML='';
      MACRO_COMPONENTS.forEach((c,i)=>{
        const item=document.createElement('div');
        item.className='legend-item';
        item.innerHTML=`<span class="legend-line" style="background:${HISTORY_COLORS[i % HISTORY_COLORS.length]}"></span><span>${c.title}</span>`;
        legend.appendChild(item);
      });
    }

    /* ========= se√ß√µes ========= */
    const SECTIONS = [
      { id:"macro",    name:"Macro" },
      { id:"estruturacao", name:"Estrutura√ß√£o" },
      { id:"demandas",  name:"Planejamento" },
      { id:"ia",        name:"I.A" },
      { id:"calendar",  name:"Calend√°rio" },
      { id:"metas",     name:"Metas" },
      { id:"leads",     name:"Leads" },
      { id:"notes",     name:"Anota√ß√µes" },
      { id:"teamNotes", name:"Notas Time" },
      { id:"reunioes",  name:"Reuni√µes" },
      { id:"access",    name:"Acessos" },
      { id:"arquivos",  name:"Arquivos" },
      { id:"relatorio", name:"Relat√≥rio" }
    ];
    // Sempre iniciar na aba "macro" ao carregar a p√°gina
    let currentSection = "macro";
    if(currentSection==="other") currentSection="demandas";
    let USER_DATA = {};
    let CLIENT_PROFILE = {};
    if(window.googleCalendarIntegration){
      window.googleCalendarIntegration.updateConfigFromProfile(CLIENT_PROFILE);
    }
    let clientDocPathParts = null;
    let clientDocUnsub = null;
    let profileLogoUploading = false;
    let widgetsRenderedSection = null;
    let trafegoInitialized = false;
    const sectionScroll = {};
    let iaHistoryScrollPos = 0; // Salva posi√ß√£o de scroll da √°rea de hist√≥rico IA

    function clearMacroTabBadge(){
      macroTabHasUpdate = false;
      if(macroTabBadgeEl){
        macroTabBadgeEl.hidden = true;
      }
    }

    function markMacroTabUpdated(){
      if(currentSection === 'macro') return;
      macroTabHasUpdate = true;
      if(macroTabBadgeEl){
        macroTabBadgeEl.hidden = false;
      }
    }

    function syncMacroTabBadge(){
      if(!macroTabBadgeEl) return;
      macroTabBadgeEl.hidden = !macroTabHasUpdate;
    }

    function setActiveTab(sectionId, { restoreScroll = true } = {}){
      if(!sectionId) return;
      const target = String(sectionId);
      const prevSection = currentSection;
      
      // Salvar posi√ß√£o de scroll da √°rea IA antes de sair
      if(prevSection === 'ia' && iaHistory){
        iaHistoryScrollPos = iaHistory.scrollTop || 0;
      }
      
      // Se saindo da aba de estrutura√ß√£o, for√ßar blur e salvamento
      if(prevSection === 'estruturacao' && target !== 'estruturacao'){
        if(typeof blurActiveEstruturacaoFields === 'function'){
          blurActiveEstruturacaoFields();
        }
        // For√ßar salvamento imediato se houver altera√ß√µes pendentes
        if(typeof persistEstruturacaoImmediate === 'function' && estruturacaoPendingSave){
          persistEstruturacaoImmediate();
        }
      }
      
      if(prevSection !== target){
        sectionScroll[prevSection] = window.scrollY || document.documentElement.scrollTop || 0;
        currentSection = target;
        localStorage.setItem("mg_currentSection", currentSection);
      }
      if(currentSection === 'macro'){
        clearMacroTabBadge();
        if(macroPendingRender){
          try{ refreshMacroInsights({ immediate: true }); }catch(_err){}
        }
      }
      if(sectionTabs){
        const buttons = [...sectionTabs.children];
        buttons.forEach(el=>{ el.classList.remove("active"); el.setAttribute("aria-selected","false"); });
        const btn = sectionTabs.querySelector(`.tab-btn[data-section="${target}"]`);
        if(btn){
          btn.classList.add("active");
          btn.setAttribute("aria-selected","true");
        }
      }
      rerenderBySection();
      if(restoreScroll){
        const y = sectionScroll[currentSection] || 0;
        requestAnimationFrame(()=> window.scrollTo(0, y));
      }
    }
    window.setActiveTab = setActiveTab;

    const MACRO_AUTO_OPEN_EVENT = "macro:auto-open";
    function triggerMacroAutoOpen(options = {}){
      const force = !!(options && options.force);
      if(force){
        macroAutoOpenPending = false;
        setActiveTab("macro", { restoreScroll: false });
        return;
      }
      if(!macroAutoOpenPending) return;
      macroAutoOpenPending = false;
      if(currentSection !== 'macro'){
        setActiveTab("macro", { restoreScroll: false });
      }else{
        clearMacroTabBadge();
      }
    }
    window.triggerMacroAutoOpen = triggerMacroAutoOpen;
    window.addEventListener(MACRO_AUTO_OPEN_EVENT, (event)=>{
      try{
        const detail = event && typeof event.detail === 'object' ? event.detail : {};
        triggerMacroAutoOpen(detail);
      }catch(err){
        console.warn("macro:auto-open handler", err);
      }
    });

    const SOCIAL_ICONS = {
      googleAds: { src: "https://www.google.com/s2/favicons?sz=64&domain=ads.google.com" },
      metaAds: { src: "https://www.google.com/s2/favicons?sz=64&domain=business.facebook.com" },
      instagram: { src: "https://www.google.com/s2/favicons?sz=64&domain=instagram.com", title: "Instagram" },
      website: { src: "https://www.google.com/s2/favicons?sz=64&domain=example.com", title: "Site" },
      tiktok: { src: "https://www.google.com/s2/favicons?sz=64&domain=tiktok.com", title: "TikTok" },
      facebook: { src: "https://www.google.com/s2/favicons?sz=64&domain=facebook.com", title: "Facebook" },
      youtube: { src: "https://www.google.com/s2/favicons?sz=64&domain=youtube.com", title: "YouTube" },
      linkedin: { src: "https://www.google.com/s2/favicons?sz=64&domain=linkedin.com", title: "LinkedIn" },
      whatsapp: { src: "https://www.google.com/s2/favicons?sz=64&domain=whatsapp.com", title: "WhatsApp" },
      googleBusiness: { src: "https://www.google.com/s2/favicons?sz=64&domain=business.google.com" },
      pinterest: { src: "https://www.google.com/s2/favicons?sz=64&domain=pinterest.com" },
      chart: { emoji: "üìà", title: "CRM" }
    };
    let SOCIAL_LINKS = {};

    function loadSocialLinksFromUserData(){
      SOCIAL_LINKS = USER_DATA.socialLinks && typeof USER_DATA.socialLinks === 'object' ? { ...USER_DATA.socialLinks } : {};
    }

    async function persistSocialLinks(){
      const uid = auth.currentUser?.uid;
      if(!uid) return;
      USER_DATA.socialLinks = SOCIAL_LINKS;
      await setDoc(doc(db, "usuarios", uid), { socialLinks: SOCIAL_LINKS }, { merge: true });
    }

    function renderSocialIcons(){
      const wrap = $("socialIcons");
      if(!wrap) return;
      wrap.innerHTML = "";
      Object.entries(SOCIAL_ICONS).forEach(([key, info]) => {
        const span = document.createElement("span");
        span.className = "social-icon" + (SOCIAL_LINKS[key] ? " has-link" : "");
        const label = info.title || key;
        span.dataset.socialKey = key;
        span.dataset.label = label;
        if(SOCIAL_LINKS[key]){
          span.dataset.href = SOCIAL_LINKS[key];
        }
        span.title = SOCIAL_LINKS[key] ? `Abrir ${label}` : `Adicionar link para ${label}`;
        if(info.src){
          const img = document.createElement("img");
          img.src = info.src;
          img.alt = label;
          span.appendChild(img);
        } else if(info.emoji){
          span.textContent = info.emoji;
          span.style.fontSize = "18px";
        }
        span.addEventListener("click", () => {
          const current = SOCIAL_LINKS[key];
          if(current){
            const newWindow = window.open(current, "_blank");
            if(newWindow){
              newWindow.opener = null;
            } else {
              window.location.href = current;
            }
          } else {
            const link = prompt(`Informe o link para ${label}:`, "https://");
            if(link){
              SOCIAL_LINKS[key] = link;
              persistSocialLinks();
              renderSocialIcons();
            }
          }
        });
        wrap.appendChild(span);
      });
      updateMacroSocialFromHeader();
      try{ refreshMacroInsights(); }catch(_err){}
    }

    /* ========= impedimentos ========= */
    const IMPEDIMENT_STATUS_OPTIONS = [
      { value: 'pending', label: 'Ainda n√£o resolvido' },
      { value: 'resolved', label: 'Resolvido' }
    ];
    const IMPEDIMENT_STATUS_VALUES = new Set(IMPEDIMENT_STATUS_OPTIONS.map(opt => opt.value));
    let IMPEDIMENT_ALERTS = [];
    const IMPEDIMENTS_SAVE_DEBOUNCE_MS = 800;
    let impedimentsSaveTimer = null;
    let impedimentsSavePending = false;
    let impedimentsSaveInFlight = false;
    let impedimentsSaveQueued = false;
    let lastImpedimentsSignature = '';
    let lastRemoteImpedimentsSignature = '';
    
    function computeImpedimentsSignature(list){
      if(!Array.isArray(list) || list.length === 0) return '[]';
      return list.map(item => {
        const id = item && typeof item.id === 'string' ? item.id : '';
        const text = item && typeof item.descricao === 'string' ? item.descricao.trim() : '';
        const status = item && typeof item.status === 'string' ? item.status : 'pending';
        return `${id}|${text}|${status}`;
      }).join('||');
    }
    
    function fallbackUUID(){
      return `imp-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;
    }
    
    function createImpediment(data={}){
      const baseId = typeof data.id === 'string' && data.id ? data.id : (typeof uuid === 'function' ? uuid() : fallbackUUID());
      const statusValue = typeof data.status === 'string' && IMPEDIMENT_STATUS_VALUES.has(data.status) ? data.status : 'pending';
      return {
        id: baseId,
        descricao: typeof data.descricao === 'string' ? data.descricao : '',
        status: statusValue
      };
    }
    
    function applyImpedimentsFromSource(source, { fromRemote=false }={}){
      const list = Array.isArray(source) ? source : [];
      IMPEDIMENT_ALERTS = list.map(item => createImpediment(item));
      if(!IMPEDIMENT_ALERTS.length){
        IMPEDIMENT_ALERTS.push(createImpediment());
      }
      const signature = computeImpedimentsSignature(IMPEDIMENT_ALERTS);
      lastImpedimentsSignature = signature;
      if(fromRemote){
        lastRemoteImpedimentsSignature = signature;
        if(impedimentsSaveTimer){
          clearTimeout(impedimentsSaveTimer);
          impedimentsSaveTimer = null;
        }
        impedimentsSavePending = false;
        impedimentsSaveQueued = false;
      }
    }
    
    function loadImpedimentsFromUserData(){
      const source = USER_DATA && Array.isArray(USER_DATA.impediments) ? USER_DATA.impediments : [];
      applyImpedimentsFromSource(source, { fromRemote:true });
    }
    
    function updateImpedimentsSignature(){
      lastImpedimentsSignature = computeImpedimentsSignature(IMPEDIMENT_ALERTS);
    }
    
    function renderImpediments(){
      const section = $('impedimentosSection');
      const tbody = $('impedimentosBody');
      const empty = $('impedimentosEmpty');
      if(!tbody){ return; }
      if(!Array.isArray(IMPEDIMENT_ALERTS) || !IMPEDIMENT_ALERTS.length){
        IMPEDIMENT_ALERTS = [createImpediment()];
      }
      tbody.innerHTML = '';
      IMPEDIMENT_ALERTS.forEach(item => {
        const tr = document.createElement('tr');
        tr.dataset.id = item.id;
        tr.dataset.status = item.status;
        const iconTd = document.createElement('td');
        iconTd.className = 'icon-cell';
        const iconSpan = document.createElement('span');
        iconSpan.setAttribute('role','img');
        iconSpan.setAttribute('aria-label','Alerta de aten√ß√£o');
        iconSpan.textContent = '‚ö†Ô∏è';
        iconTd.appendChild(iconSpan);
        const descTd = document.createElement('td');
        const textarea = document.createElement('textarea');
        textarea.placeholder = 'Descreva o impedimento identificado (ex.: atraso no fornecedor, falta de or√ßamento, cliente sem aprova√ß√£o).';
        textarea.value = item.descricao || '';
        textarea.addEventListener('input', ()=>{
          item.descricao = textarea.value;
          updateImpedimentsSignature();
          scheduleImpedimentsPersist();
        });
        textarea.addEventListener('blur', ()=>{
          item.descricao = textarea.value;
          updateImpedimentsSignature();
          scheduleImpedimentsPersist({ immediate:true });
        });
        descTd.appendChild(textarea);
        const statusTd = document.createElement('td');
        const statusWrap = document.createElement('div');
        statusWrap.className = 'impedimentos-status-wrap';
        const select = document.createElement('select');
        IMPEDIMENT_STATUS_OPTIONS.forEach(opt => {
          const option = document.createElement('option');
          option.value = opt.value;
          option.textContent = opt.label;
          if(item.status === opt.value){ option.selected = true; }
          select.appendChild(option);
        });
        select.addEventListener('change', ()=>{
          item.status = select.value;
          tr.dataset.status = item.status;
          updateImpedimentsSignature();
          scheduleImpedimentsPersist();
        });
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'impedimentos-remove';
        removeBtn.setAttribute('aria-label','Remover impedimento');
        removeBtn.textContent = 'Remover';
        removeBtn.addEventListener('click', ()=>{
          IMPEDIMENT_ALERTS = IMPEDIMENT_ALERTS.filter(entry => entry.id !== item.id);
          if(!IMPEDIMENT_ALERTS.length){
            IMPEDIMENT_ALERTS.push(createImpediment());
          }
          updateImpedimentsSignature();
          renderImpediments();
          scheduleImpedimentsPersist({ immediate:true });
        });
        statusWrap.appendChild(select);
        statusWrap.appendChild(removeBtn);
        statusTd.appendChild(statusWrap);
        tr.appendChild(iconTd);
        tr.appendChild(descTd);
        tr.appendChild(statusTd);
        tbody.appendChild(tr);
      });
      if(section){
        section.classList.toggle('empty', !IMPEDIMENT_ALERTS.length);
      }
      if(empty){
        empty.style.display = IMPEDIMENT_ALERTS.length ? 'none' : 'block';
      }
    }
    
    function sanitizeImpedimentsPayload(){
      return (Array.isArray(IMPEDIMENT_ALERTS) ? IMPEDIMENT_ALERTS : []).map(item => ({
        id: item.id,
        descricao: typeof item.descricao === 'string' ? item.descricao : '',
        status: IMPEDIMENT_STATUS_VALUES.has(item.status) ? item.status : 'pending'
      }));
    }
    
    async function persistImpediments(){
      const uid = auth?.currentUser?.uid;
      const payload = sanitizeImpedimentsPayload();
      USER_DATA.impediments = payload;
      if(!uid) return;
      try{
        await setDoc(doc(db,'usuarios',uid), { impediments: payload }, { merge:true });
      }catch(err){
        console.error('Erro ao salvar impedimentos', err);
        throw err;
      }
    }
    
    async function flushImpedimentsPersist(){
      if(impedimentsSaveTimer){
        clearTimeout(impedimentsSaveTimer);
        impedimentsSaveTimer = null;
      }
      if(impedimentsSaveInFlight){
        impedimentsSaveQueued = true;
        return;
      }
      if(!impedimentsSavePending){
        return;
      }
      impedimentsSavePending = false;
      impedimentsSaveInFlight = true;
      try{
        await persistImpediments();
      }finally{
        impedimentsSaveInFlight = false;
        if(impedimentsSaveQueued){
          impedimentsSaveQueued = false;
          scheduleImpedimentsPersist({ immediate:true });
        }
      }
    }
    
    function scheduleImpedimentsPersist({ immediate=false }={}){
      impedimentsSavePending = true;
      if(impedimentsSaveTimer){
        clearTimeout(impedimentsSaveTimer);
        impedimentsSaveTimer = null;
      }
      if(immediate){
        flushImpedimentsPersist();
        return;
      }
      impedimentsSaveTimer = setTimeout(()=>{ flushImpedimentsPersist(); }, IMPEDIMENTS_SAVE_DEBOUNCE_MS);
    }

    const MAX_PROFILE_LOGO_SIZE = 5 * 1024 * 1024;

    function formatClientDisplayName(value){
      if(!value) return "";
      return value.replace(/[_-]+/g, " ").trim().toUpperCase();
    }

    function attachClientDocListener(parts){
      if(clientDocUnsub){
        try{ clientDocUnsub(); }catch(_e){}
        clientDocUnsub = null;
      }
      if(!Array.isArray(parts)) return;
      try{
        const ref = doc(db, ...parts);
        clientDocUnsub = onSnapshot(ref, (snap)=>{
          CLIENT_PROFILE = snap.exists() ? (snap.data() || {}) : {};
          if(window.googleCalendarIntegration){
            window.googleCalendarIntegration.updateConfigFromProfile(CLIENT_PROFILE);
          }
          clientDocPathParts = parts;
          syncStorageLimitFromProfile();
          updateProfileAvatar();
          triggerMacroAutoOpen();
        }, (err)=>{
          console.warn('clientDoc listener', err);
        });
      }catch(err){
        console.warn('attachClientDocListener', err);
      }
    }

    function updateProfileAvatar(){
      if(!profileArea) return;
      const hasUser = !!auth?.currentUser;
      if(!hasUser){
        profileArea.classList.remove('active');
        profileArea.setAttribute('aria-hidden','true');
        if(profileAvatar){
          profileAvatar.classList.remove('has-image','uploading');
          profileAvatar.disabled = true;
          profileAvatar.setAttribute('aria-label','Adicionar logo do cliente');
          profileAvatar.setAttribute('title','Adicionar logo do cliente');
        }
        if(profileAvatarImg){
          profileAvatarImg.removeAttribute('src');
        }
        if(profileClientName){
          profileClientName.textContent = '';
        }
        if(profileAvatarPlaceholder){
          profileAvatarPlaceholder.textContent = '+';
        }
        return;
      }
      profileArea.classList.add('active');
      profileArea.setAttribute('aria-hidden','false');
      const clientKey = getClientKey() || '';
      if(profileClientName){
        profileClientName.textContent = clientKey ? formatClientDisplayName(clientKey) : '';
      }
      const logoUrl = CLIENT_PROFILE?.profileLogoUrl || '';
      if(profileAvatar){
        profileAvatar.classList.toggle('has-image', !!logoUrl);
        profileAvatar.classList.toggle('uploading', profileLogoUploading);
        profileAvatar.disabled = !!profileLogoUploading;
        const label = logoUrl ? 'Atualizar logo do cliente' : 'Adicionar logo do cliente';
        profileAvatar.setAttribute('aria-label', label);
        profileAvatar.setAttribute('title', label);
      }
      if(profileAvatarImg){
        if(logoUrl){
          if(profileAvatarImg.src !== logoUrl){
            profileAvatarImg.src = logoUrl;
          }
        }else{
          profileAvatarImg.removeAttribute('src');
        }
      }
      if(profileAvatarPlaceholder){
        profileAvatarPlaceholder.textContent = clientKey ? clientKey.charAt(0).toUpperCase() : '+';
      }
    }

    async function loadClientProfile(){
      // Resetar estado das reuni√µes ao mudar de cliente
      if (typeof resetReunioesState === 'function') {
        resetReunioesState();
      }
      
      if(!auth?.currentUser){
        CLIENT_PROFILE = {};
        if(window.googleCalendarIntegration){
          window.googleCalendarIntegration.updateConfigFromProfile(CLIENT_PROFILE);
        }
        clientDocPathParts = null;
        if(clientDocUnsub){
          try{ clientDocUnsub(); }catch(_e){}
          clientDocUnsub = null;
        }
        syncStorageLimitFromProfile();
        updateProfileAvatar();
        refreshMetasFormSubscription();
        return;
      }
      const uid = auth.currentUser.uid;
      const clientKey = getClientKey();
      if(!clientKey){
        CLIENT_PROFILE = {};
        if(window.googleCalendarIntegration){
          window.googleCalendarIntegration.updateConfigFromProfile(CLIENT_PROFILE);
        }
        clientDocPathParts = null;
        if(clientDocUnsub){
          try{ clientDocUnsub(); }catch(_e){}
          clientDocUnsub = null;
        }
        syncStorageLimitFromProfile();
        updateProfileAvatar();
        refreshMetasFormSubscription();
        return;
      }
      const safeKey = clientKey.replace(/[^\w-]/g,'_');
      let targetKey = safeKey || clientKey;
      try{
        let snap = await getDoc(doc(db, 'usuarios', uid, 'clients', safeKey));
        if(!snap.exists() && safeKey !== clientKey){
          snap = await getDoc(doc(db, 'usuarios', uid, 'clients', clientKey));
          if(snap.exists()){
            targetKey = clientKey;
          }
        }
        CLIENT_PROFILE = snap?.exists() ? (snap.data() || {}) : {};
        if(window.googleCalendarIntegration){
          window.googleCalendarIntegration.updateConfigFromProfile(CLIENT_PROFILE);
        }
        syncStorageLimitFromProfile();
      }catch(err){
        console.warn('loadClientProfile', err);
        CLIENT_PROFILE = CLIENT_PROFILE || {};
        if(window.googleCalendarIntegration){
          window.googleCalendarIntegration.updateConfigFromProfile(CLIENT_PROFILE);
        }
        syncStorageLimitFromProfile();
      }
      const pathParts = ['usuarios', uid, 'clients', targetKey];
      clientDocPathParts = pathParts;
      attachClientDocListener(pathParts);
      updateProfileAvatar();
      refreshMetasFormSubscription();
    }

    function ensureProfileStorage(){
      if(STORAGE) return STORAGE;
      try{
        STORAGE = getStorage(app);
      }catch(err){
        console.warn('ensureProfileStorage', err);
      }
      return STORAGE;
    }

    async function uploadClientLogo(file){
      if(!file) return;
      if(!auth?.currentUser){
        alert('Fa√ßa login para enviar a logo.');
        return;
      }
      const uid = auth.currentUser.uid;
      const clientKey = getClientKey();
      if(!clientKey){
        alert('Cliente n√£o identificado.');
        return;
      }
      if(file.size > MAX_PROFILE_LOGO_SIZE){
        alert('Selecione uma imagem de at√© 5MB.');
        return;
      }
      const storage = ensureProfileStorage();
      if(!storage){
        alert('Armazenamento indispon√≠vel no momento.');
        return;
      }
      const safeKey = clientKey.replace(/[^\w-]/g,'_');
      const previousPath = CLIENT_PROFILE?.profileLogoStoragePath || null;
      profileLogoUploading = true;
      updateProfileAvatar();
      try{
        const rawExt = (file.name || '').split('.').pop() || '';
        const ext = rawExt.toLowerCase().replace(/[^a-z0-9]/g,'');
        const finalExt = ext ? ext.slice(0,8) : 'png';
        const storagePath = `usuarios/${uid}/clients/${safeKey}/profile/logo-${Date.now()}.${finalExt}`;
        const storageRef = sRef(storage, storagePath);
        await uploadBytes(storageRef, file, { contentType: file.type || undefined });
        const url = await getDownloadURL(storageRef);
        const docParts = clientDocPathParts || ['usuarios', uid, 'clients', safeKey];
        await setDoc(doc(db, ...docParts), {
          profileLogoUrl: url,
          profileLogoStoragePath: storagePath,
          profileLogoUpdatedAt: serverTimestamp()
        }, { merge: true });
        CLIENT_PROFILE = {
          ...(CLIENT_PROFILE || {}),
          profileLogoUrl: url,
          profileLogoStoragePath: storagePath
        };
        updateProfileAvatar();
        if(previousPath && previousPath !== storagePath){
          try{ await deleteObject(sRef(storage, previousPath)); }
          catch(err){ console.warn('delete previous logo', err); }
        }
        if(typeof mgToast === 'function'){ mgToast('Logo atualizada!'); }
      }catch(err){
        console.error('uploadClientLogo', err);
        alert('N√£o foi poss√≠vel enviar a logo. Tente novamente.');
      }finally{
        profileLogoUploading = false;
        if(profileAvatarInput){ profileAvatarInput.value = ''; }
        updateProfileAvatar();
      }
    }

    updateProfileAvatar();

    profileAvatar?.addEventListener('click', ()=>{
      if(profileLogoUploading) return;
      if(!auth?.currentUser){
        alert('Fa√ßa login para adicionar a logo.');
        return;
      }
      profileAvatarInput?.click();
    });

    profileAvatarInput?.addEventListener('change', (event)=>{
      const file = event.target?.files?.[0] || null;
      if(event.target){ event.target.value = ''; }
      if(!file) return;
      uploadClientLogo(file);
    });

    function setSectionVisibility({widgets=false, demandas=false, notes=false, briefing=false, access=false, calendar=false, metas=false, trafego=false, files=false, ia=false, concorrentes=false, refSocial=false, cac=false, leads=false, relatorio=false, estruturacao=false, teamNotes=false, reunioes=false}){
      widgetsGrid.style.display = widgets? "flex":"none";
      iframeDica.style.display  = widgets? "block":"none";
      metasWrap.style.display = metas? "block":"none"; metasWrap.setAttribute("aria-hidden", metas? "false":"true");
      demandasWrap.style.display = demandas? "block":"none"; demandasWrap.setAttribute("aria-hidden", demandas? "false":"true");
      notesWrap.style.display   = notes? "flex":"none";  notesWrap.setAttribute("aria-hidden", notes? "false":"true");
      calendarWrap.style.display = calendar? "flex":"none"; calendarWrap.setAttribute("aria-hidden", calendar? "false":"true");
      briefWrap.style.display   = briefing? "flex":"none"; briefWrap.setAttribute("aria-hidden", briefing? "false":"true");
      accessWrap.style.display  = access? "flex":"none";  accessWrap.setAttribute("aria-hidden", access? "false":"true");
      filesWrap.style.display   = files? "flex":"none";  filesWrap.setAttribute("aria-hidden", files? "false":"true");
      iaWrap.style.display      = ia? "block":"none"; iaWrap.setAttribute("aria-hidden", ia? "false":"true");
      if(teamNotesWrap){ teamNotesWrap.style.display = teamNotes? "flex":"none"; teamNotesWrap.setAttribute("aria-hidden", teamNotes? "false":"true"); }
      if(reunioesWrap){ reunioesWrap.style.display = reunioes? "flex":"none"; reunioesWrap.setAttribute("aria-hidden", reunioes? "false":"true"); }
      
      // Ao entrar na aba I.A, sempre usar a √∫ltima conversa (mais recente)
      if(ia){
        setTimeout(() => {
          if(typeof CURRENT_CHAT !== 'undefined' && typeof IA_CHATS !== 'undefined'){
            // Se n√£o houver nenhuma conversa, criar uma nova
            if(!CURRENT_CHAT && IA_CHATS.length === 0 && typeof newIAChat === 'function'){
              console.log('üìù Nenhuma conversa encontrada - criando primeira conversa');
              newIAChat();
            } else if(IA_CHATS.length > 0 && CURRENT_CHAT !== IA_CHATS[0]){
              // Se existem conversas, sempre usar a mais recente (primeira do array j√° ordenado)
              CURRENT_CHAT = IA_CHATS[0];
              console.log(`‚úÖ Continuando na √∫ltima conversa: "${CURRENT_CHAT.title || 'Nova conversa'}" (${CURRENT_CHAT.messages?.length || 0} mensagens)`);
              if(typeof renderIAChatList === 'function') renderIAChatList();
              if(typeof renderIAHistory === 'function') renderIAHistory();
            }
          }
        }, 100);
      }
      
      competitorsWrap.style.display = concorrentes? "block":"none"; competitorsWrap.setAttribute("aria-hidden", concorrentes? "false":"true");
      if(estruturacaoWrap) { estruturacaoWrap.style.display = estruturacao? "flex":"none"; estruturacaoWrap.setAttribute("aria-hidden", estruturacao? "false":"true"); }
      refSocialWrap.style.display = refSocial? "block":"none"; refSocialWrap.setAttribute("aria-hidden", refSocial? "false":"true");
      leadsWrap.style.display = leads? "block":"none"; leadsWrap.setAttribute("aria-hidden", leads? "false":"true");
      relatorioWrap.style.display = relatorio? "block":"none"; relatorioWrap.setAttribute("aria-hidden", relatorio? "false":"true");
    }

    const TRAFEGO_STATUS_OPTIONS = [
      { value: 'ativa', label: 'Ativa' },
      { value: 'teste', label: 'Em teste' },
      { value: 'pausada', label: 'Pausada' },
      { value: 'escalar', label: 'Escalar' },
      { value: 'revisar-criativo', label: 'Rever criativo' }
    ];
    const TRAFEGO_CAMPAIGN_STATUS_OPTIONS = [
      { value: 'nao-testada', label: 'Ainda n√£o testada' },
      { value: 'ja-testada', label: 'J√° testada' },
      { value: 'pausada', label: 'Pausada' },
      { value: 'aprovado', label: 'Aprovado pelo cliente' },
      { value: 'nao-aprovado', label: 'N√£o aprovado' }
    ];
    const TRAFEGO_PLATFORM_OPTIONS = [
      { value: 'meta', label: 'Meta' },
      { value: 'google', label: 'Google' },
      { value: 'tiktok', label: 'TikTok' },
      { value: 'linkedin', label: 'LinkedIn' },
      { value: 'pinterest', label: 'Pinterest' }
    ];
    const TRAFEGO_OPTIMIZATION_HISTORY_FIELDS = ['platform','campaign','observation','lastOptimization','lastOptimizationDate'];
    const TRAFEGO_OPTIMIZATION_HISTORY_LIMIT = 500;
    const TRAFEGO_OPTIMIZATION_SAVE_TIMEOUT_MS = 15000;
    const TRAFEGO_META_TOPIC_OPTIONS = [
      { value: 'An√∫ncio', label: 'An√∫ncio' },
      { value: 'Copy', label: 'Copy' },
      { value: 'P√∫blico', label: 'P√∫blico' },
      { value: 'Segmenta√ß√£o', label: 'Segmenta√ß√£o' },
      { value: 'Criativo', label: 'Criativo' },
      { value: 'Or√ßamento', label: 'Or√ßamento' },
      { value: 'Lances', label: 'Lances' },
      { value: 'Posicionamento', label: 'Posicionamento' },
      { value: 'Frequ√™ncia', label: 'Frequ√™ncia' },
      { value: 'Pixel', label: 'Pixel' },
      { value: 'Convers√£o', label: 'Convers√£o' },
      { value: 'CTA', label: 'CTA' },
      { value: 'V√≠deo', label: 'V√≠deo' },
      { value: 'Imagem', label: 'Imagem' },
      { value: 'T√≠tulo', label: 'T√≠tulo' },
      { value: 'Descri√ß√£o', label: 'Descri√ß√£o' },
      { value: 'Campanha', label: 'Campanha' },
      { value: 'A/B', label: 'A/B' },
      { value: 'Retargeting', label: 'Retargeting' },
      { value: 'Lookalike', label: 'Lookalike' }
    ];
    const TRAFEGO_OPTIMIZATION_TOPICS = {
      meta: TRAFEGO_META_TOPIC_OPTIONS,
      google: [
        { value: 'Palavras-chave', label: 'Palavras-chave' },
        { value: 'Negativas', label: 'Negativas' },
        { value: 'Extens√µes', label: 'Extens√µes' },
        { value: 'Lances', label: 'Lances' },
        { value: 'An√∫ncio', label: 'An√∫ncio' },
        { value: 'T√≠tulo', label: 'T√≠tulo' },
        { value: 'Descri√ß√£o', label: 'Descri√ß√£o' },
        { value: 'Segmenta√ß√£o', label: 'Segmenta√ß√£o' },
        { value: 'Localiza√ß√£o', label: 'Localiza√ß√£o' },
        { value: 'Dispositivo', label: 'Dispositivo' },
        { value: 'Rede', label: 'Rede' },
        { value: 'Convers√£o', label: 'Convers√£o' },
        { value: 'CPC', label: 'CPC' },
        { value: 'CPL', label: 'CPL' },
        { value: 'CTR', label: 'CTR' },
        { value: 'Campanha', label: 'Campanha' },
        { value: 'Display', label: 'Display' },
        { value: 'Performance Max', label: 'Performance Max' },
        { value: 'Remarketing', label: 'Remarketing' },
        { value: 'A/B', label: 'A/B' }
      ],
      tiktok: [
        { value: 'V√≠deo', label: 'V√≠deo' },
        { value: 'Copy', label: 'Copy' },
        { value: 'M√∫sica', label: 'M√∫sica' },
        { value: 'Segmenta√ß√£o', label: 'Segmenta√ß√£o' },
        { value: 'P√∫blico', label: 'P√∫blico' },
        { value: 'Lances', label: 'Lances' },
        { value: 'Or√ßamento', label: 'Or√ßamento' },
        { value: 'Hashtags', label: 'Hashtags' },
        { value: 'Convers√£o', label: 'Convers√£o' },
        { value: 'CTR', label: 'CTR' },
        { value: 'Campanha', label: 'Campanha' },
        { value: 'Formato', label: 'Formato' },
        { value: 'Criativo', label: 'Criativo' },
        { value: 'Engajamento', label: 'Engajamento' },
        { value: 'Retargeting', label: 'Retargeting' },
        { value: 'Pixel', label: 'Pixel' },
        { value: 'Call-to-Action', label: 'Call-to-Action' },
        { value: 'A/B', label: 'A/B' },
        { value: 'Audi√™ncia', label: 'Audi√™ncia' },
        { value: 'Performance', label: 'Performance' }
      ],
      linkedin: TRAFEGO_META_TOPIC_OPTIONS,
      pinterest: TRAFEGO_META_TOPIC_OPTIONS
    };
    function getTrafficOptimizationTopicOptions(platform){
      const key = typeof platform === 'string' ? platform.toLowerCase() : '';
      return TRAFEGO_OPTIMIZATION_TOPICS[key] || [];
    }

    function normalizeOptimizationTopics(rawTopics, platform){
      const baseOptions = getTrafficOptimizationTopicOptions(platform);
      const allowedValues = new Set(baseOptions.map(opt => opt.value));
      let values = [];
      if(Array.isArray(rawTopics)){
        values = rawTopics;
      }else if(typeof rawTopics === 'string'){
        const trimmed = rawTopics.trim();
        if(trimmed){
          if(trimmed.startsWith('[')){
            try{
              const parsed = JSON.parse(trimmed);
              if(Array.isArray(parsed)){
                values = parsed;
              }else{
                values = [trimmed];
              }
            }catch(_err){
              values = [trimmed];
            }
          }else{
            values = [trimmed];
          }
        }
      }
      const unique = [];
      const seen = new Set();
      values.forEach(value => {
        const str = typeof value === 'string' ? value.trim() : '';
        if(!str || seen.has(str)) return;
        seen.add(str);
        unique.push(str);
      });
      if(!allowedValues.size) return unique;
      const recognized = unique.filter(value => allowedValues.has(value));
      if(recognized.length === unique.length) return recognized;
      const extras = unique.filter(value => !allowedValues.has(value));
      return recognized.concat(extras);
    }

    function normalizeOptimizationTopicValue(rawTopic, platform){
      const topics = normalizeOptimizationTopics(rawTopic, platform);
      if(topics.length) return topics[0];
      if(Array.isArray(rawTopic)){
        for(const value of rawTopic){
          if(typeof value === 'string'){
            const trimmed = value.trim();
            if(trimmed) return trimmed;
          }
        }
      }
      return typeof rawTopic === 'string' ? rawTopic.trim() : '';
    }

    function populateOptimizationTopicOptions(select, platform, selectedTopic = ''){
      if(!select) return;
      const topics = getTrafficOptimizationTopicOptions(platform);
      const normalizedSelected = normalizeOptimizationTopicValue(selectedTopic, platform);
      select.innerHTML = '';
      let hasSelectedOption = false;
      topics.forEach(topic => {
        const option = document.createElement('option');
        option.value = topic.value;
        option.textContent = topic.label;
        if(topic.value === normalizedSelected){
          option.selected = true;
          hasSelectedOption = true;
        }
        select.appendChild(option);
      });
      if(!hasSelectedOption && normalizedSelected){
        const option = document.createElement('option');
        option.value = normalizedSelected;
        option.textContent = normalizedSelected;
        option.selected = true;
        option.hidden = true;
        select.appendChild(option);
      }
      select.multiple = false;
      select.removeAttribute('size');
    }

    const TRAFEGO_OPTIMIZATION_RECURRENCE_OPTIONS = [
      { value: '1-dia', label: '1 dia', days: 1 },
      { value: '2-dias', label: '2 dias', days: 2 },
      { value: '3-dias', label: '3 dias', days: 3 },
      { value: '4-dias', label: '4 dias', days: 4 },
      { value: '5-dias', label: '5 dias', days: 5 },
      { value: '7-dias', label: '7 dias', days: 7 },
      { value: '2-semanas', label: '2 semanas', days: 14 },
      { value: '3-semanas', label: '3 semanas', days: 21 },
      { value: '1-mes', label: '1 m√™s', days: 30 },
      { value: '2-meses', label: '2 meses', days: 60 }
    ];
    const TRAFEGO_OPTIMIZATION_LEGACY_RECURRENCE_MAP = {
      diaria: '1-dia',
      trissemanal: '2-dias',
      bissemanal: '4-dias',
      trimestral: '2-meses'
    };
    const TRAFEGO_OPTIMIZATION_DEFAULT_RECURRENCE = TRAFEGO_OPTIMIZATION_RECURRENCE_OPTIONS[0].value;
    const TRAFEGO_OPTIMIZATION_SAVE_DEBOUNCE_MS = 700;
    const TRAFEGO_HISTORY_SAVE_DEBOUNCE_MS = 700;
    const TRAFEGO_DAY_MS = 24 * 60 * 60 * 1000;
    const TRAFEGO_METRICS_SAVE_DEBOUNCE_MS = 700;
    let TRAFEGO_METRICS = [];
    let trafegoMetricsSaveTimer = null;
    let trafegoMetricsSavePending = false;
    let trafegoMetricsSaveInFlight = false;
    let trafegoMetricsSaveQueued = false;
    let pendingTrafficMetricsSnapshot = null;
    let trafficMetricsLocalSignature = '';
    let trafficMetricsSavedSignature = '';
    let trafficMetricsRemoteSignature = '';
    let TRAFEGO_OPTIMIZATIONS = [];
    let TRAFEGO_OPTIMIZATIONS_LAST_SAVED = [];
    let TRAFEGO_OPTIMIZATION_HISTORY = [];
    let trafegoOptimizationSaveTimer = null;
    let trafegoOptimizationSavePending = false;
    let trafegoOptimizationSaveInFlight = false;
    let trafegoOptimizationSaveQueued = false;
    let pendingTrafficOptimizationSnapshot = null;
    let trafficOptimizationLocalSignature = '';
    let trafficOptimizationSavedSignature = '';
    let trafficOptimizationRemoteSignature = '';
    let trafegoHistorySaveTimer = null;
    let trafegoHistorySavePending = false;
    let trafegoHistorySaveInFlight = false;
    let trafegoHistorySaveQueued = false;
    let pendingTrafficOptimizationHistorySnapshot = null;
    let trafficHistoryLocalSignature = '';
    let trafficHistorySavedSignature = '';
    let trafficHistoryRemoteSignature = '';
    let TRAFEGO_CAMPAIGN_IDEAS = [];
    const TRAFEGO_CAMPAIGNS_SAVE_DEBOUNCE_MS = 700;
    let trafegoCampaignSaveTimer = null;
    let trafegoCampaignSavePending = false;
    let trafegoCampaignSaveInFlight = false;
    let trafegoCampaignSaveQueued = false;
    let pendingTrafficCampaignSnapshot = null;
    let trafficCampaignLocalSignature = '';
    let trafficCampaignSavedSignature = '';
    let trafficCampaignRemoteSignature = '';

    function generateTrafficCampaignId(){
      if(typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function'){
        return `camp-${crypto.randomUUID()}`;
      }
      return 'camp-' + Math.random().toString(36).slice(2) + Date.now().toString(36);
    }

    function normalizeTrafficCampaignIdea(raw = {}){
      const statusValue = typeof raw?.status === 'string' ? raw.status.toLowerCase() : '';
      const validStatus = TRAFEGO_CAMPAIGN_STATUS_OPTIONS.some(opt => opt.value === statusValue) ? statusValue : 'nao-testada';
      return {
        id: typeof raw?.id === 'string' && raw.id ? raw.id : generateTrafficCampaignId(),
        name: typeof raw?.name === 'string' ? raw.name : '',
        budget: raw?.budget === undefined || raw?.budget === null ? '' : String(raw.budget),
        format: typeof raw?.format === 'string' ? raw.format : '',
        observation: typeof raw?.observation === 'string' ? raw.observation : '',
        audience: typeof raw?.audience === 'string' ? raw.audience : '',
        copy: typeof raw?.copy === 'string' ? raw.copy : '',
        objective: typeof raw?.objective === 'string' ? raw.objective : '',
        status: validStatus
      };
    }

    function normalizeTrafficCampaignList(list){
      if(!Array.isArray(list)) return [];
      return list.map(normalizeTrafficCampaignIdea);
    }

    function computeTrafficCampaignSignature(list){
      if(!Array.isArray(list) || !list.length) return '[]';
      return JSON.stringify(list.map(item => ({
        id: item?.id || '',
        name: item?.name || '',
        budget: item?.budget || '',
        format: item?.format || '',
        observation: item?.observation || '',
        audience: item?.audience || '',
        copy: item?.copy || '',
        objective: item?.objective || '',
        status: item?.status || ''
      })));
    }

    function getSanitizedTrafficCampaigns(){
      return TRAFEGO_CAMPAIGN_IDEAS.map(item => ({
        id: item.id,
        name: (item.name || '').trim(),
        budget: (item.budget || '').trim(),
        format: (item.format || '').trim(),
        observation: (item.observation || '').trim(),
        audience: (item.audience || '').trim(),
        copy: (item.copy || '').trim(),
        objective: (item.objective || '').trim(),
        status: TRAFEGO_CAMPAIGN_STATUS_OPTIONS.some(opt => opt.value === item.status) ? item.status : 'nao-testada'
      }));
    }

    function updateTrafficCampaignLocalSignature(){
      trafficCampaignLocalSignature = computeTrafficCampaignSignature(TRAFEGO_CAMPAIGN_IDEAS);
    }

    function escapeTrafficCampaignId(value){
      const str = String(value || '');
      if(typeof CSS !== 'undefined' && typeof CSS.escape === 'function'){
        return CSS.escape(str);
      }
      return str.replace(/[^a-zA-Z0-9_-]/g, '\\$&');
    }

    function campaignMatchesFilters(campaign){
      const statusFilter = trafegoCampaignStatusFilter?.value || 'all';
      if(statusFilter !== 'all' && campaign.status !== statusFilter) return false;
      const term = (trafegoCampaignSearch?.value || '').trim().toLowerCase();
      if(!term) return true;
      const haystack = [campaign.name, campaign.format, campaign.observation, campaign.audience, campaign.copy, campaign.objective]
        .map(part => (part || '').toLowerCase())
        .join(' ');
      return haystack.includes(term);
    }

    function renderTrafficCampaignIdeas(){
      if(!trafegoCampaignsBody) return;
      const filtered = TRAFEGO_CAMPAIGN_IDEAS.filter(campaignMatchesFilters);
      trafegoCampaignsBody.innerHTML = '';
      const frag = document.createDocumentFragment();
      filtered.forEach(idea => {
        const row = document.createElement('tr');
        row.dataset.id = idea.id;

        const nameCell = document.createElement('td');
        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.placeholder = 'Campanha ou conceito';
        nameInput.value = idea.name;
        nameInput.dataset.field = 'name';
        nameCell.appendChild(nameInput);
        row.appendChild(nameCell);

        const budgetCell = document.createElement('td');
        const budgetInput = document.createElement('input');
        budgetInput.type = 'text';
        budgetInput.placeholder = 'R$';
        budgetInput.value = idea.budget;
        budgetInput.dataset.field = 'budget';
        budgetCell.appendChild(budgetInput);
        row.appendChild(budgetCell);

        const formatCell = document.createElement('td');
        const formatInput = document.createElement('input');
        formatInput.type = 'text';
        formatInput.placeholder = 'Ex.: Meta Ads, Google, Reels';
        formatInput.value = idea.format;
        formatInput.dataset.field = 'format';
        formatCell.appendChild(formatInput);
        row.appendChild(formatCell);

        const obsCell = document.createElement('td');
        const obsArea = document.createElement('textarea');
        obsArea.placeholder = 'Insights, aprendizados e alertas';
        obsArea.value = idea.observation;
        obsArea.dataset.field = 'observation';
        obsCell.appendChild(obsArea);
        row.appendChild(obsCell);

        const audienceCell = document.createElement('td');
        const audienceInput = document.createElement('input');
        audienceInput.type = 'text';
        audienceInput.placeholder = 'Segmento ou persona';
        audienceInput.value = idea.audience;
        audienceInput.dataset.field = 'audience';
        audienceCell.appendChild(audienceInput);
        row.appendChild(audienceCell);

        const copyCell = document.createElement('td');
        const copyArea = document.createElement('textarea');
        copyArea.placeholder = 'Copy principal, CTA ou promessa';
        copyArea.value = idea.copy;
        copyArea.dataset.field = 'copy';
        copyCell.appendChild(copyArea);
        row.appendChild(copyCell);

        const objectiveCell = document.createElement('td');
        const objectiveInput = document.createElement('input');
        objectiveInput.type = 'text';
        objectiveInput.placeholder = 'Objetivo de neg√≥cio';
        objectiveInput.value = idea.objective;
        objectiveInput.dataset.field = 'objective';
        objectiveCell.appendChild(objectiveInput);
        row.appendChild(objectiveCell);

        const statusCell = document.createElement('td');
        const statusSelect = document.createElement('select');
        statusSelect.dataset.field = 'status';
        TRAFEGO_CAMPAIGN_STATUS_OPTIONS.forEach(opt => {
          const option = document.createElement('option');
          option.value = opt.value;
          option.textContent = opt.label;
          if(opt.value === idea.status) option.selected = true;
          statusSelect.appendChild(option);
        });
        statusCell.appendChild(statusSelect);
        row.appendChild(statusCell);

        // A√ß√µes
        const actionsCell = document.createElement('td');
        const pauseBtn = document.createElement('button');
        pauseBtn.type = 'button';
        pauseBtn.className = 'btn small ghost pause-btn';
        pauseBtn.title = 'Pausar campanha';
        pauseBtn.textContent = 'P';
        actionsCell.appendChild(pauseBtn);
        row.appendChild(actionsCell);

        frag.appendChild(row);
      });
      trafegoCampaignsBody.appendChild(frag);
      if(trafegoCampaignsEmpty){
        if(filtered.length){
          trafegoCampaignsEmpty.style.display = 'none';
        }else{
          const hasItems = TRAFEGO_CAMPAIGN_IDEAS.length > 0;
          trafegoCampaignsEmpty.textContent = hasItems
            ? 'Nenhuma campanha encontrada com os filtros aplicados.'
            : (trafegoCampaignsEmptyDefault || 'Cadastre ideias de campanhas para organizar testes e alinhamentos com o cliente.');
          trafegoCampaignsEmpty.style.display = 'block';
        }
      }
    }

    function scheduleTrafficCampaignPersist({ immediate = false } = {}){
      trafegoCampaignSavePending = true;
      if(trafegoCampaignSaveTimer){
        clearTimeout(trafegoCampaignSaveTimer);
        trafegoCampaignSaveTimer = null;
      }
      if(immediate){
        flushTrafficCampaignPersist();
        return;
      }
      trafegoCampaignSaveTimer = setTimeout(()=> flushTrafficCampaignPersist(), TRAFEGO_CAMPAIGNS_SAVE_DEBOUNCE_MS);
    }

    function hasPendingTrafficCampaignSave(){
      return trafegoCampaignSavePending || trafegoCampaignSaveInFlight || !!trafegoCampaignSaveTimer;
    }

    function shouldDeferTrafficCampaignSnapshot(){
      return hasPendingTrafficCampaignSave();
    }

    function queuePendingTrafficCampaignSnapshot(payload){
      if(!payload){
        pendingTrafficCampaignSnapshot = null;
        return;
      }
      pendingTrafficCampaignSnapshot = payload;
    }

    function maybeApplyPendingTrafficCampaignSnapshot(){
      if(!pendingTrafficCampaignSnapshot) return;
      if(shouldDeferTrafficCampaignSnapshot()) return;
      const { data, signature } = pendingTrafficCampaignSnapshot;
      pendingTrafficCampaignSnapshot = null;
      TRAFEGO_CAMPAIGN_IDEAS = Array.isArray(data) ? data : [];
      trafficCampaignLocalSignature = signature || computeTrafficCampaignSignature(TRAFEGO_CAMPAIGN_IDEAS);
      trafficCampaignSavedSignature = trafficCampaignLocalSignature;
      trafficCampaignRemoteSignature = trafficCampaignLocalSignature;
      renderTrafficCampaignIdeas();
    }

    async function persistTrafficCampaignIdeas(){
      const uid = auth.currentUser?.uid;
      if(!uid) return;
      const payload = getSanitizedTrafficCampaigns();
      USER_DATA.trafegoCampaignIdeas = payload;
      TRAFEGO_CAMPAIGN_IDEAS = payload.map(item => ({ ...item }));
      trafficCampaignSavedSignature = computeTrafficCampaignSignature(payload);
      trafficCampaignLocalSignature = trafficCampaignSavedSignature;
      try{
        await setDoc(doc(db, 'usuarios', uid), { trafegoCampaignIdeas: payload }, { merge: true });
      }catch(err){
        console.error('persistTrafficCampaignIdeas', err);
      }
    }

    async function flushTrafficCampaignPersist(){
      if(trafegoCampaignSaveTimer){
        clearTimeout(trafegoCampaignSaveTimer);
        trafegoCampaignSaveTimer = null;
      }
      if(trafegoCampaignSaveInFlight){
        trafegoCampaignSaveQueued = true;
        return;
      }
      if(!trafegoCampaignSavePending){
        maybeApplyPendingTrafficCampaignSnapshot();
        return;
      }
      trafegoCampaignSavePending = false;
      trafegoCampaignSaveInFlight = true;
      try{
        await persistTrafficCampaignIdeas();
      }finally{
        trafegoCampaignSaveInFlight = false;
        if(trafegoCampaignSaveQueued){
          trafegoCampaignSaveQueued = false;
          scheduleTrafficCampaignPersist({ immediate: true });
          return;
        }
        maybeApplyPendingTrafficCampaignSnapshot();
      }
    }

    function handleRemoteTrafficCampaignIdeas(rawList){
      const normalized = normalizeTrafficCampaignList(rawList);
      const signature = computeTrafficCampaignSignature(normalized);
      if(signature === trafficCampaignRemoteSignature) return;
      trafficCampaignRemoteSignature = signature;
      if(signature === trafficCampaignLocalSignature){
        trafficCampaignSavedSignature = signature;
        if(TRAFEGO_CAMPAIGN_IDEAS.length !== normalized.length){
          TRAFEGO_CAMPAIGN_IDEAS = normalized;
          renderTrafficCampaignIdeas();
        }
        return;
      }
      if(shouldDeferTrafficCampaignSnapshot()){
        queuePendingTrafficCampaignSnapshot({ data: normalized, signature });
        return;
      }
      TRAFEGO_CAMPAIGN_IDEAS = normalized;
      trafficCampaignLocalSignature = signature;
      trafficCampaignSavedSignature = signature;
      renderTrafficCampaignIdeas();
    }

    function loadTrafficCampaignIdeasFromUserData(){
      TRAFEGO_CAMPAIGN_IDEAS = normalizeTrafficCampaignList(USER_DATA?.trafegoCampaignIdeas);
      const signature = computeTrafficCampaignSignature(TRAFEGO_CAMPAIGN_IDEAS);
      trafficCampaignLocalSignature = signature;
      trafficCampaignSavedSignature = signature;
      trafficCampaignRemoteSignature = signature;
      renderTrafficCampaignIdeas();
    }

    function addTrafficCampaignIdea(data = {}){
      const idea = normalizeTrafficCampaignIdea(data);
      TRAFEGO_CAMPAIGN_IDEAS.push(idea);
      updateTrafficCampaignLocalSignature();
      renderTrafficCampaignIdeas();
      scheduleTrafficCampaignPersist();
      focusTrafficCampaignRow(idea.id);
    }

    function focusTrafficCampaignRow(id){
      if(!id) return;
      requestAnimationFrame(()=>{
        const row = trafegoCampaignsBody?.querySelector(`tr[data-id="${escapeTrafficCampaignId(id)}"]`);
        const focusable = row?.querySelector('input, textarea, select');
        if(focusable){
          focusable.focus();
          if(typeof focusable.select === 'function' && focusable.tagName === 'INPUT'){
            focusable.select();
          }
        }
      });
    }

    function handleTrafficCampaignInput(event){
      const target = event.target;
      if(!target || !target.dataset) return;
      const field = target.dataset.field;
      if(!field || field === 'status') return;
      const row = target.closest('tr');
      if(!row) return;
      const id = row.dataset.id;
      const idea = TRAFEGO_CAMPAIGN_IDEAS.find(item => item.id === id);
      if(!idea) return;
      idea[field] = target.value;
      updateTrafficCampaignLocalSignature();
      scheduleTrafficCampaignPersist();
    }

    function handleTrafficCampaignChange(event){
      const target = event.target;
      if(!target || !target.dataset) return;
      const field = target.dataset.field;
      if(!field) return;
      const row = target.closest('tr');
      if(!row) return;
      const id = row.dataset.id;
      const idea = TRAFEGO_CAMPAIGN_IDEAS.find(item => item.id === id);
      if(!idea) return;
      if(field === 'status'){
        const value = target.value;
        idea.status = TRAFEGO_CAMPAIGN_STATUS_OPTIONS.some(opt => opt.value === value) ? value : 'nao-testada';
        updateTrafficCampaignLocalSignature();
        scheduleTrafficCampaignPersist();
        if(!campaignMatchesFilters(idea)){
          renderTrafficCampaignIdeas();
        }
      }else{
        idea[field] = target.value;
        updateTrafficCampaignLocalSignature();
        scheduleTrafficCampaignPersist();
      }
    }

    function handleTrafficCampaignClick(event){
      const btn = event.target?.closest?.('.pause-btn');
      if(!btn) return;
      const row = btn.closest('tr');
      if(!row) return;
      const id = row.dataset.id;
      const idea = TRAFEGO_CAMPAIGN_IDEAS.find(item => item.id === id);
      if(!idea) return;

      // Pergunta a data de pausa (AAAA-MM-DD)
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      const defaultDate = `${yyyy}-${mm}-${dd}`;
      const input = window.prompt('Quando a campanha foi pausada? (AAAA-MM-DD)', defaultDate);
      if(input === null) return; // cancelado
      let dateStr = (input || '').trim();
      if(!/^\d{4}-\d{2}-\d{2}$/.test(dateStr)){
        dateStr = defaultDate;
      }

      const noteLine = `Pausada em ${dateStr}`;
      if(typeof idea.observation === 'string' && idea.observation.trim()){
        idea.observation = `${idea.observation}\n${noteLine}`.trim();
      }else{
        idea.observation = noteLine;
      }
      idea.status = 'pausada';

      // Reflete no DOM imediato
      const statusSelect = row.querySelector('select[data-field="status"]');
      if(statusSelect){
        if(!Array.from(statusSelect.options).some(o => o.value === 'pausada')){
          const opt = document.createElement('option');
          opt.value = 'pausada';
          opt.textContent = 'Pausada';
          statusSelect.appendChild(opt);
        }
        statusSelect.value = 'pausada';
      }
      const obsArea = row.querySelector('textarea[data-field="observation"]');
      if(obsArea){ obsArea.value = idea.observation; }

      updateTrafficCampaignLocalSignature();
      scheduleTrafficCampaignPersist({ immediate: true });

      // Ap√≥s salvar, rola para o card de hist√≥rico
      const historyCard = document.querySelector('.trafego-card.trafego-history-card');
      if(historyCard && typeof historyCard.scrollIntoView === 'function'){
        historyCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    function handleTrafficCampaignBlur(event){
      if(!event || !event.target || !event.target.dataset?.field) return;
      const row = event.target.closest('tr');
      if(!row) return;
      const id = row.dataset.id;
      const idea = TRAFEGO_CAMPAIGN_IDEAS.find(item => item.id === id);
      if(!idea) return;
      const statusFilterActive = trafegoCampaignStatusFilter && trafegoCampaignStatusFilter.value !== 'all';
      const searchActive = !!(trafegoCampaignSearch && trafegoCampaignSearch.value.trim());
      if(statusFilterActive || searchActive){
        if(!campaignMatchesFilters(idea)){
          renderTrafficCampaignIdeas();
        }
      }
    }

    function trafegoEscAttr(value){
      if(value === undefined || value === null) return '';
      return String(value).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function trafegoAttrNumber(value){
      const num = Number.parseFloat(value);
      return Number.isFinite(num) ? String(num) : '';
    }

    function trafegoNumberValue(raw){
      const num = Number.parseFloat(raw);
      return Number.isFinite(num) ? num : null;
    }

    function trafegoIntValue(raw){
      const num = Number.parseInt(raw, 10);
      return Number.isFinite(num) ? num : null;
    }

    function generateTrafficMetricId(){
      if(typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function'){
        return `metric-${crypto.randomUUID()}`;
      }
      return `metric-${Date.now().toString(36)}-${Math.floor(Math.random() * 1e9).toString(36)}`;
    }

    function sanitizeTrafficMetricDate(value){
      if(typeof value !== 'string') return '';
      const trimmed = value.trim();
      if(!trimmed) return '';
      if(!/^\d{4}-\d{2}-\d{2}$/.test(trimmed)) return '';
      const date = new Date(trimmed);
      if(Number.isNaN(date.getTime())) return '';
      return trimmed;
    }

    function normalizeTrafficMetric(raw = {}){
      const id = typeof raw?.id === 'string' && raw.id ? raw.id : generateTrafficMetricId();
      const date = sanitizeTrafficMetricDate(raw?.date || '');
      const spendValue = trafegoNumberValue(raw?.spend);
      const revenueValue = trafegoNumberValue(raw?.revenue);
      const leadsValue = trafegoIntValue(raw?.leads);
      const note = typeof raw?.note === 'string' ? raw.note.trim() : '';
      return {
        id,
        date,
        spend: spendValue !== null ? spendValue : null,
        revenue: revenueValue !== null ? revenueValue : null,
        leads: leadsValue !== null ? leadsValue : null,
        note
      };
    }

    function normalizeTrafficMetricList(list){
      if(!Array.isArray(list)) return [];
      return list.map(normalizeTrafficMetric);
    }

    function computeTrafficMetricSignature(list){
      if(!Array.isArray(list) || !list.length) return '[]';
      return JSON.stringify(list.map(item => ({
        id: item?.id || '',
        date: item?.date || '',
        spend: (typeof item?.spend === 'number' && Number.isFinite(item.spend)) ? Number(item.spend) : null,
        revenue: (typeof item?.revenue === 'number' && Number.isFinite(item.revenue)) ? Number(item.revenue) : null,
        leads: (typeof item?.leads === 'number' && Number.isFinite(item.leads)) ? Number(item.leads) : null,
        note: item?.note || ''
      })));
    }

    function getSanitizedTrafficMetrics(){
      return TRAFEGO_METRICS.map(item => {
        const normalized = normalizeTrafficMetric(item);
        return {
          id: normalized.id,
          date: normalized.date,
          spend: normalized.spend !== null ? Number(normalized.spend) : null,
          revenue: normalized.revenue !== null ? Number(normalized.revenue) : null,
          leads: normalized.leads !== null ? Number(normalized.leads) : null,
          note: normalized.note
        };
      });
    }

    function updateTrafficMetricsLocalSignature(){
      trafficMetricsLocalSignature = computeTrafficMetricSignature(getSanitizedTrafficMetrics());
    }

    function hasPendingTrafficMetricsSave(){
      return trafegoMetricsSavePending || trafegoMetricsSaveInFlight || !!trafegoMetricsSaveTimer;
    }

    function shouldDeferTrafficMetricsSnapshot(){
      return hasPendingTrafficMetricsSave();
    }

    function queuePendingTrafficMetricsSnapshot(payload){
      pendingTrafficMetricsSnapshot = payload || null;
    }

    function maybeApplyPendingTrafficMetricsSnapshot(){
      if(!pendingTrafficMetricsSnapshot) return;
      if(shouldDeferTrafficMetricsSnapshot()) return;
      const { data, signature } = pendingTrafficMetricsSnapshot;
      pendingTrafficMetricsSnapshot = null;
      TRAFEGO_METRICS = normalizeTrafficMetricList(data);
      const computedSignature = signature || computeTrafficMetricSignature(TRAFEGO_METRICS);
      trafficMetricsLocalSignature = computedSignature;
      trafficMetricsSavedSignature = computedSignature;
      trafficMetricsRemoteSignature = computedSignature;
      renderTrafficMetrics();
    }

    async function persistTrafficMetrics(){
      const uid = auth.currentUser?.uid;
      if(!uid) return;
      const payload = getSanitizedTrafficMetrics();
      USER_DATA.trafegoMetrics = payload;
      TRAFEGO_METRICS = normalizeTrafficMetricList(payload);
      trafficMetricsSavedSignature = computeTrafficMetricSignature(TRAFEGO_METRICS);
      trafficMetricsLocalSignature = trafficMetricsSavedSignature;
      try{
        await setDoc(doc(db, 'usuarios', uid), { trafegoMetrics: payload }, { merge: true });
      }catch(err){
        console.error('persistTrafficMetrics', err);
      }
    }

    async function flushTrafficMetricsPersist(){
      if(trafegoMetricsSaveTimer){
        clearTimeout(trafegoMetricsSaveTimer);
        trafegoMetricsSaveTimer = null;
      }
      if(trafegoMetricsSaveInFlight){
        trafegoMetricsSaveQueued = true;
        return;
      }
      if(!trafegoMetricsSavePending){
        maybeApplyPendingTrafficMetricsSnapshot();
        return;
      }
      trafegoMetricsSavePending = false;
      trafegoMetricsSaveInFlight = true;
      try{
        await persistTrafficMetrics();
      }finally{
        trafegoMetricsSaveInFlight = false;
        if(trafegoMetricsSaveQueued){
          trafegoMetricsSaveQueued = false;
          scheduleTrafficMetricsPersist({ immediate: true });
        }else{
          maybeApplyPendingTrafficMetricsSnapshot();
        }
      }
    }

    function scheduleTrafficMetricsPersist({ immediate = false } = {}){
      trafegoMetricsSavePending = true;
      if(trafegoMetricsSaveTimer){
        clearTimeout(trafegoMetricsSaveTimer);
        trafegoMetricsSaveTimer = null;
      }
      if(immediate){
        flushTrafficMetricsPersist();
        return;
      }
      trafegoMetricsSaveTimer = setTimeout(()=> flushTrafficMetricsPersist(), TRAFEGO_METRICS_SAVE_DEBOUNCE_MS);
    }

    function handleRemoteTrafficMetrics(rawList){
      const normalized = normalizeTrafficMetricList(rawList);
      const signature = computeTrafficMetricSignature(normalized);
      if(signature === trafficMetricsRemoteSignature){
        return;
      }
      trafficMetricsRemoteSignature = signature;
      if(signature === trafficMetricsLocalSignature){
        trafficMetricsSavedSignature = signature;
        TRAFEGO_METRICS = normalized;
        renderTrafficMetrics();
        return;
      }
      if(shouldDeferTrafficMetricsSnapshot()){
        queuePendingTrafficMetricsSnapshot({ data: normalized, signature });
        return;
      }
      TRAFEGO_METRICS = normalized;
      trafficMetricsLocalSignature = signature;
      trafficMetricsSavedSignature = signature;
      renderTrafficMetrics();
    }

    function loadTrafficMetricsFromUserData(){
      TRAFEGO_METRICS = normalizeTrafficMetricList(USER_DATA?.trafegoMetrics);
      const signature = computeTrafficMetricSignature(TRAFEGO_METRICS);
      trafficMetricsLocalSignature = signature;
      trafficMetricsSavedSignature = signature;
      trafficMetricsRemoteSignature = signature;
      renderTrafficMetrics();
    }

    function escapeTrafficMetricId(value){
      const str = String(value || '');
      if(typeof CSS !== 'undefined' && typeof CSS.escape === 'function'){
        return CSS.escape(str);
      }
      return str.replace(/[^a-zA-Z0-9_-]/g, '\\$&');
    }

    function generateTrafficOptimizationId(){
      if(typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function'){
        return `opt-${crypto.randomUUID()}`;
      }
      return `opt-${Date.now().toString(36)}-${Math.floor(Math.random() * 1e9).toString(36)}`;
    }

    function generateTrafficOptimizationHistoryId(){
      if(typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function'){
        return `opthist-${crypto.randomUUID()}`;
      }
      return `opthist-${Date.now().toString(36)}-${Math.floor(Math.random() * 1e9).toString(36)}`;
    }

    function getTrafficPlatformLabel(value){
      const key = typeof value === 'string' ? value.toLowerCase() : '';
      const option = TRAFEGO_PLATFORM_OPTIONS.find(opt => opt.value === key);
      return option ? option.label : (value || '‚Äî');
    }

    function sanitizeOptimizationDate(value){
      if(typeof value !== 'string') return '';
      const trimmed = value.trim();
      if(!/^\d{4}-\d{2}-\d{2}$/.test(trimmed)) return '';
      const [yearStr, monthStr, dayStr] = trimmed.split('-');
      const year = Number.parseInt(yearStr, 10);
      const month = Number.parseInt(monthStr, 10);
      const day = Number.parseInt(dayStr, 10);
      if(!Number.isFinite(year) || !Number.isFinite(month) || !Number.isFinite(day)) return '';
      const date = new Date(year, month - 1, day);
      if(date.getFullYear() !== year || date.getMonth() !== month - 1 || date.getDate() !== day) return '';
      return `${String(year).padStart(4,'0')}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    }

    function parseOptimizationDate(value){
      const sanitized = sanitizeOptimizationDate(value);
      if(!sanitized) return null;
      const [year, month, day] = sanitized.split('-').map(Number);
      return new Date(year, month - 1, day);
    }

    function getOptimizationRecurrenceOption(value){
      const key = typeof value === 'string' ? value.toLowerCase() : '';
      let option = TRAFEGO_OPTIMIZATION_RECURRENCE_OPTIONS.find(opt => opt.value === key) || null;
      if(option) return option;
      const mappedKey = key ? TRAFEGO_OPTIMIZATION_LEGACY_RECURRENCE_MAP[key] : null;
      if(!mappedKey) return null;
      option = TRAFEGO_OPTIMIZATION_RECURRENCE_OPTIONS.find(opt => opt.value === mappedKey) || null;
      return option;
    }

    function getOptimizationIntervalMs(value){
      const option = getOptimizationRecurrenceOption(value);
      if(!option) return null;
      const days = Number(option.days);
      if(!Number.isFinite(days) || days <= 0) return null;
      return days * TRAFEGO_DAY_MS;
    }

    function normalizeTrafficOptimization(raw = {}){
      const id = typeof raw?.id === 'string' && raw.id ? raw.id : generateTrafficOptimizationId();
      const platformValue = typeof raw?.platform === 'string' ? raw.platform.toLowerCase() : '';
      const recurrenceValue = typeof raw?.recurrence === 'string' ? raw.recurrence.toLowerCase() : '';
      const platform = TRAFEGO_PLATFORM_OPTIONS.some(opt => opt.value === platformValue) ? platformValue : 'meta';
      const recurrenceOption = getOptimizationRecurrenceOption(recurrenceValue);
      const recurrence = recurrenceOption ? recurrenceOption.value : TRAFEGO_OPTIMIZATION_DEFAULT_RECURRENCE;
      return {
        id,
        platform,
        campaign: typeof raw?.campaign === 'string' ? raw.campaign : '',
        observation: typeof raw?.observation === 'string' ? raw.observation : '',
        lastOptimization: normalizeOptimizationTopicValue(raw?.lastOptimization, platform),
        lastOptimizationDate: sanitizeOptimizationDate(raw?.lastOptimizationDate),
        recurrence
      };
    }

    function normalizeTrafficOptimizationList(list){
      if(!Array.isArray(list)) return [];
      return list.map(normalizeTrafficOptimization);
    }

    function computeTrafficOptimizationSignature(list){
      if(!Array.isArray(list) || !list.length) return '[]';
      return JSON.stringify(list.map(item => ({
        id: item?.id || '',
        platform: item?.platform || '',
        campaign: item?.campaign || '',
        observation: item?.observation || '',
        lastOptimization: normalizeOptimizationTopicValue(item?.lastOptimization, item?.platform),
        lastOptimizationDate: item?.lastOptimizationDate || '',
        recurrence: item?.recurrence || ''
      })));
    }

    function getSanitizedTrafficOptimizations(){
      return TRAFEGO_OPTIMIZATIONS.map(item => {
        const platform = TRAFEGO_PLATFORM_OPTIONS.some(opt => opt.value === item.platform) ? item.platform : 'meta';
        const recurrenceOption = getOptimizationRecurrenceOption(item.recurrence);
        const recurrence = recurrenceOption ? recurrenceOption.value : TRAFEGO_OPTIMIZATION_DEFAULT_RECURRENCE;
        const topic = normalizeOptimizationTopicValue(item.lastOptimization, platform);
        return {
          id: item.id,
          platform,
          campaign: (item.campaign || '').trim(),
          observation: (item.observation || '').trim(),
          lastOptimization: topic,
          lastOptimizationDate: sanitizeOptimizationDate(item.lastOptimizationDate),
          recurrence
        };
      });
    }

    function sanitizeHistoryTimestamp(value){
      if(typeof value !== 'string') return new Date().toISOString();
      const trimmed = value.trim();
      if(!trimmed) return new Date().toISOString();
      const date = new Date(trimmed);
      if(Number.isNaN(date.getTime())) return trimmed;
      return date.toISOString();
    }

    function normalizeTrafficOptimizationHistoryEntry(raw = {}){
      const id = typeof raw?.id === 'string' && raw.id ? raw.id : generateTrafficOptimizationHistoryId();
      const optimizationId = typeof raw?.optimizationId === 'string' ? raw.optimizationId : '';
      const platformValue = typeof raw?.platform === 'string' ? raw.platform.toLowerCase() : '';
      const platform = TRAFEGO_PLATFORM_OPTIONS.some(opt => opt.value === platformValue) ? platformValue : 'meta';
      const campaign = typeof raw?.campaign === 'string' ? raw.campaign : '';
      const observation = typeof raw?.observation === 'string' ? raw.observation : '';
      const lastOptimization = normalizeOptimizationTopicValue(raw?.lastOptimization, platform);
      const lastOptimizationDate = sanitizeOptimizationDate(raw?.lastOptimizationDate);
      const updatedAt = sanitizeHistoryTimestamp(raw?.updatedAt);
      const changedFields = Array.isArray(raw?.changedFields)
        ? raw.changedFields
            .map(field => String(field).trim())
            .map(field => {
              const lower = field.toLowerCase();
              if(lower === 'platform') return 'platform';
              if(lower === 'campaign') return 'campaign';
              if(lower === 'observation' || lower === 'observacao' || lower === 'observa√ß√£o') return 'observation';
              if(lower === 'lastoptimization' || lower === 'ultimaotimizacao' || lower === '√∫ltima otimiza√ß√£o' || lower === 'ultima otimiza√ß√£o') return 'lastOptimization';
              if(lower === 'lastoptimizationdate' || lower === 'dataultimaotimizacao' || lower === 'data da √∫ltima otimiza√ß√£o') return 'lastOptimizationDate';
              return null;
            })
            .filter(field => field && TRAFEGO_OPTIMIZATION_HISTORY_FIELDS.includes(field))
        : [];
      const uniqueChangedFields = [];
      if(changedFields.length){
        const seenFields = new Set();
        changedFields.forEach(field => {
          if(!seenFields.has(field)){
            seenFields.add(field);
            uniqueChangedFields.push(field);
          }
        });
      }
      return {
        id,
        optimizationId,
        platform,
        campaign,
        observation,
        lastOptimization,
        lastOptimizationDate,
        updatedAt,
        changedFields: uniqueChangedFields
      };
    }

    function normalizeTrafficOptimizationHistoryList(list){
      if(!Array.isArray(list)) return [];
      const normalized = list.map(normalizeTrafficOptimizationHistoryEntry);
      normalized.sort((a,b)=> (b.updatedAt || '').localeCompare(a.updatedAt || ''));
      const deduped = [];
      const seen = new Set();
      normalized.forEach(entry => {
        const key = entry.id || `${entry.optimizationId || ''}-${entry.updatedAt || ''}`;
        if(!key || seen.has(key)) return;
        seen.add(key);
        deduped.push(entry);
      });
      return deduped.slice(0, TRAFEGO_OPTIMIZATION_HISTORY_LIMIT);
    }

    function computeTrafficOptimizationHistorySignature(list){
      if(!Array.isArray(list) || !list.length) return '[]';
      return JSON.stringify(list.map(entry => ({
        id: entry?.id || '',
        optimizationId: entry?.optimizationId || '',
        platform: entry?.platform || '',
        campaign: entry?.campaign || '',
        observation: entry?.observation || '',
        lastOptimization: normalizeOptimizationTopicValue(entry?.lastOptimization, entry?.platform),
        lastOptimizationDate: entry?.lastOptimizationDate || '',
        updatedAt: entry?.updatedAt || '',
        changedFields: Array.isArray(entry?.changedFields)
          ? entry.changedFields.filter(field => TRAFEGO_OPTIMIZATION_HISTORY_FIELDS.includes(field))
          : []
      })));
    }

    function getSanitizedTrafficOptimizationHistory(){
      return TRAFEGO_OPTIMIZATION_HISTORY.map(entry => {
        const platform = TRAFEGO_PLATFORM_OPTIONS.some(opt => opt.value === entry.platform) ? entry.platform : 'meta';
        const lastOptimization = normalizeOptimizationTopicValue(entry.lastOptimization, platform);
        const lastOptimizationDate = sanitizeOptimizationDate(entry.lastOptimizationDate);
        const updatedAt = sanitizeHistoryTimestamp(entry.updatedAt);
        const changedFields = Array.isArray(entry.changedFields)
          ? entry.changedFields.filter(field => TRAFEGO_OPTIMIZATION_HISTORY_FIELDS.includes(field))
          : [];
        const uniqueChangedFields = [];
        if(changedFields.length){
          const seenFields = new Set();
          changedFields.forEach(field => {
            if(!seenFields.has(field)){
              seenFields.add(field);
              uniqueChangedFields.push(field);
            }
          });
        }
        return {
          id: entry.id || generateTrafficOptimizationHistoryId(),
          optimizationId: typeof entry.optimizationId === 'string' ? entry.optimizationId : '',
          platform,
          campaign: (entry.campaign || '').trim(),
          observation: (entry.observation || '').trim(),
          lastOptimization,
          lastOptimizationDate,
          updatedAt,
          changedFields: uniqueChangedFields
        };
      });
    }

    function updateTrafficOptimizationHistoryLocalSignature(){
      trafficHistoryLocalSignature = computeTrafficOptimizationHistorySignature(TRAFEGO_OPTIMIZATION_HISTORY);
    }

    function collectTrafficOptimizationHistoryEntries(prevList, nextList){
      const entries = [];
      if(!Array.isArray(nextList) || !nextList.length) return entries;
      const prevMap = new Map();
      if(Array.isArray(prevList)){
        prevList.forEach(item => {
          if(item && typeof item === 'object' && typeof item.id === 'string'){
            const platform = TRAFEGO_PLATFORM_OPTIONS.some(opt => opt.value === item.platform) ? item.platform : 'meta';
            prevMap.set(item.id, {
              platform,
              campaign: (item.campaign || '').trim(),
              observation: (item.observation || '').trim(),
              lastOptimization: normalizeOptimizationTopicValue(item.lastOptimization, platform),
              lastOptimizationDate: sanitizeOptimizationDate(item.lastOptimizationDate || '')
            });
          }
        });
      }
      const nowIso = new Date().toISOString();
      nextList.forEach(item => {
        if(!item || typeof item !== 'object') return;
        const id = typeof item.id === 'string' ? item.id : '';
        if(!id) return;
        const platform = TRAFEGO_PLATFORM_OPTIONS.some(opt => opt.value === item.platform) ? item.platform : 'meta';
        const payload = {
          optimizationId: id,
          platform,
          campaign: (item.campaign || '').trim(),
          observation: (item.observation || '').trim(),
          lastOptimization: normalizeOptimizationTopicValue(item.lastOptimization, platform),
          lastOptimizationDate: sanitizeOptimizationDate(item.lastOptimizationDate || '')
        };
        const prev = prevMap.get(id);
        if(!prev){
          const changedFields = TRAFEGO_OPTIMIZATION_HISTORY_FIELDS.filter(field => payload[field]);
          if(changedFields.length){
            entries.push({ ...payload, id: generateTrafficOptimizationHistoryId(), updatedAt: nowIso, changedFields });
          }
          return;
        }
        const changedFields = TRAFEGO_OPTIMIZATION_HISTORY_FIELDS.filter(field => (prev[field] || '') !== (payload[field] || ''));
        if(changedFields.length){
          entries.push({ ...payload, id: generateTrafficOptimizationHistoryId(), updatedAt: nowIso, changedFields });
        }
      });
      return entries;
    }

    function updateTrafficOptimizationLocalSignature(){
      trafficOptimizationLocalSignature = computeTrafficOptimizationSignature(TRAFEGO_OPTIMIZATIONS);
    }

    function escapeTrafficOptimizationId(value){
      if(typeof CSS !== 'undefined' && typeof CSS.escape === 'function'){
        return CSS.escape(value);
      }
      return String(value).replace(/[^a-zA-Z0-9_-]/g, match => `\\${match}`);
    }

    function getOptimizationFilters(){
      const platform = (trafegoOptimizationPlatformFilter?.value || 'all').toLowerCase();
      const recurrence = (trafegoOptimizationRecurrenceFilter?.value || 'all').toLowerCase();
      const status = (trafegoOptimizationStatusFilter?.value || 'all').toLowerCase();
      const search = (trafegoOptimizationSearch?.value || '').toLowerCase().trim();
      return { platform, recurrence, status, search };
    }

    function optimizationMatchesFilters(item){
      const { platform, recurrence, status, search } = getOptimizationFilters();
      if(platform !== 'all' && item.platform !== platform) return false;
      if(recurrence !== 'all' && item.recurrence !== recurrence) return false;
      if(status !== 'all'){
        const isPaused = (item?.observation || '').toLowerCase().includes('pausada');
        if(status === 'paused' && !isPaused) return false;
        if(status === 'active' && isPaused) return false;
      }
      if(search && !(item.campaign || '').toLowerCase().includes(search)) return false;
      return true;
    }

    // Aplica classes de cor no select de Plataforma conforme o value
    function applyPlatformThemeToSelect(selectEl, value){
      if(!selectEl) return;
      const cls = ['platform-meta','platform-google','platform-tiktok','platform-linkedin','platform-pinterest'];
      cls.forEach(c => selectEl.classList.remove(c));
      const v = String(value || '').toLowerCase();
      if(v === 'meta') selectEl.classList.add('platform-meta');
      else if(v === 'google') selectEl.classList.add('platform-google');
      else if(v === 'tiktok') selectEl.classList.add('platform-tiktok');
      else if(v === 'linkedin') selectEl.classList.add('platform-linkedin');
      else if(v === 'pinterest') selectEl.classList.add('platform-pinterest');
    }

    function computeTrafficOptimizationStats(item){
      const intervalMs = getOptimizationIntervalMs(item?.recurrence);
      const lastDate = parseOptimizationDate(item?.lastOptimizationDate);
      const now = Date.now();
      let percent = 0;
      let isEmpty = true;
      let nextDate = null;
      let nextLabel = '‚Äî';
      let diffDays = 0;
      const intervalDays = intervalMs ? intervalMs / TRAFEGO_DAY_MS : 0;
      if(lastDate && intervalMs){
        isEmpty = false;
        const diff = now - lastDate.getTime();
        diffDays = diff / TRAFEGO_DAY_MS;
        percent = clamp((diff / intervalMs) * 100, 0, 100);
        nextDate = new Date(lastDate.getTime() + intervalMs);
        nextLabel = nextDate.toLocaleDateString('pt-BR');
      }
      const label = `${Math.round(percent)}%`;
      const titleParts = [];
      if(isEmpty){
        titleParts.push('Defina a data da √∫ltima otimiza√ß√£o e a recorr√™ncia para acompanhar o progresso.');
      }else{
        const elapsed = Math.max(diffDays, 0);
        titleParts.push(`Decorrido: ${elapsed >= 10 ? Math.round(elapsed) : elapsed.toFixed(1)} dia(s)`);
        if(intervalDays){
          const intervalDisplay = intervalDays >= 10 || Number.isInteger(intervalDays)
            ? Math.round(intervalDays)
            : intervalDays.toFixed(1);
          titleParts.push(`Intervalo: ${intervalDisplay} dia(s)`);
        }
        if(nextDate){
          titleParts.push(`Pr√≥xima otimiza√ß√£o: ${nextLabel}`);
        }
      }
      return {
        percent,
        label,
        title: titleParts.join(' ‚Ä¢ '),
        isEmpty,
        isDue: !isEmpty && percent >= 100,
        nextLabel
      };
    }

    function createTrafficOptimizationRow(item){
      const row = document.createElement('tr');
      row.dataset.id = item.id;

      const platformCell = document.createElement('td');
      const platformSelect = document.createElement('select');
      platformSelect.dataset.field = 'platform';
      platformSelect.classList.add('platform-select');
      TRAFEGO_PLATFORM_OPTIONS.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.label;
        if(opt.value === item.platform) option.selected = true;
        platformSelect.appendChild(option);
      });
      // Aplica a cor conforme a plataforma atual
      applyPlatformThemeToSelect(platformSelect, item.platform);
      platformCell.appendChild(platformSelect);
      row.appendChild(platformCell);

      const campaignCell = document.createElement('td');
      const campaignInput = document.createElement('input');
      campaignInput.type = 'text';
      campaignInput.placeholder = 'Campanha';
      campaignInput.dataset.field = 'campaign';
      campaignInput.value = item.campaign;
  // Tooltip com o nome completo da campanha
  campaignInput.title = item.campaign || '';
  campaignCell.title = item.campaign || '';
  campaignCell.setAttribute('data-tooltip', item.campaign || '');
      campaignCell.appendChild(campaignInput);
      row.appendChild(campaignCell);

      const progressCell = document.createElement('td');
      const progressWrap = document.createElement('div');
      progressWrap.className = 'trafego-progress';
      progressWrap.setAttribute('role', 'progressbar');
      progressWrap.setAttribute('aria-valuemin', '0');
      progressWrap.setAttribute('aria-valuemax', '100');
      const progressFill = document.createElement('div');
      progressFill.className = 'trafego-progress-fill';
      const progressLabel = document.createElement('span');
      progressLabel.className = 'trafego-progress-label';
      progressWrap.appendChild(progressFill);
      progressWrap.appendChild(progressLabel);
      progressCell.appendChild(progressWrap);
      row.appendChild(progressCell);

      const observationCell = document.createElement('td');
      const observationArea = document.createElement('textarea');
      observationArea.placeholder = 'Observa√ß√µes gerais';
      observationArea.dataset.field = 'observation';
      observationArea.value = item.observation;
      observationCell.appendChild(observationArea);
      row.appendChild(observationCell);

      const lastOptimizationCell = document.createElement('td');
      const lastOptimizationSelect = document.createElement('select');
      const selectedTopic = normalizeOptimizationTopicValue(item.lastOptimization, item.platform);
      item.lastOptimization = selectedTopic;
      lastOptimizationSelect.dataset.field = 'lastOptimization';
      lastOptimizationSelect.setAttribute('aria-label', 'Itens da √∫ltima otimiza√ß√£o');
      populateOptimizationTopicOptions(lastOptimizationSelect, item.platform, selectedTopic);
      lastOptimizationCell.appendChild(lastOptimizationSelect);
      row.appendChild(lastOptimizationCell);

      const lastDateCell = document.createElement('td');
      const lastDateInput = document.createElement('input');
      lastDateInput.type = 'date';
      lastDateInput.dataset.field = 'lastOptimizationDate';
      lastDateInput.value = item.lastOptimizationDate || '';
      lastDateCell.appendChild(lastDateInput);
      row.appendChild(lastDateCell);

      const recurrenceCell = document.createElement('td');
      const recurrenceSelect = document.createElement('select');
      recurrenceSelect.dataset.field = 'recurrence';
      TRAFEGO_OPTIMIZATION_RECURRENCE_OPTIONS.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.label;
        if(opt.value === item.recurrence) option.selected = true;
        recurrenceSelect.appendChild(option);
      });
      recurrenceCell.appendChild(recurrenceSelect);
      row.appendChild(recurrenceCell);

      const nextCell = document.createElement('td');
      const nextSpan = document.createElement('span');
      nextSpan.className = 'trafego-next-optimization';
      nextSpan.textContent = '‚Äî';
      nextCell.appendChild(nextSpan);
      row.appendChild(nextCell);

      const actionsCell = document.createElement('td');
      actionsCell.className = 'trafego-actions-cell';
  const pauseButton = document.createElement('button');
  pauseButton.type = 'button';
  pauseButton.className = 'btn small ghost trafego-optimization-pause';
  pauseButton.title = 'Pausar campanha';
  pauseButton.textContent = 'P';
  actionsCell.appendChild(pauseButton);
      const saveButton = document.createElement('button');
      saveButton.type = 'button';
      saveButton.className = 'btn small trafego-save-optimization';
      saveButton.textContent = 'Salvar';
      actionsCell.appendChild(saveButton);
      row.appendChild(actionsCell);

      row._optimizationRefs = {
        wrap: progressWrap,
        fill: progressFill,
        label: progressLabel,
        next: nextSpan,
        topicsSelect: lastOptimizationSelect
      };
      updateTrafficOptimizationRow(row, item);
      return row;
    }

    function updateTrafficOptimizationRow(row, item){
      if(!row || !row._optimizationRefs) return;
      const refs = row._optimizationRefs;
      const stats = computeTrafficOptimizationStats(item);
      if(refs.fill){
        refs.fill.style.width = `${stats.percent}%`;
      }
      if(refs.label){
        refs.label.textContent = stats.label;
      }
      if(refs.wrap){
        refs.wrap.classList.toggle('is-due', !!stats.isDue);
        refs.wrap.classList.toggle('is-empty', !!stats.isEmpty);
        refs.wrap.setAttribute('aria-valuenow', String(Math.round(stats.percent)));
        refs.wrap.setAttribute('title', stats.title || '');
      }
      if(refs.next){
        refs.next.textContent = stats.nextLabel || '‚Äî';
      }
      // Atualiza tooltip do nome da campanha (input e c√©lula)
      const campaignInput = row.querySelector('input[data-field="campaign"]');
      if(campaignInput){
        const full = item?.campaign || '';
        campaignInput.title = full;
        const campaignCell = campaignInput.closest('td');
        if(campaignCell){
          campaignCell.title = full;
          campaignCell.setAttribute('data-tooltip', full);
        }
      }
      // Marca visualmente como pausada se a observa√ß√£o indicar pausa
      const isPaused = (item?.observation || '').toLowerCase().includes('pausada');
      row.classList.toggle('is-paused', isPaused);
      row.setAttribute('aria-disabled', isPaused ? 'true' : 'false');
      // Atualiza a cor do select de plataforma
      const platformSelect = row.querySelector('select[data-field="platform"]');
      if(platformSelect){
        applyPlatformThemeToSelect(platformSelect, item.platform);
      }
    }

    function syncTrafficOptimizationItemFromRow(row, item){
      if(!row || !item) return;
      const platformSelect = row.querySelector('select[data-field="platform"]');
      if(platformSelect){
        const value = String(platformSelect.value || '').toLowerCase();
        const platform = TRAFEGO_PLATFORM_OPTIONS.some(opt => opt.value === value) ? value : 'meta';
        item.platform = platform;
        if(platformSelect.value !== platform){
          platformSelect.value = platform;
        }
        applyPlatformThemeToSelect(platformSelect, item.platform);
      }
      const campaignInput = row.querySelector('input[data-field="campaign"]');
      if(campaignInput){
        item.campaign = campaignInput.value || '';
        const full = item.campaign || '';
        campaignInput.title = full;
        const campaignCell = campaignInput.closest('td');
        if(campaignCell){
          campaignCell.title = full;
          campaignCell.setAttribute('data-tooltip', full);
        }
      }
      const observationArea = row.querySelector('textarea[data-field="observation"]');
      if(observationArea){
        item.observation = observationArea.value || '';
      }
      const recurrenceSelect = row.querySelector('select[data-field="recurrence"]');
      if(recurrenceSelect){
        const value = String(recurrenceSelect.value || '').toLowerCase();
        const option = getOptimizationRecurrenceOption(value);
        const recurrence = option ? option.value : TRAFEGO_OPTIMIZATION_DEFAULT_RECURRENCE;
        item.recurrence = recurrence;
        if(recurrenceSelect.value !== recurrence){
          recurrenceSelect.value = recurrence;
        }
      }
      const dateInput = row.querySelector('input[data-field="lastOptimizationDate"]');
      if(dateInput){
        const sanitized = sanitizeOptimizationDate(dateInput.value);
        item.lastOptimizationDate = sanitized;
        if(dateInput.value !== sanitized){
          dateInput.value = sanitized;
        }
      }
      const topicSelect = row.querySelector('select[data-field="lastOptimization"]');
      if(topicSelect){
        const normalizedTopic = normalizeOptimizationTopicValue(topicSelect.value, item.platform);
        item.lastOptimization = normalizedTopic;
        if(topicSelect.value !== normalizedTopic){
          populateOptimizationTopicOptions(topicSelect, item.platform, normalizedTopic);
        }
      }
      updateTrafficOptimizationRow(row, item);
    }

    function trafegoDelay(ms){
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function renderTrafficOptimizations(){
      if(!trafegoOptimizationsBody) return;
      trafegoOptimizationsBody.innerHTML = '';
      const filtered = TRAFEGO_OPTIMIZATIONS.filter(item => optimizationMatchesFilters(item));
      const frag = document.createDocumentFragment();
      filtered.forEach(item => {
        frag.appendChild(createTrafficOptimizationRow(item));
      });
      trafegoOptimizationsBody.appendChild(frag);
      if(trafegoOptimizationsEmpty){
        if(filtered.length){
          trafegoOptimizationsEmpty.style.display = 'none';
        }else{
          const hasItems = TRAFEGO_OPTIMIZATIONS.length > 0;
          trafegoOptimizationsEmpty.textContent = hasItems
            ? 'Nenhuma otimiza√ß√£o encontrada com os filtros aplicados.'
            : (trafegoOptimizationsEmptyDefault || 'Cadastre otimiza√ß√µes para acompanhar os prazos de revis√£o.');
          trafegoOptimizationsEmpty.style.display = 'block';
        }
      }
    }

    function scheduleTrafficOptimizationHistoryPersist({ immediate = false } = {}){
      trafegoHistorySavePending = true;
      if(trafegoHistorySaveTimer){
        clearTimeout(trafegoHistorySaveTimer);
        trafegoHistorySaveTimer = null;
      }
      if(immediate){
        flushTrafficOptimizationHistoryPersist();
        return;
      }
      trafegoHistorySaveTimer = setTimeout(()=> flushTrafficOptimizationHistoryPersist(), TRAFEGO_HISTORY_SAVE_DEBOUNCE_MS);
    }

    function hasPendingTrafficOptimizationHistorySave(){
      return trafegoHistorySavePending || trafegoHistorySaveInFlight || !!trafegoHistorySaveTimer;
    }

    function shouldDeferTrafficOptimizationHistorySnapshot(){
      return hasPendingTrafficOptimizationHistorySave();
    }

    function queuePendingTrafficOptimizationHistorySnapshot(payload){
      pendingTrafficOptimizationHistorySnapshot = payload;
    }

    function maybeApplyPendingTrafficOptimizationHistorySnapshot(){
      if(!pendingTrafficOptimizationHistorySnapshot) return;
      if(shouldDeferTrafficOptimizationHistorySnapshot()) return;
      const { data, signature } = pendingTrafficOptimizationHistorySnapshot;
      pendingTrafficOptimizationHistorySnapshot = null;
      TRAFEGO_OPTIMIZATION_HISTORY = Array.isArray(data) ? data : [];
      trafficHistoryLocalSignature = signature || computeTrafficOptimizationHistorySignature(TRAFEGO_OPTIMIZATION_HISTORY);
      trafficHistorySavedSignature = trafficHistoryLocalSignature;
      trafficHistoryRemoteSignature = trafficHistoryLocalSignature;
      renderTrafficOptimizationHistory();
    }

    async function persistTrafficOptimizationHistory(){
      const uid = auth.currentUser?.uid;
      if(!uid) return;
      const payload = getSanitizedTrafficOptimizationHistory();
      USER_DATA.trafegoOptimizationHistory = payload;
      TRAFEGO_OPTIMIZATION_HISTORY = normalizeTrafficOptimizationHistoryList(payload);
      trafficHistorySavedSignature = computeTrafficOptimizationHistorySignature(TRAFEGO_OPTIMIZATION_HISTORY);
      trafficHistoryLocalSignature = trafficHistorySavedSignature;
      try{
        await setDoc(doc(db, 'usuarios', uid), { trafegoOptimizationHistory: payload }, { merge: true });
      }catch(err){
        console.error('persistTrafficOptimizationHistory', err);
      }
    }

    async function flushTrafficOptimizationHistoryPersist(){
      if(trafegoHistorySaveTimer){
        clearTimeout(trafegoHistorySaveTimer);
        trafegoHistorySaveTimer = null;
      }
      if(trafegoHistorySaveInFlight){
        trafegoHistorySaveQueued = true;
        return;
      }
      if(!trafegoHistorySavePending){
        maybeApplyPendingTrafficOptimizationHistorySnapshot();
        return;
      }
      trafegoHistorySavePending = false;
      trafegoHistorySaveInFlight = true;
      try{
        await persistTrafficOptimizationHistory();
      }finally{
        trafegoHistorySaveInFlight = false;
        if(trafegoHistorySaveQueued){
          trafegoHistorySaveQueued = false;
          scheduleTrafficOptimizationHistoryPersist({ immediate: true });
        }else{
          maybeApplyPendingTrafficOptimizationHistorySnapshot();
        }
      }
    }

    function formatTrafficHistoryUpdatedAt(iso){
      if(!iso) return '‚Äî';
      const date = new Date(iso);
      if(Number.isNaN(date.getTime())) return iso;
      return date.toLocaleString('pt-BR', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
    }

    function formatHistoryOptimizationDate(iso){
      if(!iso) return '';
      const parts = iso.split('-');
      if(parts.length === 3){
        return `${parts[2]}/${parts[1]}/${parts[0]}`;
      }
      return iso;
    }

    function renderTrafficOptimizationHistory(){
      if(!trafegoHistoryBody) return;
      const platformFilter = (trafegoHistoryPlatformFilter?.value || 'all').toLowerCase();
      const searchValue = (trafegoHistorySearch?.value || '').toLowerCase().trim();
      const sorted = [...TRAFEGO_OPTIMIZATION_HISTORY].sort((a,b)=> (b.updatedAt || '').localeCompare(a.updatedAt || ''));
      const filtered = sorted.filter(entry => {
        if(platformFilter !== 'all' && entry.platform !== platformFilter) return false;
        if(searchValue && !(entry.campaign || '').toLowerCase().includes(searchValue)) return false;
        return true;
      });
      trafegoHistoryBody.innerHTML = '';
      const frag = document.createDocumentFragment();
      filtered.forEach(entry => {
        const row = document.createElement('tr');
        row.dataset.id = entry.id || '';
        if(Array.isArray(entry.changedFields) && entry.changedFields.length){
          const labels = entry.changedFields.map(field => {
            switch(field){
              case 'platform': return 'Plataforma';
              case 'campaign': return 'Nome da campanha';
              case 'observation': return 'Observa√ß√£o';
              case 'lastOptimization': return '√öltima otimiza√ß√£o';
              case 'lastOptimizationDate': return 'Data da √∫ltima otimiza√ß√£o';
              default: return field;
            }
          });
          row.title = `Campos alterados: ${labels.join(', ')}`;
        }
        const platformCell = document.createElement('td');
        platformCell.textContent = getTrafficPlatformLabel(entry.platform);
        row.appendChild(platformCell);

        const campaignCell = document.createElement('td');
        campaignCell.textContent = entry.campaign || '‚Äî';
        row.appendChild(campaignCell);

        const observationCell = document.createElement('td');
        observationCell.textContent = entry.observation || '‚Äî';
        row.appendChild(observationCell);

        const lastOptimizationCell = document.createElement('td');
        lastOptimizationCell.textContent = entry.lastOptimization || '‚Äî';
        row.appendChild(lastOptimizationCell);

        const updatedCell = document.createElement('td');
        const updatedMain = document.createElement('div');
        updatedMain.textContent = formatTrafficHistoryUpdatedAt(entry.updatedAt);
        updatedCell.appendChild(updatedMain);
        if(entry.lastOptimizationDate){
          const optimizationMeta = document.createElement('div');
          optimizationMeta.className = 'trafego-history-meta';
          optimizationMeta.textContent = `√öltima otimiza√ß√£o: ${formatHistoryOptimizationDate(entry.lastOptimizationDate)}`;
          updatedCell.appendChild(optimizationMeta);
        }
        row.appendChild(updatedCell);

        const actionsCell = document.createElement('td');
        actionsCell.className = 'trafego-history-actions';
        const removeButton = document.createElement('button');
        removeButton.type = 'button';
        removeButton.className = 'trafego-history-remove';
        removeButton.setAttribute('aria-label', 'Remover registro');
        removeButton.dataset.id = entry.id || '';
        removeButton.textContent = '‚ùå';
        actionsCell.appendChild(removeButton);
        row.appendChild(actionsCell);

        frag.appendChild(row);
      });
      trafegoHistoryBody.appendChild(frag);
      if(trafegoHistoryEmpty){
        if(filtered.length){
          trafegoHistoryEmpty.style.display = 'none';
        }else{
          const hasItems = TRAFEGO_OPTIMIZATION_HISTORY.length > 0;
          trafegoHistoryEmpty.textContent = hasItems
            ? 'Nenhuma altera√ß√£o encontrada com os filtros aplicados.'
            : 'Nenhum registro no hist√≥rico ainda.';
          trafegoHistoryEmpty.style.display = 'block';
        }
      }
    }

    function removeTrafficOptimizationHistoryEntry(id){
      if(!id) return;
      const index = TRAFEGO_OPTIMIZATION_HISTORY.findIndex(entry => entry.id === id);
      if(index === -1) return;
      TRAFEGO_OPTIMIZATION_HISTORY.splice(index, 1);
      updateTrafficOptimizationHistoryLocalSignature();
      renderTrafficOptimizationHistory();
      scheduleTrafficOptimizationHistoryPersist({ immediate: true });
    }

    function addTrafficOptimizationHistoryEntries(entries = []){
      if(!Array.isArray(entries) || !entries.length) return;
      const normalized = entries.map(normalizeTrafficOptimizationHistoryEntry);
      const combined = [...normalized, ...TRAFEGO_OPTIMIZATION_HISTORY];
      const deduped = [];
      const seen = new Set();
      combined.forEach(entry => {
        const key = entry.id || `${entry.optimizationId || ''}-${entry.updatedAt || ''}`;
        if(!key || seen.has(key)) return;
        seen.add(key);
        deduped.push(entry);
      });
      deduped.sort((a,b)=> (b.updatedAt || '').localeCompare(a.updatedAt || ''));
      TRAFEGO_OPTIMIZATION_HISTORY = deduped.slice(0, TRAFEGO_OPTIMIZATION_HISTORY_LIMIT);
      updateTrafficOptimizationHistoryLocalSignature();
      renderTrafficOptimizationHistory();
      scheduleTrafficOptimizationHistoryPersist();
    }

    function recordManualTrafficOptimizationHistory(item, previousSnapshot = null){
      if(!item) return;
      const sanitizedList = getSanitizedTrafficOptimizations();
      const payload = sanitizedList.find(entry => entry.id === item.id);
      if(!payload) return;
      let changedFields = [];
      if(Array.isArray(previousSnapshot) && previousSnapshot.length){
        const prev = previousSnapshot.find(entry => entry && entry.id === payload.id);
        if(prev){
          changedFields = TRAFEGO_OPTIMIZATION_HISTORY_FIELDS.filter(field => (prev[field] || '') !== (payload[field] || ''));
        }
      }
      if(!changedFields.length){
        const filledFields = TRAFEGO_OPTIMIZATION_HISTORY_FIELDS.filter(field => payload[field]);
        if(filledFields.length){
          changedFields = filledFields;
        }
      }
      const historyEntry = {
        id: generateTrafficOptimizationHistoryId(),
        optimizationId: payload.id,
        platform: payload.platform,
        campaign: payload.campaign,
        observation: payload.observation,
        lastOptimization: payload.lastOptimization,
        lastOptimizationDate: payload.lastOptimizationDate,
        updatedAt: new Date().toISOString(),
        changedFields
      };
      addTrafficOptimizationHistoryEntries([historyEntry]);
    }

    function scheduleTrafficOptimizationPersist({ immediate = false } = {}){
      trafegoOptimizationSavePending = true;
      if(trafegoOptimizationSaveTimer){
        clearTimeout(trafegoOptimizationSaveTimer);
        trafegoOptimizationSaveTimer = null;
      }
      if(immediate){
        flushTrafficOptimizationPersist();
        return;
      }
      trafegoOptimizationSaveTimer = setTimeout(()=> flushTrafficOptimizationPersist(), TRAFEGO_OPTIMIZATION_SAVE_DEBOUNCE_MS);
    }

    function hasPendingTrafficOptimizationSave(){
      return trafegoOptimizationSavePending || trafegoOptimizationSaveInFlight || !!trafegoOptimizationSaveTimer;
    }

    function shouldDeferTrafficOptimizationSnapshot(){
      return hasPendingTrafficOptimizationSave();
    }

    function queuePendingTrafficOptimizationSnapshot(payload){
      if(!payload){
        pendingTrafficOptimizationSnapshot = null;
        return;
      }
      pendingTrafficOptimizationSnapshot = payload;
    }

    async function saveTrafficOptimizationsImmediate(){
      trafegoOptimizationSavePending = true;
      if(trafegoOptimizationSaveTimer){
        clearTimeout(trafegoOptimizationSaveTimer);
        trafegoOptimizationSaveTimer = null;
      }
      await flushTrafficOptimizationPersist();
      const start = Date.now();
      while(trafegoOptimizationSaveInFlight || trafegoOptimizationSaveQueued || trafegoOptimizationSavePending){
        if(Date.now() - start > TRAFEGO_OPTIMIZATION_SAVE_TIMEOUT_MS){
          throw new Error('traffic-optimization-save-timeout');
        }
        await trafegoDelay(80);
      }
    }

    function maybeApplyPendingTrafficOptimizationSnapshot(){
      if(!pendingTrafficOptimizationSnapshot) return;
      if(shouldDeferTrafficOptimizationSnapshot()) return;
      const { data, signature } = pendingTrafficOptimizationSnapshot;
      pendingTrafficOptimizationSnapshot = null;
      TRAFEGO_OPTIMIZATIONS = Array.isArray(data) ? data : [];
      trafficOptimizationLocalSignature = signature || computeTrafficOptimizationSignature(TRAFEGO_OPTIMIZATIONS);
      trafficOptimizationSavedSignature = trafficOptimizationLocalSignature;
      trafficOptimizationRemoteSignature = trafficOptimizationLocalSignature;
      TRAFEGO_OPTIMIZATIONS_LAST_SAVED = getSanitizedTrafficOptimizations().map(item => ({ ...item }));
      (function(){
        const statusSel = document.getElementById('trafegoOptimizationStatusFilter');
        if(statusSel){ statusSel.value = 'active'; }
      })();
      renderTrafficOptimizations();
    }

    async function persistTrafficOptimizations(){
      const uid = auth.currentUser?.uid;
      if(!uid) return;
      const payload = getSanitizedTrafficOptimizations();
      TRAFEGO_OPTIMIZATIONS_LAST_SAVED = payload.map(item => ({ ...item }));
      USER_DATA.trafegoOptimizations = payload;
      TRAFEGO_OPTIMIZATIONS = payload.map(normalizeTrafficOptimization);
      trafficOptimizationSavedSignature = computeTrafficOptimizationSignature(TRAFEGO_OPTIMIZATIONS);
      trafficOptimizationLocalSignature = trafficOptimizationSavedSignature;
      try{
        await setDoc(doc(db, 'usuarios', uid), { trafegoOptimizations: payload }, { merge: true });
      }catch(err){
        console.error('persistTrafficOptimizations', err);
      }
    }

    async function flushTrafficOptimizationPersist(){
      if(trafegoOptimizationSaveTimer){
        clearTimeout(trafegoOptimizationSaveTimer);
        trafegoOptimizationSaveTimer = null;
      }
      if(trafegoOptimizationSaveInFlight){
        trafegoOptimizationSaveQueued = true;
        return;
      }
      if(!trafegoOptimizationSavePending){
        maybeApplyPendingTrafficOptimizationSnapshot();
        return;
      }
      trafegoOptimizationSavePending = false;
      trafegoOptimizationSaveInFlight = true;
      try{
        await persistTrafficOptimizations();
      }finally{
        trafegoOptimizationSaveInFlight = false;
        if(trafegoOptimizationSaveQueued){
          trafegoOptimizationSaveQueued = false;
          scheduleTrafficOptimizationPersist({ immediate: true });
          return;
        }
        maybeApplyPendingTrafficOptimizationSnapshot();
      }
    }

    function handleRemoteTrafficOptimizations(rawList){
      const normalized = normalizeTrafficOptimizationList(rawList);
      const signature = computeTrafficOptimizationSignature(normalized);
      if(signature === trafficOptimizationRemoteSignature) return;
      trafficOptimizationRemoteSignature = signature;
      if(signature === trafficOptimizationLocalSignature){
        trafficOptimizationSavedSignature = signature;
        if(TRAFEGO_OPTIMIZATIONS.length !== normalized.length){
          TRAFEGO_OPTIMIZATIONS = normalized;
          renderTrafficOptimizations();
        }
        TRAFEGO_OPTIMIZATIONS_LAST_SAVED = getSanitizedTrafficOptimizations().map(item => ({ ...item }));
        return;
      }
      if(shouldDeferTrafficOptimizationSnapshot()){
        queuePendingTrafficOptimizationSnapshot({ data: normalized, signature });
        return;
      }
      TRAFEGO_OPTIMIZATIONS = normalized;
      trafficOptimizationLocalSignature = signature;
      trafficOptimizationSavedSignature = signature;
      TRAFEGO_OPTIMIZATIONS_LAST_SAVED = getSanitizedTrafficOptimizations().map(item => ({ ...item }));
      renderTrafficOptimizations();
    }

    function handleRemoteTrafficOptimizationHistory(rawList){
      const normalized = normalizeTrafficOptimizationHistoryList(rawList);
      const signature = computeTrafficOptimizationHistorySignature(normalized);
      if(signature === trafficHistoryRemoteSignature) return;
      trafficHistoryRemoteSignature = signature;
      if(signature === trafficHistoryLocalSignature){
        trafficHistorySavedSignature = signature;
        return;
      }
      if(shouldDeferTrafficOptimizationHistorySnapshot()){
        queuePendingTrafficOptimizationHistorySnapshot({ data: normalized, signature });
        return;
      }
      TRAFEGO_OPTIMIZATION_HISTORY = normalized;
      trafficHistoryLocalSignature = signature;
      trafficHistorySavedSignature = signature;
      renderTrafficOptimizationHistory();
    }

    function loadTrafficOptimizationsFromUserData(){
      TRAFEGO_OPTIMIZATIONS = normalizeTrafficOptimizationList(USER_DATA?.trafegoOptimizations);
      const signature = computeTrafficOptimizationSignature(TRAFEGO_OPTIMIZATIONS);
      trafficOptimizationLocalSignature = signature;
      trafficOptimizationSavedSignature = signature;
      trafficOptimizationRemoteSignature = signature;
      TRAFEGO_OPTIMIZATIONS_LAST_SAVED = getSanitizedTrafficOptimizations().map(item => ({ ...item }));
      renderTrafficOptimizations();
    }

    function loadTrafficOptimizationHistoryFromUserData(){
      TRAFEGO_OPTIMIZATION_HISTORY = normalizeTrafficOptimizationHistoryList(USER_DATA?.trafegoOptimizationHistory);
      const signature = computeTrafficOptimizationHistorySignature(TRAFEGO_OPTIMIZATION_HISTORY);
      trafficHistoryLocalSignature = signature;
      trafficHistorySavedSignature = signature;
      trafficHistoryRemoteSignature = signature;
      renderTrafficOptimizationHistory();
    }

    function addTrafficOptimization(data = {}){
      const item = normalizeTrafficOptimization(data);
      TRAFEGO_OPTIMIZATIONS.push(item);
      updateTrafficOptimizationLocalSignature();
      renderTrafficOptimizations();
      scheduleTrafficOptimizationPersist();
      focusTrafficOptimizationRow(item.id);
    }

    function focusTrafficOptimizationRow(id){
      if(!id) return;
      requestAnimationFrame(()=>{
        const row = trafegoOptimizationsBody?.querySelector(`tr[data-id="${escapeTrafficOptimizationId(id)}"]`);
        const focusable = row?.querySelector('input, textarea, select');
        if(focusable){
          focusable.focus();
          if(focusable.tagName === 'INPUT' && typeof focusable.select === 'function'){
            focusable.select();
          }
        }
      });
    }

    function handleTrafficOptimizationInput(event){
      const target = event.target;
      if(!target || !target.dataset) return;
      const field = target.dataset.field;
      if(!field || field === 'platform' || field === 'recurrence' || field === 'lastOptimizationDate' || field === 'lastOptimization') return;
      const row = target.closest('tr');
      if(!row) return;
      const id = row.dataset.id;
      const item = TRAFEGO_OPTIMIZATIONS.find(entry => entry.id === id);
      if(!item) return;
      item[field] = target.value;
      if(field === 'campaign'){
        const full = String(target.value || '');
        target.title = full;
        const cell = target.closest('td');
        if(cell){
          cell.title = full;
          cell.setAttribute('data-tooltip', full);
        }
      }
      updateTrafficOptimizationLocalSignature();
      scheduleTrafficOptimizationPersist();
      updateTrafficOptimizationRow(row, item);
    }

    function handleTrafficOptimizationChange(event){
      const target = event.target;
      if(!target || !target.dataset) return;
      const field = target.dataset.field;
      if(!field) return;
      const row = target.closest('tr');
      if(!row) return;
      const id = row.dataset.id;
      const item = TRAFEGO_OPTIMIZATIONS.find(entry => entry.id === id);
      if(!item) return;
      if(field === 'platform'){
        const value = String(target.value || '').toLowerCase();
        item.platform = TRAFEGO_PLATFORM_OPTIONS.some(opt => opt.value === value) ? value : 'meta';
        // Atualiza a cor do select conforme a plataforma escolhida
        applyPlatformThemeToSelect(target, item.platform);
        item.lastOptimization = normalizeOptimizationTopicValue(item.lastOptimization, item.platform);
        if(row._optimizationRefs?.topicsSelect){
          populateOptimizationTopicOptions(row._optimizationRefs.topicsSelect, item.platform, item.lastOptimization);
        }
      }else if(field === 'recurrence'){
        const value = String(target.value || '').toLowerCase();
        const recurrenceOption = getOptimizationRecurrenceOption(value);
        item.recurrence = recurrenceOption ? recurrenceOption.value : TRAFEGO_OPTIMIZATION_DEFAULT_RECURRENCE;
      }else if(field === 'lastOptimizationDate'){
        const sanitized = sanitizeOptimizationDate(target.value);
        item.lastOptimizationDate = sanitized;
        if(target.value !== sanitized){
          target.value = sanitized;
        }
      }else if(field === 'lastOptimization'){
        const value = target.value;
        item.lastOptimization = normalizeOptimizationTopicValue(value, item.platform);
        populateOptimizationTopicOptions(target, item.platform, item.lastOptimization);
      }
      updateTrafficOptimizationLocalSignature();
      scheduleTrafficOptimizationPersist();
      updateTrafficOptimizationRow(row, item);
      const { platform, recurrence, status, search } = getOptimizationFilters();
      const filtersActive = platform !== 'all' || recurrence !== 'all' || status !== 'all' || !!search;
      if(filtersActive && !optimizationMatchesFilters(item)){
        renderTrafficOptimizations();
      }
    }

    function handleTrafficOptimizationBlur(event){
      if(!event?.target?.dataset?.field) return;
      const row = event.target.closest('tr');
      if(!row) return;
      const id = row.dataset.id;
      const item = TRAFEGO_OPTIMIZATIONS.find(entry => entry.id === id);
      if(!item) return;
      if(!optimizationMatchesFilters(item)){
        renderTrafficOptimizations();
      }
    }

    function handleTrafficOptimizationClick(event){
      const pauseBtn = event.target?.closest('.trafego-optimization-pause');
      const saveBtn = event.target?.closest('.trafego-save-optimization');
      if(!pauseBtn && !saveBtn) return;
      event.preventDefault();
      if(pauseBtn){
        onTrafficOptimizationPauseClick(pauseBtn);
      }else if(saveBtn){
        onTrafficOptimizationSaveButtonClick(saveBtn);
      }
    }

    async function onTrafficOptimizationSaveButtonClick(button){
      if(!button) return;
      const row = button.closest('tr');
      if(!row) return;
      const id = row.dataset.id;
      if(!id) return;
      const item = TRAFEGO_OPTIMIZATIONS.find(entry => entry.id === id);
      if(!item) return;
      if(button.disabled) return;
      if(!auth?.currentUser){
        alert('Fa√ßa login para salvar otimiza√ß√µes.');
        return;
      }
      button.disabled = true;
      try{
        const previousSnapshot = Array.isArray(TRAFEGO_OPTIMIZATIONS_LAST_SAVED)
          ? TRAFEGO_OPTIMIZATIONS_LAST_SAVED.map(entry => ({ ...entry }))
          : [];
        syncTrafficOptimizationItemFromRow(row, item);
        updateTrafficOptimizationLocalSignature();
        await saveTrafficOptimizationsImmediate();
        recordManualTrafficOptimizationHistory(item, previousSnapshot);
        if(typeof mgToast === 'function'){
          mgToast('Otimiza√ß√£o registrada com sucesso');
        }else{
          alert('Otimiza√ß√£o registrada com sucesso');
        }
      }catch(err){
        console.error('onTrafficOptimizationSaveButtonClick', err);
        alert('N√£o foi poss√≠vel salvar a otimiza√ß√£o. Tente novamente.');
      }finally{
        button.disabled = false;
      }
    }

    async function onTrafficOptimizationPauseClick(button){
      if(!button) return;
      const row = button.closest('tr');
      if(!row) return;
      const id = row.dataset.id;
      if(!id) return;
      const item = TRAFEGO_OPTIMIZATIONS.find(entry => entry.id === id);
      if(!item) return;
      if(button.disabled) return;
      if(!auth?.currentUser){
        alert('Fa√ßa login para pausar a campanha.');
        return;
      }
      button.disabled = true;
      // Pergunta a data de pausa (AAAA-MM-DD), padr√£o hoje
      const today = new Date();
      const defaultDate = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
      const input = window.prompt('Quando a campanha foi pausada? (AAAA-MM-DD)', defaultDate);
      if(input == null) return; // cancelado
      const pausedDate = sanitizeOptimizationDate(String(input || ''));
      if(!pausedDate){
        alert('Data inv√°lida. Use o formato AAAA-MM-DD.');
        button.disabled = false;
        return;
      }
      // Snapshot anterior para hist√≥rico
      const previousSnapshot = Array.isArray(TRAFEGO_OPTIMIZATIONS_LAST_SAVED)
        ? TRAFEGO_OPTIMIZATIONS_LAST_SAVED.map(entry => ({ ...entry }))
        : [];
      // Atualiza observa√ß√£o com a informa√ß√£o de pausa
      const observationArea = row.querySelector('textarea[data-field="observation"]');
      const prefix = item.observation && item.observation.trim() ? item.observation.trim() + '\n' : '';
      const newObservation = `${prefix}Pausada em ${pausedDate}`;
      if(observationArea){
        observationArea.value = newObservation;
      }
      item.observation = newObservation;
      try{
        // Atualiza visual imediatamente
        updateTrafficOptimizationRow(row, item);
        // Se o filtro atual for "Ativas" (ou o item n√£o corresponder mais aos filtros), recarrega a lista para sumir em tempo real
        const { platform, recurrence, status, search } = getOptimizationFilters();
        const filtersActive = platform !== 'all' || recurrence !== 'all' || status !== 'all' || !!search;
        if(status === 'active' || (filtersActive && !optimizationMatchesFilters(item))){
          renderTrafficOptimizations();
        }
        updateTrafficOptimizationLocalSignature();
        await saveTrafficOptimizationsImmediate();
        // Registra no hist√≥rico para aparecer na aba Hist√≥rico
        recordManualTrafficOptimizationHistory(item, previousSnapshot);
        if(typeof mgToast === 'function'){
          mgToast('Campanha pausada e salva');
        }
        // Rola at√© o card de hist√≥rico
        const historyCard = document.querySelector('.trafego-card.trafego-history-card');
        if(historyCard){
          historyCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }catch(err){
        console.error('onTrafficOptimizationPauseClick', err);
        alert('N√£o foi poss√≠vel pausar/salvar. Tente novamente.');
      }finally{
        button.disabled = false;
      }
    }

    function handleTrafficHistoryClick(event){
      const button = event.target?.closest('.trafego-history-remove');
      if(!button) return;
      event.preventDefault();
      const id = button.dataset.id || button.closest('tr')?.dataset.id;
      if(!id) return;
      const confirmed = confirm('Remover este registro do hist√≥rico?');
      if(!confirmed) return;
      removeTrafficOptimizationHistoryEntry(id);
    }

    function addTrafficDemandaRow(data = {}){
      if(!trafegoDemandasBody) return;
      const status = (data.status || '').toLowerCase();
      const options = TRAFEGO_STATUS_OPTIONS.map(opt=>`<option value="${opt.value}"${opt.value===status?' selected':''}>${opt.label}</option>`).join('');
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><input type="text" placeholder="Campanha ou conjunto" value="${trafegoEscAttr(data.campaign)}"></td>
        <td><input type="text" placeholder="Objetivo da otimiza√ß√£o" value="${trafegoEscAttr(data.objective)}"></td>
        <td><input type="number" min="0" step="0.01" placeholder="R$" value="${trafegoAttrNumber(data.budget)}"></td>
        <td><select>${options}</select></td>
        <td><input type="text" placeholder="Pr√≥ximos passos e alertas" value="${trafegoEscAttr(data.notes)}"></td>
        <td><button type="button" class="trafego-remove-demand">Remover</button></td>
      `;
      trafegoDemandasBody.appendChild(row);
    }

    function renderTrafficMetrics(){
      if(!trafegoMetricsBody) return;
      trafegoMetricsBody.innerHTML = '';
      if(!TRAFEGO_METRICS.length) return;
      const frag = document.createDocumentFragment();
      TRAFEGO_METRICS.forEach(metric => {
        frag.appendChild(createTrafficMetricRow(metric));
      });
      trafegoMetricsBody.appendChild(frag);
    }

    function createTrafficMetricRow(metric){
      const item = normalizeTrafficMetric(metric);
      const row = document.createElement('tr');
      row.dataset.id = item.id;
      row.innerHTML = `
        <td><input type="date" data-field="date" value="${trafegoEscAttr(item.date)}"></td>
        <td><input type="number" min="0" step="0.01" data-field="spend" placeholder="0,00" value="${trafegoAttrNumber(item.spend)}"></td>
        <td><input type="number" min="0" step="0.01" data-field="revenue" placeholder="0,00" value="${trafegoAttrNumber(item.revenue)}"></td>
        <td><span class="trafego-roas">‚Äî</span></td>
        <td><input type="number" min="0" step="1" data-field="leads" placeholder="0" value="${trafegoAttrNumber(item.leads)}"></td>
        <td><span class="trafego-cpl">‚Äî</span></td>
        <td><input type="text" data-field="note" placeholder="Insights do dia" value="${trafegoEscAttr(item.note)}"></td>
      `;
      updateTrafficMetricRow(row);
      return row;
    }

    function updateTrafficMetricRow(row){
      if(!row) return null;
      const dateInput = row.querySelector('input[data-field="date"]');
      const spendInput = row.querySelector('input[data-field="spend"]');
      const revenueInput = row.querySelector('input[data-field="revenue"]');
      const leadsInput = row.querySelector('input[data-field="leads"]');
      const noteInput = row.querySelector('input[data-field="note"]');
      const roasCell = row.querySelector('.trafego-roas');
      const cplCell = row.querySelector('.trafego-cpl');

      const spend = trafegoNumberValue(spendInput?.value);
      const revenue = trafegoNumberValue(revenueInput?.value);
      const leads = trafegoIntValue(leadsInput?.value);
      const note = noteInput?.value?.trim?.() || '';

      let roas = null;
      if(spend !== null && spend > 0 && revenue !== null){
        roas = revenue / spend;
      }
      if(roasCell){
        if(roas !== null && Number.isFinite(roas)){
          roasCell.textContent = `${roas.toFixed(2)}x`;
          roasCell.classList.toggle('negative', roas < 1);
        }else{
          roasCell.textContent = '‚Äî';
          roasCell.classList.remove('negative');
        }
      }

      let cpl = null;
      if(spend !== null && spend > 0 && leads !== null && leads > 0){
        cpl = spend / leads;
      }
      if(cplCell){
        if(cpl !== null && Number.isFinite(cpl)){
          cplCell.textContent = `R$ ${cpl.toFixed(2)}`;
        }else{
          cplCell.textContent = '‚Äî';
        }
      }

      const dateValue = dateInput?.value || '';

      row.dataset.date = dateValue;
      row.dataset.spend = spend !== null ? String(spend) : '';
      row.dataset.revenue = revenue !== null ? String(revenue) : '';
      row.dataset.leads = leads !== null ? String(leads) : '';
      row.dataset.roas = roas !== null && Number.isFinite(roas) ? String(roas) : '';
      row.dataset.cpl = cpl !== null && Number.isFinite(cpl) ? String(cpl) : '';
      row.dataset.note = note;

      return { date: dateValue, spend, revenue, leads, note };
    }

    function syncTrafficMetricRow(row, { scheduleSave = true } = {}){
      if(!row) return;
      const id = row.dataset.id;
      const values = updateTrafficMetricRow(row);
      if(!values || !id) return;
      let metric = TRAFEGO_METRICS.find(item => item.id === id);
      if(!metric){
        metric = normalizeTrafficMetric({ id, ...values });
        TRAFEGO_METRICS.push(metric);
        updateTrafficMetricsLocalSignature();
        if(scheduleSave){
          scheduleTrafficMetricsPersist();
        }
        return;
      }
      const changed =
        (metric.date || '') !== values.date ||
        metric.spend !== values.spend ||
        metric.revenue !== values.revenue ||
        metric.leads !== values.leads ||
        (metric.note || '') !== values.note;
      if(!changed) return;
      metric.date = values.date;
      metric.spend = values.spend;
      metric.revenue = values.revenue;
      metric.leads = values.leads;
      metric.note = values.note;
      updateTrafficMetricsLocalSignature();
      if(scheduleSave){
        scheduleTrafficMetricsPersist();
      }
    }

    function addTrafficMetricRow(data = {}, options = {}){
      const { persist = true, focus = true } = options || {};
      const metric = normalizeTrafficMetric(data);
      TRAFEGO_METRICS.push(metric);
      updateTrafficMetricsLocalSignature();
      renderTrafficMetrics();
      if(persist){
        scheduleTrafficMetricsPersist();
      }
      if(focus !== false){
        focusTrafficMetricRow(metric.id);
      }
      return metric;
    }

    function focusTrafficMetricRow(id){
      if(!trafegoMetricsBody || !id) return;
      const selector = `tr[data-id="${escapeTrafficMetricId(id)}"] input[data-field="date"]`;
      const input = trafegoMetricsBody.querySelector(selector);
      if(input){
        input.focus();
        if(typeof input.select === 'function'){
          input.select();
        }
      }
    }

    function renderTrafego(){
      if(!trafegoWrap) return;
      if(!trafegoInitialized){
        trafegoInitialized = true;
        if(trafegoAddDemanda){
          trafegoAddDemanda.addEventListener('click', ()=>{
            addTrafficDemandaRow();
          });
        }
        if(trafegoAddOptimization){
          trafegoAddOptimization.addEventListener('click', ()=> addTrafficOptimization());
        }
        if(trafegoDemandasBody){
          trafegoDemandasBody.addEventListener('click', (event)=>{
            const target = event.target;
            if(target && target.classList?.contains('trafego-remove-demand')){
              const row = target.closest('tr');
              if(row){ row.remove(); }
              event.preventDefault();
            }
          });
        }
        if(trafegoAddMetricRow){
          trafegoAddMetricRow.addEventListener('click', ()=>{
            addTrafficMetricRow({}, { persist: true, focus: true });
          });
        }
        const metricsHandler = (event)=>{
          const row = event.target?.closest?.('tr');
          if(!row) return;
          syncTrafficMetricRow(row);
        };
        if(trafegoMetricsBody){
          trafegoMetricsBody.addEventListener('input', metricsHandler);
          trafegoMetricsBody.addEventListener('change', metricsHandler);
        }
        if(trafegoAddCampaign){
          trafegoAddCampaign.addEventListener('click', ()=> addTrafficCampaignIdea());
        }
        if(trafegoCampaignsBody){
          trafegoCampaignsBody.addEventListener('input', handleTrafficCampaignInput);
          trafegoCampaignsBody.addEventListener('change', handleTrafficCampaignChange);
          trafegoCampaignsBody.addEventListener('blur', handleTrafficCampaignBlur, true);
          trafegoCampaignsBody.addEventListener('click', handleTrafficCampaignClick);
        }
        if(trafegoOptimizationsBody){
          trafegoOptimizationsBody.addEventListener('input', handleTrafficOptimizationInput);
          trafegoOptimizationsBody.addEventListener('change', handleTrafficOptimizationChange);
          trafegoOptimizationsBody.addEventListener('blur', handleTrafficOptimizationBlur, true);
          trafegoOptimizationsBody.addEventListener('click', handleTrafficOptimizationClick);
        }
        if(trafegoCampaignStatusFilter){
          trafegoCampaignStatusFilter.addEventListener('change', ()=> renderTrafficCampaignIdeas());
        }
        if(trafegoCampaignSearch){
          trafegoCampaignSearch.addEventListener('input', ()=> renderTrafficCampaignIdeas());
        }
        if(trafegoOptimizationPlatformFilter){
          trafegoOptimizationPlatformFilter.addEventListener('change', ()=> renderTrafficOptimizations());
        }
        if(trafegoOptimizationRecurrenceFilter){
          trafegoOptimizationRecurrenceFilter.addEventListener('change', ()=> renderTrafficOptimizations());
        }
        const trafegoOptimizationStatusFilter = document.getElementById('trafegoOptimizationStatusFilter');
        if(trafegoOptimizationStatusFilter){
          trafegoOptimizationStatusFilter.addEventListener('change', ()=> renderTrafficOptimizations());
        }
        if(trafegoOptimizationSearch){
          trafegoOptimizationSearch.addEventListener('input', ()=> renderTrafficOptimizations());
        }
        if(trafegoHistoryPlatformFilter){
          trafegoHistoryPlatformFilter.addEventListener('change', ()=> renderTrafficOptimizationHistory());
        }
        if(trafegoHistorySearch){
          trafegoHistorySearch.addEventListener('input', ()=> renderTrafficOptimizationHistory());
        }
        if(trafegoHistoryBody){
          trafegoHistoryBody.addEventListener('click', handleTrafficHistoryClick);
        }
        if(trafegoDemandasBody && !trafegoDemandasBody.childElementCount){
          addTrafficDemandaRow({ status: 'ativa' });
        }
        if(!TRAFEGO_METRICS.length){
          addTrafficMetricRow({ date: new Date().toISOString().slice(0,10) }, { persist: false, focus: false });
        }else{
          renderTrafficMetrics();
        }
      }
      renderTrafficOptimizations();
      renderTrafficOptimizationHistory();
      renderTrafficCampaignIdeas();
    }

    function buildTabs(){
      sectionTabs.innerHTML="";
      SECTIONS.forEach(s=>{
        const b=document.createElement("button");
        b.className="tab-btn"+(s.id===currentSection?" active":"");
        b.setAttribute("role","tab"); b.setAttribute("aria-selected",s.id===currentSection?"true":"false");
        b.dataset.section = s.id;
        if(s.id === 'macro'){
          b.innerHTML = `<span class="tab-label">${s.name}</span><span class="tab-badge" hidden>atualizado</span>`;
          macroTabBadgeEl = b.querySelector('.tab-badge');
          syncMacroTabBadge();
        }else{
          b.textContent=s.name;
        }
        b.addEventListener("click",()=>{ if(currentSection===s.id) return; setActiveTab(s.id); });
        sectionTabs.appendChild(b);
      });
    }

    let tabKeyNavBound=false;
    function initTabKeyNav(){
      if(tabKeyNavBound) return;
      tabKeyNavBound=true;
      document.addEventListener('keydown',function(ev){
        if(ev.key!=='ArrowLeft' && ev.key!=='ArrowRight') return;
        const tag=ev.target.tagName?.toLowerCase();
        if(tag==='input' || tag==='textarea' || ev.target.isContentEditable) return;
        if(document.querySelector('.modal.show')) return;
        const tabs=[...sectionTabs.querySelectorAll('.tab-btn')];
        if(!tabs.length) return;
        const idx=tabs.findIndex(t=>t.classList.contains('active'));
        let next=idx+(ev.key==='ArrowRight'?1:-1);
        if(next<0) next=tabs.length-1;
        if(next>=tabs.length) next=0;
        tabs[next].click();
      });
    }

    function rerenderBySection(){
      // show panel only on Macro
      const isMacro = currentSection==="macro";
      if(macroSectionRoot){
        macroSectionRoot.style.display = isMacro ? "block" : "none";
      }
      if(macroActions) macroActions.style.display = isMacro ? "flex" : "none";
      if(!isMacro && historyChart){
        historyChart.destroy();
        historyChart = null;
      }
      renderHistoryChart();
      renderHistoryLegend();
      if(currentSection==="notes"){
        setSectionVisibility({notes:true});
        renderNotes();
        normalizeNoteEditorMedia();
      } else if(currentSection==="calendar"){
        setSectionVisibility({calendar:true});
        ensureCalendar();
      } else if(currentSection==="briefing"){
        setSectionVisibility({briefing:true});
        renderBrief();
      } else if(currentSection==="metas"){
        setSectionVisibility({metas:true});
        renderMetas();
      } else if(currentSection==="leads"){
        setSectionVisibility({leads:true});
        renderLeads();
      } else if(currentSection==="demandas"){
        setSectionVisibility({demandas:true});
        renderDemandas();
      } else if(currentSection==="access"){
        setSectionVisibility({access:true});
        renderAccesses();
      } else if(currentSection==="arquivos"){
        setSectionVisibility({files:true});
        renderFiles();
      } else if(currentSection==="ia"){
        setSectionVisibility({ia:true});
        renderIA();
      } else if(currentSection==="refSocial"){
        setSectionVisibility({refSocial:true});
        renderRefSocial();
      } else if(currentSection==="concorrentes"){
        setSectionVisibility({concorrentes:true});
        renderCompetitors();
      } else if(currentSection==="estruturacao"){
        setSectionVisibility({estruturacao:true});
        // Garantir que dados est√£o carregados antes de renderizar
        if(Object.keys(ESTRUTURACAO_STATE).length === 0){
          console.log('[Estrutura√ß√£o] ESTRUTURACAO_STATE vazio, tentando carregar dados...');
          // Sempre tentar subcole√ß√£o primeiro quando n√£o tem dados
          loadEstruturacaoFromSubcollections().then(() => {
            renderEstruturacao();
          }).catch(() => {
            // Fallback final
            renderEstruturacao();
          });
        } else {
          renderEstruturacao();
        }
      } else if(currentSection==="relatorio"){
        setSectionVisibility({relatorio:true});
        initRelatorio();
      } else if(currentSection==="teamNotes"){
        setSectionVisibility({teamNotes:true});
        renderTeamNotes();
      } else if(currentSection==="reunioes"){
        setSectionVisibility({reunioes:true});
        renderReunioes();
      } else {
        setSectionVisibility({widgets:true});
        if(widgetsRenderedSection !== currentSection){
          loadWidgetsFromData();
          renderWidgets();
          widgetsRenderedSection = currentSection;
        }
      }
      updateScrollHint();
    }

    /* ========= NOTAS TIME (Kanban) ========= */
    let TEAM_NOTES = [];
    let TEAM_NOTES_COLUMNS = {
      trafego: { name: 'Tr√°fego', icon: 'üéØ' },
      canais: { name: 'Canais de Tra√ß√£o', icon: 'üì¢' },
      lideranca: { name: 'Lideran√ßa', icon: 'üëî' },
      outros: { name: 'Outros', icon: 'üìå' }
    };
    let currentEditingTeamNote = null;
    let currentTeamNoteColumn = null;
    let teamNoteAttachmentUrls = [];

    async function loadTeamNotesFromData(){
      const uid = getTeamNotesTargetUid();
      if(!uid) {
        console.warn('‚ö†Ô∏è Nenhum UID dispon√≠vel para carregar notas');
        TEAM_NOTES = [];
        return;
      }
      
      try {
        // SEMPRE carregar da subcole√ß√£o primeiro (fonte principal)
        const notesDocRef = doc(db, "usuarios", uid, "teamNotes", "notes");
        const notesDoc = await getDoc(notesDocRef);
        
        if(notesDoc.exists()){
          const data = notesDoc.data();
          TEAM_NOTES = Array.isArray(data.notes) ? data.notes : [];
          console.log('‚úÖ Notas carregadas da subcole√ß√£o:', TEAM_NOTES.length);
        } else {
          console.log('üìã Nenhuma nota na subcole√ß√£o, verificando legado...');
          
          // Fallback: carregar do USER_DATA legado e migrar
          if (Array.isArray(USER_DATA.teamNotes) && USER_DATA.teamNotes.length > 0) {
            TEAM_NOTES = USER_DATA.teamNotes;
            console.log('üìã Notas encontradas no legado:', TEAM_NOTES.length, '- Migrando para subcole√ß√£o...');
            
            // Migrar para subcole√ß√£o
            await persistTeamNotes();
            console.log('‚úÖ Migra√ß√£o conclu√≠da!');
          } else {
            TEAM_NOTES = [];
            console.log('üìã Nenhuma nota encontrada (nem subcole√ß√£o nem legado)');
          }
        }
      } catch(err) {
        console.error('‚ùå Erro ao carregar notas:', err);
        TEAM_NOTES = [];
      }
    }

    function saveTeamNotesToUserData(){
      // Mant√©m para compatibilidade, mas n√£o usa mais
      USER_DATA.teamNotes = TEAM_NOTES;
    }

    function getTeamNotesTargetUid(){
      // Determinar o UID correto: se admin est√° visualizando cliente, usar UID do cliente
      // Se √© cliente direto, usar auth.currentUser.uid ou fakeUser
      if (Array.isArray(clientDocPathParts) && clientDocPathParts.length >= 2) {
        return clientDocPathParts[1]; // ['usuarios', 'uid-do-cliente', ...]
      }
      // Tentar getCurrentUser (que inclui _adminFakeUser)
      const currentUser = typeof window.getCurrentUser === 'function' ? window.getCurrentUser() : auth.currentUser;
      return currentUser?.uid;
    }

    async function persistTeamNotes(){
      saveTeamNotesToUserData();
      const uid = getTeamNotesTargetUid();
      if(!uid) {
        console.warn('‚ö†Ô∏è Nenhum UID dispon√≠vel para salvar notas do time');
        mgToast('Fa√ßa login para salvar notas');
        return;
      }
      try {
        console.log('üíæ Salvando notas para UID:', uid);
        console.log('üíæ Total de notas:', TEAM_NOTES.length);
        
        // SALVAR EM SUBCOLE√á√ÉO para evitar limite de 1MB do documento
        const notesCollectionRef = collection(db, "usuarios", uid, "teamNotes");
        
        // Criar um documento √∫nico com todas as notas
        const notesDocRef = doc(notesCollectionRef, "notes");
        await setDoc(notesDocRef, { 
          notes: TEAM_NOTES,
          updatedAt: new Date().toISOString()
        });
        
        console.log('‚úÖ Notas do time salvas para:', uid);
        mgToast('Nota salva!');
      } catch(err) {
        console.error('‚ùå Erro ao salvar notas do time:', err);
        console.error('‚ùå Erro detalhado:', err.message, err.code, err.stack);
        mgToast('Erro ao salvar nota: ' + (err.message || 'Erro desconhecido'));
      }
    }

    async function renderTeamNotes(){
      await loadTeamNotesFromData();
      
      Object.keys(TEAM_NOTES_COLUMNS).forEach(columnKey => {
        const cardsContainer = document.getElementById(`teamNotesCards${capitalize(columnKey)}`);
        const countEl = document.getElementById(`teamNotesCount${capitalize(columnKey)}`);
        if(!cardsContainer) return;
        
        const columnNotes = TEAM_NOTES.filter(n => n.column === columnKey)
          .sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
        
        if(countEl) countEl.textContent = columnNotes.length;
        
        if(columnNotes.length === 0){
          cardsContainer.innerHTML = `<p style="color:#64748b;font-size:.85rem;text-align:center;padding:20px 10px;">Nenhuma nota ainda</p>`;
          return;
        }
        
        cardsContainer.innerHTML = columnNotes.map(note => {
          const content = escapeHtml(note.content || '').replace(/\n/g, '<br>');
          const contentWithLinks = linkifyText(content);
          const date = note.createdAt ? new Date(note.createdAt).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit' }) : '';
          const authorName = note.authorName || 'An√¥nimo';
          const authorPhoto = note.authorPhoto || '';
          
          let attachmentsHtml = '';
          if(note.attachments && note.attachments.length > 0){
            attachmentsHtml = `<div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;">
              ${note.attachments.map(url => `<img src="${url}" style="max-width:100%;max-height:120px;border-radius:6px;cursor:pointer;" onclick="window.open('${url}', '_blank')">`).join('')}
            </div>`;
          }
          
          return `
            <div class="team-notes-card" data-id="${note.id}">
              <div class="team-notes-card-content">${contentWithLinks}${attachmentsHtml}</div>
              <div class="team-notes-card-meta">
                <div class="team-notes-card-author">
                  ${authorPhoto ? `<img src="${authorPhoto}" alt="">` : ''}
                  <span>${authorName}</span>
                  <span style="margin-left:4px;opacity:.6">${date}</span>
                </div>
                <div class="team-notes-card-actions">
                  <button onclick="expandTeamNote('${note.id}')" title="Expandir" style="font-size:1rem;">üîç</button>
                  <button onclick="editTeamNote('${note.id}')" title="Editar">‚úèÔ∏è</button>
                  <button class="delete" onclick="deleteTeamNote('${note.id}')" title="Excluir">üóëÔ∏è</button>
                </div>
              </div>
            </div>
          `;
        }).join('');
      });
      
      // Atualiza resumos ap√≥s renderizar notas
      if(typeof updateSummaries === 'function') {
        setTimeout(updateSummaries, 100);
      }
      // Inicializa bloco de resumo semanal consolidado
      if(typeof initWeeklySummaryBlock === 'function') {
        setTimeout(initWeeklySummaryBlock, 150);
      }
      // Inicializa bloco de resumo mensal consolidado
      if(typeof initMonthlySummaryBlock === 'function') {
        setTimeout(initMonthlySummaryBlock, 200);
      }
    }

    function capitalize(str){
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function linkifyText(text){
      const urlRegex = /(https?:\/\/[^\s<]+)/g;
      return text.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener">$1</a>');
    }

    function openTeamNoteModal(column, noteId = null){
      currentTeamNoteColumn = column;
      currentEditingTeamNote = noteId;
      teamNoteAttachmentUrls = [];
      
      const modal = document.getElementById('teamNotesModal');
      const titleEl = document.getElementById('teamNotesModalTitle');
      const contentEl = document.getElementById('teamNoteContent');
      const attachmentsEl = document.getElementById('teamNoteAttachments');
      
      // Limpar e garantir que n√£o h√° conte√∫do indesejado
      if(!modal || !titleEl || !contentEl || !attachmentsEl) {
        console.error('Elementos do modal n√£o encontrados');
        return;
      }
      
      // CR√çTICO: Remover TODOS os iframes que possam ter sido injetados no modal
      const allIframes = modal.querySelectorAll('iframe');
      allIframes.forEach(iframe => {
        console.warn('‚ö†Ô∏è Removendo iframe indesejado do modal:', iframe);
        iframe.remove();
      });
      
      // Remover divs .show que n√£o pertencem ao modal
      const showDivs = modal.querySelectorAll('div.show');
      showDivs.forEach(div => {
        if(!div.classList.contains('team-notes-modal') && !div.closest('.team-notes-modal-content')){
          console.warn('‚ö†Ô∏è Removendo div.show indesejada:', div);
          div.remove();
        }
      });
      
      // IMPORTANTE: Remover qualquer elemento estranho que possa ter sido injetado no modal
      const modalBody = modal.querySelector('.team-notes-modal-body');
      if(modalBody){
        // Remover apenas elementos INDESEJADOS (n√£o o textarea nem attachments)
        const children = Array.from(modalBody.children);
        children.forEach(child => {
          const isTextareaContainer = child.querySelector('#teamNoteContent');
          const isAttachmentsContainer = child.id === 'teamNoteAttachments';
          
          if(!isTextareaContainer && !isAttachmentsContainer){
            console.warn('‚ö†Ô∏è Removendo elemento indesejado do modal body:', child);
            child.remove();
          }
        });
      }
      
      // Debug: Verificar se h√° elementos indesejados dentro do modal
      console.log('üîç Abrindo modal. Children do attachmentsEl antes da limpeza:', attachmentsEl.children.length);
      
      if(noteId){
        const note = TEAM_NOTES.find(n => n.id === noteId);
        if(note){
          titleEl.textContent = 'Editar Nota';
          contentEl.value = note.content || '';
          teamNoteAttachmentUrls = Array.isArray(note.attachments) ? [...note.attachments] : [];
          currentTeamNoteColumn = note.column;
        }
      } else {
        titleEl.textContent = `Nova Nota - ${TEAM_NOTES_COLUMNS[column]?.name || column}`;
        contentEl.value = '';
        teamNoteAttachmentUrls = [];
      }
      
      // Renderizar anexos ANTES de abrir o modal
      renderTeamNoteAttachments();
      
      // Debug: Verificar ap√≥s renderiza√ß√£o
      console.log('‚úÖ Anexos renderizados. Children do attachmentsEl:', attachmentsEl.children.length);
      
      // GARANTIR que o textarea aceite Enter (adicionar listener se n√£o existe)
      if(contentEl && !contentEl.dataset.enterListenerAdded){
        contentEl.dataset.enterListenerAdded = 'true';
        contentEl.addEventListener('keydown', (e) => {
          if(e.key === 'Enter'){
            // Permitir Enter SEMPRE no textarea
            e.stopPropagation();
            console.log('‚úÖ Enter pressionado no textarea - quebra de linha permitida');
          }
        }, true); // useCapture = true para pegar o evento primeiro
      }
      
      // Abrir modal
      modal.classList.add('show');
      
      // Focar no textarea ap√≥s pequeno delay para garantir que est√° vis√≠vel
      setTimeout(() => {
        if(contentEl) {
          contentEl.focus();
          console.log('üéØ Textarea focado, pronto para digita√ß√£o');
        }
      }, 100);
    }
    window.openTeamNoteModal = openTeamNoteModal;

    function closeTeamNoteModal(){
      const modal = document.getElementById('teamNotesModal');
      modal.classList.remove('show');
      currentEditingTeamNote = null;
      currentTeamNoteColumn = null;
      teamNoteAttachmentUrls = [];
    }
    window.closeTeamNoteModal = closeTeamNoteModal;

    function renderTeamNoteAttachments(){
      const container = document.getElementById('teamNoteAttachments');
      if(!container) {
        console.error('‚ùå Container de anexos n√£o encontrado');
        return;
      }
      
      // Limpar COMPLETAMENTE o container primeiro
      while(container.firstChild) {
        container.removeChild(container.firstChild);
      }
      
      const previewsHtml = teamNoteAttachmentUrls.map((url, idx) => `
        <div class="team-notes-attachment-preview">
          <img src="${escapeHtml(url)}" alt="Anexo">
          <button type="button" class="remove-attachment" onclick="removeTeamNoteAttachment(${idx})">√ó</button>
        </div>
      `).join('');
      
      container.innerHTML = `
        <div class="team-notes-modal-attachments-label">üìé Anexos (clique ou arraste imagens)</div>
        ${previewsHtml}
        <label class="team-notes-modal-upload-btn" for="teamNoteFileInput">+</label>
        <input type="file" id="teamNoteFileInput" accept="image/*" multiple style="display:none" onchange="handleTeamNoteFileSelect(event)">
      `;
    }

    function removeTeamNoteAttachment(idx){
      teamNoteAttachmentUrls.splice(idx, 1);
      renderTeamNoteAttachments();
    }
    window.removeTeamNoteAttachment = removeTeamNoteAttachment;

    async function handleTeamNoteFileSelect(event){
      const files = event.target.files;
      if(!files || files.length === 0) return;
      
      const uid = getTeamNotesTargetUid();
      if(!uid){
        mgToast('Fa√ßa login para anexar imagens');
        return;
      }
      
      for(const file of files){
        if(!file.type.startsWith('image/')){
          mgToast('Apenas imagens s√£o permitidas');
          continue;
        }
        
        try {
          mgToast('Enviando imagem...');
          const fileName = `team-notes/${uid}/${Date.now()}-${file.name}`;
          const fileRef = sRef(storage, fileName);
          await uploadBytes(fileRef, file);
          const url = await getDownloadURL(fileRef);
          teamNoteAttachmentUrls.push(url);
          renderTeamNoteAttachments();
          mgToast('Imagem anexada!');
        } catch(err) {
          console.error('Erro ao enviar imagem:', err);
          mgToast('Erro ao enviar imagem');
        }
      }
      
      event.target.value = '';
    }
    window.handleTeamNoteFileSelect = handleTeamNoteFileSelect;

    async function saveTeamNote(){
      try {
        const contentEl = document.getElementById('teamNoteContent');
        const content = (contentEl?.value || '').trim();
        
        console.log('üìù Salvando nota com conte√∫do:', content);
        console.log('üìù Quebras de linha detectadas:', (content.match(/\n/g) || []).length);
        
        if(!content && teamNoteAttachmentUrls.length === 0){
          mgToast('Digite algo ou anexe uma imagem');
          return;
        }
        
        // Verificar UID antes de salvar
        const uid = getTeamNotesTargetUid();
        if(!uid){
          console.error('‚ùå Nenhum UID encontrado para salvar nota');
          mgToast('Erro: Usu√°rio n√£o identificado. Fa√ßa login novamente.');
          return;
        }
        
        console.log('‚úÖ UID verificado para salvar nota:', uid);
        
        // Usar getCurrentUser para suportar sess√£o admin
        const user = typeof window.getCurrentUser === 'function' ? window.getCurrentUser() : auth.currentUser;
        const now = new Date().toISOString();
      
      if(currentEditingTeamNote){
        // Editar nota existente
        const idx = TEAM_NOTES.findIndex(n => n.id === currentEditingTeamNote);
        if(idx !== -1){
          TEAM_NOTES[idx].content = content;
          TEAM_NOTES[idx].attachments = teamNoteAttachmentUrls;
          TEAM_NOTES[idx].updatedAt = now;
        }
      } else {
        // Nova nota
        const newNote = {
          id: uuid(),
          column: currentTeamNoteColumn,
          content: content,
          attachments: teamNoteAttachmentUrls,
          authorId: user?.uid || '',
          authorName: user?.displayName || user?.email?.split('@')[0] || 'An√¥nimo',
          authorPhoto: user?.photoURL || '',
          createdAt: now,
          updatedAt: now
        };
        TEAM_NOTES.push(newNote);
      }
      
      await persistTeamNotes();
      closeTeamNoteModal();
      renderTeamNotes();
      mgToast('Nota salva!');
      
      } catch(err) {
        console.error('‚ùå Erro ao salvar nota:', err);
        console.error('‚ùå Stack trace:', err.stack);
        mgToast('Erro ao salvar nota: ' + (err.message || 'Erro desconhecido'));
      }
    }
    window.saveTeamNote = saveTeamNote;

    function editTeamNote(noteId){
      openTeamNoteModal(null, noteId);
    }
    window.editTeamNote = editTeamNote;

    async function deleteTeamNote(noteId){
      if(!confirm('Tem certeza que deseja excluir esta nota?')) return;
      
      TEAM_NOTES = TEAM_NOTES.filter(n => n.id !== noteId);
      await persistTeamNotes();
      renderTeamNotes();
      mgToast('Nota exclu√≠da');
    }
    window.deleteTeamNote = deleteTeamNote;
    
    // Expandir nota em modal
    function expandTeamNote(noteId){
      const note = TEAM_NOTES.find(n => n.id === noteId);
      if(!note){
        console.error('Nota n√£o encontrada:', noteId);
        return;
      }
      
      const modal = document.getElementById('expandNoteModal');
      const titleEl = document.getElementById('expandNoteModalTitle');
      const contentEl = document.getElementById('expandNoteContent');
      const attachmentsEl = document.getElementById('expandNoteAttachments');
      const authorEl = document.getElementById('expandNoteAuthor');
      
      if(!modal || !contentEl || !attachmentsEl || !authorEl) {
        console.error('Elementos do modal de expans√£o n√£o encontrados');
        return;
      }
      
      // T√≠tulo da coluna
      const columnName = TEAM_NOTES_COLUMNS[note.column]?.name || 'Nota';
      const columnIcon = TEAM_NOTES_COLUMNS[note.column]?.icon || 'üìù';
      titleEl.textContent = `${columnIcon} ${columnName} - Nota Completa`;
      
      // Conte√∫do (com quebras de linha preservadas e links)
      const content = escapeHtml(note.content || '').replace(/\n/g, '<br>');
      const contentWithLinks = linkifyText(content);
      contentEl.innerHTML = contentWithLinks;
      
      // Anexos
      if(note.attachments && note.attachments.length > 0){
        attachmentsEl.innerHTML = note.attachments.map(url => 
          `<img src="${url}" style="max-width: 100%; max-height: 400px; border-radius: 8px; cursor: pointer; border: 1px solid rgba(255,255,255,0.1);" onclick="window.open('${url}', '_blank')">`
        ).join('');
        attachmentsEl.style.display = 'flex';
      } else {
        attachmentsEl.style.display = 'none';
      }
      
      // Autor e data
      const authorName = note.authorName || 'An√¥nimo';
      const authorPhoto = note.authorPhoto || '';
      const date = note.createdAt ? new Date(note.createdAt).toLocaleDateString('pt-BR', { 
        day: '2-digit', 
        month: 'long', 
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      }) : '';
      
      authorEl.innerHTML = `
        ${authorPhoto ? `<img src="${authorPhoto}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;" alt="">` : ''}
        <span style="color: #e2e8f0; font-weight: 600;">${authorName}</span>
        <span style="opacity: 0.7;">‚Ä¢ ${date}</span>
      `;
      
      // Abrir modal
      modal.classList.add('show');
      document.body.style.overflow = 'hidden';
    }
    window.expandTeamNote = expandTeamNote;
    
    function closeExpandNoteModal(){
      const modal = document.getElementById('expandNoteModal');
      if(!modal) return;
      modal.classList.remove('show');
      document.body.style.overflow = '';
    }
    window.closeExpandNoteModal = closeExpandNoteModal;

    // Suporte para colar imagens no textarea
    document.addEventListener('paste', async (e) => {
      const modal = document.getElementById('teamNotesModal');
      if(!modal || !modal.classList.contains('show')) return;
      
      const items = e.clipboardData?.items;
      if(!items) return;
      
      for(const item of items){
        if(item.type.startsWith('image/')){
          e.preventDefault();
          const file = item.getAsFile();
          if(file){
            const fakeEvent = { target: { files: [file], value: '' } };
            await handleTeamNoteFileSelect(fakeEvent);
          }
          break;
        }
      }
    });
    
    /* ========== TEMPLATE DE TR√ÅFEGO ========== */
    function openTrafficTemplateModal(){
      const modal = document.getElementById('trafficTemplateModal');
      if(!modal) return;
      
      // Limpar todos os campos
      document.getElementById('trafficCampGoogle').checked = false;
      document.getElementById('trafficCampMeta').checked = false;
      document.getElementById('trafficCampNenhuma').checked = false;
      document.getElementById('trafficCampDetails').value = '';
      document.getElementById('trafficLeadsGerando').value = '';
      document.getElementById('trafficLeadsOntem').value = '';
      document.getElementById('trafficLeadsMes').value = '';
      document.getElementById('trafficInvestimento').value = '';
      document.getElementById('trafficCPL').value = '';
      document.getElementById('trafficLeadsCaindo').value = '';
      document.getElementById('trafficCTR').value = '';
      document.getElementById('trafficMelhoresAnuncios').value = '';
      document.getElementById('trafficMelhoresAnunciosCustom').value = '';
      document.getElementById('trafficMelhoresAnunciosCustom').style.display = 'none';
      document.getElementById('trafficComentarios').value = '';
      document.getElementById('trafficComentariosDetails').value = '';
      document.getElementById('trafficComentariosDetails').style.display = 'none';
      document.getElementById('trafficOtimizacao').value = '';
      document.getElementById('trafficOtimizacaoDetails').value = '';
      document.getElementById('trafficOtimizacaoDetails').style.display = 'none';
      document.getElementById('trafficInsight').value = '';
      document.getElementById('trafficInsightCustom').value = '';
      document.getElementById('trafficInsightCustom').style.display = 'none';
      document.getElementById('trafficDecisao').value = '';
      document.getElementById('trafficDecisaoCustom').value = '';
      document.getElementById('trafficDecisaoCustom').style.display = 'none';
      
      modal.classList.add('show');
      document.body.style.overflow = 'hidden';
    }
    window.openTrafficTemplateModal = openTrafficTemplateModal;
    
    function closeTrafficTemplateModal(){
      const modal = document.getElementById('trafficTemplateModal');
      if(!modal) return;
      modal.classList.remove('show');
      document.body.style.overflow = '';
    }
    window.closeTrafficTemplateModal = closeTrafficTemplateModal;
    
    async function saveTrafficTemplate(){
      try {
        // Coletar dados do formul√°rio
        const campanhasGoogle = document.getElementById('trafficCampGoogle').checked;
        const campanhasMeta = document.getElementById('trafficCampMeta').checked;
        const campanhasNenhuma = document.getElementById('trafficCampNenhuma').checked;
        const campanhasDetalhes = document.getElementById('trafficCampDetails').value.trim();
        
        let campanhasTexto = '';
        if(campanhasNenhuma){
          campanhasTexto = 'Nenhuma rodando';
        } else if(campanhasGoogle || campanhasMeta){
          const plataformas = [];
          if(campanhasGoogle) plataformas.push('Google Ads');
          if(campanhasMeta) plataformas.push('Meta Ads');
          campanhasTexto = plataformas.join(' + ');
          if(campanhasDetalhes) campanhasTexto += ` (${campanhasDetalhes})`;
        } else {
          campanhasTexto = campanhasDetalhes || '-';
        }
        
        const leadsGerando = document.getElementById('trafficLeadsGerando').value;
        const leadsOntem = document.getElementById('trafficLeadsOntem').value;
        const leadsMes = document.getElementById('trafficLeadsMes').value;
        const investimento = document.getElementById('trafficInvestimento').value.trim();
        const cpl = document.getElementById('trafficCPL').value.trim();
        const leadsCaindo = document.getElementById('trafficLeadsCaindo').value;
        const ctr = document.getElementById('trafficCTR').value.trim();
        
        let melhoresAnuncios = document.getElementById('trafficMelhoresAnuncios').value;
        if(melhoresAnuncios === 'personalizado'){
          melhoresAnuncios = document.getElementById('trafficMelhoresAnunciosCustom').value.trim();
        }
        
        let comentarios = document.getElementById('trafficComentarios').value;
        if(comentarios === 'Sim'){
          const detalhes = document.getElementById('trafficComentariosDetails').value.trim();
          if(detalhes) comentarios += `: ${detalhes}`;
        }
        
        let otimizacao = document.getElementById('trafficOtimizacao').value;
        if(otimizacao === 'Sim' || otimizacao === 'Feita'){
          const detalhes = document.getElementById('trafficOtimizacaoDetails').value.trim();
          if(detalhes) otimizacao += `: ${detalhes}`;
        }
        
        let insight = document.getElementById('trafficInsight').value;
        if(insight === 'personalizado'){
          insight = document.getElementById('trafficInsightCustom').value.trim();
        }
        
        let decisao = document.getElementById('trafficDecisao').value;
        if(decisao === 'personalizado'){
          decisao = document.getElementById('trafficDecisaoCustom').value.trim();
        }
        
        // Montar o conte√∫do da nota - formato compacto
        let conteudo = 'üìä RELAT√ìRIO DE TR√ÅFEGO\n';
        conteudo += `üìÖ ${new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' })}\n\n`;
        
        conteudo += `üéØ Campanhas: ${campanhasTexto}\n`;
        if(leadsGerando) conteudo += `üìä Gerando leads: ${leadsGerando}\n`;
        if(leadsOntem) conteudo += `üìà Leads ontem: ${leadsOntem}\n`;
        if(leadsMes) conteudo += `üìÖ Leads m√™s: ${leadsMes}\n`;
        if(investimento) conteudo += `ÔøΩ Investimento: ${investimento}\n`;
        if(cpl) conteudo += `üíµ CPL: ${cpl}\n`;
        if(leadsCaindo) conteudo += `‚úÖ Leads no CRM: ${leadsCaindo}\n`;
        if(ctr) conteudo += `üéØ CTR: ${ctr}\n`;
        if(melhoresAnuncios) conteudo += `‚≠ê Melhores an√∫ncios: ${melhoresAnuncios}\n`;
        if(comentarios) conteudo += `üí¨ Coment√°rios: ${comentarios}\n`;
        if(otimizacao) conteudo += `üõ†Ô∏è Otimiza√ß√£o: ${otimizacao}\n`;
        if(insight) conteudo += `üí° Insight: ${insight}\n`;
        if(decisao) conteudo += `üéØ Decis√£o: ${decisao}\n`;
        
        // Verificar se h√° conte√∫do suficiente
        if(conteudo.split('\n').filter(line => line.trim()).length <= 3){
          mgToast('Preencha pelo menos algumas perguntas');
          return;
        }
        
        // Verificar UID
        const uid = getTeamNotesTargetUid();
        if(!uid){
          console.error('‚ùå Nenhum UID encontrado para salvar nota');
          mgToast('Erro: Usu√°rio n√£o identificado. Fa√ßa login novamente.');
          return;
        }
        
        // Usar getCurrentUser para suportar sess√£o admin
        const user = typeof window.getCurrentUser === 'function' ? window.getCurrentUser() : auth.currentUser;
        const now = new Date().toISOString();
        
        // Criar nova nota
        const newNote = {
          id: uuid(),
          column: 'trafego',
          content: conteudo,
          attachments: [],
          authorId: user?.uid || '',
          authorName: user?.displayName || user?.email?.split('@')[0] || 'An√¥nimo',
          authorPhoto: user?.photoURL || '',
          createdAt: now,
          updatedAt: now
        };
        
        TEAM_NOTES.push(newNote);
        await persistTeamNotes();
        closeTrafficTemplateModal();
        renderTeamNotes();
        mgToast('Relat√≥rio de tr√°fego salvo!');
        
      } catch(err) {
        console.error('‚ùå Erro ao salvar relat√≥rio de tr√°fego:', err);
        mgToast('Erro ao salvar relat√≥rio: ' + (err.message || 'Erro desconhecido'));
      }
    }
    window.saveTrafficTemplate = saveTrafficTemplate;
    /* ========== FIM TEMPLATE DE TR√ÅFEGO ========== */
    
    /* ========== TEMPLATE DE CONTE√öDO/CANAIS ========== */
    function openContentTemplateModal(){
      const modal = document.getElementById('contentTemplateModal');
      if(!modal) return;
      
      // Limpar todos os campos
      document.getElementById('contentAlcanceMes').value = '';
      document.getElementById('contentAlcanceOntem').value = '';
      document.getElementById('contentAlcanceInstagram').value = '';
      document.getElementById('contentAlcanceGoogle').value = '';
      document.getElementById('contentMaterialDisponivel').value = '';
      document.getElementById('contentMaterialDetails').value = '';
      document.getElementById('contentMaterialDetails').style.display = 'none';
      document.getElementById('contentProximosConteudos').value = '';
      document.getElementById('contentProximosDetails').value = '';
      document.getElementById('contentProximosDetails').style.display = 'none';
      document.getElementById('contentResultadoOntem').value = '';
      document.getElementById('contentResultadoOntemDetails').value = '';
      document.getElementById('contentResultadoOntemDetails').style.display = 'none';
      document.getElementById('contentPostsMes').value = '';
      document.getElementById('contentReelsMes').value = '';
      document.getElementById('contentStoriesMes').value = '';
      document.getElementById('contentMelhorReel').value = '';
      document.getElementById('contentConteudosFracos').value = '';
      document.getElementById('contentDMsRespondidas').value = '';
      document.getElementById('contentComentariosRespondidos').value = '';
      document.getElementById('contentComentarioNegativo').value = '';
      document.getElementById('contentComentarioNegativoDetails').value = '';
      document.getElementById('contentComentarioNegativoDetails').style.display = 'none';
      document.getElementById('contentInsight').value = '';
      document.getElementById('contentInsightCustom').value = '';
      document.getElementById('contentInsightCustom').style.display = 'none';
      document.getElementById('contentAcaoDecidida').value = '';
      document.getElementById('contentAcaoDecididaCustom').value = '';
      document.getElementById('contentAcaoDecididaCustom').style.display = 'none';
      
      modal.classList.add('show');
      document.body.style.overflow = 'hidden';
    }
    window.openContentTemplateModal = openContentTemplateModal;
    
    function closeContentTemplateModal(){
      const modal = document.getElementById('contentTemplateModal');
      if(!modal) return;
      modal.classList.remove('show');
      document.body.style.overflow = '';
    }
    window.closeContentTemplateModal = closeContentTemplateModal;
    
    async function saveContentTemplate(){
      try {
        // Coletar dados do formul√°rio
        const alcanceMes = document.getElementById('contentAlcanceMes').value.trim();
        const alcanceOntem = document.getElementById('contentAlcanceOntem').value.trim();
        const alcanceInstagram = document.getElementById('contentAlcanceInstagram').value.trim();
        const alcanceGoogle = document.getElementById('contentAlcanceGoogle').value.trim();
        
        let materialDisponivel = document.getElementById('contentMaterialDisponivel').value;
        if(materialDisponivel === 'personalizado'){
          materialDisponivel = document.getElementById('contentMaterialDetails').value.trim();
        }
        
        let proximosConteudos = document.getElementById('contentProximosConteudos').value;
        if(proximosConteudos === 'personalizado'){
          proximosConteudos = document.getElementById('contentProximosDetails').value.trim();
        }
        
        let resultadoOntem = document.getElementById('contentResultadoOntem').value;
        if(resultadoOntem === 'personalizado'){
          resultadoOntem = document.getElementById('contentResultadoOntemDetails').value.trim();
        }
        
        const postsMes = document.getElementById('contentPostsMes').value;
        const reelsMes = document.getElementById('contentReelsMes').value;
        const storiesMes = document.getElementById('contentStoriesMes').value;
        const melhorReel = document.getElementById('contentMelhorReel').value.trim();
        const conteudosFracos = document.getElementById('contentConteudosFracos').value.trim();
        
        const dmsRespondidas = document.getElementById('contentDMsRespondidas').value;
        const comentariosRespondidos = document.getElementById('contentComentariosRespondidos').value;
        
        let comentarioNegativo = document.getElementById('contentComentarioNegativo').value;
        if(comentarioNegativo === 'Sim'){
          const detalhes = document.getElementById('contentComentarioNegativoDetails').value.trim();
          if(detalhes) comentarioNegativo += `: ${detalhes}`;
        }
        
        let insight = document.getElementById('contentInsight').value;
        if(insight === 'personalizado'){
          insight = document.getElementById('contentInsightCustom').value.trim();
        }
        
        let acaoDecidida = document.getElementById('contentAcaoDecidida').value;
        if(acaoDecidida === 'personalizado'){
          acaoDecidida = document.getElementById('contentAcaoDecididaCustom').value.trim();
        }
        
        // Montar o conte√∫do da nota - formato compacto
        let conteudo = 'üì¢ RELAT√ìRIO DE CONTE√öDO\n';
        conteudo += `üìÖ ${new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' })}\n\n`;
        
        // Alcance total
        if(alcanceMes || alcanceOntem){
          conteudo += `üåê Alcance total: ${alcanceMes || '-'} (m√™s) | ${alcanceOntem || '-'} (ontem)\n`;
        }
        
        // Instagram e Google
        if(alcanceInstagram || alcanceGoogle){
          conteudo += `üì± IG: ${alcanceInstagram || '-'} | üîç Google: ${alcanceGoogle || '-'}\n`;
        }
        
        if(materialDisponivel) conteudo += `üì¶ Material: ${materialDisponivel}\n`;
        if(proximosConteudos) conteudo += `üóìÔ∏è Pr√≥ximos: ${proximosConteudos}\n`;
        if(resultadoOntem) conteudo += `üìà Ontem: ${resultadoOntem}\n`;
        
        // Conte√∫dos no m√™s
        if(postsMes || reelsMes || storiesMes){
          conteudo += `üìÖ M√™s: ${postsMes || 0} posts | ${reelsMes || 0} reels | ${storiesMes || 0} stories\n`;
        }
        
        // Melhor reel e fracos
        if(melhorReel || conteudosFracos){
          if(melhorReel) conteudo += `üé• Melhor: ${melhorReel}\n`;
          if(conteudosFracos) conteudo += `üìâ Fracos: ${conteudosFracos}\n`;
        }
        
        if(dmsRespondidas) conteudo += `üíå DMs: ${dmsRespondidas}\n`;
        if(comentariosRespondidos) conteudo += `üí¨ Coment√°rios: ${comentariosRespondidos}\n`;
        if(comentarioNegativo) conteudo += `‚ö†Ô∏è Relevante: ${comentarioNegativo}\n`;
        if(insight) conteudo += `üí° Insight: ${insight}\n`;
        if(acaoDecidida) conteudo += `üéØ A√ß√£o: ${acaoDecidida}\n`;
        
        // Verificar se h√° conte√∫do suficiente
        if(conteudo.split('\n').filter(line => line.trim()).length <= 3){
          mgToast('Preencha pelo menos algumas perguntas');
          return;
        }
        
        // Verificar UID
        const uid = getTeamNotesTargetUid();
        if(!uid){
          console.error('‚ùå Nenhum UID encontrado para salvar nota');
          mgToast('Erro: Usu√°rio n√£o identificado. Fa√ßa login novamente.');
          return;
        }
        
        // Usar getCurrentUser para suportar sess√£o admin
        const user = typeof window.getCurrentUser === 'function' ? window.getCurrentUser() : auth.currentUser;
        const now = new Date().toISOString();
        
        // Criar nova nota
        const newNote = {
          id: uuid(),
          column: 'canais',
          content: conteudo,
          attachments: [],
          authorId: user?.uid || '',
          authorName: user?.displayName || user?.email?.split('@')[0] || 'An√¥nimo',
          authorPhoto: user?.photoURL || '',
          createdAt: now,
          updatedAt: now
        };
        
        TEAM_NOTES.push(newNote);
        await persistTeamNotes();
        closeContentTemplateModal();
        renderTeamNotes();
        mgToast('Relat√≥rio de conte√∫do salvo!');
        
      } catch(err) {
        console.error('‚ùå Erro ao salvar relat√≥rio de conte√∫do:', err);
        mgToast('Erro ao salvar relat√≥rio: ' + (err.message || 'Erro desconhecido'));
      }
    }
    window.saveContentTemplate = saveContentTemplate;
    
    /* ========== TEMPLATE DE LIDERAN√áA (CHECK-IN DI√ÅRIO) ========== */
    
    // Fun√ß√£o para mostrar/ocultar campo de observa√ß√£o
    function toggleLeadershipObs(selectEl, obsId) {
      const obsInput = document.getElementById(obsId);
      if(obsInput) {
        // Mostrar campo de observa√ß√£o quando uma op√ß√£o √© selecionada
        obsInput.style.display = selectEl.value ? 'block' : 'none';
      }
    }
    window.toggleLeadershipObs = toggleLeadershipObs;
    
    function openLeadershipTemplateModal(){
      const modal = document.getElementById('leadershipTemplateModal');
      if(modal){
        modal.style.display = 'flex';
        // Limpar campos de sele√ß√£o
        document.getElementById('leadershipLeadsEntraram').value = '';
        document.getElementById('leadershipLeadsAtendidos').value = '';
        document.getElementById('leadershipCustoOk').value = '';
        document.getElementById('leadershipConteudoAtivo').value = '';
        document.getElementById('leadershipMarcaVisivel').value = '';
        document.getElementById('leadershipStatusGeral').value = '';
        document.getElementById('leadershipInsight').value = '';
        document.getElementById('leadershipDecisao').value = '';
        // Limpar campo de a√ß√£o r√°pida
        const acaoRapidaEl = document.getElementById('leadershipAcaoRapida');
        if(acaoRapidaEl) acaoRapidaEl.value = '';
        // Limpar e ocultar campos de observa√ß√£o
        const obsFields = ['leadershipLeadsEntraramObs', 'leadershipLeadsAtendidosObs', 'leadershipCustoOkObs', 
                          'leadershipConteudoAtivoObs', 'leadershipMarcaVisivelObs', 'leadershipStatusGeralObs', 'leadershipDecisaoObs'];
        obsFields.forEach(id => {
          const el = document.getElementById(id);
          if(el) { el.value = ''; el.style.display = 'none'; }
        });
      }
    }
    window.openLeadershipTemplateModal = openLeadershipTemplateModal;
    
    function closeLeadershipTemplateModal(){
      const modal = document.getElementById('leadershipTemplateModal');
      if(modal) modal.style.display = 'none';
    }
    window.closeLeadershipTemplateModal = closeLeadershipTemplateModal;
    
    async function saveLeadershipTemplate(){
      try {
        const leadsEntraram = document.getElementById('leadershipLeadsEntraram').value;
        const leadsEntraramObs = document.getElementById('leadershipLeadsEntraramObs').value.trim();
        const leadsAtendidos = document.getElementById('leadershipLeadsAtendidos').value;
        const leadsAtendidosObs = document.getElementById('leadershipLeadsAtendidosObs').value.trim();
        const custoOk = document.getElementById('leadershipCustoOk').value;
        const custoOkObs = document.getElementById('leadershipCustoOkObs').value.trim();
        const conteudoAtivo = document.getElementById('leadershipConteudoAtivo').value;
        const conteudoAtivoObs = document.getElementById('leadershipConteudoAtivoObs').value.trim();
        const marcaVisivel = document.getElementById('leadershipMarcaVisivel').value;
        const marcaVisivelObs = document.getElementById('leadershipMarcaVisivelObs').value.trim();
        const statusGeral = document.getElementById('leadershipStatusGeral').value;
        const statusGeralObs = document.getElementById('leadershipStatusGeralObs').value.trim();
        const insight = document.getElementById('leadershipInsight').value.trim();
        const decisao = document.getElementById('leadershipDecisao').value;
        const decisaoObs = document.getElementById('leadershipDecisaoObs').value.trim();
        
        // Pegar a√ß√£o r√°pida
        const acaoRapida = document.getElementById('leadershipAcaoRapida')?.value?.trim() || '';
        
        // Verificar se tem a√ß√£o r√°pida OU campos completos
        const temAcaoRapida = acaoRapida.length > 0;
        const temCamposCompletos = leadsEntraram && leadsAtendidos && custoOk && conteudoAtivo && marcaVisivel && statusGeral && decisao;
        
        // Validar: precisa ter a√ß√£o r√°pida OU todos os campos obrigat√≥rios
        if(!temAcaoRapida && !temCamposCompletos) {
          mgToast('‚ö†Ô∏è Preencha todos os campos obrigat√≥rios OU adicione uma a√ß√£o r√°pida');
          return;
        }
        
        // Montar conte√∫do formatado para WhatsApp
        const dataHoje = new Date().toLocaleDateString('pt-BR');
        let conteudo = '';
        
        // Se apenas a√ß√£o r√°pida foi preenchida
        if(temAcaoRapida && !temCamposCompletos) {
          conteudo = `‚ö° *A√á√ÉO DE LIDERAN√áA*\n`;
          conteudo += `_${dataHoje}_\n\n`;
          conteudo += `*üìå A√á√ÉO:*\n${acaoRapida}`;
        } else {
          // Check-in completo
          conteudo = `üß≠ *CHECK-IN DI√ÅRIO ‚Äî VIS√ÉO MACRO*\n`;
          conteudo += `_${dataHoje}_\n\n`;
          
          conteudo += `*üìã STATUS DO DIA*\n`;
          conteudo += `‚Ä¢ Leads entraram? *${leadsEntraram}*${leadsEntraramObs ? ` ‚Äî ${leadsEntraramObs}` : ''}\n`;
          conteudo += `‚Ä¢ Leads foram atendidos? *${leadsAtendidos}*${leadsAtendidosObs ? ` ‚Äî ${leadsAtendidosObs}` : ''}\n`;
          conteudo += `‚Ä¢ Custo est√° ok? *${custoOk}*${custoOkObs ? ` ‚Äî ${custoOkObs}` : ''}\n`;
          conteudo += `‚Ä¢ Conte√∫do ativo? *${conteudoAtivo}*${conteudoAtivoObs ? ` ‚Äî ${conteudoAtivoObs}` : ''}\n`;
          conteudo += `‚Ä¢ Marca vis√≠vel hoje? *${marcaVisivel}*${marcaVisivelObs ? ` ‚Äî ${marcaVisivelObs}` : ''}\n\n`;
          
          conteudo += `*üö¶ STATUS GERAL*\n`;
          conteudo += `${statusGeral}${statusGeralObs ? `\n_${statusGeralObs}_` : ''}\n\n`;
          
          if(insight) {
            conteudo += `*üí° INSIGHT DO DIA*\n`;
            conteudo += `${insight}\n\n`;
          }
          
          conteudo += `*üéØ DECIS√ÉO DE HOJE*\n`;
          conteudo += `${decisao}${decisaoObs ? ` ‚Äî ${decisaoObs}` : ''}`;
          
          // Se tamb√©m tem a√ß√£o r√°pida no check-in completo, adicionar
          if(temAcaoRapida) {
            conteudo += `\n\n*‚ö° A√á√ÉO ADICIONAL:*\n${acaoRapida}`;
          }
        }
        
        // Usar getCurrentUser para suportar sess√£o admin
        const user = typeof window.getCurrentUser === 'function' ? window.getCurrentUser() : auth.currentUser;
        const now = new Date().toISOString();
        
        // Criar nova nota
        const newNote = {
          id: uuid(),
          column: 'lideranca',
          content: conteudo,
          attachments: [],
          authorId: user?.uid || '',
          authorName: user?.displayName || user?.email?.split('@')[0] || 'An√¥nimo',
          authorPhoto: user?.photoURL || '',
          createdAt: now,
          updatedAt: now
        };
        
        TEAM_NOTES.push(newNote);
        await persistTeamNotes();
        closeLeadershipTemplateModal();
        renderTeamNotes();
        
        // Mensagem diferenciada dependendo do que foi salvo
        if(temAcaoRapida && !temCamposCompletos) {
          mgToast('‚úÖ A√ß√£o de lideran√ßa salva!');
        } else {
          mgToast('‚úÖ Check-in di√°rio salvo!');
        }
        
      } catch(err) {
        console.error('‚ùå Erro ao salvar check-in de lideran√ßa:', err);
        mgToast('Erro ao salvar check-in: ' + (err.message || 'Erro desconhecido'));
      }
    }
    window.saveLeadershipTemplate = saveLeadershipTemplate;
    /* ========== FIM TEMPLATE DE LIDERAN√áA ========== */
    /* ========== FIM TEMPLATE DE CONTE√öDO/CANAIS ========== */

    /* ========== RESUMO AUTOM√ÅTICO DAS NOTAS ========== */
    let currentSummaryFilter = 'semana'; // 'dia', 'semana', 'mes'
    console.log('üéØ [INIT] currentSummaryFilter inicializado como:', currentSummaryFilter);
    
    function setSummaryFilter(filter) {
      console.log('üéØ [FILTER] setSummaryFilter chamado com:', filter);
      
      // N√ÉO limpar cache ao mudar de filtro - cada per√≠odo tem seu pr√≥prio cache salvo
      currentSummaryFilter = filter;
      console.log('üéØ [FILTER] currentSummaryFilter agora √©:', currentSummaryFilter);
      
      // Atualizar bot√µes visuais
      document.querySelectorAll('.summary-filter-btn').forEach(btn => {
        if(btn.dataset.filter === filter) {
          btn.style.background = 'rgba(99,102,241,0.3)';
          btn.style.borderColor = 'rgba(99,102,241,0.5)';
          btn.style.color = '#e2e8f0';
          btn.classList.add('active');
        } else {
          btn.style.background = 'transparent';
          btn.style.borderColor = 'rgba(99,102,241,0.3)';
          btn.style.color = '#94a3b8';
          btn.classList.remove('active');
        }
      });
      
      // Atualizar resumos
      updateSummaries();
    }
    window.setSummaryFilter = setSummaryFilter;
    
    function getNotesInPeriod(column, filter) {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      
      let startDate;
      if(filter === 'dia') {
        startDate = today;
      } else if(filter === 'semana') {
        startDate = new Date(today);
        startDate.setDate(today.getDate() - 7);
      } else { // mes
        startDate = new Date(today);
        startDate.setMonth(today.getMonth() - 1);
      }
      
      return TEAM_NOTES.filter(note => {
        if(note.column !== column) return false;
        // Tentar converter createdAt de v√°rios formatos
        let noteDate;
        if(note.createdAt) {
          if(typeof note.createdAt === 'string') {
            noteDate = new Date(note.createdAt);
          } else if(note.createdAt.seconds) {
            // Firebase Timestamp
            noteDate = new Date(note.createdAt.seconds * 1000);
          } else if(note.createdAt.toDate) {
            noteDate = note.createdAt.toDate();
          } else {
            noteDate = new Date(note.createdAt);
          }
        } else {
          noteDate = new Date(); // Fallback para agora
        }
        return noteDate >= startDate;
      }).sort((a, b) => {
        const dateA = new Date(a.createdAt?.seconds ? a.createdAt.seconds * 1000 : a.createdAt);
        const dateB = new Date(b.createdAt?.seconds ? b.createdAt.seconds * 1000 : b.createdAt);
        return dateB - dateA;
      });
    }
    
    function parseTrafegoNote(content) {
      const data = {};
      if(!content) return data;
      
      const lines = content.split('\n');
      const lower = content.toLowerCase();
      
      // Extrair TODOS os n√∫meros que parecem leads
      const allLeadsMatches = content.match(/(\d+)\s*(leads?|lead)/gi) || [];
      let totalLeads = 0;
      allLeadsMatches.forEach(m => {
        const num = parseInt(m.match(/\d+/)[0]) || 0;
        if(num > 0 && num < 10000) totalLeads += num;
      });
      if(totalLeads > 0) data.leadsOntem = totalLeads.toString();
      
      // Extrair "quantos leads hoje" ou similar
      const quantosLeadsMatch = content.match(/quantos leads[^\d]*(\d+)/i);
      if(quantosLeadsMatch) {
        data.leadsOntem = quantosLeadsMatch[1];
      }
      
      // Extrair leads do m√™s
      const leadsMesMatch = content.match(/leads?\s*(do\s*)?m[√™e]s[^\d]*(\d+)/i) || content.match(/(\d+)\s*leads?\s*(no\s*)?m[√™e]s/i);
      if(leadsMesMatch) {
        const num = leadsMesMatch[2] || leadsMesMatch[1];
        if(num) data.leadsMes = num;
      }
      
      // Campanhas ativas
      let campanhas = [];
      if(lower.includes('google ads') || lower.includes('google')) campanhas.push('Google Ads');
      if(lower.includes('meta ads') || lower.includes('meta') || lower.includes('facebook') || lower.includes('instagram ads')) campanhas.push('Meta Ads');
      if(lower.includes('tiktok')) campanhas.push('TikTok Ads');
      if(campanhas.length > 0) data.campanhas = campanhas.join(', ');
      
      // CPL
      const cplMatch = content.match(/cpl[^\d]*R?\$?\s*([\d,\.]+)/i) || content.match(/R?\$?\s*([\d,\.]+)[^\d]*cpl/i);
      if(cplMatch) data.cpl = 'R$ ' + cplMatch[1];
      
      // CTR
      const ctrMatch = content.match(/ctr[^\d]*([\d,\.]+)\s*%?/i);
      if(ctrMatch) data.ctr = ctrMatch[1] + '%';
      
      // Investimento
      const investMatch = content.match(/investimento[^\d]*R?\$?\s*([\d,\.]+)/i) || content.match(/gasto[^\d]*R?\$?\s*([\d,\.]+)/i);
      if(investMatch) data.investimento = 'R$ ' + investMatch[1];
      
      // Insights e observa√ß√µes - capturar textos relevantes
      lines.forEach(line => {
        const l = line.toLowerCase();
        if(line.includes('Insight:')) data.insight = line.split('Insight:')[1]?.trim();
        if(line.includes('Decis√£o:')) data.decisao = line.split('Decis√£o:')[1]?.trim();
        if(line.includes('Otimiza√ß√£o:')) data.otimizacao = line.split('Otimiza√ß√£o:')[1]?.trim();
        if(line.includes('Melhores an√∫ncios:')) data.melhoresAnuncios = line.split('Melhores an√∫ncios:')[1]?.trim();
        
        // Capturar observa√ß√µes importantes
        if(l.includes('observ') || l.includes('nota:') || l.includes('obs:')) {
          data.observacao = line;
        }
      });
      
      // Se n√£o extraiu leads estruturados mas tem n√∫mero no texto
      if(!data.leadsOntem) {
        const simpleNumMatch = content.match(/(\d+)\s*leads?/i);
        if(simpleNumMatch) data.leadsOntem = simpleNumMatch[1];
      }
      
      // Guardar conte√∫do completo para an√°lise
      data.conteudoOriginal = content;
      
      return data;
    }
    
    function parseConteudoNote(content) {
      const data = {};
      if(!content) return data;
      
      const lines = content.split('\n');
      const lower = content.toLowerCase();
      
      // Alcance - extrair n√∫meros grandes (geralmente alcance)
      const alcanceMatches = content.match(/alcance[^\d]*([\d.,]+)\s*k?/gi) || [];
      alcanceMatches.forEach(m => {
        const numMatch = m.match(/([\d.,]+)\s*(k)?/i);
        if(numMatch) {
          let val = parseFloat(numMatch[1].replace('.','').replace(',','.'));
          if(numMatch[2]?.toLowerCase() === 'k') val *= 1000;
          if(val > 100) data.alcanceTotal = val.toLocaleString('pt-BR');
        }
      });
      
      // Instagram espec√≠fico
      const igMatch = content.match(/instagram[^\d]*([\d.,]+)\s*(k)?/i);
      if(igMatch) {
        let val = parseFloat(igMatch[1].replace('.','').replace(',','.'));
        if(igMatch[2]?.toLowerCase() === 'k') val *= 1000;
        data.alcanceIG = val.toString();
      }
      
      // Formato "15.6k" isolado
      const kMatch = content.match(/([\d.,]+)\s*k\b/i);
      if(kMatch && !data.alcanceTotal) {
        let val = parseFloat(kMatch[1].replace(',','.')) * 1000;
        data.alcanceTotal = val.toLocaleString('pt-BR');
      }
      
      // Posts, Reels, Stories
      const postsMatch = content.match(/(\d+)\s*posts?/i);
      const reelsMatch = content.match(/(\d+)\s*reels?/i);
      const storiesMatch = content.match(/(\d+)\s*stor(y|ies)/i);
      if(postsMatch || reelsMatch || storiesMatch) {
        const p = postsMatch ? postsMatch[1] : '0';
        const r = reelsMatch ? reelsMatch[1] : '0';
        const s = storiesMatch ? storiesMatch[1] : '0';
        data.conteudosMes = `${p} posts, ${r} reels, ${s} stories`;
      }
      
      // DMs
      const dmsMatch = content.match(/(\d+)\s*dms?/i);
      if(dmsMatch) data.dms = dmsMatch[1];
      
      // Coment√°rios
      const comentMatch = content.match(/(\d+)\s*coment[a√°]rios?/i);
      if(comentMatch) data.comentarios = comentMatch[1];
      
      // Insights e a√ß√µes
      lines.forEach(line => {
        if(line.includes('Insight:')) data.insight = line.split('Insight:')[1]?.trim();
        if(line.includes('A√ß√£o:')) data.acao = line.split('A√ß√£o:')[1]?.trim();
        if(line.includes('Material:')) data.material = line.split('Material:')[1]?.trim();
        if(line.includes('Melhor:')) data.melhorReel = line.split('Melhor:')[1]?.trim();
      });
      
      // Guardar conte√∫do completo
      data.conteudoOriginal = content;
      
      return data;
    }
    
    // Formatar notas brutas para WhatsApp (usado no modo DI√ÅRIO)
    function formatNotesForWpp(notes, tipo) {
      if(!notes.length) return null;
      
      const now = new Date();
      const hoje = now.toLocaleDateString('pt-BR');
      const emoji = tipo === 'trafego' ? 'üìä' : 'üìù';
      const titulo = tipo === 'trafego' ? 'TR√ÅFEGO' : 'CONTE√öDO';
      
      let wpp = `*${emoji} ${titulo} ‚Äî ${hoje}*\n\n`;
      
      notes.forEach((note, i) => {
        const dateVal = note.createdAt || note.timestamp;
        let noteDate = new Date();
        if(dateVal) {
          if(dateVal.seconds) noteDate = new Date(dateVal.seconds * 1000);
          else if(dateVal.toDate) noteDate = dateVal.toDate();
          else noteDate = new Date(dateVal);
        }
        
        const hora = noteDate.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
        
        wpp += `*${hora}*\n`;
        // Formatar o conte√∫do preservando quebras de linha
        const content = note.content.trim()
          .split('\n')
          .map(line => line.trim())
          .filter(line => line)
          .join('\n‚Ä¢ ');
        wpp += `‚Ä¢ ${content}\n`;
        
        if(i < notes.length - 1) wpp += `\n`;
      });
      
      wpp += `\n_${notes.length} anota√ß√£o(√µes) registrada(s)_`;
      return wpp;
    }
    
    // Gerar resumo com IA para semana/m√™s
    async function generateAISummary(notes, tipo, periodo) {
      console.log('ü§ñ [IA SUMMARY] Iniciando com', notes.length, 'notas para', tipo, periodo);
      
      if(!notes.length) return null;
      
      const now = new Date();
      const emoji = tipo === 'trafego' ? 'üìä' : 'üìù';
      const titulo = tipo === 'trafego' ? 'TR√ÅFEGO PAGO' : 'PRODU√á√ÉO DE CONTE√öDO';
      
      // Preparar todas as notas para a IA
      let notasTexto = notes.map((note, i) => {
        const dateVal = note.createdAt || note.timestamp;
        let noteDate = new Date();
        if(dateVal) {
          if(dateVal.seconds) noteDate = new Date(dateVal.seconds * 1000);
          else if(dateVal.toDate) noteDate = dateVal.toDate();
          else noteDate = new Date(dateVal);
        }
        const dataStr = noteDate.toLocaleDateString('pt-BR');
        return `[${dataStr}] ${note.content || '(sem conte√∫do)'}`;
      }).join('\n\n');
      
      console.log('ü§ñ [IA SUMMARY] Notas preparadas:', notasTexto.length, 'caracteres');
      console.log('ü§ñ [IA SUMMARY] Preview das notas:', notasTexto.substring(0, 200));
      
      // Definir per√≠odo
      let periodoTexto = '';
      if(periodo === 'semana') {
        const inicio = new Date(now);
        inicio.setDate(now.getDate() - 7);
        periodoTexto = `Semana: ${inicio.toLocaleDateString('pt-BR')} a ${now.toLocaleDateString('pt-BR')}`;
      } else {
        periodoTexto = `M√™s: ${now.toLocaleDateString('pt-BR', {month: 'long', year: 'numeric'})}`;
      }
      
      // Prompt espec√≠fico por tipo
      let prompt = '';
      
      if(tipo === 'trafego') {
        prompt = `Voc√™ √© um analista de marketing digital especialista em tr√°fego pago.

Analise as seguintes anota√ß√µes de tr√°fego pago do per√≠odo (${periodoTexto}) e gere um RESUMO CONSOLIDADO formatado para WhatsApp.

ANOTA√á√ïES:
${notasTexto}

Gere um resumo no seguinte formato (use *texto* para negrito e _texto_ para it√°lico):

*${emoji} RESUMO DE ${titulo}*
_${periodoTexto}_

*üìà RESULTADOS*
‚Ä¢ Total de leads mencionados: X
‚Ä¢ Campanhas ativas: listar
‚Ä¢ CPL m√©dio (se mencionado): R$ X
‚Ä¢ Investimento (se mencionado): R$ X

*üéØ PRINCIPAIS PONTOS*
‚Ä¢ Liste os 3-5 pontos mais importantes das anota√ß√µes

*üí° INSIGHTS E DECIS√ïES*
‚Ä¢ Extraia insights e decis√µes mencionadas

*‚ö†Ô∏è PONTOS DE ATEN√á√ÉO*
‚Ä¢ Problemas ou alertas mencionados

_Resumo gerado com base em ${notes.length} anota√ß√µes_

IMPORTANTE:
- Seja objetivo e direto
- Consolide n√∫meros quando poss√≠vel (some leads, calcule m√©dias)
- Use apenas dados que REALMENTE aparecem nas anota√ß√µes
- Se alguma informa√ß√£o n√£o existe, n√£o invente
- Mantenha o formato WhatsApp com * para negrito`;
      } else {
        prompt = `Voc√™ √© um analista de marketing digital especialista em produ√ß√£o de conte√∫do e redes sociais.

Analise as seguintes anota√ß√µes de conte√∫do/redes sociais do per√≠odo (${periodoTexto}) e gere um RESUMO CONSOLIDADO formatado para WhatsApp.

ANOTA√á√ïES:
${notasTexto}

Gere um resumo no seguinte formato (use *texto* para negrito e _texto_ para it√°lico):

*${emoji} RESUMO DE ${titulo}*
_${periodoTexto}_

*üìä ALCANCE E M√âTRICAS*
‚Ä¢ Alcance total mencionado: X
‚Ä¢ Engajamento (DMs, coment√°rios): X
‚Ä¢ Melhor conte√∫do: descrever

*üé¨ PRODU√á√ÉO*
‚Ä¢ Posts/Reels/Stories produzidos
‚Ä¢ Status dos materiais

*üí° INSIGHTS*
‚Ä¢ Liste os principais aprendizados

*‚úÖ A√á√ïES DEFINIDAS*
‚Ä¢ Pr√≥ximos passos mencionados

_Resumo gerado com base em ${notes.length} anota√ß√µes_

IMPORTANTE:
- Seja objetivo e direto
- Consolide n√∫meros quando poss√≠vel
- Use apenas dados que REALMENTE aparecem nas anota√ß√µes
- Se alguma informa√ß√£o n√£o existe, n√£o invente
- Mantenha o formato WhatsApp com * para negrito`;
      }
      
      console.log('ü§ñ [IA SUMMARY] Prompt gerado:', prompt.length, 'caracteres');
      console.log('ü§ñ [IA SUMMARY] Prompt preview:', prompt.substring(0, 300) + '...');
      
      try {
        const response = await callGeminiAPI(prompt);
        if(response) {
          console.log('ü§ñ [IA SUMMARY] Resposta recebida:', response.length, 'caracteres');
          return response;
        }
        // Se a resposta for null, n√£o usar fallback - retornar null para o caller tratar
        console.warn('‚ö†Ô∏è Resposta da IA foi vazia');
        return null;
      } catch(err) {
        console.error('Erro ao gerar resumo com IA:', err);
        return null; // Retornar null em vez de fallback
      }
    }
    
    // Cache dos resumos gerados pela IA - separado por per√≠odo
    let cachedSummaries = {
      trafego: {
        semana: { text: null, savedAt: null },
        mes: { text: null, savedAt: null }
      },
      conteudo: {
        semana: { text: null, savedAt: null },
        mes: { text: null, savedAt: null }
      },
      _loaded: false
    };
    
    // Carregar resumos salvos do Firebase
    async function loadSavedSummaries() {
      try {
        const uid = getTeamNotesTargetUid();
        if(!uid) return;
        
        const summariesDocRef = doc(db, "usuarios", uid, "teamNotes", "summaries");
        const summariesDoc = await getDoc(summariesDocRef);
        
        if(summariesDoc.exists()) {
          const data = summariesDoc.data();
          // Carregar trafego (semana e m√™s)
          if(data.trafego_semana) {
            cachedSummaries.trafego.semana = data.trafego_semana;
          }
          if(data.trafego_mes) {
            cachedSummaries.trafego.mes = data.trafego_mes;
          }
          // Carregar conteudo (semana e m√™s)
          if(data.conteudo_semana) {
            cachedSummaries.conteudo.semana = data.conteudo_semana;
          }
          if(data.conteudo_mes) {
            cachedSummaries.conteudo.mes = data.conteudo_mes;
          }
          console.log('üì• Resumos carregados do Firebase:', data);
        }
      } catch(err) {
        console.warn('‚ö†Ô∏è Erro ao carregar resumos salvos:', err);
      }
    }
    
    // Salvar resumo no Firebase (por tipo E per√≠odo)
    async function saveSummaryToFirebase(type, filter, text) {
      try {
        const uid = getTeamNotesTargetUid();
        if(!uid) {
          console.warn('‚ö†Ô∏è Nenhum UID para salvar resumo');
          return;
        }
        
        const summariesDocRef = doc(db, "usuarios", uid, "teamNotes", "summaries");
        const savedAt = new Date().toISOString();
        
        // Chave composta: tipo_periodo (ex: trafego_semana, conteudo_mes)
        const key = `${type}_${filter}`;
        const updateData = {};
        updateData[key] = { text, savedAt };
        
        await setDoc(summariesDocRef, updateData, { merge: true });
        
        console.log('‚úÖ Resumo salvo no Firebase:', key);
        
        // Atualizar cache local
        cachedSummaries[type][filter] = { text, savedAt };
        
      } catch(err) {
        console.error('‚ùå Erro ao salvar resumo:', err);
      }
    }

    // Helper para converter WPP para HTML
    function wppToHtml(wpp) {
      return wpp
        .replace(/\*([^*]+)\*/g, '<strong>$1</strong>')
        .replace(/_([^_]+)_/g, '<em style="color:#94a3b8">$1</em>')
        .replace(/\n/g, '<br>')
        .replace(/‚Ä¢ /g, '&nbsp;&nbsp;‚Ä¢ ');
    }

    // Fun√ß√£o para mostrar bot√£o de gerar resumo
    function showGenerateButton(el, type, notesCount, periodo) {
      const periodoLabel = periodo === 'semana' ? 'da semana' : 'do m√™s';
      el.innerHTML = `
        <div style="text-align: center; padding: 20px 0;">
          <p style="color: #94a3b8; margin-bottom: 15px;">
            <strong>${notesCount}</strong> anota√ß√µes encontradas ${periodoLabel}
          </p>
          <button onclick="generateSummaryIA('${type}')" 
                  style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); 
                         color: white; 
                         border: none; 
                         padding: 12px 24px; 
                         border-radius: 8px; 
                         cursor: pointer; 
                         font-weight: 600;
                         display: inline-flex;
                         align-items: center;
                         gap: 8px;
                         transition: transform 0.2s, box-shadow 0.2s;"
                  onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 15px rgba(99,102,241,0.4)';"
                  onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
            <i class="fas fa-magic"></i> Gerar Resumo com IA
          </button>
        </div>
      `;
    }
    
    // Fun√ß√£o para mostrar resumo com bot√£o "Gerar Novamente"
    function showSummaryWithRegenerateButton(el, type, wpp, savedAt) {
      const savedDate = savedAt ? new Date(savedAt) : new Date();
      const formattedDate = savedDate.toLocaleDateString('pt-BR', {
        day: '2-digit',
        month: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      el.innerHTML = `
        <div>
          <div style="margin-bottom: 12px;">
            ${wppToHtml(wpp)}
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 12px; margin-top: 12px;">
            <span style="color: #64748b; font-size: 0.75rem;">
              <i class="fas fa-clock"></i> Gerado em ${formattedDate}
            </span>
            <button onclick="generateSummaryIA('${type}')" 
                    style="background: rgba(99,102,241,0.2); 
                           color: #a5b4fc; 
                           border: 1px solid rgba(99,102,241,0.4); 
                           padding: 6px 12px; 
                           border-radius: 6px; 
                           cursor: pointer; 
                           font-size: 0.8rem;
                           display: inline-flex;
                           align-items: center;
                           gap: 6px;
                           transition: all 0.2s;"
                    onmouseover="this.style.background='rgba(99,102,241,0.3)'"
                    onmouseout="this.style.background='rgba(99,102,241,0.2)'">
              <i class="fas fa-sync-alt"></i> Gerar Novamente
            </button>
          </div>
        </div>
      `;
    }

    // Fun√ß√£o para gerar resumo com IA (chamada pelo bot√£o)
    async function generateSummaryIA(type) {
      console.log('ü§ñ [IA] Iniciando gera√ß√£o de resumo para:', type);
      
      const column = type === 'trafego' ? 'trafego' : 'canais';
      const notes = getNotesInPeriod(column, currentSummaryFilter);
      const el = document.getElementById(type === 'trafego' ? 'summaryTrafegoContent' : 'summaryConteudoContent');
      
      if(!el || notes.length === 0) {
        console.warn('ü§ñ [IA] Sem notas ou elemento n√£o encontrado');
        return;
      }
      
      // Mostrar loading
      el.innerHTML = '<p style="color: #60a5fa; margin: 0; text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Gerando resumo com IA...</p>';
      
      try {
        const wpp = await generateAISummary(notes, type, currentSummaryFilter);
        
        // Se a IA falhou, mostrar erro e op√ß√£o de tentar novamente
        if(!wpp) {
          console.error('ü§ñ [IA] Resumo retornou vazio');
          el.innerHTML = `
            <div style="text-align: center; padding: 20px;">
              <p style="color: #ef4444; margin-bottom: 15px;">‚ö†Ô∏è Erro ao conectar com a IA</p>
              <button onclick="generateSummaryIA('${type}')" 
                      style="background: rgba(239,68,68,0.2); 
                             color: #ef4444; 
                             border: 1px solid rgba(239,68,68,0.5); 
                             padding: 10px 20px; 
                             border-radius: 8px; 
                             cursor: pointer; 
                             font-weight: 600;">
                üîÑ Tentar Novamente
              </button>
            </div>
          `;
          mgToast('‚ö†Ô∏è Erro ao gerar resumo. Tente novamente.');
          return;
        }
        
        console.log('ü§ñ [IA] Resumo gerado com sucesso!');
        
        // Salvar no Firebase
        await saveSummaryToFirebase(type, currentSummaryFilter, wpp);
        
        // Mostrar resumo com bot√£o "Gerar Novamente"
        showSummaryWithRegenerateButton(el, type, wpp);
        
        mgToast('‚ú® Resumo gerado e salvo!');
      } catch(err) {
        console.error('Erro ao gerar resumo:', err);
        el.innerHTML = `
          <div style="text-align: center; padding: 20px;">
            <p style="color: #ef4444; margin-bottom: 15px;">‚ö†Ô∏è Erro ao gerar resumo</p>
            <button onclick="generateSummaryIA('${type}')" 
                    style="background: rgba(239,68,68,0.2); 
                           color: #ef4444; 
                           border: 1px solid rgba(239,68,68,0.5); 
                           padding: 10px 20px; 
                           border-radius: 8px; 
                           cursor: pointer; 
                           font-weight: 600;">
              üîÑ Tentar Novamente
            </button>
          </div>
        `;
        mgToast('Erro ao gerar resumo');
      }
    }
    window.generateSummaryIA = generateSummaryIA;

    async function updateSummaries() {
      console.log('üîÑ [SUMMARY] updateSummaries chamado, filtro atual:', currentSummaryFilter);
      
      // Carregar resumos salvos do Firebase na primeira vez
      if(!cachedSummaries._loaded) {
        await loadSavedSummaries();
        cachedSummaries._loaded = true;
      }
      
      const trafegoNotes = getNotesInPeriod('trafego', currentSummaryFilter);
      const conteudoNotes = getNotesInPeriod('canais', currentSummaryFilter);
      
      console.log('üîÑ [SUMMARY] Notas encontradas - Tr√°fego:', trafegoNotes.length, 'Conte√∫do:', conteudoNotes.length);
      
      const trafegoEl = document.getElementById('summaryTrafegoContent');
      const conteudoEl = document.getElementById('summaryConteudoContent');
      
      // ========== TR√ÅFEGO ==========
      if(trafegoEl) {
        if(trafegoNotes.length === 0) {
          console.log('üîÑ [SUMMARY] TR√ÅFEGO: Nenhuma nota');
          trafegoEl.innerHTML = '<p style="color: #64748b; font-style: italic; margin: 0;">Nenhuma nota de tr√°fego no per√≠odo.</p>';
        } else if(currentSummaryFilter === 'dia') {
          console.log('üîÑ [SUMMARY] TR√ÅFEGO: Modo DIA - mostrando notas formatadas');
          // DI√ÅRIO: Mostra as notas formatadas
          const wpp = formatNotesForWpp(trafegoNotes, 'trafego');
          trafegoEl.innerHTML = wppToHtml(wpp);
        } else {
          // SEMANAL/MENSAL: Verifica se tem cache do Firebase para ESTE per√≠odo
          const cached = cachedSummaries.trafego[currentSummaryFilter];
          if(cached && cached.text) {
            console.log('üîÑ [SUMMARY] TR√ÅFEGO: Mostrando resumo SALVO do filtro', currentSummaryFilter);
            showSummaryWithRegenerateButton(trafegoEl, 'trafego', cached.text, cached.savedAt);
          } else {
            console.log('üîÑ [SUMMARY] TR√ÅFEGO: Mostrando BOT√ÉO para gerar IA, filtro:', currentSummaryFilter);
            showGenerateButton(trafegoEl, 'trafego', trafegoNotes.length, currentSummaryFilter);
          }
        }
      }
      
      // ========== CONTE√öDO ==========
      if(conteudoEl) {
        if(conteudoNotes.length === 0) {
          console.log('üîÑ [SUMMARY] CONTE√öDO: Nenhuma nota');
          conteudoEl.innerHTML = '<p style="color: #64748b; font-style: italic; margin: 0;">Nenhuma nota de conte√∫do no per√≠odo.</p>';
        } else if(currentSummaryFilter === 'dia') {
          console.log('üîÑ [SUMMARY] CONTE√öDO: Modo DIA - mostrando notas formatadas');
          // DI√ÅRIO: Mostra as notas formatadas
          const wpp = formatNotesForWpp(conteudoNotes, 'conteudo');
          conteudoEl.innerHTML = wppToHtml(wpp);
        } else {
          // SEMANAL/MENSAL: Verifica se tem cache do Firebase para ESTE per√≠odo
          const cached = cachedSummaries.conteudo[currentSummaryFilter];
          if(cached && cached.text) {
            console.log('üîÑ [SUMMARY] CONTE√öDO: Mostrando resumo SALVO do filtro', currentSummaryFilter);
            showSummaryWithRegenerateButton(conteudoEl, 'conteudo', cached.text, cached.savedAt);
          } else {
            console.log('üîÑ [SUMMARY] CONTE√öDO: Mostrando BOT√ÉO para gerar IA, filtro:', currentSummaryFilter);
            showGenerateButton(conteudoEl, 'conteudo', conteudoNotes.length, currentSummaryFilter);
          }
        }
      }
    }
    window.updateSummaries = updateSummaries;
    
    async function copySummary(type) {
      let wppText = '';
      
      if(type === 'trafego') {
        const notes = getNotesInPeriod('trafego', currentSummaryFilter);
        if(notes.length === 0) {
          mgToast('Nenhuma nota de tr√°fego no per√≠odo');
          return;
        }
        // Usar cache se dispon√≠vel (nova estrutura por per√≠odo)
        const cached = cachedSummaries.trafego[currentSummaryFilter];
        if(cached && cached.text) {
          wppText = cached.text;
        } else if(currentSummaryFilter === 'dia') {
          wppText = formatNotesForWpp(notes, 'trafego');
        } else {
          mgToast('‚ö†Ô∏è Clique em "Gerar Resumo com IA" primeiro');
          return;
        }
      } else {
        const notes = getNotesInPeriod('canais', currentSummaryFilter);
        if(notes.length === 0) {
          mgToast('Nenhuma nota de conte√∫do no per√≠odo');
          return;
        }
        // Usar cache se dispon√≠vel (nova estrutura por per√≠odo)
        const cached = cachedSummaries.conteudo[currentSummaryFilter];
        if(cached && cached.text) {
          wppText = cached.text;
        } else if(currentSummaryFilter === 'dia') {
          wppText = formatNotesForWpp(notes, 'conteudo');
        } else {
          mgToast('‚ö†Ô∏è Clique em "Gerar Resumo com IA" primeiro');
          return;
        }
      }
      
      if(!wppText) {
        mgToast('Nenhum dado para copiar');
        return;
      }
      
      try {
        await mgCopyToClipboard(wppText);
        mgToast('üìã Resumo copiado para WhatsApp!');
      } catch(err) {
        console.error('Erro ao copiar:', err);
        mgToast('Erro ao copiar');
      }
    }
    window.copySummary = copySummary;
    
    // ========== RESUMO CONSOLIDADO DO M√äS ==========
    
    // Gerar resumo consolidado do m√™s (todas as colunas)
    async function generateMonthlyResume() {
      console.log('üóìÔ∏è [M√äS] Iniciando gera√ß√£o de resumo consolidado do m√™s');
      
      const el = document.getElementById('monthlyResumeContent');
      if(!el) {
        console.error('üóìÔ∏è [M√äS] Elemento monthlyResumeContent n√£o encontrado');
        return;
      }
      
      // Pegar todas as notas do m√™s de TODAS as colunas
      const trafegoNotes = getNotesInPeriod('trafego', 'mes');
      const canaisNotes = getNotesInPeriod('canais', 'mes');
      const liderancaNotes = getNotesInPeriod('lideranca', 'mes');
      const outrosNotes = getNotesInPeriod('outros', 'mes');
      
      const totalNotas = trafegoNotes.length + canaisNotes.length + liderancaNotes.length + outrosNotes.length;
      
      console.log('üóìÔ∏è [M√äS] Notas encontradas - Tr√°fego:', trafegoNotes.length, 
                  'Canais:', canaisNotes.length, 
                  'Lideran√ßa:', liderancaNotes.length, 
                  'Outros:', outrosNotes.length);
      
      if(totalNotas === 0) {
        el.innerHTML = '<p style="color: #64748b; font-style: italic; margin: 0;">Nenhuma nota registrada no m√™s.</p>';
        mgToast('‚ö†Ô∏è Nenhuma nota no m√™s para consolidar');
        return;
      }
      
      // Mostrar loading
      el.innerHTML = '<p style="color: #60a5fa; margin: 0; text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Gerando resumo consolidado do m√™s com IA...</p>';
      
      try {
        const now = new Date();
        const mesAtual = now.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
        
        // Preparar notas de cada coluna
        function formatarNotas(notes, nomeColuna) {
          if(!notes.length) return `${nomeColuna}: Sem anota√ß√µes no per√≠odo.\n`;
          
          return `${nomeColuna}:\n` + notes.map(note => {
            const dateVal = note.createdAt || note.timestamp;
            let noteDate = new Date();
            if(dateVal) {
              if(dateVal.seconds) noteDate = new Date(dateVal.seconds * 1000);
              else if(dateVal.toDate) noteDate = dateVal.toDate();
              else noteDate = new Date(dateVal);
            }
            const dataStr = noteDate.toLocaleDateString('pt-BR');
            return `[${dataStr}] ${note.content || '(sem conte√∫do)'}`;
          }).join('\n') + '\n\n';
        }
        
        let notasConsolidadas = '';
        notasConsolidadas += formatarNotas(trafegoNotes, 'üìä TR√ÅFEGO PAGO');
        notasConsolidadas += formatarNotas(canaisNotes, 'üì± CANAIS DE TRA√á√ÉO');
        notasConsolidadas += formatarNotas(liderancaNotes, 'üë• LIDERAN√áA');
        notasConsolidadas += formatarNotas(outrosNotes, 'üìù OUTROS');
        
        console.log('üóìÔ∏è [M√äS] Texto consolidado preparado:', notasConsolidadas.length, 'caracteres');
        
        // Prompt para resumo consolidado
        const prompt = `Voc√™ √© um analista de marketing digital experiente.

Analise as seguintes anota√ß√µes CONSOLIDADAS de todas as √°reas do m√™s de ${mesAtual} e gere um RESUMO EXECUTIVO formatado para WhatsApp.

ANOTA√á√ïES POR √ÅREA:
${notasConsolidadas}

Gere um resumo no seguinte formato (use *texto* para negrito e _texto_ para it√°lico):

*üìÖ RESUMO CONSOLIDADO DO M√äS*
_${mesAtual}_

*üìä Tr√°fego Pago:*
‚Ä¢ [Resuma os principais pontos de tr√°fego: investimentos, CPL, resultados]

*üì± Canais de Tra√ß√£o:*
‚Ä¢ [Resuma engajamento, alcance, conte√∫dos que se destacaram]

*üë• Lideran√ßa/Equipe:*
‚Ä¢ [Resuma pontos relevantes sobre equipe, processos, check-ins]

*üìù Observa√ß√µes Gerais:*
‚Ä¢ [Outros pontos relevantes que n√£o se encaixam acima]

*üéØ Insights do M√™s:*
‚Ä¢ [Liste 2-3 insights principais baseados nos dados]

*üìà Pr√≥ximos Passos Sugeridos:*
‚Ä¢ [Liste 2-3 a√ß√µes recomendadas para o pr√≥ximo per√≠odo]

---
_Resumo gerado por IA em ${now.toLocaleDateString('pt-BR')} √†s ${now.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}_
_${totalNotas} anota√ß√£o(√µes) analisada(s)_

IMPORTANTE:
- Seja CONCISO e objetivo
- Foque nos RESULTADOS e INSIGHTS, n√£o em listar cada nota
- Se uma √°rea n√£o tiver dados relevantes, mencione brevemente
- Use linguagem profissional mas acess√≠vel
- O resumo deve ter no m√°ximo 25-30 linhas`;

        console.log('üóìÔ∏è [M√äS] Chamando IA para gerar resumo consolidado...');
        
        const resumo = await callGeminiAPI(prompt, 2000);
        
        if(!resumo) {
          console.error('üóìÔ∏è [M√äS] Resumo retornou vazio');
          el.innerHTML = `
            <div style="text-align: center; padding: 20px;">
              <p style="color: #ef4444; margin-bottom: 15px;">‚ö†Ô∏è Erro ao conectar com a IA</p>
              <button onclick="generateMonthlyResume()" 
                      style="background: rgba(239,68,68,0.2); 
                             color: #ef4444; 
                             border: 1px solid rgba(239,68,68,0.5); 
                             padding: 10px 20px; 
                             border-radius: 8px; 
                             cursor: pointer; 
                             font-weight: 600;">
                üîÑ Tentar Novamente
              </button>
            </div>
          `;
          mgToast('‚ö†Ô∏è Erro ao gerar resumo. Tente novamente.');
          return;
        }
        
        console.log('üóìÔ∏è [M√äS] Resumo consolidado gerado com sucesso!');
        
        // Salvar no Firebase
        await saveMonthlySummaryToFirebase(resumo);
        
        // Mostrar resumo com bot√£o "Gerar Novamente"
        showMonthlySummaryWithButton(el, resumo);
        
        // Mostrar bot√£o de copiar
        const copyBtn = document.getElementById('copyMonthlyResumeBtn');
        if(copyBtn) copyBtn.style.display = 'inline-flex';
        
        mgToast('‚ú® Resumo consolidado do m√™s gerado e salvo!');
      } catch(err) {
        console.error('üóìÔ∏è [M√äS] Erro ao gerar resumo:', err);
        el.innerHTML = `
          <div style="text-align: center; padding: 20px;">
            <p style="color: #ef4444; margin-bottom: 15px;">‚ö†Ô∏è Erro ao gerar resumo</p>
            <button onclick="generateMonthlyResume()" 
                    style="background: rgba(239,68,68,0.2); 
                           color: #ef4444; 
                           border: 1px solid rgba(239,68,68,0.5); 
                           padding: 10px 20px; 
                           border-radius: 8px; 
                           cursor: pointer; 
                           font-weight: 600;">
              üîÑ Tentar Novamente
            </button>
          </div>
        `;
        mgToast('Erro ao gerar resumo consolidado');
      }
    }
    window.generateMonthlyResume = generateMonthlyResume;
    
    // Salvar resumo mensal no Firebase
    async function saveMonthlySummaryToFirebase(text) {
      try {
        const uid = getTeamNotesTargetUid();
        if(!uid) {
          console.warn('‚ö†Ô∏è Nenhum UID para salvar resumo mensal');
          return;
        }
        
        const summariesDocRef = doc(db, "usuarios", uid, "teamNotes", "summaries");
        const savedAt = new Date().toISOString();
        const mesKey = new Date().toISOString().slice(0, 7); // ex: "2025-01"
        
        await setDoc(summariesDocRef, {
          [`consolidado_${mesKey}`]: { text, savedAt }
        }, { merge: true });
        
        console.log('‚úÖ Resumo mensal consolidado salvo:', `consolidado_${mesKey}`);
        
        // Atualizar cache local
        if(!cachedSummaries.consolidado) cachedSummaries.consolidado = {};
        cachedSummaries.consolidado[mesKey] = { text, savedAt };
        
      } catch(err) {
        console.error('‚ùå Erro ao salvar resumo mensal:', err);
      }
    }
    
    // Carregar resumo mensal salvo
    async function loadMonthlySummary() {
      try {
        const uid = getTeamNotesTargetUid();
        if(!uid) return null;
        
        const summariesDocRef = doc(db, "usuarios", uid, "teamNotes", "summaries");
        const summariesDoc = await getDoc(summariesDocRef);
        
        if(summariesDoc.exists()) {
          const data = summariesDoc.data();
          const mesKey = new Date().toISOString().slice(0, 7);
          
          if(data[`consolidado_${mesKey}`]) {
            console.log('üì• Resumo mensal carregado:', `consolidado_${mesKey}`);
            return data[`consolidado_${mesKey}`];
          }
        }
      } catch(err) {
        console.warn('‚ö†Ô∏è Erro ao carregar resumo mensal:', err);
      }
      return null;
    }
    
    // Mostrar resumo mensal com bot√£o regenerar
    function showMonthlySummaryWithButton(el, text, savedAt) {
      const dataInfo = savedAt ? `<small style="color: #64748b; font-size: 11px; display: block; margin-top: 8px;">Salvo em: ${new Date(savedAt).toLocaleString('pt-BR')}</small>` : '';
      
      el.innerHTML = `
        <div style="margin-bottom: 10px;">
          ${wppToHtml(text)}
          ${dataInfo}
        </div>
        <button onclick="generateMonthlyResume()" 
                style="background: rgba(245,158,11,0.2); 
                       color: #f59e0b; 
                       border: 1px solid rgba(245,158,11,0.5); 
                       padding: 8px 16px; 
                       border-radius: 8px; 
                       cursor: pointer; 
                       font-weight: 600;
                       font-size: 13px;">
          üîÑ Gerar Novamente
        </button>
      `;
    }
    
    // Copiar resumo mensal
    async function copyMonthlyResume() {
      // Verificar se tem resumo salvo no cache
      const mesKey = new Date().toISOString().slice(0, 7);
      const cached = cachedSummaries.consolidado?.[mesKey];
      
      if(cached && cached.text) {
        try {
          await mgCopyToClipboard(cached.text);
          mgToast('üìã Resumo do m√™s copiado para WhatsApp!');
        } catch(err) {
          console.error('Erro ao copiar:', err);
          mgToast('Erro ao copiar');
        }
      } else {
        mgToast('‚ö†Ô∏è Gere o resumo do m√™s primeiro');
      }
    }
    window.copyMonthlyResume = copyMonthlyResume;
    
    // Inicializar bloco de resumo mensal
    async function initMonthlySummaryBlock() {
      const el = document.getElementById('monthlyResumeContent');
      if(!el) return;
      
      // Atualizar label do m√™s
      const labelEl = document.getElementById('monthlyResumeMonthLabel');
      if(labelEl) {
        const mesAtual = new Date().toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
        labelEl.textContent = `(${mesAtual})`;
      }
      
      // Carregar resumo salvo do m√™s atual
      const saved = await loadMonthlySummary();
      
      if(saved && saved.text) {
        showMonthlySummaryWithButton(el, saved.text, saved.savedAt);
        // Mostrar bot√£o de copiar
        const copyBtn = document.getElementById('copyMonthlyResumeBtn');
        if(copyBtn) copyBtn.style.display = 'inline-flex';
      } else {
        el.innerHTML = '<p style="color: #64748b; font-style: italic; margin: 0; text-align: center;">Clique em "Gerar Resumo do M√™s" para consolidar todas as anota√ß√µes de Tr√°fego, Conte√∫do, Lideran√ßa e Outros em um √∫nico resumo.</p>';
      }
    }
    
    // ========== RESUMO CONSOLIDADO DA SEMANA ==========
    
    // Gerar resumo consolidado da semana (todas as colunas)
    async function generateWeeklyResume() {
      console.log('üìÜ [SEMANA] Iniciando gera√ß√£o de resumo consolidado da semana');
      
      const el = document.getElementById('weeklyResumeContent');
      if(!el) {
        console.error('üìÜ [SEMANA] Elemento weeklyResumeContent n√£o encontrado');
        return;
      }
      
      // Pegar todas as notas da semana de TODAS as colunas
      const trafegoNotes = getNotesInPeriod('trafego', 'semana');
      const canaisNotes = getNotesInPeriod('canais', 'semana');
      const liderancaNotes = getNotesInPeriod('lideranca', 'semana');
      const outrosNotes = getNotesInPeriod('outros', 'semana');
      
      const totalNotas = trafegoNotes.length + canaisNotes.length + liderancaNotes.length + outrosNotes.length;
      
      console.log('üìÜ [SEMANA] Notas encontradas - Tr√°fego:', trafegoNotes.length, 
                  'Canais:', canaisNotes.length, 
                  'Lideran√ßa:', liderancaNotes.length, 
                  'Outros:', outrosNotes.length);
      
      if(totalNotas === 0) {
        el.innerHTML = '<p style="color: #64748b; font-style: italic; margin: 0;">Nenhuma nota registrada na semana.</p>';
        mgToast('‚ö†Ô∏è Nenhuma nota na semana para consolidar');
        return;
      }
      
      // Mostrar loading
      el.innerHTML = '<p style="color: #60a5fa; margin: 0; text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Gerando resumo consolidado da semana com IA...</p>';
      
      try {
        const now = new Date();
        const inicioSemana = new Date(now);
        inicioSemana.setDate(now.getDate() - 7);
        const periodoSemana = `${inicioSemana.toLocaleDateString('pt-BR')} a ${now.toLocaleDateString('pt-BR')}`;
        
        // Preparar notas de cada coluna
        function formatarNotas(notes, nomeColuna) {
          if(!notes.length) return `${nomeColuna}: Sem anota√ß√µes no per√≠odo.\n`;
          
          return `${nomeColuna}:\n` + notes.map(note => {
            const dateVal = note.createdAt || note.timestamp;
            let noteDate = new Date();
            if(dateVal) {
              if(dateVal.seconds) noteDate = new Date(dateVal.seconds * 1000);
              else if(dateVal.toDate) noteDate = dateVal.toDate();
              else noteDate = new Date(dateVal);
            }
            const dataStr = noteDate.toLocaleDateString('pt-BR');
            return `[${dataStr}] ${note.content || '(sem conte√∫do)'}`;
          }).join('\n') + '\n\n';
        }
        
        let notasConsolidadas = '';
        notasConsolidadas += formatarNotas(trafegoNotes, 'üìä TR√ÅFEGO PAGO');
        notasConsolidadas += formatarNotas(canaisNotes, 'üì± CANAIS DE TRA√á√ÉO');
        notasConsolidadas += formatarNotas(liderancaNotes, 'üë• LIDERAN√áA');
        notasConsolidadas += formatarNotas(outrosNotes, 'üìù OUTROS');
        
        console.log('üìÜ [SEMANA] Texto consolidado preparado:', notasConsolidadas.length, 'caracteres');
        
        // Prompt para resumo consolidado da semana
        const prompt = `Voc√™ √© um analista de marketing digital experiente.

Analise as seguintes anota√ß√µes CONSOLIDADAS de todas as √°reas da semana (${periodoSemana}) e gere um RESUMO EXECUTIVO formatado para WhatsApp.

ANOTA√á√ïES POR √ÅREA:
${notasConsolidadas}

Gere um resumo no seguinte formato (use *texto* para negrito e _texto_ para it√°lico):

*üìÜ RESUMO CONSOLIDADO DA SEMANA*
_${periodoSemana}_

*üìä Tr√°fego Pago:*
‚Ä¢ [Resuma os principais pontos de tr√°fego: investimentos, CPL, resultados]

*üì± Canais de Tra√ß√£o:*
‚Ä¢ [Resuma engajamento, alcance, conte√∫dos que se destacaram]

*üë• Lideran√ßa/Equipe:*
‚Ä¢ [Resuma pontos relevantes sobre equipe, processos, check-ins]

*üìù Observa√ß√µes Gerais:*
‚Ä¢ [Outros pontos relevantes que n√£o se encaixam acima]

*üéØ Destaques da Semana:*
‚Ä¢ [Liste 2-3 destaques principais baseados nos dados]

*üìà Foco para Pr√≥xima Semana:*
‚Ä¢ [Liste 2-3 prioridades recomendadas]

---
_Resumo gerado por IA em ${now.toLocaleDateString('pt-BR')} √†s ${now.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}_
_${totalNotas} anota√ß√£o(√µes) analisada(s)_

IMPORTANTE:
- Seja CONCISO e objetivo
- Foque nos RESULTADOS e INSIGHTS, n√£o em listar cada nota
- Se uma √°rea n√£o tiver dados relevantes, mencione brevemente
- Use linguagem profissional mas acess√≠vel
- O resumo deve ter no m√°ximo 20-25 linhas`;

        console.log('üìÜ [SEMANA] Chamando IA para gerar resumo consolidado...');
        
        const resumo = await callGeminiAPI(prompt, 2000);
        
        if(!resumo) {
          console.error('üìÜ [SEMANA] Resumo retornou vazio');
          el.innerHTML = `
            <div style="text-align: center; padding: 20px;">
              <p style="color: #ef4444; margin-bottom: 15px;">‚ö†Ô∏è Erro ao conectar com a IA</p>
              <button onclick="generateWeeklyResume()" 
                      style="background: rgba(239,68,68,0.2); 
                             color: #ef4444; 
                             border: 1px solid rgba(239,68,68,0.5); 
                             padding: 10px 20px; 
                             border-radius: 8px; 
                             cursor: pointer; 
                             font-weight: 600;">
                üîÑ Tentar Novamente
              </button>
            </div>
          `;
          mgToast('‚ö†Ô∏è Erro ao gerar resumo. Tente novamente.');
          return;
        }
        
        console.log('üìÜ [SEMANA] Resumo consolidado gerado com sucesso!');
        
        // Salvar no Firebase
        await saveWeeklySummaryToFirebase(resumo);
        
        // Mostrar resumo com bot√£o "Gerar Novamente"
        showWeeklySummaryWithButton(el, resumo);
        
        // Mostrar bot√£o de copiar
        const copyBtn = document.getElementById('copyWeeklyResumeBtn');
        if(copyBtn) copyBtn.style.display = 'inline-flex';
        
        mgToast('‚ú® Resumo consolidado da semana gerado e salvo!');
      } catch(err) {
        console.error('üìÜ [SEMANA] Erro ao gerar resumo:', err);
        el.innerHTML = `
          <div style="text-align: center; padding: 20px;">
            <p style="color: #ef4444; margin-bottom: 15px;">‚ö†Ô∏è Erro ao gerar resumo</p>
            <button onclick="generateWeeklyResume()" 
                    style="background: rgba(239,68,68,0.2); 
                           color: #ef4444; 
                           border: 1px solid rgba(239,68,68,0.5); 
                           padding: 10px 20px; 
                           border-radius: 8px; 
                           cursor: pointer; 
                           font-weight: 600;">
              üîÑ Tentar Novamente
            </button>
          </div>
        `;
        mgToast('Erro ao gerar resumo consolidado da semana');
      }
    }
    window.generateWeeklyResume = generateWeeklyResume;
    
    // Salvar resumo semanal no Firebase
    async function saveWeeklySummaryToFirebase(text) {
      try {
        const uid = getTeamNotesTargetUid();
        if(!uid) {
          console.warn('‚ö†Ô∏è Nenhum UID para salvar resumo semanal');
          return;
        }
        
        const summariesDocRef = doc(db, "usuarios", uid, "teamNotes", "summaries");
        const savedAt = new Date().toISOString();
        // Chave: semana do ano (ex: "2026-W04")
        const now = new Date();
        const oneJan = new Date(now.getFullYear(), 0, 1);
        const weekNum = Math.ceil((((now - oneJan) / 86400000) + oneJan.getDay() + 1) / 7);
        const semanaKey = `${now.getFullYear()}-W${String(weekNum).padStart(2, '0')}`;
        
        await setDoc(summariesDocRef, {
          [`consolidado_semana_${semanaKey}`]: { text, savedAt }
        }, { merge: true });
        
        console.log('‚úÖ Resumo semanal consolidado salvo:', `consolidado_semana_${semanaKey}`);
        
        // Atualizar cache local
        if(!cachedSummaries.consolidadoSemana) cachedSummaries.consolidadoSemana = {};
        cachedSummaries.consolidadoSemana[semanaKey] = { text, savedAt };
        
      } catch(err) {
        console.error('‚ùå Erro ao salvar resumo semanal:', err);
      }
    }
    
    // Carregar resumo semanal salvo
    async function loadWeeklySummary() {
      try {
        const uid = getTeamNotesTargetUid();
        if(!uid) return null;
        
        const summariesDocRef = doc(db, "usuarios", uid, "teamNotes", "summaries");
        const summariesDoc = await getDoc(summariesDocRef);
        
        if(summariesDoc.exists()) {
          const data = summariesDoc.data();
          const now = new Date();
          const oneJan = new Date(now.getFullYear(), 0, 1);
          const weekNum = Math.ceil((((now - oneJan) / 86400000) + oneJan.getDay() + 1) / 7);
          const semanaKey = `${now.getFullYear()}-W${String(weekNum).padStart(2, '0')}`;
          
          if(data[`consolidado_semana_${semanaKey}`]) {
            console.log('üì• Resumo semanal carregado:', `consolidado_semana_${semanaKey}`);
            return data[`consolidado_semana_${semanaKey}`];
          }
        }
      } catch(err) {
        console.warn('‚ö†Ô∏è Erro ao carregar resumo semanal:', err);
      }
      return null;
    }
    
    // Mostrar resumo semanal com bot√£o regenerar
    function showWeeklySummaryWithButton(el, text, savedAt) {
      const dataInfo = savedAt ? `<small style="color: #64748b; font-size: 11px; display: block; margin-top: 8px;">Salvo em: ${new Date(savedAt).toLocaleString('pt-BR')}</small>` : '';
      
      el.innerHTML = `
        <div style="margin-bottom: 10px;">
          ${wppToHtml(text)}
          ${dataInfo}
        </div>
        <button onclick="generateWeeklyResume()" 
                style="background: rgba(59,130,246,0.2); 
                       color: #3b82f6; 
                       border: 1px solid rgba(59,130,246,0.5); 
                       padding: 8px 16px; 
                       border-radius: 8px; 
                       cursor: pointer; 
                       font-weight: 600;
                       font-size: 13px;">
          üîÑ Gerar Novamente
        </button>
      `;
    }
    
    // Copiar resumo semanal
    async function copyWeeklyResume() {
      // Verificar se tem resumo salvo no cache
      const now = new Date();
      const oneJan = new Date(now.getFullYear(), 0, 1);
      const weekNum = Math.ceil((((now - oneJan) / 86400000) + oneJan.getDay() + 1) / 7);
      const semanaKey = `${now.getFullYear()}-W${String(weekNum).padStart(2, '0')}`;
      const cached = cachedSummaries.consolidadoSemana?.[semanaKey];
      
      if(cached && cached.text) {
        try {
          await mgCopyToClipboard(cached.text);
          mgToast('üìã Resumo da semana copiado para WhatsApp!');
        } catch(err) {
          console.error('Erro ao copiar:', err);
          mgToast('Erro ao copiar');
        }
      } else {
        mgToast('‚ö†Ô∏è Gere o resumo da semana primeiro');
      }
    }
    window.copyWeeklyResume = copyWeeklyResume;
    
    // Inicializar bloco de resumo semanal
    async function initWeeklySummaryBlock() {
      const el = document.getElementById('weeklyResumeContent');
      if(!el) return;
      
      // Atualizar label da semana
      const labelEl = document.getElementById('weeklyResumeWeekLabel');
      if(labelEl) {
        const now = new Date();
        const inicioSemana = new Date(now);
        inicioSemana.setDate(now.getDate() - 7);
        const periodoSemana = `${inicioSemana.toLocaleDateString('pt-BR')} a ${now.toLocaleDateString('pt-BR')}`;
        labelEl.textContent = `(${periodoSemana})`;
      }
      
      // Carregar resumo salvo da semana atual
      const saved = await loadWeeklySummary();
      
      if(saved && saved.text) {
        showWeeklySummaryWithButton(el, saved.text, saved.savedAt);
        // Mostrar bot√£o de copiar
        const copyBtn = document.getElementById('copyWeeklyResumeBtn');
        if(copyBtn) copyBtn.style.display = 'inline-flex';
      } else {
        el.innerHTML = '<p style="color: #64748b; font-style: italic; margin: 0; text-align: center;">Clique em "Gerar Resumo da Semana" para consolidar todas as anota√ß√µes de Tr√°fego, Conte√∫do, Lideran√ßa e Outros dos √∫ltimos 7 dias.</p>';
      }
    }
    
    // ========== FIM RESUMO CONSOLIDADO DA SEMANA ==========
    
    // ========== FIM RESUMO CONSOLIDADO DO M√äS ==========
    
    /* ========== FIM RESUMO AUTOM√ÅTICO DAS NOTAS ========== */

    /* ========= REUNI√ïES ========= */
    let REUNIOES = [];
    let currentEditingReuniao = null;
    let currentViewingReuniao = null;
    let reunioesInitialLoadDone = false; // Flag para indicar se o carregamento inicial foi feito
    let reunioesPersistLock = false; // Lock para evitar condi√ß√µes de corrida
    
    // Fun√ß√£o para resetar estado das reuni√µes (usado quando muda de cliente)
    function resetReunioesState() {
      REUNIOES = [];
      currentEditingReuniao = null;
      currentViewingReuniao = null;
      reunioesInitialLoadDone = false;
      reunioesPersistLock = false;
      console.log('üîÑ Estado de reuni√µes resetado');
    }
    window.resetReunioesState = resetReunioesState;

    async function loadReunioesFromData(forceReload = false){
      // Se j√° foi carregado e n√£o √© for√ßado, usar dados locais
      if (reunioesInitialLoadDone && !forceReload) {
        console.log('üìã Usando dados locais de reuni√µes:', REUNIOES.length);
        return;
      }
      
      // Aguardar se houver uma persist√™ncia em andamento
      if (reunioesPersistLock) {
        console.log('‚è≥ Aguardando persist√™ncia de reuni√µes terminar...');
        await new Promise(resolve => {
          const checkLock = setInterval(() => {
            if (!reunioesPersistLock) {
              clearInterval(checkLock);
              resolve();
            }
          }, 100);
        });
      }
      
      const uid = getReunioesTargetUid();
      if(!uid) {
        console.warn('‚ö†Ô∏è Nenhum UID dispon√≠vel para carregar reuni√µes');
        REUNIOES = [];
        return;
      }
      
      try {
        const reunioesDocRef = doc(db, "usuarios", uid, "reunioes", "data");
        const reunioesDoc = await getDoc(reunioesDocRef);
        
        if(reunioesDoc.exists()){
          const data = reunioesDoc.data();
          REUNIOES = Array.isArray(data.reunioes) ? data.reunioes : [];
          console.log('‚úÖ Reuni√µes carregadas do Firebase:', REUNIOES.length);
        } else {
          REUNIOES = [];
          console.log('üìã Nenhuma reuni√£o encontrada no Firebase');
        }
        
        reunioesInitialLoadDone = true;
        
        // Atualizar stats do chat
        if (typeof updateReunioesChatStats === 'function') {
          updateReunioesChatStats();
        }
      } catch(err) {
        console.error('‚ùå Erro ao carregar reuni√µes:', err);
        // N√£o resetar REUNIOES em caso de erro se j√° temos dados locais
        if (!reunioesInitialLoadDone) {
          REUNIOES = [];
        }
      }
    }

    function getReunioesTargetUid(){
      if (Array.isArray(clientDocPathParts) && clientDocPathParts.length >= 2) {
        return clientDocPathParts[1];
      }
      const currentUser = typeof window.getCurrentUser === 'function' ? window.getCurrentUser() : auth.currentUser;
      return currentUser?.uid;
    }

    async function persistReunioes(){
      const uid = getReunioesTargetUid();
      if(!uid) {
        console.error('‚ùå Sem UID para persistir reuni√µes');
        return;
      }
      
      // Ativar lock
      reunioesPersistLock = true;
      
      try {
        const reunioesDocRef = doc(db, "usuarios", uid, "reunioes", "data");
        await setDoc(reunioesDocRef, {
          reunioes: REUNIOES,
          updatedAt: serverTimestamp()
        }, { merge: true });
        console.log('‚úÖ Reuni√µes persistidas no Firebase:', REUNIOES.length);
      } catch(err) {
        console.error('‚ùå Erro ao persistir reuni√µes:', err);
        throw err;
      } finally {
        // Sempre liberar o lock
        reunioesPersistLock = false;
      }
    }

    function renderReunioes(skipLoad = false){
      const doRender = () => {
        const grid = document.getElementById('reunioesGrid');
        const emptyState = document.getElementById('reunioesEmptyState');
        
        if(!grid) return;
        
        if(REUNIOES.length === 0){
          grid.innerHTML = '';
          if(emptyState) emptyState.style.display = 'block';
          return;
        }
        
        if(emptyState) emptyState.style.display = 'none';
        
        // Ordenar por data (mais recente primeiro)
        const sorted = [...REUNIOES].sort((a, b) => {
          const dateA = new Date(a.data || 0);
          const dateB = new Date(b.data || 0);
          return dateB - dateA;
        });
        
        const frag = document.createDocumentFragment();
        
        sorted.forEach(reuniao => {
          const card = document.createElement('div');
          card.className = 'reuniao-card';
          card.onclick = () => viewReuniao(reuniao.id);
          
          const dataFormatada = reuniao.data ? new Date(reuniao.data + 'T00:00:00').toLocaleDateString('pt-BR', {
            day: '2-digit',
            month: 'short',
            year: 'numeric'
          }) : 'Sem data';
          
          const resumoPreview = reuniao.resumo 
            ? reuniao.resumo.substring(0, 150) + (reuniao.resumo.length > 150 ? '...' : '')
            : '';
          
          card.innerHTML = `
            <div class="reuniao-card-header">
              <span class="reuniao-card-date">üìÖ ${dataFormatada}</span>
              <div class="reuniao-card-actions">
                <button onclick="event.stopPropagation(); editReuniao('${reuniao.id}')" title="Editar">‚úèÔ∏è</button>
                <button class="delete" onclick="event.stopPropagation(); deleteReuniao('${reuniao.id}')" title="Excluir">üóëÔ∏è</button>
              </div>
            </div>
            <div class="reuniao-card-objetivo">${escapeHtml(reuniao.objetivo || 'Sem objetivo definido')}</div>
            <div class="reuniao-card-resumo ${!reuniao.resumo ? 'empty' : ''}">
              ${reuniao.resumo ? escapeHtml(resumoPreview) : 'üìù Resumo ainda n√£o gerado'}
            </div>
            <div class="reuniao-card-footer">
              <button class="reuniao-view-btn" onclick="event.stopPropagation(); viewReuniao('${reuniao.id}')">
                üîç Ver Resumo
              </button>
            </div>
          `;
          
          frag.appendChild(card);
        });
        
        grid.replaceChildren(frag);
      };
      
      // Se skipLoad √© true ou j√° temos dados locais, renderizar direto
      if (skipLoad || reunioesInitialLoadDone) {
        doRender();
      } else {
        // Primeiro acesso: carregar do Firebase
        loadReunioesFromData().then(doRender);
      }
    }
    window.renderReunioes = renderReunioes;

    function openReuniaoModal(reuniaoId = null){
      const modal = document.getElementById('reuniaoModal');
      const titleEl = document.getElementById('reuniaoModalTitle');
      const dataInput = document.getElementById('reuniaoData');
      const objetivoInput = document.getElementById('reuniaoObjetivo');
      const transcricaoInput = document.getElementById('reuniaoTranscricao');
      
      if(!modal) return;
      
      if(reuniaoId){
        const reuniao = REUNIOES.find(r => r.id === reuniaoId);
        if(reuniao){
          currentEditingReuniao = reuniao;
          titleEl.textContent = '‚úèÔ∏è Editar Reuni√£o';
          dataInput.value = reuniao.data || '';
          objetivoInput.value = reuniao.objetivo || '';
          transcricaoInput.value = reuniao.transcricao || '';
        }
      } else {
        currentEditingReuniao = null;
        titleEl.textContent = 'üìÖ Nova Reuni√£o';
        dataInput.value = new Date().toISOString().split('T')[0];
        objetivoInput.value = '';
        transcricaoInput.value = '';
      }
      
      modal.classList.add('show');
    }
    window.openReuniaoModal = openReuniaoModal;

    function closeReuniaoModal(){
      const modal = document.getElementById('reuniaoModal');
      if(modal) modal.classList.remove('show');
      currentEditingReuniao = null;
    }
    window.closeReuniaoModal = closeReuniaoModal;

    // ========== GERA√á√ÉO AUTOM√ÅTICA DE T√çTULO DA REUNI√ÉO ==========
    let tituloGeracaoTimeout = null;
    let ultimaTranscricaoProcessada = '';
    
    async function gerarTituloReuniaoIA(transcricao) {
      if (!transcricao || transcricao.length < 50) return null;
      if (typeof window.callAIProxy !== 'function') return null;
      
      try {
        const userId = auth?.currentUser?.uid || 'anonymous-' + Date.now();
        
        const messages = [
          { 
            role: 'system', 
            content: 'Voc√™ gera t√≠tulos curtos e descritivos para reuni√µes. Responda APENAS com o t√≠tulo, sem aspas, sem explica√ß√µes.' 
          },
          { 
            role: 'user', 
            content: `Leia o in√≠cio desta transcri√ß√£o de reuni√£o e gere um T√çTULO CURTO (m√°ximo 6 palavras) que descreva o assunto principal.

Transcri√ß√£o (in√≠cio):
${transcricao.substring(0, 1500)}

Responda APENAS com o t√≠tulo. Exemplos de bons t√≠tulos:
- Alinhamento de Campanhas Google Ads
- Revis√£o de Metas Mensais
- Planejamento de Conte√∫do Janeiro
- Feedback de Performance do Site
- Defini√ß√£o de Estrat√©gia de Tr√°fego` 
          }
        ];
        
        const data = await window.callAIProxy('google/gemini-2.5-flash', messages, userId, 50, 0.3);
        const titulo = data?.choices?.[0]?.message?.content?.trim();
        
        if (titulo && titulo.length > 3 && titulo.length < 80) {
          // Limpar t√≠tulo de poss√≠veis aspas ou prefixos
          return titulo.replace(/^["']|["']$/g, '').replace(/^(t√≠tulo:|title:)/i, '').trim();
        }
        return null;
      } catch (err) {
        console.warn('Erro ao gerar t√≠tulo:', err);
        return null;
      }
    }
    
    function setupTranscricaoAutoTitle() {
      const transcricaoInput = document.getElementById('reuniaoTranscricao');
      const objetivoInput = document.getElementById('reuniaoObjetivo');
      
      if (!transcricaoInput || !objetivoInput) return;
      
      // Listener para quando colar ou digitar no campo de transcri√ß√£o
      const handleTranscricaoChange = async (e) => {
        const transcricao = transcricaoInput.value?.trim();
        
        // S√≥ gera t√≠tulo se:
        // 1. O campo objetivo estiver vazio
        // 2. A transcri√ß√£o tiver mais de 50 caracteres
        // 3. A transcri√ß√£o for diferente da √∫ltima processada
        if (objetivoInput.value?.trim() || !transcricao || transcricao.length < 50) return;
        if (transcricao === ultimaTranscricaoProcessada) return;
        
        // Debounce para evitar chamadas excessivas
        if (tituloGeracaoTimeout) clearTimeout(tituloGeracaoTimeout);
        
        tituloGeracaoTimeout = setTimeout(async () => {
          ultimaTranscricaoProcessada = transcricao;
          
          // Mostrar indicador de loading
          objetivoInput.placeholder = 'ü§ñ Gerando t√≠tulo automaticamente...';
          objetivoInput.style.opacity = '0.7';
          
          try {
            const titulo = await gerarTituloReuniaoIA(transcricao);
            
            if (titulo && !objetivoInput.value?.trim()) {
              objetivoInput.value = titulo;
              objetivoInput.style.borderColor = 'rgba(16, 185, 129, 0.5)';
              setTimeout(() => {
                objetivoInput.style.borderColor = '';
              }, 2000);
              mgToast('‚ú® T√≠tulo gerado automaticamente!', 'success');
            }
          } catch (err) {
            console.warn('Erro ao gerar t√≠tulo:', err);
          } finally {
            objetivoInput.placeholder = 'Ex: Alinhamento de metas do m√™s, Revis√£o de campanhas, etc.';
            objetivoInput.style.opacity = '1';
          }
        }, 800); // Aguarda 800ms ap√≥s parar de digitar/colar
      };
      
      // Evento de paste (colar) - a√ß√£o mais comum
      transcricaoInput.addEventListener('paste', (e) => {
        // Pequeno delay para o valor ser atualizado ap√≥s o paste
        setTimeout(() => handleTranscricaoChange(e), 100);
      });
      
      // Evento de input para quando digitar
      transcricaoInput.addEventListener('input', handleTranscricaoChange);
    }
    
    // Inicializar quando a p√°gina carregar
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupTranscricaoAutoTitle);
    } else {
      setTimeout(setupTranscricaoAutoTitle, 500);
    }
    // ========== FIM - GERA√á√ÉO AUTOM√ÅTICA DE T√çTULO ==========

    async function saveReuniao(){
      const dataInput = document.getElementById('reuniaoData');
      const objetivoInput = document.getElementById('reuniaoObjetivo');
      const transcricaoInput = document.getElementById('reuniaoTranscricao');
      const saveBtn = document.getElementById('reuniaoSaveBtn');
      
      const data = dataInput?.value?.trim();
      const objetivo = objetivoInput?.value?.trim();
      const transcricao = transcricaoInput?.value?.trim();
      
      if(!data){
        mgToast('‚ö†Ô∏è Informe a data da reuni√£o');
        return;
      }
      
      if(!objetivo){
        mgToast('‚ö†Ô∏è Informe o objetivo da reuni√£o');
        return;
      }
      
      if(!transcricao){
        mgToast('‚ö†Ô∏è Cole a transcri√ß√£o da reuni√£o');
        return;
      }
      
      try {
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<div class="spinner" style="width:16px;height:16px;border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin 0.8s linear infinite;display:inline-block;margin-right:8px;"></div> Gerando resumo...';
        
        const user = typeof window.getCurrentUser === 'function' ? window.getCurrentUser() : auth.currentUser;
        const now = new Date().toISOString();
        
        // Gerar resumo com IA
        let resumo = '';
        try {
          resumo = await generateReuniaoResumoIA(transcricao, objetivo);
        } catch(err) {
          console.error('Erro ao gerar resumo:', err);
          mgToast('‚ö†Ô∏è Erro ao gerar resumo, mas a reuni√£o ser√° salva');
        }
        
        if(currentEditingReuniao){
          // Atualizar existente
          const idx = REUNIOES.findIndex(r => r.id === currentEditingReuniao.id);
          if(idx !== -1){
            REUNIOES[idx] = {
              ...REUNIOES[idx],
              data,
              objetivo,
              transcricao,
              resumo: resumo || REUNIOES[idx].resumo,
              updatedAt: now
            };
          }
        } else {
          // Criar nova
          const newReuniao = {
            id: uuid(),
            data,
            objetivo,
            transcricao,
            resumo,
            authorId: user?.uid || '',
            authorName: user?.displayName || user?.email?.split('@')[0] || 'An√¥nimo',
            createdAt: now,
            updatedAt: now
          };
          REUNIOES.push(newReuniao);
        }
        
        await persistReunioes();
        closeReuniaoModal();
        renderReunioes(true); // skipLoad = true para usar dados locais
        mgToast('‚úÖ Reuni√£o salva com sucesso!');
        
      } catch(err) {
        console.error('‚ùå Erro ao salvar reuni√£o:', err);
        mgToast('Erro ao salvar reuni√£o: ' + (err.message || 'Erro desconhecido'));
      } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = 'üíæ Salvar e Gerar Resumo';
      }
    }
    window.saveReuniao = saveReuniao;

    async function generateReuniaoResumoIA(transcricao, objetivo){
      // Usar EXATAMENTE o mesmo m√©todo que funciona na aba de IA
      if(typeof window.callAIProxy !== 'function'){
        throw new Error('Fun√ß√£o callAIProxy n√£o dispon√≠vel');
      }
      
      const promptContent = `Voc√™ √© um assistente ESPECIALISTA em documentar reuni√µes de neg√≥cios.

Crie um RESUMO EXECUTIVO COMPLETO da reuni√£o abaixo. O resumo deve ser claro, bem organizado e permitir que qualquer pessoa entenda o que foi discutido.

**OBJETIVO DA REUNI√ÉO:** ${objetivo}

**TRANSCRI√á√ÉO:**
${transcricao.substring(0, 12000)}

---

GERE O RESUMO seguindo esta estrutura. Use formata√ß√£o SIMPLES e LIMPA (sem headers ####, apenas negrito para t√≠tulos de se√ß√£o):

**üìã RESUMO GERAL**
Escreva 2-4 frases explicando o contexto da reuni√£o, participantes (se mencionado) e foco principal.

**üìå T√ìPICOS DISCUTIDOS**
Liste cada t√≥pico abordado com uma breve descri√ß√£o do que foi conversado. Use bullet points simples:
- **Nome do t√≥pico:** Descri√ß√£o do que foi discutido sobre este ponto.
- **Outro t√≥pico:** Descri√ß√£o...

**‚úÖ DECIS√ïES TOMADAS**
Liste as decis√µes acordadas de forma clara:
- Decis√£o 1 (respons√°vel, se mencionado)
- Decis√£o 2

**üìã TAREFAS E RESPONS√ÅVEIS**
Liste as a√ß√µes definidas:
- **Tarefa:** Descri√ß√£o | Respons√°vel: Nome | Prazo: Data (se definido)
- **Tarefa:** Descri√ß√£o | Respons√°vel: Nome | Prazo: Data

**üìä DADOS MENCIONADOS**
Liste n√∫meros, m√©tricas ou valores citados:
- Dado 1: valor/contexto
- Dado 2: valor/contexto
(Se n√£o houver dados, escreva "Nenhum dado num√©rico mencionado")

**‚ö†Ô∏è PROBLEMAS IDENTIFICADOS**
- Problema ou desafio mencionado
(Se n√£o houver, escreva "Nenhum problema espec√≠fico levantado")

**üí° INSIGHTS IMPORTANTES**
- Observa√ß√µes relevantes da conversa
- Sugest√µes ou recomenda√ß√µes feitas

**‚ùì PEND√äNCIAS**
- Quest√µes que ficaram em aberto
- Pontos que precisam de follow-up

**üìÖ PR√ìXIMOS PASSOS**
- Pr√≥ximas a√ß√µes ou reuni√µes definidas

---

REGRAS DE FORMATA√á√ÉO:
1. N√ÉO use ### ou #### - apenas **texto em negrito** para t√≠tulos
2. Use bullet points simples (-)
3. Seja direto e objetivo
4. Mantenha par√°grafos curtos
5. Se uma se√ß√£o n√£o tiver informa√ß√£o, escreva brevemente "N√£o mencionado"
6. O resultado deve parecer um documento profissional e f√°cil de ler`;

      // Formato de mensagens igual √† aba de IA (OpenRouter/OpenAI format)
      const messages = [
        { role: 'system', content: 'Voc√™ √© um assistente que cria resumos de reuni√µes profissionais. Use formata√ß√£o limpa com negrito para t√≠tulos e bullet points para listas. Nunca use ### ou ####. Seja claro e objetivo.' },
        { role: 'user', content: promptContent }
      ];
      
      // Determinar userId para a API:
      // 1. Tentar auth.currentUser (usu√°rio real logado)
      // 2. Se n√£o existir, usar userId do parent window (para iframes)
      // 3. Como √∫ltimo recurso, usar 'rate-limit-only'
      let userId = null;
      
      // Tentar obter do auth local
      if (auth && auth.currentUser && auth.currentUser.uid) {
        userId = auth.currentUser.uid;
        console.log('ü§ñ [Reuni√£o/IA] userId do auth.currentUser:', userId);
      }
      // Tentar obter do parent (modo iframe admin)
      else if (window.parent && window.parent !== window) {
        try {
          const parentAuth = window.parent.auth;
          if (parentAuth && parentAuth.currentUser) {
            userId = parentAuth.currentUser.uid;
            console.log('ü§ñ [Reuni√£o/IA] userId do parent.auth:', userId);
          }
        } catch(e) {
          console.log('ü§ñ [Reuni√£o/IA] N√£o conseguiu acessar parent auth');
        }
      }
      
      // Fallback para rate-limit-only (backend aceita para rate limiting)
      if (!userId) {
        userId = 'anonymous-' + Date.now();
        console.log('ü§ñ [Reuni√£o/IA] Usando userId fallback:', userId);
      }
      
      console.log('ü§ñ [Reuni√£o/IA] Chamando callAIProxy com userId:', userId);
      
      // CHAMADA COM MAX_TOKENS AUMENTADO para resumo detalhado
      // max_tokens: 4096 permite resumos bem mais longos e detalhados
      const data = await window.callAIProxy(window.IA_CONFIG.model, messages, userId, 4096, 0.3);
      
      console.log('ü§ñ [Reuni√£o/IA] Resposta recebida:', data);
      
      // Extrair resposta no formato OpenRouter/OpenAI
      const resumo = data?.choices?.[0]?.message?.content;
      
      if(resumo){
        console.log('ü§ñ [Reuni√£o/IA] Resumo gerado com sucesso! (' + resumo.length + ' chars)');
        return resumo;
      }
      
      throw new Error('Resposta inv√°lida da IA');
    }

    function viewReuniao(reuniaoId){
      const reuniao = REUNIOES.find(r => r.id === reuniaoId);
      if(!reuniao) return;
      
      currentViewingReuniao = reuniao;
      
      const modal = document.getElementById('reuniaoViewModal');
      const dataEl = document.getElementById('reuniaoViewData');
      const objetivoEl = document.getElementById('reuniaoViewObjetivo');
      const resumoEl = document.getElementById('reuniaoViewResumo');
      const transcricaoEl = document.getElementById('reuniaoViewTranscricao');
      const generatingEl = document.getElementById('reuniaoViewGenerating');
      
      if(!modal) return;
      
      const dataFormatada = reuniao.data ? new Date(reuniao.data + 'T00:00:00').toLocaleDateString('pt-BR', {
        weekday: 'long',
        day: '2-digit',
        month: 'long',
        year: 'numeric'
      }) : 'Sem data';
      
      dataEl.textContent = dataFormatada;
      objetivoEl.textContent = reuniao.objetivo || 'Sem objetivo definido';
      
      if(reuniao.resumo){
        resumoEl.innerHTML = formatResumoForDisplay(reuniao.resumo);
        generatingEl.style.display = 'none';
        resumoEl.style.display = 'block';
      } else {
        resumoEl.style.display = 'none';
        generatingEl.style.display = 'flex';
        
        // Gerar resumo automaticamente se n√£o existir
        generateReuniaoResumoIA(reuniao.transcricao, reuniao.objetivo).then(resumo => {
          const idx = REUNIOES.findIndex(r => r.id === reuniaoId);
          if(idx !== -1){
            REUNIOES[idx].resumo = resumo;
            REUNIOES[idx].updatedAt = new Date().toISOString();
            persistReunioes();
          }
          resumoEl.innerHTML = formatResumoForDisplay(resumo);
          generatingEl.style.display = 'none';
          resumoEl.style.display = 'block';
          renderReunioes(true); // skipLoad = true ap√≥s persistir
        }).catch(err => {
          console.error('Erro ao gerar resumo:', err);
          resumoEl.innerHTML = '<p style="color:#ef4444;">Erro ao gerar resumo. Tente novamente.</p>';
          generatingEl.style.display = 'none';
          resumoEl.style.display = 'block';
        });
      }
      
      transcricaoEl.textContent = reuniao.transcricao || 'Transcri√ß√£o n√£o dispon√≠vel';
      
      modal.classList.add('show');
    }
    window.viewReuniao = viewReuniao;

    function formatResumoForDisplay(resumo){
      if(!resumo) return '';
      
      // Converter markdown para HTML formatado - formata√ß√£o limpa e profissional
      let html = resumo
        // Remover headers #### e ### - converter para negrito simples
        .replace(/^#{1,4}\s*(.*?)$/gm, '<strong style="color:#60a5fa;display:block;margin:16px 0 8px;font-size:1rem;">$1</strong>')
        // Bold **text** - t√≠tulos de se√ß√£o com emoji ficam destacados
        .replace(/\*\*(üìã|üìå|‚úÖ|üìä|‚ö†Ô∏è|üí°|‚ùì|üìÖ|üíº)(.*?)\*\*/g, '<div style="color:#60a5fa;font-weight:600;margin:20px 0 10px;font-size:1.02rem;border-bottom:1px solid rgba(96,165,250,0.2);padding-bottom:6px;">$1$2</div>')
        // Bold **text** normal
        .replace(/\*\*(.*?)\*\*/g, '<strong style="color:#f1f5f9;">$1</strong>')
        // Italic *text*
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        // Bullet points - text
        .replace(/^- (.*?)$/gm, '<div style="display:flex;align-items:flex-start;gap:8px;margin:5px 0;padding-left:4px;"><span style="color:#60a5fa;">‚Ä¢</span><span>$1</span></div>')
        // Indented bullet points (2+ spaces)
        .replace(/^\s{2,}- (.*?)$/gm, '<div style="display:flex;align-items:flex-start;gap:8px;margin:3px 0;padding-left:20px;"><span style="color:#94a3b8;">‚ó¶</span><span style="color:#cbd5e1;font-size:0.92em;">$1</span></div>')
        // Double newlines = paragraph break
        .replace(/\n\n/g, '<div style="margin:10px 0;"></div>')
        // Single newlines
        .replace(/\n/g, '<br>');
      
      // Wrap in container
      html = '<div style="line-height:1.75;color:#e2e8f0;">' + html + '</div>';
      
      return html;
    }

    function closeReuniaoViewModal(){
      const modal = document.getElementById('reuniaoViewModal');
      if(modal) modal.classList.remove('show');
      currentViewingReuniao = null;
    }
    window.closeReuniaoViewModal = closeReuniaoViewModal;

    async function regenerateReuniaoResumo(){
      if(!currentViewingReuniao) return;
      
      const btn = document.getElementById('regenerateResumoBtn');
      const resumoEl = document.getElementById('reuniaoViewResumo');
      const generatingEl = document.getElementById('reuniaoViewGenerating');
      
      try {
        btn.disabled = true;
        btn.innerHTML = '‚è≥ Regenerando...';
        resumoEl.style.display = 'none';
        generatingEl.style.display = 'flex';
        
        const resumo = await generateReuniaoResumoIA(
          currentViewingReuniao.transcricao, 
          currentViewingReuniao.objetivo
        );
        
        const idx = REUNIOES.findIndex(r => r.id === currentViewingReuniao.id);
        if(idx !== -1){
          REUNIOES[idx].resumo = resumo;
          REUNIOES[idx].updatedAt = new Date().toISOString();
          await persistReunioes();
        }
        
        resumoEl.innerHTML = formatResumoForDisplay(resumo);
        generatingEl.style.display = 'none';
        resumoEl.style.display = 'block';
        renderReunioes(true); // skipLoad = true ap√≥s persistir
        mgToast('‚úÖ Resumo regenerado!');
        
      } catch(err) {
        console.error('Erro ao regenerar resumo:', err);
        mgToast('Erro ao regenerar resumo');
        generatingEl.style.display = 'none';
        resumoEl.style.display = 'block';
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'üîÑ Regenerar Resumo';
      }
    }
    window.regenerateReuniaoResumo = regenerateReuniaoResumo;

    // ========== CONVERS√ÉO PARA FORMATO WHATSAPP ==========
    function converterParaFormatoWhatsApp(texto) {
      if (!texto) return '';
      
      let wpp = texto
        // Remover headers markdown (##, ###, ####) e converter para negrito WhatsApp
        .replace(/^#{1,4}\s*(.+)$/gm, '*$1*')
        
        // Converter **texto** (negrito markdown) para *texto* (negrito WhatsApp)
        .replace(/\*\*(.+?)\*\*/g, '*$1*')
        
        // Manter emojis de se√ß√£o em negrito
        .replace(/^\*(üìã|üìå|‚úÖ|üìä|‚ö†Ô∏è|üí°|‚ùì|üìÖ|üíº)(.+?)\*$/gm, '*$1$2*')
        
        // Converter _texto_ ou *texto* (it√°lico markdown) para _texto_ (it√°lico WhatsApp)
        // Cuidado para n√£o converter negrito j√° convertido
        .replace(/(?<!\*)_(.+?)_(?!\*)/g, '_$1_')
        
        // Converter listas com - para ‚Ä¢ (mais visual no WhatsApp)
        .replace(/^[\s]*[-‚Ä¢]\s*/gm, '‚Ä¢ ')
        
        // Converter sublistas com espa√ßos para indenta√ß√£o visual
        .replace(/^(\s{2,})‚Ä¢\s*/gm, '   ‚ó¶ ')
        
        // Limpar espa√ßos extras no in√≠cio das linhas
        .replace(/^\s+(?=\S)/gm, '');
      
      // GARANTIR ESPA√áAMENTO ANTES DOS T√çTULOS DE SE√á√ÉO (emojis)
      // Adiciona linha em branco ANTES de cada t√≠tulo com emoji
      wpp = wpp.replace(/([^\n])\n(\*[üìãüìå‚úÖüìä‚ö†Ô∏èüí°‚ùìüìÖüíº])/g, '$1\n\n$2');
      
      // Garantir espa√ßamento DEPOIS dos t√≠tulos de se√ß√£o
      wpp = wpp.replace(/(\*[üìãüìå‚úÖüìä‚ö†Ô∏èüí°‚ùìüìÖüíº][^*]+\*)\n(?!\n)/g, '$1\n');
      
      // Remover m√∫ltiplas quebras de linha (m√°ximo 2)
      wpp = wpp.replace(/\n{3,}/g, '\n\n');
      
      return wpp.trim();
    }

    // ========== CONVERS√ÉO PARA FORMATO ESTRUTURADO (Google Docs style) ==========
    function converterParaFormatoEstruturado(texto) {
      if (!texto) return '';
      
      let estruturado = texto;
      
      // Primeiro, remover toda a marca√ß√£o markdown de headers mas manter o texto
      // #### Texto ‚Üí Texto (mant√©m como est√°, ser√° identificado pela posi√ß√£o)
      estruturado = estruturado.replace(/^#{1,4}\s+(.+)$/gm, '$1');
      
      // Converter **negrito** markdown removendo os asteriscos
      estruturado = estruturado.replace(/\*\*(.+?)\*\*/g, '$1');
      
      // Converter _it√°lico_ ou *it√°lico* markdown removendo marcadores
      estruturado = estruturado.replace(/(?<!\*)[_*](.+?)[_*](?!\*)/g, '$1');
      
      // Processar listas: converter - ou * no in√≠cio da linha para ‚Ä¢
      // Detectar n√≠vel de indenta√ß√£o e aplicar o bullet apropriado
      estruturado = estruturado.replace(/^(\s*)[-*]\s+(.+)$/gm, (match, spaces, content) => {
        const indentLevel = spaces.length;
        if (indentLevel === 0) {
          return `‚Ä¢ ${content}`;
        } else if (indentLevel <= 2) {
          return `\t‚ó¶ ${content}`;
        } else {
          return `\t\t‚ñ™ ${content}`;
        }
      });
      
      // Adicionar linha em branco ANTES de t√≠tulos de se√ß√£o (linhas com emoji no in√≠cio)
      estruturado = estruturado.replace(/([^\n])\n([üìãüìå‚úÖüìä‚ö†Ô∏èüí°‚ùìüìÖüíºüéØüîçüìàüí∞üöÄ‚è∞üë•üóÇÔ∏èüìùüîÑüì±üíªüé®üé¨üì∏üìπüé•üéØ])/g, '$1\n\n$2');
      
      // Adicionar linha em branco DEPOIS de t√≠tulos de se√ß√£o (linhas com emoji)
      estruturado = estruturado.replace(/^([üìãüìå‚úÖüìä‚ö†Ô∏èüí°‚ùìüìÖüíºüéØüîçüìàüí∞üöÄ‚è∞üë•üóÇÔ∏èüìùüîÑüì±üíªüé®üé¨üì∏üìπüé•].+)$/gm, '$1\n');
      
      // Adicionar linha em branco ANTES de linhas que terminam com ":"
      estruturado = estruturado.replace(/([^\n])\n([^‚Ä¢‚ó¶‚ñ™\n\t].+:)$/gm, '$1\n\n$2');
      
      // Adicionar linha em branco DEPOIS de linhas que terminam com ":"
      estruturado = estruturado.replace(/^([^‚Ä¢‚ó¶‚ñ™\n].+:)$/gm, '$1\n');
      
      // Adicionar quebra de linha ANTES do primeiro item de cada lista
      estruturado = estruturado.replace(/([^\n‚Ä¢‚ó¶‚ñ™])\n(‚Ä¢)/g, '$1\n\n$2');
      
      // Adicionar quebra de linha DEPOIS do √∫ltimo item de lista (quando pr√≥xima linha n√£o √© lista)
      estruturado = estruturado.replace(/(^[‚Ä¢‚ó¶‚ñ™\t].+)$\n([^‚Ä¢‚ó¶‚ñ™\t\n])/gm, '$1\n\n$2');
      
      // Limpar m√∫ltiplas quebras de linha (m√°ximo 2)
      estruturado = estruturado.replace(/\n{3,}/g, '\n\n');
      
      // Limpar espa√ßos no final das linhas
      estruturado = estruturado.replace(/[ \t]+$/gm, '');
      
      // Limpar linhas vazias no in√≠cio e fim
      estruturado = estruturado.trim();
      
      return estruturado;
    }

    /**
     * Converte markdown para HTML formatado (para Google Docs)
     * @param {string} texto - Texto em markdown
     * @returns {string} HTML formatado
     */
    function converterMarkdownParaHTML(texto) {
      if (!texto) return '';
      
      let linhas = texto.split('\n');
      let resultado = [];
      let dentroLista = false;
      
      for (let i = 0; i < linhas.length; i++) {
        let linha = linhas[i];
        
        // Pular linhas vazias completamente
        if (linha.trim() === '') {
          if (dentroLista) {
            resultado.push('</ul>');
            dentroLista = false;
          }
          continue;
        }
        
        // Converter **negrito** e *it√°lico* PRIMEIRO (antes de processar tags)
        linha = linha.replace(/\*\*(.+?)\*\*/g, '<b>$1</b>');
        linha = linha.replace(/(?<!\*)[_*](.+?)[_*](?!\*)/g, '<i>$1</i>');
        
        // Detectar headers markdown EXPL√çCITOS
        if (linha.match(/^# (.+)$/)) {
          if (dentroLista) {
            resultado.push('</ul>');
            dentroLista = false;
          }
          const conteudo = linha.replace(/^# /, '');
          resultado.push(`<h1 style="text-align: left;">${conteudo}</h1>`);
        } 
        else if (linha.match(/^## (.+)$/)) {
          if (dentroLista) {
            resultado.push('</ul>');
            dentroLista = false;
          }
          const conteudo = linha.replace(/^## /, '');
          resultado.push(`<h2 style="text-align: left;">${conteudo}</h2>`);
        } 
        else if (linha.match(/^### (.+)$/)) {
          if (dentroLista) {
            resultado.push('</ul>');
            dentroLista = false;
          }
          const conteudo = linha.replace(/^### /, '');
          resultado.push(`<h3 style="text-align: left;">${conteudo}</h3>`);
        } 
        else if (linha.match(/^#### (.+)$/)) {
          if (dentroLista) {
            resultado.push('</ul>');
            dentroLista = false;
          }
          const conteudo = linha.replace(/^#### /, '');
          resultado.push(`<h4 style="text-align: left;">${conteudo}</h4>`);
        }
        // Detectar t√≠tulos por emoji no IN√çCIO
        else if (linha.match(/^([üìãüìå‚úÖüìä‚ö†Ô∏èüí°‚ùìüìÖüíºüéØüîçüìàüí∞üöÄ‚è∞üë•üóÇÔ∏èüìùüîÑüì±üíªüé®üé¨üì∏üìπüé•])/)) {
          if (dentroLista) {
            resultado.push('</ul>');
            dentroLista = false;
          }
          resultado.push(`<h2 style="text-align: left;">${linha}</h2>`);
        }
        // Detectar t√≠tulos por ":" no final (linha n√£o indentada, n√£o √© lista)
        else if (linha.match(/^[^‚Ä¢‚ó¶‚ñ™\-\*\s].+:$/) && !dentroLista) {
          if (linha.match(/\d{2}\/\d{2}\/\d{4}/) || linha.match(/Slide|Reuni√£o|Discuss√£o/i)) {
            resultado.push(`<h2 style="text-align: left;">${linha}</h2>`);
          } else {
            resultado.push(`<h3 style="text-align: left;">${linha}</h3>`);
          }
        }
        // Detectar listas
        else if (linha.match(/^(\s*)[-*‚Ä¢]\s+(.+)$/)) {
          const match = linha.match(/^(\s*)[-*‚Ä¢]\s+(.+)$/);
          const conteudo = match[2];
          
          if (!dentroLista) {
            resultado.push('<ul style="text-align: left;">');
            dentroLista = true;
          }
          
          resultado.push(`<li>${conteudo}</li>`);
        }
        // Texto normal - par√°grafo
        else {
          if (dentroLista) {
            resultado.push('</ul>');
            dentroLista = false;
          }
          resultado.push(`<p style="text-align: left;">${linha}</p>`);
        }
      }
      
      // Fechar lista se ainda estiver aberta
      if (dentroLista) {
        resultado.push('</ul>');
      }
      
      // Retornar HTML sem wrapper - cada elemento j√° tem seu pr√≥prio text-align
      return resultado.join('');
    }

    function copyReuniaoResumo(){
      if(!currentViewingReuniao?.resumo) {
        mgToast('‚ö†Ô∏è Nenhum resumo para copiar');
        return;
      }
      
      // Montar texto base
      const textoBase = `üìÖ *RESUMO DA REUNI√ÉO*\n\n` +
        `*Data:* ${currentViewingReuniao.data ? new Date(currentViewingReuniao.data + 'T00:00:00').toLocaleDateString('pt-BR') : 'N√£o definida'}\n` +
        `*T√≠tulo:* ${currentViewingReuniao.objetivo || 'N√£o definido'}\n\n` +
        `${currentViewingReuniao.resumo}`;
      
      // Converter para formato WhatsApp
      const textoWhatsApp = converterParaFormatoWhatsApp(textoBase);
      
      // Usar mgCopyToClipboard para suporte a iframe
      mgCopyToClipboard(textoWhatsApp).then(success => {
        if (success) {
          mgToast('‚úÖ Resumo copiado no formato WhatsApp!');
        } else {
          mgToast('Erro ao copiar');
        }
      });
    }
    window.copyReuniaoResumo = copyReuniaoResumo;

    function copyReuniaoResumoTexto(){
      if(!currentViewingReuniao?.resumo) {
        mgToast('‚ö†Ô∏è Nenhum resumo para copiar');
        return;
      }
      
      // Montar texto com estrutura
      const textoBase = `# RESUMO DA REUNI√ÉO\n\n` +
        `**Data:** ${currentViewingReuniao.data ? new Date(currentViewingReuniao.data + 'T00:00:00').toLocaleDateString('pt-BR') : 'N√£o definida'}\n` +
        `**T√≠tulo:** ${currentViewingReuniao.objetivo || 'N√£o definido'}\n\n` +
        `${currentViewingReuniao.resumo}`;
      
      // Converter para HTML formatado
      const htmlFormatado = converterMarkdownParaHTML(textoBase);
      
      // Texto plano como fallback
      const textoPlano = converterParaFormatoEstruturado(textoBase);
      
      // Usar mgCopyFormattedToClipboard para copiar com formata√ß√£o HTML
      mgCopyFormattedToClipboard(htmlFormatado, textoPlano).then(success => {
        if (success) {
          mgToast('‚úÖ Resumo copiado com formata√ß√£o!');
        } else {
          mgToast('Erro ao copiar');
        }
      });
    }
    window.copyReuniaoResumoTexto = copyReuniaoResumoTexto;

    function editReuniao(reuniaoId){
      openReuniaoModal(reuniaoId);
    }
    window.editReuniao = editReuniao;

    async function deleteReuniao(reuniaoId){
      if(!confirm('Tem certeza que deseja excluir esta reuni√£o?')) return;
      
      try {
        REUNIOES = REUNIOES.filter(r => r.id !== reuniaoId);
        await persistReunioes();
        renderReunioes(true); // skipLoad = true ap√≥s persistir
        mgToast('‚úÖ Reuni√£o exclu√≠da');
      } catch(err) {
        console.error('Erro ao excluir reuni√£o:', err);
        mgToast('Erro ao excluir reuni√£o');
      }
    }
    window.deleteReuniao = deleteReuniao;

    // ========== CHAT IA PARA CONSULTAR REUNI√ïES ==========
    let reunioesChatHistory = [];
    let reunioesAllChats = []; // Array de todas as conversas salvas
    let reunioesCurrentChatId = null; // ID da conversa atual
    
    function updateReunioesChatStats() {
      // Atualizar contadores
      const countEl = document.getElementById('reunioesChatCount');
      const countSidebarEl = document.getElementById('reunioesChatCountSidebar');
      if (countEl) countEl.textContent = REUNIOES.length;
      if (countSidebarEl) countSidebarEl.textContent = REUNIOES.length;
      
      // Mostrar/ocultar se√ß√£o de chat baseado em se h√° reuni√µes
      const chatSection = document.getElementById('reunioesChatSection');
      if (chatSection) {
        chatSection.style.display = REUNIOES.length > 0 ? 'flex' : 'none';
      }
      
      // Atualizar op√ß√µes do filtro de reuni√µes
      if (typeof updateReunioesChatFilterOptions === 'function') {
        updateReunioesChatFilterOptions();
      }
      
      // Resetar conversa atual ao trocar de cliente/recarregar
      reunioesCurrentChatId = null;
      reunioesChatHistory = [];
      
      // Resetar UI do chat
      const messagesEl = document.getElementById('reunioesChatMessages');
      if (messagesEl) {
        messagesEl.innerHTML = `
          <div class="reunioes-chat-welcome">
            <div class="reunioes-chat-welcome-icon">ü§ñ</div>
            <h4>Assistente de Reuni√µes</h4>
            <p>Pergunte sobre qualquer assunto discutido nas suas reuni√µes</p>
            <div class="reunioes-chat-suggestions">
              <button onclick="askReuniaoSuggestion('Quais foram as principais decis√µes tomadas?')">üìã Principais decis√µes</button>
              <button onclick="askReuniaoSuggestion('Quais tarefas ficaram pendentes?')">‚è≥ Tarefas pendentes</button>
              <button onclick="askReuniaoSuggestion('Resuma os principais t√≥picos discutidos')">üìå T√≥picos discutidos</button>
              <button onclick="askReuniaoSuggestion('Quais problemas foram identificados?')">‚ö†Ô∏è Problemas</button>
              <button onclick="askReuniaoSuggestion('Quem ficou respons√°vel por cada tarefa?')">üë§ Respons√°veis</button>
              <button onclick="askReuniaoSuggestion('Quais foram os prazos definidos?')">üìÖ Prazos</button>
              <button onclick="askReuniaoSuggestion('O que foi discutido sobre metas e resultados?')">üéØ Metas e Resultados</button>
              <button onclick="askReuniaoSuggestion('Houve algum pr√≥ximo passo ou a√ß√£o combinada?')">‚û°Ô∏è Pr√≥ximos passos</button>
              <button onclick="askReuniaoSuggestion('Fa√ßa um resumo geral de todas as reuni√µes')">üìä Resumo geral</button>
            </div>
          </div>
        `;
      }
      
      // Carregar conversas salvas do cliente atual
      loadReunioesChatsFromStorage();
    }
    
    function loadReunioesChatsFromStorage() {
      // Carregar do Firebase para o usu√°rio atual E cliente selecionado
      const uid = getReunioesTargetUid();
      const clientKey = typeof getClientKey === 'function' ? getClientKey() : null;
      
      if (!uid) {
        console.warn('[ReunioesChats] Usu√°rio n√£o logado, n√£o √© poss√≠vel carregar chats');
        reunioesAllChats = [];
        renderReunioesChatHistoryList();
        return;
      }
      
      if (!clientKey || clientKey === 'no-client') {
        console.warn('[ReunioesChats] Nenhum cliente selecionado, n√£o √© poss√≠vel carregar chats');
        reunioesAllChats = [];
        renderReunioesChatHistoryList();
        return;
      }
      
      try {
        // Buscar do Firebase - separado por uid E clientKey
        const chatsRef = doc(db, 'usuarios', uid, 'clients', clientKey, 'reunioesChats', 'data');
        getDoc(chatsRef).then(docSnap => {
          if (docSnap.exists()) {
            const data = docSnap.data();
            reunioesAllChats = data.chats || [];
            console.log('[ReunioesChats] Carregado do Firebase para cliente', clientKey, ':', reunioesAllChats.length, 'conversas');
          } else {
            reunioesAllChats = [];
            console.log('[ReunioesChats] Nenhum hist√≥rico encontrado para cliente', clientKey);
          }
          renderReunioesChatHistoryList();
        }).catch(err => {
          console.error('[ReunioesChats] Erro ao carregar do Firebase:', err);
          reunioesAllChats = [];
          renderReunioesChatHistoryList();
        });
      } catch(e) {
        console.error('Erro ao carregar hist√≥rico de chats:', e);
        reunioesAllChats = [];
        renderReunioesChatHistoryList();
      }
    }
    
    function saveReunioesChatsToStorage() {
      // Salvar no Firebase para o usu√°rio atual E cliente selecionado
      const uid = getReunioesTargetUid();
      const clientKey = typeof getClientKey === 'function' ? getClientKey() : null;
      
      if (!uid) {
        console.warn('[ReunioesChats] Usu√°rio n√£o logado, n√£o √© poss√≠vel salvar chats');
        return;
      }
      
      if (!clientKey || clientKey === 'no-client') {
        console.warn('[ReunioesChats] Nenhum cliente selecionado, n√£o √© poss√≠vel salvar chats');
        return;
      }
      
      try {
        const chatsRef = doc(db, 'usuarios', uid, 'clients', clientKey, 'reunioesChats', 'data');
        setDoc(chatsRef, {
          chats: reunioesAllChats,
          updatedAt: Date.now()
        }, { merge: true }).then(() => {
          console.log('[ReunioesChats] Salvo no Firebase para cliente', clientKey, ':', reunioesAllChats.length, 'conversas');
        }).catch(err => {
          console.error('[ReunioesChats] Erro ao salvar no Firebase:', err);
        });
      } catch(e) {
        console.error('Erro ao salvar hist√≥rico de chats:', e);
      }
    }
    
    function renderReunioesChatHistoryList() {
      const listEl = document.getElementById('reunioesChatHistoryList');
      if (!listEl) return;
      
      if (reunioesAllChats.length === 0) {
        listEl.innerHTML = `
          <div class="reunioes-chat-sidebar-empty">
            <div class="reunioes-chat-sidebar-empty-icon">üí¨</div>
            <p>Suas conversas aparecer√£o aqui</p>
          </div>
        `;
        return;
      }
      
      // Ordenar por data (mais recentes primeiro)
      const sortedChats = [...reunioesAllChats].sort((a, b) => b.updatedAt - a.updatedAt);
      
      listEl.innerHTML = sortedChats.map(chat => {
        const date = new Date(chat.updatedAt).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        const isActive = chat.id === reunioesCurrentChatId;
        return `
          <div class="reunioes-chat-history-item ${isActive ? 'active' : ''}" onclick="loadReuniaoChat('${chat.id}')">
            <span class="reunioes-chat-history-item-icon">üí¨</span>
            <div class="reunioes-chat-history-item-content">
              <div class="reunioes-chat-history-item-title">${chat.title || 'Nova conversa'}</div>
              <div class="reunioes-chat-history-item-date">${date}</div>
            </div>
            <div class="reunioes-chat-history-item-actions">
              <button type="button" class="reunioes-chat-history-item-btn delete" onclick="event.stopPropagation(); deleteReuniaoChat('${chat.id}')" title="Excluir">üóëÔ∏è</button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function toggleReunioesChatSidebar() {
      const sidebar = document.getElementById('reunioesChatSidebar');
      if (sidebar) {
        sidebar.classList.toggle('collapsed');
        // Em mobile, usar classe open
        if (window.innerWidth <= 768) {
          sidebar.classList.toggle('open');
        }
      }
    }
    window.toggleReunioesChatSidebar = toggleReunioesChatSidebar;
    
    async function startNewReuniaoChat() {
      // Salvar conversa atual se tiver mensagens
      if (reunioesChatHistory.length > 0) {
        await saveCurrentReuniaoChat();
      }
      
      // Criar nova conversa
      reunioesCurrentChatId = 'chat_' + Date.now();
      reunioesChatHistory = [];
      
      // Resetar UI
      const messagesEl = document.getElementById('reunioesChatMessages');
      if (messagesEl) {
        messagesEl.innerHTML = `
          <div class="reunioes-chat-welcome">
            <div class="reunioes-chat-welcome-icon">ü§ñ</div>
            <h4>Assistente de Reuni√µes</h4>
            <p>Pergunte sobre qualquer assunto discutido nas suas reuni√µes</p>
            <div class="reunioes-chat-suggestions">
              <button onclick="askReuniaoSuggestion('Quais foram as principais decis√µes tomadas?')">üìã Principais decis√µes</button>
              <button onclick="askReuniaoSuggestion('Quais tarefas ficaram pendentes?')">‚è≥ Tarefas pendentes</button>
              <button onclick="askReuniaoSuggestion('Resuma os principais t√≥picos discutidos')">üìå T√≥picos discutidos</button>
              <button onclick="askReuniaoSuggestion('Quais problemas foram identificados?')">‚ö†Ô∏è Problemas</button>
              <button onclick="askReuniaoSuggestion('Quem ficou respons√°vel por cada tarefa?')">üë§ Respons√°veis</button>
              <button onclick="askReuniaoSuggestion('Quais foram os prazos definidos?')">üìÖ Prazos</button>
              <button onclick="askReuniaoSuggestion('O que foi discutido sobre metas e resultados?')">üéØ Metas e Resultados</button>
              <button onclick="askReuniaoSuggestion('Houve algum pr√≥ximo passo ou a√ß√£o combinada?')">‚û°Ô∏è Pr√≥ximos passos</button>
              <button onclick="askReuniaoSuggestion('Fa√ßa um resumo geral de todas as reuni√µes')">üìä Resumo geral</button>
            </div>
          </div>
        `;
      }
      
      // Atualizar lista para remover sele√ß√£o ativa
      renderReunioesChatHistoryList();
      
      // Fechar sidebar em mobile
      if (window.innerWidth <= 768) {
        const sidebar = document.getElementById('reunioesChatSidebar');
        if (sidebar) sidebar.classList.remove('open');
      }
    }
    window.startNewReuniaoChat = startNewReuniaoChat;
    
    // Gerar t√≠tulo descritivo com IA (5-6 palavras)
    async function generateChatTitleIA(messages) {
      if (!messages || messages.length === 0) {
        console.log('‚ö†Ô∏è generateChatTitleIA: Sem mensagens');
        return null;
      }
      if (typeof window.callAIProxy !== 'function') {
        console.log('‚ö†Ô∏è generateChatTitleIA: callAIProxy n√£o dispon√≠vel');
        return null;
      }
      
      try {
        // Pegar a pergunta do usu√°rio e a resposta da IA
        const userMsg = messages.find(m => m.role === 'user');
        const assistantMsg = messages.find(m => m.role === 'assistant');
        
        const pergunta = userMsg?.content?.substring(0, 300) || '';
        const resposta = assistantMsg?.content?.substring(0, 500) || '';
        
        console.log('ü§ñ Chamando IA para gerar t√≠tulo...');
        
        const userId = auth?.currentUser?.uid || 'anonymous';
        const aiMessages = [{ role: 'user', content: `Crie um T√çTULO CURTO de 5-6 palavras que descreva esta conversa sobre reuni√µes.

O t√≠tulo deve resumir O QUE FOI PERGUNTADO e O QUE FOI RESPONDIDO.

PERGUNTA DO USU√ÅRIO:
${pergunta}

RESPOSTA DO ASSISTENTE:
${resposta}

REGRAS:
- Use entre 5 e 6 palavras
- Seja direto e descritivo
- Sem pontua√ß√£o
- Sem aspas
- Apenas o t√≠tulo

T√çTULO:` }];
        
        // Usando a assinatura correta: callAIProxy(model, messages, userId, maxTokens, temperature)
        const data = await window.callAIProxy('google/gemini-2.5-flash', aiMessages, userId, 50, 0.3);
        const content = data?.choices?.[0]?.message?.content;
        
        console.log('ü§ñ Resposta da IA:', content);
        
        if (content) {
          // Limpar e pegar at√© 6 palavras
          const cleaned = content.trim()
            .replace(/["'`]/g, '')
            .replace(/[^\w\s√°√†√¢√£√©√®√™√≠√¨√Æ√≥√≤√¥√µ√∫√π√ª√ß√Å√Ä√Ç√É√â√à√ä√ç√å√é√ì√í√î√ï√ö√ô√õ√á-]/gi, ' ')
            .replace(/\s+/g, ' ')
            .trim();
          const words = cleaned.split(' ').filter(w => w.length > 0).slice(0, 6);
          console.log('ü§ñ Palavras extra√≠das:', words);
          if (words.length >= 3) {
            const title = words.join(' ');
            console.log('‚úÖ T√≠tulo final:', title);
            return title;
          }
        }
      } catch (err) {
        console.error('‚ùå Erro ao gerar t√≠tulo IA:', err);
      }
      return null;
    }
    
    async function saveCurrentReuniaoChat() {
      if (reunioesChatHistory.length === 0) return;
      
      // Verificar se j√° existe
      const existingIndex = reunioesAllChats.findIndex(c => c.id === reunioesCurrentChatId);
      
      // Verificar se j√° tem um t√≠tulo v√°lido gerado por IA (sem "...")
      const existingTitle = existingIndex >= 0 ? reunioesAllChats[existingIndex].title : null;
      const isValidIATitle = existingTitle && 
                            !existingTitle.includes('...') && 
                            !existingTitle.startsWith('Nova conversa') &&
                            existingTitle.split(' ').length >= 3;
      
      let title;
      if (isValidIATitle) {
        // J√° tem t√≠tulo v√°lido gerado, manter
        title = existingTitle;
        console.log('üìù Mantendo t√≠tulo existente:', title);
      } else {
        // Gerar t√≠tulo com IA (5-6 palavras)
        console.log('ü§ñ Gerando t√≠tulo com IA...');
        title = await generateChatTitleIA(reunioesChatHistory);
        console.log('ü§ñ T√≠tulo gerado:', title);
        
        if (!title) {
          // Fallback: usar in√≠cio da primeira pergunta
          const firstUserMsg = reunioesChatHistory.find(m => m.role === 'user');
          title = firstUserMsg ? firstUserMsg.content.substring(0, 30) + '...' : 'Nova conversa';
          console.log('‚ö†Ô∏è Usando fallback:', title);
        }
      }
      
      const chatData = {
        id: reunioesCurrentChatId || 'chat_' + Date.now(),
        title: title,
        messages: [...reunioesChatHistory],
        createdAt: existingIndex >= 0 ? reunioesAllChats[existingIndex].createdAt : Date.now(),
        updatedAt: Date.now()
      };
      
      if (existingIndex >= 0) {
        reunioesAllChats[existingIndex] = chatData;
      } else {
        reunioesAllChats.unshift(chatData); // Adicionar no in√≠cio
      }
      
      // Limitar a 30 conversas
      if (reunioesAllChats.length > 30) {
        reunioesAllChats = reunioesAllChats.slice(0, 30);
      }
      
      saveReunioesChatsToStorage();
      renderReunioesChatHistoryList();
    }
    
    async function loadReuniaoChat(chatId) {
      // Salvar conversa atual primeiro
      if (reunioesChatHistory.length > 0) {
        await saveCurrentReuniaoChat();
      }
      
      const chat = reunioesAllChats.find(c => c.id === chatId);
      if (!chat) {
        mgToast('‚ùå Conversa n√£o encontrada');
        return;
      }
      
      reunioesCurrentChatId = chatId;
      reunioesChatHistory = [...chat.messages];
      
      // Renderizar mensagens
      const messagesEl = document.getElementById('reunioesChatMessages');
      if (messagesEl) {
        messagesEl.innerHTML = '';
        chat.messages.forEach(msg => {
          renderReunioesChatMessage(msg.role, msg.content);
        });
      }
      
      // Atualizar lista para mostrar item ativo
      renderReunioesChatHistoryList();
      
      // Fechar sidebar em mobile
      if (window.innerWidth <= 768) {
        const sidebar = document.getElementById('reunioesChatSidebar');
        if (sidebar) sidebar.classList.remove('open');
      }
    }
    window.loadReuniaoChat = loadReuniaoChat;
    
    function deleteReuniaoChat(chatId) {
      if (!confirm('Excluir esta conversa?')) return;
      
      reunioesAllChats = reunioesAllChats.filter(c => c.id !== chatId);
      saveReunioesChatsToStorage();
      renderReunioesChatHistoryList();
      
      // Se deletou a conversa atual, iniciar nova
      if (chatId === reunioesCurrentChatId) {
        reunioesCurrentChatId = null;
        reunioesChatHistory = [];
        startNewReuniaoChat();
      }
      
      mgToast('üóëÔ∏è Conversa exclu√≠da');
    }
    window.deleteReuniaoChat = deleteReuniaoChat;
    
    // Vari√°vel para armazenar o filtro de reuni√£o selecionada
    let reunioesChatFilterId = ''; // Vazio = todas as reuni√µes
    
    // Atualizar select de filtro com as reuni√µes dispon√≠veis
    function updateReunioesChatFilterOptions() {
      const select = document.getElementById('reunioesChatFilter');
      if (!select) return;
      
      // Manter o valor selecionado
      const currentValue = select.value;
      
      // Limpar op√ß√µes existentes (exceto a primeira)
      select.innerHTML = '<option value="">üìÇ Todas as reuni√µes</option>';
      
      if (!REUNIOES || REUNIOES.length === 0) return;
      
      // Ordenar por data (mais recentes primeiro)
      const reunioesOrdenadas = [...REUNIOES].sort((a, b) => {
        return new Date(b.data || 0) - new Date(a.data || 0);
      });
      
      reunioesOrdenadas.forEach(r => {
        const dataFormatada = r.data ? new Date(r.data + 'T00:00:00').toLocaleDateString('pt-BR') : 'Sem data';
        const titulo = r.objetivo || 'Sem t√≠tulo';
        const option = document.createElement('option');
        option.value = r.id;
        option.textContent = `üìÖ ${titulo} (${dataFormatada})`;
        select.appendChild(option);
      });
      
      // Restaurar sele√ß√£o se ainda existir
      if (currentValue && reunioesOrdenadas.find(r => r.id === currentValue)) {
        select.value = currentValue;
      } else {
        select.value = '';
        reunioesChatFilterId = '';
      }
    }
    window.updateReunioesChatFilterOptions = updateReunioesChatFilterOptions;
    
    // Quando o usu√°rio muda o filtro
    function updateReunioesChatFilter() {
      const select = document.getElementById('reunioesChatFilter');
      reunioesChatFilterId = select?.value || '';
      
      // Atualizar placeholder do input
      const input = document.getElementById('reunioesChatInput');
      if (input) {
        if (reunioesChatFilterId) {
          const reuniao = REUNIOES.find(r => r.id === reunioesChatFilterId);
          const titulo = reuniao?.objetivo || 'reuni√£o selecionada';
          input.placeholder = `Pergunte sobre "${titulo}"...`;
        } else {
          input.placeholder = 'Pergunte sobre as reuni√µes...';
        }
      }
      
      console.log('üîç Filtro de reuni√£o:', reunioesChatFilterId || 'Todas');
    }
    window.updateReunioesChatFilter = updateReunioesChatFilter;
    
    function buildReunioesContext() {
      if (!REUNIOES || REUNIOES.length === 0) {
        return 'N√£o h√° reuni√µes registradas.';
      }
      
      // Filtrar reuni√µes se houver filtro selecionado
      let reunioesParaContexto = [...REUNIOES];
      
      if (reunioesChatFilterId) {
        reunioesParaContexto = REUNIOES.filter(r => r.id === reunioesChatFilterId);
        if (reunioesParaContexto.length === 0) {
          return 'Reuni√£o selecionada n√£o encontrada.';
        }
      }
      
      // Ordenar por data (mais recentes primeiro)
      const reunioesOrdenadas = reunioesParaContexto.sort((a, b) => {
        return new Date(b.data || 0) - new Date(a.data || 0);
      });
      
      // Construir contexto
      let contexto;
      if (reunioesChatFilterId) {
        const r = reunioesOrdenadas[0];
        const dataFormatada = r.data ? new Date(r.data + 'T00:00:00').toLocaleDateString('pt-BR') : 'Sem data';
        contexto = `REUNI√ÉO SELECIONADA: ${r.objetivo || 'Sem t√≠tulo'} (${dataFormatada})\n\n`;
        contexto += `TRANSCRI√á√ÉO COMPLETA:\n${r.transcricao || 'Sem transcri√ß√£o'}\n`;
        if (r.resumo) {
          contexto += `\nRESUMO GERADO:\n${r.resumo}\n`;
        }
      } else {
        contexto = `BANCO DE DADOS DE REUNI√ïES (${REUNIOES.length} reuni√µes):\n\n`;
        
        reunioesOrdenadas.forEach((r) => {
          const dataFormatada = r.data ? new Date(r.data + 'T00:00:00').toLocaleDateString('pt-BR') : 'Sem data';
          const titulo = r.objetivo || 'Sem t√≠tulo';
          contexto += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
          contexto += `üìÖ ${titulo} (${dataFormatada})\n`;
          contexto += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
          contexto += `TRANSCRI√á√ÉO COMPLETA:\n${r.transcricao || 'Sem transcri√ß√£o'}\n`;
          if (r.resumo) {
            contexto += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
            contexto += `RESUMO GERADO:\n${r.resumo}\n`;
          }
          contexto += `\n`;
        });
      }
      
      return contexto;
    }
    
    function renderReunioesChatMessage(role, content) {
      const messagesEl = document.getElementById('reunioesChatMessages');
      if (!messagesEl) return;
      
      // Remover welcome se existir
      const welcome = messagesEl.querySelector('.reunioes-chat-welcome');
      if (welcome) welcome.remove();
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `reunioes-chat-message ${role}`;
      
      const avatar = role === 'user' ? 'üë§' : 'ü§ñ';
      const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      
      let formattedContent;
      
      if (role === 'assistant') {
        // Para respostas da IA: dividir em blocos e adicionar bot√£o de copiar em cada um
        const blocks = content.split(/\n\n+/).filter(b => b.trim());
        
        formattedContent = blocks.map((block, idx) => {
          const blockId = `${messageId}_block_${idx}`;
          
          // Formatar o bloco
          let formatted = block
            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.+?)\*/g, '<em>$1</em>')
            .replace(/^- (.+)$/gm, '<li>$1</li>')
            .replace(/\n/g, '<br>');
          
          // Verificar se tem lista
          if (formatted.includes('<li>')) {
            formatted = formatted.replace(/(<li>.*)/s, '<ul>$1</ul>');
          }
          
          return `
            <div class="reunioes-chat-block" data-block-id="${blockId}" data-block-content="${encodeURIComponent(block)}">
              <div class="reunioes-chat-block-content">${formatted}</div>
              <button class="reunioes-chat-copy-line-btn" onclick="copyReunioesChatLine('${blockId}')" title="Copiar este trecho">üìã</button>
            </div>
          `;
        }).join('');
        
        // Bot√µes de copiar tudo no final
        formattedContent += `
          <div class="reunioes-chat-copy-all">
            <button class="reunioes-chat-copy-btn" onclick="copyReunioesChatMessage('${messageId}')" title="Copiar resposta completa em formato WhatsApp">
              üìã Copiar p/ WhatsApp
            </button>
            <button class="reunioes-chat-copy-btn" onclick="copyReunioesChatMessageTexto('${messageId}')" title="Copiar resposta completa em texto normal">
              üìÑ Copiar Texto
            </button>
          </div>
        `;
      } else {
        // Para mensagens do usu√°rio: formata√ß√£o simples
        formattedContent = content
          .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
          .replace(/\*(.+?)\*/g, '<em>$1</em>')
          .replace(/\n\n/g, '</p><p>')
          .replace(/\n/g, '<br>');
        formattedContent = '<p>' + formattedContent + '</p>';
      }
      
      messageDiv.innerHTML = `
        <div class="reunioes-chat-message-avatar">${avatar}</div>
        <div class="reunioes-chat-message-content">
          ${formattedContent}
        </div>
      `;
      
      // Armazenar conte√∫do original para copiar
      if (role === 'assistant') {
        messageDiv.dataset.messageId = messageId;
        messageDiv.dataset.originalContent = content;
      }
      
      messagesEl.appendChild(messageDiv);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
    
    // Converter texto para formato WhatsApp
    function convertToWhatsAppFormat(text) {
      if (!text) return '';
      
      let wpp = text
        // Remover markdown de c√≥digo
        .replace(/```[\s\S]*?```/g, (match) => match.replace(/```/g, ''))
        // Manter negrito **texto** ‚Üí *texto*
        .replace(/\*\*(.+?)\*\*/g, '*$1*')
        // Headers ### ‚Üí *T√çTULO*
        .replace(/^#{1,4}\s*(.+)$/gm, '*$1*')
        // Bullet points com h√≠fen
        .replace(/^[\s]*[-‚Ä¢]\s*/gm, '‚Ä¢ ')
        // Numera√ß√£o
        .replace(/^(\d+)\.\s+/gm, '$1. ')
        // Cita√ß√µes
        .replace(/^>\s*(.+)$/gm, '> $1')
        // Remover m√∫ltiplos espa√ßos
        .replace(/[ \t]+/g, ' ')
        // Limpar linhas
        .replace(/^\s+/gm, '')
        // Espa√ßamento antes de t√≠tulos com emoji
        .replace(/([^\n])\n(\*[üìãüìå‚úÖüìä‚ö†Ô∏èüí°‚ùìüìÖüíºüéØüë§‚û°Ô∏è])/g, '$1\n\n$2')
        // M√°ximo 2 quebras de linha
        .replace(/\n{3,}/g, '\n\n');
      
      return wpp.trim();
    }
    
    // Copiar mensagem do chat para WhatsApp
    function copyReunioesChatMessage(messageId) {
      const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
      if (!messageDiv) {
        mgToast('‚ùå Mensagem n√£o encontrada');
        return;
      }
      
      const originalContent = messageDiv.dataset.originalContent;
      if (!originalContent) {
        mgToast('‚ùå Conte√∫do n√£o dispon√≠vel');
        return;
      }
      
      const whatsappText = convertToWhatsAppFormat(originalContent);
      
      // Usar mgCopyToClipboard para suporte a iframe
      mgCopyToClipboard(whatsappText).then(success => {
        if (success) {
          mgToast('‚úÖ Copiado para WhatsApp!');
          
          // Feedback visual no bot√£o
          const btn = messageDiv.querySelector('.reunioes-chat-copy-btn');
          if (btn) {
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚úÖ Copiado!';
            btn.style.background = 'rgba(34, 197, 94, 0.2)';
            btn.style.borderColor = 'rgba(34, 197, 94, 0.5)';
            setTimeout(() => {
              btn.innerHTML = originalText;
              btn.style.background = '';
              btn.style.borderColor = '';
            }, 2000);
          }
        } else {
          mgToast('‚ùå Erro ao copiar');
        }
      });
    }
    window.copyReunioesChatMessage = copyReunioesChatMessage;
    
    // Copiar mensagem do chat em formato texto estruturado (Google Docs style)
    function copyReunioesChatMessageTexto(messageId) {
      const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
      if (!messageDiv) {
        mgToast('‚ùå Mensagem n√£o encontrada');
        return;
      }
      
      const originalContent = messageDiv.dataset.originalContent;
      if (!originalContent) {
        mgToast('‚ùå Conte√∫do n√£o dispon√≠vel');
        return;
      }
      
      // Converter para HTML formatado (Google Docs reconhece)
      const htmlFormatado = converterMarkdownParaHTML(originalContent);
      
      // Texto plano como fallback
      const textoPlano = converterParaFormatoEstruturado(originalContent);
      
      // Usar mgCopyFormattedToClipboard para copiar com formata√ß√£o HTML
      mgCopyFormattedToClipboard(htmlFormatado, textoPlano).then(success => {
        if (success) {
          mgToast('‚úÖ Texto copiado com formata√ß√£o!');
          
          // Feedback visual no bot√£o
          const buttons = messageDiv.querySelectorAll('.reunioes-chat-copy-btn');
          const btn = Array.from(buttons).find(b => b.textContent.includes('Texto'));
          if (btn) {
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚úÖ Copiado!';
            btn.style.background = 'rgba(34, 197, 94, 0.2)';
            btn.style.borderColor = 'rgba(34, 197, 94, 0.5)';
            setTimeout(() => {
              btn.innerHTML = originalText;
              btn.style.background = '';
              btn.style.borderColor = '';
            }, 2000);
          }
        } else {
          mgToast('‚ùå Erro ao copiar');
        }
      });
    }
    window.copyReunioesChatMessageTexto = copyReunioesChatMessageTexto;
    
    // Fun√ß√£o para copiar uma linha/bloco individual
    function copyReunioesChatLine(blockId) {
      const blockDiv = document.querySelector(`[data-block-id="${blockId}"]`);
      if (!blockDiv) {
        mgToast('‚ùå Trecho n√£o encontrado');
        return;
      }
      
      const blockContent = decodeURIComponent(blockDiv.dataset.blockContent || '');
      if (!blockContent) {
        mgToast('‚ùå Conte√∫do n√£o dispon√≠vel');
        return;
      }
      
      const whatsappText = convertToWhatsAppFormat(blockContent);
      
      // Usar mgCopyToClipboard para suporte a iframe
      mgCopyToClipboard(whatsappText).then(success => {
        if (success) {
          mgToast('‚úÖ Trecho copiado!');
          
          // Feedback visual no bot√£o
          const btn = blockDiv.querySelector('.reunioes-chat-copy-line-btn');
          if (btn) {
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚úÖ';
            btn.style.background = 'rgba(34, 197, 94, 0.3)';
            setTimeout(() => {
              btn.innerHTML = originalText;
              btn.style.background = '';
            }, 1500);
          }
        } else {
          mgToast('‚ùå Erro ao copiar');
        }
      });
    }
    window.copyReunioesChatLine = copyReunioesChatLine;
    
    function showReunioesChatLoading() {
      const messagesEl = document.getElementById('reunioesChatMessages');
      if (!messagesEl) return;
      
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'reunioes-chat-loading';
      loadingDiv.id = 'reunioesChatLoading';
      loadingDiv.innerHTML = `
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <span>Analisando reuni√µes...</span>
      `;
      messagesEl.appendChild(loadingDiv);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
    
    function hideReunioesChatLoading() {
      const loading = document.getElementById('reunioesChatLoading');
      if (loading) loading.remove();
    }
    
    async function sendReuniaoChat() {
      const input = document.getElementById('reunioesChatInput');
      const sendBtn = document.getElementById('reunioesChatSendBtn');
      
      const pergunta = input?.value?.trim();
      if (!pergunta) return;
      
      if (REUNIOES.length === 0) {
        mgToast('‚ö†Ô∏è Nenhuma reuni√£o registrada para consultar');
        return;
      }
      
      if (typeof window.callAIProxy !== 'function') {
        mgToast('‚ùå Servi√ßo de IA n√£o dispon√≠vel');
        return;
      }
      
      // Garantir que temos um ID de conversa
      if (!reunioesCurrentChatId) {
        reunioesCurrentChatId = 'chat_' + Date.now();
        console.log('üìù Novo chat criado:', reunioesCurrentChatId);
      }
      
      // Renderizar pergunta do usu√°rio
      renderReunioesChatMessage('user', pergunta);
      
      // Limpar input e desabilitar
      input.value = '';
      input.disabled = true;
      sendBtn.disabled = true;
      
      // Mostrar loading
      showReunioesChatLoading();
      
      try {
        const userId = auth?.currentUser?.uid || 'anonymous-' + Date.now();
        
        // Construir contexto com todas as transcri√ß√µes
        const contextoReunioes = buildReunioesContext();
        
        // Construir hist√≥rico de conversa (√∫ltimas 6 mensagens)
        const historicoRecente = reunioesChatHistory.slice(-6);
        
        // Construir prompt do sistema baseado no filtro
        let systemPrompt;
        if (reunioesChatFilterId) {
          const reuniaoFiltrada = REUNIOES.find(r => r.id === reunioesChatFilterId);
          const nomeReuniao = reuniaoFiltrada?.objetivo || 'Reuni√£o selecionada';
          systemPrompt = `Voc√™ √© um assistente especializado em analisar reuni√µes de neg√≥cios. 

O usu√°rio est√° consultando UMA REUNI√ÉO ESPEC√çFICA: "${nomeReuniao}"

Responda APENAS com base nas informa√ß√µes DESSA reuni√£o espec√≠fica fornecida abaixo.

REGRAS:
1. Baseie suas respostas EXCLUSIVAMENTE nas informa√ß√µes da reuni√£o fornecida
2. Seja objetivo e organize as respostas com bullet points quando apropriado
3. Use negrito para destacar pontos importantes
4. Se algo n√£o foi discutido nesta reuni√£o, diga claramente

${contextoReunioes}`;
        } else {
          systemPrompt = `Voc√™ √© um assistente especializado em analisar reuni√µes de neg√≥cios. 
            
Voc√™ tem acesso a um banco de dados com TODAS as transcri√ß√µes das reuni√µes registradas. Use essas informa√ß√µes para responder √†s perguntas do usu√°rio.

REGRAS:
1. Baseie suas respostas EXCLUSIVAMENTE nas informa√ß√µes das reuni√µes fornecidas
2. Cite datas e contextos espec√≠ficos quando poss√≠vel
3. Se a informa√ß√£o n√£o estiver nas reuni√µes, diga claramente
4. Seja objetivo e organize as respostas com bullet points quando apropriado
5. Use negrito para destacar pontos importantes
6. Ao referenciar reuni√µes, use APENAS o formato: **Nome da Reuni√£o (DD/MM/AAAA)** - N√ÉO use "Reuni√£o 1", "Reuni√£o 2", etc.

Exemplo correto: **Estrat√©gia de Redes Sociais (28/01/2026)**
Exemplo errado: Reuni√£o 1: Estrat√©gia de Redes Sociais

${contextoReunioes}`;
        }
        
        const messages = [
          {
            role: 'system',
            content: systemPrompt
          },
          ...historicoRecente,
          {
            role: 'user',
            content: pergunta
          }
        ];
        
        const data = await window.callAIProxy('google/gemini-2.5-flash', messages, userId, 2048, 0.3);
        const resposta = data?.choices?.[0]?.message?.content;
        
        hideReunioesChatLoading();
        
        if (resposta) {
          renderReunioesChatMessage('assistant', resposta);
          
          // Salvar no hist√≥rico
          reunioesChatHistory.push({ role: 'user', content: pergunta });
          reunioesChatHistory.push({ role: 'assistant', content: resposta });
          
          // Manter hist√≥rico limitado
          if (reunioesChatHistory.length > 40) {
            reunioesChatHistory = reunioesChatHistory.slice(-40);
          }
          
          // Salvar conversa automaticamente
          saveCurrentReuniaoChat();
        } else {
          renderReunioesChatMessage('assistant', 'Desculpe, n√£o consegui processar sua pergunta. Tente novamente.');
        }
        
      } catch (err) {
        console.error('Erro no chat de reuni√µes:', err);
        hideReunioesChatLoading();
        renderReunioesChatMessage('assistant', '‚ùå Erro ao processar sua pergunta. Verifique sua conex√£o e tente novamente.');
      } finally {
        input.disabled = false;
        sendBtn.disabled = false;
        input.focus();
      }
    }
    window.sendReuniaoChat = sendReuniaoChat;
    
    function askReuniaoSuggestion(pergunta) {
      const input = document.getElementById('reunioesChatInput');
      if (input) {
        input.value = pergunta;
        sendReuniaoChat();
      }
    }
    window.askReuniaoSuggestion = askReuniaoSuggestion;
    
    async function clearReunioesChatHistory() {
      // Salvar conversa atual antes de limpar
      await saveCurrentReuniaoChat();
      
      // Iniciar nova conversa
      await startNewReuniaoChat();
    }
    window.clearReunioesChatHistory = clearReunioesChatHistory;
    
    // Atualizar stats quando renderizar reuni√µes
    const originalRenderReunioes = window.renderReunioes;
    window.renderReunioes = function(skipLoad) {
      if (originalRenderReunioes) originalRenderReunioes(skipLoad);
      updateReunioesChatStats();
    };
    // ========== FIM CHAT IA REUNI√ïES ==========

    /* ========= FIM REUNI√ïES ========= */

    /* ========= Relat√≥rio ========= */
  let relatorioMesInput, relatorioGerarBtn, relatorioExportarBtn, relatorioPreview;
  let relatorioStoriesSection, relatorioStoriesGrid, relatorioStoriesPrev, relatorioStoriesNext, relatorioStoriesSubtitle;
  let relatorioPostsSection, relatorioPostsGrid, relatorioPostsPrev, relatorioPostsNext, relatorioPostsSubtitle;
  let relatorioGoalsSection, relatorioGoalsSubtitle, relatorioGoalsDonePill, relatorioGoalsProgressPill, relatorioGoalsTodoPill, relatorioGoalsClearFilter;
  let relatorioGoalsDone, relatorioGoalsProgress, relatorioGoalsTodo;
  let relatorioMetasSection, relatorioMetasSubtitle, relatorioMetasAchievedPill, relatorioMetasProgressPill, relatorioMetasMissingPill, relatorioMetasClearFilter;
  let relatorioMetasAchieved, relatorioMetasProgress, relatorioMetasMissing;
  let relatorioGoalsNotesSimple, relatorioGoalsNotesSimpleStatus;
  // Leads gerados
  let relatorioLeadsSection, relatorioLeadsSubtitle, relatorioLeadsCount, relatorioLeadsDesc;
  // Redes trabalhadas
  let relatorioRedesSection, relatorioRedesGrid, relatorioRedesDesc, relatorioRedesSubtitle;
  let relatorioStoriesDesc, relatorioPostsDesc, relatorioGoalsDesc, relatorioMetasDesc;
  // Resumo em texto
  let relatorioResumoTextoSection, relatorioResumoTextoContent, btnCopiarResumo;
  // An√°lise Estrat√©gica IA
  let relatorioAnaliseIASection, relatorioAnaliseIASubtitle, relatorioIAContexto, relatorioIADiagnostico;
  let relatorioIAPontosFortes, relatorioIAOportunidades, relatorioIARecomendacoes, relatorioIAPrompt;
  let btnCopiarPromptIA, relatorioAnaliseIADesc;
    
    function initRelatorio(){
      if(!relatorioMesInput){
        relatorioMesInput = $("relatorioMes");
        relatorioGerarBtn = $("relatorioGerar");
        relatorioExportarBtn = $("relatorioExportar");
        relatorioPreview = $("relatorioPreview");
        relatorioStoriesSection = $("relatorioStoriesSection");
        relatorioStoriesGrid = $("relatorioStoriesGrid");
        relatorioStoriesPrev = $("relatorioStoriesPrev");
        relatorioStoriesNext = $("relatorioStoriesNext");
        relatorioStoriesSubtitle = $("relatorioStoriesSubtitle");
    relatorioStoriesDesc = $("relatorioStoriesDesc");
  relatorioPostsSection = $("relatorioPostsSection");
  relatorioPostsGrid = $("relatorioPostsGrid");
  relatorioPostsPrev = $("relatorioPostsPrev");
  relatorioPostsNext = $("relatorioPostsNext");
  relatorioPostsSubtitle = $("relatorioPostsSubtitle");
  relatorioPostsDesc = $("relatorioPostsDesc");
  relatorioGoalsSection = $("relatorioGoalsSection");
  relatorioGoalsSubtitle = $("relatorioGoalsSubtitle");
  relatorioGoalsDonePill = $("relatorioGoalsDonePill");
  relatorioGoalsProgressPill = $("relatorioGoalsProgressPill");
  relatorioGoalsTodoPill = $("relatorioGoalsTodoPill");
  relatorioGoalsClearFilter = $("relatorioGoalsClearFilter");
  relatorioGoalsDone = $("relatorioGoalsDone");
  relatorioGoalsProgress = $("relatorioGoalsProgress");
  relatorioGoalsTodo = $("relatorioGoalsTodo");
  relatorioGoalsDesc = $("relatorioGoalsDesc");
  relatorioMetasSection = $("relatorioMetasSection");
  relatorioMetasSubtitle = $("relatorioMetasSubtitle");
  relatorioMetasAchievedPill = $("relatorioMetasAchievedPill");
  relatorioMetasProgressPill = $("relatorioMetasProgressPill");
  relatorioMetasMissingPill = $("relatorioMetasMissingPill");
  relatorioMetasClearFilter = $("relatorioMetasClearFilter");
  relatorioMetasAchieved = $("relatorioMetasAchieved");
  relatorioMetasProgress = $("relatorioMetasProgress");
  relatorioMetasMissing = $("relatorioMetasMissing");
  relatorioMetasDesc = $("relatorioMetasDesc");
  relatorioGoalsNotesSimple = $("relatorioGoalsNotesSimple");
  relatorioGoalsNotesSimpleStatus = $("relatorioGoalsNotesSimpleStatus");
  // Leads
  relatorioLeadsSection = $("relatorioLeadsSection");
  relatorioLeadsSubtitle = $("relatorioLeadsSubtitle");
  relatorioLeadsCount = $("relatorioLeadsCount");
  relatorioLeadsDesc = $("relatorioLeadsDesc");
  // Redes
  relatorioRedesSection = $("relatorioRedesSection");
  relatorioRedesGrid = $("relatorioRedesGrid");
  relatorioRedesDesc = $("relatorioRedesDesc");
  relatorioRedesSubtitle = $("relatorioRedesSubtitle");
  // Resumo em texto
  relatorioResumoTextoSection = $("relatorioResumoTextoSection");
  relatorioResumoTextoContent = $("relatorioResumoTextoContent");
  btnCopiarResumo = $("btnCopiarResumo");
  // An√°lise Estrat√©gica IA
  relatorioAnaliseIASection = $("relatorioAnaliseIASection");
  relatorioAnaliseIASubtitle = $("relatorioAnaliseIASubtitle");
  relatorioIAContexto = $("relatorioIAContexto");
  relatorioIADiagnostico = $("relatorioIADiagnostico");
  relatorioIAPontosFortes = $("relatorioIAPontosFortes");
  relatorioIAOportunidades = $("relatorioIAOportunidades");
  relatorioIARecomendacoes = $("relatorioIARecomendacoes");
  relatorioIAPrompt = $("relatorioIAPrompt");
  btnCopiarPromptIA = $("btnCopiarPromptIA");
  relatorioAnaliseIADesc = $("relatorioAnaliseIADesc");
  
        
        if(relatorioGerarBtn){
          relatorioGerarBtn.addEventListener('click', gerarRelatorio);
        }
        if(relatorioExportarBtn){
          relatorioExportarBtn.addEventListener('click', exportarRelatorioPDF);
        }
        if(relatorioMesInput){
          relatorioMesInput.addEventListener('change', onRelatorioMesChange);
        }
        if(relatorioStoriesPrev && relatorioStoriesGrid){
          relatorioStoriesPrev.addEventListener('click', ()=> relatorioStoriesGrid.scrollBy({left:-200, behavior:'smooth'}));
        }
        if(relatorioStoriesNext && relatorioStoriesGrid){
          relatorioStoriesNext.addEventListener('click', ()=> relatorioStoriesGrid.scrollBy({left:200, behavior:'smooth'}));
        }
        if(relatorioPostsPrev && relatorioPostsGrid){
          relatorioPostsPrev.addEventListener('click', ()=> relatorioPostsGrid.scrollBy({left:-200, behavior:'smooth'}));
        }
        if(relatorioPostsNext && relatorioPostsGrid){
          relatorioPostsNext.addEventListener('click', ()=> relatorioPostsGrid.scrollBy({left:200, behavior:'smooth'}));
        }
        if(relatorioGoalsDonePill){ relatorioGoalsDonePill.addEventListener('click', ()=> filterGoals('concluido')); }
        if(relatorioGoalsProgressPill){ relatorioGoalsProgressPill.addEventListener('click', ()=> filterGoals('em-andamento')); }
        if(relatorioGoalsTodoPill){ relatorioGoalsTodoPill.addEventListener('click', ()=> filterGoals('nao-iniciado')); }
        if(relatorioGoalsClearFilter){ relatorioGoalsClearFilter.addEventListener('click', ()=> filterGoals('')); }
        if(relatorioMetasAchievedPill){ relatorioMetasAchievedPill.addEventListener('click', ()=> filterMetas('concluido')); }
        if(relatorioMetasProgressPill){ relatorioMetasProgressPill.addEventListener('click', ()=> filterMetas('em-andamento')); }
        if(relatorioMetasMissingPill){ relatorioMetasMissingPill.addEventListener('click', ()=> filterMetas('nao-iniciado')); }
        if(relatorioMetasClearFilter){ relatorioMetasClearFilter.addEventListener('click', ()=> filterMetas('')); }
        if(relatorioGoalsNotesSimple){ relatorioGoalsNotesSimple.addEventListener('input', saveRelatorioGoalsNoteLocal); }
        // Captura dos elementos de Redes trabalhadas
        relatorioRedesSection = $("relatorioRedesSection");
        relatorioRedesGrid = $("relatorioRedesGrid");
        relatorioRedesDesc = $("relatorioRedesDesc");
        relatorioRedesSubtitle = $("relatorioRedesSubtitle");
        // Bot√£o copiar resumo
        if(btnCopiarResumo){
          btnCopiarResumo.addEventListener('click', copiarResumoTexto);
        }
        // Bot√£o copiar prompt IA
        if(btnCopiarPromptIA){
          btnCopiarPromptIA.addEventListener('click', copiarPromptIA);
        }
        
        // Bot√£o toggle hist√≥rico
        const toggleHistoryBtn = document.getElementById('toggleHistoryBtn');
        const historyTabs = document.getElementById('relatorioHistoryTabs');
        if(toggleHistoryBtn && historyTabs){
          let isVisible = true;
          toggleHistoryBtn.addEventListener('click', () => {
            isVisible = !isVisible;
            historyTabs.style.display = isVisible ? 'flex' : 'none';
          });
        }
        
        // Carregar lista de relat√≥rios salvos (com delay para garantir Firebase pronto)
        setTimeout(() => {
          loadSavedRelatorios().catch(err => {
            console.error('[Init Relatorio] Erro ao carregar relat√≥rios salvos:', err);
          });
        }, 500);
        
      }
    }
    
    function onRelatorioMesChange(){
      if(!relatorioMesInput || !relatorioMesInput.value) return;
      renderRelatorioStories(relatorioMesInput.value);
      renderRelatorioPosts(relatorioMesInput.value);
      renderRelatorioGoals(relatorioMesInput.value);
  renderRelatorioMetas(relatorioMesInput.value);
  loadRelatorioGoalsNoteLocal(relatorioMesInput.value);
  // Atualiza tamb√©m o bloco de redes trabalhadas (independente do m√™s, mas mant√©m consist√™ncia visual)
  renderRelatorioRedes(relatorioMesInput.value);
    }
    
  function renderRelatorioStories(mesISO){
      if(!relatorioStoriesGrid || !relatorioStoriesSection || !mesISO) return;
      
      const [ano, mes] = mesISO.split('-');
      const stories = POSTS.filter(p => {
        if((p.target || 'feed') !== 'stories') return false;
        if(!p.dateISO) return false;
        const [pAno, pMes] = p.dateISO.split('-');
        return pAno === ano && pMes === mes;
      });
      
      if(stories.length === 0){
        relatorioStoriesSection.style.display = 'none';
        return;
      }
      
      relatorioStoriesSection.style.display = 'block';
      
      const meses = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
      const mesNome = meses[parseInt(mes)-1] || mes;
      if(relatorioStoriesSubtitle){
        relatorioStoriesSubtitle.textContent = `${stories.length} ${stories.length===1?'story':'stories'} produzido${stories.length===1?'':'s'} em ${mesNome} de ${ano}`;
      }

      // Descri√ß√£o resumida abaixo do bloco
      if(relatorioStoriesDesc){
        const total = stories.length;
        const aprovados = stories.filter(p=> (p.status||'')==='aprovado').length;
        const revisar = stories.filter(p=> (p.status||'')==='revisar').length;
        const pendentes = Math.max(0, total - aprovados - revisar);
        const rate = total>0 ? Math.round((aprovados/total)*100) : 0;
        const diasMes = Math.max(1, new Date(parseInt(ano,10), parseInt(mes,10), 0).getDate());
        const mediaDia = (total/diasMes).toFixed(1);
        relatorioStoriesDesc.style.display = 'block';
        relatorioStoriesDesc.textContent = `‚ú® ${mesNome} de ${ano}: ${total} ${total===1?'story':'stories'} produzid${total===1?'o':'os'} ‚Ä¢ ${aprovados} aprovados (${rate}%), ${revisar} para revisar, ${pendentes} pendentes ‚Ä¢ Ritmo m√©dio: ${mediaDia}/dia. Excelente consist√™ncia de publica√ß√µes para refor√ßar a presen√ßa da marca.`;
      }
      
      stories.sort((a,b)=> (a.dateISO<b.dateISO?-1:a.dateISO>b.dateISO?1:0));
      
      relatorioStoriesGrid.innerHTML = stories.map(p=>{
        const firstMedia = p.mediaUrls?.[0] || "";
        const ext = firstMedia.split("?")[0].split(".").pop().toLowerCase();
        const isVideo = ["mp4","mov","webm","m4v","avi"].includes(ext);

        let cls = "relatorio-story-item";
        if(p.status === "aprovado"){
          cls += p.approvedBy === 'interno' ? " aprovado-interno" : " aprovado";
        }else if(p.status === "revisar"){
          cls += " revisar";
        }else{
          cls += " pendente";
        }
        if(isVideo) cls += " video";

        const [y,m,d] = (p.dateISO||'').split('-');
        const dateLabel = d && m ? `${d}/${m}` : '';

        // Se for v√≠deo e houver capa customizada (imagem), usa a capa
        const hasCustomCover = p.thumbUrl && !/\.(mp4|mov|webm|m4v|avi)(\?|$)/i.test(p.thumbUrl);
        if(isVideo){
          if(hasCustomCover){
            return `
              <div class="${cls}" data-id="${p.id}">
                <img src="${p.thumbUrl}" alt="Story ${dateLabel}" crossorigin="anonymous">
                <div class="relatorio-story-status"></div>
                <div class="relatorio-story-date">${dateLabel}</div>
              </div>
            `;
          }
          // Sen√£o, gera automaticamente a thumbnail via canvas
          if(firstMedia){
            return `
              <div class="${cls}" data-id="${p.id}" data-video-url="${firstMedia}">
                <span>V</span>
                <div class="relatorio-story-status"></div>
                <div class="relatorio-story-date">${dateLabel}</div>
              </div>
            `;
          }
        }
        // N√£o √© v√≠deo: usa a primeira m√≠dia dispon√≠vel (thumbUrl preferencial)
        const imgSrc = p.thumbUrl || firstMedia;
        if(imgSrc){
          return `
            <div class="${cls}" data-id="${p.id}">
              <img src="${imgSrc}" alt="Story ${dateLabel}" crossorigin="anonymous">
              <div class="relatorio-story-status"></div>
              <div class="relatorio-story-date">${dateLabel}</div>
            </div>
          `;
        }
        // Sem m√≠dia
        return `
          <div class="${cls}" data-id="${p.id}">
            <div class="relatorio-story-status"></div>
            <div class="relatorio-story-date">${dateLabel}</div>
          </div>
        `;
      }).join("");
      
      relatorioStoriesGrid.querySelectorAll('.relatorio-story-item').forEach(el=>{
        el.addEventListener('click', ()=>{
          const id = el.getAttribute('data-id');
          const post = POSTS.find(p=>p.id===id);
          if(post && typeof openPostModal === 'function') openPostModal(post);
        });
      });
      // Agendar gera√ß√£o das thumbnails de v√≠deo
      setTimeout(() => { try{ applyVideoThumbnails(); }catch(_e){ try{ window.applyVideoThumbnails && window.applyVideoThumbnails(); }catch(__){} } }, 120);
    }

    function renderRelatorioPosts(mesISO){
      if(!relatorioPostsGrid || !relatorioPostsSection || !mesISO) return;

      const [ano, mes] = mesISO.split('-');
      const posts = POSTS.filter(p => {
        if((p.target || 'feed') !== 'feed') return false;
        if(!p.dateISO) return false;
        const [pAno, pMes] = p.dateISO.split('-');
        return pAno === ano && pMes === mes;
      });

      if(posts.length === 0){
        relatorioPostsSection.style.display = 'none';
        return;
      }

      relatorioPostsSection.style.display = 'block';

      const meses = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
      const mesNome = meses[parseInt(mes)-1] || mes;
      if(relatorioPostsSubtitle){
        relatorioPostsSubtitle.textContent = `${posts.length} ${posts.length===1?'post':'posts'} produzido${posts.length===1?'':'s'} em ${mesNome} de ${ano}`;
      }

      // Descri√ß√£o resumida abaixo do bloco
      if(relatorioPostsDesc){
        const total = posts.length;
        const aprovados = posts.filter(p=> (p.status||'')==='aprovado').length;
        const revisar = posts.filter(p=> (p.status||'')==='revisar').length;
        const pendentes = Math.max(0, total - aprovados - revisar);
        const rate = total>0 ? Math.round((aprovados/total)*100) : 0;
        const diasMes = Math.max(1, new Date(parseInt(ano,10), parseInt(mes,10), 0).getDate());
        const mediaDia = (total/diasMes).toFixed(1);
        relatorioPostsDesc.style.display = 'block';
        relatorioPostsDesc.textContent = `‚ú® ${mesNome} de ${ano}: ${total} ${total===1?'post':'posts'} no feed ‚Ä¢ ${aprovados} aprovados (${rate}%), ${revisar} para revisar, ${pendentes} pendentes ‚Ä¢ Ritmo m√©dio: ${mediaDia}/dia. Conte√∫do consistente para ampliar alcance e engajamento.`;
      }

      posts.sort((a,b)=> (a.dateISO<b.dateISO?-1:a.dateISO>b.dateISO?1:0));

      relatorioPostsGrid.innerHTML = posts.map(p=>{
        const firstMedia = p.mediaUrls?.[0] || "";
        const ext = firstMedia.split("?")[0].split(".").pop().toLowerCase();
        const isVideo = ["mp4","mov","webm","m4v","avi"].includes(ext);

        let cls = "relatorio-story-item"; // reaproveita estilos
        if(p.status === "aprovado"){
          cls += p.approvedBy === 'interno' ? " aprovado-interno" : " aprovado";
        }else if(p.status === "revisar"){
          cls += " revisar";
        }else{
          cls += " pendente";
        }
        if(isVideo) cls += " video";

        const [y,m,d] = (p.dateISO||'').split('-');
        const dateLabel = d && m ? `${d}/${m}` : '';

        const hasCustomCover = p.thumbUrl && !/\.(mp4|mov|webm|m4v|avi)(\?|$)/i.test(p.thumbUrl);
        if(isVideo){
          if(hasCustomCover){
            return `
              <div class="${cls}" data-id="${p.id}">
                <img src="${p.thumbUrl}" alt="Post ${dateLabel}" crossorigin="anonymous">
                <div class="relatorio-story-status"></div>
                <div class="relatorio-story-date">${dateLabel}</div>
              </div>
            `;
          }
          if(firstMedia){
            return `
              <div class="${cls}" data-id="${p.id}" data-video-url="${firstMedia}">
                <span>V</span>
                <div class="relatorio-story-status"></div>
                <div class="relatorio-story-date">${dateLabel}</div>
              </div>
            `;
          }
        }
        const imgSrc = p.thumbUrl || firstMedia;
        if(imgSrc){
          return `
            <div class="${cls}" data-id="${p.id}">
              <img src="${imgSrc}" alt="Post ${dateLabel}" crossorigin="anonymous">
              <div class="relatorio-story-status"></div>
              <div class="relatorio-story-date">${dateLabel}</div>
            </div>
          `;
        }
        return `
          <div class="${cls}" data-id="${p.id}">
            <div class="relatorio-story-status"></div>
            <div class="relatorio-story-date">${dateLabel}</div>
          </div>
        `;
      }).join("");

      relatorioPostsGrid.querySelectorAll('.relatorio-story-item').forEach(el=>{
        el.addEventListener('click', ()=>{
          const id = el.getAttribute('data-id');
          const post = POSTS.find(p=>p.id===id);
          if(post && typeof openPostModal === 'function') openPostModal(post);
        });
      });
      // Agendar gera√ß√£o das thumbnails de v√≠deo
      setTimeout(() => { try{ applyVideoThumbnails(); }catch(_e){ try{ window.applyVideoThumbnails && window.applyVideoThumbnails(); }catch(__){} } }, 120);
    }

    function mapDemandaToStatusKey(status){
      const s = (status||'').toLowerCase();
      if(s === 'concluido' || s === 'concluido-grupo') return 'concluido';
      if(s === 'em-andamento' || s === 'bloqueado' || s === 'prioridade' || s==='prioridade-grupo') return 'em-andamento';
      return 'nao-iniciado';
    }

    let currentGoalsFilter = '';
    function filterGoals(key){
      currentGoalsFilter = (key||'');
      const cols = document.querySelectorAll('#relatorioGoalsColumns .goals-col');
      cols.forEach(col=>{
        const st = col.getAttribute('data-status');
        col.style.display = (!currentGoalsFilter || currentGoalsFilter===st) ? 'block':'none';
      });
    }

    function renderRelatorioGoals(mesISO){
      if(!relatorioGoalsSection) return;
      const [ano, mes] = (mesISO||'').split('-');
      const monthKey = `${ano}-${mes}`;
      const list = Array.isArray(DEMANDAS) ? DEMANDAS : [];
      const inMonth = list.filter(d=> {
        try{ return Array.isArray(getDemandMonthKeys(d)) && getDemandMonthKeys(d).includes(monthKey); }catch(_){ return false; }
      });
      // Sempre mostrar a se√ß√£o para exibir o bloco de notas, mesmo sem objetivos
      relatorioGoalsSection.style.display='block';

      const groups = { 'concluido':[], 'em-andamento':[], 'nao-iniciado':[] };
      inMonth.forEach(d=>{ groups[mapDemandaToStatusKey(d.status)].push(d); });

      const meses = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
      const mesNome = meses[(parseInt(mes)||1)-1] || mes;
      if(relatorioGoalsSubtitle){
        relatorioGoalsSubtitle.textContent = `Resumo de ${inMonth.length} objetivo${inMonth.length===1?'':'s'} em ${mesNome} de ${ano}`;
      }
  if(relatorioGoalsDonePill) relatorioGoalsDonePill.querySelector('strong').textContent = groups['concluido'].length;
  if(relatorioGoalsProgressPill) relatorioGoalsProgressPill.querySelector('strong').textContent = groups['em-andamento'].length;
  if(relatorioGoalsTodoPill) relatorioGoalsTodoPill.querySelector('strong').textContent = groups['nao-iniciado'].length;

      // Descri√ß√£o resumida abaixo do bloco
      if(relatorioGoalsDesc){
        const total = inMonth.length;
        const concl = groups['concluido'].length;
        const prog = groups['em-andamento'].length;
        const nao = groups['nao-iniciado'].length;
        const rate = total>0 ? Math.round((concl/total)*100) : 0;
        relatorioGoalsDesc.textContent = total>0
          ? `üöÄ ${mesNome} de ${ano}: ${total} objetivo${total===1?'':'s'} ‚Äî Conclu√≠dos: ${concl} (${rate}%), Em andamento: ${prog}, N√£o iniciados: ${nao}. Foco em entregas com impacto direto na percep√ß√£o da marca.`
          : `Sem objetivos cadastrados para ${mesNome} de ${ano}. Que tal definirmos 2‚Äì3 prioridades estrat√©gicas para o pr√≥ximo ciclo?`;
      }

      const renderCard = (d)=>{
        const title = (d.demanda||'').trim() || '(Sem t√≠tulo)';
        const resp = (d.responsavel||'').trim();
        const end = getDemandaEndDate(d);
        const date = end ? end.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'}) : '';
        const tag = (Array.isArray(d.tags) ? d.tags[0] : (d.tag||'')).toString();
        const statusKey = mapDemandaToStatusKey(d.status);
        const statusLabel = (STATUS_OPTIONS.find(o=>o.value===d.status)?.label) || '';
        return `<div class="goal-card ${statusKey}" data-id="${d.id||''}">
          <div class="goal-title">${escapeHtml(title)}</div>
          <div class="goal-meta">
            ${resp?`<span class="goal-tag">üë§ ${escapeHtml(resp)}</span>`:''}
            ${date?`<span class="goal-tag">üìÖ ${date}</span>`:''}
            ${statusLabel?`<span class="goal-tag">${escapeHtml(statusLabel)}</span>`:''}
            ${tag?`<span class="goal-tag">üè∑Ô∏è ${escapeHtml(tag)}</span>`:''}
          </div>
        </div>`;
      };

      if(relatorioGoalsDone) relatorioGoalsDone.innerHTML = groups['concluido'].sort((a,b)=> (getDemandaEndDate(a)?.getTime()||0)-(getDemandaEndDate(b)?.getTime()||0)).map(renderCard).join('');
      if(relatorioGoalsProgress) relatorioGoalsProgress.innerHTML = groups['em-andamento'].sort((a,b)=> (getDemandaEndDate(a)?.getTime()||0)-(getDemandaEndDate(b)?.getTime()||0)).map(renderCard).join('');
      if(relatorioGoalsTodo) relatorioGoalsTodo.innerHTML = groups['nao-iniciado'].sort((a,b)=> (getDemandaEndDate(a)?.getTime()||0)-(getDemandaEndDate(b)?.getTime()||0)).map(renderCard).join('');

      // Se n√£o houver objetivos no m√™s, mostrar mensagem de vazio, mantendo o bloco de notas vis√≠vel
      if(inMonth.length === 0){
        if(relatorioGoalsSubtitle){
          relatorioGoalsSubtitle.textContent = `Sem objetivos encontrados para ${mesNome} de ${ano}`;
        }
      }

      const bindClicks = (root)=>{
        if(!root) return; 
        root.querySelectorAll('.goal-card').forEach(el=>{
          if(el.dataset.bound==='1') return; el.dataset.bound='1';
          el.addEventListener('click', ()=>{ try{ setActiveTab('demandas'); }catch(_err){} });
        });
      };
      bindClicks(relatorioGoalsDone);
      bindClicks(relatorioGoalsProgress);
      bindClicks(relatorioGoalsTodo);

      filterGoals(currentGoalsFilter);
    }
    
    async function gerarRelatorio(){
      if(!relatorioMesInput || !relatorioMesInput.value){
        alert('Por favor, selecione um m√™s');
        return;
      }
      
      const mesISO = relatorioMesInput.value;
  renderRelatorioStories(mesISO);
  renderRelatorioPosts(mesISO);
  renderRelatorioGoals(mesISO);
  renderRelatorioMetas(mesISO);
  loadRelatorioGoalsNoteLocal(mesISO);
  await renderRelatorioLeads(mesISO); // Aguarda buscar leads do Firestore
  renderRelatorioRedes(mesISO);
  
  // Aguardar um momento para o DOM ser atualizado
  setTimeout(async () => {
    gerarResumoTexto(mesISO); // Gerar resumo em texto ap√≥s renderizar tudo
    gerarAnaliseEstrategicaIA(mesISO); // Gerar an√°lise estrat√©gica com IA
    
    // Salvar relat√≥rio no Firebase ap√≥s gerar
    await saveRelatorioToFirebase(mesISO);
    
    // Recarregar lista de relat√≥rios salvos
    await loadSavedRelatorios();
  }, 300);
  
      
      if(relatorioPreview){
        const [ano, mes] = mesISO.split('-');
        const meses = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
        const mesNome = meses[parseInt(mes)-1] || mes;
        relatorioPreview.classList.add('has-meta');
        relatorioPreview.innerHTML = `
          <div class="relatorio-preview-meta">
            <span class="meta-item">üìÖ ${mesNome} ${ano}</span>
            <span class="meta-sep">‚Ä¢</span>
            <span class="meta-item ok">‚úÖ Relat√≥rio gerado</span>
            <span class="meta-sep">‚Ä¢</span>
            <button id="copyRelatorioLinkBtn" type="button" class="btn ghost small" title="Copiar link do relat√≥rio para compartilhar">üîó Copiar link</button>
          </div>
        `;

        // bot√£o: copiar link do relat√≥rio (gera link p√∫blico por token)
        const btn = relatorioPreview.querySelector('#copyRelatorioLinkBtn');
        btn?.addEventListener('click', async ()=>{
          console.log('üîó [Bot√£o Copiar Link] Clicado! mesISO:', mesISO);
          let url = '';
          try{
            console.log('üîó [Bot√£o Copiar Link] Chamando createOrUpdateReportShare...');
            const token = await createOrUpdateReportShare(mesISO);
            console.log('üîó [Bot√£o Copiar Link] Token gerado:', token);
            url = buildRelatorioShareUrl(mesISO, token);
            console.log('üîó [Bot√£o Copiar Link] URL gerada:', url);
            
            // Usar fun√ß√£o robusta de clipboard com fallback para iframes
            const copiado = await mgCopyToClipboard(url);
            if(copiado){
              alert('Link do relat√≥rio copiado! (acesso p√∫blico)');
              console.log('üîó [Bot√£o Copiar Link] ‚úÖ Link copiado com sucesso!');
            } else {
              prompt('Copie o link do relat√≥rio:', url);
            }
          }catch(_err){
            console.error('üîó [Bot√£o Copiar Link] ‚ùå Erro:', _err);
            url = url || buildRelatorioShareUrl(mesISO);
            prompt('Copie o link do relat√≥rio:', url);
          }
        });
      }
    }

    // ========= SAVED REPORTS FUNCTIONS =========
    
    // Salva o relat√≥rio gerado no Firebase
    async function saveRelatorioToFirebase(mesISO){
      try{
        console.log('[Save Relatorio] Iniciando salvamento para:', mesISO);
        
        const uid = auth?.currentUser?.uid;
        const clientKey = getClientKeySafe();
        
        console.log('[Save Relatorio] UID:', uid, 'ClientKey:', clientKey);
        
        if(!uid || !clientKey){
          console.warn('[Save Relatorio] Usu√°rio n√£o autenticado ou cliente n√£o selecionado');
          return;
        }
        
        const [ano, mes] = mesISO.split('-');
        const meses = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
        const mesNome = meses[parseInt(mes)-1] || mes;
        
        console.log('[Save Relatorio] M√™s:', mesNome, 'Ano:', ano);
        
        // Helpers seguros para evitar ReferenceError quando vari√°veis globais n√£o existem
        const safeArray = (globalName) => {
          const val = typeof window !== 'undefined' ? window[globalName] : undefined;
          return Array.isArray(val) ? val : [];
        };
        const startsWithMonth = (item) => {
          if(!item || !item.dateISO || !mesISO) return false;
          return item.dateISO.startsWith(mesISO);
        };

        const storiesArr = safeArray('STORIES_CAROUSEL');
        const postsArr = safeArray('POSTS');
        const goalsArr = safeArray('GOALS');
        const metasArr = safeArray('META_SUBMISSIONS');

        // Coletar todos os dados do relat√≥rio atual
        const relatorioData = {
          mesISO,
          mesNome,
          ano,
          generatedAt: serverTimestamp(),
          // Dados das se√ß√µes (opcional - pode capturar HTML ou dados estruturados)
          storiesCount: storiesArr.filter(startsWithMonth).length,
          postsCount: postsArr.filter(startsWithMonth).length,
          goalsCount: goalsArr.length,
          metasCount: metasArr.length
        };
        
        console.log('[Save Relatorio] Dados a salvar:', relatorioData);
        
        // Salvar no Firestore: usuarios/{uid}/clients/{clientKey}/relatorios/{mesISO}
        const docRef = doc(db, 'usuarios', uid, 'clients', clientKey, 'relatorios', mesISO);
        await setDoc(docRef, relatorioData, { merge: true });
        
        console.log(`[Save Relatorio] ‚úÖ Relat√≥rio ${mesNome} ${ano} salvo com sucesso!`);
        
        if(typeof mgToast === 'function'){
          mgToast(`üìä Relat√≥rio de ${mesNome} ${ano} salvo!`);
        }
        
      }catch(err){
        console.error('[Save Relatorio] Erro ao salvar:', err);
      }
    }
    
    // Carrega a lista de relat√≥rios salvos do Firebase
    async function loadSavedRelatorios(){
      try{
        console.log('[Load Saved Relatorios] Iniciando...');
        
        const uid = auth?.currentUser?.uid;
        const clientKey = getClientKeySafe();
        
        console.log('[Load Saved Relatorios] UID:', uid, 'ClientKey:', clientKey);
        
        if(!uid || !clientKey){
          console.warn('[Load Saved Relatorios] Usu√°rio n√£o autenticado ou cliente n√£o selecionado');
          return;
        }
        
        const historyEl = document.getElementById('relatorioHistory');
        const tabsEl = document.getElementById('relatorioHistoryTabs');
        
        console.log('[Load Saved Relatorios] Elementos:', { historyEl, tabsEl });
        
        if(!historyEl || !tabsEl){
          console.error('[Load Saved Relatorios] Elementos HTML n√£o encontrados!');
          return;
        }
        
        // SEMPRE mostra a √°rea de hist√≥rico para debug
        historyEl.style.display = 'block';
        
        const relatoriosCol = collection(db, 'usuarios', uid, 'clients', clientKey, 'relatorios');
        const q = query(relatoriosCol, orderBy('generatedAt', 'desc'));
        
        console.log('[Load Saved Relatorios] Path:', `usuarios/${uid}/clients/${clientKey}/relatorios`);
        console.log('[Load Saved Relatorios] Buscando relat√≥rios...');
        
        const snapshot = await getDocs(q);
        
        console.log('[Load Saved Relatorios] Total encontrado:', snapshot.size);
        console.log('[Load Saved Relatorios] Docs:', snapshot.docs.map(d => ({id: d.id, data: d.data()})));
        
        if(!snapshot.empty){
          // Tem relat√≥rios salvos
          const tabs = snapshot.docs.map(doc => {
            const data = doc.data();
            console.log('[Load Saved Relatorios] Relat√≥rio:', data);
            return `
              <button type="button" class="relatorio-history-tab" data-mes-iso="${data.mesISO}">
                <span class="tab-date">${data.mesNome} ${data.ano}</span>
                <span class="tab-badge">Salvo</span>
              </button>
            `;
          }).join('');
          
          tabsEl.innerHTML = tabs;
          console.log('[Load Saved Relatorios] ‚úÖ Abas renderizadas:', snapshot.size);
          
          // Bind click events
          tabsEl.querySelectorAll('.relatorio-history-tab').forEach(tab => {
            tab.addEventListener('click', () => {
              const mesISO = tab.getAttribute('data-mes-iso');
              console.log('[Load Saved Relatorios] Abrindo relat√≥rio:', mesISO);
              openSavedRelatorio(mesISO);
            });
          });
          
        } else {
          // Sem relat√≥rios salvos - mostra mensagem
          console.log('[Load Saved Relatorios] Nenhum relat√≥rio salvo encontrado');
          tabsEl.innerHTML = '<p style="color: #94a3b8; font-size: 0.85rem; margin: 0;">Nenhum relat√≥rio salvo ainda. Gere um relat√≥rio para salv√°-lo automaticamente.</p>';
        }
        
      }catch(err){
        console.error('[Load Saved Relatorios] Erro:', err);
        console.error('[Load Saved Relatorios] Stack:', err.stack);
      }
    }
    
    // Abre um relat√≥rio salvo
    async function openSavedRelatorio(mesISO){
      if(!mesISO) return;
      
      // Define o m√™s no input
      if(relatorioMesInput){
        relatorioMesInput.value = mesISO;
      }
      
      // Gera o relat√≥rio (vai buscar os dados e renderizar)
      await gerarRelatorio();
      
      // Scroll suave para o topo do relat√≥rio
      const relatorioPreview = document.getElementById('relatorioPreview');
      if(relatorioPreview){
        relatorioPreview.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    let currentMetasFilter = '';
    function filterMetas(key){
      currentMetasFilter = (key||'');
      const cols = document.querySelectorAll('#relatorioMetasColumns .goals-col');
      cols.forEach(col=>{
        const st = col.getAttribute('data-status');
        col.style.display = (!currentMetasFilter || currentMetasFilter===st) ? 'block':'none';
      });
    }

    function getMetaMonthKeyFromISO(mesISO){
      if(!mesISO) return META_MONTHS[new Date().getMonth()];
      const parts = mesISO.split('-');
      if(parts.length<2) return META_MONTHS[new Date().getMonth()];
      const idx = Math.min(Math.max(parseInt(parts[1],10)-1,0),11);
      return META_MONTHS[idx];
    }

    // Gera a URL compartilh√°vel do relat√≥rio para o m√™s selecionado
    // Se token for informado, gera link p√∫blico (?share=token)
    function buildRelatorioShareUrl(mesISO, token){
      try{
        const pageUrl = new URL('relatorio.html', location.href);
        const mes = (mesISO && mesISO.length>=7) ? mesISO : (relatorioMesInput?.value || new Date().toISOString().slice(0,7));
        const tenant = getClientKey();
        if(token){
          pageUrl.searchParams.set('share', token);
          // extras amig√°veis (n√£o usados para auth, s√≥ r√≥tulo)
          if(tenant){ pageUrl.searchParams.set('tenant', tenant); }
          pageUrl.searchParams.set('mes', mes);
        } else {
          if(tenant){ pageUrl.searchParams.set('tenant', tenant); }
          pageUrl.searchParams.set('mes', mes);
        }
        return pageUrl.toString();
      }catch(_){
        // Fallback simples
        const base = location.origin + location.pathname.replace(/index\.html?$/i,'');
        const mes = encodeURIComponent((mesISO && mesISO.length>=7) ? mesISO : (relatorioMesInput?.value || new Date().toISOString().slice(0,7)));
        const tenant = encodeURIComponent(getClientKey()||'');
        return token
          ? `${base}relatorio.html?share=${encodeURIComponent(token)}&tenant=${tenant}&mes=${mes}`
          : `${base}relatorio.html?tenant=${tenant}&mes=${mes}`;
      }
    }

    // Monta snapshot dos dados do relat√≥rio do m√™s (para link p√∫blico)
    async function buildMonthlyReportData(mesISO){
      console.log('[buildMonthlyReportData] Iniciando - mesISO:', mesISO);
      const clientKey = getClientKey();
      console.log('[buildMonthlyReportData] clientKey:', clientKey);
      
      const [ano, mm] = (mesISO||'').split('-');
      const labelMonth = (()=>{
        const meses = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
        const idx = Math.max(0, Math.min(11, (parseInt(mm,10)||1)-1));
        return `${meses[idx]} ${ano||''}`.trim();
      })();
      console.log('[buildMonthlyReportData] labelMonth:', labelMonth);
      
      // metas
      const monthKey = getMetaMonthKeyFromISO(mesISO);
      const metasActive = Array.isArray(METAS) ? METAS.filter(m=>m && m.ativo!==false) : [];
      const metas = metasActive.map(m=>{
        const cur = (m.meses && m.meses[monthKey]) || {p:'',r:''};
        const planned = normalizeMetaNumber(cur.p ?? cur.P);
        const realized = normalizeMetaNumber(cur.r ?? cur.R);
        const status = evaluateMetaGoal(planned, realized, m.direcao);
        return {
          descricao: (m.descricao||'').toString(),
          unidade: m.unidade||'',
          direcao: m.direcao||'up',
          planned, realized, status
        };
      });
      console.log('[buildMonthlyReportData] Metas preparadas:', metas.length);
      
      // posts
      const tenant = clientKey;
      console.log('[buildMonthlyReportData] Total de POSTS:', Array.isArray(POSTS) ? POSTS.length : 0);
      
      let relevantPosts = filterPostsByClient(Array.isArray(POSTS)?POSTS:[], tenant)
        .filter(p=> String(p.dateISO||'').startsWith(mesISO))
        .sort((a,b)=> String(a.dateISO||'').localeCompare(String(b.dateISO||'')));

      // Se n√£o temos posts em mem√≥ria (por exemplo, usu√°rio n√£o abriu a aba de Posts), buscar direto do Firestore
      if(relevantPosts.length === 0) {
        try {
          console.log('[buildMonthlyReportData] POSTS vazios em mem√≥ria, buscando do Firestore...');
          const uid = auth?.currentUser?.uid;
          if(uid) {
            const snap = await getDocs(collection(db, 'usuarios', uid, 'posts'));
            const all = snap.docs.map(d => ({ id: d.id, ...(d.data()||{}) }));
            console.log('[buildMonthlyReportData] Posts no Firestore:', all.length);
            const filteredByTenant = filterPostsByClient(all, tenant);
            relevantPosts = filteredByTenant
              .filter(p=> String(p.dateISO||'').startsWith(mesISO))
              .sort((a,b)=> String(a.dateISO||'').localeCompare(String(b.dateISO||'')));
            console.log('[buildMonthlyReportData] Posts relevantes ap√≥s Firestore:', relevantPosts.length);
          } else {
            console.warn('[buildMonthlyReportData] Sem uid para buscar posts do Firestore');
          }
        } catch(err) {
          console.error('[buildMonthlyReportData] Erro ao buscar posts do Firestore:', err);
        }
      }
      
      console.log('[buildMonthlyReportData] Posts relevantes (ap√≥s filtro):', relevantPosts.length);
      console.log('[buildMonthlyReportData] Stories:', relevantPosts.filter(p => p.target === 'stories').length);
      console.log('[buildMonthlyReportData] Feed:', relevantPosts.filter(p => (p.target||'feed') === 'feed').length);
      
      if(relevantPosts.length > 0){
        console.log('[buildMonthlyReportData] Primeiro post relevante:', {
          id: relevantPosts[0].id,
          dateISO: relevantPosts[0].dateISO,
          target: relevantPosts[0].target,
          tenant: relevantPosts[0].tenant,
          thumbUrl: relevantPosts[0].thumbUrl?.substring(0, 50) + '...'
        });
      }
      
      const posts = relevantPosts.map(p=>({
        id: p.id||'',
        dateISO: p.dateISO||'',
        type: p.type||'',
        target: (p.target||'feed'),
        desc: p.desc||'',
        status: p.status||'',
        approvedBy: p.approvedBy||'',
        thumbUrl: p.thumbUrl||'',
        mediaUrls: Array.isArray(p.mediaUrls) ? p.mediaUrls.slice(0, 4) : []
      }));
      
      console.log('[buildMonthlyReportData] Posts mapeados para payload:', posts.length);
      // objetivos do m√™s (Planejamento)
      let goals = null;
      try{
        const [ano, mm2] = (mesISO||'').split('-');
        const monthKey = `${ano}-${mm2}`;
        const list = Array.isArray(DEMANDAS) ? DEMANDAS : [];
        const inMonth = list.filter(d=>{
          try{ return Array.isArray(getDemandMonthKeys(d)) && getDemandMonthKeys(d).includes(monthKey); }catch(_){ return false; }
        });
        const groups = { 'concluido':[], 'em-andamento':[], 'nao-iniciado':[] };
        inMonth.forEach(d=>{ const key = (typeof mapDemandaToStatusKey==='function') ? mapDemandaToStatusKey(d.status) : ((d.status||'').toLowerCase()==='concluido'?'concluido':((d.status||'').toLowerCase()==='em-andamento'?'em-andamento':'nao-iniciado')); groups[key].push(d); });
        const toItem = (d)=>{
          const endDate = (function(){ try{ const dt = getDemandaEndDate(d); if(dt && !isNaN(dt)) return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`; }catch(_){ } return ''; })();
          const tag = Array.isArray(d.tags) ? (d.tags[0]||'') : (d.tag||'');
          return { id: d.id||'', title: (d.demanda||'').toString(), responsavel: d.responsavel||'', status: d.status||'', tag: tag||'', endDate };
        };
        goals = {
          summary: {
            total: inMonth.length,
            done: groups['concluido'].length,
            progress: groups['em-andamento'].length,
            todo: groups['nao-iniciado'].length
          },
          items: inMonth.map(toItem)
        };
      }catch(_){ goals = null; }
      // notes
      const notes = [];
      try{
        const map = CAL_NOTES && typeof CAL_NOTES==='object' ? CAL_NOTES : {};
        Object.keys(map).forEach(k=>{ if(String(k).startsWith(mesISO)){ const txt = map[k]; if(txt){ notes.push({ id:k, text: String(txt) }); } }});
        notes.sort((a,b)=> String(a.id).localeCompare(String(b.id)));
      }catch(_){ }
      // social links + snapshot dos √≠cones exibidos no header
      const linksObj = (typeof SOCIAL_LINKS==='object' && SOCIAL_LINKS) ? SOCIAL_LINKS : {};
      const socialLinks = Object.fromEntries(Object.entries(linksObj).filter(([,v])=> !!v));
      let social = [];
      try{
        if(typeof collectHeaderSocialItems === 'function'){
          const items = collectHeaderSocialItems();
          social = (Array.isArray(items)?items:[])
            .filter(i=> i && i.hasLink && i.href)
            .map(i=> ({ label: i.label||'', href: i.href||'', iconInfo: i.iconInfo||null }));
        }
      }catch(_err){ /* fallback para socialLinks */ }
      
      // Buscar leads diretamente do Firestore (n√£o depende de vari√°vel global)
      let leadsCount = 0;
      let leadsData = [];
      let leadsAnalysis = null;
      try{
        console.log('[buildMonthlyReportData] Buscando leads do Firestore...');
        const uid = auth?.currentUser?.uid;
        const clientKey = tenant;
        
        if(uid && clientKey) {
          const leadsSnap = await getDocs(collection(db, 'usuarios', uid, 'clients', clientKey, 'leads'));
          const allLeads = leadsSnap.docs.map(d => ({ id: d.id, ...(d.data() || {}) }));
          console.log('[buildMonthlyReportData] Total de leads no Firestore:', allLeads.length);
          
          const filteredLeads = allLeads.filter(lead => {
            if(!lead.createdAt) return false;
            
            // Converter createdAt para data
            let leadDate;
            if(typeof lead.createdAt.toMillis === 'function'){
              leadDate = new Date(lead.createdAt.toMillis());
            } else if(typeof lead.createdAt === 'number'){
              leadDate = new Date(lead.createdAt);
            } else if(typeof lead.createdAt.toDate === 'function'){
              leadDate = lead.createdAt.toDate();
            } else if(lead.createdAt.seconds) {
              leadDate = new Date(lead.createdAt.seconds * 1000);
            } else {
              return false;
            }
            
            // Formatar data no formato YYYY-MM
            const year = leadDate.getFullYear();
            const month = String(leadDate.getMonth() + 1).padStart(2, '0');
            const leadMonthISO = `${year}-${month}`;
            
            return leadMonthISO === mesISO;
          });
          
          leadsCount = filteredLeads.length;
          
          // Mapear dados dos leads para o payload
          leadsData = filteredLeads.map(lead => ({
            name: lead.name || '',
            email: lead.email || '',
            phone: lead.phone || '',
            question: lead.question || '',
            plataforma: lead.plataforma || 'N√£o especificado',
            source: lead.source || 'N√£o especificado'
          }));
          
          console.log('[buildMonthlyReportData] ‚úÖ Leads filtrados para', mesISO, ':', leadsCount);
          console.log('[buildMonthlyReportData] ‚úÖ Dados dos leads:', leadsData.length, 'leads com detalhes');
          if(leadsData.length > 0) {
            console.log('[buildMonthlyReportData] ‚úÖ Exemplo do primeiro lead:', leadsData[0]);
          }
          
          // An√°lise dos leads para incluir no payload
          const platformStats = {};
          const sourceStats = {};
          const questionStats = {};
          
          leadsData.forEach(lead => {
            // Plataformas
            const platform = (lead.plataforma || 'N√£o especificado').toString().trim();
            platformStats[platform] = (platformStats[platform] || 0) + 1;
            
            // Fontes
            const source = (lead.source || 'N√£o especificado').toString().trim();
            sourceStats[source] = (sourceStats[source] || 0) + 1;
            
            // Perguntas
            const question = (lead.question || '').toString().trim();
            if(question && question.length > 0) {
              questionStats[question] = (questionStats[question] || 0) + 1;
            }
          });
          
          // Formatar an√°lise para o payload
          leadsAnalysis = {
            platforms: Object.entries(platformStats)
              .sort((a, b) => b[1] - a[1])
              .map(([name, count]) => ({
                name,
                count,
                percent: Math.round((count / leadsCount) * 100),
                emoji: name.toLowerCase().includes('google') ? 'üîç' : 
                       name.toLowerCase().includes('meta') ? 'üìò' : 'üì±'
              })),
            sources: Object.entries(sourceStats)
              .sort((a, b) => b[1] - a[1])
              .map(([name, count]) => ({
                name,
                count,
                percent: Math.round((count / leadsCount) * 100),
                emoji: 'üåê'
              })),
            topQuestions: Object.entries(questionStats)
              .sort((a, b) => b[1] - a[1])
              .slice(0, 5)
              .map(([question, count]) => ({
                question,
                count,
                percent: Math.round((count / leadsCount) * 100)
              }))
          };
          
          console.log('[buildMonthlyReportData] ‚úÖ An√°lise dos leads preparada:', {
            platforms: leadsAnalysis.platforms.length,
            sources: leadsAnalysis.sources.length,
            topQuestions: leadsAnalysis.topQuestions.length
          });
        } else {
          console.warn('[buildMonthlyReportData] ‚ö†Ô∏è N√£o foi poss√≠vel buscar leads - uid:', uid, 'clientKey:', clientKey);
        }
      }catch(err){
        console.error('[buildMonthlyReportData] ‚ùå Erro ao buscar leads do Firestore:', err);
      }
      
      return { monthKey: mesISO, labelMonth, tenant, metas, posts, notes, socialLinks, social, goals, leadsCount, leadsData, leadsAnalysis };
    }

    // Cria/atualiza um documento de compartilhamento p√∫blico e retorna o token
    async function createOrUpdateReportShare(mesISO){
      console.log('[createOrUpdateReportShare] Iniciando - mesISO:', mesISO);
      await requireAuthUser();
      const uid = getUserKey();
      if(!uid) throw new Error('Usu√°rio n√£o autenticado');
      console.log('[createOrUpdateReportShare] uid:', uid);
      
      const data = await buildMonthlyReportData(mesISO);
      console.log('[createOrUpdateReportShare] Data gerado:', {
        monthKey: data.monthKey,
        tenant: data.tenant,
        postsCount: Array.isArray(data.posts) ? data.posts.length : 0,
        storiesCount: Array.isArray(data.posts) ? data.posts.filter(p => p.target === 'stories').length : 0,
        feedCount: Array.isArray(data.posts) ? data.posts.filter(p => (p.target||'feed') === 'feed').length : 0,
        metasCount: Array.isArray(data.metas) ? data.metas.length : 0,
        leadsCount: data.leadsCount || 0,
        leadsDataCount: Array.isArray(data.leadsData) ? data.leadsData.length : 0
      });
      
      console.log('[createOrUpdateReportShare] leadsData preview:', Array.isArray(data.leadsData) && data.leadsData.length > 0 ? data.leadsData[0] : 'nenhum lead');
      
      // token aleat√≥rio (curto) base36
      const token = (Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2)).slice(0,20);
      const payload = {
        token,
        uid,
        monthKey: data.monthKey,
        tenant: data.tenant || null,
        createdAt: Date.now(),
        payload: data
      };
      
      console.log('[createOrUpdateReportShare] Payload a ser salvo:', {
        token,
        monthKey: payload.monthKey,
        tenant: payload.tenant,
        payloadPostsCount: Array.isArray(payload.payload?.posts) ? payload.payload.posts.length : 0,
        payloadLeadsCount: payload.payload?.leadsCount || 0,
        payloadLeadsDataCount: Array.isArray(payload.payload?.leadsData) ? payload.payload.leadsData.length : 0
      });
      
      try{
        const ref = doc(db, 'reportShares', token);
        console.log('[createOrUpdateReportShare] Salvando no Firestore - collection: reportShares, doc:', token);
        await setDoc(ref, payload);
        console.log('[createOrUpdateReportShare] ‚úÖ Salvo com sucesso!');
      }catch(err){ 
        console.error('[createOrUpdateReportShare] ‚ùå Erro ao salvar:', err); 
        throw err; 
      }
      return token;
    }

    // Notas simples locais (Objetivos do m√™s)
    function getClientKeyLocal(){
      return (typeof window.TENANT === 'string' && window.TENANT) || document.body.getAttribute('data-client-id') || 'default';
    }
    function goalsNoteKey(mesISO){
      const id = (mesISO && mesISO.length>=7) ? mesISO : (new Date().toISOString().slice(0,7));
      return `relatorio_goals_note_${getClientKeyLocal()}_${id}`;
    }
    function loadRelatorioGoalsNoteLocal(mesISO){
      try{
        if(!relatorioGoalsNotesSimple) return;
        const key = goalsNoteKey(mesISO);
        const saved = localStorage.getItem(key) || '';
        relatorioGoalsNotesSimple.value = saved;
        if(relatorioGoalsNotesSimpleStatus){
          relatorioGoalsNotesSimpleStatus.textContent = saved ? 'Auto-salvo neste navegador.' : '';
        }
      }catch(_err){}
    }
    function saveRelatorioGoalsNoteLocal(){
      try{
        if(!relatorioMesInput || !relatorioMesInput.value || !relatorioGoalsNotesSimple) return;
        const key = goalsNoteKey(relatorioMesInput.value);
        localStorage.setItem(key, relatorioGoalsNotesSimple.value || '');
        if(relatorioGoalsNotesSimpleStatus){
          const now = new Date();
          const hora = now.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
          relatorioGoalsNotesSimpleStatus.textContent = `Auto-salvo √†s ${hora}`;
        }
      }catch(_err){}
    }

    function renderRelatorioMetas(mesISO){
      if(!relatorioMetasSection) return;
      const monthKey = getMetaMonthKeyFromISO(mesISO);
      const activeMetas = Array.isArray(METAS) ? METAS.filter(meta => meta && meta.ativo !== false) : [];
      const groups = { achieved:[], progress:[], missing:[] };
      activeMetas.forEach(meta=>{
        const current = (meta.meses && meta.meses[monthKey]) || {p:'',r:''};
        const planned = normalizeMetaNumber(current.p ?? current.P);
        const realized = normalizeMetaNumber(current.r ?? current.R);
        const status = evaluateMetaGoal(planned, realized, meta.direcao);
        if(status === 'achieved') groups.achieved.push({meta, planned, realized});
        else if(status === 'missing') groups.missing.push({meta, planned, realized});
        else groups.progress.push({meta, planned, realized});
      });

      const total = activeMetas.length;
      if(total === 0){ relatorioMetasSection.style.display='none'; return; }
      relatorioMetasSection.style.display='block';

      const labelMonth = META_MONTH_LABELS[monthKey] || monthKey.toUpperCase();
      if(relatorioMetasSubtitle){ relatorioMetasSubtitle.textContent = `Metas ativas: ${total} ‚Ä¢ ${labelMonth}`; }
      if(relatorioMetasAchievedPill) relatorioMetasAchievedPill.querySelector('strong').textContent = groups.achieved.length;
      if(relatorioMetasProgressPill) relatorioMetasProgressPill.querySelector('strong').textContent = groups.progress.length;
      if(relatorioMetasMissingPill) relatorioMetasMissingPill.querySelector('strong').textContent = groups.missing.length;

      // Descri√ß√£o resumida abaixo do bloco
      if(relatorioMetasDesc){
        const a = groups.achieved.length, p = groups.progress.length, m = groups.missing.length;
        const rate = total>0 ? Math.round((a/total)*100) : 0;
        relatorioMetasDesc.textContent = `üéØ ${labelMonth}: ${total} meta${total===1?'':'s'} ativa${total===1?'':'s'} ‚Äî Atingidas: ${a} (${rate}%), Em andamento: ${p}, Precisa colocar: ${m}. Excelente sinal de alinhamento entre planejamento e execu√ß√£o.`;
      }

      const renderMetaCard = (item)=>{
        const m = item.meta;
        const title = (m.descricao||'').trim() || '(Meta sem t√≠tulo)';
        const unidade = m.unidade || '';
        const plannedLabel = formatMetaDisplay(item.planned, unidade);
        const realizedLabel = formatMetaDisplay(item.realized, unidade);
        return `<div class="goal-card" data-id="${m.id}">
          <div class="goal-title">${escapeHtml(title)}</div>
          <div class="goal-meta">
            <span class="goal-tag">üéØ Meta: ${escapeHtml(plannedLabel)}</span>
            <span class="goal-tag">üìà Realizado: ${escapeHtml(realizedLabel)}</span>
            ${m.setor?`<span class="goal-tag">üè¢ ${escapeHtml(m.setor)}</span>`:''}
          </div>
        </div>`;
      };

      if(relatorioMetasAchieved) relatorioMetasAchieved.innerHTML = groups.achieved.map(renderMetaCard).join('');
      if(relatorioMetasProgress) relatorioMetasProgress.innerHTML = groups.progress.map(renderMetaCard).join('');
      if(relatorioMetasMissing) relatorioMetasMissing.innerHTML = groups.missing.map(renderMetaCard).join('');

      const bindClicks = (root)=>{
        if(!root) return; 
        root.querySelectorAll('.goal-card').forEach(el=>{
          if(el.dataset.bound==='1') return; el.dataset.bound='1';
          el.addEventListener('click', ()=>{ try{ setActiveTab('metas'); }catch(_err){} });
        });
      };
      bindClicks(relatorioMetasAchieved);
      bindClicks(relatorioMetasProgress);
      bindClicks(relatorioMetasMissing);

      filterMetas(currentMetasFilter);
    }
    
    // Relat√≥rio: Leads Gerados no M√™s (com an√°lise completa)
    async function renderRelatorioLeads(mesISO){
      const leadsSection = document.getElementById('relatorioLeadsSection');
      const leadsSubtitle = document.getElementById('relatorioLeadsSubtitle');
      const leadsCount = document.getElementById('relatorioLeadsCount');
      const leadsDesc = document.getElementById('relatorioLeadsDesc');
      const leadsAnalysis = document.getElementById('relatorioLeadsAnalysis');
      const leadsPlatforms = document.getElementById('relatorioLeadsPlatforms');
      const leadsSources = document.getElementById('relatorioLeadsSources');
      const leadsQuestions = document.getElementById('relatorioLeadsQuestions');
      const leadsAIAnalysis = document.getElementById('relatorioLeadsAIAnalysis');
      
      if(!leadsSection || !mesISO) {
        if(leadsSection) leadsSection.style.display = 'none';
        return;
      }
      
      console.log('[renderRelatorioLeads] Iniciando para m√™s:', mesISO);
      
      // Buscar leads do Firestore
      let leadsList = [];
      try {
        const uid = auth?.currentUser?.uid;
        const clientKey = getClientKeySafe();
        
        if(!uid || !clientKey) {
          console.warn('[renderRelatorioLeads] Usu√°rio ou cliente n√£o encontrado');
          leadsSection.style.display = 'none';
          return;
        }
        
        console.log('[renderRelatorioLeads] Buscando leads - uid:', uid, 'clientKey:', clientKey);
        
        // Buscar todos os leads do cliente
        const leadsSnap = await getDocs(collection(db, 'usuarios', uid, 'clients', clientKey, 'leads'));
        leadsList = leadsSnap.docs.map(d => ({ id: d.id, ...(d.data() || {}) }));
        
        console.log('[renderRelatorioLeads] Total de leads encontrados no Firestore:', leadsList.length);
        
        if(leadsList.length > 0) {
          console.log('[renderRelatorioLeads] Primeiro lead (exemplo):', {
            id: leadsList[0].id,
            name: leadsList[0].name,
            plataforma: leadsList[0].plataforma,
            source: leadsList[0].source,
            question: leadsList[0].question,
            createdAt: leadsList[0].createdAt,
            createdAtType: typeof leadsList[0].createdAt
          });
        }
      } catch(err) {
        console.error('[renderRelatorioLeads] Erro ao buscar leads do Firestore:', err);
        leadsSection.style.display = 'none';
        return;
      }
      
      // Filtrar leads do m√™s pela coluna "Quando" (createdAt)
      const filteredLeads = leadsList.filter(lead => {
        if(!lead.createdAt) {
          console.log('[renderRelatorioLeads] Lead sem createdAt:', lead.id);
          return false;
        }
        
        // Converter createdAt para data
        let leadDate;
        try {
          if(typeof lead.createdAt.toMillis === 'function'){
            leadDate = new Date(lead.createdAt.toMillis());
          } else if(typeof lead.createdAt === 'number'){
            leadDate = new Date(lead.createdAt);
          } else if(typeof lead.createdAt.toDate === 'function'){
            leadDate = lead.createdAt.toDate();
          } else if(lead.createdAt.seconds) {
            // Firestore Timestamp com seconds
            leadDate = new Date(lead.createdAt.seconds * 1000);
          } else {
            console.warn('[renderRelatorioLeads] Formato de createdAt n√£o reconhecido:', lead.createdAt);
            return false;
          }
          
          // Formatar data no formato YYYY-MM
          const year = leadDate.getFullYear();
          const month = String(leadDate.getMonth() + 1).padStart(2, '0');
          const leadMonthISO = `${year}-${month}`;
          
          const match = leadMonthISO === mesISO;
          
          if(match) {
            console.log('[renderRelatorioLeads] ‚úÖ Lead do m√™s:', lead.name, 'criado em:', leadDate.toLocaleDateString('pt-BR'));
          }
          
          return match;
        } catch(err) {
          console.warn('[renderRelatorioLeads] Erro ao processar lead:', lead.id, err);
          return false;
        }
      });
      
      const leadCount = filteredLeads.length;
      console.log('[renderRelatorioLeads] ‚úÖ Leads filtrados para', mesISO, ':', leadCount);
      
      // Sempre mostrar se√ß√£o (mesmo com 0 leads)
      leadsSection.style.display = 'block';
      
      // Atualizar conte√∫do
      if(leadsSubtitle) {
        const [ano, mes] = mesISO.split('-');
        const meses = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
        const mesNome = meses[parseInt(mes)-1] || mes;
        leadsSubtitle.textContent = `Leads captados em ${mesNome} ${ano}`;
      }
      
      if(leadsCount) {
        leadsCount.textContent = leadCount;
      }
      
      // Se n√£o h√° leads, ocultar an√°lise detalhada
      if(leadCount === 0) {
        if(leadsAnalysis) leadsAnalysis.style.display = 'none';
        if(leadsDesc) {
          const [ano, mes] = mesISO.split('-');
          const meses = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
          const mesNome = meses[parseInt(mes)-1] || mes;
          leadsDesc.textContent = `Nenhum lead foi gerado durante ${mesNome} ${ano}.`;
        }
        return;
      }
      
      // ===== AN√ÅLISE DETALHADA =====
      
      // 1. An√°lise por Plataforma (Google/Meta)
      const platformStats = {};
      filteredLeads.forEach(lead => {
        const platform = (lead.plataforma || 'N√£o especificado').toString().trim() || 'N√£o especificado';
        platformStats[platform] = (platformStats[platform] || 0) + 1;
      });
      
      // 2. An√°lise por Fonte
      const sourceStats = {};
      filteredLeads.forEach(lead => {
        const source = (lead.source || 'N√£o especificado').toString().trim() || 'N√£o especificado';
        sourceStats[source] = (sourceStats[source] || 0) + 1;
      });
      
      // 3. Principais Perguntas (top 5)
      const questionStats = {};
      filteredLeads.forEach(lead => {
        const question = (lead.question || '').toString().trim();
        if(question && question.length > 0) {
          questionStats[question] = (questionStats[question] || 0) + 1;
        }
      });
      const topQuestions = Object.entries(questionStats)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
      
      // Renderizar an√°lise por plataforma
      if(leadsPlatforms) {
        const platformEntries = Object.entries(platformStats).sort((a, b) => b[1] - a[1]);
        leadsPlatforms.innerHTML = platformEntries.map(([platform, count]) => {
          const percentage = Math.round((count / leadCount) * 100);
          const icon = platform.toLowerCase().includes('google') ? 'üîç' : 
                       platform.toLowerCase().includes('meta') ? 'üìò' : 'üì±';
          return `<div class="goal-pill" style="border-color: rgba(99, 102, 241, 0.4); background: rgba(99, 102, 241, 0.15);">
            ${icon} ${platform}: <strong>${count}</strong> <span style="opacity: 0.7;">(${percentage}%)</span>
          </div>`;
        }).join('');
      }
      
      // Renderizar an√°lise por fonte
      if(leadsSources) {
        const sourceEntries = Object.entries(sourceStats).sort((a, b) => b[1] - a[1]);
        leadsSources.innerHTML = sourceEntries.map(([source, count]) => {
          const percentage = Math.round((count / leadCount) * 100);
          return `<div class="goal-pill" style="border-color: rgba(16, 185, 129, 0.4); background: rgba(16, 185, 129, 0.15);">
            ÔøΩ ${source}: <strong>${count}</strong> <span style="opacity: 0.7;">(${percentage}%)</span>
          </div>`;
        }).join('');
      }
      
      // Renderizar principais perguntas
      if(leadsQuestions) {
        if(topQuestions.length === 0) {
          leadsQuestions.innerHTML = '<div style="color: #94a3b8; font-size: 0.9rem; padding: 8px;">Nenhuma pergunta registrada</div>';
        } else {
          leadsQuestions.innerHTML = topQuestions.map(([question, count], index) => {
            const percentage = Math.round((count / leadCount) * 100);
            return `<div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; padding: 10px 12px;">
              <div style="display: flex; align-items: start; gap: 8px;">
                <span style="color: #fbbf24; font-weight: 800; font-size: 1.1rem; flex-shrink: 0;">${index + 1}.</span>
                <div style="flex: 1;">
                  <div style="color: #e2e8f0; margin-bottom: 4px; line-height: 1.4;">${escapeHtml(question)}</div>
                  <div style="color: #94a3b8; font-size: 0.85rem;">
                    <strong style="color: #60a5fa;">${count}</strong> ${count === 1 ? 'pergunta' : 'perguntas'} 
                    <span style="opacity: 0.7;">(${percentage}% dos leads)</span>
                  </div>
                </div>
              </div>
            </div>`;
          }).join('');
        }
      }
      
      // ===== AN√ÅLISE IA (Insights Autom√°ticos) =====
      if(leadsAIAnalysis) {
        const insights = [];
        const [ano, mes] = mesISO.split('-');
        const meses = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
        const mesNome = meses[parseInt(mes)-1] || mes;
        
        // Insight 1: Volume geral
        const avgLeadsPerDay = (leadCount / 30).toFixed(1);
        insights.push(`üìä <strong>Volume:</strong> ${leadCount} leads gerados em ${mesNome} ${ano}, com m√©dia de ${avgLeadsPerDay} leads/dia.`);
        
        // Insight 2: Plataforma dominante
        const platformEntries = Object.entries(platformStats).sort((a, b) => b[1] - a[1]);
        if(platformEntries.length > 0) {
          const topPlatform = platformEntries[0];
          const topPlatformPercent = Math.round((topPlatform[1] / leadCount) * 100);
          insights.push(`üì± <strong>Plataforma l√≠der:</strong> ${topPlatform[0]} com ${topPlatform[1]} leads (${topPlatformPercent}% do total).`);
          
          if(platformEntries.length > 1 && topPlatformPercent >= 70) {
            insights.push(`üí° <strong>Recomenda√ß√£o:</strong> H√° uma forte concentra√ß√£o em ${topPlatform[0]}. Considere diversificar investimentos em outras plataformas para reduzir depend√™ncia.`);
          }
        }
        
        // Insight 3: Fonte dominante
        const sourceEntries = Object.entries(sourceStats).sort((a, b) => b[1] - a[1]);
        if(sourceEntries.length > 0) {
          const topSource = sourceEntries[0];
          const topSourcePercent = Math.round((topSource[1] / leadCount) * 100);
          insights.push(`üåê <strong>Fonte principal:</strong> ${topSource[0]} com ${topSource[1]} leads (${topSourcePercent}% do total).`);
        }
        
        // Insight 4: Engajamento (perguntas)
        const leadsComPergunta = filteredLeads.filter(l => (l.question || '').toString().trim().length > 0).length;
        const engagementRate = Math.round((leadsComPergunta / leadCount) * 100);
        insights.push(`üí¨ <strong>Engajamento:</strong> ${engagementRate}% dos leads deixaram perguntas (${leadsComPergunta} de ${leadCount}).`);
        
        if(engagementRate < 30) {
          insights.push(`‚ö†Ô∏è <strong>Aten√ß√£o:</strong> Taxa de engajamento baixa. Considere revisar os formul√°rios ou calls-to-action para incentivar mais intera√ß√µes.`);
        } else if(engagementRate >= 70) {
          insights.push(`‚úÖ <strong>Excelente:</strong> Alta taxa de engajamento! Os leads est√£o demonstrando interesse genu√≠no.`);
        }
        
        // Insight 5: Diversifica√ß√£o
        if(platformEntries.length >= 2) {
          insights.push(`ÔøΩüéØ <strong>Diversifica√ß√£o:</strong> Leads provenientes de ${platformEntries.length} plataformas diferentes, demonstrando boa distribui√ß√£o de canais.`);
        }
        
        // Insight 6: Principais d√∫vidas
        if(topQuestions.length > 0) {
          const topQuestion = topQuestions[0];
          insights.push(`‚ùì <strong>Principal d√∫vida:</strong> "${topQuestion[0]}" apareceu ${topQuestion[1]} ${topQuestion[1] === 1 ? 'vez' : 'vezes'}. Considere criar conte√∫do ou FAQ abordando este tema.`);
        }
        
        leadsAIAnalysis.innerHTML = insights.map(insight => 
          `<div style="margin-bottom: 10px; padding-left: 4px; border-left: 3px solid rgba(168, 85, 247, 0.5);">${insight}</div>`
        ).join('');
      }
      
      // Mostrar an√°lise detalhada
      if(leadsAnalysis) leadsAnalysis.style.display = 'block';
      
      // Descri√ß√£o final
      if(leadsDesc) {
        const [ano, mes] = mesISO.split('-');
        const meses = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
        const mesNome = meses[parseInt(mes)-1] || mes;
        
        const platformCount = Object.keys(platformStats).length;
        const sourceCount = Object.keys(sourceStats).length;
        
        leadsDesc.textContent = `üéØ Total de ${leadCount} lead${leadCount === 1 ? '' : 's'} gerado${leadCount === 1 ? '' : 's'} durante ${mesNome} ${ano} atrav√©s de ${platformCount} plataforma${platformCount === 1 ? '' : 's'} e ${sourceCount} fonte${sourceCount === 1 ? '' : 's'} diferente${sourceCount === 1 ? '' : 's'}.`;
      }
      
      // Helper para escapar HTML
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
    }
    
    // Relat√≥rio: Redes trabalhadas (lista apenas redes com link configurado)
    function renderRelatorioRedes(mesISO){
      // mesISO n√£o altera os links, mas mant√©m consist√™ncia com as demais se√ß√µes
      if(!relatorioRedesSection || !relatorioRedesGrid) return;
      const items = collectHeaderSocialItems();
      const connected = items.filter(i=> i && i.hasLink && i.href);
      if(connected.length === 0){
        relatorioRedesSection.style.display = 'none';
        return;
      }
      relatorioRedesSection.style.display = 'block';
      // Subt√≠tulo e descri√ß√£o
      if(relatorioRedesSubtitle){
        relatorioRedesSubtitle.textContent = 'Redes conectadas no cliente (clique para acessar)';
      }
      if(relatorioRedesDesc){
        relatorioRedesDesc.textContent = `üìå ${connected.length} rede${connected.length===1?'':'s'} com link configurado${mesISO?` ‚Äî relat√≥rio de ${mesISO}`:''}. Mostrando apenas o que est√° ativo e pronto para uso.`;
      }
      // Monta os cards (reaproveitando os estilos de macro-social-item)
      const frag = document.createDocumentFragment();
      connected.forEach(item=>{
        const card = document.createElement('div');
        card.className = 'macro-social-item';

        const icon = document.createElement('div');
        icon.className = 'macro-social-icon';
        if(item.iconInfo?.type === 'img' && item.iconInfo.src){
          const img = document.createElement('img');
          img.src = item.iconInfo.src;
          img.alt = item.iconInfo.alt || item.label || '';
          icon.appendChild(img);
        }else if(item.iconInfo?.type === 'text' && item.iconInfo.text){
          icon.textContent = item.iconInfo.text;
          if(item.iconInfo.fontSize){ icon.style.fontSize = item.iconInfo.fontSize; }
        }

        const info = document.createElement('div');
        info.className = 'macro-social-info';
        const labelEl = document.createElement('span');
        labelEl.className = 'macro-social-label';
        labelEl.textContent = item.label || 'Rede social';
        const detailEl = document.createElement('span');
        detailEl.className = 'macro-social-detail';
        detailEl.textContent = 'Link conectado';
        info.append(labelEl, detailEl);

        const actions = document.createElement('div');
        actions.className = 'macro-social-actions';
        const openBtn = document.createElement('button');
        openBtn.type = 'button';
        openBtn.className = 'macro-social-open';
        openBtn.textContent = 'Abrir';
        openBtn.addEventListener('click', ()=>{
          try{
            const win = window.open(item.href, '_blank');
            if(win){ win.opener = null; } else { window.location.href = item.href; }
          }catch(_){ window.location.href = item.href; }
        });
        actions.appendChild(openBtn);

        card.append(icon, info, actions);
        frag.appendChild(card);
      });
      relatorioRedesGrid.replaceChildren(frag);
    }
    
    // Gera resumo em texto de todo o relat√≥rio
    function gerarResumoTexto(mesISO){
      if(!relatorioResumoTextoSection || !relatorioResumoTextoContent || !mesISO) {
        if(relatorioResumoTextoSection) relatorioResumoTextoSection.style.display = 'none';
        return;
      }
      
      const [ano, mes] = mesISO.split('-');
      const meses = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
      const mesNome = meses[parseInt(mes)-1] || mes;
      
      let resumo = `üìä RESUMO DO RELAT√ìRIO - ${mesNome.toUpperCase()} ${ano}\n`;
      resumo += `${'='.repeat(60)}\n\n`;
      
      // Stories
      const storiesCount = document.querySelectorAll('#relatorioStoriesGrid .relatorio-story-item').length;
      resumo += `üì∏ STORIES PUBLICADOS\n`;
      resumo += `   Quantidade: ${storiesCount} ${storiesCount === 1 ? 'story' : 'stories'}\n\n`;
      
      // Posts
      const postsCount = document.querySelectorAll('#relatorioPostsGrid .relatorio-story-item').length;
      resumo += `üì± POSTS DE FEED PUBLICADOS\n`;
      resumo += `   Quantidade: ${postsCount} ${postsCount === 1 ? 'post' : 'posts'}\n\n`;
      
      // Objetivos (Planejamento)
      const goalsDone = document.querySelectorAll('#relatorioGoalsDone .goal-card').length;
      const goalsProgress = document.querySelectorAll('#relatorioGoalsProgress .goal-card').length;
      const goalsTodo = document.querySelectorAll('#relatorioGoalsTodo .goal-card').length;
      const goalsTotal = goalsDone + goalsProgress + goalsTodo;
      
      if(goalsTotal > 0) {
        resumo += `üéØ OBJETIVOS DO M√äS (PLANEJAMENTO)\n`;
        resumo += `   Total de objetivos: ${goalsTotal}\n`;
        resumo += `   ‚úÖ Conclu√≠dos: ${goalsDone}\n`;
        resumo += `   üîÑ Em andamento: ${goalsProgress}\n`;
        resumo += `   ‚è≥ N√£o iniciados: ${goalsTodo}\n`;
        
        if(goalsTotal > 0) {
          const percentConcluido = Math.round((goalsDone / goalsTotal) * 100);
          resumo += `   Taxa de conclus√£o: ${percentConcluido}%\n`;
        }
        resumo += `\n`;
      }
      
      // Metas
      const metasAchieved = document.querySelectorAll('#relatorioMetasAchieved .goal-card').length;
      const metasProgress = document.querySelectorAll('#relatorioMetasProgress .goal-card').length;
      const metasMissing = document.querySelectorAll('#relatorioMetasMissing .goal-card').length;
      const metasTotal = metasAchieved + metasProgress + metasMissing;
      
      if(metasTotal > 0) {
        resumo += `üìà METAS DO M√äS\n`;
        resumo += `   Total de metas: ${metasTotal}\n`;
        resumo += `   ‚úÖ Atingidas: ${metasAchieved}\n`;
        resumo += `   üîÑ Em andamento: ${metasProgress}\n`;
        resumo += `   ‚ö†Ô∏è Precisa colocar: ${metasMissing}\n`;
        
        if(metasTotal > 0) {
          const percentAtingido = Math.round((metasAchieved / metasTotal) * 100);
          resumo += `   Taxa de atingimento: ${percentAtingido}%\n`;
        }
        resumo += `\n`;
      }
      
      // Leads
      const leadsCountEl = document.getElementById('relatorioLeadsCount');
      const leadsCount = leadsCountEl ? parseInt(leadsCountEl.textContent) || 0 : 0;
      
      if(leadsCount > 0) {
        resumo += `üéØ LEADS GERADOS\n`;
        resumo += `   Total de leads: ${leadsCount}\n`;
        
        // Plataformas
        const platformsHTML = document.getElementById('relatorioLeadsPlatforms');
        if(platformsHTML && platformsHTML.innerHTML.trim()) {
          resumo += `\n   Por Plataforma:\n`;
          const platforms = platformsHTML.querySelectorAll('.goal-pill');
          platforms.forEach(pill => {
            const text = pill.textContent.trim();
            resumo += `   ${text}\n`;
          });
        }
        
        // Fontes
        const sourcesHTML = document.getElementById('relatorioLeadsSources');
        if(sourcesHTML && sourcesHTML.innerHTML.trim()) {
          resumo += `\n   Por Fonte:\n`;
          const sources = sourcesHTML.querySelectorAll('.goal-pill');
          sources.forEach(pill => {
            const text = pill.textContent.trim();
            resumo += `   ${text}\n`;
          });
        }
        
        // Top perguntas
        const questionsHTML = document.getElementById('relatorioLeadsQuestions');
        if(questionsHTML && questionsHTML.innerHTML.trim()) {
          const questions = questionsHTML.querySelectorAll('div[style*="background"]');
          if(questions.length > 0) {
            resumo += `\n   Principais Perguntas:\n`;
            questions.forEach((q, idx) => {
              const questionText = q.querySelector('div[style*="color: #e2e8f0"]')?.textContent?.trim();
              if(questionText) {
                resumo += `   ${idx + 1}. ${questionText}\n`;
              }
            });
          }
        }
        
        resumo += `\n`;
      }
      
      // Redes trabalhadas
      const redesCount = document.querySelectorAll('#relatorioRedesGrid .macro-social-item').length;
      if(redesCount > 0) {
        resumo += `üîó REDES TRABALHADAS\n`;
        resumo += `   Quantidade: ${redesCount} ${redesCount === 1 ? 'rede' : 'redes'} com link configurado\n\n`;
      }
      
      // Rodap√©
      resumo += `${'='.repeat(60)}\n`;
      resumo += `Relat√≥rio gerado em ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}\n`;
      
      // Preencher conte√∫do
      relatorioResumoTextoContent.textContent = resumo;
      relatorioResumoTextoSection.style.display = 'block';
    }
    
    // Copiar resumo para clipboard
    async function copiarResumoTexto(){
      if(!relatorioResumoTextoContent) return;
      
      const texto = relatorioResumoTextoContent.textContent;
      
      try {
        // Usar fun√ß√£o robusta de clipboard com fallback para iframes
        const copiado = await mgCopyToClipboard(texto);
        
        if(copiado) {
          // Feedback visual
          if(btnCopiarResumo) {
            const textoOriginal = btnCopiarResumo.textContent;
            btnCopiarResumo.textContent = '‚úÖ Copiado!';
            btnCopiarResumo.style.background = 'rgba(16, 185, 129, 0.3)';
            btnCopiarResumo.style.borderColor = 'rgba(16, 185, 129, 0.5)';
            
            setTimeout(() => {
              btnCopiarResumo.textContent = textoOriginal;
              btnCopiarResumo.style.background = '';
              btnCopiarResumo.style.borderColor = '';
            }, 2000);
          }
        } else {
          alert('N√£o foi poss√≠vel copiar. Tente selecionar e copiar manualmente.');
        }
      } catch(err) {
        console.error('Erro ao copiar resumo:', err);
        alert('Erro ao copiar. Tente selecionar e copiar manualmente.');
      }
    }
    
    function exportarRelatorioPDF(){
      if(!relatorioMesInput || !relatorioMesInput.value){
        alert('Por favor, gere um relat√≥rio primeiro');
        return;
      }
      alert('Funcionalidade de exporta√ß√£o em PDF ser√° implementada em breve!');
    }

    // ============================================
    // AN√ÅLISE ESTRAT√âGICA IA - FUN√á√ïES
    // ============================================
    
    /**
     * Prompt base que define o modelo de neg√≥cio MediaGrowth
     * Este prompt √© usado como contexto para todas as an√°lises
     */
    const MEDIAGROWTH_BUSINESS_CONTEXT = `
Voc√™ √© um especialista s√™nior em Marketing Digital e Social Media com mais de 15 anos de experi√™ncia em gest√£o de contas, estrat√©gias de crescimento e an√°lise de performance para ag√™ncias e clientes.

**CONTEXTO DO NEG√ìCIO:**
A MediaGrowth √© uma ag√™ncia/plataforma de gest√£o de marketing digital que oferece:
- Gest√£o completa de redes sociais (Instagram, Facebook, TikTok, LinkedIn, YouTube, etc.)
- Produ√ß√£o de conte√∫do (Stories, Posts de Feed, Reels, Carross√©is)
- Planejamento estrat√©gico mensal com objetivos e demandas
- Gest√£o de metas de crescimento (seguidores, engajamento, alcance, convers√µes)
- Capta√ß√£o e an√°lise de leads
- Relat√≥rios mensais de performance

**M√âTRICAS IMPORTANTES:**
- Taxa de conclus√£o de objetivos (ideal: >80%)
- Taxa de atingimento de metas (ideal: >70%)
- Volume de produ√ß√£o de conte√∫do (consist√™ncia √© chave)
- Qualidade dos leads (perguntas e engajamento)
- Diversifica√ß√£o de canais

**BENCHMARKS DE MERCADO:**
- Frequ√™ncia ideal de Stories: 3-7 por dia
- Frequ√™ncia ideal de Posts: 3-5 por semana
- Taxa de engajamento m√©dia: 2-6% (varia por nicho)
- Taxa de convers√£o de leads: 1-3% do alcance
- Custo por Lead aceit√°vel: varia por segmento (R$5-50 para B2C, R$50-200 para B2B)

**TOM DE VOZ:**
- Profissional mas acess√≠vel
- Orientado a resultados
- Proativo com sugest√µes pr√°ticas
- Baseado em dados, n√£o em achismos
`;

    /**
     * Gera a an√°lise estrat√©gica completa com IA
     * Analisa os dados do relat√≥rio e gera insights profissionais
     */
    function gerarAnaliseEstrategicaIA(mesISO){
      if(!relatorioAnaliseIASection || !mesISO) {
        if(relatorioAnaliseIASection) relatorioAnaliseIASection.style.display = 'none';
        return;
      }
      
      const [ano, mes] = mesISO.split('-');
      const meses = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
      const mesNome = meses[parseInt(mes)-1] || mes;
      
      // Coletar dados do relat√≥rio atual
      const dados = coletarDadosRelatorio(mesISO);
      
      // Gerar contexto do neg√≥cio
      if(relatorioIAContexto) {
        relatorioIAContexto.innerHTML = gerarContextoNegocio(dados, mesNome, ano);
      }
      
      // Gerar diagn√≥stico de performance
      if(relatorioIADiagnostico) {
        relatorioIADiagnostico.innerHTML = gerarDiagnosticoPerformance(dados, mesNome);
      }
      
      // Gerar pontos fortes
      if(relatorioIAPontosFortes) {
        relatorioIAPontosFortes.innerHTML = gerarPontosFortes(dados, mesNome);
      }
      
      // Gerar oportunidades de melhoria
      if(relatorioIAOportunidades) {
        relatorioIAOportunidades.innerHTML = gerarOportunidades(dados, mesNome);
      }
      
      // Gerar recomenda√ß√µes estrat√©gicas
      if(relatorioIARecomendacoes) {
        relatorioIARecomendacoes.innerHTML = gerarRecomendacoes(dados, mesNome, ano);
      }
      
      // Gerar prompt copi√°vel para ChatGPT/Claude
      if(relatorioIAPrompt) {
        relatorioIAPrompt.textContent = gerarPromptAvancado(dados, mesNome, ano);
      }
      
      // Atualizar subt√≠tulo e descri√ß√£o
      if(relatorioAnaliseIASubtitle) {
        relatorioAnaliseIASubtitle.textContent = `Insights profissionais baseados nos dados de ${mesNome} ${ano}`;
      }
      
      if(relatorioAnaliseIADesc) {
        relatorioAnaliseIADesc.textContent = `üí° Esta an√°lise foi gerada automaticamente com base no seu modelo de neg√≥cio. Use o prompt abaixo para obter an√°lises ainda mais profundas com ChatGPT ou Claude.`;
      }
      
      relatorioAnaliseIASection.style.display = 'block';
    }
    
    /**
     * Coleta todos os dados do relat√≥rio atual do DOM
     */
    function coletarDadosRelatorio(mesISO){
      // Stories
      const storiesCount = document.querySelectorAll('#relatorioStoriesGrid .relatorio-story-item').length;
      const storiesAprovados = document.querySelectorAll('#relatorioStoriesGrid .relatorio-story-item.aprovado').length;
      
      // Posts
      const postsCount = document.querySelectorAll('#relatorioPostsGrid .relatorio-story-item').length;
      const postsAprovados = document.querySelectorAll('#relatorioPostsGrid .relatorio-story-item.aprovado').length;
      
      // Objetivos (Planejamento)
      const goalsDone = document.querySelectorAll('#relatorioGoalsDone .goal-card').length;
      const goalsProgress = document.querySelectorAll('#relatorioGoalsProgress .goal-card').length;
      const goalsTodo = document.querySelectorAll('#relatorioGoalsTodo .goal-card').length;
      const goalsTotal = goalsDone + goalsProgress + goalsTodo;
      
      // Metas
      const metasAchieved = document.querySelectorAll('#relatorioMetasAchieved .goal-card').length;
      const metasProgress = document.querySelectorAll('#relatorioMetasProgress .goal-card').length;
      const metasMissing = document.querySelectorAll('#relatorioMetasMissing .goal-card').length;
      const metasTotal = metasAchieved + metasProgress + metasMissing;
      
      // Leads
      const leadsCountEl = document.getElementById('relatorioLeadsCount');
      const leadsCount = leadsCountEl ? parseInt(leadsCountEl.textContent) || 0 : 0;
      
      // Plataformas de leads
      const platformsEl = document.getElementById('relatorioLeadsPlatforms');
      const platformsCount = platformsEl ? platformsEl.querySelectorAll('.goal-pill').length : 0;
      
      // Fontes de leads
      const sourcesEl = document.getElementById('relatorioLeadsSources');
      const sourcesCount = sourcesEl ? sourcesEl.querySelectorAll('.goal-pill').length : 0;
      
      // Perguntas de leads
      const questionsEl = document.getElementById('relatorioLeadsQuestions');
      const questionsCount = questionsEl ? questionsEl.querySelectorAll('div[style*="background"]').length : 0;
      
      // Redes trabalhadas
      const redesCount = document.querySelectorAll('#relatorioRedesGrid .macro-social-item').length;
      
      // Nome do cliente (se dispon√≠vel)
      const clientName = typeof CLIENT_DATA !== 'undefined' && CLIENT_DATA?.nome ? CLIENT_DATA.nome : 'Cliente';
      
      return {
        mesISO,
        clientName,
        stories: { total: storiesCount, aprovados: storiesAprovados },
        posts: { total: postsCount, aprovados: postsAprovados },
        goals: { done: goalsDone, progress: goalsProgress, todo: goalsTodo, total: goalsTotal },
        metas: { achieved: metasAchieved, progress: metasProgress, missing: metasMissing, total: metasTotal },
        leads: { count: leadsCount, platforms: platformsCount, sources: sourcesCount, questions: questionsCount },
        redes: redesCount
      };
    }
    
    /**
     * Gera o contexto do neg√≥cio baseado nos dados
     */
    function gerarContextoNegocio(dados, mesNome, ano){
      const totalConteudo = dados.stories.total + dados.posts.total;
      const taxaObjetivos = dados.goals.total > 0 ? Math.round((dados.goals.done / dados.goals.total) * 100) : 0;
      const taxaMetas = dados.metas.total > 0 ? Math.round((dados.metas.achieved / dados.metas.total) * 100) : 0;
      
      let nivel = 'iniciante';
      if(totalConteudo > 30 && taxaObjetivos > 60 && taxaMetas > 50) nivel = 'avan√ßado';
      else if(totalConteudo > 15 || taxaObjetivos > 40 || taxaMetas > 30) nivel = 'intermedi√°rio';
      
      let contexto = `<strong>${dados.clientName}</strong> est√° operando em n√≠vel <strong>${nivel}</strong> de maturidade em marketing digital. `;
      
      if(totalConteudo > 0) {
        contexto += `Em ${mesNome} ${ano}, foram produzidos <strong>${totalConteudo} conte√∫dos</strong> (${dados.stories.total} stories + ${dados.posts.total} posts). `;
      } else {
        contexto += `N√£o houve produ√ß√£o de conte√∫do registrada em ${mesNome} ${ano}. `;
      }
      
      if(dados.leads.count > 0) {
        contexto += `A opera√ß√£o est√° gerando leads ativamente (<strong>${dados.leads.count} leads</strong> captados). `;
      }
      
      if(dados.redes > 0) {
        contexto += `O cliente est√° presente em <strong>${dados.redes} ${dados.redes === 1 ? 'rede social' : 'redes sociais'}</strong>.`;
      }
      
      return contexto;
    }
    
    /**
     * Gera o diagn√≥stico de performance
     */
    function gerarDiagnosticoPerformance(dados, mesNome){
      const diagnosticos = [];
      
      // An√°lise de produ√ß√£o de conte√∫do
      const diasNoMes = 30;
      const storiesPorDia = (dados.stories.total / diasNoMes).toFixed(1);
      const postsPorSemana = (dados.posts.total / 4).toFixed(1);
      
      if(dados.stories.total > 0 || dados.posts.total > 0) {
        let statusConteudo = 'üü¢';
        let msgConteudo = '';
        
        if(storiesPorDia >= 3) {
          msgConteudo = `Excelente volume de stories (${storiesPorDia}/dia). Frequ√™ncia acima da m√©dia de mercado.`;
        } else if(storiesPorDia >= 1) {
          statusConteudo = 'üü°';
          msgConteudo = `Volume moderado de stories (${storiesPorDia}/dia). Considere aumentar para 3-5/dia para maior visibilidade.`;
        } else {
          statusConteudo = 'üî¥';
          msgConteudo = `Baixo volume de stories (${storiesPorDia}/dia). Stories s√£o essenciais para engajamento di√°rio.`;
        }
        diagnosticos.push(`${statusConteudo} <strong>Stories:</strong> ${msgConteudo}`);
        
        if(postsPorSemana >= 3) {
          diagnosticos.push(`üü¢ <strong>Posts de Feed:</strong> Frequ√™ncia ideal (${postsPorSemana}/semana). Mant√©m o algoritmo favor√°vel.`);
        } else if(postsPorSemana >= 1) {
          diagnosticos.push(`üü° <strong>Posts de Feed:</strong> Frequ√™ncia aceit√°vel (${postsPorSemana}/semana). Ideal seria 3-5/semana.`);
        } else {
          diagnosticos.push(`üî¥ <strong>Posts de Feed:</strong> Frequ√™ncia baixa (${postsPorSemana}/semana). M√≠nimo recomendado: 3/semana.`);
        }
      } else {
        diagnosticos.push(`üî¥ <strong>Produ√ß√£o de Conte√∫do:</strong> Sem conte√∫do registrado em ${mesNome}. Cr√≠tico para presen√ßa digital.`);
      }
      
      // An√°lise de objetivos
      if(dados.goals.total > 0) {
        const taxaObjetivos = Math.round((dados.goals.done / dados.goals.total) * 100);
        let statusObj = taxaObjetivos >= 80 ? 'üü¢' : taxaObjetivos >= 50 ? 'üü°' : 'üî¥';
        diagnosticos.push(`${statusObj} <strong>Objetivos:</strong> ${taxaObjetivos}% de conclus√£o (${dados.goals.done}/${dados.goals.total}). ${taxaObjetivos >= 80 ? 'Excelente execu√ß√£o!' : taxaObjetivos >= 50 ? 'Bom progresso, mas h√° espa√ßo para melhoria.' : 'Aten√ß√£o: muitos objetivos n√£o conclu√≠dos.'}`);
        
        if(dados.goals.progress > 0) {
          diagnosticos.push(`üü° <strong>Em Andamento:</strong> ${dados.goals.progress} objetivo${dados.goals.progress > 1 ? 's' : ''} ainda em progresso. Priorize a conclus√£o.`);
        }
      }
      
      // An√°lise de metas
      if(dados.metas.total > 0) {
        const taxaMetas = Math.round((dados.metas.achieved / dados.metas.total) * 100);
        let statusMetas = taxaMetas >= 70 ? 'üü¢' : taxaMetas >= 40 ? 'üü°' : 'üî¥';
        diagnosticos.push(`${statusMetas} <strong>Metas:</strong> ${taxaMetas}% de atingimento (${dados.metas.achieved}/${dados.metas.total}). ${taxaMetas >= 70 ? 'Performance acima da m√©dia!' : taxaMetas >= 40 ? 'Desempenho mediano. Revise as estrat√©gias.' : 'Desempenho abaixo do esperado. Reavalia√ß√£o urgente necess√°ria.'}`);
        
        if(dados.metas.missing > 0) {
          diagnosticos.push(`‚ö†Ô∏è <strong>Aten√ß√£o:</strong> ${dados.metas.missing} meta${dados.metas.missing > 1 ? 's' : ''} sem dados preenchidos. Complete para an√°lise precisa.`);
        }
      }
      
      // An√°lise de leads
      if(dados.leads.count > 0) {
        const leadsIdeal = 50; // Benchmark arbitr√°rio
        let statusLeads = dados.leads.count >= leadsIdeal ? 'üü¢' : dados.leads.count >= leadsIdeal/2 ? 'üü°' : 'üî¥';
        diagnosticos.push(`${statusLeads} <strong>Leads:</strong> ${dados.leads.count} leads captados. ${dados.leads.count >= leadsIdeal ? 'Volume excelente!' : 'Considere intensificar campanhas de capta√ß√£o.'}`);
        
        if(dados.leads.platforms > 1) {
          diagnosticos.push(`üü¢ <strong>Diversifica√ß√£o:</strong> Leads vindos de ${dados.leads.platforms} plataformas diferentes. Boa distribui√ß√£o de canais.`);
        }
        
        if(dados.leads.questions > 0) {
          const taxaEngajamento = Math.round((dados.leads.questions / dados.leads.count) * 100);
          diagnosticos.push(`üìä <strong>Engajamento:</strong> ${taxaEngajamento}% dos leads deixaram perguntas. ${taxaEngajamento >= 50 ? 'Alto interesse!' : 'Leads qualificados tendem a ter mais perguntas.'}`);
        }
      }
      
      return diagnosticos.map(d => `<div style="margin-bottom: 8px; padding-left: 8px; border-left: 2px solid rgba(59, 130, 246, 0.4);">${d}</div>`).join('');
    }
    
    /**
     * Gera os pontos fortes identificados
     */
    function gerarPontosFortes(dados, mesNome){
      const pontosFortes = [];
      
      const totalConteudo = dados.stories.total + dados.posts.total;
      const taxaObjetivos = dados.goals.total > 0 ? (dados.goals.done / dados.goals.total) * 100 : 0;
      const taxaMetas = dados.metas.total > 0 ? (dados.metas.achieved / dados.metas.total) * 100 : 0;
      
      // Pontos fortes baseados em performance
      if(totalConteudo >= 20) {
        pontosFortes.push(`‚úÖ <strong>Produ√ß√£o Consistente:</strong> ${totalConteudo} conte√∫dos em ${mesNome} demonstra comprometimento com presen√ßa digital constante.`);
      }
      
      if(dados.stories.total >= 60) {
        pontosFortes.push(`‚úÖ <strong>Stories Ativos:</strong> M√©dia de 2+ stories/dia. Excelente para manter o algoritmo favor√°vel e engajamento di√°rio.`);
      }
      
      if(taxaObjetivos >= 80) {
        pontosFortes.push(`‚úÖ <strong>Execu√ß√£o Impec√°vel:</strong> ${Math.round(taxaObjetivos)}% dos objetivos conclu√≠dos. Demonstra organiza√ß√£o e foco nas entregas.`);
      } else if(taxaObjetivos >= 60) {
        pontosFortes.push(`‚úÖ <strong>Boa Execu√ß√£o:</strong> ${Math.round(taxaObjetivos)}% dos objetivos conclu√≠dos. Acima da m√©dia de mercado.`);
      }
      
      if(taxaMetas >= 70) {
        pontosFortes.push(`‚úÖ <strong>Metas Superadas:</strong> ${Math.round(taxaMetas)}% das metas atingidas. Performance acima do esperado!`);
      }
      
      if(dados.leads.count >= 30) {
        pontosFortes.push(`‚úÖ <strong>Capta√ß√£o Ativa:</strong> ${dados.leads.count} leads gerados demonstra que as estrat√©gias de convers√£o est√£o funcionando.`);
      }
      
      if(dados.leads.platforms >= 3) {
        pontosFortes.push(`‚úÖ <strong>Multicanalidade:</strong> Leads de ${dados.leads.platforms} plataformas diferentes. Reduz depend√™ncia de um √∫nico canal.`);
      }
      
      if(dados.redes >= 3) {
        pontosFortes.push(`‚úÖ <strong>Presen√ßa Ampla:</strong> Ativo em ${dados.redes} redes sociais. Maximiza pontos de contato com a audi√™ncia.`);
      }
      
      if(dados.posts.aprovados === dados.posts.total && dados.posts.total > 0) {
        pontosFortes.push(`‚úÖ <strong>Qualidade Aprovada:</strong> 100% dos posts aprovados. Excelente alinhamento com o cliente.`);
      }
      
      if(pontosFortes.length === 0) {
        pontosFortes.push(`üí≠ <strong>Em Constru√ß√£o:</strong> Continue trabalhando para desenvolver pontos fortes. Consist√™ncia √© a chave do sucesso em marketing digital.`);
      }
      
      return pontosFortes.map(p => `<div style="margin-bottom: 8px; padding-left: 8px; border-left: 2px solid rgba(16, 185, 129, 0.4);">${p}</div>`).join('');
    }
    
    /**
     * Gera as oportunidades de melhoria
     */
    function gerarOportunidades(dados, mesNome){
      const oportunidades = [];
      
      const totalConteudo = dados.stories.total + dados.posts.total;
      const taxaObjetivos = dados.goals.total > 0 ? (dados.goals.done / dados.goals.total) * 100 : 0;
      const taxaMetas = dados.metas.total > 0 ? (dados.metas.achieved / dados.metas.total) * 100 : 0;
      
      // Oportunidades baseadas em gaps
      if(dados.stories.total < 60) {
        const storiesIdeal = 90;
        const gap = storiesIdeal - dados.stories.total;
        oportunidades.push(`üí° <strong>Aumentar Stories:</strong> Produza mais ${gap} stories/m√™s para atingir frequ√™ncia ideal de 3/dia. Stories t√™m 500% mais alcance que posts est√°ticos.`);
      }
      
      if(dados.posts.total < 12) {
        oportunidades.push(`üí° <strong>Frequ√™ncia de Posts:</strong> Aumente para 3-4 posts/semana. Algoritmo favorece contas consistentes.`);
      }
      
      if(dados.goals.todo > 0) {
        oportunidades.push(`üí° <strong>Objetivos Pendentes:</strong> ${dados.goals.todo} objetivo${dados.goals.todo > 1 ? 's' : ''} n√£o iniciado${dados.goals.todo > 1 ? 's' : ''}. Revise prioridades e inicie no pr√≥ximo ciclo.`);
      }
      
      if(dados.goals.progress > 2) {
        oportunidades.push(`üí° <strong>Foco na Conclus√£o:</strong> ${dados.goals.progress} objetivos em andamento. Priorize finalizar antes de iniciar novos.`);
      }
      
      if(dados.metas.missing > 0) {
        oportunidades.push(`üí° <strong>Complete os Dados:</strong> ${dados.metas.missing} meta${dados.metas.missing > 1 ? 's' : ''} sem valores realizados. Dados completos permitem an√°lises precisas.`);
      }
      
      if(taxaMetas < 50 && dados.metas.total > 0) {
        oportunidades.push(`üí° <strong>Revisar Metas:</strong> Apenas ${Math.round(taxaMetas)}% atingidas. Considere ajustar metas para n√≠veis mais realistas ou intensificar esfor√ßos.`);
      }
      
      if(dados.leads.count < 20 && dados.leads.count > 0) {
        oportunidades.push(`üí° <strong>Escalar Capta√ß√£o:</strong> ${dados.leads.count} leads √© um in√≠cio. Invista em campanhas de tr√°fego pago para escalar.`);
      }
      
      if(dados.leads.platforms <= 1 && dados.leads.count > 0) {
        oportunidades.push(`üí° <strong>Diversificar Canais:</strong> Leads concentrados em ${dados.leads.platforms} plataforma. Expanda para Google, Meta, TikTok, LinkedIn.`);
      }
      
      if(dados.redes < 3) {
        oportunidades.push(`üí° <strong>Expandir Presen√ßa:</strong> Considere adicionar mais redes sociais. LinkedIn para B2B, TikTok para alcance org√¢nico.`);
      }
      
      if(totalConteudo === 0) {
        oportunidades.push(`üî¥ <strong>CR√çTICO - Produ√ß√£o Zero:</strong> Sem conte√∫do n√£o h√° crescimento. Defina um calend√°rio editorial m√≠nimo de 3 posts/semana + stories di√°rios.`);
      }
      
      if(oportunidades.length === 0) {
        oportunidades.push(`üåü <strong>Excelente Performance:</strong> N√£o foram identificados gaps cr√≠ticos. Mantenha o ritmo e explore novas oportunidades de crescimento.`);
      }
      
      return oportunidades.map(o => `<div style="margin-bottom: 8px; padding-left: 8px; border-left: 2px solid rgba(245, 158, 11, 0.4);">${o}</div>`).join('');
    }
    
    /**
     * Gera as recomenda√ß√µes estrat√©gicas para o pr√≥ximo m√™s
     */
    function gerarRecomendacoes(dados, mesNome, ano){
      const recomendacoes = [];
      
      const totalConteudo = dados.stories.total + dados.posts.total;
      const taxaObjetivos = dados.goals.total > 0 ? (dados.goals.done / dados.goals.total) * 100 : 0;
      const taxaMetas = dados.metas.total > 0 ? (dados.metas.achieved / dados.metas.total) * 100 : 0;
      
      // Calcular pr√≥ximo m√™s
      const [anoNum, mesNum] = dados.mesISO.split('-').map(Number);
      const proximoMes = mesNum === 12 ? 1 : mesNum + 1;
      const proximoAno = mesNum === 12 ? anoNum + 1 : anoNum;
      const mesesNomes = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
      const proximoMesNome = mesesNomes[proximoMes - 1];
      
      // Recomenda√ß√µes estrat√©gicas
      recomendacoes.push(`üéØ <strong>Meta de Conte√∫do para ${proximoMesNome}:</strong> Produza no m√≠nimo ${Math.max(totalConteudo + 10, 30)} conte√∫dos. Crescimento de 20% mant√©m momentum.`);
      
      if(dados.stories.total < 60) {
        recomendacoes.push(`üì± <strong>Estrat√©gia de Stories:</strong> Implemente rotina de 3 stories/dia: 1 bastidores, 1 dica/valor, 1 CTA/engajamento.`);
      }
      
      if(dados.posts.total < 12) {
        recomendacoes.push(`üì∞ <strong>Calend√°rio Editorial:</strong> Crie um mix de conte√∫do: 40% educativo, 30% inspiracional, 20% promocional, 10% entretenimento.`);
      }
      
      if(taxaObjetivos < 70) {
        recomendacoes.push(`üìã <strong>Gest√£o de Objetivos:</strong> Reduza para 3-5 objetivos priorit√°rios. Menos √© mais quando se trata de foco.`);
      }
      
      if(dados.leads.count > 0) {
        const metaLeads = Math.round(dados.leads.count * 1.3);
        recomendacoes.push(`üéØ <strong>Meta de Leads:</strong> Alcance ${metaLeads} leads em ${proximoMesNome} (+30%). Intensifique campanhas que performaram.`);
      } else {
        recomendacoes.push(`üéØ <strong>Iniciar Capta√ß√£o:</strong> Configure pelo menos 1 campanha de capta√ß√£o de leads. Use formul√°rios com perguntas qualificadoras.`);
      }
      
      if(dados.leads.platforms <= 1) {
        recomendacoes.push(`üîÄ <strong>Diversifica√ß√£o de Canais:</strong> Teste campanhas no Google Ads e Meta Ads simultaneamente. Compare performance.`);
      }
      
      // Recomenda√ß√µes sazonais
      const mesAtual = parseInt(mesNum);
      if(mesAtual === 11 || mesAtual === 12) {
        recomendacoes.push(`üéÑ <strong>Sazonalidade:</strong> Prepare conte√∫dos de fim de ano, retrospectiva e metas para ${proximoAno}. Alto engajamento nessa √©poca.`);
      } else if(mesAtual === 1 || mesAtual === 2) {
        recomendacoes.push(`üöÄ <strong>In√≠cio de Ano:</strong> Aproveite a energia de "novo come√ßo". Conte√∫dos sobre metas e transforma√ß√£o performam bem.`);
      } else if(mesAtual >= 6 && mesAtual <= 8) {
        recomendacoes.push(`‚òÄÔ∏è <strong>Meio do Ano:</strong> Per√≠odo de menor engajamento. Mantenha consist√™ncia e prepare grandes lan√ßamentos para Set/Out.`);
      }
      
      // Recomenda√ß√£o de an√°lise
      recomendacoes.push(`üìä <strong>Pr√≥xima An√°lise:</strong> Agende revis√£o dos resultados na primeira semana de ${proximoMesNome}. Ajuste estrat√©gias com base em dados.`);
      
      return recomendacoes.map(r => `<div style="margin-bottom: 10px; padding-left: 8px; border-left: 2px solid rgba(236, 72, 153, 0.4);">${r}</div>`).join('');
    }
    
    /**
     * Gera um prompt avan√ßado para usar com ChatGPT/Claude
     * Este prompt inclui todos os dados e pede an√°lise profunda
     */
    function gerarPromptAvancado(dados, mesNome, ano){
      const totalConteudo = dados.stories.total + dados.posts.total;
      const taxaObjetivos = dados.goals.total > 0 ? Math.round((dados.goals.done / dados.goals.total) * 100) : 0;
      const taxaMetas = dados.metas.total > 0 ? Math.round((dados.metas.achieved / dados.metas.total) * 100) : 0;
      
      return `${MEDIAGROWTH_BUSINESS_CONTEXT}

=== DADOS DO RELAT√ìRIO DE ${mesNome.toUpperCase()} ${ano} ===

**CLIENTE:** ${dados.clientName}

**PRODU√á√ÉO DE CONTE√öDO:**
- Stories produzidos: ${dados.stories.total} (${dados.stories.aprovados} aprovados)
- Posts de feed: ${dados.posts.total} (${dados.posts.aprovados} aprovados)
- Total de conte√∫dos: ${totalConteudo}
- Frequ√™ncia de stories: ${(dados.stories.total / 30).toFixed(1)}/dia
- Frequ√™ncia de posts: ${(dados.posts.total / 4).toFixed(1)}/semana

**OBJETIVOS DO M√äS (PLANEJAMENTO):**
- Total de objetivos: ${dados.goals.total}
- Conclu√≠dos: ${dados.goals.done} (${taxaObjetivos}%)
- Em andamento: ${dados.goals.progress}
- N√£o iniciados: ${dados.goals.todo}

**METAS QUANTITATIVAS:**
- Total de metas: ${dados.metas.total}
- Atingidas: ${dados.metas.achieved} (${taxaMetas}%)
- Em progresso: ${dados.metas.progress}
- Sem dados: ${dados.metas.missing}

**LEADS CAPTADOS:**
- Total de leads: ${dados.leads.count}
- Plataformas de origem: ${dados.leads.platforms}
- Fontes diferentes: ${dados.leads.sources}
- Leads com perguntas: ${dados.leads.questions}

**PRESEN√áA DIGITAL:**
- Redes sociais ativas: ${dados.redes}

=== SOLICITA√á√ÉO DE AN√ÅLISE ===

Com base nos dados acima e no contexto do neg√≥cio MediaGrowth, por favor forne√ßa:

1. **DIAGN√ìSTICO EXECUTIVO (3-5 par√°grafos):**
   - Avalia√ß√£o geral da performance do m√™s
   - Compara√ß√£o com benchmarks de mercado
   - Identifica√ß√£o de padr√µes e tend√™ncias

2. **AN√ÅLISE SWOT ESPEC√çFICA:**
   - For√ßas: O que est√° funcionando muito bem
   - Fraquezas: Gaps e problemas identificados
   - Oportunidades: O que pode ser explorado
   - Amea√ßas: Riscos se nada mudar

3. **PLANO DE A√á√ÉO PARA O PR√ìXIMO M√äS:**
   - 5 a√ß√µes priorit√°rias com prazo e respons√°vel
   - M√©tricas de sucesso para cada a√ß√£o
   - Recursos necess√°rios

4. **PROJE√á√ïES E METAS SUGERIDAS:**
   - Metas realistas para o pr√≥ximo m√™s
   - Crescimento esperado se a√ß√µes forem implementadas
   - Cen√°rio pessimista, realista e otimista

5. **INSIGHTS CRIATIVOS:**
   - 3 ideias de campanhas/conte√∫dos espec√≠ficos
   - Oportunidades sazonais
   - Tend√™ncias de mercado aplic√°veis

Por favor, seja espec√≠fico, use n√∫meros e d√™ recomenda√ß√µes acion√°veis.
`;
    }
    
    /**
     * Copia o prompt de IA para o clipboard
     */
    async function copiarPromptIA(){
      if(!relatorioIAPrompt) return;
      
      const texto = relatorioIAPrompt.textContent;
      
      try {
        // Usar fun√ß√£o robusta de clipboard com fallback para iframes
        const copiado = await mgCopyToClipboard(texto);
        
        if(copiado) {
          // Feedback visual
          if(btnCopiarPromptIA) {
            const textoOriginal = btnCopiarPromptIA.textContent;
            btnCopiarPromptIA.textContent = '‚úÖ Copiado!';
            btnCopiarPromptIA.style.background = 'rgba(16, 185, 129, 0.3)';
            btnCopiarPromptIA.style.borderColor = 'rgba(16, 185, 129, 0.5)';
            
            setTimeout(() => {
              btnCopiarPromptIA.textContent = textoOriginal;
              btnCopiarPromptIA.style.background = 'rgba(139, 92, 246, 0.2)';
              btnCopiarPromptIA.style.borderColor = 'rgba(139, 92, 246, 0.4)';
            }, 2000);
          }
          
          mgToast('‚úÖ Prompt copiado! Cole no ChatGPT ou Claude para an√°lise avan√ßada.');
        } else {
          alert('N√£o foi poss√≠vel copiar. Tente selecionar e copiar manualmente.');
        }
      } catch(err) {
        console.error('Erro ao copiar prompt:', err);
        alert('Erro ao copiar. Tente selecionar e copiar manualmente.');
      }
    }

    

    /* ========= arquivos ========= */
    const normalizeParent = (value)=> (value===undefined || value===null || value==='') ? null : value;
    const folderCollator = new Intl.Collator('pt-BR', { sensitivity: 'base', numeric: true });
    let FOLDERS = [];
    const DEFAULT_STORAGE_LIMIT_BYTES = 5 * 1024 * 1024 * 1024;
    let storageUsageBytes = 0;
    let storageUsageCount = 0;
    let storageUsageLoading = false;
    let storageUsageFetchToken = 0;
    let storageLimitBytes = null;
    let storageLimitSource = null;
    const STORAGE_METADATA_TTL = 5 * 60 * 1000;
    const storageMetadataCache = new Map();
    const storageMetadataPending = new Map();
    let storageUsageBreakdown = {
      files: 0,
      calendarMedia: 0,
      calendarNotes: 0,
      references: 0,
      notes: 0
    };
    const textEncoder = typeof TextEncoder !== 'undefined' ? new TextEncoder() : null;
    let currentFolder = null;
    let CURRENT_FILES = [];
    let SELECTED_FILES = new Set();
    let LAST_SELECTED_INDEX = null;
    let BULK_ACTION_RUNNING = false;
    let LAST_BULK_SHIFT = false;
    let LAST_UNDO_ACTION = null;
    let BULK_STATUS_MESSAGE = '';
    const uploadingObjectUrls = new Map();
    let FILES_UPLOAD_ACTIVE = false;
    let viewingAllFiles = false;
    let lastSelectedFolder = null;
    const ALL_FILES_CRUMB_ID = '__all__';
    const FILES_VIEW_STORAGE_KEY = 'mg_files_view_mode';
    let FILES_VIEW_MODE = 'list';
    try{
      const storedView = localStorage.getItem(FILES_VIEW_STORAGE_KEY);
      if(storedView === 'grid' || storedView === 'list'){
        FILES_VIEW_MODE = storedView;
      }
    }catch(_){ }
    const IMAGE_EXTS = ['png','jpg','jpeg','gif','bmp','webp','svg','heic','heif','tiff','tif','avif'];
    const VIDEO_EXTS = ['mp4','mov','wmv','mkv','avi','flv','webm','mpeg','mpg','m4v','3gp'];
    const DEFAULT_ROOT_FOLDERS = [
      'üß† ESTRAT√âGIA & RELAT√ìRIOS',
      'üé® IDENTIDADE & MATERIAIS',
      'üì∏ CONTE√öDO & REDES SOCIAIS',
      'üöÄ TR√ÅFEGO & GOOGLE',
      'üìÑ DOCUMENTOS & CONTRATOS',
      'üí° INSPIRA√á√ïES'
    ];
    function normalizeDefaultFolderName(name){
      let base = (name || '').toString().trim().toLowerCase();
      try{
        base = base.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      }catch(_){ }
      return base;
    }
    async function ensureDefaultRootFolders(uid, clientKey, existingFolders, colRef){
      if(!uid || !clientKey) return [];
      const current = Array.isArray(existingFolders) ? existingFolders : [];
      const existingNames = new Set(
        current
          .filter(folder=> !normalizeParent(folder.parentId))
          .map(folder=> normalizeDefaultFolderName(folder.name))
      );
      const missing = DEFAULT_ROOT_FOLDERS.filter(name=> !existingNames.has(normalizeDefaultFolderName(name)));
      if(!missing.length) return [];
      const col = colRef || collection(db, 'usuarios', uid, 'clients', clientKey, 'fileFolders');
      const created = [];
      for(const name of missing){
        try{
          const createdAt = Date.now();
          const docRef = await addDoc(col, { name, parentId: null, createdAt });
          created.push({ id: docRef.id, name, parentId: null, createdAt });
        }catch(err){
          console.warn('ensureDefaultRootFolders', err);
        }
      }
      return created;
    }

    function normalizeTenantKey(value){
      if(!value) return null;
      return value.replace(/[^\w-]/g, '_');
    }

    function extractStoragePath(raw){
      if(!raw) return null;
      if(typeof raw !== 'string') return null;
      if(raw.startsWith('http')){
        try{
          const url = new URL(raw);
          const match = url.pathname.match(/\/o\/([^?]+)/);
          if(match && match[1]){
            return decodeURIComponent(match[1]);
          }
        }catch(_){ }
        return null;
      }
      return raw;
    }

    async function getStorageObjectSize(path){
      if(!path) return null;
      const now = Date.now();
      const cached = storageMetadataCache.get(path);
      if(cached && (now - cached.ts) < STORAGE_METADATA_TTL){
        return cached.size;
      }
      if(storageMetadataPending.has(path)){
        try{
          const size = await storageMetadataPending.get(path);
          return size;
        }catch(_){
          return null;
        }
      }
      const promise = (async ()=>{
        try{
          if(!STORAGE){
            STORAGE = getStorage(app);
          }
        }catch(err){
          console.warn('getStorageObjectSize init', err);
          return null;
        }
        try{
          const metadata = await getMetadata(sRef(STORAGE, path));
          const sizeValue = Number(metadata?.size);
          const size = Number.isFinite(sizeValue) && sizeValue > 0 ? sizeValue : 0;
          storageMetadataCache.set(path, { size, ts: Date.now() });
          return size;
        }catch(err){
          storageMetadataCache.set(path, { size: null, ts: Date.now(), error: true });
          console.warn('getStorageObjectSize', path, err);
          return null;
        }
      })();
      storageMetadataPending.set(path, promise);
      try{
        const size = await promise;
        return size;
      }finally{
        storageMetadataPending.delete(path);
      }
    }

    function estimateObjectBytes(value){
      if(!textEncoder) return 0;
      try{
        if(typeof value === 'string'){
          return textEncoder.encode(value).length;
        }
        if(value && typeof value === 'object'){
          return textEncoder.encode(JSON.stringify(value)).length;
        }
      }catch(err){
        console.warn('estimateObjectBytes', err);
      }
      return 0;
    }

    function filterPostsByClient(posts, clientKey){
      if(!Array.isArray(posts)) return [];
      const safeKey = normalizeTenantKey(clientKey);
      console.log('[filterPostsByClient] clientKey:', clientKey, 'safeKey:', safeKey);
      if(!safeKey) return posts.slice();
      
      // Normaliza removendo pontos e h√≠fens para compara√ß√£o
      const normalizeForCompare = (str) => {
        if(!str) return '';
        return String(str).toLowerCase().replace(/[.-]/g, '');
      };
      const normalizedClientKey = normalizeForCompare(clientKey);
      
      const filtered = posts.filter(post=>{
        const tenant = post?.tenant || '';
        if(!tenant) return true;
        const normalizedTenant = normalizeForCompare(tenant);
        const matches = normalizedTenant === normalizedClientKey;
        console.log('[filterPostsByClient] Post:', post.id, 'tenant:', tenant, 'normalized:', normalizedTenant, 'matches:', matches);
        return matches;
      });
      console.log('[filterPostsByClient] Total posts:', posts.length, 'Filtered:', filtered.length);
      return filtered;
    }

    async function computeCalendarStorageUsage(clientKey){
      const relevantPosts = filterPostsByClient(Array.isArray(POSTS) ? POSTS : [], clientKey);
      const pathMap = new Map();
      relevantPosts.forEach(post=>{
        const mediaMeta = Array.isArray(post?.mediaMeta) ? post.mediaMeta : [];
        const metaByPath = new Map();
        mediaMeta.forEach(meta=>{
          const metaPath = extractStoragePath(meta?.path || meta?.url);
          if(!metaPath) return;
          const sizeValue = Number(meta?.size);
          const knownSize = Number.isFinite(sizeValue) && sizeValue > 0 ? sizeValue : null;
          if(!metaByPath.has(metaPath) || (knownSize && !metaByPath.get(metaPath))){
            metaByPath.set(metaPath, knownSize);
          }
        });
        (Array.isArray(post?.mediaUrls) ? post.mediaUrls : []).forEach((url, index)=>{
          const path = extractStoragePath(url);
          if(!path) return;
          let knownSize = null;
          const meta = mediaMeta[index];
          if(meta){
            const metaSize = Number(meta.size);
            if(Number.isFinite(metaSize) && metaSize > 0){
              knownSize = metaSize;
            } else if(meta.path){
              const cached = metaByPath.get(meta.path);
              if(cached) knownSize = cached;
            }
          } else if(metaByPath.has(path)){
            knownSize = metaByPath.get(path);
          }
          if(!pathMap.has(path) || (knownSize && !pathMap.get(path))){
            pathMap.set(path, knownSize);
          }
        });
        const coverMeta = post?.coverMeta && typeof post.coverMeta === 'object' ? post.coverMeta : null;
        if(coverMeta){
          const coverPath = extractStoragePath(coverMeta.path || coverMeta.url || post.thumbUrl);
          if(coverPath){
            const coverSize = Number(coverMeta.size);
            const knownSize = Number.isFinite(coverSize) && coverSize > 0 ? coverSize : null;
            if(!pathMap.has(coverPath) || (knownSize && !pathMap.get(coverPath))){
              pathMap.set(coverPath, knownSize);
            }
          }
        }
        const thumbPath = extractStoragePath(post?.thumbUrl);
        if(thumbPath && !pathMap.has(thumbPath)){
          pathMap.set(thumbPath, null);
        }
      });

      const mediaResults = await Promise.all(Array.from(pathMap.entries()).map(async ([path, knownSize])=>{
        if(Number.isFinite(knownSize) && knownSize > 0){
          return { path, size: knownSize };
        }
        const size = await getStorageObjectSize(path);
        return { path, size };
      }));

      let mediaBytes = 0;
      mediaResults.forEach(({ size })=>{
        if(Number.isFinite(size) && size > 0){
          mediaBytes += size;
        }
      });
      const mediaCount = pathMap.size;

      const calendarNotes = CAL_NOTES && typeof CAL_NOTES === 'object' ? CAL_NOTES : {};
      const notesBytes = estimateObjectBytes(calendarNotes);
      const notesCount = Object.keys(calendarNotes).length;

      return {
        mediaBytes,
        mediaCount,
        notesBytes,
        notesCount,
        bytes: mediaBytes + notesBytes,
        count: mediaCount + notesCount
      };
    }

    async function computeRefSocialStorageUsage(){
      const items = Array.isArray(REF_SOCIAL) ? REF_SOCIAL : [];
      const pathMap = new Map();
      items.forEach(item=>{
        const isUpload = (item?.sourceType || item?.type) === 'upload';
        if(!isUpload) return;
        const path = extractStoragePath(item?.path || item?.storagePath || item?.url);
        if(!path) return;
        const sizeValue = Number(item?.size);
        const knownSize = Number.isFinite(sizeValue) && sizeValue > 0 ? sizeValue : null;
        if(!pathMap.has(path) || (knownSize && !pathMap.get(path))){
          pathMap.set(path, knownSize);
        }
      });
      const results = await Promise.all(Array.from(pathMap.entries()).map(async ([path, knownSize])=>{
        if(Number.isFinite(knownSize) && knownSize > 0){
          return { path, size: knownSize };
        }
        const size = await getStorageObjectSize(path);
        return { path, size };
      }));
      let bytes = 0;
      results.forEach(({ size })=>{
        if(Number.isFinite(size) && size > 0){
          bytes += size;
        }
      });
      const count = pathMap.size;
      return { bytes, count };
    }

    function computeNotesStorageUsage(){
      const notesArray = Array.isArray(NOTES) ? NOTES : [];
      const bytes = estimateObjectBytes(notesArray);
      return { bytes, count: notesArray.length };
    }

    function escapeHtml(value){
      return String(value ?? '')
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    const escapeAttr = escapeHtml;

    function getFileExt(name){
      return String(name||'').split('.').pop().toLowerCase();
    }

    function isImageFile(file){
      const type = String(file?.contentType||'');
      if(type.startsWith('image/')) return true;
      return IMAGE_EXTS.includes(getFileExt(file?.name));
    }

    function isVideoFile(file){
      const type = String(file?.contentType||'');
      if(type.startsWith('video/')) return true;
      return VIDEO_EXTS.includes(getFileExt(file?.name));
    }

    const sizeUnits = ['B','KB','MB','GB','TB'];
    function formatFileSize(raw){
      if(raw === null || raw === undefined) return '--';
      const size = Number(raw);
      if(!Number.isFinite(size) || size < 0){
        return '--';
      }
      if(size === 0){
        return '0 B';
      }
      let value = size;
      let unitIndex = 0;
      while(value >= 1024 && unitIndex < sizeUnits.length - 1){
        value /= 1024;
        unitIndex++;
      }
      const digits = value >= 10 || unitIndex === 0 ? 0 : 1;
      return `${value.toFixed(digits)} ${sizeUnits[unitIndex]}`;
    }

    function toPositiveNumber(raw){
      if(raw === null || raw === undefined) return null;
      if(typeof raw === 'number'){
        return Number.isFinite(raw) && raw > 0 ? raw : null;
      }
      if(typeof raw === 'string'){
        const cleaned = raw.replace(/[^0-9.,-]/g,'').replace(',', '.');
        if(!cleaned.trim()) return null;
        const num = Number(cleaned);
        return Number.isFinite(num) && num > 0 ? num : null;
      }
      return null;
    }

    function extractStorageLimitFromSource(source, sourceName){
      if(!source || typeof source !== 'object') return null;
      const bytesCandidates = [
        source.storageLimitBytes,
        source.storageUsageLimitBytes,
        source.storageQuotaBytes,
        source.storageQuota,
        source.storageLimit
      ];
      for(const candidate of bytesCandidates){
        const parsed = toPositiveNumber(candidate);
        if(parsed) return { bytes: parsed, source: sourceName };
      }
      const gbCandidates = [
        source.storageLimitGb,
        source.storageLimitGB,
        source.storageQuotaGb,
        source.storageQuotaGB
      ];
      for(const candidate of gbCandidates){
        const parsed = toPositiveNumber(candidate);
        if(parsed) return { bytes: parsed * 1024 * 1024 * 1024, source: sourceName };
      }
      const mbCandidates = [
        source.storageLimitMb,
        source.storageLimitMB,
        source.storageQuotaMb,
        source.storageQuotaMB
      ];
      for(const candidate of mbCandidates){
        const parsed = toPositiveNumber(candidate);
        if(parsed) return { bytes: parsed * 1024 * 1024, source: sourceName };
      }
      return null;
    }

    function syncStorageLimitFromProfile(){
      const clientLimit = extractStorageLimitFromSource(CLIENT_PROFILE, 'profile');
      const userLimit = extractStorageLimitFromSource(USER_DATA, 'user');
      const next = clientLimit || userLimit || null;
      const nextBytes = next ? next.bytes : null;
      const nextSource = next ? next.source : null;
      if(nextBytes !== storageLimitBytes || nextSource !== storageLimitSource){
        storageLimitBytes = nextBytes;
        storageLimitSource = nextSource;
        updateStorageUsageUI();
      }
    }

    const formatFileCount = (count)=>{
      const value = Number(count);
      if(!Number.isFinite(value) || value <= 0) return '0 itens';
      return value === 1 ? '1 item' : `${value} itens`;
    };

    function resetStorageUsageState(options = {}){
      const { loading = false } = options;
      storageUsageBytes = 0;
      storageUsageCount = 0;
      storageLimitBytes = null;
      storageLimitSource = null;
      storageUsageFetchToken++;
      storageUsageLoading = loading;
      updateStorageUsageUI();
    }

    function updateStorageUsageUI(){
      if(!storageUsage) return;
      const hasContext = !!(auth?.currentUser) && !!getClientKey();
      if(!hasContext){
        storageUsage.classList.add('hidden');
        storageUsage.removeAttribute('aria-busy');
        storageUsage.removeAttribute('data-level');
        if(storageUsagePercent) storageUsagePercent.textContent = '';
        if(storageUsageSummary) storageUsageSummary.textContent = '';
        if(storageUsageHint) storageUsageHint.textContent = '';
        if(storageUsageFill) storageUsageFill.style.width = '0%';
        return;
      }
      storageUsage.classList.remove('hidden');
      const breakdownLabel = 'Inclui arquivos, calend√°rio, refer√™ncias e notas.';
      if(storageUsageLoading){
        storageUsage.setAttribute('aria-busy','true');
        storageUsage.dataset.level = 'loading';
        if(storageUsagePercent) storageUsagePercent.textContent = '';
        if(storageUsageSummary) storageUsageSummary.textContent = 'Calculando uso...';
        if(storageUsageHint){
          const limitIsCustom = Number.isFinite(storageLimitBytes) && storageLimitBytes > 0;
          const effectiveLimit = limitIsCustom ? storageLimitBytes : DEFAULT_STORAGE_LIMIT_BYTES;
          const limitLabel = formatFileSize(effectiveLimit);
          const sourceLabel = storageLimitSource === 'user'
            ? 'Limite do usu√°rio'
            : storageLimitSource === 'profile'
              ? 'Limite do cliente'
              : 'Limite padr√£o';
          if(limitIsCustom){
            storageUsageHint.textContent = breakdownLabel ? `${sourceLabel}: ${limitLabel} ‚Ä¢ ${breakdownLabel}` : `${sourceLabel}: ${limitLabel}`;
          } else {
            storageUsageHint.textContent = breakdownLabel ? `${sourceLabel} de ${limitLabel} ‚Ä¢ ${breakdownLabel}` : `${sourceLabel} de ${limitLabel}`;
          }
        }
        if(storageUsageFill) storageUsageFill.style.width = '0%';
        return;
      }
      storageUsage.removeAttribute('aria-busy');
      const bytes = Math.max(0, Number(storageUsageBytes) || 0);
      const count = Math.max(0, Number(storageUsageCount) || 0);
      const limitIsCustom = Number.isFinite(storageLimitBytes) && storageLimitBytes > 0;
      const effectiveLimit = limitIsCustom ? storageLimitBytes : DEFAULT_STORAGE_LIMIT_BYTES;
      const percentRaw = effectiveLimit > 0 ? (bytes / effectiveLimit) * 100 : 0;
      const percentForBar = Math.min(100, Math.max(0, percentRaw));
      const percentRounded = Math.round(percentRaw);
      if(storageUsageFill) storageUsageFill.style.width = `${percentForBar}%`;
      if(storageUsagePercent) storageUsagePercent.textContent = `${percentRounded}%`;
      const usedLabel = formatFileSize(bytes);
      const limitLabel = formatFileSize(effectiveLimit);
      const countLabel = formatFileCount(count);
      const sourceLabel = storageLimitSource === 'user'
        ? 'Limite do usu√°rio'
        : storageLimitSource === 'profile'
          ? 'Limite do cliente'
          : 'Limite padr√£o';
      if(bytes <= 0){
        if(storageUsageSummary){
          if(limitIsCustom){
            const descriptor = storageLimitSource === 'user' ? ' (usu√°rio)' : '';
            storageUsageSummary.textContent = `0 B de ${limitLabel}${descriptor} utilizados`;
          } else {
            storageUsageSummary.textContent = 'Nenhum arquivo enviado ainda.';
          }
        }
        if(storageUsageHint){
          if(limitIsCustom){
            const hintLabel = sourceLabel
              ? `${countLabel} ‚Ä¢ ${sourceLabel} de ${limitLabel}`
              : `${countLabel} ‚Ä¢ Limite de ${limitLabel}`;
            storageUsageHint.textContent = breakdownLabel ? `${hintLabel} ‚Ä¢ ${breakdownLabel}` : hintLabel;
          } else {
            storageUsageHint.textContent = `${countLabel} ‚Ä¢ Limite padr√£o de ${limitLabel} ‚Ä¢ ${breakdownLabel}`;
          }
        }
      } else {
        if(storageUsageSummary){
          if(limitIsCustom){
            const descriptor = storageLimitSource === 'user' ? ' (usu√°rio)' : '';
            storageUsageSummary.textContent = `${usedLabel} de ${limitLabel}${descriptor} utilizados`;
          } else {
            storageUsageSummary.textContent = `${usedLabel} de ${limitLabel} (padr√£o) utilizados`;
          }
        }
        if(storageUsageHint){
          if(limitIsCustom){
            const remaining = Math.max(0, effectiveLimit - bytes);
            const remainingLabel = formatFileSize(remaining);
            if(remaining > 0){
              const base = sourceLabel
                ? `${remainingLabel} restantes ‚Ä¢ ${countLabel} ‚Ä¢ ${sourceLabel}`
                : `${remainingLabel} restantes ‚Ä¢ ${countLabel}`;
              storageUsageHint.textContent = breakdownLabel ? `${base} ‚Ä¢ ${breakdownLabel}` : base;
            } else {
              const base = sourceLabel
                ? `Limite atingido ‚Ä¢ ${countLabel} ‚Ä¢ ${sourceLabel}`
                : `Limite atingido ‚Ä¢ ${countLabel}`;
              storageUsageHint.textContent = breakdownLabel ? `${base} ‚Ä¢ ${breakdownLabel}` : base;
            }
          } else {
            storageUsageHint.textContent = `${countLabel} ‚Ä¢ Limite padr√£o de ${limitLabel} ‚Ä¢ ${breakdownLabel}`;
          }
        }
      }
      let level = 'ok';
      if(percentRaw >= 95){
        level = 'alert';
      } else if(percentRaw >= 80){
        level = 'warn';
      }
      storageUsage.dataset.level = level;
    }

    async function refreshStorageUsage(){
      const uid = getUserKey();
      const clientKey = getClientKey();
      const fetchId = ++storageUsageFetchToken;
      if(!uid || !clientKey){
        storageUsageBytes = 0;
        storageUsageCount = 0;
        storageUsageBreakdown = {
          files: 0,
          calendarMedia: 0,
          calendarNotes: 0,
          references: 0,
          notes: 0
        };
        storageUsageLoading = false;
        updateStorageUsageUI();
        return;
      }
      storageUsageLoading = true;
      updateStorageUsageUI();
      try{
        const folderIds = Array.isArray(FOLDERS)
          ? Array.from(new Set(FOLDERS.map(folder => folder?.id).filter(Boolean)))
          : [];
        let totalBytes = 0;
        let totalCount = 0;
        const breakdown = {
          files: 0,
          calendarMedia: 0,
          calendarNotes: 0,
          references: 0,
          notes: 0
        };
        let aggregatedRecent = [];
        if(folderIds.length){
          const results = await Promise.all(folderIds.map(async (folderId)=>{
            try{
              const filesCol = collection(db, 'usuarios', uid, 'clients', clientKey, 'fileFolders', folderId, 'files');
              const snap = await getDocs(filesCol);
              let folderBytes = 0;
              let folderCount = 0;
              const recentEntries = [];
              const folderLabel = getFolderLabel(folderId);
              snap.forEach(docSnap=>{
                folderCount += 1;
                const data = docSnap.data() || {};
                const sizeValue = Number(data.size);
                if(Number.isFinite(sizeValue) && sizeValue > 0){
                  folderBytes += sizeValue;
                }
                const created = normalizeDateValue(data.createdAt);
                recentEntries.push({
                  id: docSnap.id,
                  name: data.name || '',
                  createdAt: created ? created.getTime() : null,
                  folderId,
                  folderLabel
                });
              });
              return { bytes: folderBytes, count: folderCount, recent: recentEntries };
            }catch(err){
              console.warn('refreshStorageUsage folder', folderId, err);
              return { bytes: 0, count: 0, recent: [] };
            }
          }));
          if(fetchId !== storageUsageFetchToken){
            return;
          }
          results.forEach(({ bytes, count, recent })=>{
            totalBytes += bytes;
            totalCount += count;
            if(Array.isArray(recent)) aggregatedRecent.push(...recent);
          });
          breakdown.files = totalBytes;
          aggregatedRecent.sort((a,b)=> (Number(b?.createdAt) || 0) - (Number(a?.createdAt) || 0));
          recentFilesCache = aggregatedRecent.slice(0, 60);
        }else{
          recentFilesCache = [];
        }
        if(fetchId !== storageUsageFetchToken){
          return;
        }
        const calendarUsage = await computeCalendarStorageUsage(clientKey);
        if(fetchId !== storageUsageFetchToken){
          return;
        }
        if(calendarUsage){
          const mediaBytes = Number(calendarUsage.mediaBytes) || 0;
          const mediaCount = Number(calendarUsage.mediaCount) || 0;
          const notesBytes = Number(calendarUsage.notesBytes) || 0;
          const notesCount = Number(calendarUsage.notesCount) || 0;
          breakdown.calendarMedia = mediaBytes;
          breakdown.calendarNotes = notesBytes;
          totalBytes += (Number(calendarUsage.bytes) || mediaBytes + notesBytes);
          totalCount += mediaCount + notesCount;
        }
        const refUsage = await computeRefSocialStorageUsage();
        if(fetchId !== storageUsageFetchToken){
          return;
        }
        if(refUsage){
          const refBytes = Number(refUsage.bytes) || 0;
          const refCount = Number(refUsage.count) || 0;
          breakdown.references = refBytes;
          totalBytes += refBytes;
          totalCount += refCount;
        }
        const notesUsage = computeNotesStorageUsage();
        if(notesUsage){
          const notesBytes = Number(notesUsage.bytes) || 0;
          const notesCount = Number(notesUsage.count) || 0;
          breakdown.notes = notesBytes;
          totalBytes += notesBytes;
          totalCount += notesCount;
        }
        storageUsageBreakdown = breakdown;
        storageUsageBytes = totalBytes;
        storageUsageCount = totalCount;
      }catch(err){
        if(fetchId === storageUsageFetchToken){
          console.warn('refreshStorageUsage', err);
        }
      }finally{
        if(fetchId === storageUsageFetchToken){
          storageUsageLoading = false;
          updateStorageUsageUI();
          try{ refreshMacroInsights(); }catch(_){ }
        }
      }
    }

    updateStorageUsageUI();

    const fileDateFormatter = new Intl.DateTimeFormat('pt-BR', { dateStyle:'short', timeStyle:'short' });
    function normalizeDateValue(raw){
      if(!raw && raw !== 0) return null;
      if(raw instanceof Date) return Number.isFinite(raw.getTime()) ? raw : null;
      if(typeof raw === 'number'){
        const date = new Date(raw);
        return Number.isFinite(date.getTime()) ? date : null;
      }
      if(typeof raw === 'object' && raw !== null){
        if(typeof raw.toDate === 'function'){
          try{ return raw.toDate(); }catch(_){ return null; }
        }
        if(typeof raw.seconds === 'number'){
          const date = new Date(raw.seconds * 1000);
          return Number.isFinite(date.getTime()) ? date : null;
        }
      }
      return null;
    }

    function formatFileDate(raw){
      const date = normalizeDateValue(raw);
      return date ? fileDateFormatter.format(date) : '--';
    }

    function syncFilesViewToggle(){
      if(!filesViewToggle) return;
      const buttons = filesViewToggle.querySelectorAll('.view-btn');
      buttons.forEach(btn=>{
        const active = btn.dataset.mode === FILES_VIEW_MODE;
        btn.classList.toggle('active', active);
        btn.setAttribute('aria-pressed', active ? 'true' : 'false');
      });
    }

    syncFilesViewToggle();

    function setFilesViewMode(mode){
      const normalized = mode === 'grid' ? 'grid' : 'list';
      if(FILES_VIEW_MODE === normalized){
        syncFilesViewToggle();
        return;
      }
      FILES_VIEW_MODE = normalized;
      try{ localStorage.setItem(FILES_VIEW_STORAGE_KEY, normalized); }
      catch(_){ }
      syncFilesViewToggle();
      renderFilesList(CURRENT_FILES, { showFolder: viewingAllFiles });
    }

    function closeFilePreview(){
      if(!filePreviewModal) return;
      filePreviewModal.classList.remove('show');
      filePreviewModal.setAttribute('aria-hidden','true');
      if(filePreviewContent) filePreviewContent.innerHTML = '';
      if(filePreviewInfo) filePreviewInfo.innerHTML = '';
      delete filePreviewModal.dataset.fileId;
    }

    function openFilePreview(file){
      if(!filePreviewModal || !filePreviewContent || !filePreviewInfo) return;
      if(!file || !file.url) return;
      const name = file.name || 'Arquivo';
      const safeUrl = escapeAttr(file.url);
      const safeName = escapeHtml(name);
      let contentHtml = '';
      if(isImageFile(file)){
        contentHtml = `<img src="${safeUrl}" alt="${safeName}" crossorigin="anonymous">`;
      } else if(isVideoFile(file)){
        contentHtml = `<video src="${safeUrl}" controls playsinline crossorigin="anonymous"></video>`;
      } else {
        contentHtml = `<div class="file-preview-placeholder"><span>Pr√©-visualiza√ß√£o indispon√≠vel.<br><a href="${safeUrl}" target="_blank" rel="noopener">Abrir arquivo</a></span></div>`;
      }
      const typeLabelRaw = file.contentType ? String(file.contentType).split(';')[0] : (getFileExt(name) || '').toUpperCase() || 'Desconhecido';
      const downloadDisabled = Boolean(file.uploading) || !file.url;
      const deleteDisabled = Boolean(file.uploading);
      const renameDisabled = Boolean(file.uploading);
      const downloadAttr = downloadDisabled ? ' disabled' : '';
      const deleteAttr = deleteDisabled ? ' disabled' : '';
      const renameAttr = renameDisabled ? ' disabled' : '';
      const actionsMarkup = `
        <div class="file-preview-actions">
          <a class="btn small" href="${safeUrl}" target="_blank" rel="noopener">Abrir original</a>
          <button class="btn ghost small download-file" type="button"${downloadAttr}>Baixar</button>
          <button class="btn ghost small rename-file" type="button"${renameAttr}>Renomear</button>
          <button class="btn ghost small danger delete-file" type="button"${deleteAttr}>Excluir</button>
        </div>
      `;
      const infoMarkup = [
        `<div><strong>Nome</strong>${safeName}</div>`,
        `<div><strong>Adicionado em</strong>${escapeHtml(formatFileDate(file.createdAt))}</div>`,
        `<div><strong>Tamanho</strong>${escapeHtml(formatFileSize(file.size))}</div>`,
        `<div><strong>Tipo</strong>${escapeHtml(typeLabelRaw)}</div>`,
        actionsMarkup
      ].join('');
      filePreviewTitle && (filePreviewTitle.textContent = name);
      filePreviewContent.innerHTML = contentHtml;
      filePreviewInfo.innerHTML = infoMarkup;
      filePreviewModal.classList.add('show');
      filePreviewModal.setAttribute('aria-hidden','false');
      if(file.id){
        filePreviewModal.dataset.fileId = file.id;
      } else {
        delete filePreviewModal.dataset.fileId;
      }
    }

    filePreviewClose?.addEventListener('click', closeFilePreview);
    filePreviewModal?.addEventListener('click', (event)=>{
      if(event.target === filePreviewModal){
        closeFilePreview();
      }
    });
    filePreviewInfo?.addEventListener('click', (event)=>{
      const downloadBtn = event.target.closest('.download-file');
      if(downloadBtn){
        event.preventDefault();
        event.stopPropagation();
        const fileId = filePreviewModal?.dataset.fileId;
        if(fileId){
          handleFileDownload(fileId);
        }
        return;
      }
      const renameBtn = event.target.closest('.rename-file');
      if(renameBtn){
        event.preventDefault();
        event.stopPropagation();
        const fileId = filePreviewModal?.dataset.fileId;
        if(fileId){
          renameFileById(fileId);
        }
        return;
      }
      const deleteBtn = event.target.closest('.delete-file');
      if(deleteBtn){
        event.preventDefault();
        event.stopPropagation();
        const fileId = filePreviewModal?.dataset.fileId;
        if(fileId){
          deleteFileById(fileId);
        }
      }
    });
    document.addEventListener('keydown', (event)=>{
      if(event.key === 'Escape' && filePreviewModal?.classList.contains('show')){
        closeFilePreview();
      }
    });

    filesViewToggle?.addEventListener('click', (event)=>{
      const btn = event.target.closest('.view-btn');
      if(!btn) return;
      const mode = btn.dataset.mode;
      setFilesViewMode(mode);
    });

    viewAllFilesBtn?.addEventListener('click', async ()=>{
      if(FILES_UPLOAD_ACTIVE) return;
      if(viewingAllFiles){
        const targetFolder = lastSelectedFolder;
        selectFolder(targetFolder);
      } else {
        lastSelectedFolder = currentFolder;
        viewingAllFiles = true;
        updateFilesToolbar();
        await loadAllFiles();
      }
    });

    function getClientKey(){
      return (typeof window.TENANT === 'string' && window.TENANT) || document.body.getAttribute('data-client-id');
    }

    function getUserKey(){
      return auth.currentUser?.uid || null;
    }

    function requireAuthUser(){
      if(auth.currentUser){
        return Promise.resolve(auth.currentUser);
      }
      return new Promise((resolve, reject)=>{
        const unsubscribe = onAuthStateChanged(auth, (user)=>{
          unsubscribe();
          if(user){
            resolve(user);
          } else {
            reject(new Error('Usu√°rio n√£o autenticado.'));
          }
        }, (error)=>{
          unsubscribe();
          reject(error);
        });
      });
    }

    function getUserKeyCandidates(){
      const user = auth.currentUser;
      if(!user) return [];
      const keys = [];
      if(user.uid) keys.push(user.uid);
      if(user.email && user.email !== user.uid) keys.push(user.email);
      return keys;
    }

    function renderFiles(){
      loadFolders();
    }

    function getChildFolders(parentId){
      const target = normalizeParent(parentId);
      return FOLDERS.filter(f=> normalizeParent(f.parentId) === target)
        .sort((a,b)=> folderCollator.compare(a.name||'', b.name||''));
    }

    function getFolderTrail(id){
      const trail = [];
      let currentId = normalizeParent(id);
      const visited = new Set();
      while(currentId){
        if(visited.has(currentId)) break;
        visited.add(currentId);
        const folder = FOLDERS.find(f=>f.id===currentId);
        if(!folder) break;
        trail.push(folder);
        currentId = normalizeParent(folder.parentId);
      }
      return trail.reverse();
    }

    function formatFolderPath(id){
      const trail = getFolderTrail(id);
      return trail.map(f=>f.name).join(' ‚Ä∫ ');
    }

    function getFolderLabel(folderId){
      const normalized = normalizeParent(folderId);
      if(!normalized) return 'Arquivos';
      const path = formatFolderPath(normalized);
      if(path) return path;
      const folder = FOLDERS.find(f=>f.id===normalized);
      return folder?.name || 'Pasta';
    }

    function getFolderDescendants(id){
      const normalized = normalizeParent(id);
      if(!normalized) return [];
      const result = [];
      const stack = [normalized];
      const seen = new Set([normalized]);
      while(stack.length){
        const current = stack.pop();
        const children = FOLDERS.filter(f=> normalizeParent(f.parentId) === current);
        children.forEach(child=>{
          if(seen.has(child.id)) return;
          seen.add(child.id);
          result.push(child.id);
          stack.push(child.id);
        });
      }
      return result;
    }

    async function loadFolders(){
      const uid = getUserKey();
      const clientKey = getClientKey();
      if(!foldersList){ return; }
      if(!uid || !clientKey){
        FOLDERS = [];
        currentFolder = null;
        renderFolders();
        renderFolderContents([]);
        if(!uid){
          resetStorageUsageState({ loading: false });
        }
        return;
      }
      try{
        const col = collection(db, 'usuarios', uid, 'clients', clientKey, 'fileFolders');
        const snap = await getDocs(col);
        const fetchedFolders = snap.docs.map(d=>{
          const data = d.data() || {};
          return {
            id: d.id,
            name: data.name || 'Pasta sem nome',
            parentId: normalizeParent(data.parentId),
            createdAt: data.createdAt || null
          };
        });
        const ensuredFolders = await ensureDefaultRootFolders(uid, clientKey, fetchedFolders, col);
        FOLDERS = [...fetchedFolders, ...ensuredFolders];
      }catch(err){
        console.warn('loadFolders', err);
        FOLDERS = [];
      }
      if(currentFolder && !FOLDERS.some(f=>f.id===currentFolder)){
        currentFolder = null;
      }
      renderFolders();
      renderFolderContents(CURRENT_FILES);
      if(viewingAllFiles){
        await loadAllFiles();
      } else {
        await loadFiles();
      }
      await refreshStorageUsage();
    }

    function renderFolders(){
      if(!foldersList) return;
      const visited = new Set();
      const buildTree = (parentId, depth)=>{
        const children = getChildFolders(parentId).filter(folder=>{
          if(visited.has(folder.id)) return false;
          visited.add(folder.id);
          return true;
        });
        if(!children.length) return '';
        return children.map(folder=>{
          const isActive = (!viewingAllFiles && folder.id === currentFolder) ? ' active' : '';
          const depthValue = depth + 1;
          const safeName = escapeHtml(folder.name);
          return `
            <div class="folder-tree-item${isActive}" data-id="${folder.id}" style="--depth:${depthValue}">
              <span class="tree-icon">üìÅ</span>
              <span class="tree-label">${safeName}</span>
              <div class="folder-actions">
                <button class="folder-action rename-folder" type="button" data-id="${folder.id}" title="Renomear pasta">‚úèÔ∏è</button>
                <button class="folder-action move-folder" type="button" data-id="${folder.id}" title="Mover pasta">üîÄ</button>
                <button class="folder-action delete-folder" type="button" data-id="${folder.id}" title="Excluir pasta">üóëÔ∏è</button>
              </div>
            </div>
            ${buildTree(folder.id, depthValue)}
          `;
        }).join('');
      };
      const rootActive = (!viewingAllFiles && !currentFolder) ? ' active' : '';
      const treeMarkup = buildTree(null, 0);
      foldersList.innerHTML = `
        <div class="folder-tree-item${rootActive}" data-id="" style="--depth:0">
          <span class="tree-icon">üè†</span>
          <span class="tree-label">Arquivos</span>
        </div>
        ${treeMarkup || '<div class="folder-tree-empty">Nenhuma pasta criada.</div>'}
      `;
    }

    function renderFolderContents(files){
      CURRENT_FILES = Array.isArray(files) ? files : [];
      syncSelectionWithCurrentFiles();
      const childFolders = viewingAllFiles ? [] : getChildFolders(currentFolder);
      renderSubfolders(viewingAllFiles ? [] : childFolders);
      renderFilesList(CURRENT_FILES, { showFolder: viewingAllFiles });
      renderEmptyState(viewingAllFiles ? [] : childFolders, CURRENT_FILES);
      renderBreadcrumb();
      updateFilesToolbar();
    }

    function refreshFilesUi(){
      if(viewingAllFiles){
        renderSubfolders([]);
        renderFilesList(CURRENT_FILES, { showFolder: true });
        renderEmptyState([], CURRENT_FILES);
        renderBreadcrumb();
        return;
      }
      const childFolders = getChildFolders(currentFolder);
      renderSubfolders(childFolders);
      renderFilesList(CURRENT_FILES);
      renderEmptyState(childFolders, CURRENT_FILES);
      renderBreadcrumb();
    }

    const clampPercent = (value)=>{
      const num = Number(value);
      if(!Number.isFinite(num)) return 0;
      return Math.max(0, Math.min(100, num));
    };

    function showUploadProgress(percent, message){
      if(!uploadProgress) return;
      uploadProgress.classList.remove('hidden');
      const clamped = clampPercent(percent);
      if(uploadProgressBar){
        uploadProgressBar.style.width = `${clamped}%`;
      }
      if(uploadProgressPercent){
        uploadProgressPercent.textContent = `${clamped}%`;
      }
      if(uploadProgressText){
        uploadProgressText.textContent = message || '';
        if(message){
          uploadProgressText.title = message;
        } else {
          uploadProgressText.removeAttribute('title');
        }
      }
    }

    function hideUploadProgress(){
      if(!uploadProgress) return;
      uploadProgress.classList.add('hidden');
      if(uploadProgressBar){
        uploadProgressBar.style.width = '0%';
      }
      if(uploadProgressPercent){
        uploadProgressPercent.textContent = '';
      }
      if(uploadProgressText){
        uploadProgressText.textContent = '';
        uploadProgressText.removeAttribute('title');
      }
    }

    function renderSubfolders(children){
      if(!subfoldersGrid) return;
      if(!children.length){
        subfoldersGrid.innerHTML = '';
        subfoldersGrid.classList.add('hidden');
        return;
      }
      subfoldersGrid.classList.remove('hidden');
      subfoldersGrid.innerHTML = children.map(folder=>{
        const safeName = escapeHtml(folder.name);
        return `
        <div class="subfolder-card" data-id="${folder.id}">
          <div class="subfolder-icon">üìÅ</div>
          <div class="subfolder-name">${safeName}</div>
        </div>
      `;
      }).join('');
    }

    function renderFilesList(arr, options = {}){
      if(!filesList) return;
      const showFolder = Boolean(options.showFolder);
      if(!Array.isArray(arr) || !arr.length){
        filesList.innerHTML = '';
        filesList.classList.add('hidden');
        delete filesList.dataset.view;
        delete filesList.dataset.all;
        updateSelectionIndicators();
        return;
      }
      filesList.classList.remove('hidden');
      filesList.dataset.view = FILES_VIEW_MODE;
      filesList.dataset.all = showFolder ? 'true' : 'false';
      const rowsMarkup = arr.map((file, index)=>{
        const id = file.id || '';
        const name = file.name || '';
        const safeName = escapeHtml(name);
        const safeTitle = escapeAttr(name);
        const safeUrl = escapeAttr(file.url || '');
        const uploading = Boolean(file.uploading);
        const selected = id && SELECTED_FILES.has(id);
        const progressValue = clampPercent(file.progress ?? (uploading ? 0 : 100));
        const folderIdForFile = normalizeParent(file.folderId ?? currentFolder);
        const availableFolders = FOLDERS.filter(fl=>fl.id !== folderIdForFile);
        const optionsMarkup = availableFolders.map(fl=>{
          const label = getFolderLabel(fl.id);
          return `<option value="${fl.id}">${escapeHtml(label)}</option>`;
        }).join('');
        const baseSelectMarkup = availableFolders.length
          ? `<option value="">Mover para...</option>${optionsMarkup}`
          : '<option value="" disabled>Crie outra pasta para mover</option>';
        let thumb = '<span class="file-icon">üìÑ</span>';
        if(isImageFile(file)){
          thumb = `<img src="${safeUrl}" alt="${safeName}" crossorigin="anonymous">`;
        } else if(isVideoFile(file)){
          thumb = `<video src="${safeUrl}" muted playsinline preload="metadata" crossorigin="anonymous"></video>`;
        }
        const typeLabelRaw = file.contentType ? String(file.contentType).split(';')[0] : (getFileExt(name) || '').toUpperCase() || 'Arquivo';
        const safeType = escapeHtml(typeLabelRaw);
        const added = escapeHtml(formatFileDate(file.createdAt));
        const sizeLabel = escapeHtml(formatFileSize(file.size));
        const folderLabel = showFolder ? escapeHtml(file.folderLabel || getFolderLabel(folderIdForFile)) : '';
        const folderInfo = showFolder ? `<div class="file-folder">üìÅ ${folderLabel}</div>` : '';
        const statusHtml = uploading
          ? `<div class="file-status"><span>Enviando (${progressValue}%)</span><div class="file-status-bar"><div class="file-status-fill" style="width:${progressValue}%"></div></div></div>`
          : '';
        const moveDisabled = uploading || !availableFolders.length;
        const selectAttr = moveDisabled ? ' disabled' : '';
        const copyDisabled = uploading || !file.url;
        const downloadDisabled = uploading || !file.url;
        const deleteDisabled = uploading;
        const renameDisabled = uploading;
        const copyAttr = copyDisabled ? ' disabled' : '';
        const downloadAttr = downloadDisabled ? ' disabled' : '';
        const deleteAttr = deleteDisabled ? ' disabled' : '';
        const renameAttr = renameDisabled ? ' disabled' : '';
        const buttonsHtml = `<div class="file-action-buttons"><button class="btn ghost small copy-link" type="button"${copyAttr}>Copiar link</button><button class="btn ghost small download-file" type="button"${downloadAttr}>Baixar</button><button class="btn ghost small rename-file" type="button"${renameAttr}>Renomear</button><button class="btn ghost small danger delete-file" type="button"${deleteAttr}>Excluir</button></div>`;
        const moveHtml = `<div class="file-action-move"><select class="move-select"${selectAttr}>${baseSelectMarkup}</select></div>`;
        const actionsHtml = `<div class="file-actions">${buttonsHtml}${moveHtml}</div>`;
        const folderDataAttr = folderIdForFile ? ` data-folder="${escapeAttr(folderIdForFile)}"` : '';
        const checkboxAttr = selected ? ' checked' : '';
        const checkboxDisabled = uploading ? ' disabled' : '';
        const checkboxLabelAttr = escapeAttr(name ? `Selecionar ${name}` : 'Selecionar arquivo');
        const checkbox = `<label class="file-select-box${FILES_VIEW_MODE === 'grid' ? ' compact' : ''}"><input aria-label="${checkboxLabelAttr}" class="file-checkbox" data-id="${id}" data-index="${index}" type="checkbox"${checkboxAttr}${checkboxDisabled}>${FILES_VIEW_MODE === 'grid' ? '' : '<span class="file-select-label">Selecionar</span>'}</label>`;
        if(FILES_VIEW_MODE === 'grid'){
          const detailsHtml = `<div class="file-details"><span>${added}</span><span>${sizeLabel}</span><span>${safeType}</span></div>`;
          return `<div class="file-card file-entry${uploading ? ' uploading' : ''}${selected ? ' selected' : ''}" data-id="${id}"${folderDataAttr} title="${safeTitle}">${checkbox}<div class="file-thumb">${thumb}</div><div class="file-name">${safeName}</div>${folderInfo}${detailsHtml}${statusHtml}${actionsHtml}</div>`;
        }
        const infoParts = [`<div class="file-name">${safeName}</div>`];
        if(folderInfo) infoParts.push(folderInfo);
        infoParts.push(`<div class="file-type">${safeType}</div>`);
        if(statusHtml) infoParts.push(statusHtml);
        const infoHtml = infoParts.join('');
        return `<div class="files-table-row file-entry${uploading ? ' uploading' : ''}${selected ? ' selected' : ''}" data-id="${id}"${folderDataAttr} title="${safeTitle}"><div class="file-select-col">${checkbox}</div><div class="file-info"><div class="file-thumb">${thumb}</div><div class="file-text">${infoHtml}</div></div><div class="file-meta">${added}</div><div class="file-meta">${sizeLabel}</div>${actionsHtml}</div>`;
      }).join('');
      if(FILES_VIEW_MODE === 'grid'){
        filesList.innerHTML = `<div class="files-grid">${rowsMarkup}</div>`;
      } else {
        filesList.innerHTML = `<div class="files-table"><div class="files-table-head"><span class="file-select-head"></span><span>Arquivo</span><span>Adicionado</span><span>Tamanho</span><span>A√ß√µes</span></div><div class="files-table-body">${rowsMarkup}</div></div>`;
      }
      updateSelectionIndicators();
    }

    function syncSelectionWithCurrentFiles(){
      const validIds = new Set(CURRENT_FILES.map(file=>file.id).filter(Boolean));
      let changed = false;
      SELECTED_FILES.forEach(id=>{
        if(!validIds.has(id)){
          SELECTED_FILES.delete(id);
          changed = true;
        }
      });
      if(changed){
        LAST_SELECTED_INDEX = null;
      }
      updateSelectionIndicators();
    }

    function updateSelectionIndicators(){
      applySelectionToDom();
      updateSelectAllControl();
      updateBulkBar();
    }

    function applySelectionToDom(){
      if(!filesList) return;
      const entries = filesList.querySelectorAll('.file-entry');
      entries.forEach(entry=>{
        const id = entry.dataset.id;
        if(!id) return;
        const selected = SELECTED_FILES.has(id);
        entry.classList.toggle('selected', selected);
        const checkbox = entry.querySelector('.file-checkbox');
        if(checkbox){
          checkbox.checked = selected;
        }
      });
    }

    function updateSelectAllControl(){
      if(!filesSelectAll) return;
      const selectable = CURRENT_FILES.filter(file=>!file.uploading && file.id);
      const total = selectable.length;
      const selectedCount = selectable.filter(file=>SELECTED_FILES.has(file.id)).length;
      filesSelectAll.disabled = total === 0;
      filesSelectAll.checked = total > 0 && selectedCount === total;
      filesSelectAll.indeterminate = selectedCount > 0 && selectedCount < total;
    }

    function updateBulkBar(){
      if(!filesBulkBar) return;
      const selectedCount = SELECTED_FILES.size;
      const hasUndo = Boolean(LAST_UNDO_ACTION);
      const show = selectedCount > 0 || BULK_ACTION_RUNNING || hasUndo;
      filesBulkBar.classList.toggle('hidden', !show);
      if(filesBulkCount){
        if(selectedCount > 0){
          const plural = selectedCount > 1 ? 's' : '';
          filesBulkCount.textContent = `${selectedCount} arquivo${plural} selecionado${plural}`;
        } else if(hasUndo){
          filesBulkCount.textContent = 'A√ß√£o conclu√≠da';
        } else if(BULK_ACTION_RUNNING){
          filesBulkCount.textContent = 'Processando...';
        } else {
          filesBulkCount.textContent = '';
        }
      }
      if(filesBulkStatus){
        filesBulkStatus.textContent = BULK_STATUS_MESSAGE || '';
        filesBulkStatus.classList.toggle('hidden', !BULK_STATUS_MESSAGE);
      }
      if(filesBulkUndo){
        filesBulkUndo.classList.toggle('hidden', !hasUndo || BULK_ACTION_RUNNING);
        filesBulkUndo.disabled = BULK_ACTION_RUNNING;
      }
      const buttons = filesBulkBar.querySelectorAll('[data-action]');
      buttons.forEach(btn=>{
        btn.disabled = BULK_ACTION_RUNNING || selectedCount === 0;
      });
    }

    function setBulkStatus(message){
      BULK_STATUS_MESSAGE = message || '';
      updateBulkBar();
    }

    function clearBulkStatus(){
      setBulkStatus('');
    }

    function clearSelection(){
      SELECTED_FILES.clear();
      LAST_SELECTED_INDEX = null;
      updateSelectionIndicators();
    }

    function getSelectedFiles(){
      if(!SELECTED_FILES.size) return [];
      const map = new Map(CURRENT_FILES.map(file=>[file.id, file]));
      return Array.from(SELECTED_FILES).map(id=>map.get(id)).filter(Boolean);
    }

    function setUndoAction(action){
      LAST_UNDO_ACTION = action || null;
      updateBulkBar();
    }

    function handleFileSelectionToggle(checkbox, useShift){
      if(!checkbox) return;
      const fileId = checkbox.dataset.id;
      if(!fileId) return;
      if(checkbox.disabled){
        checkbox.checked = false;
        return;
      }
      const index = Number(checkbox.dataset.index);
      const shouldSelect = checkbox.checked;
      if(useShift && LAST_SELECTED_INDEX !== null && Number.isFinite(index)){
        const start = Math.min(LAST_SELECTED_INDEX, index);
        const end = Math.max(LAST_SELECTED_INDEX, index);
        for(let i = start; i <= end; i++){
          const file = CURRENT_FILES[i];
          if(!file || !file.id || file.uploading) continue;
          if(shouldSelect){
            SELECTED_FILES.add(file.id);
          } else {
            SELECTED_FILES.delete(file.id);
          }
        }
      } else {
        if(shouldSelect){
          SELECTED_FILES.add(fileId);
        } else {
          SELECTED_FILES.delete(fileId);
        }
      }
      if(Number.isFinite(index)){
        LAST_SELECTED_INDEX = index;
      }
      updateSelectionIndicators();
    }

    function renderEmptyState(children, files){
      if(!filesEmpty) return;
      let message = '';
      if(viewingAllFiles){
        message = files.length
          ? ''
          : 'Nenhum arquivo encontrado. Crie uma pasta e envie arquivos para come√ßar.';
      } else if(!currentFolder){
        message = children.length
          ? 'Selecione uma pasta na barra lateral ou clique em uma subpasta para visualizar os arquivos.'
          : 'Nenhuma pasta criada. Clique em "Nova pasta" para come√ßar.';
      } else if(!children.length && !files.length){
        message = 'Esta pasta est√° vazia. Utilize os bot√µes acima para adicionar arquivos ou criar subpastas.';
      } else if(!files.length){
        message = 'Nenhum arquivo nesta pasta.';
      }
      filesEmpty.textContent = message;
      filesEmpty.style.display = message ? 'block' : 'none';
    }

    function renderBreadcrumb(){
      if(!filesBreadcrumb) return;
      const parts = [];
      const isRoot = !currentFolder && !viewingAllFiles;
      parts.push(`<span class="crumb${isRoot ? ' current' : ''}" data-id="">Arquivos</span>`);
      if(viewingAllFiles){
        parts.push('<span class="crumb-sep">‚Ä∫</span>');
        parts.push(`<span class="crumb current" data-id="${ALL_FILES_CRUMB_ID}">Todos os arquivos</span>`);
      } else {
        const trail = getFolderTrail(currentFolder);
        trail.forEach((folder, idx)=>{
          parts.push('<span class="crumb-sep">‚Ä∫</span>');
          const isLast = idx === trail.length - 1;
          parts.push(`<span class="crumb${isLast ? ' current' : ''}" data-id="${folder.id}">${escapeHtml(folder.name)}</span>`);
        });
      }
      filesBreadcrumb.innerHTML = parts.join('');
    }

    function updateViewAllButton(){
      if(!viewAllFilesBtn) return;
      const label = viewingAllFiles ? 'Voltar para pastas' : 'Ver todos os arquivos';
      viewAllFilesBtn.textContent = label;
      viewAllFilesBtn.classList.toggle('active', viewingAllFiles);
      viewAllFilesBtn.setAttribute('aria-pressed', viewingAllFiles ? 'true' : 'false');
      viewAllFilesBtn.title = viewingAllFiles
        ? 'Voltar para a visualiza√ß√£o por pastas.'
        : 'Visualizar todos os arquivos de todas as pastas.';
      viewAllFilesBtn.disabled = FILES_UPLOAD_ACTIVE;
    }

    function updateFilesToolbar(){
      if(uploadFilesBtn){
        const disabled = viewingAllFiles || !currentFolder || FILES_UPLOAD_ACTIVE;
        uploadFilesBtn.disabled = disabled;
        if(FILES_UPLOAD_ACTIVE){
          uploadFilesBtn.textContent = 'Enviando...';
          uploadFilesBtn.title = 'Aguarde o envio terminar.';
        } else {
          uploadFilesBtn.textContent = 'Adicionar arquivos';
          if(viewingAllFiles){
            uploadFilesBtn.title = 'Saia do modo "Todos os arquivos" para enviar arquivos.';
          } else {
            uploadFilesBtn.title = currentFolder ? 'Adicionar arquivos' : 'Selecione uma pasta para enviar arquivos.';
          }
        }
      }
      if(newFolderBtn){
        newFolderBtn.textContent = currentFolder ? 'Nova subpasta' : 'Nova pasta';
      }
      updateViewAllButton();
      updateSelectAllControl();
      updateBulkBar();
    }

    function selectFolder(id){
      const normalized = normalizeParent(id);
      const wasViewingAll = viewingAllFiles;
      if(viewingAllFiles){
        viewingAllFiles = false;
        updateViewAllButton();
      }
      lastSelectedFolder = normalized;
      if(normalized === currentFolder && !wasViewingAll){
        renderFolderContents(CURRENT_FILES);
        return;
      }
      currentFolder = normalized;
      CURRENT_FILES = [];
      renderFolders();
      renderFolderContents([]);
      loadFiles();
    }

    foldersList?.addEventListener('click', e=>{
      const deleteBtn = e.target.closest('.delete-folder');
      if(deleteBtn){
        e.preventDefault();
        e.stopPropagation();
        deleteFolder(deleteBtn.dataset.id);
        return;
      }
      const moveBtn = e.target.closest('.move-folder');
      if(moveBtn){
        e.preventDefault();
        e.stopPropagation();
        moveFolder(moveBtn.dataset.id);
        return;
      }
      const renameBtn = e.target.closest('.rename-folder');
      if(renameBtn){
        e.preventDefault();
        e.stopPropagation();
        renameFolder(renameBtn.dataset.id);
        return;
      }
      const item = e.target.closest('.folder-tree-item');
      if(!item) return;
      selectFolder(item.dataset.id || null);
    });

    subfoldersGrid?.addEventListener('click', e=>{
      const card = e.target.closest('.subfolder-card');
      if(!card) return;
      selectFolder(card.dataset.id || null);
    });

    filesBreadcrumb?.addEventListener('click', e=>{
      const crumb = e.target.closest('.crumb');
      if(!crumb || crumb.classList.contains('current')) return;
      selectFolder(crumb.dataset.id || null);
    });

    async function renameFolder(id){
      const folder = FOLDERS.find(f=>f.id===id);
      if(!folder) return;
      const newName = (prompt('Renomear pasta:', folder.name)||'').trim();
      if(!newName || newName===folder.name) return;
      const uid = getUserKey();
      const clientKey = getClientKey();
      if(!uid || !clientKey) return;
      const ref = doc(db, 'usuarios', uid, 'clients', clientKey, 'fileFolders', id);
      await updateDoc(ref, { name: newName });
      folder.name = newName;
      renderFolders();
      renderFolderContents(CURRENT_FILES);
    }

    async function moveFolder(id){
      const folder = FOLDERS.find(f=>f.id===id);
      if(!folder) return;
      const uid = getUserKey();
      const clientKey = getClientKey();
      if(!uid || !clientKey){
        alert('Fa√ßa login para mover pastas.');
        return;
      }
      const blocked = new Set([id, ...getFolderDescendants(id)]);
      const options = [
        { id: '', label: 'Arquivos (raiz)' },
        ...FOLDERS.filter(fl=>!blocked.has(fl.id)).map(fl=>({ id: fl.id, label: getFolderLabel(fl.id) }))
      ];
      if(options.length <= 1){
        alert('Crie outra pasta antes de mover.');
        return;
      }
      const choice = prompt(
        'Mover para qual pasta? Digite o n√∫mero correspondente:\n' +
        options.map((opt, idx)=>`${idx} - ${opt.label}`).join('\n'),
        '0'
      );
      if(choice === null) return;
      const index = Number(choice.trim());
      if(!Number.isInteger(index) || index < 0 || index >= options.length){
        alert('Op√ß√£o inv√°lida.');
        return;
      }
      const target = options[index];
      const newParent = normalizeParent(target.id);
      if(normalizeParent(folder.parentId) === newParent){
        return;
      }
      try{
        const ref = doc(db, 'usuarios', uid, 'clients', clientKey, 'fileFolders', id);
        await updateDoc(ref, { parentId: newParent || null });
        folder.parentId = newParent;
        renderFolders();
        if(viewingAllFiles){
          await loadAllFiles();
        } else {
          renderFolderContents(CURRENT_FILES);
        }
      }catch(err){
        console.warn('moveFolder', err);
        alert('N√£o foi poss√≠vel mover a pasta.');
      }
    }

    async function deleteFolder(id){
      const folder = FOLDERS.find(f=>f.id===id);
      if(!folder) return;
      const confirmed = confirm(`Excluir a pasta "${folder.name}" e todo o conte√∫do? Esta a√ß√£o n√£o pode ser desfeita.`);
      if(!confirmed) return;
      const uid = getUserKey();
      const clientKey = getClientKey();
      if(!uid || !clientKey){
        alert('Fa√ßa login para excluir pastas.');
        return;
      }
      const targetIds = [id, ...getFolderDescendants(id)];
      try{
        for(const folderId of targetIds){
          try{
            const filesCol = collection(db, 'usuarios', uid, 'clients', clientKey, 'fileFolders', folderId, 'files');
            const snap = await getDocs(filesCol);
            for(const docSnap of snap.docs){
              const data = docSnap.data() || {};
              const storagePath = data.storagePath || `usuarios/${uid}/clients/${clientKey}/files/${folderId}/${data.name || ''}`;
              if(storagePath){
                try{
                  if(!STORAGE) STORAGE = getStorage(app);
                  await deleteObject(sRef(STORAGE, storagePath));
                }catch(storageErr){
                  console.warn('deleteFolder storage', storageErr);
                }
              }
              try{
                await deleteDoc(docSnap.ref);
              }catch(fileErr){
                console.warn('deleteFolder fileDoc', fileErr);
              }
            }
          }catch(filesErr){
            console.warn('deleteFolder files', filesErr);
          }
          try{
            await deleteDoc(doc(db, 'usuarios', uid, 'clients', clientKey, 'fileFolders', folderId));
          }catch(folderErr){
            console.warn('deleteFolder doc', folderErr);
          }
        }
      }catch(err){
        console.warn('deleteFolder', err);
        alert('N√£o foi poss√≠vel excluir a pasta.');
        return;
      }
      const removed = new Set(targetIds);
      FOLDERS = FOLDERS.filter(f=>!removed.has(f.id));
      if(removed.has(currentFolder)){
        currentFolder = null;
        CURRENT_FILES = [];
      }
      if(removed.has(lastSelectedFolder)){
        lastSelectedFolder = null;
      }
      renderFolders();
      if(viewingAllFiles){
        await loadAllFiles();
      } else if(currentFolder){
        await loadFiles();
      } else {
        renderFolderContents([]);
      }
      await refreshStorageUsage();
    }

    uploadFilesBtn?.addEventListener('click', ()=>{
      if(uploadFilesBtn.disabled || FILES_UPLOAD_ACTIVE) return;
      fileInput?.click();
    });
    fileInput?.addEventListener('change', ()=>{
      const selection = fileInput?.files ? Array.from(fileInput.files) : [];
      if(selection.length) uploadFiles(selection);
    });

    async function uploadFiles(fileList){
      if(!currentFolder){
        alert('Selecione uma pasta antes de enviar arquivos.');
        if(fileInput) fileInput.value = '';
        return;
      }
      const queue = Array.isArray(fileList) ? fileList : Array.from(fileList || []);
      if(!queue.length){
        if(fileInput) fileInput.value = '';
        return;
      }
      const tenantId = getClientKey();
      if(!tenantId){
        alert('Fa√ßa login para enviar arquivos.');
        if(fileInput) fileInput.value = '';
        return;
      }
      try{
        await requireAuthUser();
      }catch(authError){
        console.error('uploadFiles auth', authError);
        alert('Fa√ßa login para enviar arquivos.');
        if(fileInput) fileInput.value = '';
        return;
      }
      const authenticatedUser = auth.currentUser;
      if(!authenticatedUser || !authenticatedUser.uid){
        alert('Fa√ßa login para enviar arquivos.');
        if(fileInput) fileInput.value = '';
        return;
      }
      const userId = authenticatedUser.uid;
      if(FILES_UPLOAD_ACTIVE){
        if(fileInput) fileInput.value = '';
        return;
      }
      FILES_UPLOAD_ACTIVE = true;
      updateFilesToolbar();
      showUploadProgress(0, 'Preparando envio...');
      const folderPath = String(currentFolder || '').trim();
      const filesCol = collection(db, 'usuarios', userId, 'clients', tenantId, 'fileFolders', currentFolder, 'files');
      const totalBytes = queue.reduce((sum, file)=>{
        const size = Number(file?.size);
        if(Number.isFinite(size) && size > 0){
          return sum + size;
        }
        return sum;
      }, 0);
      const useBytes = totalBytes > 0;
      const totalFiles = queue.length;
      let completedBytes = 0;
      let completedFiles = 0;
      try{
        for(const file of queue){
          const activeUser = auth.currentUser;
          if(!activeUser || !activeUser.uid){
            throw new Error('Sess√£o expirada. Fa√ßa login novamente para enviar arquivos.');
          }
          const storagePath = `usuarios/${activeUser.uid}/clients/${tenantId}/files/${folderPath}/${file.name}`;
          if(!STORAGE){
            STORAGE = getStorage(app);
          }
          const ref = sRef(STORAGE, storagePath);
          const normalizedSize = (()=>{
            const size = Number(file?.size);
            return Number.isFinite(size) && size >= 0 ? size : null;
          })();
          const tempId = `temp-${Date.now()}-${Math.random().toString(36).slice(2,10)}`;
          let objectUrl = '';
          try{
            objectUrl = URL.createObjectURL(file);
            if(objectUrl){
              uploadingObjectUrls.set(tempId, objectUrl);
            }
          }catch(_){ }
          const folderLabel = getFolderLabel(currentFolder);
          const tempEntry = {
            id: tempId,
            name: file.name,
            url: objectUrl || '',
            createdAt: Date.now(),
            size: normalizedSize,
            contentType: file.type || '',
            storagePath,
            uploading: true,
            progress: 0,
            folderId: currentFolder,
            folderLabel
          };
          CURRENT_FILES = [...CURRENT_FILES, tempEntry];
          refreshFilesUi();
          const initialPercent = useBytes && totalBytes
            ? Math.round((completedBytes / totalBytes) * 100)
            : Math.round((completedFiles / totalFiles) * 100);
          showUploadProgress(initialPercent, 'Preparando envio...');
          const snapshot = await new Promise((resolve, reject)=>{
            const task = uploadBytesResumable(ref, file);
            task.on('state_changed', snap=>{
              const totalForFile = snap.totalBytes || (normalizedSize ?? 0);
              const bytesTransferred = snap.bytesTransferred;
              const fileTotal = totalForFile > 0 ? totalForFile : (bytesTransferred > 0 ? bytesTransferred : 0);
              if(fileTotal && (!Number.isFinite(tempEntry.size) || tempEntry.size === null)){
                tempEntry.size = fileTotal;
              }
              const fileProgress = totalForFile > 0
                ? Math.round((bytesTransferred / totalForFile) * 100)
                : (bytesTransferred ? 100 : 0);
              tempEntry.progress = fileProgress;
              const overallPercent = (()=>{
                if(useBytes){
                  const bytes = completedBytes + bytesTransferred;
                  return totalBytes ? Math.round((bytes / totalBytes) * 100) : fileProgress;
                }
                const denom = totalForFile > 0 ? totalForFile : 1;
                const fraction = bytesTransferred / denom;
                const percent = ((completedFiles + fraction) / totalFiles) * 100;
                return Math.round(percent);
              })();
              showUploadProgress(overallPercent, `Enviando ${file.name} (${fileProgress}%)`);
              refreshFilesUi();
            }, reject, ()=> resolve(task.snapshot));
          });
          const rawTotal = Number(snapshot.totalBytes);
          const fileTotal = Number.isFinite(rawTotal) && rawTotal >= 0 ? rawTotal : (normalizedSize ?? 0);
          if(useBytes){
            completedBytes += fileTotal;
          } else {
            completedFiles += 1;
          }
          const url = await getDownloadURL(snapshot.ref);
          const storedSize = Number.isFinite(fileTotal) && fileTotal >= 0 ? fileTotal : (normalizedSize ?? null);
          const docRef = await addDoc(filesCol, {
            name: file.name,
            url,
            createdAt: Date.now(),
            size: storedSize ?? null,
            contentType: file.type || '',
            storagePath
          });
          tempEntry.id = docRef.id;
          tempEntry.url = url;
          tempEntry.uploading = false;
          tempEntry.progress = 100;
          tempEntry.createdAt = Date.now();
          tempEntry.size = storedSize ?? tempEntry.size;
          const savedObjectUrl = uploadingObjectUrls.get(tempId);
          if(savedObjectUrl){
            try{ URL.revokeObjectURL(savedObjectUrl); }catch(_){ }
            uploadingObjectUrls.delete(tempId);
          }
          refreshFilesUi();
          const overallPercent = useBytes && totalBytes
            ? Math.round((completedBytes / totalBytes) * 100)
            : Math.round((completedFiles / totalFiles) * 100);
          const message = completedFiles === totalFiles ? 'Finalizando envio...' : `Enviando ${file.name} (100%)`;
          showUploadProgress(overallPercent, message);
        }
        showUploadProgress(100, 'Upload conclu√≠do!');
        if(viewingAllFiles){
          await loadAllFiles();
        } else {
          await loadFiles();
        }
        await refreshStorageUsage();
      }catch(err){
        console.error('uploadFiles', err);
        alert('Falha ao enviar arquivos: ' + (err?.message || String(err)));
        showUploadProgress(0, 'Falha ao enviar.');
        CURRENT_FILES = CURRENT_FILES.filter(file=>!file.uploading);
        refreshFilesUi();
      }finally{
        if(fileInput) fileInput.value = '';
        FILES_UPLOAD_ACTIVE = false;
        updateFilesToolbar();
        setTimeout(hideUploadProgress, 1500);
        uploadingObjectUrls.forEach(url=>{ try{ URL.revokeObjectURL(url); }catch(_){ } });
        uploadingObjectUrls.clear();
      }
    }

    async function loadFiles(){
      if(!filesList){ return; }
      if(!currentFolder){
        renderFolderContents([]);
        return;
      }
      const uid = getUserKey();
      const clientKey = getClientKey();
      if(!uid || !clientKey){
        renderFolderContents([]);
        return;
      }
      try{
        const col = collection(db, 'usuarios', uid, 'clients', clientKey, 'fileFolders', currentFolder, 'files');
        const snap = await getDocs(col);
        const files = snap.docs.map(docSnap=>{
          const data = docSnap.data() || {};
          let createdAt = data.createdAt;
          if(createdAt && typeof createdAt.toMillis === 'function'){
            try{ createdAt = createdAt.toMillis(); }
            catch(_){ createdAt = Date.now(); }
          } else if(createdAt && typeof createdAt.seconds === 'number'){
            createdAt = createdAt.seconds * 1000;
          }
          const sizeValue = Number(data.size);
          const normalizedSize = Number.isFinite(sizeValue) ? sizeValue : null;
          return {
            id: docSnap.id,
            ...data,
            name: data.name || '',
            url: data.url || '',
            createdAt: createdAt ?? null,
            size: normalizedSize,
            contentType: data.contentType || '',
            storagePath: data.storagePath || `usuarios/${uid}/clients/${clientKey}/files/${currentFolder}/${data.name || ''}`,
            folderId: currentFolder,
            folderLabel: getFolderLabel(currentFolder)
          };
        });
        files.sort((a,b)=> (a.name||'').localeCompare(b.name||'', 'pt-BR', { sensitivity:'base', numeric:true }));
        renderFolderContents(files);
      }catch(err){
        console.warn('loadFiles', err);
        renderFolderContents([]);
      }
    }

    async function loadAllFiles(){
      if(!filesList){ return; }
      const uid = getUserKey();
      const clientKey = getClientKey();
      if(!uid || !clientKey){
        renderFolderContents([]);
        return;
      }
      try{
        const aggregated = [];
        for(const folder of FOLDERS){
          const folderId = folder.id;
          const filesCol = collection(db, 'usuarios', uid, 'clients', clientKey, 'fileFolders', folderId, 'files');
          const snap = await getDocs(filesCol);
          const folderLabel = getFolderLabel(folderId);
          snap.docs.forEach(docSnap=>{
            const data = docSnap.data() || {};
            let createdAt = data.createdAt;
            if(createdAt && typeof createdAt.toMillis === 'function'){
              try{ createdAt = createdAt.toMillis(); }
              catch(_){ createdAt = Date.now(); }
            } else if(createdAt && typeof createdAt.seconds === 'number'){
              createdAt = createdAt.seconds * 1000;
            }
            const sizeValue = Number(data.size);
            const normalizedSize = Number.isFinite(sizeValue) ? sizeValue : null;
            aggregated.push({
              id: docSnap.id,
              ...data,
              name: data.name || '',
              url: data.url || '',
              createdAt: createdAt ?? null,
              size: normalizedSize,
              contentType: data.contentType || '',
              storagePath: data.storagePath || `usuarios/${uid}/clients/${clientKey}/files/${folderId}/${data.name || ''}`,
              folderId,
              folderLabel
            });
          });
        }
        aggregated.sort((a,b)=>{
          const folderCompare = (a.folderLabel||'').localeCompare(b.folderLabel||'', 'pt-BR', { sensitivity:'base', numeric:true });
          if(folderCompare !== 0) return folderCompare;
          return (a.name||'').localeCompare(b.name||'', 'pt-BR', { sensitivity:'base', numeric:true });
        });
        if(!viewingAllFiles){
          return;
        }
        renderFolderContents(aggregated);
      }catch(err){
        console.warn('loadAllFiles', err);
        renderFolderContents([]);
      }
    }

    filesList?.addEventListener('keydown', e=>{
      if(e.target.classList?.contains('file-checkbox') && (e.key === ' ' || e.key === 'Spacebar')){
        LAST_BULK_SHIFT = e.shiftKey;
      }
    });

    filesList?.addEventListener('change', e=>{
      const checkbox = e.target.closest?.('.file-checkbox');
      if(checkbox){
        handleFileSelectionToggle(checkbox, LAST_BULK_SHIFT);
        LAST_BULK_SHIFT = false;
        return;
      }
      if(e.target.classList.contains('move-select')){
        const item = e.target.closest('.file-entry');
        const target = e.target.value;
        if(target && item){
          moveFile(item, target);
        }
        e.target.value = '';
      }
    });

    filesSelectAll?.addEventListener('change', e=>{
      const shouldSelect = Boolean(e.target.checked);
      if(shouldSelect){
        CURRENT_FILES.forEach((file, idx)=>{
          if(file && file.id && !file.uploading){
            SELECTED_FILES.add(file.id);
            LAST_SELECTED_INDEX = idx;
          }
        });
      } else {
        CURRENT_FILES.forEach(file=>{
          if(file && file.id){
            SELECTED_FILES.delete(file.id);
          }
        });
        LAST_SELECTED_INDEX = null;
      }
      updateSelectionIndicators();
    });

    filesList?.addEventListener('click', e=>{
      if(e.target.closest('.file-select-box')){
        e.stopPropagation();
      }
      const checkbox = e.target.closest('.file-checkbox');
      if(checkbox){
        e.stopPropagation();
        handleFileSelectionToggle(checkbox, e.shiftKey);
        return;
      }
      const copyBtn = e.target.closest('.copy-link');
      if(copyBtn){
        e.preventDefault();
        e.stopPropagation();
        const item = e.target.closest('.file-entry');
        const fileId = item?.dataset.id;
        if(fileId){
          copyFileLink(fileId);
        }
        return;
      }
      const downloadBtn = e.target.closest('.download-file');
      if(downloadBtn){
        e.preventDefault();
        e.stopPropagation();
        const item = e.target.closest('.file-entry');
        const fileId = item?.dataset.id;
        if(fileId){
          handleFileDownload(fileId);
        }
        return;
      }
      const renameBtn = e.target.closest('.rename-file');
      if(renameBtn){
        e.preventDefault();
        e.stopPropagation();
        const item = e.target.closest('.file-entry');
        const fileId = item?.dataset.id;
        if(fileId){
          renameFileById(fileId);
        }
        return;
      }
      const deleteBtn = e.target.closest('.delete-file');
      if(deleteBtn){
        e.preventDefault();
        e.stopPropagation();
        const item = e.target.closest('.file-entry');
        const fileId = item?.dataset.id;
        if(fileId){
          deleteFileById(fileId);
        }
        return;
      }
      if(e.target.closest('.move-select')) return;
      if(e.target.closest('.file-actions')) return;
      const item = e.target.closest('.file-entry');
      if(!item) return;
      const fileId = item.dataset.id;
      if(!fileId) return;
      const file = CURRENT_FILES.find(f=>f.id === fileId);
      if(file){
        openFilePreview(file);
      }
    });

    filesBulkBar?.addEventListener('click', async e=>{
      const btn = e.target.closest('[data-action]');
      if(!btn || btn.disabled) return;
      e.preventDefault();
      const action = btn.dataset.action;
      if(action === 'delete'){
        await performBulkDelete(getSelectedFiles());
      } else if(action === 'move'){
        await promptBulkMove();
      } else if(action === 'rename'){
        await promptBulkRename();
      }
    });

    filesBulkUndo?.addEventListener('click', async ()=>{
      if(!LAST_UNDO_ACTION || BULK_ACTION_RUNNING) return;
      BULK_ACTION_RUNNING = true;
      setBulkStatus('Desfazendo...');
      try{
        await LAST_UNDO_ACTION.handler();
        if(typeof mgToast === 'function'){
          mgToast('A√ß√£o desfeita.');
        }
        setUndoAction(null);
        if(viewingAllFiles){
          await loadAllFiles();
        } else {
          await loadFiles();
        }
        await refreshStorageUsage();
      }catch(err){
        console.warn('bulkUndo', err);
        alert('N√£o foi poss√≠vel desfazer a a√ß√£o. Verifique o console.');
      }finally{
        BULK_ACTION_RUNNING = false;
        clearBulkStatus();
        updateSelectionIndicators();
      }
    });

    async function copyFileLink(fileId){
      const file = findFileById(fileId);
      if(!file){
        alert('Arquivo n√£o encontrado.');
        return;
      }
      if(file.uploading){
        alert('Aguarde o envio terminar para copiar o link deste arquivo.');
        return;
      }
      if(!file.url){
        alert('Link indispon√≠vel para este arquivo.');
        return;
      }
      // Usar fun√ß√£o robusta de clipboard com fallback para iframes
      const copiado = await mgCopyToClipboard(file.url);
      if(copiado){
        alert('Link copiado com sucesso!');
      } else {
        alert('N√£o foi poss√≠vel copiar o link do arquivo.');
      }
    }

    function findFileById(fileId){
      if(!fileId) return null;
      return CURRENT_FILES.find(f=>f.id === fileId) || null;
    }

    function handleFileDownload(fileId){
      const file = findFileById(fileId);
      if(!file){
        alert('Arquivo n√£o encontrado.');
        return;
      }
      if(file.uploading){
        alert('Aguarde o envio terminar para baixar este arquivo.');
        return;
      }
      if(!file.url){
        alert('URL do arquivo indispon√≠vel para download.');
        return;
      }
      try{
        const link = document.createElement('a');
        link.href = file.url;
        link.target = '_blank';
        link.rel = 'noopener';
        if(file.name){
          link.download = file.name;
        }
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        setTimeout(()=>{
          document.body.removeChild(link);
        }, 0);
      }catch(err){
        console.warn('handleFileDownload', err);
        alert('N√£o foi poss√≠vel iniciar o download do arquivo.');
      }
    }

    async function deleteFileRecord(file, uid, clientKey){
      const folderId = normalizeParent(file.folderId ?? currentFolder);
      if(!folderId){
        throw new Error('Pasta do arquivo n√£o encontrada.');
      }
      const storagePath = file.storagePath || `usuarios/${uid}/clients/${clientKey}/files/${folderId}/${file.name || ''}`;
      if(storagePath){
        try{
          if(!STORAGE){
            STORAGE = getStorage(app);
          }
          const storageRef = sRef(STORAGE, storagePath);
          await deleteObject(storageRef);
        }catch(err){
          console.warn('deleteFileRecord storage', err);
        }
      }
      const docRef = doc(db, 'usuarios', uid, 'clients', clientKey, 'fileFolders', folderId, 'files', file.id);
      await deleteDoc(docRef);
    }

    async function restoreDeletedFile(file, blob, uid, clientKey){
      const folderId = normalizeParent(file.folderId ?? currentFolder);
      if(!folderId){
        throw new Error('Pasta original do arquivo n√£o localizada.');
      }
      if(!blob){
        throw new Error('N√£o foi poss√≠vel restaurar o arquivo, conte√∫do indispon√≠vel.');
      }
      if(!STORAGE){
        STORAGE = getStorage(app);
      }
      const storagePath = file.storagePath || `usuarios/${uid}/clients/${clientKey}/files/${folderId}/${file.name || ''}`;
      const storageRef = sRef(STORAGE, storagePath);
      await uploadBytes(storageRef, blob);
      const url = await getDownloadURL(storageRef);
      const docRef = doc(db, 'usuarios', uid, 'clients', clientKey, 'fileFolders', folderId, 'files', file.id);
      const payload = {
        name: file.name || '',
        url,
        createdAt: file.createdAt ?? Date.now(),
        size: Number.isFinite(file.size) ? file.size : (typeof blob.size === 'number' ? blob.size : null),
        contentType: file.contentType || blob.type || '',
        storagePath,
        folderId: file.folderId ?? folderId
      };
      await setDoc(docRef, payload);
    }

    async function fetchFileBlob(file){
      if(!file || !file.url){
        throw new Error('Arquivo sem URL dispon√≠vel.');
      }
      const response = await fetch(file.url);
      if(!response.ok){
        throw new Error(`Falha ao acessar o arquivo (${response.status}).`);
      }
      return await response.blob();
    }

    async function performBulkDelete(files, options = {}){
      const list = Array.isArray(files) ? files.filter(Boolean) : [];
      if(!list.length){
        alert('Nenhum arquivo selecionado.');
        return;
      }
      const ready = list.filter(file=>!file.uploading);
      if(!ready.length){
        alert('Aguarde o envio terminar para excluir arquivos.');
        return;
      }
      if(ready.length !== list.length){
        alert('Arquivos em envio foram ignorados na exclus√£o.');
      }
      const confirmMessage = options.confirmMessage
        || (ready.length === 1
          ? `Excluir o arquivo "${ready[0].name || 'arquivo'}"? Esta a√ß√£o n√£o pode ser desfeita.`
          : `Excluir ${ready.length} arquivos selecionados? Esta a√ß√£o n√£o pode ser desfeita.`);
      if(!options.skipConfirm){
        const confirmed = confirm(confirmMessage);
        if(!confirmed) return;
      }
      const uid = getUserKey();
      const clientKey = getClientKey();
      if(!uid || !clientKey){
        alert('Fa√ßa login para excluir arquivos.');
        return;
      }
      try{
        await requireAuthUser();
      }catch(err){
        console.warn('performBulkDelete auth', err);
        alert('Fa√ßa login para excluir arquivos.');
        return;
      }
      BULK_ACTION_RUNNING = true;
      setBulkStatus('Preparando exclus√£o...');
      const backups = [];
      for(let i = 0; i < ready.length; i++){
        const file = ready[i];
        let blob = null;
        try{
          setBulkStatus(`Salvando c√≥pia ${i + 1}/${ready.length}...`);
          blob = await fetchFileBlob(file);
        }catch(err){
          console.warn('performBulkDelete fetch', err);
        }
        backups.push({ file, blob });
      }
      const errors = [];
      for(let i = 0; i < ready.length; i++){
        const file = ready[i];
        setBulkStatus(`Excluindo ${i + 1}/${ready.length}...`);
        try{
          await deleteFileRecord(file, uid, clientKey);
          SELECTED_FILES.delete(file.id);
        }catch(err){
          console.warn('performBulkDelete delete', err);
          errors.push({ file, error: err });
        }
      }
      BULK_ACTION_RUNNING = false;
      clearBulkStatus();
      updateSelectionIndicators();
      if(errors.length){
        alert('Alguns arquivos n√£o puderam ser exclu√≠dos. Verifique o console para detalhes.');
      } else if(ready.length){
        if(typeof mgToast === 'function'){
          mgToast(ready.length > 1 ? 'Arquivos exclu√≠dos.' : 'Arquivo exclu√≠do.');
        }
      }
      const restorable = backups.filter(entry=>entry.file && entry.file.id && entry.blob);
      if(restorable.length){
        setUndoAction({
          label: 'delete',
          async handler(){
            const undoUid = getUserKey();
            const undoClient = getClientKey();
            if(!undoUid || !undoClient){
              throw new Error('Fa√ßa login para desfazer.');
            }
            try{
              await requireAuthUser();
            }catch(err){
              throw err;
            }
            for(let i = 0; i < restorable.length; i++){
              const { file, blob } = restorable[i];
              setBulkStatus(`Restaurando ${i + 1}/${restorable.length}...`);
              await restoreDeletedFile(file, blob, undoUid, undoClient);
            }
          }
        });
      } else {
        setUndoAction(null);
      }
      if(filePreviewModal?.dataset.fileId && ready.some(f=>f.id === filePreviewModal.dataset.fileId)){
        closeFilePreview();
      }
      if(viewingAllFiles){
        await loadAllFiles();
      } else {
        await loadFiles();
      }
      await refreshStorageUsage();
      clearBulkStatus();
    }

    function chooseDestinationFolder(){
      const options = FOLDERS.map(folder=>({ id: folder.id, label: getFolderLabel(folder.id) }))
        .filter(opt=>opt.id)
        .sort((a,b)=> a.label.localeCompare(b.label, 'pt-BR', { sensitivity:'base', numeric:true }));
      if(!options.length){
        alert('Crie outra pasta antes de mover arquivos.');
        return null;
      }
      const message = 'Mover para qual pasta? Digite o n√∫mero correspondente:\n'
        + options.map((opt, idx)=>`${idx} - ${opt.label}`).join('\n');
      const input = prompt(message, '0');
      if(input === null) return null;
      const index = Number(input.trim());
      if(!Number.isInteger(index) || index < 0 || index >= options.length){
        alert('Op√ß√£o inv√°lida.');
        return null;
      }
      return options[index].id;
    }

    async function getExistingNamesInFolder(folderId, uid, clientKey){
      const colRef = collection(db, 'usuarios', uid, 'clients', clientKey, 'fileFolders', folderId, 'files');
      const snap = await getDocs(colRef);
      return snap.docs.map(docSnap=>((docSnap.data()?.name || '').trim().toLowerCase())).filter(Boolean);
    }

    async function moveFileToFolder(file, blob, uid, clientKey, destinationFolderId){
      const sourceFolderId = normalizeParent(file.folderId ?? currentFolder);
      const destId = normalizeParent(destinationFolderId);
      if(!destId || !sourceFolderId){
        throw new Error('Pasta inv√°lida para movimenta√ß√£o.');
      }
      if(!blob){
        throw new Error('Conte√∫do do arquivo indispon√≠vel.');
      }
      if(!STORAGE){
        STORAGE = getStorage(app);
      }
      const newPath = `usuarios/${uid}/clients/${clientKey}/files/${destId}/${file.name || ''}`;
      const newRef = sRef(STORAGE, newPath);
      await uploadBytes(newRef, blob);
      const newUrl = await getDownloadURL(newRef);
      const docRef = doc(db, 'usuarios', uid, 'clients', clientKey, 'fileFolders', destId, 'files', file.id);
      const payload = {
        name: file.name || '',
        url: newUrl,
        createdAt: file.createdAt ?? Date.now(),
        size: Number.isFinite(file.size) ? file.size : (typeof blob.size === 'number' ? blob.size : null),
        contentType: file.contentType || blob.type || '',
        storagePath: newPath,
        folderId: destId
      };
      await setDoc(docRef, payload);
      const oldPath = file.storagePath || `usuarios/${uid}/clients/${clientKey}/files/${sourceFolderId}/${file.name || ''}`;
      try{
        const oldRef = sRef(STORAGE, oldPath);
        await deleteObject(oldRef);
      }catch(err){
        console.warn('moveFileToFolder delete old', err);
      }
      const oldDoc = doc(db, 'usuarios', uid, 'clients', clientKey, 'fileFolders', sourceFolderId, 'files', file.id);
      await deleteDoc(oldDoc);
      return { storagePath: newPath, url: newUrl, oldPath, destinationFolderId: destId, sourceFolderId };
    }

    async function performBulkMove(files, destinationFolderId){
      const list = Array.isArray(files) ? files.filter(file=>file && !file.uploading) : [];
      if(!list.length){
        alert('Selecione arquivos v√°lidos para mover.');
        return;
      }
      const destId = normalizeParent(destinationFolderId);
      if(!destId){
        alert('Escolha uma pasta v√°lida para mover.');
        return;
      }
      const uid = getUserKey();
      const clientKey = getClientKey();
      if(!uid || !clientKey){
        alert('Fa√ßa login para mover arquivos.');
        return;
      }
      try{
        await requireAuthUser();
      }catch(err){
        console.warn('performBulkMove auth', err);
        alert('Fa√ßa login para mover arquivos.');
        return;
      }
      const movable = list.filter(file=>normalizeParent(file.folderId ?? currentFolder) !== destId);
      if(!movable.length){
        alert('Os arquivos selecionados j√° est√£o nessa pasta.');
        return;
      }
      BULK_ACTION_RUNNING = true;
      setBulkStatus('Validando destino...');
      const existingNames = new Set(await getExistingNamesInFolder(destId, uid, clientKey));
      const executed = [];
      const errors = [];
      for(let i = 0; i < movable.length; i++){
        const file = movable[i];
        const nameKey = (file.name || '').trim().toLowerCase();
        if(existingNames.has(nameKey)){
          errors.push({ file, error: new Error('Arquivo duplicado no destino.') });
          continue;
        }
        setBulkStatus(`Movendo ${i + 1}/${movable.length}...`);
        try{
          const blob = await fetchFileBlob(file);
          const result = await moveFileToFolder(file, blob, uid, clientKey, destId);
          existingNames.add(nameKey);
          executed.push({ file, blob, result });
          SELECTED_FILES.delete(file.id);
        }catch(err){
          console.warn('performBulkMove item', err);
          errors.push({ file, error: err });
        }
      }
      BULK_ACTION_RUNNING = false;
      clearBulkStatus();
      updateSelectionIndicators();
      if(errors.length && errors.length === movable.length){
        alert('N√£o foi poss√≠vel mover os arquivos selecionados. Verifique o console.');
      } else if(errors.length){
        alert('Alguns arquivos n√£o foram movidos. Verifique o console.');
      } else if(executed.length){
        if(typeof mgToast === 'function'){
          mgToast(executed.length > 1 ? 'Arquivos movidos.' : 'Arquivo movido.');
        }
      }
      if(executed.length){
        setUndoAction({
          label: 'move',
          async handler(){
            const undoUid = getUserKey();
            const undoClient = getClientKey();
            if(!undoUid || !undoClient){
              throw new Error('Fa√ßa login para desfazer.');
            }
            await requireAuthUser();
            for(let i = 0; i < executed.length; i++){
              const entry = executed[i];
              setBulkStatus(`Restaurando ${i + 1}/${executed.length}...`);
              const payloadFile = {
                ...entry.file,
                folderId: entry.result.destinationFolderId,
                storagePath: entry.result.storagePath,
                url: entry.result.url
              };
              await moveFileToFolder(payloadFile, entry.blob, undoUid, undoClient, entry.result.sourceFolderId);
            }
          }
        });
      } else {
        setUndoAction(null);
      }
      if(viewingAllFiles){
        await loadAllFiles();
      } else {
        await loadFiles();
      }
      await refreshStorageUsage();
      clearBulkStatus();
    }

    async function promptBulkMove(){
      const files = getSelectedFiles();
      if(!files.length){
        alert('Selecione arquivos para mover.');
        return;
      }
      const destination = chooseDestinationFolder();
      if(!destination) return;
      await performBulkMove(files, destination);
    }

    async function performBulkRename(files, pattern){
      const list = Array.isArray(files) ? files.filter(file=>file && !file.uploading) : [];
      if(!list.length){
        alert('Selecione arquivos v√°lidos para renomear.');
        return;
      }
      const trimmedPattern = (pattern || '').trim();
      if(!trimmedPattern){
        alert('Informe um nome v√°lido.');
        return;
      }
      const total = list.length;
      const padLength = String(total).length;
      const usesSequence = trimmedPattern.includes('{n}');
      const renameMap = [];
      for(let i = 0; i < total; i++){
        const file = list[i];
        const originalName = file.name || '';
        let baseName = trimmedPattern;
        if(total > 1){
          if(usesSequence){
            const seq = String(i + 1).padStart(padLength, '0');
            baseName = trimmedPattern.replace(/\{n\}/gi, seq);
          } else {
            baseName = `${trimmedPattern} (${i + 1})`;
          }
        }
        const { name: desiredName, error } = buildRenamedFileName(baseName, originalName);
        if(error === 'empty' || !desiredName){
          alert('Informe um nome v√°lido para os arquivos.');
          return;
        }
        if(error === 'extension'){
          alert('N√£o √© permitido alterar a extens√£o do arquivo.');
          return;
        }
        renameMap.push({ file, newName: desiredName });
      }
      const seenKeys = new Set();
      for(const entry of renameMap){
        const folderId = normalizeParent(entry.file.folderId ?? currentFolder) || 'root';
        const key = `${folderId}::${entry.newName.trim().toLowerCase()}`;
        if(seenKeys.has(key)){
          alert('Os nomes gerados entram em conflito entre si. Ajuste o padr√£o informado.');
          return;
        }
        seenKeys.add(key);
      }
      const conflict = renameMap.find(entry=>{
        const folderId = normalizeParent(entry.file.folderId ?? currentFolder);
        const nameKey = entry.newName.trim().toLowerCase();
        return CURRENT_FILES.some(other=>{
          if(other.id === entry.file.id) return false;
          const otherFolder = normalizeParent(other.folderId ?? currentFolder);
          if(otherFolder !== folderId) return false;
          return (other.name || '').trim().toLowerCase() === nameKey;
        });
      });
      if(conflict){
        alert(`J√° existe um arquivo chamado "${conflict.newName}" na pasta de destino.`);
        return;
      }
      const uid = getUserKey();
      const clientKey = getClientKey();
      if(!uid || !clientKey){
        alert('Fa√ßa login para renomear arquivos.');
        return;
      }
      try{
        await requireAuthUser();
      }catch(err){
        console.warn('performBulkRename auth', err);
        alert('Fa√ßa login para renomear arquivos.');
        return;
      }
      const previewOpenId = (filePreviewModal && filePreviewModal.classList.contains('show'))
        ? (filePreviewModal.dataset.fileId || null)
        : null;
      BULK_ACTION_RUNNING = true;
      setBulkStatus('Renomeando arquivos...');
      const executed = [];
      for(let i = 0; i < renameMap.length; i++){
        const { file, newName } = renameMap[i];
        setBulkStatus(`Renomeando ${i + 1}/${renameMap.length}...`);
        try{
          const folderId = normalizeParent(file.folderId ?? currentFolder);
          if(!folderId){
            throw new Error('Pasta n√£o encontrada para o arquivo.');
          }
          const docRef = doc(db, 'usuarios', uid, 'clients', clientKey, 'fileFolders', folderId, 'files', file.id);
          const previousName = file.name || '';
          await updateDoc(docRef, { name: newName });
          file.name = newName;
          executed.push({ file, oldName: previousName, newName, folderId });
        }catch(err){
          console.warn('performBulkRename item', err);
          alert('N√£o foi poss√≠vel renomear um dos arquivos. Verifique o console.');
          BULK_ACTION_RUNNING = false;
          clearBulkStatus();
          updateSelectionIndicators();
          return;
        }
      }
      BULK_ACTION_RUNNING = false;
      clearBulkStatus();
      updateSelectionIndicators();
      if(executed.length){
        if(typeof mgToast === 'function'){
          mgToast(executed.length > 1 ? 'Arquivos renomeados.' : 'Arquivo renomeado.');
        }
        setUndoAction({
          label: 'rename',
          async handler(){
            const undoUid = getUserKey();
            const undoClient = getClientKey();
            if(!undoUid || !undoClient){
              throw new Error('Fa√ßa login para desfazer.');
            }
            await requireAuthUser();
            for(let i = 0; i < executed.length; i++){
              const entry = executed[i];
              setBulkStatus(`Restaurando ${i + 1}/${executed.length}...`);
              const docRef = doc(db, 'usuarios', undoUid, 'clients', undoClient, 'fileFolders', entry.folderId, 'files', entry.file.id);
              await updateDoc(docRef, { name: entry.oldName });
              entry.file.name = entry.oldName;
            }
          }
        });
      } else {
        setUndoAction(null);
      }
      if(viewingAllFiles){
        await loadAllFiles();
      } else {
        await loadFiles();
      }
      if(previewOpenId){
        const updated = findFileById(previewOpenId);
        if(updated){
          openFilePreview(updated);
        } else if(filePreviewModal?.classList.contains('show')){
          closeFilePreview();
        }
      }
    }

    async function promptBulkRename(preselected){
      const files = Array.isArray(preselected) && preselected.length ? preselected : getSelectedFiles();
      if(!files.length){
        alert('Selecione arquivos para renomear.');
        return;
      }
      const ready = files.filter(file=>!file.uploading);
      if(!ready.length){
        alert('Aguarde o envio terminar para renomear estes arquivos.');
        return;
      }
      const defaultValue = ready.length === 1 ? (ready[0].name || '') : '';
      const message = ready.length === 1
        ? 'Novo nome para o arquivo:'
        : 'Novo nome base. Use {n} para inserir numera√ß√£o sequencial:';
      const input = prompt(message, defaultValue);
      if(input === null) return;
      await performBulkRename(ready, input);
    }

    async function deleteFileById(fileId){
      const file = findFileById(fileId);
      if(!file){
        alert('Arquivo n√£o encontrado.');
        return;
      }
      if(file.uploading){
        alert('Aguarde o envio terminar para excluir este arquivo.');
        return;
      }
      await performBulkDelete([file]);
    }

    function buildRenamedFileName(rawInput, originalName){
      const cleaned = (rawInput ?? '').replace(/[\\/:*?"<>|]/g,'_').trim();
      if(!cleaned){
        return { name: '', error: 'empty' };
      }
      const original = String(originalName || '');
      const dotIndex = original.lastIndexOf('.');
      const originalExt = dotIndex > -1 ? original.slice(dotIndex + 1) : '';
      if(!originalExt){
        return { name: cleaned, error: null };
      }
      const lowerOriginalExt = originalExt.toLowerCase();
      const lastDot = cleaned.lastIndexOf('.');
      if(lastDot > -1){
        const inputExt = cleaned.slice(lastDot + 1);
        if(inputExt.toLowerCase() !== lowerOriginalExt){
          return { name: '', error: 'extension' };
        }
        return { name: cleaned, error: null };
      }
      return { name: `${cleaned}.${originalExt}`, error: null };
    }

    async function renameFileById(fileId){
      const file = findFileById(fileId);
      if(!file){
        alert('Arquivo n√£o encontrado.');
        return;
      }
      if(file.uploading){
        alert('Aguarde o envio terminar para renomear este arquivo.');
        return;
      }
      await promptBulkRename([file]);
    }

    async function moveFile(item, targetFolder){
      const fileId = item.dataset.id;
      if(!fileId) return;
      const file = CURRENT_FILES.find(f=>f.id === fileId);
      if(!file) return;
      await performBulkMove([file], targetFolder);
    }

    newFolderBtn?.addEventListener('click', createFolder);

    async function createFolder(){
      const name = (prompt('Nome da pasta:')||'').trim();
      if(!name) return;
      const uid = getUserKey();
      const clientKey = getClientKey();
      if(!uid || !clientKey){ alert('Fa√ßa login para criar pastas.'); return; }
      const parentId = normalizeParent(currentFolder);
      const col = collection(db, 'usuarios', uid, 'clients', clientKey, 'fileFolders');
      const docRef = await addDoc(col, { name, parentId: parentId || null, createdAt: Date.now() });
      const newFolder = { id: docRef.id, name, parentId };
      FOLDERS.push(newFolder);
      selectFolder(docRef.id);
    }


    /* ========= widgets with stable IDs ========= */
    let WIDGETS = [];
    const k = (suffix)=> `${currentSection}-${suffix}`;
    function sanitizeUrl(raw){ let s=(raw||"").trim(); if(!s) return ""; if(!/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(s)) s="https://"+s;
      try{ const u=new URL(s); if(!/^https?:$/.test(u.protocol)) return ""; return u.toString(); }catch(e){ return ""; } }
    const getHost = (url)=>{ try{ return url? new URL(url).hostname : ""; }catch(e){ return ""; } };
    const findIndexById = (id)=> WIDGETS.findIndex(w=>w.id===id);

    function migrateOldFormatIfNeeded(){
      const arr = USER_DATA[k("widgets")];
      if(Array.isArray(arr) && arr.length){
        return arr.map(w=> ({ id: w.id || uuid(), title: w.title||"", url: w.url||"", embed: w.embed||"", h: w.h, order: w.order??0 }));
      }
      const hasOld = Object.keys(USER_DATA||{}).some(f=>f.startsWith(`${currentSection}-widget-`)||f===`${currentSection}-widgetOrder`);
      if(!hasOld) return [{ id: uuid(), title:`Widget 1`, url:""}];
      const tmp = [];
      let i=0;
      while(USER_DATA.hasOwnProperty(k(`widget-${i}-title`)) || USER_DATA.hasOwnProperty(k(`widget-${i}-url`))){
        tmp.push({ id: uuid(), title: USER_DATA[k(`widget-${i}-title`)] || `Widget ${i+1}`, url: USER_DATA[k(`widget-${i}-url`)] || "" });
        i++;
      }
      return tmp.length?tmp:[{id:uuid(),title:"Widget 1", url:""}];
    }

    async function loadWidgetsFromData(){
      let arr = Array.isArray(USER_DATA[k("widgets")]) ? [...USER_DATA[k("widgets")]] : migrateOldFormatIfNeeded();
      if(!arr || arr.length === 0){
        let title = "Widget 1";
        if(currentSection==="refSocial") title = "Refer√™ncia Rede 1";
        else if(currentSection==="concorrentes") title = "Concorrente 1";
        arr = [{ id: uuid(), title, url: "" }];
        await persistWidgets();
      } else {
        arr = arr.map(w=> ({ id: w.id||uuid(), title:w.title||"", url:w.url||"", embed:w.embed||"", h:w.h, order:w.order??0 })).sort((a,b)=>(a.order??0)-(b.order??0));
      }
      WIDGETS = arr;
    }

    async function persistWidgets(){
      const uid=auth.currentUser?.uid; if(!uid) return;
      WIDGETS = WIDGETS.map((w,i)=>({...w, order:i}));
      USER_DATA[k("widgets")] = WIDGETS;
      await setDoc(doc(db,"usuarios",uid), { [k("widgets")]: WIDGETS }, { merge:true });
    }

    function renderWidgets(){
      widgetsGrid.innerHTML="";
      WIDGETS.forEach((w,i)=> widgetsGrid.appendChild(createWidgetCard(w)));
      setupDragAndDrop();
    }

    function createWidgetCard(w){
      const index = WIDGETS.findIndex(x=>x.id===w.id);
      const card=document.createElement("div"); card.className="widget-card"; card.dataset.id=w.id;
      const host=getHost(w.url);
      card.innerHTML=`
        <div class="widget-head" draggable="true">
          <div class="widget-title" title="${w.title||`Widget`}">${w.title||`Widget`}</div>
          <div class="widget-meta">${host}</div>
          <div class="widget-actions">
            <button class="icon-btn btn-dup" title="Duplicar">‚ßâ</button>
            <button class="icon-btn btn-up"  title="Mover para cima">‚Üë</button>
            <button class="icon-btn btn-down" title="Mover para baixo">‚Üì</button>
            <button class="icon-btn danger btn-del" title="Fechar">‚®â</button>
          </div>
        </div>
        <div class="widget-input">
          <input class="input w-title" type="text" placeholder="T√≠tulo do painel" value="${w.title||""}">
          <input class="input w-url"   type="text" placeholder="Cole o link (https://...) ou c√≥digo embed" value="${w.url||w.embed||""}">
        </div>
        <div class="frame-shell">${
          w.embed ? w.embed :
          `<iframe class="widget-iframe" title="Widget" loading="lazy"
            sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox"
            referrerpolicy="no-referrer" ${w.url? `src="${sanitizeUrl(w.url)}"`:""}></iframe>`
        }</div>`;

      const inputTitle=card.querySelector(".w-title"), inputUrl=card.querySelector(".w-url");
      const titleEl=card.querySelector(".widget-title"), metaEl=card.querySelector(".widget-meta");
      const iframe=card.querySelector("iframe");
      const shell=card.querySelector(".frame-shell");

      // reexecuta scripts se embed salvo
      if(w.embed){ mountEmbed(shell, w.embed); }
      if(typeof w.h === "number" && w.h>0){ shell.style.height = w.h + "px"; }

      // salvar altura com ID est√°vel
      let __heightTimer=null;
      function saveHeightDebounced(){
        clearTimeout(__heightTimer);
        __heightTimer=setTimeout(async()=>{
          const h=Math.round(shell.getBoundingClientRect().height);
          if(!Number.isFinite(h) || h<=0) return;
          const idx=findIndexById(w.id);
          if(idx<0) return;
          WIDGETS[idx] = { ...(WIDGETS[idx]||{}), h };
          await persistWidgets();
        }, 400);
      }
      try{
        const ro=new ResizeObserver(()=> saveHeightDebounced());
        ro.observe(shell);
      }catch(e){ shell.addEventListener("mouseup", saveHeightDebounced); shell.addEventListener("touchend", saveHeightDebounced); }

      const btnUp=card.querySelector(".btn-up"), btnDown=card.querySelector(".btn-down");
      const btnDup=card.querySelector(".btn-dup"), btnDel=card.querySelector(".btn-del");
      const head=card.querySelector(".widget-head");

      if(!w.url && !w.embed) card.classList.add("editing");

      const apply = async ()=>{
        const t=(inputTitle.value||"").trim() || `Widget`;
        const raw=(inputUrl.value||"").trim();
        const idx=findIndexById(w.id);
        if(idx<0) return;
        let newData={ ...(WIDGETS[idx]||{}), title:t, url:"", embed:"" };

        if(raw.startsWith("<")){
          newData.embed = raw;
          mountEmbed(shell, raw);
          metaEl.textContent = "embed";
        } else {
          const u=sanitizeUrl(raw);
          newData.url = u;
          titleEl.textContent=t; titleEl.title=t; metaEl.textContent=getHost(u);
          if(u){ if(iframe){ iframe.src="about:blank"; setTimeout(()=>{ iframe.src=u; },0); } else {
            shell.innerHTML = `<iframe class="widget-iframe" title="Widget" loading="lazy"
              sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox"
              referrerpolicy="no-referrer" src="${u}"></iframe>`;
          } } else { if(iframe){ iframe.removeAttribute("src"); } }
        }

        WIDGETS[idx] = newData;
        titleEl.textContent=t; titleEl.title=t;
        card.classList.remove("editing");
        await persistWidgets();
      };
      inputTitle.addEventListener("keydown",(e)=>{ if(e.key==="Enter") apply(); });
      inputUrl  .addEventListener("keydown",(e)=>{ if(e.key==="Enter") apply(); });
      // s√≥ fecha edi√ß√£o ao clicar FORA do card, n√£o fora do documento todo
      card.addEventListener("focusout",(ev)=>{
        if(!card.contains(ev.relatedTarget)){ apply(); }
      });
      card.addEventListener("dblclick",()=>{ card.classList.add("editing"); inputTitle.focus(); setTimeout(()=>{ const v=inputTitle.value; inputTitle.selectionStart=inputTitle.selectionEnd=v.length; },0); });

      iframe?.addEventListener("mouseenter", showScrollHintTemporario);

      btnUp.addEventListener("click", async ()=>{
        const idx=findIndexById(w.id); if(idx<=0) return;
        const it=WIDGETS.splice(idx,1)[0]; WIDGETS.splice(idx-1,0,it);
        await persistWidgets(); renderWidgets();
      });
      btnDown.addEventListener("click", async ()=>{
        const idx=findIndexById(w.id); if(idx<0 || idx>=WIDGETS.length-1) return;
        const it=WIDGETS.splice(idx,1)[0]; WIDGETS.splice(idx+1,0,it);
        await persistWidgets(); renderWidgets();
      });
      btnDup.addEventListener("click", async ()=>{
        const idx=findIndexById(w.id); if(idx<0) return;
        const copy={...WIDGETS[idx], id: uuid()};
        WIDGETS.splice(idx+1,0,copy);
        await persistWidgets(); renderWidgets();
      });
      btnDel.addEventListener("click", async ()=>{
        if(!confirm("Remover este painel?")) return;
        const idx=findIndexById(w.id); if(idx<0) return;
        WIDGETS.splice(idx,1);
        if(WIDGETS.length===0){ WIDGETS=[{id:uuid(), title:"Widget 1", url:""}]; }
        await persistWidgets(); renderWidgets();
      });

      head.addEventListener("dragstart",(e)=>{ card.classList.add("dragging"); e.dataTransfer.effectAllowed="move"; e.dataTransfer.setData("text/plain",w.id); });
      head.addEventListener("dragend",()=>{ card.classList.remove("dragging"); removePlaceholder(); });

      return card;
    }

    /* drag & drop */
    let placeholder=null;
    function createPlaceholder(){ if(!placeholder){ placeholder=document.createElement("div"); placeholder.className="drag-placeholder"; } return placeholder; }
    function removePlaceholder(){ if(placeholder && placeholder.parentNode){ placeholder.parentNode.removeChild(placeholder); } }
    function setupDragAndDrop(){
      widgetsGrid.addEventListener("dragover",(e)=>{
        e.preventDefault();
        const dragging = widgetsGrid.querySelector(".widget-card.dragging"); if(!dragging) return;
        const after = getDragAfterElement(e.clientY); const ph=createPlaceholder();
        if(after==null) widgetsGrid.appendChild(ph); else widgetsGrid.insertBefore(ph,after);
      });
      widgetsGrid.addEventListener("drop", async (e)=>{
        const dragging = widgetsGrid.querySelector(".widget-card.dragging"); if(!dragging) return;
        const movingId = dragging.dataset.id;
        const phIndex = [...widgetsGrid.children].indexOf(placeholder);
        const from = findIndexById(movingId);
        let to = phIndex;
        const actualChildren = [...widgetsGrid.children].filter(el=>!el.classList.contains("drag-placeholder"));
        const afterEl = getDragAfterElement(e.clientY);
        to = afterEl ? actualChildren.indexOf(afterEl) : actualChildren.length;
        if(to>from) to = to-1;
        const item=WIDGETS.splice(from,1)[0]; WIDGETS.splice(to,0,item);
        await persistWidgets(); renderWidgets();
      });
    }
    function getDragAfterElement(y){
      const els=[...widgetsGrid.querySelectorAll(".widget-card:not(.dragging)")];
      return els.reduce((closest,child)=>{
        const box=child.getBoundingClientRect(); const offset=y - box.top - box.height/2;
        if(offset<0 && offset>closest.offset){ return {offset,element:child}; } else { return closest; }
      },{offset:Number.NEGATIVE_INFINITY}).element;
    }

    /* ========= Concorrentes ========= */
    let COMPETITORS = [];
    const COMP_CACHE_PREFIX = 'competitors_';
    function competitorsCacheKey(){
      const client = getClientKey();
      if(!client) return 'competitorsList';
      return COMP_CACHE_PREFIX + client;
    }
    async function loadCompetitors(){
      const uid = getUserKey();
      const clientKey = getClientKey();
      COMPETITORS = [];
      if(uid && clientKey){
        const safeClient = clientKey.replace(/[^\w-]/g,'_');
        try{
          let snap = await getDoc(doc(db, 'usuarios', uid, 'clients', safeClient));
          if(!snap.exists() && safeClient !== clientKey){
            snap = await getDoc(doc(db, 'usuarios', uid, 'clients', clientKey));
          }
          if(snap.exists()){
            const data = snap.data() || {};
            if(Array.isArray(data.competitors)){
              COMPETITORS = data.competitors.map(item=>({ ...item }));
            }
          }
        }catch(err){
          console.warn('loadCompetitors firebase', err);
        }
      }
      if(!Array.isArray(COMPETITORS) || !COMPETITORS.length){
        const storageKey = competitorsCacheKey();
        try{
          const cached = JSON.parse(localStorage.getItem(storageKey) || localStorage.getItem('competitorsList') || '[]');
          if(Array.isArray(cached)) COMPETITORS = cached;
        }catch(_){ COMPETITORS = []; }
      }
      const stateKey = clientKey ? `competitors-${clientKey}` : 'competitors';
      const fromUserData = USER_DATA?.[stateKey] || USER_DATA?.competitors;
      if(Array.isArray(fromUserData) && fromUserData.length){
        COMPETITORS = fromUserData.map(item=>({ ...item }));
      }
      if(!Array.isArray(COMPETITORS)) COMPETITORS = [];
      USER_DATA.competitors = COMPETITORS;
      if(stateKey){ USER_DATA[stateKey] = COMPETITORS; }
      try{ localStorage.setItem(competitorsCacheKey(), JSON.stringify(COMPETITORS)); }
      catch(_){ }
      try{ refreshMacroInsights(); }catch(_){ }
    }
    async function persistCompetitors(){
      try{ localStorage.setItem(competitorsCacheKey(), JSON.stringify(COMPETITORS)); }
      catch(_){ }
      USER_DATA.competitors = COMPETITORS;
      const clientKey = getClientKey();
      if(clientKey){ USER_DATA[`competitors-${clientKey}`] = COMPETITORS; }
      const uid = getUserKey();
      if(uid && clientKey){
        const safeClient = clientKey.replace(/[^\w-]/g,'_');
        try{
          await setDoc(doc(db, 'usuarios', uid, 'clients', safeClient), { competitors: COMPETITORS }, { merge: true });
        }catch(err){
          console.error('persistCompetitors', err);
        }
      }
      try{ refreshMacroInsights(); }catch(_){ }
    }
    function renderCompetitors(){
      const tbody = $("competitorsTable")?.querySelector("tbody");
      if(!tbody) return;
      tbody.innerHTML = "";
      COMPETITORS.forEach((c, idx)=>{
        const tr = document.createElement("tr");
        const link = sanitizeUrl(c.link);
        tr.innerHTML = `
          <td>${c.name||""}</td>
          <td><a href="${link}" target="_blank" rel="noopener">${c.link||""}</a></td>
          <td>${c.tags||""}</td>
          <td class="del-cell"><button data-idx="${idx}">üóëÔ∏è</button></td>`;
        tr.querySelector("button")?.addEventListener("click", async ()=>{
          if(confirm("Remover concorrente?")){
            COMPETITORS.splice(idx,1);
            await persistCompetitors();
            renderCompetitors();
          }
        });
        tbody.appendChild(tr);
      });
    }
    loadCompetitors().then(()=>renderCompetitors());
    $("addCompetitor")?.addEventListener("click", async ()=>{
      const name = $("competitorName").value.trim();
      const link = $("competitorLink").value.trim();
      const tags = $("competitorTags").value.trim();
      if(!name || !link){ alert("Nome e link s√£o obrigat√≥rios."); return; }
      COMPETITORS.push({name, link, tags});
      await persistCompetitors();
      $("competitorName").value = "";
      $("competitorLink").value = "";
      $("competitorTags").value = "";
      renderCompetitors();
    });
    
    /* ========= CAC ========= */
    function renderCAC(){
      if(renderCAC._bound) return;
      const currency = $("cacCurrency");
      const monthSel = $("cacMonth");
      const expensesBody = $("cacExpensesBody");
      const addExpense = $("addExpenseRow");
      const sales = $("cacSales");
      const revenue = $("cacRevenue");
      const ticket = $("cacTicket");
      const salesAds = $("cacSalesAds");
      const revenueAds = $("cacRevenueAds");
      const ticketAds = $("cacTicketAds");
      const real = $("cacReal");
      const ads = $("cacAds");
      function fmt(v){
        if(currency.value === 'USD'){
          return 'US$ ' + new Intl.NumberFormat('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
        } else {
          return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL',minimumFractionDigits:2}).format(v||0);
        }
      }
      function parseToNumber(raw, isCurrency = false){
        if (typeof raw === 'number') return raw;
        const s0 = String(raw ?? '').trim();

        // mant√©m d√≠gitos, v√≠rgula e ponto at√© definir o decimal
        const s = s0.replace(/[^\d.,-]/g, '');
        if (!s) return 0;
        const lastComma = s.lastIndexOf(',');
        const lastDot   = s.lastIndexOf('.');
        let norm;

        if (lastComma > -1 && lastDot > -1) {
          // o √∫ltimo define o decimal
          if (lastComma > lastDot) {       // pt-BR: 240.000,00
            norm = s.replace(/\./g, '').replace(',', '.');
          } else {                         // en-US: 10,500.75
            norm = s.replace(/,/g, '');
          }
        } else if (lastComma > -1) {       // s√≥ v√≠rgula => pt-BR
          norm = s.replace(/\./g, '').replace(',', '.');
        } else {                           // s√≥ ponto ou nenhum
          norm = s.replace(/,/g, '');
        }
        return Number(norm) || 0;
      }
      function recalc(){
        const expenses = [...expensesBody.querySelectorAll('input.expense')].map(i=>parseFloat(i.value)||0);
        const totalExpenses = expenses.reduce((a,b)=>a+b,0);
        const tBudget = parseFloat((expensesBody.querySelector('#cacTraffic')||{}).value)||0;
        const salesVal = parseFloat(sales.value)||0;
        const revenueVal = parseFloat(revenue.value)||0;
        const salesAdsVal = parseFloat(salesAds.value)||0;
        const revenueAdsVal = parseFloat(revenueAds.value)||0;
        const ticketVal = salesVal ? revenueVal / salesVal : 0;
        const ticketAdsVal = salesAdsVal ? revenueAdsVal / salesAdsVal : 0;
        ticket.textContent = fmt(ticketVal);
        ticketAds.textContent = fmt(ticketAdsVal);
        real.textContent = fmt(salesVal ? totalExpenses / salesVal : 0);
        ads.textContent  = fmt(salesAdsVal ? tBudget / salesAdsVal : 0);
      }
      function loadMonth(){
        currency.value = CAC_DATA.currency || 'BRL';
        const m = monthSel.value;
        const rows = CAC_DATA.expenses?.[m] || [];
        const defaults = [
          {desc:'Equipe Marketing', val:0},
          {desc:'Equipe Vendas', val:0},
          {desc:'Softwares', val:0},
          {desc:'Verba de Tr√°fego', val:0},
          {desc:'Outros', val:0}
        ];
        const data = rows.length ? rows : defaults;
        expensesBody.innerHTML = '';
        data.forEach(item=>{
          const tr=document.createElement('tr');
          if(defaults.some(d=>d.desc===item.desc)){
            const idAttr = item.desc === 'Verba de Tr√°fego' ? ' id="cacTraffic"' : '';
            tr.innerHTML=`<td>${item.desc}</td><td><input type="number" step="0.01" class="expense"${idAttr} value="${item.val ?? ''}"></td>`;
          } else {
            tr.innerHTML=`<td><input type="text" placeholder="Descri√ß√£o" class="input" style="width:100%" value="${item.desc||''}"></td><td><input type="number" step="0.01" class="expense" value="${item.val||''}"></td>`;
          }
          expensesBody.appendChild(tr);
        });
        salesAds.value = CAC_DATA.salesAds?.[m] ?? '';
        revenueAds.value = CAC_DATA.revenueAds?.[m] ?? '';
        sales.value = CAC_DATA.sales?.[m] ?? '';
        revenue.value = CAC_DATA.revenue?.[m] ?? '';
        recalc();
      }
      function saveMonth(){
        const m = monthSel.value;
        const rows = [...expensesBody.querySelectorAll('tr')];
        CAC_DATA.expenses = CAC_DATA.expenses || {};
        CAC_DATA.expenses[m] = rows.map(tr=>{
          const descInput = tr.querySelector('td:first-child input');
          const desc = descInput ? descInput.value : tr.cells[0].textContent.trim();
          const val = parseFloat(tr.querySelector('input.expense').value) || 0;
          return { desc, val };
        });
        CAC_DATA.salesAds = CAC_DATA.salesAds || {};
        CAC_DATA.revenueAds = CAC_DATA.revenueAds || {};
        CAC_DATA.sales = CAC_DATA.sales || {};
        CAC_DATA.revenue = CAC_DATA.revenue || {};
        CAC_DATA.salesAds[m] = parseFloat(salesAds.value) || 0;
        CAC_DATA.revenueAds[m] = parseFloat(revenueAds.value) || 0;
        CAC_DATA.sales[m] = parseFloat(sales.value) || 0;
        CAC_DATA.revenue[m] = parseFloat(revenue.value) || 0;
        CAC_DATA.currency = currency.value;
        persistCAC();
        try{ refreshMacroInsights(); }catch(_){ }
      }
      expensesBody.addEventListener('input', recalc);
      expensesBody.addEventListener('change', ()=>{ recalc(); saveMonth(); });
      [currency, salesAds, revenueAds, sales, revenue].forEach(el=>{
        el.addEventListener('input', recalc);
        el.addEventListener('change', ()=>{ recalc(); saveMonth(); });
      });
      monthSel.addEventListener('change', loadMonth);
      addExpense?.addEventListener('click', ()=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td><input type="text" placeholder="Descri√ß√£o" class="input" style="width:100%"></td><td><input type="number" step="0.01" class="expense"></td>`;
        expensesBody.appendChild(tr);
      });
      renderCAC._bound=true;
      renderCAC.refresh = loadMonth;
      const now = new Date();
      const mIdx = now.getMonth();
      monthSel.value = META_MONTHS[mIdx];
      loadMonth();
    }

    /* ========= LEADS ========= */
    function renderLeads(){
      if(renderLeads._bound) return;
      console.log('Se√ß√£o de Leads inicializada');
      // Cache de elementos
      leadsWebhookUrlEl = $("leadsWebhookUrl");
      leadsWebhookCopyBtn = $("leadsWebhookCopy");
      leadsWebhookRegenerateBtn = $("leadsWebhookRegenerate");
      leadsListEl = $("leadsList");
      leadsEmptyEl = $("leadsEmpty");

      // Eventos
      leadsWebhookCopyBtn?.addEventListener('click', async ()=>{
        try{
          const val = leadsWebhookUrlEl?.value || '';
          if(!val){ return; }
          const copiado = await mgCopyToClipboard(val);
          if(copiado && typeof mgToast==='function') mgToast('URL copiada!');
          else if(!copiado) alert('N√£o foi poss√≠vel copiar a URL');
        }catch(err){ alert('Falha ao copiar: ' + (err?.message||err)); }
      });
      leadsWebhookRegenerateBtn?.addEventListener('click', async ()=>{
        if(!confirm('Gerar um novo token? Isso invalida a URL anterior.')) return;
        try{
          await regenerateLeadWebhookToken();
          await syncLeadWebhookUrl();
          if(typeof mgToast==='function') mgToast('Novo token gerado');
        }catch(err){ alert('N√£o foi poss√≠vel regenerar: ' + (err?.message||err)); }
      });
      
      // Eventos de edi√ß√£o em lote
      const selectAllCheckbox = $('leadsSelectAll');
      const bulkEditBtn = $('leadsBulkEdit');
      const bulkDeleteBtn = $('leadsBulkDelete');
      const bulkClearBtn = $('leadsBulkClear');
      
      selectAllCheckbox?.addEventListener('change', () => {
        const isChecked = selectAllCheckbox.checked;
        if(leadsListEl){
          leadsListEl.querySelectorAll('.lead-checkbox').forEach(cb => {
            cb.checked = isChecked;
          });
          updateBulkToolbar();
        }
      });
      
      bulkEditBtn?.addEventListener('click', () => {
        openBulkEditModal();
      });
      
      bulkDeleteBtn?.addEventListener('click', async () => {
        await bulkDeleteLeads();
      });
      
      bulkClearBtn?.addEventListener('click', () => {
        clearBulkSelection();
      });
      
      // Eventos de importa√ß√£o em massa
      const importBtn = $('leadsImportBtn');
      const downloadTemplateBtn = $('leadsDownloadTemplate');
      
      importBtn?.addEventListener('click', () => {
        openImportModal();
      });
      
      downloadTemplateBtn?.addEventListener('click', () => {
        downloadLeadsTemplate();
      });
      
      // Evento de copiar relat√≥rio r√°pido
      const quickReportCopyBtn = $('leadsQuickReportCopy');
      quickReportCopyBtn?.addEventListener('click', async () => {
        try{
          const reportContent = $('leadsQuickReportContent');
          const texto = reportContent?.textContent || '';
          if(!texto || texto === 'Carregando relat√≥rio...'){
            if(typeof mgToast==='function') mgToast('Aguarde o relat√≥rio ser gerado...');
            return;
          }
          const copiado = await mgCopyToClipboard(texto);
          if(copiado && typeof mgToast==='function') mgToast('‚úÖ Relat√≥rio copiado para √°rea de transfer√™ncia!');
          else if(!copiado) alert('N√£o foi poss√≠vel copiar o relat√≥rio');
        } catch(err){
          console.error('Erro ao copiar relat√≥rio:', err);
          alert('Falha ao copiar: ' + (err?.message || err));
        }
      });
      
      // Eventos de filtro por per√≠odo
      document.querySelectorAll('.leads-metric-panel[data-filter]').forEach(panel => {
        panel.addEventListener('click', () => {
          const filterType = panel.getAttribute('data-filter');
          if(currentLeadsFilter === filterType){
            // Se clicar no mesmo filtro, limpa
            clearLeadsFilter();
          } else {
            // Aplica novo filtro
            setLeadsFilter(filterType);
          }
        });
      });
      
      const clearFilterBtn = document.getElementById('leadsClearFilter');
      clearFilterBtn?.addEventListener('click', () => {
        clearLeadsFilter();
      });

      // Inicializa fluxo
      (async ()=>{
        try{
          await subscribeLeadWebhookToken();
          await subscribeLeads();
        }catch(err){ console.warn('leads:init', err); }
      })();

      renderLeads._bound = true;
    }

    // ====== LEADS: estado/refs ======
    let leadsWebhookUrlEl, leadsWebhookCopyBtn, leadsWebhookRegenerateBtn, leadsListEl, leadsEmptyEl;
  let LEADS = [];
  let leadsUnsub = null;
  let leadWebhookUnsub = null;
  
  // ====== LEADS: filtro de per√≠odo ======
  let currentLeadsFilter = null; // 'lastMonth', 'thisMonth', 'thisWeek', 'today', null
  
  function getFilteredLeads(){
    if(!currentLeadsFilter) return LEADS;
    
    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth();
    const currentDate = now.getDate();
    
    let startDate, endDate;
    
    switch(currentLeadsFilter){
      case 'lastMonth':
        startDate = new Date(currentYear, currentMonth - 1, 1);
        endDate = new Date(currentYear, currentMonth, 0, 23, 59, 59, 999);
        break;
      case 'thisMonth':
        startDate = new Date(currentYear, currentMonth, 1);
        endDate = new Date(currentYear, currentMonth + 1, 0, 23, 59, 59, 999);
        break;
      case 'thisWeek':
        const dayOfWeek = now.getDay();
        startDate = new Date(now);
        startDate.setDate(currentDate - dayOfWeek);
        startDate.setHours(0, 0, 0, 0);
        endDate = new Date(currentYear, currentMonth, currentDate, 23, 59, 59, 999);
        break;
      case 'today':
        startDate = new Date(currentYear, currentMonth, currentDate, 0, 0, 0, 0);
        endDate = new Date(currentYear, currentMonth, currentDate, 23, 59, 59, 999);
        break;
      default:
        return LEADS;
    }
    
    return LEADS.filter(lead => {
      let leadDate = null;
      if(lead.createdAt){
        if(typeof lead.createdAt.toDate === 'function'){
          leadDate = lead.createdAt.toDate();
        } else if(lead.createdAt.seconds){
          leadDate = new Date(lead.createdAt.seconds * 1000);
        } else if(lead.createdAt instanceof Date){
          leadDate = lead.createdAt;
        }
      }
      if(!leadDate) return false;
      return leadDate >= startDate && leadDate <= endDate;
    });
  }
  
  function setLeadsFilter(filterType){
    currentLeadsFilter = filterType;
    
    // Atualizar UI dos pain√©is
    document.querySelectorAll('.leads-metric-panel').forEach(panel => {
      const panelFilter = panel.getAttribute('data-filter');
      if(panelFilter === filterType){
        panel.classList.add('active');
      } else {
        panel.classList.remove('active');
      }
    });
    
    // Mostrar/ocultar barra de filtro
    const filterBar = document.getElementById('leadsFilterBar');
    const filterText = document.getElementById('leadsFilterText');
    if(filterType && filterBar && filterText){
      const labels = {
        'lastMonth': 'M√™s Passado',
        'thisMonth': 'Este M√™s',
        'thisWeek': 'Esta Semana',
        'today': 'Hoje'
      };
      filterText.textContent = labels[filterType] || filterType;
      filterBar.style.display = 'flex';
    } else if(filterBar){
      filterBar.style.display = 'none';
    }
    
    // Re-renderizar tudo com filtro aplicado
    renderLeadsList();
    updateLeadsSourcesReport();
  }
  
  function clearLeadsFilter(){
    setLeadsFilter(null);
  }

    function getClientKeySafe(){
      return getClientKey() || '';
    }

    async function ensureLeadWebhookToken(){
      const uid = auth?.currentUser?.uid;
      const clientKey = getClientKeySafe();
      if(!uid || !clientKey) return;
  const ref = doc(db, 'usuarios', uid, 'clients', clientKey, 'settings', 'leadWebhook');
      const snap = await getDoc(ref);
      if(!snap.exists() || !(snap.data()||{}).token){
        const token = (Math.random().toString(36).slice(2, 10) + Math.random().toString(36).slice(2, 10)).toLowerCase();
        await setDoc(ref, { token, createdAt: serverTimestamp(), agencyId: uid, clientId: clientKey }, { merge: true });
      }
    }

    async function regenerateLeadWebhookToken(){
      const uid = auth?.currentUser?.uid;
      const clientKey = getClientKeySafe();
      if(!uid || !clientKey) throw new Error('Sess√£o expirada ou cliente ausente');
  const ref = doc(db, 'usuarios', uid, 'clients', clientKey, 'settings', 'leadWebhook');
      const token = (Math.random().toString(36).slice(2, 10) + Math.random().toString(36).slice(2, 10)).toLowerCase();
      await setDoc(ref, { token, updatedAt: serverTimestamp() }, { merge: true });
    }

    function buildLeadWebhookUrl(uid, clientKey, token){
      const region = 'us-central1';
      const projectId = 'mediagrowth-a5349';
      const base = `https://${region}-${projectId}.cloudfunctions.net/receiveLead`;
      const url = new URL(base);
      url.searchParams.set('uid', uid);
      url.searchParams.set('client', clientKey);
      url.searchParams.set('token', token);
      return url.toString();
    }

    async function syncLeadWebhookUrl(){
      const uid = auth?.currentUser?.uid;
      const clientKey = getClientKeySafe();
      if(!uid || !clientKey){
        if(leadsWebhookUrlEl) leadsWebhookUrlEl.value = 'Fa√ßa login e selecione um cliente.';
        return;
      }
  const ref = doc(db, 'usuarios', uid, 'clients', clientKey, 'settings', 'leadWebhook');
      const snap = await getDoc(ref);
      const data = snap.data() || {};
      const token = data.token || '';
      const url = token ? buildLeadWebhookUrl(uid, clientKey, token) : '';
      if(leadsWebhookUrlEl){ leadsWebhookUrlEl.value = url || 'Gerando...'; }
    }

    async function subscribeLeadWebhookToken(){
      const uid = auth?.currentUser?.uid;
      const clientKey = getClientKeySafe();
      if(leadWebhookUnsub){ try{ leadWebhookUnsub(); }catch(_e){} leadWebhookUnsub = null; }
      if(!uid || !clientKey){
        if(leadsWebhookUrlEl) leadsWebhookUrlEl.value = 'Fa√ßa login e selecione um cliente.';
        return;
      }
  const ref = doc(db, 'usuarios', uid, 'clients', clientKey, 'settings', 'leadWebhook');
      // Garante token pelo menos uma vez
      await ensureLeadWebhookToken();
      leadWebhookUnsub = onSnapshot(ref, async (snap)=>{
        if(!snap.exists()){
          // defensivo: cria token se n√£o existir
          try{ await ensureLeadWebhookToken(); }catch(_e){}
          if(leadsWebhookUrlEl) leadsWebhookUrlEl.value = 'Gerando...';
          return;
        }
        const data = snap.data()||{};
        if(!data.token){
          try{ await ensureLeadWebhookToken(); }catch(_e){}
          if(leadsWebhookUrlEl) leadsWebhookUrlEl.value = 'Gerando...';
          return;
        }
        const url = buildLeadWebhookUrl(uid, clientKey, data.token);
        if(leadsWebhookUrlEl){ leadsWebhookUrlEl.value = url; }
      }, (err)=>{
        console.warn('leadWebhook:onSnapshot', err);
      });
    }

    async function subscribeLeads(){
      const uid = auth?.currentUser?.uid;
      const clientKey = getClientKeySafe();
      if(leadsUnsub){ try{ leadsUnsub(); }catch(_e){} leadsUnsub = null; }
      if(!uid || !clientKey){
        LEADS = [];
        renderLeadsList();
        return;
      }
      const colRef = collection(db, 'usuarios', uid, 'clients', clientKey, 'leads');
      const qy = query(colRef, orderBy('createdAt', 'desc'));
      leadsUnsub = onSnapshot(qy, (snap)=>{
        const list = [];
        snap.forEach(docSnap=>{
          const d = docSnap.data() || {};
          // DEBUG: Log do documento bruto do Firestore
          if(d.name && d.name.includes('TEST')){
            console.log('[FIRESTORE DEBUG] Lead de teste encontrado:', docSnap.id);
            console.log('[FIRESTORE DEBUG] Dados brutos:', d);
            console.log('[FIRESTORE DEBUG] Campo plataforma:', d.plataforma);
          }
          list.push({ id: docSnap.id, ...d });
        });
        LEADS = list;
        console.log('[LEADS DEBUG] Total de leads carregados do Firestore:', list.length);
        if(list.length > 0){
          console.log('[LEADS DEBUG] Primeiro lead (ap√≥s carregar):', list[0]);
          console.log('[LEADS DEBUG] Plataforma do primeiro lead:', list[0].plataforma);
        }
        renderLeadsList();
        updateLeadsMetrics();
        updateLeadsSourcesReport();
        
        // Atualiza notifica√ß√µes quando leads mudarem
        try{ scheduleNotificationRefresh({ immediate: true }); }
        catch(_err){ }
      }, (err)=>{
        console.warn('leads:onSnapshot', err);
      });
    }

    function updateLeadsMetrics(){
      try{
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth();
        const currentDate = now.getDate();
        
        // In√≠cio do m√™s passado
        const lastMonthStart = new Date(currentYear, currentMonth - 1, 1);
        const lastMonthEnd = new Date(currentYear, currentMonth, 0, 23, 59, 59, 999);
        
        // In√≠cio deste m√™s
        const thisMonthStart = new Date(currentYear, currentMonth, 1);
        const thisMonthEnd = new Date(currentYear, currentMonth + 1, 0, 23, 59, 59, 999);
        
        // In√≠cio da semana (domingo)
        const dayOfWeek = now.getDay();
        const thisWeekStart = new Date(now);
        thisWeekStart.setDate(currentDate - dayOfWeek);
        thisWeekStart.setHours(0, 0, 0, 0);
        
        // Hoje
        const todayStart = new Date(currentYear, currentMonth, currentDate, 0, 0, 0, 0);
        const todayEnd = new Date(currentYear, currentMonth, currentDate, 23, 59, 59, 999);
        
        let lastMonthCount = 0;
        let thisMonthCount = 0;
        let thisWeekCount = 0;
        let todayCount = 0;
        
        LEADS.forEach(lead => {
          // Converter createdAt (Timestamp do Firebase) para Date
          let leadDate = null;
          if(lead.createdAt){
            if(typeof lead.createdAt.toDate === 'function'){
              leadDate = lead.createdAt.toDate();
            } else if(lead.createdAt.seconds){
              leadDate = new Date(lead.createdAt.seconds * 1000);
            } else if(lead.createdAt instanceof Date){
              leadDate = lead.createdAt;
            }
          }
          
          if(!leadDate) return;
          
          // M√™s passado
          if(leadDate >= lastMonthStart && leadDate <= lastMonthEnd){
            lastMonthCount++;
          }
          
          // Este m√™s
          if(leadDate >= thisMonthStart && leadDate <= thisMonthEnd){
            thisMonthCount++;
          }
          
          // Esta semana
          if(leadDate >= thisWeekStart){
            thisWeekCount++;
          }
          
          // Hoje
          if(leadDate >= todayStart && leadDate <= todayEnd){
            todayCount++;
          }
        });
        
        // Atualizar valores nos pain√©is
        const lastMonthEl = document.getElementById('leadsLastMonth');
        const thisMonthEl = document.getElementById('leadsThisMonth');
        const thisWeekEl = document.getElementById('leadsThisWeek');
        const todayEl = document.getElementById('leadsToday');
        const monthChangeEl = document.getElementById('leadsMonthChange');
        
        if(lastMonthEl) lastMonthEl.textContent = lastMonthCount;
        if(thisMonthEl) thisMonthEl.textContent = thisMonthCount;
        if(thisWeekEl) thisWeekEl.textContent = thisWeekCount;
        if(todayEl) todayEl.textContent = todayCount;
        
        // Calcular % de crescimento m√™s a m√™s
        if(monthChangeEl){
          let changePercent = 0;
          let changeClass = 'neutral';
          let changeIcon = '‚Üí';
          
          if(lastMonthCount > 0){
            changePercent = ((thisMonthCount - lastMonthCount) / lastMonthCount * 100).toFixed(1);
            if(changePercent > 0){
              changeClass = 'up';
              changeIcon = '‚Üë';
            } else if(changePercent < 0){
              changeClass = 'down';
              changeIcon = '‚Üì';
              changePercent = Math.abs(changePercent);
            }
          } else if(thisMonthCount > 0){
            changePercent = 100;
            changeClass = 'up';
            changeIcon = '‚Üë';
          }
          
          monthChangeEl.className = `leads-metric-change ${changeClass}`;
          monthChangeEl.innerHTML = `
            <span class="leads-metric-icon">${changeIcon}</span>
            <span>${changePercent}%</span>
          `;
        }
        
        console.log('[LEADS METRICS] Atualizado:', {
          lastMonth: lastMonthCount,
          thisMonth: thisMonthCount,
          thisWeek: thisWeekCount,
          today: todayCount
        });
        
      } catch(err){
        console.error('[LEADS METRICS] Erro ao calcular m√©tricas:', err);
      }
    }
    
    // Fun√ß√£o para normalizar nome de plataforma
    function normalizePlatform(plataforma){
      if(!plataforma || plataforma === 'N√£o especificada') return 'N√£o especificada';
      
      const normalized = plataforma.toString().trim().toLowerCase();
      
      // Google e varia√ß√µes
      if(normalized.includes('google')){
        return 'Google';
      }
      
      // Meta, Facebook, Instagram e varia√ß√µes
      if(normalized.includes('meta') || 
         normalized.includes('facebook') || 
         normalized.includes('fb') ||
         normalized.includes('instagram') ||
         normalized.includes('insta')){
        return 'Meta';
      }
      
      // TikTok e varia√ß√µes
      if(normalized.includes('tiktok') || normalized.includes('tik tok')){
        return 'TikTok';
      }
      
      // LinkedIn e varia√ß√µes
      if(normalized.includes('linkedin') || normalized.includes('linked in')){
        return 'LinkedIn';
      }
      
      // Twitter/X e varia√ß√µes
      if(normalized.includes('twitter') || normalized === 'x'){
        return 'Twitter/X';
      }
      
      // Se n√£o reconheceu, capitaliza primeira letra
      return plataforma.charAt(0).toUpperCase() + plataforma.slice(1).toLowerCase();
    }
    
    // Fun√ß√£o para normalizar nome de fonte/source
    function normalizeSource(source){
      if(!source || source === 'N√£o especificada') return 'N√£o especificada';
      
      const original = source.toString().trim();
      const normalized = original.toLowerCase();
      
      // Remover protocolo de URLs (http://, https://)
      let cleaned = normalized.replace(/^https?:\/\//gi, '');
      
      // Remover www.
      cleaned = cleaned.replace(/^www\./gi, '');
      
      // Remover query strings e fragments de URLs
      cleaned = cleaned.replace(/[?#].*$/gi, '');
      
      // Remover trailing slashes
      cleaned = cleaned.replace(/\/+$/g, '');
      
      // Remover n√∫meros de vers√£o ou datas (ex: "campanha-2024", "v2", "campaign-12-25")
      cleaned = cleaned.replace(/[-_]?\d{4}[-_]?\d{0,2}[-_]?\d{0,2}/g, '');
      cleaned = cleaned.replace(/[-_]?v\d+/gi, '');
      
      // Remover caracteres especiais extras mantendo apenas letras, n√∫meros, espa√ßos e h√≠fens
      cleaned = cleaned.replace(/[^\w\s-]/g, ' ');
      
      // Normalizar espa√ßos m√∫ltiplos
      cleaned = cleaned.replace(/\s+/g, ' ').trim();
      
      // Pegar apenas as primeiras 3-4 palavras principais (para agrupar campanhas similares)
      const words = cleaned.split(/[\s-_]+/).filter(w => w.length > 2); // Ignora palavras muito curtas
      const mainWords = words.slice(0, 3).join('-');
      
      // Se ficou muito curto, usar original limpo
      if(mainWords.length < 3){
        return original;
      }
      
      // Capitalizar primeira letra de cada palavra
      return mainWords.split('-')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
    }

    function updateLeadsSourcesReport(){
      try{
        // Usar leads filtrados ou todos os leads
        const leadsToAnalyze = getFilteredLeads();
        
        // Coletar dados de plataformas e fontes COM NORMALIZA√á√ÉO
        const plataformasMap = {};
        const sourcesMap = {};
        
        leadsToAnalyze.forEach(lead => {
          // Contar plataformas com normaliza√ß√£o
          const plataformaOriginal = (lead.plataforma || 'N√£o especificada').toString().trim();
          const plataformaNormalizada = normalizePlatform(plataformaOriginal);
          if(plataformaNormalizada){
            plataformasMap[plataformaNormalizada] = (plataformasMap[plataformaNormalizada] || 0) + 1;
          }
          
          // Contar fontes com normaliza√ß√£o
          const sourceOriginal = (lead.source || 'N√£o especificada').toString().trim();
          const sourceNormalizada = normalizeSource(sourceOriginal);
          if(sourceNormalizada){
            sourcesMap[sourceNormalizada] = (sourcesMap[sourceNormalizada] || 0) + 1;
          }
        });
        
        // Cores para plataformas
        const plataformaColors = {
          'Google': '#4285F4',
          'Meta': '#0866FF',
          'TikTok': '#000000',
          'LinkedIn': '#0A66C2',
          'Twitter/X': '#1DA1F2',
          'N√£o especificada': '#64748b'
        };
        
        // Cores para fontes (usando palette diversificada)
        const sourceColorPalette = [
          '#8b5cf6', // purple
          '#ec4899', // pink
          '#f59e0b', // amber
          '#10b981', // emerald
          '#06b6d4', // cyan
          '#6366f1', // indigo
          '#f97316', // orange
          '#14b8a6', // teal
        ];
        
        // Renderizar plataformas
        const plataformasList = document.getElementById('leadsPlataformasList');
        if(plataformasList){
          const plataformasEntries = Object.entries(plataformasMap).sort((a, b) => b[1] - a[1]);
          const totalLeads = leadsToAnalyze.length;
          
          if(plataformasEntries.length === 0){
            plataformasList.innerHTML = '<div class="leads-sources-empty">Nenhum lead neste per√≠odo</div>';
          } else {
            plataformasList.innerHTML = plataformasEntries.map(([name, count]) => {
              const percentage = totalLeads > 0 ? (count / totalLeads * 100).toFixed(1) : 0;
              const color = plataformaColors[name] || '#64748b';
              return `
                <div class="leads-source-item">
                  <div class="leads-source-name">
                    <span class="leads-source-badge" style="--badge-color: ${color}"></span>
                    ${escapeHtml(name)}
                  </div>
                  <div class="leads-source-count">${count}</div>
                </div>
                <div class="leads-source-bar">
                  <div class="leads-source-bar-fill" style="--badge-color: ${color}; width: ${percentage}%"></div>
                </div>
              `;
            }).join('');
          }
        }
        
        // Renderizar fontes
        const sourcesList = document.getElementById('leadsSourcesList');
        if(sourcesList){
          const sourcesEntries = Object.entries(sourcesMap).sort((a, b) => b[1] - a[1]);
          const totalLeads = leadsToAnalyze.length;
          
          if(sourcesEntries.length === 0){
            sourcesList.innerHTML = '<div class="leads-sources-empty">Nenhum lead neste per√≠odo</div>';
          } else {
            sourcesList.innerHTML = sourcesEntries.slice(0, 8).map(([name, count], index) => {
              const percentage = totalLeads > 0 ? (count / totalLeads * 100).toFixed(1) : 0;
              const color = sourceColorPalette[index % sourceColorPalette.length];
              return `
                <div class="leads-source-item">
                  <div class="leads-source-name">
                    <span class="leads-source-badge" style="--badge-color: ${color}"></span>
                    ${escapeHtml(name)}
                  </div>
                  <div class="leads-source-count">${count}</div>
                </div>
                <div class="leads-source-bar">
                  <div class="leads-source-bar-fill" style="--badge-color: ${color}; width: ${percentage}%"></div>
                </div>
              `;
            }).join('');
          }
        }
        
        console.log('[LEADS SOURCES] Atualizado:', {
          plataformas: Object.keys(plataformasMap).length,
          fontes: Object.keys(sourcesMap).length
        });
        
        // Atualizar relat√≥rio r√°pido ap√≥s atualizar fontes
        updateQuickReport();
        
      } catch(err){
        console.error('[LEADS SOURCES] Erro ao gerar relat√≥rio:', err);
      }
    }

    function updateQuickReport(){
      try{
        const leadsToAnalyze = getFilteredLeads();
        const totalLeads = leadsToAnalyze.length;
        
        // Coletar plataformas e fontes
        const plataformasMap = {};
        const sourcesMap = {};
        
        leadsToAnalyze.forEach(lead => {
          const plataforma = normalizePlatform(lead.plataforma || 'N√£o especificada');
          const source = normalizeSource(lead.source || 'N√£o especificada');
          plataformasMap[plataforma] = (plataformasMap[plataforma] || 0) + 1;
          sourcesMap[source] = (sourcesMap[source] || 0) + 1;
        });
        
        // Ordenar por quantidade
        const topPlataformas = Object.entries(plataformasMap).sort((a, b) => b[1] - a[1]).slice(0, 3);
        const topSources = Object.entries(sourcesMap).sort((a, b) => b[1] - a[1]).slice(0, 3);
        
        // Calcular compara√ß√£o com m√™s passado (apenas para este m√™s)
        let comparacaoTexto = '';
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth();
        
        if(currentLeadsFilter === 'thisMonth'){
          // Calcular leads do m√™s passado
          const lastMonthStart = new Date(currentYear, currentMonth - 1, 1);
          const lastMonthEnd = new Date(currentYear, currentMonth, 0, 23, 59, 59, 999);
          
          let lastMonthCount = 0;
          LEADS.forEach(lead => {
            let leadDate = null;
            if(lead.createdAt){
              if(typeof lead.createdAt.toDate === 'function'){
                leadDate = lead.createdAt.toDate();
              } else if(lead.createdAt.seconds){
                leadDate = new Date(lead.createdAt.seconds * 1000);
              } else if(lead.createdAt instanceof Date){
                leadDate = lead.createdAt;
              }
            }
            if(leadDate && leadDate >= lastMonthStart && leadDate <= lastMonthEnd){
              lastMonthCount++;
            }
          });
          
          // Calcular percentual de crescimento
          if(lastMonthCount > 0){
            const changePercent = ((totalLeads - lastMonthCount) / lastMonthCount * 100).toFixed(1);
            if(changePercent > 0){
              comparacaoTexto = ` (‚Üë${changePercent}% vs m√™s passado)`;
            } else if(changePercent < 0){
              comparacaoTexto = ` (‚Üì${Math.abs(changePercent)}% vs m√™s passado)`;
            } else {
              comparacaoTexto = ` (‚Üí mesmo volume do m√™s passado)`;
            }
          } else if(totalLeads > 0){
            comparacaoTexto = ` (üÜï primeiro m√™s com leads)`;
          }
        } else if(currentLeadsFilter === 'lastMonth'){
          // Calcular leads do m√™s retrasado para compara√ß√£o
          const twoMonthsAgoStart = new Date(currentYear, currentMonth - 2, 1);
          const twoMonthsAgoEnd = new Date(currentYear, currentMonth - 1, 0, 23, 59, 59, 999);
          
          let twoMonthsAgoCount = 0;
          LEADS.forEach(lead => {
            let leadDate = null;
            if(lead.createdAt){
              if(typeof lead.createdAt.toDate === 'function'){
                leadDate = lead.createdAt.toDate();
              } else if(lead.createdAt.seconds){
                leadDate = new Date(lead.createdAt.seconds * 1000);
              } else if(lead.createdAt instanceof Date){
                leadDate = lead.createdAt;
              }
            }
            if(leadDate && leadDate >= twoMonthsAgoStart && leadDate <= twoMonthsAgoEnd){
              twoMonthsAgoCount++;
            }
          });
          
          // Calcular percentual de crescimento
          if(twoMonthsAgoCount > 0){
            const changePercent = ((totalLeads - twoMonthsAgoCount) / twoMonthsAgoCount * 100).toFixed(1);
            if(changePercent > 0){
              comparacaoTexto = ` (‚Üë${changePercent}% vs m√™s anterior)`;
            } else if(changePercent < 0){
              comparacaoTexto = ` (‚Üì${Math.abs(changePercent)}% vs m√™s anterior)`;
            } else {
              comparacaoTexto = ` (‚Üí mesmo volume do m√™s anterior)`;
            }
          }
        }
        
        // Determinar per√≠odo do filtro
        let periodoTexto = '';
        const nomeMesAtual = now.toLocaleString('pt-BR', { month: 'long' });
        
        if(currentLeadsFilter === 'today'){
          periodoTexto = 'hoje';
        } else if(currentLeadsFilter === 'thisWeek'){
          periodoTexto = 'esta semana';
        } else if(currentLeadsFilter === 'thisMonth'){
          periodoTexto = `este m√™s (${nomeMesAtual})`;
        } else if(currentLeadsFilter === 'lastMonth'){
          const mesPassado = new Date(currentYear, currentMonth - 1, 1);
          const nomeMesPassado = mesPassado.toLocaleString('pt-BR', { month: 'long' });
          periodoTexto = `m√™s passado (${nomeMesPassado})`;
        } else {
          periodoTexto = 'o per√≠odo total';
        }
        
        // Gerar texto do relat√≥rio em formato de lista did√°tico
        let relatorioTexto = '';
        
        if(totalLeads === 0){
          relatorioTexto = `Nenhum lead captado ${periodoTexto}.`;
        } else {
          // An√°lise descritiva baseada no n√∫mero
          let analiseDescritiva = '';
          if(totalLeads >= 50){
            analiseDescritiva = 'Excelente! Volume muito bom de oportunidades.';
          } else if(totalLeads >= 20){
            analiseDescritiva = '√ìtimo resultado! Bom volume de leads captados.';
          } else if(totalLeads >= 5){
            analiseDescritiva = 'Volume moderado, estamos construindo.';
          } else {
            analiseDescritiva = 'Iniciando a capta√ß√£o de leads.';
          }
          
          // T√çTULO PRINCIPAL
          let titulo = `üìä RELAT√ìRIO DE LEADS - ${periodoTexto.toUpperCase()}`;
          
          // SE√á√ÉO 1: Total de Leads
          let secaoTotal = `\n\n‚úÖ TOTAL DE LEADS CAPTADOS\n`;
          secaoTotal += `- Captamos ${totalLeads} lead${totalLeads > 1 ? 's' : ''} ${periodoTexto}\n`;
          secaoTotal += `- ${analiseDescritiva}`;
          
          // SE√á√ÉO 2: Compara√ß√£o (se aplic√°vel)
          let secaoComparacao = '';
          if(comparacaoTexto){
            secaoComparacao = `\n\nüìà COMPARA√á√ÉO COM PER√çODO ANTERIOR\n`;
            if(comparacaoTexto.includes('‚Üë')){
              const percentual = comparacaoTexto.match(/[\d.]+/)[0];
              secaoComparacao += `- Crescimento de ${percentual}% em rela√ß√£o ao per√≠odo anterior\n`;
              secaoComparacao += `- Isso significa que captamos mais leads do que no m√™s passado\n`;
              secaoComparacao += `- Resultado positivo! As estrat√©gias est√£o funcionando`;
            } else if(comparacaoTexto.includes('‚Üì')){
              const percentual = comparacaoTexto.match(/[\d.]+/)[0];
              secaoComparacao += `- Redu√ß√£o de ${percentual}% em rela√ß√£o ao per√≠odo anterior\n`;
              secaoComparacao += `- Captamos menos leads do que no m√™s passado\n`;
              secaoComparacao += `- Vamos revisar as estrat√©gias para melhorar`;
            } else if(comparacaoTexto.includes('‚Üí')){
              secaoComparacao += `- Volume est√°vel em rela√ß√£o ao m√™s passado\n`;
              secaoComparacao += `- Mantivemos o mesmo n√∫mero de leads\n`;
              secaoComparacao += `- Desempenho consistente`;
            } else if(comparacaoTexto.includes('üÜï')){
              secaoComparacao += `- Este √© o primeiro m√™s com registro de leads\n`;
              secaoComparacao += `- Estamos come√ßando a acompanhar os resultados\n`;
              secaoComparacao += `- Base inicial para compara√ß√µes futuras`;
            }
          }
          
          // SE√á√ÉO 3: Plataformas
          let secaoPlataformas = `\n\nüì± PLATAFORMAS DE ORIGEM\n`;
          if(topPlataformas.length > 0){
            topPlataformas.forEach(([nome, qtd]) => {
              const percentual = ((qtd / totalLeads) * 100).toFixed(0);
              secaoPlataformas += `- ${nome}: ${qtd} lead${qtd > 1 ? 's' : ''} (${percentual}% do total)\n`;
            });
            secaoPlataformas += `- As plataformas mostram de onde os leads vieram (Google, Meta, etc)`;
          }
          
          // SE√á√ÉO 4: Fontes Detalhadas
          let secaoFontes = `\n\nüéØ FONTES ESPEC√çFICAS\n`;
          if(topSources.length > 0){
            topSources.forEach(([nome, qtd], index) => {
              const percentual = ((qtd / totalLeads) * 100).toFixed(0);
              const posicao = index === 0 ? '(principal)' : '';
              secaoFontes += `- ${nome}: ${qtd} lead${qtd > 1 ? 's' : ''} (${percentual}% do total) ${posicao}\n`;
            });
            secaoFontes += `- As fontes mostram exatamente qual campanha ou canal trouxe cada lead`;
          }
          
          // Montar relat√≥rio completo
          relatorioTexto = titulo + secaoTotal + secaoComparacao + secaoPlataformas + secaoFontes;
        }
        
        // Atualizar elemento
        const reportContent = document.getElementById('leadsQuickReportContent');
        if(reportContent){
          reportContent.textContent = relatorioTexto;
        }
        
        console.log('[QUICK REPORT] Gerado:', relatorioTexto);
        
      } catch(err){
        console.error('[QUICK REPORT] Erro ao gerar:', err);
      }
    }

    async function deleteLead(leadId){
      if(!leadId) return;
      try{
        const uid = auth?.currentUser?.uid;
        const clientKey = getClientKeySafe();
        if(!uid || !clientKey){
          alert('Sess√£o expirada ou cliente ausente');
          return;
        }
        const docRef = doc(db, 'usuarios', uid, 'clients', clientKey, 'leads', leadId);
        await deleteDoc(docRef);
        if(typeof mgToast === 'function'){
          mgToast('Lead removido com sucesso!');
        }
      }catch(err){
        console.error('deleteLead', err);
        alert('Erro ao remover lead: ' + (err?.message || String(err)));
      }
    }

    function formatWhen(value){
      try{
        if(!value) return '';
        if(typeof value.toMillis === 'function') return new Date(value.toMillis()).toLocaleString('pt-BR',{hour12:false});
        if(typeof value === 'number') return new Date(value).toLocaleString('pt-BR',{hour12:false});
        return '';
      }catch(_){ return ''; }
    }

    function renderLeadsList(){
      if(!leadsListEl || !leadsEmptyEl) return;
      
      // Usar leads filtrados ou todos os leads
      const leadsToRender = getFilteredLeads();
      
      if(!Array.isArray(leadsToRender) || leadsToRender.length === 0){
        leadsListEl.innerHTML = '';
        leadsEmptyEl.style.display = 'block';
        if(currentLeadsFilter){
          leadsEmptyEl.textContent = 'Nenhum lead encontrado para este per√≠odo.';
        } else {
          leadsEmptyEl.textContent = 'Nenhum lead recebido ainda.';
        }
        return;
      }
      leadsEmptyEl.style.display = 'none';
      
      // DEBUG: Log dos leads para verificar campo plataforma
      console.log('[LEADS DEBUG] Total de leads a renderizar:', leadsToRender.length, '(filtro:', currentLeadsFilter, ')');
      if(leadsToRender.length > 0){
        console.log('[LEADS DEBUG] Primeiro lead completo:', leadsToRender[0]);
        console.log('[LEADS DEBUG] Campo plataforma do primeiro lead:', leadsToRender[0].plataforma);
      }
      
      leadsListEl.innerHTML = leadsToRender.map(l => {
        const name = (l.name||'').toString();
        const email = (l.email||'').toString();
        const phone = (l.phone||'').toString();
        const question = (l.question||'').toString();
        const plataforma = (l.plataforma||'').toString();
        const fonte = (l.source||'').toString();
        
        // DEBUG: Log individual de cada lead
        if(l.plataforma){
          console.log('[LEADS DEBUG] Lead com plataforma:', l.name, '- Plataforma:', l.plataforma);
        }
        const when = formatWhen(l.createdAt || l.updatedAt || null);
        const esc = (s)=> String(s||'').replace(/[&<>]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
        return `<div class="lead-row" data-lead-id="${l.id || ''}">
          <div class="lead-cell">
            <input type="checkbox" class="lead-checkbox" data-lead-id="${l.id || ''}" />
          </div>
          <div class="lead-cell lead-name" title="${esc(name)}">${esc(name)||'-'}</div>
          <div class="lead-cell lead-email" title="${esc(email)}">${esc(email)||'-'}</div>
          <div class="lead-cell lead-phone" title="${esc(phone)}">${esc(phone)||'-'}</div>
          <div class="lead-cell lead-question" title="${esc(question)}">${esc(question)||'-'}</div>
          <div class="lead-cell lead-plataforma" title="${esc(plataforma)}">${esc(plataforma)||'-'}</div>
          <div class="lead-cell lead-fonte" title="${esc(fonte)}">${esc(fonte)||'-'}</div>
          <div class="lead-cell lead-when">${esc(when)}</div>
          <div class="lead-cell lead-actions">
            <button class="lead-edit-btn" data-lead-id="${l.id || ''}" title="Editar">‚úé</button>
            <button class="lead-delete-btn" data-lead-id="${l.id || ''}" title="Remover lead">√ó</button>
          </div>
        </div>`;
      }).join('');
      
      // Bind delete buttons
      leadsListEl.querySelectorAll('.lead-delete-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.preventDefault();
          const leadId = btn.getAttribute('data-lead-id');
          if(!leadId) return;
          if(!confirm('Tem certeza que deseja remover este lead?')) return;
          await deleteLead(leadId);
        });
      });

      // Bind edit buttons
      leadsListEl.querySelectorAll('.lead-edit-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const row = btn.closest('.lead-row');
          if(!row) return;
          enterLeadEditMode(row);
        });
      });
      
      // Bind checkboxes para sele√ß√£o m√∫ltipla
      leadsListEl.querySelectorAll('.lead-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          updateBulkToolbar();
        });
      });
    }

    // Atualiza campos espec√≠ficos do lead no Firestore (merge)
    async function updateLead(leadId, patch){
      if(!leadId || !patch || typeof patch !== 'object') return;
      try{
        const uid = auth?.currentUser?.uid;
        const clientKey = getClientKeySafe();
        if(!uid || !clientKey) throw new Error('Sess√£o expirada ou cliente ausente');
        const ref = doc(db, 'usuarios', uid, 'clients', clientKey, 'leads', leadId);
        await setDoc(ref, { ...patch, updatedAt: serverTimestamp() }, { merge:true });
        if(typeof mgToast==='function') mgToast('Lead atualizado');
      }catch(err){
        console.error('updateLead', err);
        alert('Falha ao atualizar lead: ' + (err?.message || String(err)));
      }
    }

    function enterLeadEditMode(row){
      if(!row || row.dataset.editing==='1') return;
      row.dataset.editing='1';
      row.classList.add('lead-editing');
      const leadId = row.getAttribute('data-lead-id');
      
      // Encontrar o lead no array para pegar a data original
      const lead = LEADS.find(l => l.id === leadId);
      const createdAt = lead?.createdAt;
      
      const fieldMap = [
        { cls:'lead-name', key:'name', type:'text' },
        { cls:'lead-email', key:'email', type:'email' },
        { cls:'lead-phone', key:'phone', type:'text' },
        { cls:'lead-question', key:'question', type:'text' },
        { cls:'lead-plataforma', key:'plataforma', type:'text' },
        { cls:'lead-fonte', key:'source', type:'text' }
      ];
      fieldMap.forEach(f=>{
        const cell = row.querySelector('.'+f.cls);
        if(!cell) return;
        const original = cell.textContent || '';
        cell.dataset.originalValue = original;
        cell.innerHTML = `<input class="lead-edit-input" type="${f.type}" data-field="${f.key}" value="${original.replace(/"/g,'&quot;')}">`;
      });
      
      // Adicionar campo de data "quando"
      const whenCell = row.querySelector('.lead-when');
      if(whenCell){
        let dateValue = '';
        if(createdAt){
          try{
            // Converter Timestamp do Firebase para formato de input date
            const date = createdAt.toDate ? createdAt.toDate() : new Date(createdAt);
            // Formato YYYY-MM-DD para input type="date"
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            dateValue = `${year}-${month}-${day}`;
          }catch(err){
            console.warn('[Edit Lead] Erro ao converter data:', err);
          }
        }
        const original = whenCell.textContent || '';
        whenCell.dataset.originalValue = original;
        whenCell.innerHTML = `<input class="lead-edit-input" type="date" data-field="createdAt" value="${dateValue}">`;
      }
      // A√ß√µes
      const actionsCell = row.querySelector('.lead-actions');
      if(actionsCell){
        actionsCell.innerHTML = '';
        const saveBtn = document.createElement('button');
        saveBtn.className = 'lead-save-btn';
        saveBtn.textContent = 'Salvar';
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'lead-cancel-btn';
        cancelBtn.textContent = 'Cancelar';
        actionsCell.appendChild(saveBtn);
        actionsCell.appendChild(cancelBtn);
        saveBtn.addEventListener('click', async (e)=>{
          e.preventDefault();
          if(!leadId) return;
          saveBtn.disabled = true; cancelBtn.disabled = true;
          const inputs = row.querySelectorAll('.lead-edit-input');
          const patch = {};
          inputs.forEach(inp=>{ 
            const k = inp.dataset.field; 
            if(!k) return; 
            const val = inp.value.trim();
            const cell = inp.closest('.lead-cell');
            const original = cell?.dataset?.originalValue ?? '';
            
            // Se mudou o valor, adiciona ao patch
            if(val !== original){
              // Campo de data precisa ser convertido para Timestamp
              if(k === 'createdAt' && val){
                try{
                  // Converter YYYY-MM-DD para Timestamp do Firebase
                  const [year, month, day] = val.split('-').map(Number);
                  const date = new Date(year, month - 1, day);
                  patch[k] = Timestamp.fromDate(date);
                }catch(err){
                  console.warn('[Edit Lead] Erro ao converter data:', err);
                  patch[k] = val; // Fallback para string
                }
              } else {
                patch[k] = val;
              }
            }
          });
          if(Object.keys(patch).length === 0){ 
            // Nada mudou, apenas sair do modo edi√ß√£o
            renderLeadsList();
            return; 
          }
          await updateLead(leadId, patch);
          // Re-render (snapshot ir√° atualizar, mas for√ßamos fallback)
          renderLeadsList();
        });
        cancelBtn.addEventListener('click', (e)=>{
          e.preventDefault();
          // Reverte sem salvar
          renderLeadsList();
        });
      }
    }

    // ========= BULK EDIT FUNCTIONS =========
    
    function getSelectedLeadIds(){
      if(!leadsListEl) return [];
      const checkboxes = leadsListEl.querySelectorAll('.lead-checkbox:checked');
      return Array.from(checkboxes).map(cb => cb.getAttribute('data-lead-id')).filter(Boolean);
    }
    
    function updateBulkToolbar(){
      const bulkToolbar = $('leadsBulkToolbar');
      const bulkCount = $('leadsBulkCount');
      const selectAllCheckbox = $('leadsSelectAll');
      
      const selectedIds = getSelectedLeadIds();
      const count = selectedIds.length;
      
      if(bulkCount) bulkCount.textContent = count;
      
      if(bulkToolbar){
        if(count > 0){
          bulkToolbar.classList.add('active');
        } else {
          bulkToolbar.classList.remove('active');
        }
      }
      
      // Atualizar estado do checkbox "selecionar todos"
      if(selectAllCheckbox && leadsListEl){
        const allCheckboxes = leadsListEl.querySelectorAll('.lead-checkbox');
        const checkedCount = leadsListEl.querySelectorAll('.lead-checkbox:checked').length;
        selectAllCheckbox.checked = allCheckboxes.length > 0 && checkedCount === allCheckboxes.length;
        selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < allCheckboxes.length;
      }
      
      // Aplicar classe visual nas linhas selecionadas
      if(leadsListEl){
        leadsListEl.querySelectorAll('.lead-row').forEach(row => {
          const checkbox = row.querySelector('.lead-checkbox');
          if(checkbox && checkbox.checked){
            row.classList.add('selected');
          } else {
            row.classList.remove('selected');
          }
        });
      }
    }
    
    function clearBulkSelection(){
      if(!leadsListEl) return;
      leadsListEl.querySelectorAll('.lead-checkbox').forEach(cb => {
        cb.checked = false;
      });
      updateBulkToolbar();
    }
    
    async function bulkDeleteLeads(){
      const selectedIds = getSelectedLeadIds();
      if(selectedIds.length === 0){
        alert('Nenhum lead selecionado.');
        return;
      }
      
      if(!confirm(`Tem certeza que deseja remover ${selectedIds.length} lead(s)?`)){
        return;
      }
      
      try{
        for(const leadId of selectedIds){
          await deleteLead(leadId);
        }
        if(typeof mgToast === 'function'){
          mgToast(`${selectedIds.length} lead(s) removido(s)!`);
        }
        clearBulkSelection();
      }catch(err){
        console.error('bulkDeleteLeads', err);
        alert('Erro ao remover leads: ' + (err?.message || String(err)));
      }
    }
    
    function openBulkEditModal(){
      const selectedIds = getSelectedLeadIds();
      if(selectedIds.length === 0){
        alert('Nenhum lead selecionado.');
        return;
      }
      
      // Criar modal de edi√ß√£o em lote
      const modal = document.createElement('div');
      modal.className = 'modal show';
      modal.style.zIndex = '100000';
      modal.innerHTML = `
        <div class="modal-card" style="max-width: 600px;">
          <div class="modal-head">
            <h3 style="margin: 0;">Editar ${selectedIds.length} Lead(s)</h3>
            <button class="btn small ghost" id="bulkEditClose" type="button">Fechar</button>
          </div>
          <div class="modal-body" style="display: flex; flex-direction: column; gap: 16px; padding: 20px;">
            <p style="color: #cbd5f5; margin: 0;">
              Os campos que voc√™ preencher ser√£o aplicados a todos os leads selecionados. 
              Deixe em branco para n√£o alterar.
            </p>
            
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <label style="color: #cbd5f5; font-size: 0.85rem; font-weight: 700;">Nome</label>
              <input type="text" id="bulkEditName" class="input" placeholder="Deixe vazio para n√£o alterar" />
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <label style="color: #cbd5f5; font-size: 0.85rem; font-weight: 700;">E-mail</label>
              <input type="email" id="bulkEditEmail" class="input" placeholder="Deixe vazio para n√£o alterar" />
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <label style="color: #cbd5f5; font-size: 0.85rem; font-weight: 700;">Telefone</label>
              <input type="text" id="bulkEditPhone" class="input" placeholder="Deixe vazio para n√£o alterar" />
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <label style="color: #cbd5f5; font-size: 0.85rem; font-weight: 700;">Pergunta</label>
              <textarea id="bulkEditQuestion" class="input" style="min-height: 80px;" placeholder="Deixe vazio para n√£o alterar"></textarea>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <label style="color: #cbd5f5; font-size: 0.85rem; font-weight: 700;">Plataforma</label>
              <input type="text" id="bulkEditPlataforma" class="input" placeholder="Ex: Google, Meta, etc." />
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <label style="color: #cbd5f5; font-size: 0.85rem; font-weight: 700;">Fonte</label>
              <input type="text" id="bulkEditSource" class="input" placeholder="Deixe vazio para n√£o alterar" />
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <label style="color: #cbd5f5; font-size: 0.85rem; font-weight: 700;">üìÖ Quando (Data)</label>
              <input type="date" id="bulkEditDate" class="input" style="color-scheme: dark;" />
              <small style="color: #94a3b8; font-size: 0.75rem;">
                Deixe vazio para n√£o alterar. Esta data ser√° aplicada a todos os leads selecionados.
              </small>
            </div>
          </div>
          <div class="modal-foot">
            <button class="btn" id="bulkEditSave" type="button">Salvar Altera√ß√µes</button>
            <button class="btn ghost" id="bulkEditCancel" type="button">Cancelar</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Bind events
      const closeBtn = modal.querySelector('#bulkEditClose');
      const cancelBtn = modal.querySelector('#bulkEditCancel');
      const saveBtn = modal.querySelector('#bulkEditSave');
      
      const close = () => {
        modal.remove();
      };
      
      closeBtn?.addEventListener('click', close);
      cancelBtn?.addEventListener('click', close);
      modal.addEventListener('click', (e) => {
        if(e.target === modal) close();
      });
      
      saveBtn?.addEventListener('click', async () => {
        const name = modal.querySelector('#bulkEditName').value.trim();
        const email = modal.querySelector('#bulkEditEmail').value.trim();
        const phone = modal.querySelector('#bulkEditPhone').value.trim();
        const question = modal.querySelector('#bulkEditQuestion').value.trim();
        const plataforma = modal.querySelector('#bulkEditPlataforma').value.trim();
        const source = modal.querySelector('#bulkEditSource').value.trim();
        const dateValue = modal.querySelector('#bulkEditDate').value.trim();
        
        const patch = {};
        if(name) patch.name = name;
        if(email) patch.email = email;
        if(phone) patch.phone = phone;
        if(question) patch.question = question;
        if(plataforma) patch.plataforma = plataforma;
        if(source) patch.source = source;
        
        // Adicionar data se preenchida
        if(dateValue){
          try{
            const [year, month, day] = dateValue.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            patch.createdAt = Timestamp.fromDate(date);
          }catch(err){
            console.warn('[Bulk Edit] Erro ao converter data:', err);
            alert('Erro ao processar a data. Verifique o formato.');
            return;
          }
        }
        
        if(Object.keys(patch).length === 0){
          alert('Nenhum campo foi preenchido.');
          return;
        }
        
        saveBtn.disabled = true;
        saveBtn.textContent = 'Salvando...';
        
        try{
          for(const leadId of selectedIds){
            await updateLead(leadId, patch);
          }
          
          if(typeof mgToast === 'function'){
            mgToast(`${selectedIds.length} lead(s) atualizado(s)!`);
          }
          
          clearBulkSelection();
          close();
        }catch(err){
          console.error('bulkEditLeads', err);
          alert('Erro ao atualizar leads: ' + (err?.message || String(err)));
          saveBtn.disabled = false;
          saveBtn.textContent = 'Salvar Altera√ß√µes';
        }
      });
    }

    // ========= IMPORT FUNCTIONS =========
    
    function downloadLeadsTemplate(){
      // Cria CSV template com colunas corretas
      const headers = ['name', 'email', 'phone', 'question', 'plataforma', 'source'];
      const exampleRow = ['Jo√£o Silva', 'joao@email.com', '(11) 99999-9999', 'Gostaria de saber mais sobre o produto', 'Google', 'Formul√°rio Site'];
      
      const csvContent = [
        headers.join(','),
        exampleRow.join(','),
        // Linhas vazias para o usu√°rio preencher
        ',,,,,',
        ',,,,,',
        ',,,,,,'
      ].join('\n');
      
      const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', 'template_leads.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      if(typeof mgToast === 'function'){
        mgToast('Template baixado! Preencha e importe.');
      }
    }
    
    function openImportModal(){
      const modal = document.createElement('div');
      modal.className = 'modal show';
      modal.style.zIndex = '100001';
      modal.innerHTML = `
        <div class="modal-card" style="max-width: 800px; max-height: 90vh;">
          <div class="modal-head">
            <h3 style="margin: 0;">üì§ Importar Leads em Massa</h3>
            <button class="btn small ghost" id="importModalClose" type="button">Fechar</button>
          </div>
          <div class="modal-body" style="display: flex; flex-direction: column; gap: 16px; padding: 20px; overflow-y: auto;">
            <div style="background: rgba(56,189,248,.12); border: 1px solid rgba(56,189,248,.35); border-radius: 10px; padding: 12px;">
              <strong style="color: #bae6fd; display: block; margin-bottom: 6px;">üìã Instru√ß√µes:</strong>
              <ol style="margin: 0; padding-left: 20px; color: #cbd5f5; font-size: 0.9rem; line-height: 1.6;">
                <li>Baixe o template CSV clicando no bot√£o abaixo</li>
                <li>Preencha com os dados dos seus leads</li>
                <li>Salve o arquivo em formato CSV (separado por v√≠rgulas)</li>
                <li>Fa√ßa upload do arquivo preenchido</li>
                <li>Revise os dados no preview</li>
                <li>Clique em "Importar" para adicionar os leads</li>
              </ol>
            </div>
            
            <div style="background: rgba(34,197,94,.12); border: 1px solid rgba(34,197,94,.35); border-radius: 10px; padding: 12px;">
              <strong style="color: #bbf7d0; display: block; margin-bottom: 6px;">‚úÖ Colunas Reconhecidas (flex√≠vel):</strong>
              <ul style="margin: 0; padding-left: 20px; color: #86efac; font-size: 0.85rem; line-height: 1.5;">
                <li><code>name</code> ou <code>nome</code> - Nome do lead</li>
                <li><code>email</code> ou <code>e-mail</code> - E-mail</li>
                <li><code>phone</code> ou <code>telefone</code> - Telefone</li>
                <li><code>question</code> ou <code>pergunta</code> ou <code>mensagem</code> - Mensagem</li>
                <li><code>plataforma</code> ou <code>platform</code> - Origem</li>
                <li><code>source</code> ou <code>fonte</code> - Fonte espec√≠fica</li>
              </ul>
              <p style="margin: 8px 0 0; color: #86efac; font-size: 0.8rem;">üí° N√£o precisa ter todas as colunas! O sistema √© flex√≠vel.</p>
            </div>
            
            <div style="background: rgba(34,197,94,.12); border: 1px solid rgba(34,197,94,.35); border-radius: 10px; padding: 12px;">
              <strong style="color: #bbf7d0; display: block; margin-bottom: 6px;">üí° Como salvar CSV corretamente:</strong>
              <ul style="margin: 0; padding-left: 20px; color: #86efac; font-size: 0.85rem; line-height: 1.5;">
                <li><strong>Excel:</strong> "Salvar Como" ‚Üí CSV UTF-8 (separado por v√≠rgulas)</li>
                <li><strong>Google Sheets:</strong> Arquivo ‚Üí Fazer download ‚Üí .CSV (separado por v√≠rgulas)</li>
                <li><strong>LibreOffice:</strong> Salvar Como ‚Üí Texto CSV (.csv) ‚Üí UTF-8</li>
                <li><strong>Importante:</strong> Use v√≠rgula (,) como separador, n√£o ponto e v√≠rgula (;)</li>
              </ul>
            </div>
            
            <button class="btn" id="importDownloadTemplate" type="button" style="align-self: flex-start;">
              üì• Baixar Template CSV
            </button>
            
            <div id="importDropzone" class="leads-import-dropzone">
              <div class="leads-import-icon">üìÅ</div>
              <div class="leads-import-text">Arraste o arquivo CSV aqui ou clique para selecionar</div>
              <div class="leads-import-hint">Apenas arquivos .CSV s√£o aceitos</div>
              <input type="file" id="importFileInput" accept=".csv" style="display: none;" />
            </div>
            
            <div id="importStatus" class="leads-import-status"></div>
            
            <div id="importPreviewContainer" style="display: none;">
              <h4 style="margin: 0 0 12px 0; color: #f8fafc;">üìä Preview dos Dados</h4>
              <div class="leads-preview-container">
                <table class="leads-preview-table" id="importPreviewTable"></table>
              </div>
              <div style="margin-top: 12px; color: #cbd5f5; font-size: 0.9rem;">
                <strong id="importPreviewCount">0</strong> lead(s) prontos para importar
              </div>
            </div>
          </div>
          <div class="modal-foot">
            <button class="btn" id="importExecuteBtn" type="button" style="display: none;">
              ‚úÖ Importar Leads
            </button>
            <button class="btn ghost" id="importCancelBtn" type="button">Cancelar</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Elementos
      const closeBtn = modal.querySelector('#importModalClose');
      const cancelBtn = modal.querySelector('#importCancelBtn');
      const downloadBtn = modal.querySelector('#importDownloadTemplate');
      const dropzone = modal.querySelector('#importDropzone');
      const fileInput = modal.querySelector('#importFileInput');
      const statusEl = modal.querySelector('#importStatus');
      const previewContainer = modal.querySelector('#importPreviewContainer');
      const previewTable = modal.querySelector('#importPreviewTable');
      const previewCount = modal.querySelector('#importPreviewCount');
      const executeBtn = modal.querySelector('#importExecuteBtn');
      
      let parsedData = [];
      
      const close = () => {
        modal.remove();
      };
      
      closeBtn?.addEventListener('click', close);
      cancelBtn?.addEventListener('click', close);
      modal.addEventListener('click', (e) => {
        if(e.target === modal) close();
      });
      
      downloadBtn?.addEventListener('click', () => {
        downloadLeadsTemplate();
      });
      
      // Drag & Drop
      dropzone?.addEventListener('click', () => {
        fileInput.click();
      });
      
      dropzone?.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzone.classList.add('dragover');
      });
      
      dropzone?.addEventListener('dragleave', () => {
        dropzone.classList.remove('dragover');
      });
      
      dropzone?.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if(files.length > 0){
          handleFileSelect(files[0]);
        }
      });
      
      fileInput?.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if(file){
          handleFileSelect(file);
        }
      });
      
      executeBtn?.addEventListener('click', async () => {
        await executeImport(parsedData);
      });
      
      async function handleFileSelect(file){
        console.log('[Import] üìÅ Arquivo selecionado:', {
          nome: file.name,
          tipo: file.type,
          tamanho: file.size + ' bytes',
          modificado: new Date(file.lastModified).toLocaleString('pt-BR')
        });
        
        statusEl.className = 'leads-import-status';
        statusEl.textContent = '';
        previewContainer.style.display = 'none';
        executeBtn.style.display = 'none';
        parsedData = [];
        
        const fileName = file.name.toLowerCase();
        
        if(!fileName.endsWith('.csv')){
          console.error('[Import] ‚ùå Formato inv√°lido:', fileName);
          statusEl.className = 'leads-import-status error';
          statusEl.textContent = `‚ùå Formato n√£o suportado: "${file.name}". Apenas arquivos .CSV s√£o aceitos.`;
          return;
        }
        
        console.log('[Import] ‚úÖ Formato v√°lido (CSV), iniciando processamento...');
        await parseCSV(file);
      }
      
      async function parseCSV(file){
        try{
          statusEl.className = 'leads-import-status info';
          statusEl.textContent = '‚è≥ Processando arquivo CSV...';
          
          const text = await file.text();
          console.log('[CSV Import] Arquivo lido, tamanho:', text.length, 'caracteres');
          
          // Remove BOM se presente
          const cleanText = text.replace(/^\uFEFF/, '');
          
          // Divide em linhas
          const lines = cleanText.split(/\r?\n/).map(line => line.trim()).filter(line => line.length > 0);
          console.log('[CSV Import] Total de linhas:', lines.length);
          
          if(lines.length < 2){
            statusEl.className = 'leads-import-status error';
            statusEl.textContent = '‚ùå Arquivo vazio ou sem dados. O arquivo deve ter pelo menos o cabe√ßalho e uma linha de dados.';
            return;
          }
          
          // Detecta separador automaticamente (TAB, v√≠rgula ou ponto-e-v√≠rgula)
          const firstLine = lines[0];
          let separator = ',';
          if(firstLine.includes('\t')){
            separator = '\t';
            console.log('[CSV Import] üìã Detectado formato EXCEL/PLANILHA (separador TAB)');
          } else if(firstLine.includes(';')){
            separator = ';';
            console.log('[CSV Import] üìã Detectado formato CSV com ponto-e-v√≠rgula');
          } else {
            console.log('[CSV Import] üìã Detectado formato CSV padr√£o (v√≠rgula)');
          }
          
          // Parse header
          const headerLine = lines[0];
          console.log('[CSV Import] Header:', headerLine);
          const headers = parseCSVLine(headerLine, separator).map(h => h.trim().toLowerCase().replace(/['"]/g, ''));
          console.log('[CSV Import] Colunas encontradas:', headers);
          
          // ‚úÖ NENHUMA COLUNA √â OBRIGAT√ìRIA - aceita qualquer estrutura
          if(headers.length === 0){
            statusEl.className = 'leads-import-status error';
            statusEl.textContent = '‚ùå N√£o foi poss√≠vel identificar as colunas. Verifique se a primeira linha cont√©m os nomes das colunas.';
            return;
          }
          
          // Parse dados
          const data = [];
          let skippedLines = 0;
          
          for(let i = 1; i < lines.length; i++){
            const line = lines[i];
            if(!line || line.trim() === '') continue;
            
            const values = parseCSVLine(line, separator);
            console.log(`[CSV Import] Linha ${i}:`, values);
            
            const row = {};
            headers.forEach((header, index) => {
              const value = values[index] || '';
              row[header] = value.trim().replace(/^["']|["']$/g, '');
            });
            
            // ‚úÖ Aceita QUALQUER linha que tenha pelo menos UM campo preenchido
            const hasAnyData = Object.values(row).some(v => v && v.trim().length > 0);
            
            if(hasAnyData){
              data.push(row);
            } else {
              console.warn(`[CSV Import] Linha ${i} ignorada: completamente vazia`, row);
              skippedLines++;
            }
          }
          
          console.log('[CSV Import] Leads v√°lidos:', data.length);
          console.log('[CSV Import] Linhas ignoradas:', skippedLines);
          
          if(data.length === 0){
            statusEl.className = 'leads-import-status error';
            statusEl.textContent = '‚ùå Nenhum lead v√°lido encontrado. Certifique-se de preencher nome e email em cada linha.';
            return;
          }
          
          parsedData = data;
          displayPreview(data);
          
          statusEl.className = 'leads-import-status success';
          let msg = `‚úÖ Arquivo processado com sucesso! ${data.length} lead(s) v√°lido(s) encontrado(s).`;
          if(skippedLines > 0){
            msg += ` (${skippedLines} linha(s) ignorada(s) por dados incompletos)`;
          }
          statusEl.textContent = msg;
          executeBtn.style.display = 'inline-block';
          
        }catch(err){
          console.error('[CSV Import] Erro:', err);
          statusEl.className = 'leads-import-status error';
          statusEl.textContent = '‚ùå Erro ao processar arquivo CSV: ' + (err?.message || String(err));
        }
      }
      
      function parseCSVLine(line, separator = ','){
        // Parser ULTRA-FLEX√çVEL que aceita TAB, v√≠rgula ou ponto-e-v√≠rgula
        const result = [];
        let current = '';
        let inQuotes = false;
        let i = 0;
        
        while(i < line.length){
          const char = line[i];
          const nextChar = line[i + 1];
          
          if(char === '"'){
            if(inQuotes && nextChar === '"'){
              // Aspas duplas escapadas ""
              current += '"';
              i += 2;
              continue;
            } else {
              // Toggle estado de aspas
              inQuotes = !inQuotes;
              i++;
              continue;
            }
          }
          
          if(char === separator && !inQuotes){
            // Fim do campo
            result.push(current.trim());
            current = '';
            i++;
            continue;
          }
          
          current += char;
          i++;
        }
        
        // √öltimo campo
        result.push(current.trim());
        
        // Remove aspas externas se houver
        return result.map(val => {
          const trimmed = val.trim();
          if((trimmed.startsWith('"') && trimmed.endsWith('"')) || 
             (trimmed.startsWith("'") && trimmed.endsWith("'"))){
            return trimmed.slice(1, -1).trim();
          }
          return trimmed;
        });
      }
      
      function displayPreview(data){
        if(!data || data.length === 0){
          previewContainer.style.display = 'none';
          return;
        }
        
        // Mapeia nomes t√©cnicos para nomes amig√°veis
        const headerMap = {
          'name': 'Nome',
          'email': 'E-mail',
          'phone': 'Telefone',
          'question': 'Pergunta',
          'plataforma': 'Plataforma',
          'source': 'Fonte'
        };
        
        // Descobre TODAS as colunas presentes nos dados (flex√≠vel!)
        const allKeys = new Set();
        data.forEach(row => {
          Object.keys(row).forEach(key => {
            if(key && key.trim()) allKeys.add(key.trim());
          });
        });
        
        const keys = Array.from(allKeys);
        
        // Se n√£o houver colunas, n√£o mostra preview
        if(keys.length === 0){
          previewContainer.style.display = 'none';
          return;
        }
        
        let html = '<thead><tr>';
        keys.forEach(key => {
          const displayName = headerMap[key] || key.charAt(0).toUpperCase() + key.slice(1);
          html += `<th>${displayName}</th>`;
        });
        html += '</tr></thead><tbody>';
        
        const displayData = data.slice(0, 10); // Mostrar apenas primeiros 10
        displayData.forEach(row => {
          html += '<tr>';
          keys.forEach(key => {
            const value = row[key] || '-';
            const displayValue = value.length > 30 ? value.substring(0, 30) + '...' : value;
            const cellClass = value === '-' || !value ? 'style="color: #64748b; font-style: italic;"' : '';
            html += `<td ${cellClass} title="${value}">${displayValue}</td>`;
          });
          html += '</tr>';
        });
        
        if(data.length > 10){
          html += `<tr><td colspan="${keys.length}" style="text-align: center; color: #94a3b8; font-style: italic; padding: 12px;">
            ... e mais ${data.length - 10} lead(s)
          </td></tr>`;
        }
        
        html += '</tbody>';
        
        previewTable.innerHTML = html;
        previewCount.textContent = data.length;
        previewContainer.style.display = 'block';
      }
      
      async function executeImport(data){
        if(!data || data.length === 0){
          alert('Nenhum dado para importar.');
          return;
        }
        
        executeBtn.disabled = true;
        executeBtn.textContent = 'Importando...';
        statusEl.className = 'leads-import-status info';
        statusEl.textContent = '‚è≥ Importando leads...';
        
        try{
          const uid = auth?.currentUser?.uid;
          const clientKey = getClientKeySafe();
          
          if(!uid || !clientKey){
            throw new Error('Sess√£o expirada ou cliente n√£o selecionado.');
          }
          
          let successCount = 0;
          let errorCount = 0;
          let emptyCount = 0;
          
          for(let i = 0; i < data.length; i++){
            const row = data[i];
            
            // Atualizar progresso
            statusEl.textContent = `‚è≥ Importando ${i + 1} de ${data.length}...`;
            
            try{
              // Verificar se h√° pelo menos um campo preenchido
              const hasData = Object.values(row).some(v => v && String(v).trim().length > 0);
              
              if(!hasData){
                emptyCount++;
                continue;
              }
              
              // Cria objeto din√¢mico - APENAS com campos que existem e n√£o est√£o vazios
              const leadData = {
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp()
              };
              
              // Adiciona campos de forma condicional
              if(row.name && String(row.name).trim()){
                leadData.name = String(row.name).trim();
              }
              if(row.email && String(row.email).trim()){
                leadData.email = String(row.email).trim();
              }
              if(row.phone && String(row.phone).trim()){
                leadData.phone = String(row.phone).trim();
              }
              if(row.question && String(row.question).trim()){
                leadData.question = String(row.question).trim();
              }
              if(row.plataforma && String(row.plataforma).trim()){
                leadData.plataforma = String(row.plataforma).trim();
              }
              if(row.source && String(row.source).trim()){
                leadData.source = String(row.source).trim();
              }
              
              const colRef = collection(db, 'usuarios', uid, 'clients', clientKey, 'leads');
              await addDoc(colRef, leadData);
              successCount++;
              
            }catch(err){
              console.error('[Import] Erro ao importar lead:', row, err);
              errorCount++;
            }
          }
          
          console.log('[Import] Resultado:', { successCount, errorCount, emptyCount });
          
          let message = `‚úÖ Importa√ß√£o conclu√≠da! ${successCount} lead(s) adicionado(s)`;
          let statusClass = 'success';
          
          if(errorCount > 0){
            message += `, ${errorCount} erro(s)`;
            statusClass = 'warning';
          }
          if(emptyCount > 0){
            message += `, ${emptyCount} vazio(s) ignorado(s)`;
          }
          
          statusEl.className = `leads-import-status ${statusClass}`;
          statusEl.textContent = message;
          
          if(typeof mgToast === 'function'){
            mgToast(`${successCount} lead(s) importado(s)!`);
          }
          
          executeBtn.style.display = 'none';
          previewContainer.style.display = 'none';
          
          setTimeout(() => {
            close();
          }, 2500);
          
        }catch(err){
          console.error('[Import] Erro geral:', err);
          statusEl.className = 'leads-import-status error';
          statusEl.textContent = '‚ùå Erro na importa√ß√£o: ' + (err?.message || String(err));
          executeBtn.disabled = false;
          executeBtn.textContent = '‚úÖ Importar Leads';
        }
      }
    }

    /* ========= Refer√™ncias Redes ========= */
    let REF_SOCIAL = [];
    const refSocialLinkPreviewCache = new Map();
    const refSocialPreviewPending = new Set();
    let refSocialLinkPreviewData = null;
    let refSocialLinkPreviewTimer = null;

    function getRefSocialMode(){
      return refSocialForm?.dataset.mode === 'upload' ? 'upload' : 'link';
    }
    function setRefSocialMode(mode){
      if(!refSocialForm) return;
      const normalized = mode === 'upload' ? 'upload' : 'link';
      refSocialForm.dataset.mode = normalized;
      if(refSocialModeToggle){
        refSocialModeToggle.querySelectorAll('button[data-mode]').forEach(btn=>{
          btn.classList.toggle('active', btn.dataset.mode === normalized);
        });
      }
      if(normalized === 'upload'){
        if(refSocialLinkInput){
          refSocialLinkInput.value = '';
        }
        refSocialLinkPreviewData = null;
        refSocialForm?.removeAttribute('data-preview-url');
        resetRefSocialLinkPreview('Cole um link para gerar a pr√©-visualiza√ß√£o.');
      } else {
        if(refSocialFile){
          try{ refSocialFile.value = ''; }catch(_){ }
        }
      }
    }
    setRefSocialMode(getRefSocialMode());
    refSocialModeToggle?.addEventListener('click', evt=>{
      const btn = evt.target.closest('button[data-mode]');
      if(!btn) return;
      evt.preventDefault();
      const current = getRefSocialMode();
      const next = btn.dataset.mode;
      if(!next || next === current) return;
      setRefSocialMode(next);
    });

    const normalizeRefLink = (url)=>{
      if(!url) return '';
      let trimmed = url.trim();
      if(!trimmed) return '';
      if(!/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(trimmed)){
        trimmed = 'https://' + trimmed;
      }
      return trimmed;
    };
    const detectRefLinkProvider = (url)=>{
      const lower = (url || '').toLowerCase();
      if(lower.includes('instagram.com')) return 'instagram';
      if(lower.includes('tiktok.com')) return 'tiktok';
      if(lower.includes('youtu')) return 'youtube';
      return 'link';
    };
    function youtubeIdFromUrl(url){
      if(!url) return null;
      try{
        const u = new URL(url);
        if(u.hostname.includes('youtu.be')){
          return u.pathname.split('/').filter(Boolean)[0] || null;
        }
        if(u.searchParams.get('v')) return u.searchParams.get('v');
        const pathMatch = u.pathname.match(/\/shorts\/([\w-]{5,})/);
        if(pathMatch) return pathMatch[1];
        const embedMatch = u.pathname.match(/\/embed\/([\w-]{5,})/);
        if(embedMatch) return embedMatch[1];
      }catch(_){
        const fallback = url.match(/(?:youtu\.be\/|v=|\/shorts\/|\/embed\/)([\w-]{5,})/);
        return fallback ? fallback[1] : null;
      }
      return null;
    }
    const instagramInfoFromUrl = (url)=>{
      if(!url) return null;
      const match = url.match(/instagram\.com\/(p|reel|tv)\/([\w-]+)/i);
      if(match) return { type: match[1], id: match[2] };
      return null;
    };
    const tiktokIdFromUrl = (url)=>{
      if(!url) return null;
      const match = url.match(/tiktok\.com\/@[^/]+\/video\/(\d+)/i) || url.match(/tiktok\.com\/(?:t|v)\/(\w+)/i);
      return match ? match[1] : null;
    };
    async function buildRefSocialLinkPreview(rawUrl){
      const url = normalizeRefLink(rawUrl);
      if(!url) throw new Error('URL inv√°lida');
      if(refSocialLinkPreviewCache.has(url)){
        return { ...refSocialLinkPreviewCache.get(url) };
      }
      const provider = detectRefLinkProvider(url);
      const preview = { url, provider };
      try{
        const res = await fetch(`https://noembed.com/embed?url=${encodeURIComponent(url)}`);
        if(res.ok){
          const data = await res.json();
          if(!preview.provider && data?.provider_name){
            preview.provider = (data.provider_name || '').toLowerCase();
          }
          if(data?.title) preview.title = data.title;
          if(data?.thumbnail_url) preview.thumbnail = data.thumbnail_url;
          if(data?.html && provider === 'youtube' && !preview.embedUrl){
            const iframeMatch = data.html.match(/src=\"([^\"]+)\"/i);
            if(iframeMatch) preview.embedUrl = iframeMatch[1];
          }
        }
      }catch(err){
        console.warn('buildRefSocialLinkPreview', err);
      }
      if(provider === 'youtube'){
        const yId = youtubeIdFromUrl(url);
        if(yId){
          preview.embedUrl = `https://www.youtube.com/embed/${yId}`;
          preview.thumbnail = preview.thumbnail || `https://img.youtube.com/vi/${yId}/hqdefault.jpg`;
        }
      } else if(provider === 'instagram'){
        const info = instagramInfoFromUrl(url);
        if(info){
          preview.embedUrl = `https://www.instagram.com/${info.type}/${info.id}/embed/`;
        }
      } else if(provider === 'tiktok'){
        const ttId = tiktokIdFromUrl(url);
        if(ttId){
          preview.embedUrl = `https://www.tiktok.com/embed/v2/${ttId}`;
        }
      }
      if(!preview.title){
        preview.title = url.replace(/^https?:\/\//i, '');
      }
      refSocialLinkPreviewCache.set(url, { ...preview });
      return { ...preview };
    }
    function resetRefSocialLinkPreview(message){
      if(!refSocialLinkPreview) return;
      refSocialLinkPreviewData = null;
      refSocialForm?.removeAttribute('data-preview-url');
      refSocialLinkPreview.dataset.state = 'empty';
      refSocialLinkPreview.innerHTML = `<p class="muted" style="margin:0">${message || 'Cole um link para gerar a pr√©-visualiza√ß√£o.'}</p>`;
    }
    function showRefSocialLinkPreviewLoading(){
      if(!refSocialLinkPreview) return;
      refSocialLinkPreview.dataset.state = 'loading';
      refSocialLinkPreview.innerHTML = '<p class="muted" style="margin:0">Gerando pr√©via...</p>';
    }
    function renderRefSocialLinkPreview(preview){
      if(!refSocialLinkPreview) return;
      refSocialLinkPreview.dataset.state = 'ready';
      refSocialLinkPreview.innerHTML = '';
      const mediaWrap = document.createElement('div');
      mediaWrap.className = 'refsocial-link-preview-media';
      if(preview.embedUrl){
        const iframe = document.createElement('iframe');
        iframe.src = preview.embedUrl;
        iframe.loading = 'lazy';
        iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
        iframe.allowFullscreen = true;
        mediaWrap.appendChild(iframe);
      } else if(preview.thumbnail){
        const img = document.createElement('img');
        img.src = preview.thumbnail;
        img.alt = preview.title || 'Pr√©via do link';
        img.loading = 'lazy';
        mediaWrap.appendChild(img);
      }
      if(mediaWrap.childNodes.length){
        refSocialLinkPreview.appendChild(mediaWrap);
      }
      const meta = document.createElement('div');
      meta.className = 'refsocial-link-preview-meta';
      const providerEl = document.createElement('strong');
      providerEl.textContent = (preview.provider || 'Link').toUpperCase();
      meta.appendChild(providerEl);
      if(preview.title){
        const titleEl = document.createElement('span');
        titleEl.textContent = preview.title;
        meta.appendChild(titleEl);
      }
      const linkEl = document.createElement('a');
      linkEl.href = preview.url;
      linkEl.target = '_blank';
      linkEl.rel = 'noopener noreferrer';
      linkEl.textContent = 'Abrir link original';
      meta.appendChild(linkEl);
      refSocialLinkPreview.appendChild(meta);
    }
    async function ensureRefSocialLinkPreview(item){
      if(!item || (item.embedUrl || item.thumbnail) || !item.url) return;
      if(refSocialPreviewPending.has(item.id)) return;
      refSocialPreviewPending.add(item.id);
      try{
        const preview = await buildRefSocialLinkPreview(item.url);
        let changed = false;
        ['embedUrl','thumbnail','title','provider'].forEach(key=>{
          if(preview[key] && item[key] !== preview[key]){
            item[key] = preview[key];
            changed = true;
          }
        });
        if(!item.type) item.type = 'link';
        if(!item.sourceType) item.sourceType = 'link';
        if(changed){
          await persistRefSocial();
          renderRefSocial();
        }
      }catch(err){
        console.warn('ensureRefSocialLinkPreview', err);
      }finally{
        refSocialPreviewPending.delete(item.id);
      }
    }
    async function loadRefSocial(){
      const uid = auth.currentUser?.uid;
      if(!uid){ REF_SOCIAL = []; return; }
      const rawClientKey = (typeof window.TENANT === 'string' && window.TENANT)
        || document.body.getAttribute('data-client-id');
      if (!rawClientKey || rawClientKey === 'no-client') {
        console.warn('Cliente n√£o definido na URL.');
        REF_SOCIAL = [];
        return;
      }
      const safeClientKey = rawClientKey.replace(/[^\w-]/g, '_');
      try{
        let snap = await getDoc(doc(db, 'usuarios', uid, 'clients', safeClientKey));
        if(!snap.exists() && safeClientKey !== rawClientKey){
          snap = await getDoc(doc(db, 'usuarios', uid, 'clients', rawClientKey));
        }
        const data = snap.exists() ? snap.data() : {};
        REF_SOCIAL = Array.isArray(data.refSocial) ? data.refSocial : [];
      }catch(err){
        console.error('loadRefSocial', err);
        REF_SOCIAL = [];
      }
      await refreshStorageUsage();
      try{ refreshMacroInsights(); }catch(_){ }
    }
    async function persistRefSocial(){
      const uid = auth.currentUser?.uid; if(!uid) return;
      const rawClientKey = (typeof window.TENANT === 'string' && window.TENANT)
        || document.body.getAttribute('data-client-id');
      if (!rawClientKey || rawClientKey === 'no-client') {
        console.warn('Cliente n√£o definido na URL.');
        return;
      }
      const safeClientKey = rawClientKey.replace(/[^\w-]/g, '_');
      USER_DATA.refSocial = REF_SOCIAL;
      try{
        await setDoc(doc(db, 'usuarios', uid, 'clients', safeClientKey), { refSocial: REF_SOCIAL }, { merge: true });
        await refreshStorageUsage();
        try{ refreshMacroInsights(); }catch(_){ }
      }catch(err){
        console.error('persistRefSocial', err);
      }
    }
    function renderRefSocial(){
      if(!refSocialList) return;
      refSocialList.innerHTML = "";
      REF_SOCIAL.forEach(item=>{
        const div=document.createElement("div");
        div.className="ref-item";

        const mediaWrap=document.createElement("div");
        mediaWrap.className="ref-item-media";
        if((item.sourceType === 'link' || item.type === 'link')){
          if(item.embedUrl){
            const iframe=document.createElement('iframe');
            iframe.src=item.embedUrl;
            iframe.loading='lazy';
            iframe.allow='accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
            iframe.allowFullscreen=true;
            mediaWrap.appendChild(iframe);
          } else if(item.thumbnail){
            const img=document.createElement('img');
            img.src=item.thumbnail;
            img.alt=item.title || item.details || 'Pr√©via do link';
            img.loading='lazy';
            mediaWrap.appendChild(img);
          } else {
            const placeholder=document.createElement('div');
            placeholder.className='muted';
            placeholder.style.padding='18px';
            placeholder.textContent='Pr√©via indispon√≠vel';
            mediaWrap.appendChild(placeholder);
            ensureRefSocialLinkPreview(item);
          }
        } else {
          let mediaEl;
          if(item.type && item.type.startsWith("video")){
            mediaEl=document.createElement("video");
            mediaEl.src=item.url;
            mediaEl.controls=true;
          } else {
            mediaEl=document.createElement("img");
            mediaEl.src=item.url;
            mediaEl.alt="";
            mediaEl.loading="lazy";
          }
          mediaWrap.appendChild(mediaEl);
        }
        div.appendChild(mediaWrap);

        const detailsWrap=document.createElement("div");
        detailsWrap.className="ref-item-details";
        if(item.sourceType === 'link' || item.type === 'link'){
          const linkInfo=document.createElement('div');
          linkInfo.className='ref-link-info';
          if(item.provider){
            const providerEl=document.createElement('span');
            providerEl.className='ref-link-provider';
            providerEl.textContent=(item.provider||'Link').toUpperCase();
            linkInfo.appendChild(providerEl);
          }
          if(item.title){
            const titleEl=document.createElement('p');
            titleEl.style.margin='0';
            titleEl.textContent=item.title;
            linkInfo.appendChild(titleEl);
          }
          const linkActions=document.createElement('div');
          linkActions.className='ref-link-actions';
          const anchor=document.createElement('a');
          anchor.href=item.url || '#';
          anchor.target='_blank';
          anchor.rel='noopener noreferrer';
          anchor.textContent='Abrir refer√™ncia';
          linkActions.appendChild(anchor);
          linkInfo.appendChild(linkActions);
          detailsWrap.appendChild(linkInfo);
        }
        const categoryEl=document.createElement("strong");
        categoryEl.textContent=item.category || "";
        const detailsText=document.createElement("div");
        detailsText.className="ref-item-details-text markdown-view";
        detailsText.innerHTML=renderMarkdownText(item.details || "");
        detailsWrap.appendChild(categoryEl);
        detailsWrap.appendChild(detailsText);

        const actions=document.createElement("div");
        actions.className="ref-item-actions";
        const editBtn=document.createElement("button");
        editBtn.type="button";
        editBtn.className="ref-edit";
        editBtn.textContent="Editar texto";
        editBtn.addEventListener("click", ()=>{
          if(div.dataset.editing === "1") return;
          div.dataset.editing = "1";
          const textarea=document.createElement("textarea");
          textarea.className="ref-edit-input";
          textarea.rows = 4;
          textarea.value=item.details || "";
          detailsWrap.replaceChild(textarea, detailsText);
          textarea.focus();
          try{ textarea.setSelectionRange(textarea.value.length, textarea.value.length); }catch(_){ }

          const saveBtn=document.createElement("button");
          saveBtn.type="button";
          saveBtn.className="ref-save";
          saveBtn.textContent="Salvar";
          const cancelBtn=document.createElement("button");
          cancelBtn.type="button";
          cancelBtn.className="ref-cancel";
          cancelBtn.textContent="Cancelar";

          const exitEditing=()=>{
            delete div.dataset.editing;
            if(detailsWrap.contains(textarea)){
              detailsWrap.replaceChild(detailsText, textarea);
            }
            actions.innerHTML="";
            actions.appendChild(editBtn);
          };

          cancelBtn.addEventListener("click", ()=>{
            exitEditing();
          });

          saveBtn.addEventListener("click", async ()=>{
            const updated=textarea.value;
            if(updated === item.details){
              exitEditing();
              return;
            }
            const uid = auth.currentUser?.uid;
            if(!uid){
              alert('Fa√ßa login para salvar.');
              exitEditing();
              return;
            }
            const idx=REF_SOCIAL.findIndex(r=> r.id === item.id);
            if(idx === -1){
              exitEditing();
              return;
            }
            REF_SOCIAL[idx] = { ...REF_SOCIAL[idx], details: updated };
            detailsText.innerHTML = renderMarkdownText(updated);
            exitEditing();
            await persistRefSocial();
            renderRefSocial();
            if(typeof mgToast === "function"){
              mgToast("Texto atualizado!");
            }
          });

          textarea.addEventListener("keydown", evt=>{
            if(evt.key === "Escape"){
              evt.preventDefault();
              cancelBtn.click();
            }
            if((evt.metaKey || evt.ctrlKey) && evt.key === "Enter"){
              evt.preventDefault();
              saveBtn.click();
            }
          });

          actions.innerHTML="";
          actions.append(saveBtn, cancelBtn);
        });
        actions.appendChild(editBtn);
        detailsWrap.appendChild(actions);

        div.appendChild(detailsWrap);

        const btn=document.createElement("button");
        btn.type="button";
        btn.className="ref-remove";
        btn.textContent="√ó";
        btn.addEventListener("click", async ()=>{
          if(!confirm("Remover refer√™ncia?")) return;
          if(!STORAGE){ try{ STORAGE = getStorage(app); }catch(_){ } }
          try{ if(item.path) await deleteObject(sRef(STORAGE, item.path)); }catch(err){ console.error('deleteObject', err); }
          REF_SOCIAL = REF_SOCIAL.filter(r=> r.id !== item.id);
          await persistRefSocial();
          renderRefSocial();
        });
        div.appendChild(btn);
        refSocialList.appendChild(div);
      });
    }
    refSocialForm?.addEventListener("submit", async e=>{
      e.preventDefault();
      const mode = getRefSocialMode();
      if(mode === 'upload'){
        const file = refSocialFile?.files?.[0];
        if(!file){
          alert('Selecione um arquivo para enviar.');
          return;
        }
        const details = refSocialDetails?.value?.trim() || '';
        const category = refSocialCategory?.value || '';
        const uid = auth.currentUser?.uid;
        if(!uid) return alert('Fa√ßa login para salvar.');
        const clientKey = (typeof window.TENANT === 'string' && window.TENANT)
          || document.body.getAttribute('data-client-id');
        if (!clientKey || clientKey === 'no-client') {
          console.warn('Cliente n√£o definido na URL.');
          return;
        }
        if(!STORAGE){
          try{ STORAGE = getStorage(app); }catch(err){ console.error(err); return alert('Storage n√£o inicializado.'); }
        }
        const id = uuid();
        const safeClientKey = clientKey.replace(/[^\w-]/g, '_');
        const safeFileName = file.name.replace(/[^\w.-]/g, '_');
        const path = `usuarios/${uid}/clients/${safeClientKey}/refSocial/${id}_${safeFileName}`;
        try{
          const r = sRef(STORAGE, path);
          await uploadBytes(r, file);
          const url = await getDownloadURL(r);
          const fileSize = Number(file?.size);
          REF_SOCIAL.push({ id, sourceType:'upload', type:file.type, url, details, category, path, size: Number.isFinite(fileSize) && fileSize > 0 ? fileSize : null, contentType: file?.type || '' });
          await persistRefSocial();
          renderRefSocial();
          refSocialForm.reset();
          refSocialForm?.removeAttribute('data-preview-url');
        }catch(err){
          console.error('upload refSocial', err);
          const msg = err?.message || err?.code || String(err);
          alert('Erro ao enviar arquivo: ' + msg);
        }
        return;
      }

      const rawUrl = refSocialLinkInput?.value?.trim();
      if(!rawUrl){
        alert('Informe um link v√°lido.');
        refSocialLinkInput?.focus?.();
        return;
      }
      const url = normalizeRefLink(rawUrl);
      let preview = refSocialLinkPreviewData;
      if(!preview || preview.url !== url){
        try{
          showRefSocialLinkPreviewLoading();
          preview = await buildRefSocialLinkPreview(url);
          refSocialLinkPreviewData = preview;
          refSocialForm?.setAttribute('data-preview-url', preview.url);
          renderRefSocialLinkPreview(preview);
        }catch(err){
          console.warn('submit link preview', err);
          alert('N√£o foi poss√≠vel gerar a pr√©-visualiza√ß√£o deste link.');
          resetRefSocialLinkPreview('Cole um link para gerar a pr√©-visualiza√ß√£o.');
          return;
        }
      }
      const details = refSocialDetails?.value?.trim() || '';
      const category = refSocialCategory?.value || '';
      const id = uuid();
      const item = {
        id,
        sourceType:'link',
        type:'link',
        url: preview.url || url,
        category,
        details,
        provider: preview.provider || detectRefLinkProvider(url),
        title: preview.title || '',
        thumbnail: preview.thumbnail || null,
        embedUrl: preview.embedUrl || null
      };
      REF_SOCIAL.push(item);
      await persistRefSocial();
      renderRefSocial();
      refSocialForm.reset();
      refSocialForm?.removeAttribute('data-preview-url');
      resetRefSocialLinkPreview('Cole um link para gerar a pr√©-visualiza√ß√£o.');
    });
    refSocialLinkInput?.addEventListener('input', ()=>{
      if(getRefSocialMode() !== 'link') return;
      if(refSocialLinkPreviewTimer) clearTimeout(refSocialLinkPreviewTimer);
      const raw = refSocialLinkInput.value;
      if(!raw){
        refSocialForm?.removeAttribute('data-preview-url');
        resetRefSocialLinkPreview('Cole um link para gerar a pr√©-visualiza√ß√£o.');
        return;
      }
      refSocialLinkPreviewTimer = setTimeout(async ()=>{
        try{
          showRefSocialLinkPreviewLoading();
          const preview = await buildRefSocialLinkPreview(raw);
          refSocialLinkPreviewData = preview;
          refSocialForm?.setAttribute('data-preview-url', preview.url);
          renderRefSocialLinkPreview(preview);
        }catch(err){
          console.warn('preview link', err);
          resetRefSocialLinkPreview('N√£o foi poss√≠vel gerar a pr√©-visualiza√ß√£o. Verifique o link.');
        }
      }, 500);
    });
    refSocialForm?.addEventListener('reset', ()=>{
      refSocialForm?.removeAttribute('data-preview-url');
      setTimeout(()=> resetRefSocialLinkPreview('Cole um link para gerar a pr√©-visualiza√ß√£o.'), 0);
    });
    resetRefSocialLinkPreview('Cole um link para gerar a pr√©-visualiza√ß√£o.');
    loadRefSocial();
    renderRefSocial();


    /* ========= Notas ========= */
    let NOTES = []; // {id,title,html,sector,dateISO,updatedAt,createdAt}
    let noteMarkdownSource = '';
    let currentNoteId = null;
    let NOTE_TEMPLATES = []; // {id,name,markdown,createdAt,updatedAt}
    const sectorLabel = (v)=>({roi:"ROI","vitrine-engajamento":"Vitrine/Engajamento","novasideias":"Novas Ideias",relacionamento:"Relacionamento",ia:"I.A",gbp:"Google Business Profile"})[v]||v;

    function defaultDateISO(){ const d=new Date(); return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10); }
    function loadNotesFromUserData(){
      if(!Array.isArray(USER_DATA.notes)){
        NOTES = [];
        return;
      }
      NOTES = USER_DATA.notes.map(n=>{
        if(!n || typeof n !== 'object') return n;
        const copy = { ...n };
        if(typeof copy.createdAt === 'string'){ const num = Number(copy.createdAt); if(Number.isFinite(num)) copy.createdAt = num; }
        if(typeof copy.updatedAt === 'string'){ const num = Number(copy.updatedAt); if(Number.isFinite(num)) copy.updatedAt = num; }
        return copy;
      });
      try{ refreshMacroInsights(); }catch(_){ }
    }
    function saveNotesToUserData(){ USER_DATA.notes = NOTES; }

    function loadNoteTemplatesFromUserData(){
      if(!Array.isArray(USER_DATA.noteTemplates)){
        NOTE_TEMPLATES = [];
        refreshNoteTemplateOptions();
        return;
      }
      NOTE_TEMPLATES = USER_DATA.noteTemplates.map(t=>{
        if(!t || typeof t !== 'object') return null;
        const copy = { ...t };
        if(!copy.id){ copy.id = uuid(); }
        if(typeof copy.createdAt === 'string'){ const num = Number(copy.createdAt); if(Number.isFinite(num)) copy.createdAt = num; }
        if(typeof copy.updatedAt === 'string'){ const num = Number(copy.updatedAt); if(Number.isFinite(num)) copy.updatedAt = num; }
        const raw = typeof copy.markdown === 'string' ? copy.markdown : (typeof copy.content === 'string' ? copy.content : '');
        copy.markdown = normalizeNoteRaw(raw);
        delete copy.content;
        return copy;
      }).filter(Boolean);
      refreshNoteTemplateOptions();
    }
    function saveNoteTemplatesToUserData(){ USER_DATA.noteTemplates = NOTE_TEMPLATES; }

    const NOTE_TITLE_MAX_WORDS = 12;
    const NOTE_TITLE_MAX_LENGTH = 120;
    const NOTE_AUTO_SAVE_IDLE_MS = 2000;

    function updateNoteTemplateControlsState(){
      if(!noteTemplateSelect) return;
      const hasTemplates = Array.isArray(NOTE_TEMPLATES) && NOTE_TEMPLATES.length > 0;
      noteTemplateSelect.disabled = !hasTemplates;
      if(!hasTemplates){
        noteTemplateSelect.value = '';
      }
      if(insertTemplateBtn){
        insertTemplateBtn.disabled = !hasTemplates || !(noteTemplateSelect.value);
      }
    }

    function refreshNoteTemplateOptions(selectedId){
      if(!noteTemplateSelect) return;
      const templates = Array.isArray(NOTE_TEMPLATES) ? [...NOTE_TEMPLATES] : [];
      const previous = typeof selectedId === 'string' ? selectedId : noteTemplateSelect.value;
      noteTemplateSelect.innerHTML = '<option value="">Selecionar template...</option>';
      templates
        .sort((a,b)=>{
          const diff = (b.updatedAt||0) - (a.updatedAt||0);
          return diff || String(a.name||'').localeCompare(String(b.name||''));
        })
        .forEach(template=>{
          const option = document.createElement('option');
          option.value = template.id || '';
          option.textContent = template.name || 'Template sem nome';
          noteTemplateSelect.appendChild(option);
        });
      const valid = templates.some(t=> (t.id||'') === previous) ? previous : '';
      noteTemplateSelect.value = valid;
      updateNoteTemplateControlsState();
    }

    async function persistNoteTemplates(){
      saveNoteTemplatesToUserData();
      const uid = auth.currentUser?.uid;
      if(!uid) return;
      await setDoc(doc(db,'usuarios',uid), { noteTemplates: NOTE_TEMPLATES }, { merge:true });
    }

    function ensureDateISOFromTimestamp(ts){
      if(!ts) return defaultDateISO();
      const d = new Date(ts);
      return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
    }
    function generateNoteTitleFromMarkdown(raw){
      let normalized = normalizeNoteRaw(raw||'').trim();
      if(!normalized) return '';
      // Remover tags HTML de m√≠dia para n√£o poluir o t√≠tulo
      normalized = normalized.replace(/<span[^>]*class\s*=\s*["']media-resizable["'][^>]*>[\s\S]*?<\/span>/gi, '');
      // Remover placeholders de m√≠dia se existirem
      normalized = normalized.replace(/___MEDIA_PLACEHOLDER_\d+___/g, '');
      // Remover outras tags HTML
      normalized = normalized.replace(/<[^>]+>/g, '');
      normalized = normalized.trim();
      if(!normalized) return 'Anota√ß√£o com imagem';
      const words = normalized.split(/\s+/).filter(Boolean).slice(0, NOTE_TITLE_MAX_WORDS);
      let title = words.join(' ');
      if(title.length > NOTE_TITLE_MAX_LENGTH){
        title = title.slice(0, NOTE_TITLE_MAX_LENGTH).trim();
      }
      if(normalized.length > title.length){
        title = title.replace(/[\s,.!?;:-]+$/,'');
        title += '‚Ä¶';
      }
      return title;
    }
    function formatNoteDateTime(note){
      if(!note) return '';
      const ts = typeof note.createdAt === 'number' ? note.createdAt : (typeof note.updatedAt === 'number' ? note.updatedAt : null);
      if(!ts){
        return note.dateISO || '';
      }
      const d = new Date(ts);
      const dateStr = d.toLocaleDateString('pt-BR');
      const timeStr = d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
      return `${dateStr} ${timeStr}`;
    }

    function normalizeNoteRaw(raw){
      return typeof raw === 'string'
        ? raw.replace(/\u00a0/g, ' ').replace(/\r\n?/g, '\n')
        : '';
    }
    function extractNoteEditorMarkdown(){
      if(!noteEditor) return '';
      const sanitizedCurrent = sanitizeMarkdownHtml(noteEditor.innerHTML || '');
      
      // IMPORTANTE: Se h√° m√≠dia no editor, N√ÉO converter para markdown!
      // Apenas retornar textContent para o t√≠tulo, preservando o HTML original
      const hasMedia = /<span[^>]*class\s*=\s*["']media-resizable["'][^>]*>/i.test(sanitizedCurrent) ||
                       /<img[^>]+src\s*=\s*["'][^"']+["'][^>]*>/i.test(sanitizedCurrent);
      
      if(hasMedia){
        // Quando h√° m√≠dia, retornar apenas texto simples para o t√≠tulo
        // O HTML ser√° preservado diretamente sem processamento
        const textOnly = noteEditor.textContent || '';
        const normalized = normalizeNoteRaw(textOnly);
        noteMarkdownSource = normalized;
        noteEditor.dataset.raw = normalized;
        return normalized;
      }
      
      // Apenas para notas sem m√≠dia, fazer convers√£o markdown normal
      let markdown = htmlToMarkdown(sanitizedCurrent);
      if(!markdown){
        markdown = noteEditor.textContent || '';
      }
      const normalized = normalizeNoteRaw(markdown);
      noteMarkdownSource = normalized;
      noteEditor.dataset.raw = normalized;
      return normalized;
    }
    function computeNoteHtmlFromMarkdown(raw){
      const normalized = normalizeNoteRaw(raw);
      if(!normalized.trim()) return '';
      
      // Preservar blocos media-resizable antes do processamento markdown
      // Usar abordagem baseada em DOM para maior robustez
      const mediaPlaceholders = [];
      
      // Primeiro, tentar extrair usando DOM para pegar spans corretamente
      let processed = normalized;
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = normalized;
      const mediaSpans = tempDiv.querySelectorAll('span.media-resizable');
      
      if(mediaSpans.length > 0){
        // Usar abordagem DOM - mais confi√°vel
        mediaSpans.forEach((span, idx) => {
          const outerHTML = span.outerHTML;
          mediaPlaceholders.push(outerHTML);
          // Criar um marcador de texto para substituir
          const marker = document.createTextNode(`\n\n___MEDIA_PLACEHOLDER_${idx}___\n\n`);
          span.parentNode.replaceChild(marker, span);
        });
        processed = tempDiv.innerHTML;
        // Limpar qualquer HTML residual do container
        processed = processed.replace(/<\/?div>/gi, '');
      } else {
        // Fallback: tentar regex
        const mediaRegex = /<span\s+[^>]*class\s*=\s*["']media-resizable["'][^>]*>[\s\S]*?<\/span>/gi;
        processed = normalized.replace(mediaRegex, (match) => {
          const idx = mediaPlaceholders.length;
          mediaPlaceholders.push(match);
          return `\n\n___MEDIA_PLACEHOLDER_${idx}___\n\n`;
        });
      }
      
      const markedLib = window.marked;
      let html = '';
      if(markedLib){
        try{
          const parser = typeof markedLib.parse === 'function' ? markedLib.parse : markedLib;
          const rendered = parser.call(markedLib, processed, { gfm:true, breaks:true });
          if(typeof rendered === 'string') html = rendered;
        }catch(err){
          console.warn('Markdown render error', err);
        }
      }
      if(!html){
        html = escapeHtml(processed).replace(/\n/g,'<br>');
      }
      
      // Restaurar blocos media-resizable ap√≥s o processamento markdown
      // Tentar m√∫ltiplas varia√ß√µes de como o marked pode ter embrulhado o placeholder
      mediaPlaceholders.forEach((block, idx) => {
        const placeholder = `___MEDIA_PLACEHOLDER_${idx}___`;
        // Varia√ß√£o 1: dentro de par√°grafo
        html = html.replace(`<p>${placeholder}</p>`, block);
        // Varia√ß√£o 2: placeholder puro
        html = html.replace(placeholder, block);
        // Varia√ß√£o 3: com quebras de linha ao redor (regex)
        html = html.replace(new RegExp(`<p>\\s*${placeholder}\\s*</p>`, 'g'), block);
        // Varia√ß√£o 4: placeholder com br ao redor
        html = html.replace(new RegExp(`<br\\s*/?>${placeholder}<br\\s*/?>`, 'gi'), block);
        html = html.replace(new RegExp(`<br\\s*/?>${placeholder}`, 'gi'), block);
        html = html.replace(new RegExp(`${placeholder}<br\\s*/?>`, 'gi'), block);
      });
      
      // Verifica√ß√£o final: se ainda h√° placeholders n√£o substitu√≠dos, algo deu errado
      // Tentar substituir qualquer placeholder restante
      const remainingPlaceholders = html.match(/___MEDIA_PLACEHOLDER_(\d+)___/g);
      if(remainingPlaceholders){
        remainingPlaceholders.forEach(ph => {
          const match = ph.match(/___MEDIA_PLACEHOLDER_(\d+)___/);
          if(match){
            const idx = parseInt(match[1], 10);
            if(mediaPlaceholders[idx]){
              html = html.split(ph).join(mediaPlaceholders[idx]);
            }
          }
        });
      }
      
      let safe = html;
      const purifier = window.DOMPurify;
      if(purifier && typeof purifier.sanitize === 'function'){
        try{
          safe = purifier.sanitize(html, { 
            USE_PROFILES: { html: true },
            ADD_ATTR: ['style'],
            ALLOWED_ATTR: ['style', 'class', 'src', 'alt', 'href', 'target', 'rel', 'controls', 'crossorigin', 'contenteditable']
          });
        }catch(err){
          console.warn('DOMPurify sanitize error', err);
          safe = sanitizeMarkdownHtml(html);
        }
      }else{
        safe = sanitizeMarkdownHtml(html);
      }
      return safe;
    }
    let noteEditorUpdating = false;
    function setNoteEditorMarkdown(raw, selectionState=null){
      if(!noteEditor) return;
      const prevScrollTop = noteEditor.scrollTop;
      const prevScrollLeft = noteEditor.scrollLeft;
      const normalized = normalizeNoteRaw(raw);
      noteMarkdownSource = normalized;
      noteEditor.dataset.raw = normalized;
      const html = normalized ? computeNoteHtmlFromMarkdown(normalized) : '';
      if(html){
        if(noteEditor.innerHTML !== html){
          noteEditor.innerHTML = html;
        }
      }else{
        noteEditor.innerHTML = '';
      }
      if(selectionState){
        restoreEditableSelection(noteEditor, selectionState);
      }
      noteEditor.scrollTop = prevScrollTop;
      noteEditor.scrollLeft = prevScrollLeft;
      // Normalizar tamanho das imagens e v√≠deos
      setTimeout(()=>{ if(typeof normalizeNoteEditorMedia === 'function') normalizeNoteEditorMedia(); }, 50);
    }
    function refreshNoteEditorFromCurrentHtml(options={}){
      if(!noteEditor || noteEditorUpdating) return;
      noteEditorUpdating = true;
      try{
        const prevScrollTop = noteEditor.scrollTop;
        const prevScrollLeft = noteEditor.scrollLeft;
        const normalized = extractNoteEditorMarkdown();
        const isActive = document.activeElement === noteEditor;
        if(!isActive || options.forceRender){
          const html = normalized ? (computeNoteHtmlFromMarkdown(normalized) || '') : '';
          if(html){
            if(noteEditor.innerHTML !== html){
              noteEditor.innerHTML = html;
            }
          }else if(noteEditor.innerHTML){
            noteEditor.innerHTML = '';
          }
          noteEditor.scrollTop = prevScrollTop;
          noteEditor.scrollLeft = prevScrollLeft;
        }
      }finally{
        noteEditorUpdating = false;
      }
    }
    if(noteEditor && !noteEditor.innerHTML.trim()){
      setNoteEditorMarkdown('');
    }

    function renderNotes(){
      noteDate.value = noteDate.value || defaultDateISO();
      let items=[...NOTES];
      const fs=filterSector.value, ff=filterFrom.value, ft=filterTo.value;
      if(fs) items=items.filter(n=>n.sector===fs);
      if(ff) items=items.filter(n=>n.dateISO>=ff);
      if(ft) items=items.filter(n=>n.dateISO<=ft);
      items.sort((a,b)=> (a.dateISO<b.dateISO?1:a.dateISO>b.dateISO?-1:(b.updatedAt||0)-(a.updatedAt||0)));

      notesList.innerHTML="";
      if(items.length===0){ const d=document.createElement("div"); d.className="muted"; d.textContent="Nenhuma nota encontrada."; notesList.appendChild(d); return; }
      items.forEach(n=>{
        const div=document.createElement("div"); div.className="note-item";
        if(n.id) div.dataset.id = n.id;
        if(n.id && n.id===currentNoteId) div.classList.add('active');
        const dateLabel = formatNoteDateTime(n) || n.dateISO || '';
        div.innerHTML=`
          <div class="note-head">
            <div>
              <div class="note-title">${n.title||"(Sem nome)"}</div>
              <div class="note-meta"><span class="tag">${sectorLabel(n.sector)}</span>${dateLabel?` ‚Ä¢ ${dateLabel}`:''}</div>
            </div>
            <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end">
              <button class="btn small secondary" data-act="edit">Editar</button>
              <button class="btn small" data-act="dup">Duplicar</button>
              <button class="btn small secondary" data-act="del">Excluir</button>
              <button class="btn small" data-act="dl-html" title="Baixar HTML">Download HTML</button>
            </div>
          </div>`;
        div.querySelector('[data-act="edit"]').onclick=()=>{
          let sanitized = sanitizeMarkdownHtml(n.html||'');
          
          // Debug: verificar o que est√° vindo do banco
          console.log('üìÇ Carregando nota:', n.id);
          console.log('üìÑ HTML do banco (primeiros 500 chars):', (n.html || '').substring(0, 500));
          console.log('üîç T√≠tulo da nota:', n.title);
          
          // Limpar qualquer placeholder residual de notas antigas que foram salvas incorretamente
          sanitized = sanitized.replace(/___MEDIA_PLACEHOLDER_\d+___/g, '');
          sanitized = sanitized.replace(/MEDIA_PLACEHOLDER_\d+/g, '');
          
          // Verificar se o HTML cont√©m elementos de m√≠dia (imagens/v√≠deos)
          const hasMedia = /<span[^>]*class\s*=\s*["']media-resizable["'][^>]*>/i.test(sanitized) ||
                          /<img[^>]+src\s*=\s*["'][^"']+["'][^>]*>/i.test(sanitized);
          
          console.log('üé® Cont√©m m√≠dia?', hasMedia);
          
          if(hasMedia && noteEditor){
            // Se tem m√≠dia, usar o HTML diretamente para preservar as imagens
            console.log('‚úÖ Carregando HTML direto com m√≠dia');
            noteEditor.innerHTML = sanitized;
            noteMarkdownSource = sanitized;
            noteEditor.dataset.raw = sanitized;
            setTimeout(()=>normalizeNoteEditorMedia(), 50);
          } else {
            // Sem m√≠dia, converter para markdown normalmente
            let markdown = htmlToMarkdown(sanitized);
            if(!markdown && sanitized){
              const temp=document.createElement('div');
              temp.innerHTML=sanitized;
              markdown=temp.textContent||'';
            }
            markdown = normalizeNoteRaw(markdown||'');
            setNoteEditorMarkdown(markdown);
          }
          
          if(noteEditor){
            const len = (noteEditor.textContent||'').length;
            restoreEditableSelection(noteEditor, { start: len, end: len });
            noteEditor.focus();
            setTimeout(()=>normalizeNoteEditorMedia(), 50);
          }
          currentNoteId = n.id;
          const titleFromContent = hasMedia ? (n.title || 'Anota√ß√£o com imagem') : generateNoteTitleFromMarkdown(sanitized);
          noteTitle.value=n.title||titleFromContent||"";
          noteSector.value=n.sector||"roi";
          noteDate.value=n.dateISO||ensureDateISOFromTimestamp(n.createdAt||n.updatedAt||Date.now());
          if(noteAutoSaveStatus){
            const when = formatNoteDateTime(n);
            noteAutoSaveStatus.textContent = when ? `√öltimo salvamento em ${when}.` : 'Altera√ß√µes s√£o salvas automaticamente.';
          }
          notesList.querySelectorAll('.note-item').forEach(item=>item.classList.remove('active'));
          div.classList.add('active');
          window.scrollTo({top:sectionTabs.offsetTop,behavior:"smooth"});
        };
        div.querySelector('[data-act="dup"]').onclick=async()=>{
          const now = Date.now();
          const copy={...n,id:uuid(),updatedAt:now,createdAt:now,dateISO:ensureDateISOFromTimestamp(now)};
          NOTES.push(copy);
          await persistNotes();
          renderNotes();
        };
        div.querySelector('[data-act="del"]').onclick=async()=>{
          if(confirm("Excluir esta nota?")){
            NOTES=NOTES.filter(x=>x.id!==n.id);
            if(n.id===currentNoteId){
              currentNoteId=null;
              startNewNote();
            }
            await persistNotes();
            renderNotes();
          }
        };
        div.querySelector('[data-act="dl-html"]').onclick=()=> downloadNoteHTML(n);
        notesList.appendChild(div);
      });
    }

    function updateNoteListAfterSave(note, { isNew=false }={}){
      if(!notesList || !note) return;
      if(isNew){
        renderNotes();
        return;
      }
      const item = note.id ? notesList.querySelector(`.note-item[data-id="${note.id}"]`) : null;
      if(!item) return;
      const titleEl = item.querySelector('.note-title');
      if(titleEl){
        titleEl.textContent = note.title || '(Sem nome)';
      }
      const metaEl = item.querySelector('.note-meta');
      if(metaEl){
        const dateLabel = formatNoteDateTime(note) || note.dateISO || '';
        metaEl.innerHTML = `<span class="tag">${sectorLabel(note.sector)}</span>${dateLabel?` ‚Ä¢ ${dateLabel}`:''}`;
      }
    }

    // toolbar texto ‚Äî ESCOPADA AO NOTES WRAP
    notesWrap.querySelectorAll(".note-toolbar .tool").forEach(btn=>{
      const cmd=btn.dataset.cmd; if(!cmd) return;
      btn.addEventListener("click",()=>{ const v=btn.dataset.value||null; if(cmd==="formatBlock"&&v) document.execCommand(cmd,false,v); else document.execCommand(cmd,false,v); noteEditor.focus(); });
    });
    notesWrap.querySelector("#makeLink").addEventListener("click",()=>{
      let url=prompt("URL do link:"); if(url){ if(!/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(url)) url="https://"+url; document.execCommand("createLink",false,url); }
      noteEditor.focus();
    });

    notesWrap.querySelector("#noteColor").addEventListener("input",(e)=>{
      document.execCommand("foreColor", false, e.target.value);
      noteEditor.focus();
    });

    // m√≠dias nas notas (imagens e v√≠deos)
    notesWrap.querySelector("#btnImg").addEventListener("click",()=>imgInput.click());
    imgInput.addEventListener("change",(e)=>{ const f=e.target.files?.[0]; if(f) insertImageFromFile(f); imgInput.value=""; });
    notesWrap.querySelector("#btnVideo").addEventListener("click",()=>videoInput.click());
    videoInput.addEventListener("change",(e)=>{ const f=e.target.files?.[0]; if(f) insertVideoFromFile(f); videoInput.value=""; });
    const scheduleNoteEditorRefresh = noteEditor ? debounce(()=>refreshNoteEditorFromCurrentHtml(), 300) : null;
    let noteAutoSaveTimer = null;
    function scheduleNoteAutoSave(options={}){
      if(!noteEditor) return Promise.resolve();
      const force = options?.force === true;
      clearTimeout(noteAutoSaveTimer);
      if(force){
        noteAutoSaveTimer = null;
        return autoSaveCurrentNote(true);
      }
      if(noteAutoSaveStatus){
        updateAutoSaveStatus('Altera√ß√µes pendentes. Salvaremos em instantes...');
      }
      noteAutoSaveTimer = window.setTimeout(()=>{
        noteAutoSaveTimer = null;
        autoSaveCurrentNote();
      }, NOTE_AUTO_SAVE_IDLE_MS);
      return Promise.resolve();
    }

    function applyNoteTemplate(template){
      if(!template || !noteEditor) return;
      const templateContent = normalizeNoteRaw(template.markdown || '');
      if(!templateContent.trim()){
        if(typeof mgToast === 'function'){ mgToast('Template vazio.'); }
        return;
      }
      const current = normalizeNoteRaw(extractNoteEditorMarkdown() || '');
      if(current.trim() && current !== templateContent){
        const confirmReplace = confirm('Substituir o conte√∫do atual pelo template selecionado?');
        if(!confirmReplace){
          refreshNoteEditorFromCurrentHtml({ forceRender: true });
          return;
        }
      }
      setNoteEditorMarkdown(templateContent);
      refreshNoteEditorFromCurrentHtml({ forceRender: true });
      const len = (noteEditor.textContent||'').length;
      restoreEditableSelection(noteEditor, { start: len, end: len });
      noteEditor.focus();
      scheduleNoteAutoSave({ force: true });
      if(typeof mgToast === 'function'){ mgToast('Template inserido!'); }
    }

    if(noteTemplateSelect){
      noteTemplateSelect.addEventListener('change', ()=> updateNoteTemplateControlsState());
    }
    if(saveTemplateBtn){
      saveTemplateBtn.addEventListener('click', async ()=>{
        if(!noteEditor) return;
        refreshNoteEditorFromCurrentHtml({ forceRender: true });
        const { normalized } = getNoteEditorContentForSaving();
        const normalizedContent = normalizeNoteRaw(normalized || '');
        if(!normalizedContent.trim()){
          alert('Escreva algo na anota√ß√£o para salvar como template.');
          noteEditor.focus();
          return;
        }
        const defaultName = (noteTitle?.value || '').trim() || `Template ${NOTE_TEMPLATES.length + 1}`;
        let name = prompt('Nome do template:', defaultName);
        if(name === null) return;
        name = name.trim();
        if(!name){
          alert('Informe um nome v√°lido para o template.');
          return;
        }
        const now = Date.now();
        const normalizedName = name.toLowerCase();
        let targetId = null;
        const existing = NOTE_TEMPLATES.find(t => (t.name||'').toLowerCase() === normalizedName);
        if(existing){
          if(!confirm(`Substituir o template "${existing.name}"?`)) return;
          existing.name = name;
          existing.markdown = normalizedContent;
          existing.updatedAt = now;
          if(!existing.createdAt) existing.createdAt = now;
          targetId = existing.id;
        }else{
          const template = { id: uuid(), name, markdown: normalizedContent, createdAt: now, updatedAt: now };
          NOTE_TEMPLATES.push(template);
          targetId = template.id;
        }
        try{
          await persistNoteTemplates();
          refreshNoteTemplateOptions(targetId);
          if(typeof mgToast === 'function'){ mgToast('Template salvo!'); }
        }catch(err){
          console.error('note template save', err);
          alert('N√£o foi poss√≠vel salvar o template. Tente novamente.');
        }
      });
    }
    if(insertTemplateBtn){
      insertTemplateBtn.addEventListener('click', ()=>{
        const id = noteTemplateSelect?.value || '';
        if(!id){
          alert('Selecione um template para inserir.');
          noteTemplateSelect?.focus();
          return;
        }
        const template = NOTE_TEMPLATES.find(t=> (t.id||'') === id);
        if(!template){
          alert('Template n√£o encontrado. Atualize a lista e tente novamente.');
          refreshNoteTemplateOptions();
          return;
        }
        applyNoteTemplate(template);
      });
    }
    noteEditor.addEventListener("paste",(e)=>{
      const items=e.clipboardData?.items||[];
      for(const it of items){
        if(it.type?.startsWith("image/")){
          e.preventDefault();
          const f=it.getAsFile();
          if(f) insertImageFromFile(f);
          return;
        }
      }
      const text=e.clipboardData?.getData('text/plain');
      if(typeof text === 'string' && text.length){
        e.preventDefault();
        const normalized=normalizeNoteRaw(text);
        document.execCommand('insertText', false, normalized);
        refreshNoteEditorFromCurrentHtml();
        scheduleNoteAutoSave();
      }
    });
    noteEditor.addEventListener("keydown",(e)=>{
      if(e.key === 'Tab' && !e.shiftKey){
        e.preventDefault();
        const insertion = '  ';
        const inserted = document.execCommand('insertText', false, insertion);
        if(!inserted){
          const selection = window.getSelection();
          if(selection && selection.rangeCount){
            const range = selection.getRangeAt(0);
            range.deleteContents();
            range.insertNode(document.createTextNode(insertion));
            range.collapse(false);
            selection.removeAllRanges();
            selection.addRange(range);
          }
        }
        if(scheduleNoteEditorRefresh) scheduleNoteEditorRefresh();
        scheduleNoteAutoSave();
      }
    });
    noteEditor.addEventListener("input",()=>{
      if(scheduleNoteEditorRefresh) scheduleNoteEditorRefresh();
      scheduleNoteAutoSave();
    });
    noteEditor.addEventListener("blur",()=>{
      // üõ°Ô∏è PROTE√á√ÉO: Se o editor tem m√≠dia, N√ÉO fazer refresh (que destruiria as imagens)
      const currentHtml = noteEditor?.innerHTML || '';
      const hasMedia = /<span[^>]*class\s*=\s*["']media-resizable["'][^>]*>/i.test(currentHtml) ||
                       /<img[^>]+src\s*=\s*["'][^"']+["'][^>]*>/i.test(currentHtml);
      
      if(!hasMedia){
        // Apenas fazer refresh se N√ÉO tiver m√≠dia
        refreshNoteEditorFromCurrentHtml({ forceRender: true });
      } else {
        console.log('üõ°Ô∏è PROTE√á√ÉO blur: Editor tem m√≠dia, pulando refresh que destruiria imagens');
      }
      
      scheduleNoteAutoSave({ force: true });
    });
    let lastMediaBox=null;
    
    async function uploadNoteImage(file){
      const uid = auth.currentUser?.uid;
      if(!uid){ 
        console.error('Usu√°rio n√£o autenticado');
        return null;
      }
      if(!STORAGE){
        console.error('Storage n√£o inicializado');
        return null;
      }
      try{
        const timestamp = Date.now();
        const randomId = Math.random().toString(36).substring(2, 10);
        const ext = file.name.split('.').pop() || 'png';
        const fileName = `note-image-${timestamp}-${randomId}.${ext}`;
        const storageRef = sRef(STORAGE, `usuarios/${uid}/notes-images/${fileName}`);
        console.log('üì§ Iniciando upload de imagem para:', `usuarios/${uid}/notes-images/${fileName}`);
        const uploadTask = await uploadBytes(storageRef, file);
        const downloadURL = await getDownloadURL(uploadTask.ref);
        console.log('‚úÖ Upload de imagem conclu√≠do:', downloadURL);
        return downloadURL;
      }catch(err){
        console.error('Erro ao fazer upload da imagem:', err);
        // Verificar tipo de erro para mensagem mais espec√≠fica
        if(err.code === 'storage/unauthorized'){
          console.error('‚ö†Ô∏è PERMISS√ÉO NEGADA: As regras do Firebase Storage precisam ser atualizadas. Execute: firebase deploy --only storage');
        }
        return null;
      }
    }
    
    async function insertImageFromFile(file){ 
      // Valida√ß√£o de tamanho: m√°ximo 5MB
      const maxSize = 5 * 1024 * 1024; // 5MB
      if(file.size > maxSize){
        alert('Erro: A imagem √© muito grande. Tamanho m√°ximo: 5MB');
        return;
      }

      const tempBox = document.createElement("span");
      tempBox.className = "media-resizable";
      tempBox.contentEditable = "false";
      tempBox.innerHTML = `<div style="padding:20px;text-align:center;color:rgba(255,255,255,0.6);">Carregando imagem...</div>`;
      tempBox.style.width = "420px";
      const range = getCurrentRange();
      if(range) range.insertNode(tempBox);
      else noteEditor.appendChild(tempBox);
      
      const downloadURL = await uploadNoteImage(file);
      if(downloadURL){
        tempBox.innerHTML = `<img alt="imagem" src="${downloadURL}" crossorigin="anonymous">`;
        tempBox.addEventListener("click",(ev)=>{ ev.stopPropagation(); selectMediaBox(tempBox); });
        selectMediaBox(tempBox);
        scheduleNoteAutoSave();
      }else{
        // Remove o elemento tempor√°rio se o upload falhar
        tempBox.remove();
        alert('Erro ao fazer upload da imagem. Verifique sua conex√£o e tente novamente.');
      }
    }
    
    function insertImageBox(src){
      const box=document.createElement("span"); box.className="media-resizable"; box.contentEditable="false"; box.innerHTML=`<img alt="imagem" src="${src}" crossorigin="anonymous">`; box.style.width="420px";
      box.addEventListener("click",(ev)=>{ ev.stopPropagation(); selectMediaBox(box); });
      const range=getCurrentRange(); if(range) range.insertNode(box); else noteEditor.appendChild(box); selectMediaBox(box);
    }
    
    async function uploadNoteVideo(file){
      const uid = auth.currentUser?.uid;
      if(!uid){ 
        console.error('Usu√°rio n√£o autenticado');
        return null;
      }
      if(!STORAGE){
        console.error('Storage n√£o inicializado');
        return null;
      }
      try{
        const timestamp = Date.now();
        const randomId = Math.random().toString(36).substring(2, 10);
        const ext = file.name.split('.').pop() || 'mp4';
        const fileName = `note-video-${timestamp}-${randomId}.${ext}`;
        const storageRef = sRef(STORAGE, `usuarios/${uid}/notes-videos/${fileName}`);
        const uploadTask = await uploadBytes(storageRef, file);
        const downloadURL = await getDownloadURL(uploadTask.ref);
        return downloadURL;
      }catch(err){
        console.error('Erro ao fazer upload do v√≠deo:', err);
        return null;
      }
    }
    
    async function insertVideoFromFile(file){ 
      // Valida√ß√£o de tamanho: m√°ximo 10MB
      const maxSize = 10 * 1024 * 1024; // 10MB
      if(file.size > maxSize){
        alert('Erro: O v√≠deo √© muito grande. Tamanho m√°ximo: 10MB');
        return;
      }

      const tempBox = document.createElement("span");
      tempBox.className = "media-resizable";
      tempBox.contentEditable = "false";
      tempBox.innerHTML = `<div style="padding:20px;text-align:center;color:rgba(255,255,255,0.6);">Carregando v√≠deo...</div>`;
      tempBox.style.width = "420px";
      const range = getCurrentRange();
      if(range) range.insertNode(tempBox);
      else noteEditor.appendChild(tempBox);
      
      const downloadURL = await uploadNoteVideo(file);
      if(downloadURL){
        tempBox.innerHTML = `<video controls src="${downloadURL}" crossorigin="anonymous"></video>`;
        tempBox.addEventListener("click",(ev)=>{ ev.stopPropagation(); selectMediaBox(tempBox); });
        selectMediaBox(tempBox);
        scheduleNoteAutoSave();
      }else{
        // Remove o elemento tempor√°rio se o upload falhar
        tempBox.remove();
        alert('Erro ao fazer upload do v√≠deo. Verifique sua conex√£o e tente novamente.');
      }
    }
    
    function insertVideoBox(src){
      const box=document.createElement("span"); box.className="media-resizable"; box.contentEditable="false"; box.innerHTML=`<video controls src="${src}" crossorigin="anonymous"></video>`; box.style.width="420px";
      box.addEventListener("click",(ev)=>{ ev.stopPropagation(); selectMediaBox(box); });
      const range=getCurrentRange(); if(range) range.insertNode(box); else noteEditor.appendChild(box); selectMediaBox(box);
    }
    function selectMediaBox(box){ if(lastMediaBox) lastMediaBox.classList.remove("selected"); lastMediaBox=box; box.classList.add("selected"); }
    function getCurrentRange(){ const sel=window.getSelection(); if(!sel||sel.rangeCount===0) return null; return sel.getRangeAt(0); }
    notesWrap.querySelector("#btnImgLink").addEventListener("click",()=>{
      if(!lastMediaBox || !lastMediaBox.querySelector("img")){ alert("Clique na imagem para selecion√°-la primeiro."); return; }
      let a=lastMediaBox.closest("a"); let url=a?.getAttribute("href")||"";
      url=prompt("URL para abrir ao clicar na imagem:",url||"https://")||""; if(!url){ if(a){ a.replaceWith(lastMediaBox); } return; }
      if(!/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(url)) url="https://"+url;
      const link=document.createElement("a"); link.href=url; link.target="_blank"; link.rel="noopener noreferrer";
      lastMediaBox.replaceWith(link); link.appendChild(lastMediaBox); selectMediaBox(lastMediaBox);
    });
    notesWrap.querySelector("#btnVideoLink").addEventListener("click",()=>{
      if(!lastMediaBox || !lastMediaBox.querySelector("video")){ alert("Clique no v√≠deo para selecion√°-lo primeiro."); return; }
      let a=lastMediaBox.closest("a"); let url=a?.getAttribute("href")||"";
      url=prompt("URL para abrir ao clicar no v√≠deo:",url||"https://")||""; if(!url){ if(a){ a.replaceWith(lastMediaBox); } return; }
      if(!/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(url)) url="https://"+url;
      const link=document.createElement("a"); link.href=url; link.target="_blank"; link.rel="noopener noreferrer";
      lastMediaBox.replaceWith(link); link.appendChild(lastMediaBox); selectMediaBox(lastMediaBox);
    });
    document.addEventListener("click",(e)=>{ if(!noteEditor.contains(e.target) && lastMediaBox){ lastMediaBox.classList.remove("selected"); lastMediaBox=null; } });

    // üóëÔ∏è Deletar m√≠dia com Delete/Backspace
    document.addEventListener("keydown",(e)=>{
      if(!lastMediaBox || !noteEditor.contains(lastMediaBox)) return;
      
      // Delete ou Backspace
      if(e.key === "Delete" || e.key === "Backspace"){
        e.preventDefault();
        e.stopPropagation();
        
        // Confirmar antes de deletar
        if(confirm("Deseja deletar esta m√≠dia?")){
          console.log('üóëÔ∏è Deletando m√≠dia selecionada');
          lastMediaBox.remove();
          lastMediaBox = null;
          scheduleNoteAutoSave();
        }
      }
    });

    function normalizeNoteEditorMedia(){
      if(!noteEditor) return;
      const mediaBoxes = noteEditor.querySelectorAll('.media-resizable');
      const editorWidth = noteEditor.offsetWidth;
      if(!editorWidth) return;
      const maxWidth = editorWidth - 20; // subtrair padding/margem
      const defaultWidth = 420;
      mediaBoxes.forEach(box => {
        // Garantir que o box tenha uma largura definida
        if(!box.style.width || box.style.width === 'auto'){
          box.style.width = Math.min(defaultWidth, maxWidth) + 'px';
        }
        const currentWidth = box.offsetWidth;
        // Limitar se exceder o m√°ximo
        if(currentWidth > maxWidth){
          box.style.width = Math.min(defaultWidth, maxWidth) + 'px';
        }
        // Adicionar evento de click se ainda n√£o tem
        if(!box.dataset.mediaClickBound){
          box.dataset.mediaClickBound = 'true';
          box.addEventListener("click",(ev)=>{ ev.stopPropagation(); selectMediaBox(box); });
        }
      });
    }

    function updateAutoSaveStatus(message){
      if(noteAutoSaveStatus) noteAutoSaveStatus.textContent = message;
    }

    function startNewNote(){
      clearTimeout(noteAutoSaveTimer);
      noteAutoSaveTimer = null;
      currentNoteId = null;
      setNoteEditorMarkdown('');
      if(noteEditor){
        restoreEditableSelection(noteEditor, { start:0, end:0 });
        noteEditor.focus();
      }
      if(noteTitle) noteTitle.value = '';
      if(noteDate) noteDate.value = defaultDateISO();
      if(noteTemplateSelect){
        noteTemplateSelect.value = '';
        updateNoteTemplateControlsState();
      }
      if(notesList){
        notesList.querySelectorAll('.note-item').forEach(item=>item.classList.remove('active'));
      }
      updateAutoSaveStatus('Digite para criar uma nova anota√ß√£o. Salvamento autom√°tico ativo.');
    }

    function captureNoteEditorState(){
      if(!noteEditor) return null;
      const active = document.activeElement === noteEditor;
      return {
        active,
        selection: active ? getEditableSelection(noteEditor) : null,
        scrollTop: noteEditor.scrollTop,
        scrollLeft: noteEditor.scrollLeft
      };
    }
    function restoreNoteEditorState(state){
      if(!state || !noteEditor) return;
      noteEditor.scrollTop = state.scrollTop;
      noteEditor.scrollLeft = state.scrollLeft;
      if(state.active){
        try{
          noteEditor.focus({ preventScroll: true });
        }catch(_err){
          noteEditor.focus();
        }
        if(state.selection){
          restoreEditableSelection(noteEditor, state.selection);
        }
      }
    }
    function getNoteEditorContentForSaving(){
      if(!noteEditor) return { normalized: '', html: '' };
      const normalized = extractNoteEditorMarkdown();
      // Usar o HTML diretamente do editor para preservar as imagens corretamente
      // ao inv√©s de reprocessar via computeNoteHtmlFromMarkdown que pode perder os media
      let html = sanitizeMarkdownHtml(noteEditor.innerHTML || '');
      
      // Debug: Verificar se h√° imagens no HTML
      const hasImages = /<img[^>]+src\s*=\s*["'][^"']+["'][^>]*>/i.test(html);
      const hasMediaSpans = /<span[^>]*class\s*=\s*["']media-resizable["'][^>]*>/i.test(html);
      if(hasImages || hasMediaSpans){
        console.log('üíæ Salvando nota COM imagem:', { hasImages, hasMediaSpans, htmlLength: html.length });
        console.log('üì∏ Preview HTML ANTES limpeza:', html.substring(0, 500));
      }
      
      // IMPORTANTE: Remover qualquer placeholder de m√≠dia residual que n√£o deveria estar no HTML final
      // Estes placeholders s√£o apenas para processamento interno, n√£o devem ser salvos
      html = html.replace(/___MEDIA_PLACEHOLDER_\d+___/g, '');
      html = html.replace(/MEDIA_PLACEHOLDER_\d+/g, '');
      
      if(hasImages || hasMediaSpans){
        console.log('üì∏ Preview HTML DEPOIS limpeza:', html.substring(0, 500));
        console.log('üìù Normalized (markdown/text) usado para t√≠tulo:', normalized.substring(0, 200));
      }
      
      // Fallback: se n√£o tem HTML, tenta gerar do markdown
      if(!html.trim() && normalized.trim()){
        html = computeNoteHtmlFromMarkdown(normalized) || '';
      }
      return { normalized, html };
    }
    async function autoSaveCurrentNote(force=false){
      if(!noteEditor) return;
      const editorState = captureNoteEditorState();
      try{
      clearTimeout(noteAutoSaveTimer);
      noteAutoSaveTimer = null;
      const { normalized, html: editorHtml } = getNoteEditorContentForSaving();
      const normalizedContent = normalized || '';
      const trimmed = normalizedContent.trim();
      const sector = noteSector?.value || 'roi';

      if(!trimmed){
        if(!currentNoteId){
          if(noteTitle) noteTitle.value = '';
          if(noteDate) noteDate.value = defaultDateISO();
          updateAutoSaveStatus('Digite para criar uma nova anota√ß√£o. Salvamento autom√°tico ativo.');
          return;
        }
        const existing = NOTES.find(n=>n.id===currentNoteId);
        if(existing){
          // üõ°Ô∏è PROTE√á√ÉO: Se a nota original tinha m√≠dia, N√ÉO sobrescrever com vazio
          const existingHasMedia = /<span[^>]*class\s*=\s*["']media-resizable["'][^>]*>/i.test(existing.html || '') ||
                                   /<img[^>]+src\s*=\s*["'][^"']+["'][^>]*>/i.test(existing.html || '');
          
          if(existingHasMedia){
            console.log('üõ°Ô∏è PROTE√á√ÉO: Nota tem m√≠dia, n√£o sobrescrever com vazio');
            updateAutoSaveStatus('Altera√ß√µes preservadas (nota cont√©m m√≠dia).');
            return;
          }
          
          const hadContent = !!(existing.html && existing.html.trim());
          existing.title = '';
          existing.html = '';
          existing.sector = sector;
          existing.updatedAt = Date.now();
          if(!existing.dateISO) existing.dateISO = ensureDateISOFromTimestamp(existing.updatedAt);
          try{
            await persistNotes();
          }catch(err){
            console.error('autoSaveCurrentNote(empty)', err);
          }
          if(hadContent) renderNotes();
        }
        updateAutoSaveStatus('Anota√ß√£o vazia. Nenhuma altera√ß√£o nova para salvar.');
        return;
      }

      const html = editorHtml || '';
      const title = generateNoteTitleFromMarkdown(normalizedContent) || 'Anota√ß√£o';
      
      // Debug: Log do que vai ser salvo
      const debugHasMedia = /<span[^>]*class\s*=\s*["']media-resizable["'][^>]*>/i.test(html) ||
                           /<img[^>]+src\s*=\s*["'][^"']+["'][^>]*>/i.test(html);
      if(debugHasMedia){
        console.log('üì¶ Preparando para salvar nota COM m√≠dia:', { 
          htmlLength: html.length, 
          title,
          htmlPreview: html.substring(0, 300)
        });
      }
      
      if(noteTitle) noteTitle.value = title;
      let note = currentNoteId ? NOTES.find(n=>n.id===currentNoteId) : null;
      let noteWasNew = false;
      const now = Date.now();

      if(!note){
        note = { id: uuid(), title, html, sector, dateISO: ensureDateISOFromTimestamp(now), createdAt: now, updatedAt: now };
        NOTES.push(note);
        currentNoteId = note.id;
        noteWasNew = true;
      }else{
        const sameContent = !force && (note.html||'')===html && (note.title||'')===title && (note.sector||'')===sector;
        if(sameContent){
          const savedLabel = formatNoteDateTime(note);
          updateAutoSaveStatus(savedLabel ? `√öltimo salvamento em ${savedLabel}.` : 'Altera√ß√µes salvas automaticamente.');
          return;
        }
        note.title = title;
        note.html = html;
        note.sector = sector;
        note.updatedAt = now;
        if(!note.createdAt) note.createdAt = now;
        if(!note.dateISO) note.dateISO = ensureDateISOFromTimestamp(note.createdAt);
      }

      if(noteDate) noteDate.value = note.dateISO || ensureDateISOFromTimestamp(note.createdAt||now);
      updateAutoSaveStatus('Salvando...');
      try{
        await persistNotes();
        updateNoteListAfterSave(note, { isNew: noteWasNew });
        const savedLabel = formatNoteDateTime(note);
        updateAutoSaveStatus(savedLabel ? `Salvo automaticamente em ${savedLabel}.` : 'Altera√ß√µes salvas automaticamente.');
      }catch(err){
        console.error('autoSaveCurrentNote', err);
        updateAutoSaveStatus('Falha ao salvar na nuvem. Guardado localmente.');
        updateNoteListAfterSave(note, { isNew: noteWasNew });
      }
      }finally{
        restoreNoteEditorState(editorState);
      }
    }

    if(newNoteBtn){
      newNoteBtn.addEventListener('click', ()=>{
        autoSaveCurrentNote(true).finally(()=>{
          startNewNote();
        });
      });
    }
    if(noteSector){
      noteSector.addEventListener('change', ()=>autoSaveCurrentNote(true));
    }
    document.addEventListener('visibilitychange', ()=>{
      if(document.visibilityState === 'hidden'){
        autoSaveCurrentNote(true);
      }
    });
    window.addEventListener('beforeunload', ()=>{
      autoSaveCurrentNote(true);
    });
    if(noteTitle){
      noteTitle.readOnly = true;
      noteTitle.placeholder = 'T√≠tulo gerado automaticamente';
    }
    if(noteDate){
      noteDate.disabled = true;
      noteDate.title = 'Definido automaticamente ao criar a anota√ß√£o';
    }
    if(noteAutoSaveStatus){
      updateAutoSaveStatus('Digite para criar uma nova anota√ß√£o. Salvamento autom√°tico ativo.');
    }
    refreshNoteTemplateOptions();
    if(!currentNoteId && (!noteEditor || !(noteEditor.textContent||'').trim())){
      startNewNote();
    }

    async function persistNotes(){
      saveNotesToUserData();
      const uid = auth.currentUser?.uid;
      if(!uid) return;
      
      // Debug: Log do que est√° sendo salvo no Firestore
      const notesWithMedia = NOTES.filter(n => {
        const hasMedia = /<span[^>]*class\s*=\s*["']media-resizable["'][^>]*>/i.test(n.html || '') ||
                        /<img[^>]+src\s*=\s*["'][^"']+["'][^>]*>/i.test(n.html || '');
        return hasMedia;
      });
      if(notesWithMedia.length > 0){
        console.log('üíæ Salvando no Firestore', notesWithMedia.length, 'notas COM m√≠dia');
        notesWithMedia.forEach(n => {
          console.log('  Nota:', n.id, 'HTML length:', (n.html || '').length, 'Preview:', (n.html || '').substring(0, 200));
        });
      }
      
      // CR√çTICO: Quando h√° notas com m√≠dia, usar save direto no Firestore
      // para evitar corrup√ß√£o de dados pela fun√ß√£o reduzirDocumentoUsuario()
      const hasMedia = notesWithMedia.length > 0;
      let result;
      
      if(hasMedia){
        console.log('üéØ Save DIRETO (bypass auto-cleanup) para preservar m√≠dia');
        try {
          // Save direto no Firestore sem passar por safeWriteUserDoc
          await setDoc(doc(db, "usuarios", uid), { notes: NOTES }, { merge: true });
          result = { success: true, directSave: true };
          console.log('‚úÖ Save direto bem-sucedido!');
        } catch(err) {
          console.error('‚ùå Erro no save direto:', err);
          result = { success: false, error: err };
        }
      } else {
        // Notas sem m√≠dia podem usar o fluxo normal com auto-cleanup
        result = await safeWriteUserDoc({ notes: NOTES });
      }
      
      if(!result.success) {
        console.error('‚ùå Falha ao salvar notas:', result.error);
        mgToast('‚ö†Ô∏è Erro ao salvar notas', 'error', 3000);
        return;
      }
      if(result.autoCleanup || result.emergencyCleanup) {
        console.log('üßπ Limpeza autom√°tica executada ao salvar notas');
      }
      if(result.directSave) {
        console.log('üì∏ Notas com m√≠dia salvas diretamente no Firestore');
      }
      await refreshStorageUsage();
      try{ refreshMacroInsights(); }catch(_){ }
    }
    applyFilter.addEventListener("click",renderNotes);
    clearFilter.addEventListener("click",()=>{ filterSector.value=""; filterFrom.value=""; filterTo.value=""; renderNotes(); });

    function sanitizeFileName(str){
      return (str||"nota").replace(/[\\/:*?"<>|]/g,"_");
    }
    function downloadNoteHTML(n){
      const html=`<!DOCTYPE html><html><head><meta charset="utf-8"><title>${n.title||""}</title></head><body>${n.html||""}</body></html>`;
      const blob=new Blob([html],{type:"text/html"});
      const a=document.createElement("a"); a.href=URL.createObjectURL(blob);
      a.download=`${sanitizeFileName(`${n.dateISO||""}-${n.title||"nota"}`)}.html`;
      document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();
    }

    /* ========= ACESSOS (dados) ========= */
    const accessWrap = $("accessWrap"), accessList = $("accessList"), accessForm = $("accessForm");
    let ACCESSES = []; // {id,name,url,user,pass,tags}
    let editingId = null;
    function loadAccessesFromUserData(){ 
      console.log('üîê [ACESSOS] loadAccessesFromUserData chamada');
      console.log('üîê [ACESSOS] USER_DATA todas as keys:', Object.keys(USER_DATA || {}));
      console.log('üîê [ACESSOS] USER_DATA.accesses:', USER_DATA?.accesses?.length || 0, 'itens');
      console.log('üîê [ACESSOS] typeof USER_DATA.accesses:', typeof USER_DATA?.accesses);
      console.log('üîê [ACESSOS] USER_DATA.accesses raw:', JSON.stringify(USER_DATA?.accesses || [], null, 2));
      
      // Verificar se accesses est√° em outro lugar
      if(USER_DATA){
        console.log('üîê [ACESSOS] Verificando todos os campos do USER_DATA para encontrar acessos:');
        for(const key of Object.keys(USER_DATA)){
          const val = USER_DATA[key];
          if(Array.isArray(val) && val.length > 0){
            console.log(`üîê [ACESSOS] Campo "${key}": ${val.length} itens, primeiro:`, val[0]);
          }
        }
      }
      
      ACCESSES = Array.isArray(USER_DATA.accesses) ? USER_DATA.accesses : []; 
      console.log('üîê [ACESSOS] ACCESSES carregados:', ACCESSES.length, 'itens');
    }
    
    // Fun√ß√£o async para carregar acessos com fallback para subcole√ß√£o
    async function loadAccessesFromUserDataAsync(){
      loadAccessesFromUserData();
      
      // Se n√£o houver acessos, tentar carregar da subcole√ß√£o accesses_backup
      if(ACCESSES.length === 0){
        console.log('üîÑ [ACESSOS FALLBACK] Nenhum acesso encontrado, tentando subcole√ß√£o...');
        try{
          const uid = auth.currentUser?.uid || window._adminFakeUser?.uid;
          if(!uid){
            console.log('üîê [ACESSOS FALLBACK] UID n√£o dispon√≠vel');
            return;
          }
          
          // Tentar carregar de subcole√ß√£o accesses_chunks (caso exista)
          const chunksRef = collection(db, "usuarios", uid, "accesses_chunks");
          const chunksSnap = await getDocs(chunksRef);
          
          if(!chunksSnap.empty){
            console.log('üì• [ACESSOS FALLBACK] Encontrados', chunksSnap.size, 'chunks de acessos');
            const allAccesses = [];
            chunksSnap.forEach(docSnap => {
              const data = docSnap.data();
              if(Array.isArray(data.items)){
                allAccesses.push(...data.items);
              }
            });
            if(allAccesses.length > 0){
              ACCESSES = allAccesses;
              USER_DATA.accesses = ACCESSES;
              console.log('‚úÖ [ACESSOS FALLBACK] Carregados', ACCESSES.length, 'acessos da subcole√ß√£o');
              return;
            }
          }
          
          // Tentar carregar do documento de backup
          const backupRef = doc(db, "usuarios", uid, "backups", "accesses");
          const backupSnap = await getDoc(backupRef);
          
          if(backupSnap.exists()){
            const data = backupSnap.data();
            if(Array.isArray(data.items)){
              ACCESSES = data.items;
              USER_DATA.accesses = ACCESSES;
              console.log('‚úÖ [ACESSOS FALLBACK] Carregados', ACCESSES.length, 'acessos do backup');
              return;
            }
          }
          
          console.log('üì≠ [ACESSOS FALLBACK] Nenhuma fonte alternativa encontrada');
        }catch(err){
          console.error('‚ùå [ACESSOS FALLBACK] Erro ao buscar subcole√ß√£o:', err);
        }
      }
    }
    
    function saveAccessesToUserData(){ USER_DATA.accesses = ACCESSES; }
    async function persistAccesses(){ saveAccessesToUserData(); const uid=auth.currentUser?.uid; if(!uid) return; await setDoc(doc(db,"usuarios",uid), { accesses: ACCESSES }, { merge:true }); }

    /* ===== ESTRUTURA√á√ÉO (GAMIFICA√á√ÉO) ===== */
    const ESTRUTURACAO_DATA = [
      {
        id: 'semana1',
        title: 'Semana 1',
        subtitle: 'Clareza e Diagn√≥stico Estrat√©gico',
        description: 'Entender profundamente o neg√≥cio, o mercado e os gargalos antes de qualquer execu√ß√£o',
        blocks: [
          {
            id: 'dir_estrategico',
            title: 'Direcionamento Estrat√©gico',
            items: [
              'Onde a empresa quer chegar',
              'Objetivo financeiro e de crescimento',
              'Expectativa de faturamento',
              'Volume de vendas desejado',
              'Posicionamento de marca no mercado'
            ]
          },
          {
            id: 'momento_atual',
            title: 'An√°lise do Momento Atual',
            items: [
              'Situa√ß√£o atual do marketing',
              'Situa√ß√£o atual das vendas',
              'Presen√ßa digital (site, redes sociais, an√∫ncios)',
              'Canais atuais de aquisi√ß√£o',
              'Gargalos vis√≠veis de convers√£o'
            ]
          },
          {
            id: 'mercado_concorrencia',
            title: 'An√°lise de Mercado e Concorr√™ncia',
            items: [
              'Concorrentes diretos e indiretos',
              'Como se posicionam',
              'Promessas que fazem',
              'Pontos fortes e fracos',
              'Onde todos falam a mesma coisa',
              'Oportunidades de diferencia√ß√£o (Oceano Azul)'
            ]
          },
          {
            id: 'matriz_cdt',
            title: 'MATRIZ CDT ‚Äî Caracter√≠sticas, Dores e Solu√ß√µes',
            items: [
              'Caracter√≠sticas: o que a empresa √©, faz e entrega',
              'Dores: problemas reais, frustra√ß√µes, medos e obje√ß√µes do cliente',
              'Solu√ß√µes (Transforma√ß√µes): como a empresa resolve essas dores'
            ]
          },
          {
            id: 'estrutura_time',
            title: 'Estrutura e Time Atual',
            items: [
              'Time interno do cliente',
              'Fun√ß√µes e responsabilidades',
              'Quem faz o qu√™',
              'Onde o marketing depende do cliente',
              'Onde o marketing executa de forma independente'
            ]
          },
          {
            id: 'entendimento_negocio',
            title: 'Entendimento Profundo do Neg√≥cio',
            items: [
              'Processo comercial atual',
              'Ticket m√©dio',
              'Margem',
              'Ciclo de venda',
              'Principais obje√ß√µes',
              'Principais pontos de perda de venda'
            ]
          }
        ]
      },
      {
        id: 'semana2',
        title: 'Semana 2',
        subtitle: 'Posicionamento e Estrutura de Crescimento',
        description: 'Definir para quem vender, o que vender e por que o cliente deve escolher essa empresa',
        blocks: [
          {
            id: 'puv',
            title: 'Defini√ß√£o da PUV (Proposta √önica de Valor)',
            items: [
              'Diferencial real da empresa',
              'Por que ela √© a melhor escolha',
              'O que faz diferente do mercado',
              'Mensagem simples, direta e defend√≠vel'
            ]
          },
          {
            id: 'pai',
            title: 'Defini√ß√£o do PAI (P√∫blico-Alvo Ideal)',
            items: [
              'Perfil do cliente ideal',
              'Caracter√≠sticas demogr√°ficas',
              'Comportamento de compra',
              'Dores e desejos',
              'Obje√ß√µes',
              'Momento de decis√£o'
            ]
          },
          {
            id: 'benchmarks',
            title: 'Estudo de Mercado e Benchmarks',
            items: [
              'Estrat√©gias que j√° funcionaram no nicho',
              'Tipos de an√∫ncios vencedores',
              'Modelos de oferta',
              'Estruturas de funil'
            ]
          },
          {
            id: 'melhorias',
            title: 'Pontos de Melhoria Imediatos',
            items: [
              'Ajustes r√°pidos de alto impacto',
              'Corre√ß√µes de comunica√ß√£o',
              'Ajustes de oferta',
              'Melhorias no processo comercial',
              'Cliente Oculto'
            ]
          }
        ]
      },
      {
        id: 'semana3_4',
        title: 'Semanas 3 e 4',
        subtitle: 'Metas, Estrat√©gias e Plano de A√ß√£o',
        description: 'Transformar estrat√©gia em execu√ß√£o pr√°tica',
        blocks: [
          {
            id: 'metas',
            title: 'Defini√ß√£o de Metas',
            items: [
              'Metas anuais',
              'Metas mensais',
              'Metas por canal',
              'Metas de leads, convers√£o e vendas',
              'M√©dias de custo por cliques no Google'
            ]
          },
          {
            id: 'visao_temporal',
            title: 'Vis√£o de Curto, M√©dio e Longo Prazo',
            items: [
              'Curto prazo: gerar demanda',
              'M√©dio prazo: previsibilidade',
              'Longo prazo: marca forte e crescimento sustent√°vel'
            ]
          },
          {
            id: 'google',
            title: 'Estrutura√ß√£o do Google (Plano de a√ß√£o)',
            items: [
              'Google Ads',
              'Google Meu Neg√≥cio',
              'Palavras-chave estrat√©gicas',
              'Funis de inten√ß√£o',
              'Capta√ß√£o de demanda pronta'
            ]
          },
          {
            id: 'site_seo',
            title: 'Estrutura√ß√£o do Site e SEO',
            items: [
              'Arquitetura do site',
              'P√°ginas de venda',
              'SEO estrat√©gico',
              'Conte√∫do para ranqueamento (BLOGS)',
              'Posicionamento da marca'
            ]
          },
          {
            id: 'redes_sociais',
            title: 'Estrutura√ß√£o das Redes Sociais',
            items: [
              'Objetivo das redes',
              'Tipos de conte√∫do',
              'Frequ√™ncia',
              'Linguagem',
              'Conte√∫dos de autoridade, prova social e convers√£o'
            ]
          },
          {
            id: 'copywriting',
            title: 'Copywriting',
            items: [
              'An√∫ncios (Google e Meta)',
              'Site',
              'Blogs',
              'Mensagens comerciais (DISPAROS, MENSAGENS DE RELACIONAMENTO)',
              'Scripts de venda comercial'
            ]
          }
        ]
      },
      {
        id: 'semana5',
        title: 'Semana 5',
        subtitle: 'Produ√ß√£o de Conte√∫do e Materiais',
        description: 'Criar os ativos que sustentam a estrat√©gia',
        blocks: [
          {
            id: 'conteudo_redes',
            title: 'Conte√∫do para Redes Sociais (gravado com o cliente)',
            items: [
              'Institucional',
              'Autoridade',
              'Prova social',
              'Convers√£o'
            ]
          },
          {
            id: 'conteudo_anuncios',
            title: 'Conte√∫do para An√∫ncios',
            items: [
              'V√≠deos curtos',
              'Criativos para Meta e Google',
              'Estrutura de an√∫ncios test√°veis'
            ]
          },
          {
            id: 'stories',
            title: 'Stories Iniciais',
            items: [
              'Padr√£o visual',
              'Bastidores',
              'Oferta',
              'Autoridade'
            ]
          },
          {
            id: 'materiais',
            title: 'Organiza√ß√£o de Materiais',
            items: [
              'Estrutura de pastas',
              'Organiza√ß√£o de v√≠deos, artes e copys',
              'Processo simples para o cliente'
            ]
          }
        ]
      },
      {
        id: 'semana6',
        title: 'Semana 6',
        subtitle: 'CRM e Automa√ß√µes',
        description: 'Organizar vendas e aumentar convers√£o sem aumentar tr√°fego',
        blocks: [
          {
            id: 'crm',
            title: 'Estrutura√ß√£o do CRM',
            items: [
              'Entrada de leads',
              'Funil de vendas',
              'Etapas',
              'Respons√°veis',
              'SLA de atendimento',
              'Implementa√ß√£o e treinamento'
            ]
          },
          {
            id: 'automacoes',
            title: 'Automa√ß√µes',
            items: [
              'Mensagens autom√°ticas',
              'Follow-ups',
              'Confirma√ß√µes',
              'Nutri√ß√£o de leads baseada na Matriz CDT'
            ]
          }
        ]
      },
      {
        id: 'semana7',
        title: 'Semana 7',
        subtitle: 'Opera√ß√£o e Entregas Finais',
        description: 'Deixar tudo padronizado, funcional e escal√°vel',
        blocks: [
          {
            id: 'paginas',
            title: 'Entrega de P√°ginas de Venda',
            items: [
              'Landing pages',
              'P√°ginas de servi√ßo',
              'Estrutura focada em convers√£o'
            ]
          },
          {
            id: 'site',
            title: 'Entrega do Site',
            items: [
              'Site funcional',
              'Alinhado √† estrat√©gia',
              'Preparado para tr√°fego e SEO'
            ]
          },
          {
            id: 'criativos',
            title: 'Entrega de Criativos Editados',
            items: [
              'An√∫ncios',
              'Artes',
              'V√≠deos',
              'Copys'
            ]
          },
          {
            id: 'padronizacoes',
            title: 'Padroniza√ß√µes',
            items: [
              'Google Ads padronizado',
              'Redes sociais padronizadas',
              'Comunica√ß√£o visual',
              'Linguagem de marca'
            ]
          },
          {
            id: 'posts',
            title: 'Entrega de Posts',
            items: [
              'Calend√°rio inicial',
              'Conte√∫dos prontos',
              'Dire√ß√£o clara de continuidade'
            ]
          }
        ]
      }
    ];

    // Disclaimers para cada semana de estrutura√ß√£o
    const ESTRUTURACAO_DISCLAIMERS = {
      semana1: {
        explain: {
          title: 'üìò Explica√ß√£o da Semana 1',
          content: `<ul>
            <li><strong>Direcionamento Estrat√©gico:</strong> Definir metas claras de crescimento e posicionamento.</li>
            <li><strong>Momento Atual:</strong> Diagn√≥stico completo da situa√ß√£o de marketing e vendas.</li>
            <li><strong>Mercado e Concorr√™ncia:</strong> Identificar oportunidades e diferenciais competitivos.</li>
            <li><strong>Matriz CDT:</strong> Mapear caracter√≠sticas, dores e solu√ß√µes do neg√≥cio.</li>
            <li><strong>Estrutura do Time:</strong> Entender quem faz o qu√™ para alinhar responsabilidades.</li>
            <li><strong>Entendimento do Neg√≥cio:</strong> Conhecer ticket m√©dio, ciclo de venda e obje√ß√µes.</li>
          </ul>`
        },
        warning: {
          title: '‚ö†Ô∏è Se n√£o for feito...',
          content: `<ul>
            <li>Campanhas ser√£o criadas "no escuro" sem direcionamento.</li>
            <li>Investimento em tr√°fego sem saber o que realmente funciona.</li>
            <li>Comunica√ß√£o gen√©rica que n√£o conecta com o cliente.</li>
            <li>Desalinhamento entre marketing e vendas.</li>
            <li>Perda de tempo e dinheiro com estrat√©gias erradas.</li>
          </ul>`
        },
        importance: {
          title: 'üéØ Por que estamos fazendo isso?',
          content: `Esta √© a <strong>funda√ß√£o de todo o projeto</strong>. Sem clareza e diagn√≥stico, qualquer a√ß√£o ser√° apenas "achismo". Investir tempo aqui evita retrabalho e garante que cada real investido tenha direcionamento estrat√©gico.`
        }
      },
      semana2: {
        explain: {
          title: 'üìò Explica√ß√£o da Semana 2',
          content: `<ul>
            <li><strong>PUV:</strong> Criar uma proposta √∫nica que diferencia a empresa da concorr√™ncia.</li>
            <li><strong>PAI:</strong> Definir exatamente quem √© o cliente ideal para direcionar toda comunica√ß√£o.</li>
            <li><strong>Benchmarks:</strong> Aprender com o que j√° funciona no mercado.</li>
            <li><strong>Melhorias Imediatas:</strong> Quick wins que geram resultados r√°pidos.</li>
          </ul>`
        },
        warning: {
          title: '‚ö†Ô∏è Se n√£o for feito...',
          content: `<ul>
            <li>A empresa ser√° "mais uma" no mercado, sem diferencial.</li>
            <li>An√∫ncios atrair√£o pessoas erradas, desperdi√ßando verba.</li>
            <li>Taxa de convers√£o baixa por falta de conex√£o com o p√∫blico.</li>
            <li>Oportunidades de melhoria r√°pida ser√£o ignoradas.</li>
          </ul>`
        },
        importance: {
          title: 'üéØ Por que estamos fazendo isso?',
          content: `<strong>Posicionamento √© poder.</strong> Quem n√£o se diferencia, compete por pre√ßo. Esta semana define a identidade √∫nica que far√° os clientes escolherem voc√™, n√£o a concorr√™ncia.`
        }
      },
      semana3_4: {
        explain: {
          title: 'üìò Explica√ß√£o das Semanas 3 e 4',
          content: `<ul>
            <li><strong>Metas:</strong> Transformar objetivos em n√∫meros mensur√°veis.</li>
            <li><strong>Vis√£o Temporal:</strong> Planejar curto, m√©dio e longo prazo.</li>
            <li><strong>Google:</strong> Estruturar capta√ß√£o de demanda pronta.</li>
            <li><strong>Site e SEO:</strong> Base para autoridade e convers√£o org√¢nica.</li>
            <li><strong>Redes Sociais:</strong> Definir presen√ßa digital estrat√©gica.</li>
            <li><strong>Copywriting:</strong> Criar textos que vendem em todos os canais.</li>
          </ul>`
        },
        warning: {
          title: '‚ö†Ô∏è Se n√£o for feito...',
          content: `<ul>
            <li>A√ß√µes sem metas = imposs√≠vel medir sucesso.</li>
            <li>Foco s√≥ no curto prazo, sem constru√ß√£o de marca.</li>
            <li>Google Ads mal estruturado = dinheiro jogado fora.</li>
            <li>Site sem estrat√©gia = visitantes que n√£o convertem.</li>
            <li>Redes sociais sem prop√≥sito = esfor√ßo sem resultado.</li>
          </ul>`
        },
        importance: {
          title: 'üéØ Por que estamos fazendo isso?',
          content: `<strong>Estrat√©gia sem execu√ß√£o √© sonho. Execu√ß√£o sem estrat√©gia √© pesadelo.</strong> Aqui transformamos todo o diagn√≥stico em um plano de a√ß√£o concreto com metas, canais e copywriting definidos.`
        }
      },
      semana5: {
        explain: {
          title: 'üìò Explica√ß√£o da Semana 5',
          content: `<ul>
            <li><strong>Conte√∫do para Redes:</strong> Produ√ß√£o de v√≠deos de autoridade, institucional e convers√£o.</li>
            <li><strong>Conte√∫do para An√∫ncios:</strong> Criativos test√°veis para Meta e Google.</li>
            <li><strong>Stories:</strong> Padr√£o visual e conte√∫do de bastidores.</li>
            <li><strong>Organiza√ß√£o de Materiais:</strong> Estrutura de pastas e processos claros.</li>
          </ul>`
        },
        warning: {
          title: '‚ö†Ô∏è Se n√£o for feito...',
          content: `<ul>
            <li>An√∫ncios com criativos fracos = baixa taxa de clique.</li>
            <li>Redes sociais vazias ou sem padr√£o profissional.</li>
            <li>Materiais desorganizados = caos operacional.</li>
            <li>Depend√™ncia constante do cliente para produ√ß√£o.</li>
          </ul>`
        },
        importance: {
          title: 'üéØ Por que estamos fazendo isso?',
          content: `<strong>Conte√∫do √© o combust√≠vel do marketing digital.</strong> Sem materiais de qualidade, campanhas n√£o performam. Esta semana garante que voc√™ tenha um arsenal de conte√∫dos prontos para usar.`
        }
      },
      semana6: {
        explain: {
          title: 'üìò Explica√ß√£o da Semana 6',
          content: `<ul>
            <li><strong>CRM:</strong> Sistema para gerenciar leads, funil de vendas e responsabilidades.</li>
            <li><strong>Automa√ß√µes:</strong> Mensagens autom√°ticas, follow-ups e nutri√ß√£o de leads.</li>
          </ul>`
        },
        warning: {
          title: '‚ö†Ô∏è Se n√£o for feito...',
          content: `<ul>
            <li>Leads esquecidos = vendas perdidas.</li>
            <li>Sem SLA = atendimento lento e despadronizado.</li>
            <li>Falta de follow-up = 80% das vendas perdidas.</li>
            <li>Sem automa√ß√£o = time sobrecarregado com tarefas repetitivas.</li>
          </ul>`
        },
        importance: {
          title: 'üéØ Por que estamos fazendo isso?',
          content: `<strong>CRM n√£o √© sobre tecnologia, √© sobre n√£o perder dinheiro.</strong> A maioria das empresas perde vendas por falta de organiza√ß√£o comercial. Automa√ß√µes multiplicam a capacidade do time.`
        }
      },
      semana7: {
        explain: {
          title: 'üìò Explica√ß√£o da Semana 7',
          content: `<ul>
            <li><strong>P√°ginas de Venda:</strong> Landing pages otimizadas para convers√£o.</li>
            <li><strong>Site:</strong> Entrega funcional e alinhada √† estrat√©gia.</li>
            <li><strong>Criativos:</strong> An√∫ncios, artes e v√≠deos editados.</li>
            <li><strong>Padroniza√ß√µes:</strong> Google Ads, redes sociais e linguagem de marca.</li>
            <li><strong>Posts:</strong> Calend√°rio inicial e dire√ß√£o de continuidade.</li>
          </ul>`
        },
        warning: {
          title: '‚ö†Ô∏è Se n√£o for feito...',
          content: `<ul>
            <li>Estrutura incompleta = opera√ß√£o travada.</li>
            <li>Falta de padroniza√ß√£o = comunica√ß√£o inconsistente.</li>
            <li>Sem calend√°rio = redes sociais abandonadas ap√≥s in√≠cio.</li>
            <li>Projeto sem entrega final = expectativas frustradas.</li>
          </ul>`
        },
        importance: {
          title: 'üéØ Por que estamos fazendo isso?',
          content: `<strong>Esta semana √© a entrega final que deixa tudo funcionando.</strong> √â aqui que toda a estrat√©gia se materializa em ativos prontos para uso. Uma estrutura escal√°vel que permite crescimento cont√≠nuo.`
        }
      }
    };

    let ESTRUTURACAO_STATE = {};
    let estruturacaoSaveTimeout = null;
    let estruturacaoIsSaving = false;
    let estruturacaoPendingSave = false;
    let estruturacaoLastSaveTime = 0;
    let estruturacaoUsesSubcollection = false;

    // ===== FUN√á√ÉO DE TESTE DE SALVAMENTO =====
    // Pode ser chamada no console: window.testarSalvamento()
    window.testarSalvamento = async function(){
      const uid = auth.currentUser?.uid;
      if(!uid){
        console.error('Usu√°rio n√£o autenticado');
        return;
      }
      
      console.log('üß™ Testando salvamento da Estrutura√ß√£o...');
      console.log('üìä Estado atual:', Object.keys(ESTRUTURACAO_STATE));
      
      // Verificar weekData em cada semana
      Object.keys(ESTRUTURACAO_STATE).forEach(weekId => {
        const week = ESTRUTURACAO_STATE[weekId];
        console.log(`üìÖ ${weekId}:`, {
          temBlocks: !!week?.blocks,
          blocksCount: week?.blocks ? Object.keys(week.blocks).length : 0,
          temWeekData: !!week?.weekData,
          note: week?.weekData?.note?.length || 0,
          files: week?.weekData?.files?.length || 0,
          checklist: week?.weekData?.checklist?.length || 0,
          checklistItems: week?.weekData?.checklist || []
        });
      });
      
      // For√ßar salvamento imediato com prote√ß√£o
      console.log('üíæ For√ßando salvamento...');
      try{
        const dataToSave = JSON.parse(JSON.stringify(ESTRUTURACAO_STATE));
        const result = await safeWriteUserDoc({ estruturacao: dataToSave });
        
        if(!result.success) {
          console.error('‚ùå Falha ao salvar estrutura√ß√£o:', result.error);
          throw new Error(result.error);
        }
        
        if(result.autoCleanup || result.emergencyCleanup) {
          console.log('üßπ Limpeza autom√°tica executada ao salvar estrutura√ß√£o');
        }
        
        console.log('‚úÖ Salvamento bem sucedido!');
        
        // Verificar se foi salvo
        console.log('üîç Verificando dados salvos...');
        const userDoc = await getDoc(doc(db, "usuarios", uid));
        const userData = userDoc.data();
        if(userData?.estruturacao){
          console.log('‚úÖ Dados confirmados no Firebase:', Object.keys(userData.estruturacao));
          Object.keys(userData.estruturacao).forEach(weekId => {
            const week = userData.estruturacao[weekId];
            console.log(`  üìÖ ${weekId}:`, {
              temWeekData: !!week?.weekData,
              checklist: week?.weekData?.checklist?.length || 0
            });
          });
        } else {
          console.log('‚ùå Dados n√£o encontrados no Firebase!');
        }
        
        return userData?.estruturacao;
      }catch(err){
        console.error('‚ùå Erro no teste:', err);
        return null;
      }
    };

    // ===== FUN√á√ïES DE RECUPERA√á√ÉO DE EMERG√äNCIA =====
    
    // DIAGN√ìSTICO COMPLETO - window.diagnosticoCompleto()
    window.diagnosticoCompleto = async function(){
      const uid = auth.currentUser?.uid;
      if(!uid){
        console.error('‚ùå Usu√°rio n√£o autenticado');
        return;
      }
      
      console.log('üîç ===== DIAGN√ìSTICO COMPLETO DA ESTRUTURA√á√ÉO =====');
      
      try{
        // 1. Estado local
        console.log('\nüì¶ 1. ESTADO LOCAL (MEM√ìRIA):');
        console.log('  ESTRUTURACAO_STATE keys:', Object.keys(ESTRUTURACAO_STATE));
        console.log('  estruturacaoUsesSubcollection:', estruturacaoUsesSubcollection);
        
        if(Object.keys(ESTRUTURACAO_STATE).length > 0){
          let localContentCount = 0;
          Object.keys(ESTRUTURACAO_STATE).forEach(weekId => {
            const week = ESTRUTURACAO_STATE[weekId];
            const noteLenght = week?.weekData?.note?.length || 0;
            const checklistCount = week?.weekData?.checklist?.length || 0;
            const filesCount = week?.weekData?.files?.length || 0;
            localContentCount += noteLenght + (checklistCount * 10) + (filesCount * 5);
            
            if(noteLenght > 0 || checklistCount > 0 || filesCount > 0){
              console.log(`    ${weekId}: note=${noteLenght}chars, checklist=${checklistCount}, files=${filesCount}`);
            }
          });
          console.log('  üìä Peso do conte√∫do local:', localContentCount);
        }
        
        // 2. Documento principal no Firebase
        console.log('\n‚òÅÔ∏è 2. DOCUMENTO PRINCIPAL (FIREBASE):');
        const userDoc = await getDoc(doc(db, "usuarios", uid));
        const userData = userDoc.data() || {};
        
        console.log('  estruturacaoUsesSubcollection:', userData.estruturacaoUsesSubcollection);
        console.log('  estruturacaoLastUpdate:', userData.estruturacaoLastUpdate);
        console.log('  estruturacao existe:', !!userData.estruturacao);
        
        let principalContentCount = 0;
        if(userData.estruturacao){
          const keys = Object.keys(userData.estruturacao);
          console.log('  estruturacao keys:', keys);
          
          keys.forEach(weekId => {
            const week = userData.estruturacao[weekId];
            const noteLength = week?.weekData?.note?.length || 0;
            const checklistCount = week?.weekData?.checklist?.length || 0;
            const filesCount = week?.weekData?.files?.length || 0;
            principalContentCount += noteLength + (checklistCount * 10) + (filesCount * 5);
            
            if(noteLength > 0 || checklistCount > 0 || filesCount > 0){
              console.log(`    ${weekId}: note=${noteLength}chars, checklist=${checklistCount}, files=${filesCount}`);
            }
          });
          console.log('  üìä Peso do conte√∫do principal:', principalContentCount);
        } else {
          console.log('  ‚ö†Ô∏è Campo estruturacao N√ÉO existe no documento principal');
        }
        
        // 3. Subcole√ß√µes
        console.log('\nüìÇ 3. SUBCOLE√á√ïES (FIREBASE):');
        const subcollectionRef = collection(db, "usuarios", uid, "estruturacao");
        const snapshot = await getDocs(subcollectionRef);
        console.log('  Documentos encontrados:', snapshot.size);
        
        let subContentCount = 0;
        if(snapshot.size > 0){
          snapshot.forEach(docSnap => {
            const week = docSnap.data();
            const noteLength = week?.weekData?.note?.length || 0;
            const checklistCount = week?.weekData?.checklist?.length || 0;
            const filesCount = week?.weekData?.files?.length || 0;
            subContentCount += noteLength + (checklistCount * 10) + (filesCount * 5);
            
            if(noteLength > 0 || checklistCount > 0 || filesCount > 0){
              console.log(`    ${docSnap.id}: note=${noteLength}chars, checklist=${checklistCount}, files=${filesCount}`);
            }
          });
          console.log('  üìä Peso do conte√∫do subcole√ß√µes:', subContentCount);
        }
        
        // 4. Recomenda√ß√£o
        console.log('\nüí° 4. RECOMENDA√á√ÉO:');
        const localCount = Object.keys(ESTRUTURACAO_STATE).length > 0 ? countRealContent(ESTRUTURACAO_STATE) : 0;
        
        console.log('  Pesos calculados:');
        console.log('    - Local (mem√≥ria):', localCount);
        console.log('    - Principal (Firebase):', principalContentCount);
        console.log('    - Subcole√ß√µes (Firebase):', subContentCount);
        
        const maxWeight = Math.max(localCount, principalContentCount, subContentCount);
        
        if(maxWeight === 0){
          console.log('  ‚ùå Nenhum dado encontrado em lugar algum');
          console.log('  Os dados podem ter sido perdidos permanentemente.');
        } else if(maxWeight === principalContentCount){
          console.log('  ‚úÖ Documento principal tem MAIS dados');
          console.log('  Execute: window.recuperarDoPrincipal()');
        } else if(maxWeight === subContentCount){
          console.log('  ‚úÖ Subcole√ß√µes t√™m MAIS dados');
          console.log('  Execute: window.recuperarDasSubcolecoes()');
        } else {
          console.log('  ‚úÖ Estado local tem MAIS dados');
          console.log('  Tente salvar: persistEstruturacao()');
        }
        
        return {
          local: localCount,
          principal: principalContentCount,
          subcollections: subContentCount
        };
        
      }catch(err){
        console.error('‚ùå Erro no diagn√≥stico:', err);
      }
    };
    
    // RECUPERAR DO DOCUMENTO PRINCIPAL - window.recuperarDoPrincipal()
    window.recuperarDoPrincipal = async function(){
      const uid = auth.currentUser?.uid;
      if(!uid){
        console.error('‚ùå Usu√°rio n√£o autenticado');
        return;
      }
      
      try{
        console.log('üîß Recuperando do documento principal...');
        const userDoc = await getDoc(doc(db, "usuarios", uid));
        const userData = userDoc.data() || {};
        
        if(userData.estruturacao && Object.keys(userData.estruturacao).length > 0){
          const normalized = normalizeLoadedState(userData.estruturacao);
          ESTRUTURACAO_STATE = normalized;
          USER_DATA.estruturacao = normalized;
          
          console.log('‚úÖ Dados recuperados do documento principal:', Object.keys(normalized).length, 'semanas');
          renderEstruturacao();
          
          // Salvar nas subcole√ß√µes como backup
          console.log('üíæ Salvando nas subcole√ß√µes como backup...');
          await persistEstruturacaoSplit(uid, normalized);
          
          return normalized;
        } else {
          console.log('‚ùå Documento principal n√£o cont√©m dados de estrutura√ß√£o');
          return null;
        }
      }catch(err){
        console.error('‚ùå Erro:', err);
      }
    };
    
    // RECUPERAR DAS SUBCOLE√á√ïES - window.recuperarDasSubcolecoes()
    window.recuperarDasSubcolecoes = async function(){
      const uid = auth.currentUser?.uid;
      if(!uid){
        console.error('‚ùå Usu√°rio n√£o autenticado');
        return;
      }
      
      try{
        console.log('üîß Recuperando das subcole√ß√µes...');
        const subcollectionRef = collection(db, "usuarios", uid, "estruturacao");
        const snapshot = await getDocs(subcollectionRef);
        
        if(snapshot.size > 0){
          const loadedState = {};
          snapshot.forEach(docSnap => {
            loadedState[docSnap.id] = docSnap.data();
          });
          
          const normalized = normalizeLoadedState(loadedState);
          ESTRUTURACAO_STATE = normalized;
          USER_DATA.estruturacao = normalized;
          estruturacaoUsesSubcollection = true;
          
          console.log('‚úÖ Dados recuperados das subcole√ß√µes:', Object.keys(normalized).length, 'semanas');
          renderEstruturacao();
          return normalized;
        } else {
          console.log('‚ùå Subcole√ß√µes vazias');
          return null;
        }
      }catch(err){
        console.error('‚ùå Erro:', err);
      }
    };
    
    // FOR√áAR RECARREGAMENTO COMPLETO - window.recarregarEstruturacao()
    window.recarregarEstruturacao = async function(){
      console.log('üîÑ For√ßando recarregamento completo...');
      estruturacaoAlreadyLoaded = false; // Resetar flag
      estruturacaoLoadingFromSubcollections = false; // Resetar flag
      await loadEstruturacaoFromFirebase();
      renderEstruturacao();
      console.log('‚úÖ Estrutura√ß√£o recarregada');
    };
    
    // SALVAR ESTRUTURA√á√ÉO - window.salvarEstruturacao()
    // Fun√ß√£o global para salvar manualmente (pode ser chamada no console)
    window.salvarEstruturacao = async function(){
      const uid = auth.currentUser?.uid;
      if(!uid){
        console.error('‚ùå Usu√°rio n√£o autenticado');
        return false;
      }
      
      console.log('üíæ Salvando estrutura√ß√£o nas subcole√ß√µes...');
      
      try{
        saveEstruturacaoToUserData();
        const dataToSave = JSON.parse(JSON.stringify(ESTRUTURACAO_STATE));
        
        if(Object.keys(dataToSave).length === 0){
          console.log('‚ö†Ô∏è Nenhum dado para salvar');
          return false;
        }
        
        // Mostrar o que vai salvar
        console.log('üìä Dados a salvar:', Object.keys(dataToSave).length, 'semanas');
        Object.keys(dataToSave).forEach(weekId => {
          const week = dataToSave[weekId];
          console.log(`  ${weekId}:`, {
            noteLength: week?.weekData?.note?.length || 0,
            checklistCount: week?.weekData?.checklist?.length || 0,
            filesCount: week?.weekData?.files?.length || 0,
            blocksCount: week?.blocks ? Object.keys(week.blocks).length : 0
          });
        });
                                  
        await persistEstruturacaoSplit(uid, dataToSave);
        console.log('‚úÖ Estrutura√ß√£o salva com sucesso!', Object.keys(dataToSave).length, 'semanas');
        showEstruturacaoSaveIndicator('saved');
        return true;
      }catch(err){
        console.error('‚ùå Erro ao salvar:', err);
        showEstruturacaoSaveIndicator('error');
        return false;
      }
    };
    
    // RESTAURAR DADOS DE BACKUP - window.restaurarDadosDeBackup(dadosJSON)
    // Usa dados copiados do console para restaurar
    window.restaurarDadosDeBackup = async function(dadosJSON){
      const uid = auth.currentUser?.uid;
      if(!uid){
        console.error('‚ùå Usu√°rio n√£o autenticado');
        return false;
      }
      
      try{
        let dados;
        if(typeof dadosJSON === 'string'){
          dados = JSON.parse(dadosJSON);
        } else {
          dados = dadosJSON;
        }
        
        if(!dados || Object.keys(dados).length === 0){
          console.error('‚ùå Dados inv√°lidos ou vazios');
          return false;
        }
        
        console.log('üîß Restaurando dados de backup...');
        console.log('üìä Semanas encontradas:', Object.keys(dados));
        
        // Normalizar e aplicar
        const normalized = normalizeLoadedState(dados);
        ESTRUTURACAO_STATE = normalized;
        USER_DATA.estruturacao = normalized;
        
        // Salvar nas subcole√ß√µes
        await persistEstruturacaoSplit(uid, normalized);
        
        // Renderizar
        renderEstruturacao();
        
        console.log('‚úÖ Dados restaurados com sucesso!');
        return true;
      }catch(err){
        console.error('‚ùå Erro ao restaurar:', err);
        return false;
      }
    };
    
    // VER ESTADO ATUAL - window.verEstadoAtual()
    window.verEstadoAtual = function(){
      console.log('üìä ESTADO ATUAL DA ESTRUTURA√á√ÉO:');
      console.log('Semanas:', Object.keys(ESTRUTURACAO_STATE));
      
      Object.keys(ESTRUTURACAO_STATE).forEach(weekId => {
        const week = ESTRUTURACAO_STATE[weekId];
        console.log(`\nüìÖ ${weekId}:`);
        console.log('  weekData:', {
          note: week?.weekData?.note?.substring(0, 50) || '(vazio)',
          noteLength: week?.weekData?.note?.length || 0,
          checklist: week?.weekData?.checklist?.length || 0,
          files: week?.weekData?.files?.length || 0
        });
        
        if(week?.blocks){
          const blockIds = Object.keys(week.blocks);
          console.log('  blocks:', blockIds.length, 'blocos');
          blockIds.forEach(blockId => {
            const block = week.blocks[blockId];
            const itemCount = block?.items ? Object.keys(block.items).length : 0;
            const completedItems = block?.items ? Object.values(block.items).filter(i => i.completed).length : 0;
            console.log(`    ${blockId}: ${completedItems}/${itemCount} itens`);
          });
        }
      });
      
      return ESTRUTURACAO_STATE;
    };

    // Pode ser chamada no console: window.recuperarEstruturacao()
    window.recuperarEstruturacao = async function(){
      const uid = auth.currentUser?.uid;
      if(!uid){
        console.error('Usu√°rio n√£o autenticado');
        return;
      }
      
      console.log('üîß Iniciando recupera√ß√£o de dados da Estrutura√ß√£o...');
      
      try{
        // 1. Buscar documento principal
        const userDoc = await getDoc(doc(db, "usuarios", uid));
        const userData = userDoc.data() || {};
        
        console.log('üìÑ Documento principal:');
        console.log('  - estruturacaoUsesSubcollection:', userData.estruturacaoUsesSubcollection);
        console.log('  - estruturacao existe:', !!userData.estruturacao);
        console.log('  - estruturacao keys:', userData.estruturacao ? Object.keys(userData.estruturacao) : []);
        
        // Mostrar detalhes do estruturacao se existir
        if(userData.estruturacao){
          console.log('  üìù Conte√∫do do estruturacao:');
          Object.keys(userData.estruturacao).forEach(key => {
            const data = userData.estruturacao[key];
            console.log(`    - ${key}:`, {
              hasBlocks: !!data?.blocks,
              blocksCount: data?.blocks ? Object.keys(data.blocks).length : 0,
              hasNotes: !!data?.notes,
              notesLength: data?.notes?.length || 0,
              hasFiles: !!data?.files,
              filesCount: data?.files?.length || 0,
              hasChecklist: !!data?.checklist,
              checklistCount: data?.checklist?.length || 0
            });
          });
        }
        
        // 2. Buscar subcole√ß√µes
        const subcollectionRef = collection(db, "usuarios", uid, "estruturacao");
        const snapshot = await getDocs(subcollectionRef);
        console.log('üìÇ Subcole√ß√µes encontradas:', snapshot.size);
        
        if(snapshot.size > 0){
          console.log('  üìù Conte√∫do das subcole√ß√µes:');
          snapshot.forEach(docSnap => {
            const data = docSnap.data();
            console.log(`    - ${docSnap.id}:`, {
              hasBlocks: !!data?.blocks,
              blocksCount: data?.blocks ? Object.keys(data.blocks).length : 0,
              hasNotes: !!data?.notes,
              notesLength: data?.notes?.length || 0,
              hasFiles: !!data?.files,
              filesCount: data?.files?.length || 0,
              hasChecklist: !!data?.checklist,
              checklistCount: data?.checklist?.length || 0
            });
          });
        }
        
        // 3. Carregar dados de onde existirem
        if(userData.estruturacao && Object.keys(userData.estruturacao).length > 0){
          console.log('‚úÖ Dados encontrados no documento principal!');
          ESTRUTURACAO_STATE = userData.estruturacao;
          USER_DATA.estruturacao = userData.estruturacao;
          
          // Resetar flag de subcole√ß√£o se n√£o houver subcole√ß√µes
          if(snapshot.size === 0 && userData.estruturacaoUsesSubcollection){
            console.log('üîÑ Resetando flag de subcole√ß√£o...');
            await setDoc(doc(db, "usuarios", uid), { 
              estruturacaoUsesSubcollection: false 
            }, { merge: true });
            estruturacaoUsesSubcollection = false;
            USER_DATA.estruturacaoUsesSubcollection = false;
          }
          
          renderEstruturacao();
          console.log('‚úÖ Estrutura√ß√£o renderizada!');
          return ESTRUTURACAO_STATE;
        }
        
        if(snapshot.size > 0){
          console.log('‚úÖ Dados encontrados nas subcole√ß√µes!');
          const loadedState = {};
          snapshot.forEach(docSnap => {
            loadedState[docSnap.id] = docSnap.data();
          });
          ESTRUTURACAO_STATE = loadedState;
          USER_DATA.estruturacao = loadedState;
          renderEstruturacao();
          console.log('‚úÖ Estrutura√ß√£o renderizada!');
          return ESTRUTURACAO_STATE;
        }
        
        console.log('‚ùå Nenhum dado encontrado em lugar nenhum');
        console.log('üí° Os dados podem ter sido perdidos ou nunca foram salvos corretamente.');
        return null;
      }catch(err){
        console.error('Erro na recupera√ß√£o:', err);
        return null;
      }
    };
    
    // Fun√ß√£o de diagn√≥stico - pode ser chamada: window.diagnosticoEstruturacao()
    window.diagnosticoEstruturacao = function(){
      console.log('üìä DIAGN√ìSTICO DA ESTRUTURA√á√ÉO:');
      console.log('  - ESTRUTURACAO_STATE keys:', Object.keys(ESTRUTURACAO_STATE));
      console.log('  - USER_DATA.estruturacao keys:', USER_DATA.estruturacao ? Object.keys(USER_DATA.estruturacao) : 'undefined');
      console.log('  - estruturacaoUsesSubcollection:', estruturacaoUsesSubcollection);
      console.log('  - USER_DATA.estruturacaoUsesSubcollection:', USER_DATA.estruturacaoUsesSubcollection);
      console.log('  - estruturacaoIsSaving:', estruturacaoIsSaving);
      console.log('  - estruturacaoPendingSave:', estruturacaoPendingSave);
      
      // Verificar arquivos em cada semana
      Object.keys(ESTRUTURACAO_STATE).forEach(weekId => {
        const week = ESTRUTURACAO_STATE[weekId];
        const weekData = week?.weekData || {};
        const blocks = week?.blocks || {};
        
        // Contar notas em itens
        let itemNotesCount = 0;
        let itemsWithContent = 0;
        Object.values(blocks).forEach(block => {
          Object.values(block.items || {}).forEach(item => {
            if(item.note && item.note.trim().length > 0) itemNotesCount++;
            if(item.note || item.files?.length > 0 || item.completed) itemsWithContent++;
          });
        });
        
        console.log(`  üìÖ ${weekId}:`, {
          'weekData.note': weekData.note?.length || 0,
          'weekData.files': weekData.files?.length || 0,
          'weekData.checklist': weekData.checklist?.length || 0,
          'blocks': Object.keys(blocks).length,
          'itemsWithContent': itemsWithContent,
          'itemNotesCount': itemNotesCount
        });
      });
      
      // Calcular tamanho do estado
      const stateSize = new Blob([JSON.stringify(ESTRUTURACAO_STATE)]).size;
      console.log('  üì¶ Tamanho estrutura√ß√£o:', Math.round(stateSize / 1024), 'KB');
      console.log('  ‚ö†Ô∏è Limite Firestore: 1024 KB por documento');
      console.log('  ‚úÖ Usando subcole√ß√µes:', estruturacaoUsesSubcollection);
      
      return ESTRUTURACAO_STATE;
    };
    
    // Diagn√≥stico completo do documento do usu√°rio
    window.diagnosticoDocumento = async function(){
      const uid = auth.currentUser?.uid;
      if(!uid){
        console.log('‚ùå Usu√°rio n√£o logado');
        return;
      }
      
      try{
        const userDoc = await getDoc(doc(db, "usuarios", uid));
        const userData = userDoc.data() || {};
        
        console.log('üìä DIAGN√ìSTICO DO DOCUMENTO DO USU√ÅRIO:');
        console.log('  üìÅ UID:', uid);
        
        // Calcular tamanho de cada campo
        const fieldSizes = {};
        let totalSize = 0;
        
        Object.keys(userData).forEach(key => {
          const size = new Blob([JSON.stringify(userData[key])]).size;
          fieldSizes[key] = size;
          totalSize += size;
        });
        
        // Ordenar por tamanho
        const sorted = Object.entries(fieldSizes).sort((a, b) => b[1] - a[1]);
        
        console.log('  üì¶ Tamanhos por campo (ordenado):');
        sorted.forEach(([key, size]) => {
          const kb = Math.round(size / 1024);
          const pct = Math.round((size / totalSize) * 100);
          const bar = '‚ñà'.repeat(Math.min(pct / 2, 20));
          console.log(`     ${key}: ${kb}KB (${pct}%) ${bar}`);
        });
        
        console.log('  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
        console.log(`  üì¶ TOTAL: ${Math.round(totalSize / 1024)}KB`);
        console.log(`  ‚ö†Ô∏è Limite: 1024KB`);
        console.log(`  ${totalSize > 900000 ? 'üî¥ CR√çTICO' : totalSize > 700000 ? 'üü° ATEN√á√ÉO' : 'üü¢ OK'}`);
        
        // Verificar subcole√ß√µes
        if(userData.estruturacaoUsesSubcollection){
          const subcollectionRef = collection(db, "usuarios", uid, "estruturacao");
          const snapshot = await getDocs(subcollectionRef);
          console.log(`  üìÇ Subcole√ß√µes de estrutura√ß√£o: ${snapshot.size} documentos`);
        }
        
        return { userData, fieldSizes, totalSize };
      }catch(err){
        console.error('Erro no diagn√≥stico:', err);
      }
    };
    
    // Migrar estrutura√ß√£o para subcole√ß√µes e limpar documento principal
    window.migrarEstruturacaoParaSubcolecoes = async function(){
      const uid = auth.currentUser?.uid;
      if(!uid){
        console.log('‚ùå Usu√°rio n√£o logado');
        return;
      }
      
      console.log('üöÄ Iniciando migra√ß√£o da estrutura√ß√£o para subcole√ß√µes...');
      
      try{
        // Verificar se h√° dados no ESTRUTURACAO_STATE
        if(Object.keys(ESTRUTURACAO_STATE).length === 0){
          console.log('‚ùå Nenhum dado de estrutura√ß√£o para migrar');
          return;
        }
        
        // Salvar em subcole√ß√µes
        const dataToSave = JSON.parse(JSON.stringify(ESTRUTURACAO_STATE));
        await persistEstruturacaoSplit(uid, dataToSave);
        
        console.log('‚úÖ Migra√ß√£o conclu√≠da!');
        console.log('   - Dados salvos em subcole√ß√µes');
        console.log('   - Campo estruturacao removido do documento principal');
        
        // Executar diagn√≥stico para confirmar
        await window.diagnosticoDocumento();
        
        return true;
      }catch(err){
        console.error('‚ùå Erro na migra√ß√£o:', err);
        return false;
      }
    };
    
    // Normalizar estrutura do ESTRUTURACAO_STATE para garantir que weekData existe em todas as semanas
    function normalizeEstruturacaoState(){
      Object.keys(ESTRUTURACAO_STATE).forEach(weekId => {
        if(!ESTRUTURACAO_STATE[weekId]) {
          ESTRUTURACAO_STATE[weekId] = { blocks: {}, weekData: { note: '', files: [], checklist: [] } };
        }
        if(!ESTRUTURACAO_STATE[weekId].blocks) {
          ESTRUTURACAO_STATE[weekId].blocks = {};
        }
        if(!ESTRUTURACAO_STATE[weekId].weekData) {
          ESTRUTURACAO_STATE[weekId].weekData = { note: '', files: [], checklist: [] };
        }
        const wd = ESTRUTURACAO_STATE[weekId].weekData;
        if(!wd.note) wd.note = '';
        if(!wd.files) wd.files = [];
        if(!wd.checklist) wd.checklist = [];
      });
      console.log('[Estrutura√ß√£o] Estado normalizado');
    }

    let estruturacaoAlreadyLoaded = false; // Flag para evitar recarregamento desnecess√°rio
    
    function loadEstruturacaoFromUserData(){
      // S√≥ carregar se n√£o houver salvamento pendente para evitar sobrescrever dados locais
      if(estruturacaoIsSaving || estruturacaoPendingSave){
        console.log('[Estrutura√ß√£o] Ignorando load - salvamento pendente');
        return;
      }
      
      // Se j√° carregou e tem dados, n√£o recarregar
      if(estruturacaoAlreadyLoaded && Object.keys(ESTRUTURACAO_STATE).length > 0){
        console.log('[Estrutura√ß√£o] Dados j√° carregados, ignorando reload');
        return;
      }
      
      // Debug: mostrar o que temos no USER_DATA
      console.log('[Estrutura√ß√£o] USER_DATA.estruturacaoUsesSubcollection:', USER_DATA.estruturacaoUsesSubcollection);
      console.log('[Estrutura√ß√£o] USER_DATA.estruturacao keys:', USER_DATA.estruturacao ? Object.keys(USER_DATA.estruturacao).length : 0);
      
      // Sincronizar flag de subcole√ß√µes
      if(USER_DATA.estruturacaoUsesSubcollection){
        estruturacaoUsesSubcollection = true;
      }
      
      // Se usa subcole√ß√µes E ainda n√£o tem dados carregados, carregar
      if((estruturacaoUsesSubcollection || USER_DATA.estruturacaoUsesSubcollection) && Object.keys(ESTRUTURACAO_STATE).length === 0){
        console.log('[Estrutura√ß√£o] Carregando de subcole√ß√µes (fonte principal)...');
        loadEstruturacaoFromSubcollections().then(() => {
          estruturacaoAlreadyLoaded = true;
        });
        return;
      }
      
      // Fallback: Tentar carregar do documento principal
      const loaded = USER_DATA.estruturacao || {};
      if(Object.keys(loaded).length > 0){
        // Merge inteligente: manter dados locais mais recentes
        if(Object.keys(ESTRUTURACAO_STATE).length > 0 && estruturacaoLastSaveTime > Date.now() - 5000){
          console.log('[Estrutura√ß√£o] Mantendo estado local recente');
          return;
        }
        ESTRUTURACAO_STATE = loaded;
        normalizeEstruturacaoState();
        estruturacaoAlreadyLoaded = true;
        console.log('[Estrutura√ß√£o] Estado carregado do documento principal:', Object.keys(ESTRUTURACAO_STATE).length, 'semanas');
        return;
      }
      
      // NOVO FALLBACK: Se n√£o encontrou dados no documento principal, tentar subcole√ß√£o
      console.log('[Estrutura√ß√£o] Documento principal vazio, tentando subcole√ß√£o como fallback...');
      loadEstruturacaoFromSubcollections().then(() => {
        estruturacaoAlreadyLoaded = true;
        // Depois de carregar, renderizar se estamos na aba estrutura√ß√£o
        if(currentSection === 'estruturacao'){
          renderEstruturacao();
        }
      }).catch(err => {
        console.log('[Estrutura√ß√£o] Erro ao carregar subcole√ß√£o:', err);
        console.log('[Estrutura√ß√£o] Nenhum dado encontrado para carregar');
      });
    }
    
    // Carregar estrutura√ß√£o de subcole√ß√µes (quando documento principal excede limite)
    let estruturacaoLoadingFromSubcollections = false; // Flag para evitar loop
    
    async function loadEstruturacaoFromSubcollections(){
      // Evitar chamadas simult√¢neas/recursivas
      if(estruturacaoLoadingFromSubcollections){
        console.log('[Estrutura√ß√£o] J√° carregando subcole√ß√µes, ignorando...');
        return;
      }
      
      const currentUser = window.getCurrentUser();
      const uid = currentUser?.uid;
      if(!uid) return;
      
      estruturacaoLoadingFromSubcollections = true;
      
      try{
        const subcollectionRef = collection(db, "usuarios", uid, "estruturacao");
        const snapshot = await getDocs(subcollectionRef);
        
        const loadedState = {};
        snapshot.forEach(docSnap => {
          loadedState[docSnap.id] = docSnap.data();
        });
        
        if(Object.keys(loadedState).length > 0){
          ESTRUTURACAO_STATE = loadedState;
          normalizeEstruturacaoState();
          USER_DATA.estruturacao = loadedState; // Sincronizar
          console.log('[Estrutura√ß√£o] Carregado de subcole√ß√µes:', Object.keys(loadedState).length, 'semanas');
          // N√ÉO chamar renderEstruturacao aqui para evitar loop
        } else {
          // Fallback: se subcole√ß√µes est√£o vazias, carregar do documento principal
          console.log('[Estrutura√ß√£o] Subcole√ß√µes vazias, tentando carregar do documento principal...');
          const loaded = USER_DATA.estruturacao || {};
          if(Object.keys(loaded).length > 0){
            ESTRUTURACAO_STATE = loaded;
            normalizeEstruturacaoState();
            console.log('[Estrutura√ß√£o] Carregado do documento principal (fallback):', Object.keys(ESTRUTURACAO_STATE).length, 'semanas');
            // N√ÉO chamar renderEstruturacao aqui para evitar loop
          }
        }
      }catch(err){
        console.error('[Estrutura√ß√£o] Erro ao carregar subcole√ß√µes:', err);
        // Em caso de erro, tentar carregar do documento principal
        console.log('[Estrutura√ß√£o] Tentando fallback para documento principal...');
        const loaded = USER_DATA.estruturacao || {};
        if(Object.keys(loaded).length > 0){
          ESTRUTURACAO_STATE = loaded;
          normalizeEstruturacaoState();
          console.log('[Estrutura√ß√£o] Carregado do documento principal ap√≥s erro:', Object.keys(ESTRUTURACAO_STATE).length, 'semanas');
          // N√ÉO chamar renderEstruturacao aqui
        }
      } finally {
        estruturacaoLoadingFromSubcollections = false;
      }
    }

    function saveEstruturacaoToUserData(){
      USER_DATA.estruturacao = ESTRUTURACAO_STATE;
    }

    // Indicador visual de salvamento
    function showEstruturacaoSaveIndicator(status){
      let indicator = document.getElementById('estruturacaoSaveIndicator');
      if(!indicator){
        indicator = document.createElement('div');
        indicator.id = 'estruturacaoSaveIndicator';
        indicator.style.cssText = `
          position: fixed;
          bottom: 20px;
          right: 20px;
          padding: 10px 20px;
          border-radius: 8px;
          font-size: 14px;
          font-weight: 500;
          z-index: 9999;
          transition: opacity 0.3s ease;
          pointer-events: none;
        `;
        document.body.appendChild(indicator);
      }
      
      if(status === 'saving'){
        indicator.textContent = 'üíæ Salvando...';
        indicator.style.background = 'rgba(255, 193, 7, 0.95)';
        indicator.style.color = '#000';
        indicator.style.opacity = '1';
      } else if(status === 'saved'){
        indicator.textContent = '‚úÖ Salvo!';
        indicator.style.background = 'rgba(76, 175, 80, 0.95)';
        indicator.style.color = '#fff';
        indicator.style.opacity = '1';
        setTimeout(() => { indicator.style.opacity = '0'; }, 2000);
      } else if(status === 'error'){
        indicator.textContent = '‚ùå Erro ao salvar';
        indicator.style.background = 'rgba(244, 67, 54, 0.95)';
        indicator.style.color = '#fff';
        indicator.style.opacity = '1';
        setTimeout(() => { indicator.style.opacity = '0'; }, 4000);
      } else {
        indicator.style.opacity = '0';
      }
    }

    async function persistEstruturacao(){
      saveEstruturacaoToUserData();
      const currentUser = window.getCurrentUser();
      const uid = currentUser?.uid;
      if(!uid){
        console.warn('[Estrutura√ß√£o] Usu√°rio n√£o autenticado - salvamento cancelado');
        return;
      }
      
      // Debug: Mostrar estado atual
      console.log('[Estrutura√ß√£o] persistEstruturacao chamado. Estado atual:', {
        semanas: Object.keys(ESTRUTURACAO_STATE),
        temDados: Object.keys(ESTRUTURACAO_STATE).length > 0
      });
      
      // Debug: Verificar se weekData existe em cada semana
      Object.keys(ESTRUTURACAO_STATE).forEach(weekId => {
        const week = ESTRUTURACAO_STATE[weekId];
        if(week?.weekData){
          console.log(`[Estrutura√ß√£o] ${weekId} weekData:`, {
            note: week.weekData.note?.length || 0,
            files: week.weekData.files?.length || 0,
            checklist: week.weekData.checklist?.length || 0
          });
        }
      });
      
      // Debounce para evitar muitas chamadas
      if(estruturacaoSaveTimeout){
        clearTimeout(estruturacaoSaveTimeout);
      }
      
      estruturacaoPendingSave = true;
      
      estruturacaoSaveTimeout = setTimeout(async () => {
        if(estruturacaoIsSaving){
          console.log('[Estrutura√ß√£o] J√° est√° salvando, reagendando...');
          estruturacaoPendingSave = true;
          return;
        }
        
        estruturacaoIsSaving = true;
        showEstruturacaoSaveIndicator('saving');
        
        try{
          const dataToSave = JSON.parse(JSON.stringify(ESTRUTURACAO_STATE)); // Deep clone
          console.log('[Estrutura√ß√£o] Salvando no Firebase...', Object.keys(dataToSave).length, 'semanas');
          
          // Verificar tamanho do documento antes de salvar
          const dataSize = new Blob([JSON.stringify(dataToSave)]).size;
          console.log('[Estrutura√ß√£o] Tamanho dos dados:', dataSize, 'bytes');
          
          // SEMPRE usar subcole√ß√µes para evitar limite de 1MB do documento principal
          // O documento principal pode ter outros dados (metas, notas, leads, etc)
          console.log('[Estrutura√ß√£o] Salvando em subcole√ß√µes (estrat√©gia padr√£o)...');
          await persistEstruturacaoSplit(uid, dataToSave);
          
          estruturacaoLastSaveTime = Date.now();
          estruturacaoPendingSave = false;
          console.log('[Estrutura√ß√£o] ‚úÖ Salvo com sucesso!');
          showEstruturacaoSaveIndicator('saved');
        }catch(err){
          console.error('[Estrutura√ß√£o] ‚ùå Erro ao salvar:', err);
          console.error('[Estrutura√ß√£o] Erro detalhado:', err.message, err.code);
          
          // Se erro for de tamanho, j√° est√° usando subcole√ß√µes ent√£o √© outro problema
          showEstruturacaoSaveIndicator('error');
          
          // Tentar novamente em 3 segundos
          setTimeout(() => {
            if(estruturacaoPendingSave){
              persistEstruturacao();
            }
          }, 3000);
        } finally {
          estruturacaoIsSaving = false;
          
          // Se houve altera√ß√£o enquanto salvava, salvar novamente
          if(estruturacaoPendingSave){
            setTimeout(() => persistEstruturacao(), 500);
          }
        }
      }, 800); // Debounce de 800ms
    }
    
    // Salvar estrutura√ß√£o dividida em subcole√ß√µes (uma por semana)
    // N√ÉO remove do documento principal - mant√©m backup de seguran√ßa
    async function persistEstruturacaoSplit(uid, dataToSave){
      const batch = writeBatch(db);
      const weekIds = Object.keys(dataToSave);
      
      // Salvar cada semana em um documento separado na subcole√ß√£o
      for(const weekId of weekIds){
        const weekData = dataToSave[weekId];
        const weekDocRef = doc(db, "usuarios", uid, "estruturacao", weekId);
        batch.set(weekDocRef, weekData, { merge: true });
      }
      
      // Atualizar documento principal - apenas marca que usa subcole√ß√µes
      // N√ÉO deleta o campo estruturacao para manter backup de seguran√ßa
      const userDocRef = doc(db, "usuarios", uid);
      batch.update(userDocRef, { 
        estruturacaoUsesSubcollection: true,
        estruturacaoLastUpdate: new Date().toISOString()
        // REMOVIDO deleteField() para evitar perda de dados
      });
      
      await batch.commit();
      estruturacaoUsesSubcollection = true;
      console.log('[Estrutura√ß√£o] Salvo em', weekIds.length, 'subcole√ß√µes');
    }
    
    // Carregar estrutura√ß√£o (SEMPRE verifica subcole√ß√µes primeiro)
    async function loadEstruturacaoFromFirebase(){
      const currentUser = window.getCurrentUser();
      const uid = currentUser?.uid;
      if(!uid) return;
      
      try{
        const userDoc = await getDoc(doc(db, "usuarios", uid));
        const userData = userDoc.data() || {};
        
        let fromSubcollection = null;
        let fromPrincipal = null;
        
        // SEMPRE verificar subcole√ß√µes (estrat√©gia principal de armazenamento)
        console.log('[Estrutura√ß√£o] Verificando subcole√ß√µes...');
        const subcollectionRef = collection(db, "usuarios", uid, "estruturacao");
        const snapshot = await getDocs(subcollectionRef);
        
        const loadedState = {};
        snapshot.forEach(doc => {
          loadedState[doc.id] = doc.data();
        });
        
        if(Object.keys(loadedState).length > 0){
          fromSubcollection = loadedState;
          console.log('[Estrutura√ß√£o] Encontrado em subcole√ß√µes:', Object.keys(loadedState).length, 'semanas');
        }
        
        // Verificar documento principal (fallback/backup)
        if(userData.estruturacao && Object.keys(userData.estruturacao).length > 0){
          fromPrincipal = userData.estruturacao;
          console.log('[Estrutura√ß√£o] Encontrado em documento principal:', Object.keys(fromPrincipal).length, 'semanas');
        }
        
        // Decidir qual usar - priorizar o que tem MAIS DADOS REAIS (weekData, notas, etc)
        let useData = null;
        
        if(fromSubcollection && fromPrincipal){
          // Comparar qual tem mais conte√∫do real
          const subContentCount = countRealContent(fromSubcollection);
          const principalContentCount = countRealContent(fromPrincipal);
          
          console.log('[Estrutura√ß√£o] Conte√∫do real - Subcole√ß√µes:', subContentCount, '| Principal:', principalContentCount);
          
          if(principalContentCount > subContentCount){
            useData = fromPrincipal;
            console.log('[Estrutura√ß√£o] Usando documento principal (mais conte√∫do)');
          } else if(subContentCount > 0){
            useData = fromSubcollection;
            estruturacaoUsesSubcollection = true; // Marcar que usa subcole√ß√µes
            console.log('[Estrutura√ß√£o] Usando subcole√ß√µes (mais conte√∫do)');
          } else {
            useData = fromPrincipal;
            console.log('[Estrutura√ß√£o] Usando documento principal (fallback)');
          }
        } else if(fromSubcollection){
          useData = fromSubcollection;
          estruturacaoUsesSubcollection = true; // Marcar que usa subcole√ß√µes
          console.log('[Estrutura√ß√£o] Usando subcole√ß√µes (√∫nica fonte)');
        } else if(fromPrincipal){
          useData = fromPrincipal;
          console.log('[Estrutura√ß√£o] Usando documento principal (√∫nica fonte)');
        }
        
        // Tamb√©m marcar se o userData indica que usa subcole√ß√µes
        if(userData.estruturacaoUsesSubcollection){
          estruturacaoUsesSubcollection = true;
        }
        
        if(useData){
          ESTRUTURACAO_STATE = normalizeLoadedState(useData);
          USER_DATA.estruturacao = ESTRUTURACAO_STATE; // Sincronizar
          estruturacaoAlreadyLoaded = true; // Marcar como carregado
          console.log('[Estrutura√ß√£o] Estado carregado e normalizado:', Object.keys(ESTRUTURACAO_STATE).length, 'semanas');
          console.log('[Estrutura√ß√£o] Usando subcole√ß√µes:', estruturacaoUsesSubcollection);
          // N√ÉO chamar renderEstruturacao aqui - ser√° chamado pela fun√ß√£o que invocou
        }
      }catch(err){
        console.error('[Estrutura√ß√£o] Erro ao carregar do Firebase:', err);
      }
    }
    
    // Contar conte√∫do real (weekData, notas, checklists, etc)
    function countRealContent(stateData){
      let count = 0;
      Object.values(stateData).forEach(week => {
        if(week.weekData){
          if(week.weekData.note && week.weekData.note.trim().length > 0) count += 10;
          if(week.weekData.files && week.weekData.files.length > 0) count += week.weekData.files.length * 5;
          if(week.weekData.checklist && week.weekData.checklist.length > 0) count += week.weekData.checklist.length * 3;
        }
        if(week.blocks){
          Object.values(week.blocks).forEach(block => {
            if(block.items){
              Object.values(block.items).forEach(item => {
                if(item.note && item.note.trim().length > 0) count += 2;
                if(item.files && item.files.length > 0) count += item.files.length;
                if(item.completed) count += 1;
              });
            }
          });
        }
      });
      return count;
    }
    
    // Normalizar estado externo para garantir estrutura correta (usado no load)
    function normalizeLoadedState(state){
      const normalized = {};
      Object.keys(state).forEach(weekId => {
        const week = state[weekId] || {};
        normalized[weekId] = {
          blocks: week.blocks || {},
          weekData: {
            note: week.weekData?.note || '',
            files: week.weekData?.files || [],
            checklist: week.weekData?.checklist || []
          }
        };
        // Normalizar cada bloco
        Object.keys(normalized[weekId].blocks).forEach(blockId => {
          const block = normalized[weekId].blocks[blockId] || {};
          normalized[weekId].blocks[blockId] = {
            completed: block.completed || false,
            items: block.items || {},
            files: block.files || []
          };
        });
      });
      return normalized;
    }
    
    // For√ßa salvamento imediato (para a√ß√µes cr√≠ticas)
    async function persistEstruturacaoImmediate(){
      if(estruturacaoSaveTimeout){
        clearTimeout(estruturacaoSaveTimeout);
      }
      
      const currentUser = window.getCurrentUser();
      const uid = currentUser?.uid;
      if(!uid) return;
      
      estruturacaoIsSaving = true;
      showEstruturacaoSaveIndicator('saving');
      
      try{
        saveEstruturacaoToUserData();
        const dataToSave = JSON.parse(JSON.stringify(ESTRUTURACAO_STATE));
        
        // SEMPRE usar subcole√ß√µes para evitar limite de 1MB
        console.log('[Estrutura√ß√£o] Salvando imediatamente em subcole√ß√µes...');
        await persistEstruturacaoSplit(uid, dataToSave);
        
        estruturacaoLastSaveTime = Date.now();
        estruturacaoPendingSave = false;
        console.log('[Estrutura√ß√£o] ‚úÖ Salvo imediatamente!');
        showEstruturacaoSaveIndicator('saved');
      }catch(err){
        console.error('[Estrutura√ß√£o] ‚ùå Erro ao salvar imediatamente:', err);
        showEstruturacaoSaveIndicator('error');
      } finally {
        estruturacaoIsSaving = false;
      }
    }
    
    // Salvar antes de sair da p√°gina
    window.addEventListener('beforeunload', (e) => {
      if(estruturacaoPendingSave || estruturacaoIsSaving){
        e.preventDefault();
        e.returnValue = 'H√° altera√ß√µes n√£o salvas. Deseja realmente sair?';
        // Tentar salvar rapidamente
        persistEstruturacaoImmediate();
      }
    });

    // ===== LIMPAR TODA A ESTRUTURA√á√ÉO =====
    async function clearAllEstruturacao(){
      const currentUser = window.getCurrentUser();
      const uid = currentUser?.uid;
      
      if(!uid){
        mgToast('‚ùå Voc√™ precisa estar logado para limpar a estrutura√ß√£o.');
        return;
      }
      
      // Confirma√ß√£o de seguran√ßa
      const confirmMessage = `‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o ir√° APAGAR PERMANENTEMENTE:

‚Ä¢ Todos os dados do Contexto do Neg√≥cio
‚Ä¢ Todas as semanas do Cronograma (checklists, notas, arquivos)
‚Ä¢ Todo o progresso da estrutura√ß√£o

Esta a√ß√£o N√ÉO PODE ser desfeita!

Digite "CONFIRMAR" para prosseguir:`;
      
      const userInput = prompt(confirmMessage);
      
      if(userInput !== 'CONFIRMAR'){
        mgToast('‚ÑπÔ∏è Limpeza cancelada.');
        return;
      }
      
      // Segunda confirma√ß√£o
      if(!confirm('üö® √öLTIMA CONFIRMA√á√ÉO: Tem certeza ABSOLUTA que deseja apagar tudo?')){
        mgToast('‚ÑπÔ∏è Limpeza cancelada.');
        return;
      }
      
      try{
        mgToast('‚è≥ Limpando estrutura√ß√£o...', 'info');
        
        let deletedCount = 0;
        
        // 1. Limpar subcole√ß√£o /estruturacao
        console.log('[ClearAll] Limpando subcole√ß√£o /estruturacao...');
        const estruturacaoRef = collection(db, 'usuarios', uid, 'estruturacao');
        const snapshot = await getDocs(estruturacaoRef);
        
        console.log(`[ClearAll] Encontrados ${snapshot.size} documentos na subcole√ß√£o`);
        
        for(const docSnap of snapshot.docs){
          await deleteDoc(doc(db, 'usuarios', uid, 'estruturacao', docSnap.id));
          deletedCount++;
          console.log(`[ClearAll] ‚úì Deletado: ${docSnap.id}`);
        }
        
        // 2. Limpar campos do documento principal
        console.log('[ClearAll] Limpando campos do documento principal...');
        const userDocRef = doc(db, 'usuarios', uid);
        const userDocSnap = await getDoc(userDocRef);
        
        if(userDocSnap.exists()){
          const data = userDocSnap.data();
          const updates = {};
          
          if(data.estruturacao){
            updates.estruturacao = deleteField();
            console.log('[ClearAll] ‚úì Campo estruturacao marcado para remo√ß√£o');
          }
          
          if(data.estruturacaoUsesSubcollection){
            updates.estruturacaoUsesSubcollection = deleteField();
            console.log('[ClearAll] ‚úì Flag estruturacaoUsesSubcollection marcada para remo√ß√£o');
          }
          
          if(data.estruturacaoLastUpdate){
            updates.estruturacaoLastUpdate = deleteField();
            console.log('[ClearAll] ‚úì Campo estruturacaoLastUpdate marcado para remo√ß√£o');
          }
          
          if(Object.keys(updates).length > 0){
            await updateDoc(userDocRef, updates);
            console.log('[ClearAll] ‚úÖ Documento principal atualizado');
          }
        }
        
        // 3. Limpar estado local
        ESTRUTURACAO_STATE = {};
        estruturacaoUsesSubcollection = false;
        estruturacaoPendingSave = false;
        
        // 4. Limpar campos do formul√°rio
        const fieldsToReset = [
          'businessName', 'businessNiche', 'businessLocation', 'businessCountry',
          'businessTime', 'businessBudget', 'businessAgencyFee', 'businessTicket', 
          'businessObservations'
        ];
        
        fieldsToReset.forEach(fieldId => {
          const field = document.getElementById(fieldId);
          if(field){
            if(field.tagName === 'SELECT'){
              field.selectedIndex = 0;
            } else {
              field.value = '';
            }
          }
        });
        
        // 5. Re-renderizar a estrutura√ß√£o (mostrar√° vazio)
        renderEstruturacao();
        
        console.log('[ClearAll] ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
        console.log('[ClearAll] üìä RESUMO:');
        console.log(`[ClearAll]   ‚Ä¢ Documentos deletados: ${deletedCount}`);
        console.log('[ClearAll] ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
        console.log('[ClearAll] üéâ Limpeza conclu√≠da!');
        
        mgToast(`‚úÖ Estrutura√ß√£o limpa com sucesso! ${deletedCount} itens removidos.`, 'success');
        
      }catch(err){
        console.error('[ClearAll] Erro ao limpar:', err);
        mgToast('‚ùå Erro ao limpar estrutura√ß√£o: ' + err.message, 'error');
      }
    }

    // Expor fun√ß√£o globalmente para uso no onclick
    window.clearAllEstruturacao = clearAllEstruturacao;

    // ======== INFORMA√á√ïES DO NEG√ìCIO PARA IA ========
    // Debounce para auto-save
    let businessInfoSaveTimeout = null;
    
    // Salvar informa√ß√µes do neg√≥cio no Firebase
    async function saveBusinessInfo(showFeedback = true){
      const businessName = document.getElementById('businessName')?.value?.trim() || '';
      const businessNiche = document.getElementById('businessNiche')?.value?.trim() || '';
      const businessLocation = document.getElementById('businessLocation')?.value?.trim() || '';
      const businessCountry = document.getElementById('businessCountry')?.value?.trim() || '';
      const businessTime = document.getElementById('businessTime')?.value?.trim() || '';
      const businessBudget = document.getElementById('businessBudget')?.value?.trim() || '';
      const businessAgencyFee = document.getElementById('businessAgencyFee')?.value?.trim() || '';
      const businessTicket = document.getElementById('businessTicket')?.value?.trim() || '';
      const businessObservations = document.getElementById('businessObservations')?.value?.trim() || '';
      const statusEl = document.getElementById('businessSaveStatus');
      
      console.log('[BusinessInfo] Salvando:', { businessName, businessNiche, businessLocation, businessCountry, businessTime, businessBudget, businessAgencyFee, businessTicket, businessObservations });
      
      // Atualizar o estado da estrutura√ß√£o
      if(!ESTRUTURACAO_STATE.businessInfo) ESTRUTURACAO_STATE.businessInfo = {};
      ESTRUTURACAO_STATE.businessInfo = {
        name: businessName,
        niche: businessNiche,
        location: businessLocation,
        country: businessCountry,
        time: businessTime,
        budget: businessBudget,
        agencyFee: businessAgencyFee,
        ticket: businessTicket,
        observations: businessObservations,
        updatedAt: new Date().toISOString()
      };
      
      // Mostrar status de salvando
      if(statusEl && showFeedback){
        statusEl.textContent = 'Salvando...';
        statusEl.className = 'estruturacao-business-save-status';
      }
      
      try{
        await persistEstruturacao();
        console.log('[BusinessInfo] Salvo com sucesso no Firebase');
        if(statusEl && showFeedback){
          statusEl.textContent = '‚úì Salvo!';
          statusEl.className = 'estruturacao-business-save-status success';
          setTimeout(() => { statusEl.textContent = ''; }, 2000);
        }
      }catch(err){
        console.error('[BusinessInfo] Erro ao salvar:', err);
        if(statusEl && showFeedback){
          statusEl.textContent = '‚úó Erro';
          statusEl.className = 'estruturacao-business-save-status error';
        }
      }
    }
    
    // Auto-save ao digitar (com debounce)
    function scheduleBusinessInfoAutoSave(){
      const statusEl = document.getElementById('businessSaveStatus');
      if(businessInfoSaveTimeout) clearTimeout(businessInfoSaveTimeout);
      
      // Mostrar indicador de "digitando..."
      if(statusEl){
        statusEl.textContent = '‚Ä¢‚Ä¢‚Ä¢';
        statusEl.className = 'estruturacao-business-save-status';
        statusEl.style.opacity = '0.5';
      }
      
      businessInfoSaveTimeout = setTimeout(async () => {
        if(statusEl){
          statusEl.textContent = 'üíæ';
          statusEl.style.opacity = '1';
        }
        await saveBusinessInfo(false); // Salvar sem feedback visual excessivo
        if(statusEl){
          statusEl.textContent = '‚úì';
          statusEl.className = 'estruturacao-business-save-status success';
          setTimeout(() => { 
            statusEl.textContent = ''; 
            statusEl.style.opacity = '';
          }, 1500);
        }
      }, 1500); // Aguarda 1.5s ap√≥s parar de digitar
    }
    
    // Inicializar auto-save nos campos de neg√≥cio
    function initBusinessInfoAutoSave(){
      const fields = ['businessName', 'businessNiche', 'businessLocation', 'businessCountry', 'businessTime', 'businessBudget', 'businessAgencyFee', 'businessTicket', 'businessObservations'];
      fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if(field){
          field.addEventListener('input', scheduleBusinessInfoAutoSave);
          field.addEventListener('change', scheduleBusinessInfoAutoSave); // Para select
          field.addEventListener('blur', () => saveBusinessInfo(false)); // Salvar ao sair do campo
          
          // Auto-resize para textarea de observa√ß√µes
          if(fieldId === 'businessObservations' && field.tagName === 'TEXTAREA'){
            // Fun√ß√£o de auto-resize
            const autoResize = () => {
              field.style.height = 'auto';
              field.style.height = Math.min(field.scrollHeight, 300) + 'px';
            };
            
            // Adicionar eventos para auto-resize
            field.addEventListener('input', autoResize);
            field.addEventListener('change', autoResize);
            
            // Resize inicial
            setTimeout(autoResize, 100);
            
            console.log('[BusinessInfo] Auto-resize configurado para textarea de observa√ß√µes');
          }
        }
      });
      console.log('[BusinessInfo] Auto-save inicializado para campos:', fields);
    }
    
    // Carregar informa√ß√µes do neg√≥cio do estado
    function loadBusinessInfo(){
      const businessInfo = ESTRUTURACAO_STATE.businessInfo || {};
      console.log('[BusinessInfo] Carregando do estado:', businessInfo);
      
      const nameInput = document.getElementById('businessName');
      const nicheInput = document.getElementById('businessNiche');
      const locationInput = document.getElementById('businessLocation');
      const countrySelect = document.getElementById('businessCountry');
      const timeInput = document.getElementById('businessTime');
      const budgetInput = document.getElementById('businessBudget');
      const agencyFeeInput = document.getElementById('businessAgencyFee');
      const ticketInput = document.getElementById('businessTicket');
      const obsInput = document.getElementById('businessObservations');
      
      if(nameInput) nameInput.value = businessInfo.name || '';
      if(nicheInput) nicheInput.value = businessInfo.niche || '';
      if(locationInput) locationInput.value = businessInfo.location || '';
      if(countrySelect) countrySelect.value = businessInfo.country || '';
      if(timeInput) timeInput.value = businessInfo.time || '';
      if(budgetInput) budgetInput.value = businessInfo.budget || '';
      if(agencyFeeInput) agencyFeeInput.value = businessInfo.agencyFee || '';
      if(ticketInput) ticketInput.value = businessInfo.ticket || '';
      if(obsInput){
        obsInput.value = businessInfo.observations || '';
        // Auto-resize do textarea ap√≥s carregar o conte√∫do
        if(obsInput.tagName === 'TEXTAREA'){
          setTimeout(() => {
            obsInput.style.height = 'auto';
            obsInput.style.height = Math.min(obsInput.scrollHeight, 300) + 'px';
          }, 100);
        }
      }
      
      console.log('[BusinessInfo] Campos preenchidos:', {
        name: nameInput?.value,
        niche: nicheInput?.value,
        time: timeInput?.value,
        ticket: ticketInput?.value,
        obs: obsInput?.value
      });
    }
    
    // Obter informa√ß√µes do neg√≥cio para uso nos prompts de IA
    function getBusinessInfoForAI(){
      const businessInfo = ESTRUTURACAO_STATE.businessInfo || {};
      
      // Determinar pa√≠s/localiza√ß√£o para localiza√ß√£o de conte√∫do
      const pais = businessInfo.country || '';
      const isBrasil = pais === 'Brasil' || pais.toLowerCase().includes('brasil');
      const isEUA = pais === 'Estados Unidos (EUA)' || pais.toLowerCase().includes('eua') || pais.toLowerCase().includes('usa') || pais.toLowerCase().includes('estados unidos');
      
      // Obter data atual formatada conforme o pa√≠s
      const hoje = new Date();
      let dataFormatada = '';
      
      if(isEUA){
        const mesesEN = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        const diasSemanaEN = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        dataFormatada = `${diasSemanaEN[hoje.getDay()]}, ${mesesEN[hoje.getMonth()]} ${hoje.getDate()}, ${hoje.getFullYear()}`;
      } else {
        const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
        const diasSemana = ['Domingo', 'Segunda-feira', 'Ter√ßa-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'S√°bado'];
        dataFormatada = `${diasSemana[hoje.getDay()]}, ${hoje.getDate()} de ${meses[hoje.getMonth()]} de ${hoje.getFullYear()}`;
      }
      
      // Meses para uso posterior (baseado no pa√≠s)
      const meses = isEUA 
        ? ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']
        : ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
      
      let info = `## üè¢ INFORMA√á√ïES DO NEG√ìCIO\n\n`;
      
      // REGRAS DE LOCALIZA√á√ÉO - CR√çTICO PARA IA
      if(pais){
        info += `**üåç LOCALIZA√á√ÉO E REGRAS DE LOCALIZA√á√ÉO:**\n`;
        info += `**Pa√≠s:** ${pais}\n`;
        if(businessInfo.location){
          info += `**Endere√ßo/Cidade:** ${businessInfo.location}\n`;
        }
        info += `\n`;
        
        if(isBrasil){
          info += `**‚ö†Ô∏è REGRAS OBRIGAT√ìRIAS PARA CONTE√öDO BRASILEIRO:**\n`;
          info += `- ‚úÖ Todos os valores monet√°rios DEVEM ser em REAIS (R$)\n`;
          info += `- ‚úÖ Use nomes brasileiros para exemplos de clientes/personas (Ex: Jo√£o, Maria, Pedro, Ana, Carlos, Fernanda)\n`;
          info += `- ‚úÖ Escreva TODO o conte√∫do em Portugu√™s do Brasil\n`;
          info += `- ‚úÖ Use formata√ß√£o de n√∫mero brasileira (1.000,00)\n`;
          info += `- ‚úÖ Refer√™ncias culturais brasileiras quando aplic√°vel\n`;
          info += `- ‚úÖ Datas no formato brasileiro: DD/MM/AAAA\n`;
          info += `- ‚ùå N√ÉO use d√≥lares ($) ou nomes estrangeiros\n\n`;
        } else if(isEUA){
          info += `**‚ö†Ô∏è MANDATORY RULES FOR US CONTENT:**\n`;
          info += `- ‚úÖ All monetary values MUST be in US DOLLARS ($)\n`;
          info += `- ‚úÖ Use American names for client/persona examples (Ex: John, Sarah, Michael, Emily, David, Jennifer)\n`;
          info += `- ‚úÖ Write ALL content in American English\n`;
          info += `- ‚úÖ Use US number formatting (1,000.00)\n`;
          info += `- ‚úÖ Use American cultural references when applicable\n`;
          info += `- ‚úÖ Dates in US format: MM/DD/YYYY\n`;
          info += `- ‚ùå DO NOT use Brazilian Real (R$) or foreign names\n\n`;
        } else {
          info += `**‚ö†Ô∏è REGRAS DE LOCALIZA√á√ÉO:**\n`;
          info += `- Adapte moeda, idioma e nomes conforme a localiza√ß√£o: ${businessInfo.location || pais}\n`;
          info += `- Use refer√™ncias culturais apropriadas para a regi√£o\n\n`;
        }
      }
      
      // DATA DO PLANO - SEMPRE incluir no topo para refer√™ncia da IA (OBRIGAT√ìRIO)
      info += `**üìÖ DATA DE CRIA√á√ÉO DO PLANO:** ${dataFormatada}\n`;
      if(isEUA){
        info += `**üìÜ Numeric date:** ${(hoje.getMonth()+1).toString().padStart(2,'0')}/${hoje.getDate().toString().padStart(2,'0')}/${hoje.getFullYear()}\n\n`;
        info += `**‚ö†Ô∏è MANDATORY DATE RULE:**\n`;
        info += `All strategies, schedules, deadlines and action plans MUST be created FROM ${hoje.getMonth()+1}/${hoje.getDate()}/${hoje.getFullYear()} onwards.\n`;
      } else {
        info += `**üìÜ Data num√©rica:** ${hoje.getDate().toString().padStart(2,'0')}/${(hoje.getMonth()+1).toString().padStart(2,'0')}/${hoje.getFullYear()}\n\n`;
        info += `**‚ö†Ô∏è REGRA OBRIGAT√ìRIA DE DATAS:**\n`;
        info += `Todas as estrat√©gias, cronogramas, prazos e planos de a√ß√£o DEVEM ser criados A PARTIR de ${hoje.getDate()}/${hoje.getMonth()+1}/${hoje.getFullYear()}.\n`;
      }
      info += `- **${isEUA ? 'Immediate Actions' : 'A√ß√µes Imediatas'}:** 0-7 ${isEUA ? 'days' : 'dias'} (${isEUA ? 'until' : 'at√©'} ${new Date(hoje.getTime() + 7*24*60*60*1000).getDate()}/${new Date(hoje.getTime() + 7*24*60*60*1000).getMonth()+1})\n`;
      info += `- **${isEUA ? 'Short Term' : 'Curto Prazo'}:** 7-30 ${isEUA ? 'days' : 'dias'} (${meses[hoje.getMonth()]} ${hoje.getFullYear()})\n`;
      info += `- **${isEUA ? 'Medium Term' : 'M√©dio Prazo'}:** 30-90 ${isEUA ? 'days' : 'dias'} (${meses[(hoje.getMonth()+1)%12]}-${meses[(hoje.getMonth()+3)%12]} ${hoje.getFullYear()})\n`;
      info += `- **${isEUA ? 'Long Term' : 'Longo Prazo'}:** 90-180 ${isEUA ? 'days' : 'dias'} (${isEUA ? 'until' : 'at√©'} ${meses[(hoje.getMonth()+6)%12]} ${hoje.getMonth()+6 > 11 ? hoje.getFullYear()+1 : hoje.getFullYear()})\n`;
      info += `- **${isEUA ? 'Annual' : 'Anual'}:** ${hoje.getFullYear()}-${hoje.getFullYear()+1}\n\n`;
      
      if(businessInfo.name){
        info += `**${isEUA ? 'Business Name' : 'Nome do Neg√≥cio'}:** ${businessInfo.name}\n`;
      }
      if(businessInfo.niche){
        info += `**${isEUA ? 'Niche/Segment' : 'Nicho/Segmento'}:** ${businessInfo.niche}\n`;
      }
      if(businessInfo.time){
        info += `**${isEUA ? 'Time in Market' : 'Tempo de Mercado'}:** ${businessInfo.time}\n`;
      }
      
      // CUSTOS DE MARKETING - Informa√ß√µes para c√°lculo de CAC
      if(businessInfo.budget || businessInfo.agencyFee){
        info += `\n**üí∞ ${isEUA ? 'MARKETING COSTS (for CAC calculation)' : 'CUSTOS DE MARKETING (para c√°lculo de CAC)'}:**\n`;
        
        if(businessInfo.budget){
          info += `- **${isEUA ? 'Ad/Marketing Investment/month' : 'Investimento em An√∫ncios/Marketing/m√™s'}:** ${businessInfo.budget}\n`;
        }
        if(businessInfo.agencyFee){
          info += `- **${isEUA ? 'Agency Fee/month' : 'Valor Pago para Ag√™ncia/m√™s'}:** ${businessInfo.agencyFee}\n`;
        }
        
        // Calcular investimento total se ambos os valores existirem
        if(businessInfo.budget && businessInfo.agencyFee){
          // Extrair valores num√©ricos
          const extractNumber = (str) => {
            const match = str.replace(/\./g, '').replace(',', '.').match(/[\d.]+/);
            return match ? parseFloat(match[0]) : 0;
          };
          const budgetNum = extractNumber(businessInfo.budget);
          const agencyNum = extractNumber(businessInfo.agencyFee);
          const totalInvestimento = budgetNum + agencyNum;
          
          // Detectar moeda baseado no pa√≠s ou valor inserido
          let moeda = 'R$'; // Default para Brasil
          if(isEUA){
            moeda = '$';
          } else if(businessInfo.budget.includes('$') && !businessInfo.budget.includes('R$')){
            moeda = '$';
          }
          
          const totalFormatado = moeda === 'R$' 
            ? `R$ ${totalInvestimento.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`
            : `$ ${totalInvestimento.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
          
          info += `- **üìä ${isEUA ? 'TOTAL MARKETING INVESTMENT/month' : 'INVESTIMENTO TOTAL EM MARKETING/m√™s'}:** ${totalFormatado}\n`;
          info += `\n**‚ö†Ô∏è ${isEUA ? 'CRITICAL: CAC vs CPL DEFINITIONS' : 'CR√çTICO: DEFINI√á√ïES DE CAC vs CPL'}:**\n`;
          if(isEUA){
            info += `\nüî¥ **CAC (Customer Acquisition Cost) = Cost to acquire a PAYING CUSTOMER**\n`;
            info += `- Formula: CAC = Total Investment / Number of CUSTOMERS WHO PAID\n`;
            info += `- Example: If you spent $3,000 and got 10 paying customers ‚Üí CAC = $300/customer\n`;
            info += `- Denominator is ONLY paying customers (closed sales)\n\n`;
            info += `üîµ **CPL (Cost Per Lead) = Cost to acquire a LEAD (prospect)**\n`;
            info += `- Formula: CPL = Total Investment / Number of LEADS generated\n`;
            info += `- Example: If you spent $3,000 and got 100 leads ‚Üí CPL = $30/lead\n`;
            info += `- Denominator is ALL leads (regardless of purchase)\n\n`;
            info += `‚ö†Ô∏è **NEVER CONFUSE THESE TWO:**\n`;
            info += `- CAC is ALWAYS higher than CPL (not all leads become customers)\n`;
            info += `- If conversion rate is 10%: 100 leads ‚Üí 10 customers\n`;
            info += `  - CPL = $3,000 / 100 leads = $30/lead\n`;
            info += `  - CAC = $3,000 / 10 customers = $300/customer\n\n`;
            info += `üìê **Relationship:** CAC = CPL / Conversion Rate\n`;
            info += `- If CPL = $30 and conversion = 10% ‚Üí CAC = $30 / 0.10 = $300\n\n`;
            info += `**MANDATORY CAC CALCULATION RULE:**\n`;
            info += `When calculating CAC (Customer Acquisition Cost), ALWAYS use TOTAL INVESTMENT (${totalFormatado}), which includes:\n`;
            info += `- Ad/media investment: ${businessInfo.budget}\n`;
            info += `- Agency fee: ${businessInfo.agencyFee}\n`;
            info += `Formula: CAC = Total Investment / Number of Acquired Customers (WHO PAID)\n`;
          } else {
            info += `\nüî¥ **CAC (Custo de Aquisi√ß√£o de Cliente) = Custo para adquirir um CLIENTE PAGANTE**\n`;
            info += `- F√≥rmula: CAC = Investimento Total / N√∫mero de CLIENTES QUE PAGARAM\n`;
            info += `- Exemplo: Se investiu R$ 3.000 e fechou 10 clientes ‚Üí CAC = R$ 300/cliente\n`;
            info += `- Denominador s√£o APENAS clientes pagantes (vendas fechadas)\n\n`;
            info += `üîµ **CPL (Custo Por Lead) = Custo para adquirir um LEAD (prospecto)**\n`;
            info += `- F√≥rmula: CPL = Investimento Total / N√∫mero de LEADS gerados\n`;
            info += `- Exemplo: Se investiu R$ 3.000 e gerou 100 leads ‚Üí CPL = R$ 30/lead\n`;
            info += `- Denominador s√£o TODOS os leads (independente de comprarem)\n\n`;
            info += `‚ö†Ô∏è **NUNCA CONFUNDA ESTES DOIS:**\n`;
            info += `- CAC √© SEMPRE maior que CPL (nem todo lead vira cliente)\n`;
            info += `- Se taxa de convers√£o √© 10%: 100 leads ‚Üí 10 clientes\n`;
            info += `  - CPL = R$ 3.000 / 100 leads = R$ 30/lead\n`;
            info += `  - CAC = R$ 3.000 / 10 clientes = R$ 300/cliente\n\n`;
            info += `üìê **Rela√ß√£o:** CAC = CPL / Taxa de Convers√£o\n`;
            info += `- Se CPL = R$ 30 e convers√£o = 10% ‚Üí CAC = R$ 30 / 0,10 = R$ 300\n\n`;
            info += `**REGRA OBRIGAT√ìRIA PARA C√ÅLCULO DE CAC:**\n`;
            info += `Ao calcular CAC (Custo de Aquisi√ß√£o de Cliente), SEMPRE use o INVESTIMENTO TOTAL (${totalFormatado}), que inclui:\n`;
            info += `- Investimento em an√∫ncios/m√≠dia: ${businessInfo.budget}\n`;
            info += `- Fee da ag√™ncia: ${businessInfo.agencyFee}\n`;
            info += `F√≥rmula: CAC = Investimento Total / N√∫mero de Clientes Adquiridos (QUE PAGARAM)\n`;
          }
        }
        info += `\n`;
      }
      
      if(businessInfo.ticket){
        info += `**${isEUA ? 'Average Ticket' : 'Ticket M√©dio'}:** ${businessInfo.ticket}\n`;
      }
      if(businessInfo.observations){
        info += `**${isEUA ? 'Observations' : 'Observa√ß√µes'}:** ${businessInfo.observations}\n`;
      }
      
      info += '\n---\n\n';
      
      // SEMPRE retornar info (nunca null) para garantir que a data seja enviada
      return info;
    }
    
    // Exportar fun√ß√£o globalmente para uso em outros m√≥dulos
    window.getBusinessInfoForAI = getBusinessInfoForAI;

    // ======== SISTEMA DE LEMBRETES ========
    function getReminders(){
      // Busca todos os itens com reminded = true no state
      const reminders = [];
      ESTRUTURACAO_DATA.forEach(week => {
        week.blocks.forEach(block => {
          const blockState = ESTRUTURACAO_STATE[week.id]?.blocks?.[block.id];
          if(blockState){
            block.items.forEach((item, idx) => {
              if(blockState.items?.[idx]?.reminded){
                const itemState = blockState.items[idx];
                reminders.push({
                  weekId: week.id,
                  weekTitle: week.title,
                  blockId: block.id,
                  blockTitle: block.title,
                  itemIdx: idx,
                  itemText: item,
                  note: itemState.note || '',
                  files: itemState.files || []
                });
              }
            });
          }
        });
      });
      return reminders;
    }

    function renderReminders(){
      const container = document.getElementById('estruturacaoReminders');
      const list = document.getElementById('estruturacaoRemindersList');
      const countEl = document.getElementById('estruturacaoRemindersCount');
      if(!container || !list) return;
      
      const reminders = getReminders();
      
      if(reminders.length === 0){
        container.style.display = 'none';
        return;
      }
      
      container.style.display = 'block';
      countEl.textContent = reminders.length;
      
      list.innerHTML = reminders.map(r => {
        const notePreview = r.note ? r.note.replace(/[#*>\-]/g, '').substring(0, 80) + (r.note.length > 80 ? '...' : '') : '';
        return `
          <div class="estruturacao-reminder-item" data-week-id="${r.weekId}" data-block-id="${r.blockId}" data-item-idx="${r.itemIdx}">
            <div class="estruturacao-reminder-item-info">
              <div class="estruturacao-reminder-item-path">
                <span>${escapeHtml(r.weekTitle)}</span>
                <span>‚Üí</span>
                <span>${escapeHtml(r.blockTitle)}</span>
              </div>
              <div class="estruturacao-reminder-item-text">${escapeHtml(r.itemText)}</div>
              ${notePreview ? `<div class="estruturacao-reminder-item-note">üìù ${escapeHtml(notePreview)}</div>` : ''}
            </div>
            <div class="estruturacao-reminder-actions">
              <button class="estruturacao-reminder-btn go-to" title="Ir para o item" data-week-id="${r.weekId}" data-block-id="${r.blockId}" data-item-idx="${r.itemIdx}">üëÅÔ∏è Ver</button>
              <button class="estruturacao-reminder-btn remove" title="Remover da lista" data-week-id="${r.weekId}" data-block-id="${r.blockId}" data-item-idx="${r.itemIdx}">‚úï</button>
            </div>
          </div>
        `;
      }).join('');
      
      // Event listeners para bot√µes
      list.querySelectorAll('.go-to').forEach(btn => {
        btn.addEventListener('click', function(){
          const wId = this.dataset.weekId;
          const bId = this.dataset.blockId;
          const iIdx = parseInt(this.dataset.itemIdx);
          goToReminderItem(wId, bId, iIdx);
        });
      });
      
      list.querySelectorAll('.remove').forEach(btn => {
        btn.addEventListener('click', function(){
          const wId = this.dataset.weekId;
          const bId = this.dataset.blockId;
          const iIdx = parseInt(this.dataset.itemIdx);
          removeReminder(wId, bId, iIdx);
        });
      });
    }

    function goToReminderItem(weekId, blockId, itemIdx){
      // Abre a semana e o bloco onde o item est√°
      const weekEl = document.querySelector(`.estruturacao-week[data-week-id="${weekId}"]`);
      if(!weekEl) return;
      
      // Abre a semana
      if(!weekEl.classList.contains('open')){
        weekEl.classList.add('open');
      }
      
      // Abre o bloco
      const blockEl = weekEl.querySelector(`.estruturacao-block[data-block-id="${blockId}"]`);
      if(blockEl && !blockEl.classList.contains('open')){
        blockEl.classList.add('open');
      }
      
      // Encontra o item usando os data attributes corretos
      const itemEl = document.querySelector(`.estruturacao-item[data-week-id="${weekId}"][data-block-id="${blockId}"][data-item-idx="${itemIdx}"]`);
      if(itemEl){
        if(!itemEl.classList.contains('open')){
          itemEl.classList.add('open');
        }
        // Scroll para o item com delay para aguardar abertura dos containers
        setTimeout(() => {
          itemEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
          // Highlight tempor√°rio amarelo pulsante
          itemEl.style.boxShadow = '0 0 0 3px rgba(255,193,7,.7)';
          itemEl.style.transition = 'box-shadow 0.3s ease';
          setTimeout(() => {
            itemEl.style.boxShadow = '0 0 0 5px rgba(255,193,7,.4)';
            setTimeout(() => {
              itemEl.style.boxShadow = '';
            }, 1500);
          }, 300);
        }, 200);
      }
    }

    function toggleReminder(weekId, blockId, itemIdx){
      if(!ESTRUTURACAO_STATE[weekId]) ESTRUTURACAO_STATE[weekId] = { blocks: {} };
      if(!ESTRUTURACAO_STATE[weekId].blocks[blockId]) ESTRUTURACAO_STATE[weekId].blocks[blockId] = { items: {} };
      if(!ESTRUTURACAO_STATE[weekId].blocks[blockId].items[itemIdx]) ESTRUTURACAO_STATE[weekId].blocks[blockId].items[itemIdx] = {};
      
      const itemState = ESTRUTURACAO_STATE[weekId].blocks[blockId].items[itemIdx];
      itemState.reminded = !itemState.reminded;
      
      // Atualiza o bot√£o no item
      const btn = document.querySelector(`.estruturacao-item-remind[data-week-id="${weekId}"][data-block-id="${blockId}"][data-item-idx="${itemIdx}"]`);
      if(btn){
        btn.classList.toggle('active', itemState.reminded);
      }
      
      renderReminders();
      persistEstruturacao();
    }

    function removeReminder(weekId, blockId, itemIdx){
      if(ESTRUTURACAO_STATE[weekId]?.blocks?.[blockId]?.items?.[itemIdx]){
        ESTRUTURACAO_STATE[weekId].blocks[blockId].items[itemIdx].reminded = false;
      }
      
      // Atualiza o bot√£o no item
      const btn = document.querySelector(`.estruturacao-item-remind[data-week-id="${weekId}"][data-block-id="${blockId}"][data-item-idx="${itemIdx}"]`);
      if(btn){
        btn.classList.remove('active');
      }
      
      renderReminders();
      persistEstruturacao();
    }
    // ======== FIM SISTEMA DE LEMBRETES ========

    // ======== SISTEMA DE GALERIA DE M√çDIA ========
    let currentGalleryType = null; // 'images', 'videos' ou 'documents'
    
    function getAllMediaFiles(){
      const images = [];
      const videos = [];
      const documents = [];
      
      ESTRUTURACAO_DATA.forEach(week => {
        week.blocks.forEach(block => {
          const blockState = ESTRUTURACAO_STATE[week.id]?.blocks?.[block.id];
          if(blockState){
            block.items.forEach((item, idx) => {
              const itemState = blockState.items?.[idx];
              if(itemState?.files && itemState.files.length > 0){
                itemState.files.forEach(file => {
                  const fileInfo = {
                    url: file.url || file,
                    name: file.name || 'Arquivo',
                    type: file.type || '',
                    size: file.size || 0,
                    weekId: week.id,
                    weekTitle: week.title,
                    blockId: block.id,
                    blockTitle: block.title,
                    itemIdx: idx,
                    itemText: item
                  };
                  
                  // Detectar tipo pelo nome, URL ou type
                  const isImage = /\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(fileInfo.url) || 
                                  /\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(fileInfo.name) ||
                                  fileInfo.type.startsWith('image/');
                  const isVideo = /\.(mp4|webm|mov|avi|mkv|m4v)$/i.test(fileInfo.url) || 
                                  /\.(mp4|webm|mov|avi|mkv|m4v)$/i.test(fileInfo.name) ||
                                  fileInfo.type.startsWith('video/');
                  const isDocument = /\.(pdf|doc|docx|xls|xlsx|ppt|pptx|txt|rtf|odt|ods|odp|csv|zip|rar|7z)$/i.test(fileInfo.url) || 
                                     /\.(pdf|doc|docx|xls|xlsx|ppt|pptx|txt|rtf|odt|ods|odp|csv|zip|rar|7z)$/i.test(fileInfo.name) ||
                                     fileInfo.type.startsWith('application/');
                  
                  if(isImage){
                    images.push(fileInfo);
                  } else if(isVideo){
                    videos.push(fileInfo);
                  } else if(isDocument || (!isImage && !isVideo)){
                    // Se n√£o √© imagem nem v√≠deo, considera como documento
                    documents.push(fileInfo);
                  }
                });
              }
            });
          }
          
          // Tamb√©m verificar arquivos em n√≠vel de semana (se existir)
          const weekState = ESTRUTURACAO_STATE[week.id];
          if(weekState?.files && weekState.files.length > 0){
            weekState.files.forEach(file => {
              const fileInfo = {
                url: file.url || file,
                name: file.name || 'Arquivo',
                type: file.type || '',
                size: file.size || 0,
                weekId: week.id,
                weekTitle: week.title,
                blockId: null,
                blockTitle: 'Arquivos da Semana',
                itemIdx: null,
                itemText: null
              };
              
              const isImage = /\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(fileInfo.url) || 
                              /\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(fileInfo.name) ||
                              fileInfo.type.startsWith('image/');
              const isVideo = /\.(mp4|webm|mov|avi|mkv|m4v)$/i.test(fileInfo.url) || 
                              /\.(mp4|webm|mov|avi|mkv|m4v)$/i.test(fileInfo.name) ||
                              fileInfo.type.startsWith('video/');
              const isDocument = /\.(pdf|doc|docx|xls|xlsx|ppt|pptx|txt|rtf|odt|ods|odp|csv|zip|rar|7z)$/i.test(fileInfo.url) || 
                                 /\.(pdf|doc|docx|xls|xlsx|ppt|pptx|txt|rtf|odt|ods|odp|csv|zip|rar|7z)$/i.test(fileInfo.name) ||
                                 fileInfo.type.startsWith('application/');
              
              if(isImage){
                images.push(fileInfo);
              } else if(isVideo){
                videos.push(fileInfo);
              } else if(isDocument || (!isImage && !isVideo)){
                documents.push(fileInfo);
              }
            });
          }
        });
      });
      
      return { images, videos, documents };
    }
    
    // Fun√ß√£o para obter √≠cone do tipo de arquivo
    function getDocumentIcon(fileName, fileType){
      const ext = (fileName || '').split('.').pop().toLowerCase();
      const icons = {
        'pdf': 'üìÑ',
        'doc': 'üìù', 'docx': 'üìù',
        'xls': 'üìä', 'xlsx': 'üìä',
        'ppt': 'üìΩÔ∏è', 'pptx': 'üìΩÔ∏è',
        'txt': 'üìÉ', 'rtf': 'üìÉ',
        'csv': 'üìà',
        'zip': 'üì¶', 'rar': 'üì¶', '7z': 'üì¶',
        'odt': 'üìù', 'ods': 'üìä', 'odp': 'üìΩÔ∏è'
      };
      return icons[ext] || 'üìé';
    }
    
    // Fun√ß√£o para formatar tamanho de arquivo
    function formatDocSize(bytes){
      if(!bytes || bytes === 0) return '';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }
    
    function updateMediaFilterCounts(){
      const { images, videos, documents } = getAllMediaFiles();
      document.getElementById('filterImagesCount').textContent = images.length;
      document.getElementById('filterVideosCount').textContent = videos.length;
      const docsCount = document.getElementById('filterDocumentsCount');
      if(docsCount) docsCount.textContent = documents.length;
    }
    
    function openMediaGallery(type){
      currentGalleryType = type;
      const gallery = document.getElementById('estruturacaoMediaGallery');
      const grid = document.getElementById('estruturacaoMediaGalleryGrid');
      const title = document.getElementById('galleryTitle');
      const icon = document.getElementById('galleryIcon');
      const filterImgBtn = document.getElementById('filterImagesBtn');
      const filterVidBtn = document.getElementById('filterVideosBtn');
      const filterDocsBtn = document.getElementById('filterDocumentsBtn');
      
      // Atualizar bot√µes ativos
      filterImgBtn.classList.toggle('active', type === 'images');
      filterVidBtn.classList.toggle('active', type === 'videos');
      if(filterDocsBtn) filterDocsBtn.classList.toggle('active', type === 'documents');
      
      // Atualizar t√≠tulo e √≠cone
      if(type === 'images'){
        title.textContent = 'Galeria de Imagens';
        icon.textContent = 'üñºÔ∏è';
      } else if(type === 'videos'){
        title.textContent = 'Galeria de V√≠deos';
        icon.textContent = 'üé¨';
      } else {
        title.textContent = 'Galeria de Arquivos';
        icon.textContent = 'üìÅ';
      }
      
      const { images, videos, documents } = getAllMediaFiles();
      const files = type === 'images' ? images : (type === 'videos' ? videos : documents);
      
      if(files.length === 0){
        const emptyIcon = type === 'images' ? 'üñºÔ∏è' : (type === 'videos' ? 'üé¨' : 'üìÅ');
        const emptyText = type === 'images' ? 'Nenhuma imagem salva' : (type === 'videos' ? 'Nenhum v√≠deo salvo' : 'Nenhum arquivo salvo');
        grid.innerHTML = `
          <div class="estruturacao-media-gallery-empty" style="grid-column: 1/-1">
            <div class="empty-icon">${emptyIcon}</div>
            <p>${emptyText} nos checklists.</p>
          </div>
        `;
      } else {
        // Agrupar arquivos pelo mesmo item de checklist
        const groups = new Map();
        files.forEach((file, idx) => {
          const groupKey = `${file.weekId}|${file.blockId}|${file.itemIdx}`;
          if(!groups.has(groupKey)){
            groups.set(groupKey, {
              weekId: file.weekId,
              weekTitle: file.weekTitle,
              blockId: file.blockId,
              blockTitle: file.blockTitle,
              itemIdx: file.itemIdx,
              itemText: file.itemText,
              files: []
            });
          }
          groups.get(groupKey).files.push({ ...file, globalIdx: idx });
        });
        
        // Renderizar com agrupamento visual
        let html = '';
        const typeLabel = type === 'images' ? 'imagens' : (type === 'videos' ? 'v√≠deos' : 'arquivos');
        groups.forEach((group, groupKey) => {
          const hasMultiple = group.files.length > 1;
          
          if(hasMultiple){
            // Grupo com header
            html += `
              <div class="estruturacao-media-gallery-group" data-group-key="${groupKey}">
                <div class="estruturacao-media-gallery-group-header">
                  <div class="estruturacao-media-gallery-group-title">
                    <span class="group-icon">üìå</span>
                    ${group.itemText ? group.itemText.substring(0, 50) + (group.itemText.length > 50 ? '...' : '') : 'Item'}
                  </div>
                  <div class="estruturacao-media-gallery-group-meta">
                    <span>üìÖ ${group.weekTitle}</span>
                    <span>üìÅ ${group.blockTitle}</span>
                  </div>
                  <span class="estruturacao-media-gallery-group-count">${group.files.length} ${typeLabel}</span>
                  <button class="estruturacao-media-gallery-group-goto" data-week-id="${group.weekId}" data-block-id="${group.blockId}" data-item-idx="${group.itemIdx}" title="Ir para o checklist">
                    üìç Ir para item
                  </button>
                </div>
                <div class="estruturacao-media-gallery-group-items">
            `;
            
            group.files.forEach((file) => {
              html += renderGalleryItem(file, file.globalIdx, type, true);
            });
            
            html += `
                </div>
              </div>
            `;
          } else {
            // Item √∫nico sem agrupamento especial
            const file = group.files[0];
            html += renderGalleryItem(file, file.globalIdx, type, false);
          }
        });
        
        grid.innerHTML = html;
        
        // Fun√ß√£o auxiliar para renderizar item individual
        function renderGalleryItem(file, idx, itemType, isGrouped){
          let previewContent = '';
          
          if(itemType === 'images'){
            previewContent = `<img src="${file.url}" alt="${file.name}" loading="lazy" onerror="this.parentElement.innerHTML='<div style=\\'padding:20px;color:rgba(255,255,255,.4);text-align:center\\'>üñºÔ∏è Erro ao carregar</div>'">`;
          } else if(itemType === 'videos'){
            previewContent = `<video src="${file.url}" preload="metadata" muted></video>
                              <div class="video-overlay">‚ñ∂</div>`;
          } else {
            // Documento
            const docIcon = getDocumentIcon(file.name, file.type);
            const ext = (file.name || '').split('.').pop().toUpperCase();
            const sizeText = formatDocSize(file.size);
            previewContent = `
              <div class="document-preview-icon">
                <span class="doc-icon">${docIcon}</span>
                <span class="doc-ext">${ext}</span>
                ${sizeText ? `<span class="doc-size">${sizeText}</span>` : ''}
              </div>
            `;
          }
          
          return `
            <div class="estruturacao-media-gallery-item${isGrouped ? ' grouped' : ''}${itemType === 'documents' ? ' is-document' : ''}" data-idx="${idx}" data-type="${itemType}" data-week-id="${file.weekId}" data-block-id="${file.blockId}" data-item-idx="${file.itemIdx}" data-url="${file.url}" data-name="${file.name}">
              <div class="estruturacao-media-gallery-preview" data-action="lightbox">
                ${previewContent}
              </div>
              <div class="estruturacao-media-gallery-info">
                <div class="estruturacao-media-gallery-name" title="${file.name}">${file.name}</div>
                <div class="estruturacao-media-gallery-location">
                  <span><span class="loc-icon">üìÖ</span> ${file.weekTitle}</span>
                  <span><span class="loc-icon">üìÅ</span> ${file.blockTitle}</span>
                  ${file.itemText ? `<span><span class="loc-icon">üìå</span> ${file.itemText.substring(0, 40)}${file.itemText.length > 40 ? '...' : ''}</span>` : ''}
                </div>
                ${file.itemIdx !== null ? `
                <div class="estruturacao-media-gallery-actions">
                  <button class="estruturacao-media-gallery-goto" data-action="goto" title="Ir para o checklist">
                    <span>üìç</span> Ir para item
                  </button>
                </div>
                ` : ''}
              </div>
            </div>
          `;
        }
        
        // Adicionar event listeners para abrir lightbox (clique na preview)
        grid.querySelectorAll('.estruturacao-media-gallery-preview').forEach(preview => {
          preview.addEventListener('click', (e) => {
            e.stopPropagation();
            const item = preview.closest('.estruturacao-media-gallery-item');
            const idx = parseInt(item.dataset.idx);
            const mediaType = item.dataset.type;
            openLightbox(files[idx], mediaType, files, idx);
          });
        });
        
        // Adicionar event listeners para navega√ß√£o (bot√£o "Ir para item" em itens individuais)
        grid.querySelectorAll('.estruturacao-media-gallery-goto').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const item = btn.closest('.estruturacao-media-gallery-item');
            const weekId = item.dataset.weekId;
            const blockId = item.dataset.blockId;
            const itemIdx = parseInt(item.dataset.itemIdx);
            
            closeMediaGallery();
            setTimeout(() => {
              goToReminderItem(weekId, blockId, itemIdx);
            }, 100);
          });
        });
        
        // Adicionar event listeners para navega√ß√£o (bot√£o "Ir para item" em headers de grupo)
        grid.querySelectorAll('.estruturacao-media-gallery-group-goto').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const weekId = btn.dataset.weekId;
            const blockId = btn.dataset.blockId;
            const itemIdx = parseInt(btn.dataset.itemIdx);
            
            closeMediaGallery();
            setTimeout(() => {
              goToReminderItem(weekId, blockId, itemIdx);
            }, 100);
          });
        });
      }
      
      gallery.classList.add('active');
      gallery.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    function closeMediaGallery(){
      const gallery = document.getElementById('estruturacaoMediaGallery');
      gallery.classList.remove('active');
      document.getElementById('filterImagesBtn').classList.remove('active');
      document.getElementById('filterVideosBtn').classList.remove('active');
      document.getElementById('filterDocumentsBtn')?.classList.remove('active');
      currentGalleryType = null;
    }
    
    // Vari√°veis para navega√ß√£o do lightbox
    let lightboxFiles = [];
    let lightboxCurrentIndex = 0;
    let lightboxType = null;
    
    function openLightbox(file, type, filesArray, currentIndex){
      const lightbox = document.getElementById('estruturacaoLightbox');
      const content = document.getElementById('estruturacaoLightboxContent');
      const info = document.getElementById('estruturacaoLightboxInfo');
      
      // Salvar refer√™ncias para navega√ß√£o
      if(filesArray){
        lightboxFiles = filesArray;
        lightboxCurrentIndex = currentIndex;
      }
      lightboxType = type;
      
      // Renderizar conte√∫do
      renderLightboxContent(file, type);
      
      lightbox.classList.add('active');
      
      // Bind eventos - usar capture:true para interceptar antes de outros handlers
      document.addEventListener('keydown', handleLightboxKeydown, true);
    }
    
    async function renderLightboxContent(file, type){
      const content = document.getElementById('estruturacaoLightboxContent');
      const info = document.getElementById('estruturacaoLightboxInfo');
      
      // Parar v√≠deo anterior se existir
      const oldVideo = content.querySelector('video');
      if(oldVideo) oldVideo.pause();
      
      // Limpar formul√°rio anterior imediatamente para evitar estado residual
      content.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:200px;color:#fff;">‚è≥ Carregando...</div>';
      
      const hasPrev = lightboxCurrentIndex > 0;
      const hasNext = lightboxCurrentIndex < lightboxFiles.length - 1;
      const counter = lightboxFiles.length > 1 ? `<span class="estruturacao-lightbox-counter">${lightboxCurrentIndex + 1} / ${lightboxFiles.length}</span>` : '';
      
      console.log('[Lightbox] Renderizando m√≠dia:', lightboxCurrentIndex + 1, '/', lightboxFiles.length);
      console.log('[Lightbox] URL da m√≠dia:', file.url);
      console.log('[Lightbox] FileInfo:', file);
      
      // Buscar metadados existentes para ESTA m√≠dia espec√≠fica (passando file inteiro como contexto)
      const metadados = await buscarMetadadosMidiaZoom(file.url, file);
      
      // Gerar HTML das tags - usando a lista global ENTREGAVEIS_TAGS
      const TAGS_LIST = window.ENTREGAVEIS_TAGS || [
        'Diagn√≥stico Estrat√©gico Completo',
        'Direcionamento Estrat√©gico e Metas',
        'An√°lise de Concorr√™ncia e Mercado',
        'Matriz CDT - Caracter√≠sticas, Dores e Transforma√ß√µes',
        'PUV - Proposta √önica de Valor',
        'PAI - P√∫blico Alvo Ideal',
        'Estrutura√ß√£o de An√∫ncios Pagos',
        'Estrutura√ß√£o Site & SEO',
        'Estrat√©gias para Redes Sociais',
        'Copywriting Estrat√©gico',
        'Produ√ß√£o de Conte√∫do Guiada',
        'Criativos para An√∫ncios Patrocinados',
        'CRM e Automa√ß√µes',
        'Estrutura√ß√£o do Processo Comercial',
        'Landing Pages Estrat√©gicas',
        'Constru√ß√£o ou Atualiza√ß√£o de Website',
        'Padroniza√ß√£o Visual e de Comunica√ß√£o',
        'Plataforma Mediagrowth'
      ];
      
      const tagsHtml = TAGS_LIST.map(tag => {
        const isSelected = metadados?.tags?.includes(tag) || false;
        return `
          <label class="lightbox-tag-option ${isSelected ? 'selected' : ''}" data-tag-value="${tag}">
            <input type="checkbox" value="${tag}" ${isSelected ? 'checked' : ''} style="display:none;">
            <span>${tag}</span>
          </label>
        `;
      }).join('');
      
      // Gerar sidebar de tags
      const sidebarHtml = `
        <div class="lightbox-sidebar" id="lightboxSidebar">
          <h3 class="lightbox-sidebar-title">üè∑Ô∏è Vincular a Entreg√°veis</h3>
          
          <div class="lightbox-sidebar-section">
            <label class="lightbox-sidebar-label">üìù Descri√ß√£o breve:</label>
            <textarea 
              id="lightboxMidiaDescricao" 
              class="lightbox-sidebar-textarea"
              placeholder="Ex: Print do dashboard mostrando resultados..."
            >${metadados?.descricao || ''}</textarea>
          </div>
          
          <div class="lightbox-sidebar-section">
            <label class="lightbox-sidebar-label">üè∑Ô∏è Tags:</label>
            <div id="lightboxTagsContainer" class="lightbox-tags-container">
              ${tagsHtml}
            </div>
          </div>
          
          <div class="lightbox-sidebar-actions">
            <button class="lightbox-save-btn" id="lightboxSaveBtn">
              üíæ Salvar Tags
            </button>
          </div>
        </div>
      `;
      
      let mediaHtml = '';
      if(type === 'images'){
        mediaHtml = `<img src="${file.url}" alt="${file.name}">`;
      } else if(type === 'videos'){
        mediaHtml = `<video src="${file.url}" controls autoplay></video>`;
      } else {
        // Documento - mostrar preview ou link para download
        const docIcon = getDocumentIcon(file.name, file.type);
        const ext = (file.name || '').split('.').pop().toLowerCase();
        const sizeText = formatDocSize(file.size);
        const isPDF = ext === 'pdf';
        
        mediaHtml = `
          <div class="estruturacao-lightbox-document">
            ${isPDF ? `
              <iframe src="${file.url}" class="document-iframe-preview" title="${file.name}"></iframe>
            ` : `
              <div class="document-preview-large">
                <span class="doc-icon-large">${docIcon}</span>
                <div class="doc-name-large">${file.name}</div>
                ${sizeText ? `<div class="doc-size-large">${sizeText}</div>` : ''}
                <div class="doc-actions-large">
                  <a href="${file.url}" target="_blank" rel="noopener noreferrer" class="doc-btn-open">
                    üîó Abrir em nova aba
                  </a>
                  <a href="${file.url}" download="${file.name}" class="doc-btn-download">
                    ‚¨áÔ∏è Baixar arquivo
                  </a>
                </div>
              </div>
            `}
          </div>
        `;
      }
      
      content.innerHTML = `
        ${counter}
        <button class="estruturacao-lightbox-close" id="closeLightboxBtn" title="Fechar">‚úï</button>
        <div class="lightbox-layout">
          <div class="lightbox-media">
            ${mediaHtml}
          </div>
          ${sidebarHtml}
        </div>
      `;
      
      // Adicionar bot√µes de navega√ß√£o ao lightbox (fora do content)
      const lightbox = document.getElementById('estruturacaoLightbox');
      
      // Remover bot√µes antigos
      lightbox.querySelectorAll('.estruturacao-lightbox-nav').forEach(btn => btn.remove());
      
      // Adicionar bot√µes de navega√ß√£o se houver mais de um arquivo
      if(lightboxFiles.length > 1){
        const prevBtn = document.createElement('button');
        prevBtn.className = 'estruturacao-lightbox-nav prev';
        prevBtn.innerHTML = '‚ùÆ';
        prevBtn.title = 'Anterior (‚Üê)';
        prevBtn.disabled = !hasPrev;
        prevBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          navigateLightbox(-1);
        });
        
        const nextBtn = document.createElement('button');
        nextBtn.className = 'estruturacao-lightbox-nav next';
        nextBtn.innerHTML = '‚ùØ';
        nextBtn.title = 'Pr√≥ximo (‚Üí)';
        nextBtn.disabled = !hasNext;
        nextBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          navigateLightbox(1);
        });
        
        lightbox.appendChild(prevBtn);
        lightbox.appendChild(nextBtn);
      }
      
      // Info
      info.innerHTML = `<strong>${file.name}</strong> ‚Ä¢ ${file.weekTitle} ‚Üí ${file.blockTitle}`;
      
      // Re-bind evento do bot√£o fechar
      document.getElementById('closeLightboxBtn').addEventListener('click', closeLightbox);
      
      // Bind evento do bot√£o salvar tags
      const saveBtn = document.getElementById('lightboxSaveBtn');
      if(saveBtn){
        saveBtn.addEventListener('click', async (e) => {
          e.stopPropagation();
          // Passar file completo para garantir ID √∫nico
          await salvarMetadadosLightbox(file.url, type === 'videos', file);
        });
      }
      
      // Bind evento dos tag labels do lightbox
      const tagLabels = content.querySelectorAll('.lightbox-tag-option');
      tagLabels.forEach(label => {
        label.addEventListener('click', (e) => {
          e.stopPropagation();
          e.preventDefault();
          label.classList.toggle('selected');
          const checkbox = label.querySelector('input[type="checkbox"]');
          if(checkbox) checkbox.checked = !checkbox.checked;
        });
      });
      
      // Fechar ao clicar fora (no background)
      lightbox.onclick = (e) => {
        if(e.target === lightbox){
          closeLightbox();
        }
      };
    }
    
    // Fun√ß√£o para salvar metadados do lightbox
    async function salvarMetadadosLightbox(url, isVideo, fileInfo = null) {
      const descricaoEl = document.getElementById('lightboxMidiaDescricao');
      const tagsContainer = document.getElementById('lightboxTagsContainer');
      
      if (!descricaoEl || !tagsContainer) {
        console.error('Formul√°rio n√£o encontrado');
        return;
      }
      
      const descricao = descricaoEl.value.trim();
      const checkboxes = tagsContainer.querySelectorAll('input[type="checkbox"]:checked');
      const tags = Array.from(checkboxes).map(cb => cb.value);
      
      const user = auth?.currentUser;
      if (!user || !db) {
        alert('Erro: Usu√°rio n√£o autenticado');
        return;
      }
      
      const uid = user.uid;
      const saveBtn = document.getElementById('lightboxSaveBtn');
      
      try {
        if(saveBtn) saveBtn.textContent = '‚è≥ Salvando...';
        
        const metadados = {
          url,
          isVideo: isVideo || false,
          descricao,
          tags,
          fileInfo: fileInfo || null,
          updatedAt: new Date().toISOString(),
          updatedBy: user.email
        };
        
        // Usar ID √∫nico baseado na URL e contexto do arquivo
        const midiaId = gerarMidiaId(url, fileInfo);
        console.log('[Lightbox] Salvando com ID:', midiaId);
        
        const metadadosRef = doc(db, 'usuarios', uid, 'midias_metadados', midiaId);
        await setDoc(metadadosRef, metadados, { merge: true });
        
        console.log('‚úÖ Metadados salvos:', metadados);
        
        if(saveBtn) saveBtn.textContent = '‚úÖ Salvo!';
        setTimeout(() => {
          if(saveBtn) saveBtn.textContent = 'üíæ Salvar Tags';
        }, 2000);
        
        // Mostrar feedback
        if (typeof mgToast === 'function') {
          mgToast('‚úÖ Tags salvas com sucesso!');
        }
        
      } catch (error) {
        console.error('Erro ao salvar metadados:', error);
        if(saveBtn) saveBtn.textContent = '‚ùå Erro';
        setTimeout(() => {
          if(saveBtn) saveBtn.textContent = 'üíæ Salvar Tags';
        }, 2000);
      }
    }
    
    function navigateLightbox(direction){
      const newIndex = lightboxCurrentIndex + direction;
      
      if(newIndex >= 0 && newIndex < lightboxFiles.length){
        lightboxCurrentIndex = newIndex;
        const file = lightboxFiles[newIndex];
        renderLightboxContent(file, lightboxType);
      }
    }
    
    function closeLightbox(){
      const lightbox = document.getElementById('estruturacaoLightbox');
      lightbox.classList.remove('active');
      
      // Parar v√≠deo se estiver tocando
      const video = lightbox.querySelector('video');
      if(video){
        video.pause();
      }
      
      // Remover bot√µes de navega√ß√£o
      lightbox.querySelectorAll('.estruturacao-lightbox-nav').forEach(btn => btn.remove());
      
      // Limpar refer√™ncias
      lightboxFiles = [];
      lightboxCurrentIndex = 0;
      lightboxType = null;
      
      document.removeEventListener('keydown', handleLightboxKeydown, true);
    }
    
    function handleLightboxKeydown(e){
      // Verificar se o lightbox est√° ativo
      const lightbox = document.getElementById('estruturacaoLightbox');
      if(!lightbox || !lightbox.classList.contains('active')) return;
      
      if(e.key === 'Escape'){
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        closeLightbox();
      } else if(e.key === 'ArrowLeft'){
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        navigateLightbox(-1);
      } else if(e.key === 'ArrowRight'){
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        navigateLightbox(1);
      }
    }
    
    function initMediaGalleryEvents(){
      // Bot√£o de filtro de imagens
      document.getElementById('filterImagesBtn')?.addEventListener('click', () => {
        if(currentGalleryType === 'images'){
          closeMediaGallery();
        } else {
          openMediaGallery('images');
        }
      });
      
      // Bot√£o de filtro de v√≠deos
      document.getElementById('filterVideosBtn')?.addEventListener('click', () => {
        if(currentGalleryType === 'videos'){
          closeMediaGallery();
        } else {
          openMediaGallery('videos');
        }
      });
      
      // Bot√£o de filtro de documentos
      document.getElementById('filterDocumentsBtn')?.addEventListener('click', () => {
        if(currentGalleryType === 'documents'){
          closeMediaGallery();
        } else {
          openMediaGallery('documents');
        }
      });
      
      // Bot√£o de fechar galeria
      document.getElementById('closeGalleryBtn')?.addEventListener('click', closeMediaGallery);
      
      // Bot√£o de fechar lightbox
      document.getElementById('closeLightboxBtn')?.addEventListener('click', closeLightbox);
    }
    // ======== FIM SISTEMA DE GALERIA DE M√çDIA ========

    function calculateProgress(){
      let total = 0;
      let completed = 0;
      
      ESTRUTURACAO_DATA.forEach(week => {
        week.blocks.forEach(block => {
          total += block.items.length;
          const blockState = ESTRUTURACAO_STATE[week.id]?.blocks?.[block.id];
          if(blockState){
            block.items.forEach((_, idx) => {
              if(blockState.items?.[idx]?.completed) completed++;
            });
          }
        });
      });
      
      return { total, completed, percentage: total > 0 ? Math.round((completed / total) * 100) : 0 };
    }

    // Fun√ß√£o para alternar valores entre Brasil e USA na se√ß√£o de entreg√°veis
    function toggleEntregaveisCountry(country){
      const valorOriginal = document.getElementById('entregaveisValorOriginal');
      const valorFinal = document.getElementById('entregaveisValorFinal');
      const valorParcelado = document.getElementById('entregaveisValorParcelado');
      const btns = document.querySelectorAll('.entregaveis-country-btn');
      
      btns.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.country === country);
      });
      
      // Atualizar valores dos cards
      const cards = document.querySelectorAll('.entregavel-value');
      
      if(country === 'US'){
        if(valorOriginal) valorOriginal.textContent = '$ 3,495';
        if(valorFinal) valorFinal.textContent = '$ 1,000';
        if(valorParcelado) valorParcelado.textContent = 'or 5x of $ 200.00';
        
        // Atualizar valores individuais dos cards para USD (18 entreg√°veis)
        const valoresUSD = [
          '$ 200', '$ 200', '$ 200', '$ 150', '$ 150', '$ 200',   // 1-6
          '$ 140', '$ 300', '$ 105', '$ 120', '$ 200', '$ 140', // 7-12
          '$ 190', '$ 200', '$ 350', '$ 400', '$ 250', '$ 40'  // 13-18
        ];
        cards.forEach((card, idx) => {
          if(valoresUSD[idx]) card.textContent = 'Value: ' + valoresUSD[idx];
        });
      } else {
        if(valorOriginal) valorOriginal.textContent = 'R$ 17.672';
        if(valorFinal) valorFinal.textContent = 'R$ 5.000';
        if(valorParcelado) valorParcelado.textContent = 'ou 5x de R$ 1.000,00';
        
        // Atualizar valores individuais dos cards para BRL (18 entreg√°veis)
        const valoresBRL = [
          'R$ 1.000', 'R$ 1.000', 'R$ 1.000', 'R$ 750', 'R$ 750', 'R$ 1.000',  // 1-6
          'R$ 700', 'R$ 1.500', 'R$ 525', 'R$ 600', 'R$ 1.000', 'R$ 700',  // 7-12
          'R$ 950', 'R$ 1.000', 'R$ 1.750', 'R$ 2.000', 'R$ 1.250', 'R$ 197'  // 13-18
        ];
        cards.forEach((card, idx) => {
          if(valoresBRL[idx]) card.textContent = 'Valor: ' + valoresBRL[idx];
        });
      }
    }
    window.toggleEntregaveisCountry = toggleEntregaveisCountry;

    // ===== TOAST NOTIFICATION =====
    function showToast(message, type = 'info') {
      // Remove toast existente
      const existingToast = document.querySelector('.doc-toast');
      if (existingToast) existingToast.remove();

      const toast = document.createElement('div');
      toast.className = 'doc-toast';
      toast.style.cssText = `
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        padding: 14px 24px;
        border-radius: 10px;
        font-size: .9rem;
        font-weight: 700;
        z-index: 9999999;
        animation: toastIn 0.3s ease;
        ${type === 'success' ? 'background: linear-gradient(135deg, #00c853, #1b5e20); color: #fff;' : ''}
        ${type === 'error' ? 'background: linear-gradient(135deg, #ff6b6b, #c0392b); color: #fff;' : ''}
        ${type === 'info' ? 'background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: #fff;' : ''}
      `;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'toastOut 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    window.showToast = showToast;

    // Adicionar estilos de anima√ß√£o do toast
    if (!document.getElementById('toastStyles')) {
      const style = document.createElement('style');
      style.id = 'toastStyles';
      style.textContent = `
        @keyframes toastIn { from { opacity: 0; transform: translateX(-50%) translateY(20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
        @keyframes toastOut { from { opacity: 1; transform: translateX(-50%) translateY(0); } to { opacity: 0; transform: translateX(-50%) translateY(20px); } }
      `;
      document.head.appendChild(style);
    }

    // ===== CONTEXTO INTELIGENTE PARA ENTREG√ÅVEIS =====
    // Este contexto √© adicionado automaticamente a todos os prompts para garantir
    // que as an√°lises sejam estrat√©gicas e n√£o apenas uma c√≥pia dos dados preenchidos
    const MEDIAGROWTH_EXPERTISE_CONTEXT = `
## üß† CONTEXTO ESTRAT√âGICO

**INSTRU√á√ïES PARA AN√ÅLISE PROFISSIONAL:** V√° direto ao ponto com an√°lises estrat√©gicas baseadas nos dados.

**üö® REGRA CR√çTICA DE OUTPUT:**
- NUNCA mencione no relat√≥rio final os nomes de especialistas, autores ou frameworks que voc√™ usa internamente
- NUNCA escreva frases como "Baseado em [Nome]...", "Aplicando a metodologia de [Nome]...", "Segundo [Framework]..."
- Use o conhecimento dessas estrat√©gias para criar an√°lises melhores, mas entregue como se fosse pensamento original
- O cliente deve ver apenas o RESULTADO da aplica√ß√£o dessas metodologias, n√£o a fonte

1. **ANALISAR os dados** coletados - identificar padr√µes, gaps e oportunidades
2. **INTERPRETAR o contexto** - conectar as informa√ß√µes de forma estrat√©gica
3. **RECOMENDAR a√ß√µes** baseadas em expertise de marketing digital
4. **ALERTAR sobre riscos** identificados nas informa√ß√µes
5. **SUGERIR melhorias** que v√£o al√©m do que foi pedido

### üéØ MODELO DE NEG√ìCIO
- Aquisi√ß√£o de clientes via tr√°fego pago (Meta Ads, Google Ads)
- Funil: Visitante ‚Üí Lead ‚Üí Agendamento ‚Üí Proposta ‚Üí Cliente
- Modelo de assinatura mensal com estrutura√ß√£o inicial de 5 semanas
- Foco em PMEs que querem escalar com marketing digital

### üìä BENCHMARKS DE REFER√äNCIA (use para comparar)
- CPL m√©dio Meta Ads B2B: R$ 25-50
- CPL m√©dio Google Ads B2B: R$ 40-80
- Taxa de convers√£o LP m√©dia: 5-15%
- Taxa de show em agendamentos: 60-80%
- Taxa de fechamento p√≥s-reuni√£o: 20-40%
- CAC saud√°vel: < 30% do LTV
- LTV m√©dio servi√ßos: 6-12x ticket mensal
- ROAS m√≠nimo vi√°vel: 3:1
- ROI saud√°vel: > 5:1

### üí° INSTRU√á√ïES CR√çTICAS PARA SUA AN√ÅLISE

1. **N√ÉO APENAS REPLIQUE** o que foi escrito nos checklists
2. **IDENTIFIQUE GAPS** - o que est√° faltando nas informa√ß√µes?
3. **CONECTE OS PONTOS** - como as informa√ß√µes se relacionam?
4. **QUESTIONE** - h√° inconsist√™ncias nos dados?
5. **SUGIRA** - o que deveria ser feito al√©m do √≥bvio?

### ‚ö†Ô∏è ALERTAS QUE VOC√ä DEVE DAR
- Se meta x investimento parecem desproporcionais
- Se h√° gargalos √≥bvios n√£o mencionados
- Se faltam informa√ß√µes cr√≠ticas
- Se h√° oportunidades n√£o exploradas
- Se h√° riscos n√£o considerados

### üîÑ QUANDO N√ÉO HOUVER INFORMA√á√ÉO SUFICIENTE
Em vez de apenas marcar [Aguardando informa√ß√£o], SUGIRA:
- O que perguntar ao cliente
- Qual dado seria ideal ter
- Uma estimativa baseada em benchmarks do mercado

---

`;

    // Fun√ß√£o auxiliar para obter insights espec√≠ficos por tipo de entreg√°vel
    function getEntregavelExpertiseInsights(entregavelId) {
      const insights = {
        diagnostico_estrategico: `
### üß† EXPERTISE ADICIONAL PARA DIAGN√ìSTICO

Ao analisar o diagn√≥stico, considere:
- **Ciclo de caixa**: tempo entre investimento em marketing e retorno
- **Gargalos escondidos**: processo comercial √© t√£o importante quanto o tr√°fego
- **Sazonalidade**: o neg√≥cio tem picos? Isso afeta toda a estrat√©gia
- **Unit Economics**: CAC, LTV, payback est√£o saud√°veis?
- **Capacidade operacional**: conseguem atender a demanda gerada?

**PERGUNTAS QUE VOC√ä DEVE RESPONDER:**
1. Este neg√≥cio tem fundamentos para escalar?
2. Qual o gargalo n¬∫ 1 que impede o crescimento?
3. Onde est√° o dinheiro sendo deixado na mesa?
`,
        direcionamento_metas: `
### üß† EXPERTISE ADICIONAL PARA METAS

Ao definir metas, valide:
- **Metas SMART**: espec√≠ficas, mensur√°veis, ating√≠veis, relevantes, temporais
- **Investimento x Retorno**: a conta fecha? Fa√ßa a math reversa
- **Capacidade de execu√ß√£o**: a empresa consegue entregar a escala?
- **Margem de erro**: sempre calcule cen√°rios pessimista/otimista
- **Breakdown semanal**: metas anuais s√£o in√∫teis sem breakdown

**MATH REVERSA QUE VOC√ä DEVE FAZER:**
Meta de faturamento ‚Üí Vendas necess√°rias ‚Üí Propostas ‚Üí Leads ‚Üí Investimento
`,
        analise_concorrencia: `
### üß† EXPERTISE ADICIONAL PARA CONCORR√äNCIA

Ao analisar concorr√™ncia:
- **Espionagem de an√∫ncios**: Meta Ad Library, SimilarWeb
- **Posicionamento √∫nico**: onde podemos ser os √∫nicos?
- **Oceano vermelho vs azul**: n√£o brigar por pre√ßo
- **Pontos cegos**: o que ningu√©m est√° oferecendo?
- **Velocidade de adapta√ß√£o**: somos mais √°geis?

**QUADRANTE ESTRAT√âGICO:**
- Alto pre√ßo + Alto valor = Premium (onde queremos estar)
- Baixo pre√ßo + Alto valor = Imposs√≠vel sustentar
- Alto pre√ßo + Baixo valor = Morte certa
- Baixo pre√ßo + Baixo valor = Commodity (fugir)
`,
        matriz_cdt: `
### üß† EXPERTISE ADICIONAL PARA CDT

A matriz CDT √© a BASE de toda comunica√ß√£o:
- **Hierarquia de dores**: qual dor tira o sono? (essa vende)
- **Dor x Desejo**: ativar dor funciona melhor que promessa
- **Obje√ß√µes universais**: pre√ßo, tempo, confian√ßa, urg√™ncia
- **Prova > Promessa**: como provar cada transforma√ß√£o?
- **Linguagem do cliente**: use as palavras DELE, n√£o t√©cnicas

**FRAMEWORK DE COPY QUE USA CDT:**
1. Chame aten√ß√£o com a DOR principal
2. Agrave a dor (custo de n√£o agir)
3. Mostre a TRANSFORMA√á√ÉO
4. Prove com EVID√äNCIAS
5. Chame para A√á√ÉO
`,
        puv: `
### üß† EXPERTISE ADICIONAL PARA PUV

Uma PUV forte deve ser:
- **√önica**: ningu√©m mais pode dizer
- **Relevante**: importa para o cliente
- **Comprov√°vel**: pode ser demonstrada
- **Memor√°vel**: f√°cil de lembrar
- **Defens√°vel**: dif√≠cil de copiar

**F√ìRMULA DE PUV:**
[Para QUEM] [com PROBLEMA X] n√≥s oferecemos [SOLU√á√ÉO Y] 
que [BENEF√çCIO √öNICO] diferente de [ALTERNATIVAS] 
porque [RAZ√ÉO DE ACREDITAR].
`,
        pai: `
### üß† EXPERTISE ADICIONAL PARA PAI

Persona vai al√©m de demografia:
- **Jobs to be done**: o que ele quer realizar?
- **Momentos de verdade**: quando ele decide comprar?
- **Influenciadores**: quem ele consulta antes?
- **Canais reais**: onde ele REALMENTE est√°?
- **Gatilhos de compra**: o que dispara a busca?

**SEGMENTA√á√ÉO ESTRAT√âGICA:**
- ICP (Ideal Customer Profile): perfil perfeito
- Buyer Persona: representa√ß√£o humanizada
- Anti-Persona: quem N√ÉO queremos atender
`,
        anuncios_pagos: `
### üß† EXPERTISE ADICIONAL PARA M√çDIA PAGA

Estrutura de campanhas que funciona:
- **Pir√¢mide de tr√°fego**: frio ‚Üí morno ‚Üí quente
- **Or√ßamento por etapa**: 20% topo / 30% meio / 50% fundo
- **Testes sistem√°ticos**: copy, criativo, p√∫blico, oferta
- **M√©tricas de decis√£o**: CTR, CPL, CPA, ROAS
- **Escala gradual**: +20% a cada 3-5 dias com resultados

**ESTRUTURA M√çNIMA VI√ÅVEL:**
- 1 campanha de convers√£o
- 3 p√∫blicos diferentes
- 3 criativos diferentes
- Budget m√≠nimo R$ 50/dia para teste
`,
        site_seo: `
### üß† EXPERTISE ADICIONAL PARA SITE & SEO

Site que converte:
- **Above the fold**: proposta clara + CTA em 5 segundos
- **Velocidade**: cada segundo = -7% convers√£o
- **Mobile-first**: 70%+ do tr√°fego √© mobile
- **Prova social**: depoimentos, logos, n√∫meros
- **M√∫ltiplos CTAs**: WhatsApp, formul√°rio, liga√ß√£o

**SEO PR√ÅTICO:**
- 1 palavra-chave principal por p√°gina
- Title tag com palavra-chave no in√≠cio
- H1 √∫nico e otimizado
- Conte√∫do m√≠nimo 1000 palavras para rankeamento
`,
        redes_sociais: `
### üß† EXPERTISE ADICIONAL PARA REDES SOCIAIS

Redes que vendem:
- **Funil social**: conte√∫do ‚Üí engajamento ‚Üí confian√ßa ‚Üí venda
- **80/20**: 80% valor, 20% venda
- **Consist√™ncia > Viralidade**: postar todo dia
- **Stories > Feed**: mais alcance, mais convers√£o
- **CTA em tudo**: sempre pedir a√ß√£o

**PIR√ÇMIDE DE CONTE√öDO:**
- Reels: alcance (topo do funil)
- Carross√©is: educa√ß√£o (meio do funil)
- Stories: relacionamento (convers√£o)
- Lives: autoridade (fideliza√ß√£o)
`,
        copywriting: `
### üß† EXPERTISE ADICIONAL PARA COPYWRITING

Copy que converte:
- **AIDA**: Aten√ß√£o ‚Üí Interesse ‚Üí Desejo ‚Üí A√ß√£o
- **PAS**: Problema ‚Üí Agita√ß√£o ‚Üí Solu√ß√£o
- **Hook nos 3 primeiros segundos**
- **Uma ideia por pe√ßa**
- **CTA claro e √∫nico**

**GATILHOS MENTAIS PODEROSOS:**
1. Escassez: "√öltimas vagas"
2. Urg√™ncia: "S√≥ at√© sexta"
3. Prova social: "4.235 clientes"
4. Autoridade: "15 anos de experi√™ncia"
5. Reciprocidade: "Ebook gratuito"
`,
        producao_conteudo: `
### üß† EXPERTISE ADICIONAL PARA PRODU√á√ÉO DE CONTE√öDO

Produ√ß√£o escal√°vel:
- **Batching**: gravar v√°rios de uma vez
- **Repurposing**: 1 conte√∫do ‚Üí 5 formatos
- **Templates**: n√£o come√ßar do zero
- **Banco de ideias**: nunca faltar pauta
- **Calend√°rio editorial**: planejamento mensal

**F√ìRMULA DE ROTEIRO:**
1. Hook (0-3s): ganhar aten√ß√£o
2. Contexto (3-10s): por que isso importa
3. Conte√∫do (10-50s): entregar valor
4. CTA (50-60s): o que fazer agora
`,
        criativos_anuncios: `
### üß† EXPERTISE ADICIONAL PARA CRIATIVOS

Criativos que performam:
- **Thumb-stopping**: parar o scroll
- **Texto leg√≠vel**: contraste, tamanho
- **Rosto humano**: aumenta CTR
- **Antes/Depois**: prova visual
- **Menos √© mais**: uma mensagem clara

**TESTES PRIORIT√ÅRIOS:**
1. Imagem vs V√≠deo
2. Texto curto vs longo
3. Prova social vs Benef√≠cio
4. Urg√™ncia vs Valor
`,
        crm_automacoes: `
### üß† EXPERTISE ADICIONAL PARA CRM

CRM que n√£o perde lead:
- **Velocidade**: responder em < 5 minutos
- **Cad√™ncia**: 7 toques nos primeiros 7 dias
- **Qualifica√ß√£o**: BANT (Budget, Authority, Need, Timeline)
- **Automa√ß√£o**: n√£o depender de humano
- **M√©tricas**: tempo de resposta, taxa de contato, convers√£o

**SEQU√äNCIA M√çNIMA DE FOLLOW-UP:**
1. Imediato: confirma√ß√£o + pr√≥ximos passos
2. +1 dia: lembrete + valor adicional
3. +3 dias: nova abordagem + urg√™ncia
4. +7 dias: √∫ltima tentativa
`,
        processo_comercial: `
### üß† EXPERTISE ADICIONAL PARA PROCESSO COMERCIAL

Vendas que fecham:
- **Diagn√≥stico antes de prescri√ß√£o**
- **Perguntas > Argumentos**
- **Obje√ß√£o = Interesse**: tratar, n√£o fugir
- **Sil√™ncio estrat√©gico**: deixar falar
- **Fechamento natural**: assumir a venda

**ESTRUTURA DE CALL:**
1. Rapport (2 min)
2. Diagn√≥stico (15 min)
3. Apresenta√ß√£o (10 min)
4. Obje√ß√µes (5 min)
5. Fechamento (3 min)
`,
        landing_pages: `
### üß† EXPERTISE ADICIONAL PARA LANDING PAGES

LP que converte:
- **Uma oferta, uma p√°gina**: sem distra√ß√µes
- **Headline matadora**: promessa clara
- **Formul√°rio curto**: nome, email, WhatsApp
- **Prova social acima do fold**
- **CTA repetido**: 3-5 vezes na p√°gina

**ELEMENTOS OBRIGAT√ìRIOS:**
1. Headline com benef√≠cio principal
2. Subheadline com como/para quem
3. Imagem/v√≠deo de prova
4. 3 benef√≠cios principais
5. Depoimentos
6. Formul√°rio/CTA
7. FAQ (reduz obje√ß√µes)
`,
        website: `
### üß† EXPERTISE ADICIONAL PARA WEBSITE

Site que vende:
- **Clareza imediata**: 5s para entender o que voc√™ faz
- **Hierarquia visual**: guiar o olho do visitante
- **Convers√£o em toda p√°gina**: CTA vis√≠vel sempre
- **SEO on-page**: cada p√°gina rankeia algo
- **Analytics**: medir tudo

**P√ÅGINAS ESSENCIAIS:**
1. Home: vis√£o geral + CTA principal
2. Servi√ßos: detalhes + CTAs espec√≠ficos
3. Sobre: hist√≥ria + credibilidade
4. Cases: prova social detalhada
5. Contato: m√∫ltiplos canais
`,
        padronizacao_visual: `
### üß† EXPERTISE ADICIONAL PARA PADRONIZA√á√ÉO VISUAL

Marca consistente:
- **Reconhecimento**: identificar em 2 segundos
- **Repeti√ß√£o**: mesmo visual em todos os canais
- **Simplicidade**: menos cores, menos fontes
- **Aplica√ß√£o pr√°tica**: templates prontos
- **Evolu√ß√£o controlada**: atualizar sem perder identidade

**ELEMENTOS DE BRAND:**
1. Cores: prim√°ria + secund√°ria + neutras
2. Tipografia: t√≠tulo + corpo
3. Elementos gr√°ficos: padr√µes, √≠cones
4. Tom de voz: personalidade escrita
5. Imagens: estilo fotogr√°fico
`,
        plataforma_mediagrowth: `
### üß† EXPERTISE ADICIONAL PARA VIS√ÉO INTEGRADA

Estrat√©gia conectada:
- **Cada entreg√°vel conecta com o pr√≥ximo**
- **M√©tricas consolidadas**: vis√£o √∫nica
- **Prioriza√ß√£o**: o que fazer primeiro
- **Quick wins vs Long term**: equilibrar
- **Revis√£o cont√≠nua**: estrat√©gia viva

**ORDEM DE PRIORIDADE:**
1. Funil funcionando (tr√°fego + convers√£o)
2. Processo comercial rodando
3. Conte√∫do org√¢nico escalando
4. Otimiza√ß√£o cont√≠nua
`
      };
      
      return insights[entregavelId] || '';
    }

    // ===== REGRA GLOBAL ANTI-INVEN√á√ÉO DE DADOS =====
    const INSTRUCAO_NAO_INVENTAR = `
**üö® REGRA SOBRE DADOS E PROJE√á√ïES:**
1. ‚ùå PROIBIDO afirmar SITUA√á√ÉO ATUAL sem dados reais (ex: "Voc√™ tem X seguidores")
2. ‚úÖ PERMITIDO fazer PROJE√á√ïES e METAS baseadas no nicho e contexto
3. Para dados atuais desconhecidos ‚Üí use "A coletar" ou "Diagn√≥stico necess√°rio"
4. Para metas e proje√ß√µes ‚Üí pode sugerir valores realistas baseados no contexto
5. CONSIST√äNCIA: Use MESMOS valores de CPL, CAC, ROAS, Ticket em todos entreg√°veis
`;

    // ===== GERAR DOC - MAPEAMENTO DE ENTREG√ÅVEIS PARA SEMANAS/BLOCOS =====
    // Configura√ß√£o completa com prompts espec√≠ficos e tipos de gr√°ficos para cada entreg√°vel
    const ENTREGAVEL_MAPPING = {
      diagnostico_estrategico: {
        title: 'Diagn√≥stico Estrat√©gico Completo',
        weeks: ['semana1'],
        blocks: ['dir_estrategico', 'momento_atual', 'mercado_concorrencia', 'entendimento_negocio', 'matriz_cdt', 'estrutura_time'],
        charts: {
          primary: 'funnel', // Funil do neg√≥cio
          secondary: 'radar', // Radar de maturidade
          tertiary: 'matrix' // Matriz Gargalo √ó Impacto
        },
        chartDescriptions: {
          primary: 'Funil de convers√£o do neg√≥cio: visualiza as etapas desde visitantes at√© vendas, identificando onde ocorrem as maiores perdas.',
          secondary: 'Radar de maturidade empresarial: avalia Marketing, Vendas, Marca, Processos e Digital para identificar gaps.',
          tertiary: 'Matriz Gargalo √ó Impacto: posiciona os problemas identificados por urg√™ncia de resolu√ß√£o e impacto no neg√≥cio.',
          radar: 'Vis√£o 360¬∞ das 5 dimens√µes-chave do neg√≥cio, revelando √°reas que precisam de aten√ß√£o priorit√°ria.'
        },
        radarLabels: ['Marketing', 'Vendas', 'Marca', 'Processos', 'Digital'],
        promptAnalise: `üìä OBJETIVO: Elaborar um DIAGN√ìSTICO ESTRAT√âGICO COMPLETO com base nos dados fornecidos.

**üéì CONTEXTO DE EXPERTISE (USE INTERNAMENTE - N√ÉO MENCIONE NO RELAT√ìRIO):**
Aplique frameworks de: Michael Porter (5 For√ßas), Philip Kotler (4Ps de Marketing), Peter Drucker (Gest√£o por Resultados), Simon Sinek (Golden Circle), Blue Ocean Strategy. Use metodologias: SWOT Analysis, Business Model Canvas, Value Proposition Canvas, OKRs, North Star Metric.

**‚ö†Ô∏è REGRA OBRIGAT√ìRIA DE MOEDA:**

**üö® REGRA SOBRE DADOS E PROJE√á√ïES:**
- ‚ùå PROIBIDO afirmar SITUA√á√ÉO ATUAL sem dados reais (ex: "Voc√™ tem X seguidores" sem ter essa info)
- ‚úÖ PERMITIDO fazer PROJE√á√ïES e METAS baseadas no nicho, contexto e anota√ß√µes
- Para dados atuais desconhecidos ‚Üí use "A coletar" ou "Diagn√≥stico necess√°rio"
- Para metas e proje√ß√µes ‚Üí pode sugerir valores realistas baseados no contexto do neg√≥cio

Antes de gerar qualquer valor monet√°rio, VERIFIQUE no bloco "üìã Contexto do Neg√≥cio" das anota√ß√µes qual moeda o cliente utiliza (R$ Real ou $ D√≥lar/USD). 
- Se encontrar "d√≥lar", "USD", "dollar" ou "$" no contexto ‚Üí Use $ (d√≥lar americano)
- Se encontrar "real", "reais", "BRL" ou "R$" no contexto ‚Üí Use R$ (real brasileiro)  
- Se n√£o estiver especificado ‚Üí Pergunte ou use R$ como padr√£o
TODOS os valores monet√°rios do relat√≥rio devem seguir a moeda identificada.

**üî¥ CR√çTICO: NUNCA CONFUNDA CAC COM CPL**

Ao analisar custos de marketing, diferencie CLARAMENTE:

**CAC (Custo de Aquisi√ß√£o de Cliente):**
- Quanto custa fechar UMA VENDA
- F√≥rmula: Investimento Total √∑ Clientes que COMPRARAM
- Use quando falar de: rentabilidade, ROI, payback

**CPL (Custo Por Lead):**
- Quanto custa gerar UM LEAD
- F√≥rmula: Investimento Total √∑ Leads Gerados
- Use quando falar de: tr√°fego pago, campanhas, capta√ß√£o

**Exemplo correto:**
"Com investimento de R$ 5.000, geraram 200 leads (CPL = R$ 25/lead). Desses, 10 viraram clientes (CAC = R$ 500/cliente). Taxa de convers√£o: 5%."

**NUNCA diga:** "CAC de R$ 25" quando se refere a custo de LEAD.

**CONTEXTO DO ENTREG√ÅVEL:**
Este √© o primeiro e mais importante entreg√°vel - a RADIOGRAFIA TOTAL do neg√≥cio sob a perspectiva de Marketing e Vendas. 
√â a base s√≥lida para todas as pr√≥ximas etapas do projeto.

**SUA TAREFA:**
Com base nas anota√ß√µes coletadas, gere um DIAGN√ìSTICO ESTRAT√âGICO COMPLETO seguindo exatamente esta estrutura:

---

## 1Ô∏è‚É£ VIS√ÉO GERAL DO DIAGN√ìSTICO
[Introdu√ß√£o executiva: contexto do neg√≥cio, setor de atua√ß√£o, tempo de mercado, momento atual. S√≠ntese de 3-5 linhas sobre o que foi diagnosticado.]

---

## 2Ô∏è‚É£ DIRECIONAMENTO ESTRAT√âGICO
**Onde a empresa quer chegar:**
- **Vis√£o de curto prazo (3-6 meses):** [objetivo imediato]
- **Vis√£o de m√©dio prazo (6-12 meses):** [crescimento esperado]
- **Vis√£o de longo prazo (1-3 anos):** [posicionamento almejado]
- **Meta de faturamento:** [valores e prazos mencionados]
- **Meta de clientes/vendas:** [quantidade e ticket m√©dio]

---

## 3Ô∏è‚É£ AN√ÅLISE DO MOMENTO ATUAL (MARKETING E VENDAS)

### üéØ Marketing Atual
- **Canais ativos:** [quais est√£o usando]
- **Investimento atual:** [or√ßamento mensal de marketing]
- **Principais a√ß√µes:** [o que est√£o fazendo]
- **Resultados obtidos:** [leads, alcance, convers√µes]
- **Pontos fortes:** [o que funciona]
- **Pontos fracos:** [o que n√£o funciona]

### üí∞ Vendas Atual
- **Modelo de vendas:** [como vendem hoje]
- **Ciclo de vendas:** [tempo m√©dio para fechar]
- **Ticket m√©dio:** [valor m√©dio por venda]
- **Taxa de convers√£o:** [de lead para cliente]
- **Principal canal de vendas:** [onde fecham mais]
- **Gargalos identificados:** [onde perdem vendas]

### üîÑ Funil Atual
| Etapa | Volume | Taxa de Convers√£o |
|-------|--------|-------------------|
| Visitantes/Contatos | [n√∫mero] | - |
| Leads qualificados | [n√∫mero] | [%] |
| Or√ßamentos/Propostas | [n√∫mero] | [%] |
| Vendas fechadas | [n√∫mero] | [%] |

---

## 4Ô∏è‚É£ AN√ÅLISE DE MERCADO E CONCORR√äNCIA
- **Setor/Nicho:** [defini√ß√£o clara]
- **Tamanho do mercado:** [se mencionado]
- **Principais concorrentes:** [nomes e diferenciais]
- **O que os concorrentes fazem bem:** [benchmarks]
- **Oportunidades de diferencia√ß√£o:** [gaps no mercado]
- **Posicionamento competitivo atual:** [como a empresa se compara]

---

## 5Ô∏è‚É£ MATRIZ CDT ‚Äî CARACTER√çSTICAS, DORES E SOLU√á√ïES

### üë§ Cliente Ideal (ICP)
- **Perfil demogr√°fico:** [quem √©]
- **Cargo/Decisor:** [quem decide a compra]
- **Segmento:** [B2B/B2C, porte, setor]

### üò∞ Principais Dores
1. [Dor #1 - o que tira o sono do cliente]
2. [Dor #2 - frustra√ß√£o ou problema urgente]
3. [Dor #3 - necessidade n√£o atendida]

### ‚ú® Como a Empresa Resolve
1. [Solu√ß√£o para Dor #1]
2. [Solu√ß√£o para Dor #2]
3. [Solu√ß√£o para Dor #3]

### üèÜ Diferenciais Competitivos
- [O que torna a empresa √∫nica]
- [Por que escolher essa empresa e n√£o o concorrente]

---

## 6Ô∏è‚É£ ESTRUTURA E TIME ATUAL
- **Tamanho da equipe:** [quantas pessoas]
- **Time de Marketing:** [existe? quantos? fun√ß√µes]
- **Time de Vendas:** [existe? quantos? fun√ß√µes]
- **Processos documentados:** [sim/n√£o, n√≠vel de maturidade]
- **Ferramentas utilizadas:** [CRM, automa√ß√£o, etc.]
- **Gaps identificados:** [o que falta na estrutura]

---

## 7Ô∏è‚É£ ENTENDIMENTO DO PROCESSO COMERCIAL
- **Como chegam os leads hoje:** [origem principal]
- **Como √© feito o primeiro contato:** [tempo, canal, abordagem]
- **Processo de qualifica√ß√£o:** [existe? como funciona]
- **Apresenta√ß√£o de proposta:** [como √© feita]
- **Follow-up:** [existe processo estruturado?]
- **Obje√ß√µes comuns:** [principais barreiras para fechar]
- **Motivos de perda:** [por que n√£o fecham]

---

## 8Ô∏è‚É£ DIAGN√ìSTICO DE POSICIONAMENTO

### üìä Radar de Maturidade (0-100%)
| Dimens√£o | Score | Justificativa |
|----------|-------|---------------|
| Marketing | [X%] | [breve justificativa] |
| Vendas | [X%] | [breve justificativa] |
| Marca/Posicionamento | [X%] | [breve justificativa] |
| Processos | [X%] | [breve justificativa] |
| Digital/Tecnologia | [X%] | [breve justificativa] |

### ‚ö†Ô∏è Gargalos Cr√≠ticos Identificados
1. **[Gargalo #1]:** [descri√ß√£o + impacto estimado no faturamento]
2. **[Gargalo #2]:** [descri√ß√£o + impacto estimado]
3. **[Gargalo #3]:** [descri√ß√£o + impacto estimado]

---

## 9Ô∏è‚É£ CONCLUS√ÉO ESTRAT√âGICA DO DIAGN√ìSTICO

### üî¥ O que precisa PARAR (est√° prejudicando)
- [A√ß√£o ou comportamento a eliminar]

### üü° O que precisa AJUSTAR (n√£o est√° otimizado)
- [Processo ou estrat√©gia a melhorar]

### üü¢ O que precisa MANTER (est√° funcionando)
- [O que n√£o pode perder de vista]

### üîµ O que precisa INICIAR (oportunidade)
- [Nova a√ß√£o estrat√©gica recomendada]

### üí° Quick Wins (ganhos r√°pidos em 30 dias)
1. [A√ß√£o imediata de alto impacto #1]
2. [A√ß√£o imediata de alto impacto #2]
3. [A√ß√£o imediata de alto impacto #3]

---

### ‚û°Ô∏è PR√ìXIMO PASSO
[Conectar com o pr√≥ximo entreg√°vel: "Direcionamento Estrat√©gico e Metas" - onde vamos definir os objetivos SMART e o plano de crescimento baseado neste diagn√≥stico]`,
        prompt: `Voc√™ √© um consultor estrat√©gico de marketing da Mediagrowth. Gere um DIAGN√ìSTICO ESTRAT√âGICO COMPLETO.`
      },
      direcionamento_metas: {
        title: 'Direcionamento Estrat√©gico e Metas',
        weeks: ['semana1', 'semana3_4'],
        blocks: ['dir_estrategico', 'metas', 'visao_temporal'],
        charts: {
          primary: 'line', // Crescimento projetado
          secondary: 'bar', // Metas por canal
          tertiary: 'gauge' // KPI m√≠nimo vi√°vel
        },
        chartDescriptions: {
          primary: 'Proje√ß√£o de crescimento: visualiza a curva de crescimento esperada ao longo dos pr√≥ximos meses.',
          secondary: 'Metas por canal: distribui as metas entre tr√°fego pago, org√¢nico, indica√ß√µes e outros canais.',
          tertiary: 'Indicador de KPI m√≠nimo vi√°vel: mostra o progresso em rela√ß√£o aos indicadores essenciais de sobreviv√™ncia.',
          radar: 'Avalia√ß√£o das 5 m√©tricas-chave de crescimento: Faturamento, Leads, Convers√£o, Ticket e Recorr√™ncia.'
        },
        radarLabels: ['Faturamento', 'Leads', 'Convers√£o', 'Ticket', 'Recorr√™ncia'],
        promptAnalise: `# üéØ PROMPT √öNICO ‚Äî RELAT√ìRIO DE METAS E PROJE√á√ïES (12 MESES | SIMPLES, SEGURO E REALISTA)

Voc√™ √© um consultor de estrat√©gia, marketing e finan√ßas orientado a RESULTADO REAL e COER√äNCIA MATEM√ÅTICA.

Seu objetivo √© gerar um **RELAT√ìRIO DE METAS ANUAIS (12 meses)** claro, realista e sem erros, usando **APENAS** os dados fornecidos no final deste prompt.

---

## 1Ô∏è‚É£ REGRAS ABSOLUTAS (N√ÉO QUEBRE)

1. ‚ùå **NUNCA invente dados atuais**
   - Se um dado n√£o existir ‚Üí escreva exatamente **"A coletar"**
   - Exemplos: seguidores atuais, leads atuais, faturamento atual

2. ‚úÖ **PODE criar METAS e PROJE√á√ïES**
   - Desde que sejam realistas para o nicho
   - E matematicamente coerentes

3. üî¥ **NUNCA confunda CPL com CAC**
   - Se confundir ‚Üí o relat√≥rio est√° ERRADO

4. üî¢ **Todos os n√∫meros devem fechar**
   - Leads, MQLs e Vendas = n√∫meros INTEIROS
   - Faturamento = Vendas √ó Ticket
   - CPL, CAC e ROAS devem bater exatamente

---

## 2Ô∏è‚É£ LOCALIZA√á√ÉO (OBRIGAT√ìRIO)

Detecte o pa√≠s pelos dados:

- üáßüá∑ Brasil ‚Üí use **R$** e datas **DD/MM/AAAA**
- üá∫üá∏ EUA ‚Üí use **$** e datas **MM/DD/YYYY**

Depois de decidir, use **UM √öNICO PADR√ÉO** no relat√≥rio inteiro.

---

## 3Ô∏è‚É£ DEFINI√á√ïES (USE EXATAMENTE)

### CPL ‚Äî Custo por Lead (TOPO DO FUNIL)

CPL = Investimento em M√≠dia Paga √∑ Leads Pagos
- Usa APENAS leads pagos
- NUNCA inclui leads org√¢nicos

### CAC ‚Äî Custo de Aquisi√ß√£o (FUNDO DO FUNIL ‚Äî TR√ÅFEGO PAGO)

CAC = Investimento em M√≠dia Paga √∑ Vendas Pagas
- Divide APENAS pelas vendas vindas do tr√°fego pago
- NUNCA divida por vendas totais

### Rela√ß√£o correta

CAC ‚âà CPL √∑ Taxa de Convers√£o do Pago

---

## 4Ô∏è‚É£ F√ìRMULAS OBRIGAT√ìRIAS

Leads Totais = Leads Org√¢nicos + Leads Pagos
MQLs = Leads Totais √ó MQL% (ajustar para inteiro)
Vendas Pagas = Leads Pagos √ó Convers√£o Pago%
Vendas Org√¢nicas = Leads Org√¢nicos √ó Convers√£o Org%
Vendas Totais = Vendas Pagas + Vendas Org√¢nicas

Faturamento Tr√°fego = Vendas Pagas √ó Ticket M√©dio
Faturamento Total = Vendas Totais √ó Ticket M√©dio
ROAS = Faturamento Tr√°fego √∑ Investimento em M√≠dia

---

## 5Ô∏è‚É£ LIMITES DE REALISMO (GUIA SIMPLES)

### Convers√£o
- Leads pagos: 3‚Äì5% inicial ‚Üí at√© 8%
- Leads org√¢nicos: 8‚Äì12% ‚Üí at√© 15%

### ROAS
- Meses 1‚Äì3: 0,5x a 1x
- Meses 4‚Äì6: 1x a 2x
- Meses 7‚Äì12: 2x a 5x

### CAC
- Pode ser alto no in√≠cio
- Deve melhorar ao longo do ano
- Se **CAC > Ticket**, sinalize PREJU√çZO (n√£o esconda)

---

## 6Ô∏è‚É£ ESTRUTURA DO RELAT√ìRIO (OBRIGAT√ìRIA)

### 1. Vis√£o Estrat√©gica (curta)
- Objetivo do neg√≥cio
- Situa√ß√£o atual (com base no contexto)
- Onde precisa chegar em 12 meses

### 2. Metas Anuais Principais
- Meta de faturamento anual
- Ticket m√©dio usado
- Total de vendas necess√°rias no ano
- Total de leads necess√°rios no ano (pago + org√¢nico)
- CAC alvo no final do per√≠odo
- ROAS alvo no final do per√≠odo

---

### 3. TABELA DE PROJE√á√ÉO ANUAL (12 MESES)

Use EXATAMENTE este formato:

\`\`\`markdown
| M√™s | Invest. M√≠dia | Leads Org | Leads Pago | Leads Totais | MQL% | MQLs | Conv Pago% | Conv Org% | Vendas Pago | Vendas Org | Vendas Totais | Ticket | Fat. Tr√°fego | Fat. Total | CPL | CAC | ROAS |
|-----|---------------|-----------|------------|--------------|------|------|------------|-----------|-------------|-------------|----------------|--------|--------------|------------|-----|-----|------|
| Jan |               |           |            |              |      |      |            |           |             |             |                |        |              |            |     |     |      |
| Fev |               |           |            |              |      |      |            |           |             |             |                |        |              |            |     |     |      |
| Mar |               |           |            |              |      |      |            |           |             |             |                |        |              |            |     |     |      |
| Abr |               |           |            |              |      |      |            |           |             |             |                |        |              |            |     |     |      |
| Mai |               |           |            |              |      |      |            |           |             |             |                |        |              |            |     |     |      |
| Jun |               |           |            |              |      |      |            |           |             |             |                |        |              |            |     |     |      |
| Jul |               |           |            |              |      |      |            |           |             |             |                |        |              |            |     |     |      |
| Ago |               |           |            |              |      |      |            |           |             |             |                |        |              |            |     |     |      |
| Set |               |           |            |              |      |      |            |           |             |             |                |        |              |            |     |     |      |
| Out |               |           |            |              |      |      |            |           |             |             |                |        |              |            |     |     |      |
| Nov |               |           |            |              |      |      |            |           |             |             |                |        |              |            |     |     |      |
| Dez |               |           |            |              |      |      |            |           |             |             |                |        |              |            |     |     |      |
| **TOTAL** | | | | | | | | | | | | | | | | | |
\`\`\`

Regras da tabela:
- Leads Totais = Org + Pago
- MQLs e Vendas = INTEIROS
- Fat. Tr√°fego = Vendas Pagas √ó Ticket
- Fat. Total = Vendas Totais √ó Ticket
- CPL = Invest. M√≠dia √∑ Leads Pago
- CAC = Invest. M√≠dia √∑ Vendas Pagas
- ROAS = Fat. Tr√°fego √∑ Invest. M√≠dia

---

### 4. Metas de Redes Sociais (somente se fizer sentido)

Se n√£o houver dados atuais ‚Üí **"A coletar"**

| Rede | Base Atual | Meta M√™s 3 | Meta M√™s 6 | Meta M√™s 12 | Objetivo de Neg√≥cio |
|------|------------|------------|------------|-------------|---------------------|
| Instagram | A coletar | | | | Leads, DMs, prova social |
| Facebook | A coletar | | | | Mensagens, tr√°fego |
| TikTok | A coletar | | | | Alcance e leads |
| LinkedIn | A coletar | | | | Leads B2B |

---

### 5. Plano Resumido para Bater as Metas

- Como aumentar leads
- Como melhorar convers√£o
- Como reduzir CPL e CAC
- Como melhorar ROAS ao longo do ano

---

### 6. Resumo Executivo

- Faturamento anual projetado
- Vendas totais no ano
- Investimento total em m√≠dia
- CPL m√©dio
- CAC m√©dio
- ROAS m√©dio
- Pr√≥ximos 90 dias (3 a√ß√µes claras)

---

## 7Ô∏è‚É£ EXECU√á√ÉO FINAL

Agora gere o relat√≥rio completo usando APENAS os dados fornecidos no contexto.

---

## üö® REGRA SUPREMA ‚Äî ADAPTA√á√ÉO AO NEG√ìCIO (N√ÉO NEGOCI√ÅVEL)

Este relat√≥rio **DEVE ser 100% ADAPTADO AO NEG√ìCIO INFORMADO**.

‚ùå √â PROIBIDO:
- Usar n√∫meros gen√©ricos
- Repetir exemplos
- Assumir m√©dias de mercado sem justificar
- Copiar estruturas prontas sem recalcular
- Ignorar o modelo de neg√≥cio, nicho ou ticket informado

‚úÖ √â OBRIGAT√ìRIO:
- Basear TODOS os c√°lculos no **modelo de neg√≥cio informado**
- Adaptar metas, taxas, CAC, CPL e ROAS ao **ticket m√©dio, nicho e est√°gio do neg√≥cio**
- Ajustar convers√µes e crescimento conforme:
  - B2B vs B2C
  - Servi√ßo local vs nacional
  - Ticket baixo vs alto
  - Ciclo de vendas curto vs longo
- Recalcular TODOS os n√∫meros do zero usando os dados fornecidos
- Se algo n√£o fizer sentido para o neg√≥cio, **parar e sinalizar**

üìå REGRA DE OURO:
> **Se um n√∫mero n√£o puder ser explicado pelo contexto do neg√≥cio, ele N√ÉO pode existir no relat√≥rio.**`,
        prompt: `Voc√™ √© um consultor estrat√©gico da Mediagrowth. Gere um documento de DIRECIONAMENTO ESTRAT√âGICO E METAS com an√°lise de como bater as metas.`
      },
      analise_concorrencia: {
        title: 'An√°lise de Concorr√™ncia e Mercado',
        weeks: ['semana1', 'semana2'],
        blocks: ['mercado_concorrencia', 'benchmarks'],
        charts: {
          primary: 'scatter', // Mapa de posicionamento
          secondary: 'comparison', // Tabela comparativa
          tertiary: 'wordcloud' // Nuvem de promessas
        },
        chartDescriptions: {
          primary: 'Mapa de posicionamento: posiciona sua empresa e concorrentes no quadrante Pre√ßo √ó Valor Percebido.',
          secondary: 'Comparativo competitivo: tabela visual mostrando for√ßas e fraquezas de cada concorrente.',
          tertiary: 'Nuvem de promessas: identifica os termos e argumentos mais usados pelos concorrentes no mercado.',
          radar: 'Avalia√ß√£o comparativa em 5 dimens√µes: Pre√ßo, Qualidade, Atendimento, Digital e Marca.'
        },
        radarLabels: ['Pre√ßo', 'Qualidade', 'Atendimento', 'Digital', 'Marca'],
        promptAnalise: `üìä OBJETIVO: Realizar uma AN√ÅLISE DE CONCORR√äNCIA E MERCADO profunda e estrat√©gica.

**üéì CONTEXTO DE EXPERTISE (USE INTERNAMENTE - N√ÉO MENCIONE NO RELAT√ìRIO):**
Aplique frameworks de: Michael Porter (5 For√ßas Competitivas, Estrat√©gias Gen√©ricas), W. Chan Kim (Blue Ocean), Al Ries & Jack Trout (Positioning), Clayton Christensen (Disruptive Innovation). Use metodologias: Competitive Intelligence, Perceptual Mapping, Market Segmentation, PESTEL Analysis.

**‚ö†Ô∏è REGRA OBRIGAT√ìRIA DE MOEDA:**

**üö® REGRA SOBRE DADOS E PROJE√á√ïES:**
- ‚ùå PROIBIDO afirmar SITUA√á√ÉO ATUAL sem dados reais (ex: "Voc√™ tem X seguidores" sem ter essa info)
- ‚úÖ PERMITIDO fazer PROJE√á√ïES e METAS baseadas no nicho, contexto e anota√ß√µes
- Para dados atuais desconhecidos ‚Üí use "A coletar" ou "Diagn√≥stico necess√°rio"
- Para metas e proje√ß√µes ‚Üí pode sugerir valores realistas baseados no contexto do neg√≥cio

Antes de gerar qualquer valor monet√°rio, VERIFIQUE no bloco "üìã Contexto do Neg√≥cio" das anota√ß√µes qual moeda o cliente utiliza (R$ Real ou $ D√≥lar/USD). 
- Se encontrar "d√≥lar", "USD", "dollar" ou "$" no contexto ‚Üí Use $ (d√≥lar americano)
- Se encontrar "real", "reais", "BRL" ou "R$" no contexto ‚Üí Use R$ (real brasileiro)  
- Se n√£o estiver especificado ‚Üí Pergunte ou use R$ como padr√£o
TODOS os valores monet√°rios do relat√≥rio devem seguir a moeda identificada.

**OBJETIVO DO ENTREG√ÅVEL:**
Parar de competir por pre√ßo. Identificar EXATAMENTE onde e como o cliente pode vencer a competi√ß√£o, encontrar oceanos azuis e criar diferencia√ß√£o real e defens√°vel no mercado.

**SUA TAREFA:**
Com base nas anota√ß√µes das semanas de estrutura√ß√£o (concorrentes listados, dados do neg√≥cio do cliente, posicionamento atual), fa√ßa uma AN√ÅLISE COMPETITIVA PROFUNDA e ACION√ÅVEL que identifique gaps de mercado, oportunidades inexploradas e estrat√©gias de diferencia√ß√£o.

**IMPORTANTE:**
- Analise CADA concorrente mencionado nas anota√ß√µes individualmente
- Compare diretamente com os dados da empresa do cliente (a "Innov" ou o nome que aparecer)
- Seja espec√≠fico sobre GAPS e OPORTUNIDADES
- D√™ DIRE√á√ÉO CLARA sobre como se diferenciar
- Use dados reais das anota√ß√µes, n√£o invente

**ESTRUTURA OBRIGAT√ìRIA:**

---

## 1Ô∏è‚É£ PANORAMA DO MERCADO

### üåê Vis√£o Geral do Setor
- **Segmento de atua√ß√£o**: [identificar das anota√ß√µes]
- **Maturidade do mercado**: [emergente/crescimento/maduro/saturado]
- **Tend√™ncias atuais**: [o que est√° mudando no setor]
- **Tamanho estimado do mercado**: [se mencionado nas anota√ß√µes]

### ÔøΩ Din√¢mica Competitiva
- **N√∫mero de concorrentes identificados**: [X] concorrentes
- **Tipo de competi√ß√£o**: [por pre√ßo/por diferencia√ß√£o/por nicho]
- **Barreiras de entrada**: [altas/m√©dias/baixas]
- **Poder de barganha do cliente**: [alto/m√©dio/baixo]

---

## 2Ô∏è‚É£ AN√ÅLISE INDIVIDUAL DE CADA CONCORRENTE

### üîç Metodologia de An√°lise
Para cada concorrente, analisei: Posicionamento, Pre√ßo, Comunica√ß√£o, Pontos Fortes, Pontos Fracos, Presen√ßa Digital e Amea√ßa Competitiva.

---

### üè¢ CONCORRENTE 1: [NOME]

| Dimens√£o | An√°lise Detalhada |
|----------|------------------|
| **Posicionamento** | [como se posiciona no mercado] |
| **Faixa de Pre√ßo** | [valor ou range - comparar com cliente] |
| **P√∫blico-Alvo** | [quem eles atendem] |
| **Proposta de Valor** | [o que prometem entregar] |
| **Canais de Venda** | [online/offline/h√≠brido] |
| **Presen√ßa Digital** | [site/redes/an√∫ncios - forte/m√©dio/fraco] |

**‚úÖ Pontos Fortes:**
1. [For√ßa #1 - o que fazem bem]
2. [For√ßa #2]
3. [For√ßa #3]

**‚ùå Pontos Fracos (OPORTUNIDADES PARA VOC√ä):**
1. [Fraqueza #1 - GAP que voc√™ pode explorar]
2. [Fraqueza #2]
3. [Fraqueza #3]

**‚ö†Ô∏è N√≠vel de Amea√ßa**: [üî¥ Alta / üü° M√©dia / üü¢ Baixa]
**Justificativa**: [por que representa essa amea√ßa]

---

### üè¢ CONCORRENTE 2: [NOME]

| Dimens√£o | An√°lise Detalhada |
|----------|------------------|
| **Posicionamento** | [como se posiciona no mercado] |
| **Faixa de Pre√ßo** | [valor ou range] |
| **P√∫blico-Alvo** | [quem eles atendem] |
| **Proposta de Valor** | [o que prometem entregar] |
| **Canais de Venda** | [online/offline/h√≠brido] |
| **Presen√ßa Digital** | [site/redes/an√∫ncios - forte/m√©dio/fraco] |

**‚úÖ Pontos Fortes:**
1. [For√ßa #1]
2. [For√ßa #2]
3. [For√ßa #3]

**‚ùå Pontos Fracos (OPORTUNIDADES PARA VOC√ä):**
1. [Fraqueza #1 - GAP]
2. [Fraqueza #2]
3. [Fraqueza #3]

**‚ö†Ô∏è N√≠vel de Amea√ßa**: [üî¥ Alta / üü° M√©dia / üü¢ Baixa]
**Justificativa**: [por que]

---

### üè¢ CONCORRENTE 3: [NOME]
[Repetir estrutura para cada concorrente mencionado nas anota√ß√µes]

---

## 3Ô∏è‚É£ AN√ÅLISE COMPARATIVA - TABELA MASTER

### üìä Comparativo Completo: Sua Empresa vs Concorrentes

| Crit√©rio | [SUA EMPRESA] | Concorrente 1 | Concorrente 2 | Concorrente 3 | Concorrente 4 | Concorrente 5 |
|----------|---------------|---------------|---------------|---------------|---------------|---------------|
| **Pre√ßo** | | | | | | |
| **Qualidade Percebida** | ‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê |
| **Atendimento** | | | | | | |
| **Diferencial Principal** | | | | | | |
| **Presen√ßa Digital** | | | | | | |
| **Tempo de Mercado** | | | | | | |
| **Reputa√ß√£o/Avalia√ß√µes** | | | | | | |
| **Especializa√ß√£o** | | | | | | |
| **Inova√ß√£o** | | | | | | |
| **P√≥s-Venda** | | | | | | |

### üéØ Legenda de Avalia√ß√£o
- ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê = Excelente (l√≠der no crit√©rio)
- ‚≠ê‚≠ê‚≠ê‚≠ê = Muito Bom
- ‚≠ê‚≠ê‚≠ê = Bom/Mediano
- ‚≠ê‚≠ê = Abaixo da m√©dia
- ‚≠ê = Fraco

---

## 4Ô∏è‚É£ MAPA DE POSICIONAMENTO COMPETITIVO

### ÔøΩ Quadrante Estrat√©gico

**Eixo X**: Pre√ßo (Baixo ‚Üê‚Üí Alto)
**Eixo Y**: Valor Percebido/Qualidade (Baixo ‚Üê‚Üí Alto)

| Quadrante | Empresas | Caracter√≠stica |
|-----------|----------|----------------|
| **PREMIUM** (Alto Pre√ßo + Alto Valor) | [listar] | L√≠deres, margens altas |
| **CUSTO-BENEF√çCIO** (Baixo Pre√ßo + Alto Valor) | [listar] | Disruptores, crescimento r√°pido |
| **ARMADILHA** (Alto Pre√ßo + Baixo Valor) | [listar] | Em decl√≠nio, clientes insatisfeitos |
| **COMMODITIES** (Baixo Pre√ßo + Baixo Valor) | [listar] | Guerra de pre√ßo, margens baixas |

### üéØ Onde [SUA EMPRESA] est√°:
[Posi√ß√£o atual no quadrante]

### üöÄ Onde [SUA EMPRESA] deveria estar:
[Posi√ß√£o ideal e por qu√™]

### üìå Movimento Estrat√©gico Recomendado:
[Seta de movimento: de onde para onde, e o que fazer para chegar l√°]

---

## 5Ô∏è‚É£ GAPS DE MERCADO IDENTIFICADOS

### üîì Oportunidades que NINGU√âM est√° Explorando

| # | GAP Identificado | Por que existe | Como explorar | Potencial |
|---|-----------------|----------------|---------------|-----------|
| 1 | [Gap #1] | [Raz√£o] | [A√ß√£o espec√≠fica] | üî•üî•üî• Alto |
| 2 | [Gap #2] | [Raz√£o] | [A√ß√£o espec√≠fica] | üî•üî• M√©dio |
| 3 | [Gap #3] | [Raz√£o] | [A√ß√£o espec√≠fica] | üî• Baixo |
| 4 | [Gap #4] | [Raz√£o] | [A√ß√£o espec√≠fica] | üî•üî•üî• Alto |
| 5 | [Gap #5] | [Raz√£o] | [A√ß√£o espec√≠fica] | üî•üî• M√©dio |

### üí° Top 3 Gaps Priorit√°rios para [SUA EMPRESA]:
1. **[Gap mais importante]**: [Por que √© priorit√°rio + a√ß√£o imediata]
2. **[Gap #2]**: [Por que √© priorit√°rio + a√ß√£o]
3. **[Gap #3]**: [Por que √© priorit√°rio + a√ß√£o]

---

## 6Ô∏è‚É£ PROMESSAS E MENSAGENS DO MERCADO

### üîÑ O que TODOS Prometem (Oceano Vermelho)
Essas s√£o promessas gen√©ricas que N√ÉO diferenciam. Evite competir apenas nisso:

| Promessa Gen√©rica | Quantos usam | Por que n√£o diferencia |
|-------------------|--------------|----------------------|
| [Promessa 1] | X de Y | [Raz√£o] |
| [Promessa 2] | X de Y | [Raz√£o] |
| [Promessa 3] | X de Y | [Raz√£o] |
| [Promessa 4] | X de Y | [Raz√£o] |
| [Promessa 5] | X de Y | [Raz√£o] |

### üåä O que NINGU√âM Promete (Oceano Azul)
Oportunidades de diferencia√ß√£o na comunica√ß√£o:

| Promessa √önica Potencial | Concorrentes que usam | Oportunidade para voc√™ |
|-------------------------|----------------------|----------------------|
| [Promessa 1] | Nenhum | ‚úÖ [Como usar] |
| [Promessa 2] | Nenhum | ‚úÖ [Como usar] |
| [Promessa 3] | Nenhum | ‚úÖ [Como usar] |

---

## 7Ô∏è‚É£ AN√ÅLISE SWOT COMPETITIVA

### Sua Empresa vs Mercado

| | **Positivo** | **Negativo** |
|---|-------------|-------------|
| **Interno** | **FOR√áAS** | **FRAQUEZAS** |
| | 1. [For√ßa #1 baseada nas notas] | 1. [Fraqueza #1] |
| | 2. [For√ßa #2] | 2. [Fraqueza #2] |
| | 3. [For√ßa #3] | 3. [Fraqueza #3] |
| **Externo** | **OPORTUNIDADES** | **AMEA√áAS** |
| | 1. [Oportunidade #1 - gap de mercado] | 1. [Amea√ßa #1 - concorrente forte] |
| | 2. [Oportunidade #2] | 2. [Amea√ßa #2] |
| | 3. [Oportunidade #3] | 3. [Amea√ßa #3] |

### üéØ Cruzamento Estrat√©gico SWOT:

**For√ßa + Oportunidade (EXPLORAR):**
- [Como usar sua for√ßa para capturar a oportunidade]

**For√ßa + Amea√ßa (DEFENDER):**
- [Como usar sua for√ßa para neutralizar a amea√ßa]

**Fraqueza + Oportunidade (DESENVOLVER):**
- [O que desenvolver para n√£o perder a oportunidade]

**Fraqueza + Amea√ßa (ELIMINAR):**
- [O que eliminar urgentemente]

---

## 8Ô∏è‚É£ ESTRAT√âGIA DE DIFERENCIA√á√ÉO

### üéØ Posicionamento √önico Recomendado

**Para** [p√∫blico-alvo espec√≠fico]
**Que** [t√™m esta necessidade/dor espec√≠fica]
**[SUA EMPRESA] √©** [categoria/tipo de solu√ß√£o]
**Que** [benef√≠cio principal √∫nico]
**Diferente de** [concorrentes/alternativas]
**Porque** [raz√£o para acreditar/prova]

### ‚öîÔ∏è Batalhas que DEVE Travar (Onde Competir)
1. **[Batalha #1]**: [Por que vencer aqui √© importante]
2. **[Batalha #2]**: [Por que vencer aqui √© importante]
3. **[Batalha #3]**: [Por que vencer aqui √© importante]

### üö´ Batalhas que N√ÉO Deve Travar (Onde Evitar)
1. **[Batalha #1]**: [Por que n√£o competir aqui - concorrente muito forte]
2. **[Batalha #2]**: [Por que n√£o competir aqui]
3. **[Batalha #3]**: [Por que n√£o competir aqui]

---

## 9Ô∏è‚É£ VANTAGENS COMPETITIVAS DE [SUA EMPRESA]

### ‚úÖ Vantagens Atuais (J√° possui)
| Vantagem | Como explorar melhor | Contra qual concorrente usar |
|----------|---------------------|----------------------------|
| [Vantagem 1] | [A√ß√£o] | [Concorrente X] |
| [Vantagem 2] | [A√ß√£o] | [Concorrente Y] |
| [Vantagem 3] | [A√ß√£o] | [Todos] |

### üî® Vantagens a Construir (Pr√≥ximos 6-12 meses)
| Vantagem a desenvolver | Por que √© importante | Como construir |
|-----------------------|---------------------|----------------|
| [Vantagem 1] | [Raz√£o] | [Passos] |
| [Vantagem 2] | [Raz√£o] | [Passos] |
| [Vantagem 3] | [Raz√£o] | [Passos] |

---

## üîü PLANO DE A√á√ÉO - COMO VENCER A CONCORR√äNCIA

### üöÄ A√ß√µes Imediatas (Pr√≥ximos 30 dias)
1. **[A√ß√£o #1]**: [Descri√ß√£o + resultado esperado]
2. **[A√ß√£o #2]**: [Descri√ß√£o + resultado esperado]
3. **[A√ß√£o #3]**: [Descri√ß√£o + resultado esperado]

### üìÖ A√ß√µes de M√©dio Prazo (30-90 dias)
1. **[A√ß√£o #1]**: [Descri√ß√£o]
2. **[A√ß√£o #2]**: [Descri√ß√£o]
3. **[A√ß√£o #3]**: [Descri√ß√£o]

### üéØ A√ß√µes Estrat√©gicas (90-180 dias)
1. **[A√ß√£o #1]**: [Descri√ß√£o]
2. **[A√ß√£o #2]**: [Descri√ß√£o]
3. **[A√ß√£o #3]**: [Descri√ß√£o]

---

## üìä RESUMO EXECUTIVO

### üîë Principais Descobertas
1. [Descoberta mais importante sobre o mercado]
2. [Segunda descoberta importante]
3. [Terceira descoberta importante]

### üíé Maior Oportunidade Identificada
[Descreva a maior oportunidade que o cliente tem baseado na an√°lise]

### ‚ö†Ô∏è Maior Amea√ßa Identificada
[Descreva a maior amea√ßa que o cliente enfrenta]

### üéØ Recomenda√ß√£o Estrat√©gica Principal
[Uma frase que resume o que o cliente deve fazer para vencer a concorr√™ncia]

---

### ‚û°Ô∏è PR√ìXIMO PASSO
[Conectar com a Matriz CDT para traduzir estas oportunidades competitivas em comunica√ß√£o que diferencia e converte]`,
        prompt: `Voc√™ √© um analista de intelig√™ncia competitiva da Mediagrowth. Gere uma AN√ÅLISE DE CONCORR√äNCIA E MERCADO profunda e estrat√©gica.`
      },
      matriz_cdt: {
        title: 'Matriz CDT - Caracter√≠sticas, Dores e Transforma√ß√µes',
        weeks: ['semana1'],
        blocks: ['matriz_cdt', 'entendimento_negocio'],
        charts: {
          primary: 'heatmap', // Matriz Dor √ó Intensidade
          secondary: 'journey', // Jornada emocional
          tertiary: 'funnel' // Obje√ß√µes por etapa
        },
        radarLabels: ['Dores', 'Desejos', 'Obje√ß√µes', 'Medos', 'Aspira√ß√µes'],
        promptAnalise: `üìã OBJETIVO: Criar a MATRIZ CDT (Caracter√≠sticas, Dores e Transforma√ß√µes) do p√∫blico-alvo.

**üéì CONTEXTO DE EXPERTISE (USE INTERNAMENTE - N√ÉO MENCIONE NO RELAT√ìRIO):**
Aplique conceitos de: Donald Miller (StoryBrand), Eugene Schwartz (5 N√≠veis de Consci√™ncia), Robert Cialdini (6 Princ√≠pios de Persuas√£o), Daniel Kahneman (Behavioral Economics). Use frameworks: Jobs To Be Done (JTBD), Pain-Agitate-Solution (PAS), Before-After-Bridge (BAB).

**‚ö†Ô∏è REGRA OBRIGAT√ìRIA DE MOEDA:**

**üö® REGRA SOBRE DADOS E PROJE√á√ïES:**
- ‚ùå PROIBIDO afirmar SITUA√á√ÉO ATUAL sem dados reais (ex: "Voc√™ tem X seguidores" sem ter essa info)
- ‚úÖ PERMITIDO fazer PROJE√á√ïES e METAS baseadas no nicho, contexto e anota√ß√µes
- Para dados atuais desconhecidos ‚Üí use "A coletar" ou "Diagn√≥stico necess√°rio"
- Para metas e proje√ß√µes ‚Üí pode sugerir valores realistas baseados no contexto do neg√≥cio

Verifique no "üìã Contexto do Neg√≥cio" qual moeda usar:
- "d√≥lar", "USD", "$" ‚Üí Use $ (d√≥lar americano)
- "real", "BRL", "R$" ‚Üí Use R$ (real brasileiro)
- N√£o especificado ‚Üí Use R$ como padr√£o

**üéØ OBJETIVO PRINCIPAL:**
Criar uma MATRIZ CDT COMPLETA que conecte TODAS as caracter√≠sticas da empresa/produto com as dores que resolvem e as transforma√ß√µes que proporcionam.

**‚ö†Ô∏è REGRA CR√çTICA - TABELA CDT:**
A TABELA PRINCIPAL ABAIXO √â O ELEMENTO MAIS IMPORTANTE DESTE DOCUMENTO!
- Liste TODAS as caracter√≠sticas identificadas nas anota√ß√µes
- CADA caracter√≠stica deve ter sua dor correspondente
- CADA dor deve ter sua transforma√ß√£o resultante
- A tabela deve ser EXTENSA e COMPLETA (m√≠nimo 10-15 linhas)

**ESTRUTURA OBRIGAT√ìRIA:**

---

## üìä MATRIZ CDT COMPLETA - TABELA PRINCIPAL

### üîó CARACTER√çSTICAS ‚Üí DORES ‚Üí TRANSFORMA√á√ïES

Esta √© a matriz central do documento. Cada caracter√≠stica da empresa/produto resolve uma dor espec√≠fica e gera uma transforma√ß√£o mensur√°vel.

| üè∑Ô∏è CARACTER√çSTICA | üî¥ DOR QUE RESOLVE | ‚ú® TRANSFORMA√á√ÉO GERADA |
|-------------------|-------------------|------------------------|
| [Caracter√≠stica 1 da empresa/produto encontrada nas anota√ß√µes] | [Qual dor do cliente essa caracter√≠stica resolve?] | [Qual transforma√ß√£o o cliente experimenta ap√≥s resolver essa dor?] |
| [Caracter√≠stica 2] | [Dor correspondente] | [Transforma√ß√£o resultante] |
| [Caracter√≠stica 3] | [Dor correspondente] | [Transforma√ß√£o resultante] |
| [Continue listando TODAS as caracter√≠sticas...] | [...] | [...] |

**üìù INSTRU√á√ïES PARA PREENCHER A TABELA:**
- **CARACTER√çSTICA**: Atributos, recursos, diferenciais, metodologias, garantias, expertise da empresa
- **DOR**: O problema, frustra√ß√£o, medo ou obst√°culo que o cliente enfrenta e que essa caracter√≠stica resolve
- **TRANSFORMA√á√ÉO**: O resultado positivo, benef√≠cio tang√≠vel ou mudan√ßa de estado que o cliente experimenta

---

### ÔøΩ AN√ÅLISE DETALHADA DAS DORES

#### Dores por Intensidade (Alta ‚Üí Baixa)
| Dor | Intensidade | Impacto na Decis√£o de Compra | Caracter√≠stica que Resolve |
|-----|-------------|------------------------------|---------------------------|
[Liste as dores ordenadas por intensidade, conectando com as caracter√≠sticas]

#### Dores por Categoria
- **Dores Financeiras:** [listar]
- **Dores de Tempo:** [listar]
- **Dores Emocionais:** [listar]
- **Dores T√©cnicas:** [listar]
- **Dores de Status/Reputa√ß√£o:** [listar]

---

### üíö DESEJOS E ASPIRA√á√ïES DO CLIENTE

| Desejo | Prioridade | Como a Empresa Atende | Caracter√≠stica Relacionada |
|--------|-----------|----------------------|---------------------------|
[Liste desejos identificados nas anota√ß√µes]

---

### ‚ö†Ô∏è OBJE√á√ïES E MEDOS

| Obje√ß√£o/Medo | Frequ√™ncia | Resposta Estrat√©gica | Prova/Garantia |
|--------------|-----------|---------------------|----------------|
[Liste obje√ß√µes identificadas e como contorn√°-las]

---

### ‚ú® TABELA DE ANTES √ó DEPOIS

| ANTES (Estado Atual com a Dor) | DEPOIS (Estado Transformado) | PROVA/EVID√äNCIA |
|-------------------------------|------------------------------|-----------------|
[Preencha com transforma√ß√µes reais identificadas]

---

### üé≠ JORNADA EMOCIONAL DO CLIENTE

1. **üò∞ Consci√™ncia**: [emo√ß√£o quando descobre o problema]
2. **ü§î Considera√ß√£o**: [emo√ß√£o ao pesquisar solu√ß√µes]
3. **üòü Decis√£o**: [emo√ß√£o no momento da compra]
4. **üòä P√≥s-compra**: [emo√ß√£o ap√≥s experimentar a transforma√ß√£o]

---

### üéØ APLICA√á√ÉO PR√ÅTICA NA COMUNICA√á√ÉO

#### Headlines que Atacam as Dores:
1. [headline baseada na dor mais intensa]
2. [headline baseada na segunda dor]
3. [headline baseada na terceira dor]

#### Promessas que Vendem (baseadas nas transforma√ß√µes):
1. [promessa de transforma√ß√£o 1]
2. [promessa de transforma√ß√£o 2]
3. [promessa de transforma√ß√£o 3]

#### Contorno de Obje√ß√µes (scripts prontos):
- **Obje√ß√£o 1**: "[obje√ß√£o]" ‚Üí **Resposta**: "[contorno]"
- **Obje√ß√£o 2**: "[obje√ß√£o]" ‚Üí **Resposta**: "[contorno]"

---

### ‚û°Ô∏è PR√ìXIMO PASSO
[Usar esta Matriz CDT para desenvolver a PUV - Proposta √önica de Valor, focando nas caracter√≠sticas mais diferenciadas e nas transforma√ß√µes mais impactantes]`,
        prompt: `Voc√™ √© um estrategista de neg√≥cios da Mediagrowth. Gere uma MATRIZ CDT profissional focada na tabela Caracter√≠sticas ‚Üí Dores ‚Üí Transforma√ß√µes.`
      },
      puv: {
        title: 'PUV - Proposta √önica de Valor',
        weeks: ['semana2'],
        blocks: ['puv', 'melhorias'],
        charts: {
          primary: 'pyramid', // Pir√¢mide de Valor
          secondary: 'comparison', // N√≥s √ó Mercado
          tertiary: 'perception' // Mapa de percep√ß√£o
        },
        radarLabels: ['Diferencia√ß√£o', 'Clareza', 'Credibilidade', 'Relev√¢ncia', 'Memorabilidade'],
        promptAnalise: `üéØ OBJETIVO: Desenvolver a Proposta √önica de Valor (PUV) do neg√≥cio.

**üéì CONTEXTO DE EXPERTISE (USE INTERNAMENTE - N√ÉO MENCIONE NO RELAT√ìRIO):**
Aplique conceitos de: Geoffrey Moore (Crossing the Chasm), Al Ries & Jack Trout (Positioning), Simon Sinek (Start With Why), Seth Godin (Purple Cow). Use frameworks: Value Proposition Canvas, Unique Selling Proposition (USP), Brand Positioning Statement, Elevator Pitch Framework.

**‚ö†Ô∏è REGRA OBRIGAT√ìRIA DE MOEDA:**

**üö® REGRA SOBRE DADOS E PROJE√á√ïES:**
- ‚ùå PROIBIDO afirmar SITUA√á√ÉO ATUAL sem dados reais (ex: "Voc√™ tem X seguidores" sem ter essa info)
- ‚úÖ PERMITIDO fazer PROJE√á√ïES e METAS baseadas no nicho, contexto e anota√ß√µes
- Para dados atuais desconhecidos ‚Üí use "A coletar" ou "Diagn√≥stico necess√°rio"
- Para metas e proje√ß√µes ‚Üí pode sugerir valores realistas baseados no contexto do neg√≥cio

Antes de gerar qualquer valor monet√°rio, VERIFIQUE no bloco "üìã Contexto do Neg√≥cio" das anota√ß√µes qual moeda o cliente utiliza (R$ Real ou $ D√≥lar/USD). 
- Se encontrar "d√≥lar", "USD", "dollar" ou "$" no contexto ‚Üí Use $ (d√≥lar americano)
- Se encontrar "real", "reais", "BRL" ou "R$" no contexto ‚Üí Use R$ (real brasileiro)  
- Se n√£o estiver especificado ‚Üí Pergunte ou use R$ como padr√£o
TODOS os valores monet√°rios do relat√≥rio devem seguir a moeda identificada.


**CONTEXTO DO ENTREG√ÅVEL:**
Define o "por que voc√™" - diferencial competitivo claro e defens√°vel.

**SUA TAREFA:**
Criar PUV poderosa e aplic√°vel.

**ESTRUTURA OBRIGAT√ìRIA:**

### üìä AN√ÅLISE DE DIFERENCIA√á√ÉO
[O que torna esta empresa √∫nica baseado nas anota√ß√µes]

### üíé PROPOSTA √öNICA DE VALOR

**FRASE CENTRAL:**
> "[PUV em uma frase poderosa]"

**VERS√ÉO EXPANDIDA:**
[PUV em um par√°grafo completo]

### üèÜ PIR√ÇMIDE DE VALOR
1. **Base** (Funcional): [o que entrega]
2. **Meio** (Emocional): [como faz sentir]
3. **Topo** (Transformacional): [quem o cliente se torna]

### ‚öîÔ∏è N√ìS vs. MERCADO
| Aspecto | Sua Empresa | Mercado |
|---------|-------------|---------|
| Diferencial | | Comum |
| Abordagem | | Tradicional |
| Resultado | | Gen√©rico |

### üõ°Ô∏è DEFESA DA PUV
Como provar que a promessa √© real:
- [Prova 1: dados/n√∫meros]
- [Prova 2: cases/depoimentos]
- [Prova 3: metodologia/processo]

### üì¢ APLICA√á√ÉO POR CANAL
- **An√∫ncios**: [vers√£o curta - at√© 10 palavras]
- **Site**: [vers√£o completa - 2-3 frases]
- **Vendas**: [pitch verbal - 30 segundos]
- **Redes Sociais**: [vers√£o bio/headline]

---

## üöÄ IDEIAS "FORA DA BOLHA" - ESTRAT√âGIAS DE ALTO IMPACTO

**‚ö†Ô∏è ATEN√á√ÉO: As ideias abaixo s√£o SUGEST√ïES OUSADAS. Devem ser avaliadas antes de implementar.**

### üí° IDEIAS DISRUPTIVAS DE POSICIONAMENTO

| # | Ideia Ousada | Por que funciona | Risco | Potencial |
|---|-------------|------------------|-------|-----------|
| 1 | [Ideia que NENHUM concorrente faz] | [Raz√£o] | [Risco] | Alto |
| 2 | [Garantia ousada ou promessa forte] | [Raz√£o] | [Risco] | Alto |
| 3 | [Formato/canal inovador] | [Raz√£o] | [Risco] | M√©dio |
| 4 | [Oferta irrecus√°vel] | [Raz√£o] | [Risco] | Alto |
| 5 | [Posicionamento contr√°rio ao mercado] | [Raz√£o] | [Risco] | M√©dio |

### üé≠ ESTRAT√âGIAS DE CHOQUE POSITIVO
1. **[Estrat√©gia 1]**: O que fazer - Por que ningu√©m faz - Resultado
2. **[Estrat√©gia 2]**: O que fazer - Por que ningu√©m faz - Resultado
3. **[Estrat√©gia 3]**: O que fazer - Por que ningu√©m faz - Resultado

### üî• GARANTIAS OUSADAS
| Garantia | Como Funciona | Impacto |
|----------|---------------|---------|
| [Resultado ou dinheiro + b√¥nus] | [Mec√¢nica] | Alto |
| [Pagamento ap√≥s resultado] | [Mec√¢nica] | Alto |

### üé™ MARKETING DE GUERRILHA
1. [A√ß√£o n√£o convencional 1]
2. [A√ß√£o n√£o convencional 2]
3. [A√ß√£o n√£o convencional 3]

> **NOTA:** Estas s√£o SUGEST√ïES para discuss√£o. Valide antes de implementar.

### ‚û°Ô∏è PR√ìXIMO PASSO
[Conex√£o com PAI - definir quem mais valoriza esses diferenciais]`,
        prompt: `Voc√™ √© um especialista em posicionamento da Mediagrowth. Gere um documento de PUV com ideias disruptivas.`
      },
      pai: {
        title: 'PAI - P√∫blico Alvo Ideal',
        weeks: ['semana2'],
        blocks: ['pai', 'matriz_cdt'],
        charts: {
          primary: 'persona', // Card de Persona
          secondary: 'journey', // Jornada de decis√£o
          tertiary: 'channels' // Canais preferidos
        },
        radarLabels: ['Conhecimento', 'Interesse', 'Inten√ß√£o', 'Urg√™ncia', 'Capacidade'],
        promptAnalise: `üë• OBJETIVO: Desenvolver o P√∫blico-Alvo Ideal (PAI) com personas detalhadas.

**ÔøΩ CONTEXTO DE EXPERTISE (USE INTERNAMENTE - N√ÉO MENCIONE NO RELAT√ìRIO):**
Aplique metodologias de: Tony Zambito (Buyer Persona), Adele Revella (Buyer Persona Institute), Alan Cooper (Goal-Directed Design), Clayton Christensen (Jobs To Be Done). Use frameworks: Empathy Map, Customer Journey Map, Persona Canvas, Psychographic Segmentation.

**ÔøΩüåç REGRA OBRIGAT√ìRIA DE LOCALIZA√á√ÉO E NOMES:**
ANTES de criar as personas, VERIFIQUE no bloco "üìã Contexto do Neg√≥cio" qual o PA√çS de atua√ß√£o do cliente:

- ‚úÖ Se o pa√≠s for **Brasil** ou contiver "Brasil":
  - Use nomes BRASILEIROS para as personas (Ex: Jo√£o Silva, Maria Santos, Pedro Costa, Ana Oliveira, Carlos Ferreira)
  - Use cidades brasileiras na localiza√ß√£o (Ex: S√£o Paulo, Rio de Janeiro, Belo Horizonte)
  - Use R$ (Real) para valores monet√°rios

- ‚úÖ Se o pa√≠s for **Estados Unidos (EUA)**, **USA**, **United States** ou contiver "EUA":
  - Use nomes AMERICANOS para as personas (Ex: John Smith, Sarah Johnson, Michael Brown, Emily Davis, David Wilson)
  - Use cidades americanas na localiza√ß√£o (Ex: New York, Los Angeles, Chicago, Miami, Austin)
  - Use $ (D√≥lar) para valores monet√°rios

- ‚úÖ Para outros pa√≠ses:
  - Adapte os nomes conforme a cultura local do pa√≠s informado
  - Use cidades do pa√≠s informado
  - Use a moeda do pa√≠s informado

**‚ö†Ô∏è ATEN√á√ÉO:** Os nomes das personas DEVEM refletir a localiza√ß√£o geogr√°fica do neg√≥cio. Um neg√≥cio americano n√£o pode ter personas com nomes brasileiros!

**üö® REGRA SOBRE DADOS E PROJE√á√ïES:**
- ‚ùå PROIBIDO afirmar SITUA√á√ÉO ATUAL sem dados reais (ex: "Voc√™ tem X seguidores" sem ter essa info)
- ‚úÖ PERMITIDO fazer PROJE√á√ïES e METAS baseadas no nicho, contexto e anota√ß√µes
- Para dados atuais desconhecidos ‚Üí use "A coletar" ou "Diagn√≥stico necess√°rio"
- Para metas e proje√ß√µes ‚Üí pode sugerir valores realistas baseados no contexto do neg√≥cio


**CONTEXTO DO ENTREG√ÅVEL:**
O PAI (P√∫blico Alvo Ideal) define exatamente quem s√£o os clientes ideais para maximizar convers√µes e n√£o desperdi√ßar investimento em tr√°fego.

**SUA TAREFA:**
Criar 5 PERSONAS COMPLETAS e detalhadas, cada uma representando um segmento diferente do p√∫blico-alvo ideal.

**ESTRUTURA OBRIGAT√ìRIA - REPITA PARA CADA UMA DAS 5 PERSONAS:**

---

## üë§ PERSONA 1: [NOME DA PERSONA]

### üìã PERFIL DEMOGR√ÅFICO
| Caracter√≠stica | Descri√ß√£o |
|----------------|-----------|
| **Nome Fict√≠cio** | [Nome representativo] |
| **Idade** | [faixa et√°ria espec√≠fica] |
| **G√™nero** | [se relevante] |
| **Estado Civil** | [solteiro/casado/etc] |
| **Profiss√£o/Cargo** | [ocupa√ß√£o detalhada] |
| **Renda Mensal** | [faixa de renda] |
| **Localiza√ß√£o** | [cidade/regi√£o] |
| **Escolaridade** | [n√≠vel educacional] |

### üß† PERFIL PSICOGR√ÅFICO
- **Estilo de vida**: [como vive o dia a dia]
- **Valores**: [o que √© importante para ela]
- **Hobbies**: [o que faz nas horas livres]
- **Aspira√ß√µes**: [o que deseja para o futuro]
- **Medos**: [o que teme acontecer]

### ÔøΩ DORES E FRUSTRA√á√ïES
| Dor | Intensidade | Impacto na Vida |
|-----|-------------|-----------------|
| [Dor principal 1] | Alta/M√©dia/Baixa | [Como afeta] |
| [Dor 2] | Alta/M√©dia/Baixa | [Como afeta] |
| [Dor 3] | Alta/M√©dia/Baixa | [Como afeta] |
| [Dor 4] | Alta/M√©dia/Baixa | [Como afeta] |

**Frase que define sua dor:**
> "[O que essa pessoa diria sobre seu problema/frustra√ß√£o]"

### ‚ú® DESEJOS E TRANSFORMA√á√ïES
| Desejo | Prioridade | Transforma√ß√£o Esperada |
|--------|------------|------------------------|
| [Desejo 1] | Alta | [Como quer se sentir/estar ap√≥s] |
| [Desejo 2] | Alta | [Transforma√ß√£o] |
| [Desejo 3] | M√©dia | [Transforma√ß√£o] |

**Estado atual vs. Estado desejado:**
- **ANTES**: [Como se sente/est√° agora]
- **DEPOIS**: [Como quer se sentir/estar]

### ‚ù§Ô∏è RAZ√ïES EMOCIONAIS DE COMPRA
| Gatilho Emocional | Por que Compra | Frase Mental |
|-------------------|----------------|--------------|
| [Emo√ß√£o 1: ex: Medo] | [Motiva√ß√£o por tr√°s] | "[O que pensa antes de comprar]" |
| [Emo√ß√£o 2: ex: Status] | [Motiva√ß√£o] | "[Pensamento]" |
| [Emo√ß√£o 3: ex: Seguran√ßa] | [Motiva√ß√£o] | "[Pensamento]" |
| [Emo√ß√£o 4: ex: Pertencimento] | [Motiva√ß√£o] | "[Pensamento]" |

### ÔøΩ COMPORTAMENTO DE COMPRA
- **Como pesquisa**: [onde busca informa√ß√£o]
- **Tempo de decis√£o**: [r√°pido/m√©dio/longo]
- **Influenciadores**: [quem influencia a decis√£o]
- **Obje√ß√µes principais**: [o que a faz hesitar]
- **Gatilho de a√ß√£o**: [o que a faz comprar agora]

### üí° INSIGHTS E OBSERVA√á√ïES
- **Insight 1**: [Descoberta importante sobre esta persona]
- **Insight 2**: [Padr√£o de comportamento identificado]
- **Insight 3**: [Oportunidade de comunica√ß√£o]

### üì± CANAIS E COMUNICA√á√ÉO
| Canal | Presen√ßa | Como Abordar |
|-------|----------|--------------|
| [Canal 1] | Alta/M√©dia/Baixa | [Tipo de conte√∫do que funciona] |
| [Canal 2] | Alta/M√©dia/Baixa | [Abordagem] |
| [Canal 3] | Alta/M√©dia/Baixa | [Abordagem] |

---

## üë§ PERSONA 2: [NOME DA PERSONA]
[Repetir toda a estrutura acima]

---

## üë§ PERSONA 3: [NOME DA PERSONA]
[Repetir toda a estrutura acima]

---

## üë§ PERSONA 4: [NOME DA PERSONA]
[Repetir toda a estrutura acima]

---

## üë§ PERSONA 5: [NOME DA PERSONA]
[Repetir toda a estrutura acima]

---

## üìä RESUMO COMPARATIVO DAS 5 PERSONAS

| Aspecto | Persona 1 | Persona 2 | Persona 3 | Persona 4 | Persona 5 |
|---------|-----------|-----------|-----------|-----------|-----------|
| **Idade** | | | | | |
| **Renda** | | | | | |
| **Dor Principal** | | | | | |
| **Desejo Principal** | | | | | |
| **Canal Favorito** | | | | | |
| **Gatilho de Compra** | | | | | |

## üéØ PRIORIZA√á√ÉO DE PERSONAS
1. **Persona Priorit√°ria**: [Nome] - [Por qu√™ focar nela primeiro]
2. **Segunda Prioridade**: [Nome] - [Justificativa]
3. **Terceira Prioridade**: [Nome] - [Justificativa]
4. **Quarta Prioridade**: [Nome] - [Justificativa]
5. **Quinta Prioridade**: [Nome] - [Justificativa]

### ‚û°Ô∏è PR√ìXIMO PASSO
[Como usar estas personas na estrat√©gia de an√∫ncios pagos]`,
        prompt: `Voc√™ √© um especialista em personas da Mediagrowth. Gere um documento de PAI com 5 personas completas.`
      },
      anuncios_pagos: {
        title: 'Estrutura√ß√£o de An√∫ncios Pagos',
        weeks: ['semana3_4'],
        blocks: ['google', 'metas'],
        maxTokens: 12000,
        charts: {
          primary: 'funnel', // Funil de an√∫ncios
          secondary: 'pie', // Or√ßamento por canal
          tertiary: 'projection' // Simula√ß√£o CPL
        },
        radarLabels: ['Meta Ads', 'Google Ads', 'YouTube', 'LinkedIn', 'TikTok'],
        promptAnalise: `üí∞ OBJETIVO: Realizar a ESTRUTURA√á√ÉO ESTRAT√âGICA DE AN√öNCIOS PAGOS com foco em performance.

**üéì CONTEXTO DE EXPERTISE (USE INTERNAMENTE - N√ÉO MENCIONE NO RELAT√ìRIO):**
Aplique estrat√©gias de: Perry Marshall (80/20 Sales), Ryan Deiss (Customer Value Optimization), Molly Pittman (Traffic & Conversion), Nicholas Kusmich (Facebook Ads), Brad Geddes (Google Ads). Use frameworks: Conversion Funnel Optimization, Campaign Budget Optimization (CBO), Audience Segmentation Matrix, Attribution Modeling, Creative Testing Framework.

**‚ö†Ô∏è REGRA OBRIGAT√ìRIA DE MOEDA:**

**üö® REGRA SOBRE DADOS E PROJE√á√ïES:**
- ‚ùå PROIBIDO afirmar SITUA√á√ÉO ATUAL sem dados reais (ex: "Voc√™ tem X seguidores" sem ter essa info)
- ‚úÖ PERMITIDO fazer PROJE√á√ïES e METAS baseadas no nicho, contexto e anota√ß√µes
- Para dados atuais desconhecidos ‚Üí use "A coletar" ou "Diagn√≥stico necess√°rio"
- Para metas e proje√ß√µes ‚Üí pode sugerir valores realistas baseados no contexto do neg√≥cio

Verifique no "üìã Contexto do Neg√≥cio" qual moeda usar (R$ ou $). Use a moeda identificada em TODOS os valores.

**üî¥ CR√çTICO: NUNCA CONFUNDA CAC COM CPL**

Estas s√£o m√©tricas COMPLETAMENTE DIFERENTES:

**CAC (Custo de Aquisi√ß√£o de Cliente):**
- Custo para conseguir um CLIENTE PAGANTE (venda fechada)
- F√≥rmula: CAC = Investimento Total / N√∫mero de CLIENTES que COMPRARAM
- Exemplo: R$ 3.000 investidos √∑ 10 clientes pagantes = R$ 300/cliente CAC

**CPL (Custo Por Lead):**
- Custo para conseguir um LEAD (prospecto interessado)
- F√≥rmula: CPL = Investimento Total / N√∫mero de LEADS gerados
- Exemplo: R$ 3.000 investidos √∑ 100 leads = R$ 30/lead CPL

**Rela√ß√£o entre eles:**
- CAC = CPL √∑ Taxa de Convers√£o
- Se CPL = R$ 30 e convers√£o = 10% ‚Üí CAC = R$ 30 √∑ 0,10 = R$ 300
- CAC √© SEMPRE maior que CPL (nem todo lead vira cliente)

**Quando usar cada um:**
- Use **CPL** para analisar efici√™ncia de GERA√á√ÉO de leads
- Use **CAC** para analisar efici√™ncia de FECHAMENTO de vendas
- Use **CAC** para calcular ROI e LTV/CAC ratio

**OBJETIVO:** Criar estrutura completa de campanhas para escala previs√≠vel de leads e vendas.

**üî¥ REGRA CR√çTICA DE CONSIST√äNCIA:**

**VOC√ä DEVE usar OS MESMOS DADOS da an√°lise de "üìä Direcionamento Estrat√©gico e Metas":**
- ‚úÖ Use o MESMO investimento mensal em tr√°fego pago
- ‚úÖ Use o MESMO ticket m√©dio
- ‚úÖ Use a MESMA meta de leads pagos por m√™s
- ‚úÖ Use o MESMO CPL projetado
- ‚úÖ Use as MESMAS taxas de convers√£o
- ‚ùå NUNCA invente n√∫meros diferentes que criem diverg√™ncia entre relat√≥rios

**FONTE DOS DADOS:**
1. **Anota√ß√µes da Semana 1:** Ticket m√©dio, contexto do neg√≥cio
2. **Anota√ß√µes da Semana 3-4:** Or√ßamento de tr√°fego, metas de leads
3. **An√°lise de Metas j√° gerada:** Investimento mensal, CPL, meta de leads pagos
4. **Contexto do neg√≥cio:** Moeda (R$ ou $), nicho, p√∫blico-alvo

**VALIDA√á√ÉO ANTES DE GERAR:**
- Confirme que os n√∫meros batem com a tabela de proje√ß√£o anual (m√™s 1)
- Se houver diverg√™ncia, USE os dados das anota√ß√µes/metas, n√£o invente novos

---

## 1Ô∏è‚É£ AN√ÅLISE ESTRAT√âGICA

**üîç IMPORTANTE:** Extraia estes dados EXATAMENTE das anota√ß√µes e da an√°lise de metas j√° gerada.

| Dado | Valor | Fonte |
|------|-------|-------|
| Or√ßamento Mensal | [das anota√ß√µes semana 3-4] | Semana 3-4 |
| Ticket M√©dio | [das anota√ß√µes semana 1] | Semana 1 |
| Meta de Leads Pagos/M√™s | [da an√°lise de metas - m√™s 1] | An√°lise Metas |
| CPL Projetado | [da an√°lise de metas - m√™s 1] | An√°lise Metas |
| CPL M√°ximo Aceit√°vel | [Ticket √ó 0,20] | Calculado |
| Meta de Vendas via Ads/M√™s | [da an√°lise de metas - m√™s 1] | An√°lise Metas |

---

## 2Ô∏è‚É£ VALIDA√á√ÉO DE COER√äNCIA COM AN√ÅLISE DE METAS

**‚ö†Ô∏è ANTES DE PROSSEGUIR, CONFIRME:**

| M√©trica | An√°lise de Metas (M√™s 1) | Este Relat√≥rio | Status |
|---------|---------------------------|----------------|--------|
| Investimento em Tr√°fego | [valor da tabela de metas] | [valor deste relat√≥rio] | ‚úÖ Bate / ‚ùå Diverge |
| Meta de Leads Pagos | [valor da tabela de metas] | [valor deste relat√≥rio] | ‚úÖ Bate / ‚ùå Diverge |
| CPL Projetado | [valor da tabela de metas] | [valor deste relat√≥rio] | ‚úÖ Bate / ‚ùå Diverge |
| Ticket M√©dio | [valor das anota√ß√µes] | [valor deste relat√≥rio] | ‚úÖ Bate / ‚ùå Diverge |

**üî¥ SE HOUVER DIVERG√äNCIA:**
- PARE e revise os dados
- Use SEMPRE os valores das anota√ß√µes/an√°lise de metas
- N√ÉO invente n√∫meros novos

**‚úÖ CONFIRMA√á√ÉO:**
"Os dados acima est√£o alinhados com a an√°lise de Direcionamento Estrat√©gico e Metas, garantindo consist√™ncia entre os relat√≥rios."

---

## 3Ô∏è‚É£ OBJETIVO DOS AN√öNCIOS

**Objetivo Principal:** [SMART - espec√≠fico e mensur√°vel]

**Objetivos Secund√°rios:**
1. [Objetivo 2 + KPI]
2. [Objetivo 3 + KPI]

---

## 3Ô∏è‚É£ DIAGN√ìSTICO DO MOMENTO ATUAL

| Aspecto | Status |
|---------|--------|
| Hist√≥rico de an√∫ncios | [Nunca/J√° anunciou] |
| Pixel/Tags | [Instalado/N√£o] |
| Landing pages | [Tem/Precisa criar] |

**N√≠vel de Maturidade:** [1-5] - [Descri√ß√£o]

**Gaps a resolver:**
1. [Gap #1 + a√ß√£o corretiva]
2. [Gap #2 + a√ß√£o corretiva]

---

## 4Ô∏è‚É£ ESTRUTURA DE FUNIS DE AN√öNCIOS

### üîµ TOPO (ToFu) - Consci√™ncia
- **% Or√ßamento:** 20%
- **Objetivo:** Alcance/Awareness
- **P√∫blicos:** Lookalike/Interesses amplos
- **Criativos:** V√≠deos curtos, Reels educativos

### üü° MEIO (MoFu) - Considera√ß√£o  
- **% Or√ßamento:** 30%
- **Objetivo:** Engajamento/Tr√°fego
- **P√∫blicos:** Retargeting 7-30 dias
- **Criativos:** Cases, Depoimentos

### üü¢ FUNDO (BoFu) - Convers√£o
- **% Or√ßamento:** 40%
- **Objetivo:** Leads/Vendas
- **P√∫blicos:** Retargeting 1-7 dias
- **Criativos:** Oferta direta, CTA forte

### üîÅ REMARKETING
- **% Or√ßamento:** 10%
- **P√∫blicos:** Leads n√£o convertidos, Clientes antigos

---

## 5Ô∏è‚É£ ESTRAT√âGIA POR CANAL

| Canal | % | Investimento | Objetivo |
|-------|---|--------------|----------|
| Meta Ads | [X]% | [valor] | [objetivo] |
| Google Ads | [X]% | [valor] | [objetivo] |
| YouTube | [X]% | [valor] | [objetivo] |
| **TOTAL** | 100% | [total] | - |

---

## 6Ô∏è‚É£ ESTRUTURA DE CAMPANHAS

**META ADS:**
| Campanha | Objetivo | P√∫blico | Or√ßamento/dia |
|----------|----------|---------|---------------|
| [Camp 1] | Convers√£o | [P√∫blico] | [valor] |
| [Camp 2] | Remarketing | [P√∫blico] | [valor] |

**GOOGLE ADS:**
| Campanha | Tipo | Palavras-chave | Or√ßamento/dia |
|----------|------|----------------|---------------|
| [Camp 1] | Search | [keywords] | [valor] |
| [Camp 2] | Display | Remarketing | [valor] |

---

## 7Ô∏è‚É£ ESTRAT√âGIA DE PALAVRAS-CHAVE (Google)

**Alta Inten√ß√£o (Prioridade):**
| Palavra-chave | CPC Est. | Inten√ß√£o |
|---------------|----------|----------|
| [palavra 1] | [valor] | Compra |
| [palavra 2] | [valor] | Compra |
| [palavra 3] | [valor] | Compra |

**Negativas:** [lista de palavras a excluir]

---

## 8Ô∏è‚É£ CRIATIVOS E COPYWRITING

**Formatos por Etapa:**
- ToFu: V√≠deo problema/dor (15-30s)
- MoFu: Depoimento/Case
- BoFu: Oferta + CTA

**Headlines (baseado nas dores do cliente):**
1. [Headline dor]
2. [Headline benef√≠cio]
3. [Headline prova social]

**Testes A/B recomendados:**
- Headline: [vers√£o A] vs [vers√£o B]
- CTA: [vers√£o A] vs [vers√£o B]

---

## 9Ô∏è‚É£ LANDING PAGES E CONVERS√ÉO

**Elementos obrigat√≥rios:**
- [ ] Headline clara
- [ ] Benef√≠cios (3-5)
- [ ] Prova social
- [ ] CTA acima da dobra
- [ ] Formul√°rio curto (Nome, Email, WhatsApp)

**Meta de convers√£o:** [X]%

---

## üîü INTEGRA√á√ÉO COM PROCESSO COMERCIAL

**Fluxo:** An√∫ncio ‚Üí LP ‚Üí Lead ‚Üí Automa√ß√£o (imediata) ‚Üí Contato comercial (<5min)

**Automa√ß√µes:**
| Gatilho | A√ß√£o | Tempo |
|---------|------|-------|
| Novo lead | WhatsApp + Email | Imediato |
| Sem resposta 24h | Follow-up | 24h |

---

## 1Ô∏è‚É£1Ô∏è‚É£ M√âTRICAS E KPIs (ALINHADAS COM AN√ÅLISE DE METAS)

**üî¥ IMPORTANTE:** Use os MESMOS valores projetados na an√°lise de Direcionamento Estrat√©gico e Metas (M√™s 1).

| M√©trica | Meta (M√™s 1) | Fonte | Frequ√™ncia |
|---------|--------------|-------|------------|
| Leads Pagos | [valor da an√°lise de metas] | An√°lise Metas | Di√°ria |
| CPL (Custo Por Lead) | [valor da an√°lise de metas] | An√°lise Metas | Di√°ria |
| Vendas via Ads | [valor da an√°lise de metas] | An√°lise Metas | Semanal |
| CAC Tr√°fego Pago | [valor da an√°lise de metas] | An√°lise Metas | Semanal |
| ROAS | [valor da an√°lise de metas] | An√°lise Metas | Semanal |
| Taxa convers√£o LP | [8-12%] | Benchmark | Semanal |
| Faturamento Tr√°fego | [valor da an√°lise de metas] | An√°lise Metas | Mensal |

**üìä EVOLU√á√ÉO ESPERADA (12 MESES):**

Use a MESMA proje√ß√£o da an√°lise de metas:

| M√™s | Investimento | Leads Pagos | CPL | Vendas Ads | CAC | ROAS |
|-----|--------------|-------------|-----|------------|-----|------|
| M√™s 1 | [an√°lise metas] | [an√°lise metas] | [an√°lise metas] | [an√°lise metas] | [an√°lise metas] | [an√°lise metas] |
| M√™s 3 | [an√°lise metas] | [an√°lise metas] | [an√°lise metas] | [an√°lise metas] | [an√°lise metas] | [an√°lise metas] |
| M√™s 6 | [an√°lise metas] | [an√°lise metas] | [an√°lise metas] | [an√°lise metas] | [an√°lise metas] | [an√°lise metas] |
| M√™s 12 | [an√°lise metas] | [an√°lise metas] | [an√°lise metas] | [an√°lise metas] | [an√°lise metas] | [an√°lise metas] |

**üí° CONTEXTO:**
- Evolu√ß√£o baseada na otimiza√ß√£o gradual das campanhas
- CPL deve REDUZIR com testes e aprendizado
- ROAS deve AUMENTAR com melhor segmenta√ß√£o
- CAC deve REDUZIR com melhor convers√£o do funil
| Leads | [X]/m√™s | Di√°ria |
| CPL | [valor] | Di√°ria |
| ROAS | [X]:1 | Semanal |
| CAC | [valor] | Semanal |
| Taxa convers√£o LP | [X]% | Semanal |

---

## 1Ô∏è‚É£2Ô∏è‚É£ RISCOS E ALERTAS (BASEADOS NAS METAS)

**üî¥ CR√çTICO:** Use os valores da an√°lise de metas como refer√™ncia para alertas.

| Alerta | Gatilho | A√ß√£o |
|--------|---------|------|
| üî¥ CPL Alto | CPL > [CPL projetado √ó 1,5] | Pausar campanhas ruins |
| üî¥ CAC Insustent√°vel | CAC > Ticket M√©dio | Revisar funil completo |
| üî¥ Sem convers√£o | 48h sem lead | Revisar copy + p√∫blico |
| üü° CTR Baixo | CTR < 1% | Trocar criativos |
| üü° ROAS Baixo | ROAS < [meta √ó 0,7] | Otimizar segmenta√ß√£o |

**Limites de seguran√ßa (baseados nas metas):**
- CPL m√°ximo aceit√°vel: [CPL projetado √ó 1,5]
- CAC m√°ximo aceit√°vel: [Ticket M√©dio √ó 0,8]
- Gasto di√°rio m√°ximo: [Investimento mensal √∑ 30 dias]
- ROAS m√≠nimo vi√°vel: [da an√°lise de metas]

---

## 1Ô∏è‚É£3Ô∏è‚É£ CONCLUS√ÉO ESTRAT√âGICA (ALINHADA COM METAS)

**Resumo da Estrat√©gia:**
- **Investimento mensal:** [valor da an√°lise de metas]
- **Canais principais:** [Meta Ads, Google Ads, etc.]
- **Meta de Leads Pagos:** [valor da an√°lise de metas m√™s 1]
- **Meta de Vendas via Ads:** [valor da an√°lise de metas m√™s 1]
- **CPL projetado:** [valor da an√°lise de metas m√™s 1]
- **CAC projetado:** [valor da an√°lise de metas m√™s 1]
- **ROAS esperado:** [valor da an√°lise de metas m√™s 1]
- **Faturamento via Tr√°fego:** [valor da an√°lise de metas m√™s 1]

**‚úÖ VALIDA√á√ÉO FINAL:**
"Esta estrutura de an√∫ncios est√° 100% alinhada com as metas e proje√ß√µes definidas na an√°lise de Direcionamento Estrat√©gico e Metas, garantindo consist√™ncia entre planejamento e execu√ß√£o."

**Checklist de Implementa√ß√£o:**
- [ ] Semana 1: Setup (contas, pixel, p√∫blicos, convers√µes)
- [ ] Semana 2: Lan√ßamento (campanhas teste com 20% do budget)
- [ ] Semana 3: An√°lise de resultados iniciais
- [ ] Semana 4: Escala gradual (+20%) no que funciona

**Pr√≥ximos passos imediatos:**
1. [A√ß√£o imediata #1 baseada no contexto]
2. [A√ß√£o imediata #2 baseada no contexto]
3. [A√ß√£o imediata #3 baseada no contexto]

---

### ‚û°Ô∏è PR√ìXIMO PASSO
[Conex√£o com Site & SEO - estrutura de landing pages para convers√£o]`,
        prompt: `Voc√™ √© um especialista em m√≠dia paga da Mediagrowth. Gere um documento de ESTRUTURA√á√ÉO DE AN√öNCIOS PAGOS completo e estrat√©gico.

**üî¥ REGRA CR√çTICA:** Use os MESMOS dados da an√°lise de "Direcionamento Estrat√©gico e Metas" j√° gerada. Verifique investimento, CPL, metas de leads, CAC e ROAS na tabela de proje√ß√£o anual (m√™s 1) e USE EXATAMENTE esses valores. N√ÉO invente n√∫meros novos.`
      },
      site_seo: {
        title: 'Estrutura√ß√£o Site & SEO',
        weeks: ['semana3_4'],
        blocks: ['site_seo'],
        maxTokens: 12000,
        charts: {
          primary: 'sitemap',
          secondary: 'userflow',
          tertiary: 'keywords'
        },
        radarLabels: ['T√©cnico', 'Conte√∫do', 'Autoridade', 'UX', 'Velocidade'],
        promptAnalise: `üîç OBJETIVO: Realizar a ESTRUTURA√á√ÉO COMPLETA DE SITE & SEO para atrair leads organicamente.

**üéì CONTEXTO DE EXPERTISE (USE INTERNAMENTE - N√ÉO MENCIONE NO RELAT√ìRIO):**
Aplique estrat√©gias de: Brian Dean (Backlinko/Skyscraper Technique), Neil Patel (SEO & Growth), Rand Fishkin (Moz/SparkToro), Aleyda Solis (International SEO), Cyrus Shepard (On-Page SEO). Use frameworks: E-A-T (Expertise, Authoritativeness, Trustworthiness), Topic Clusters, Pillar Content Strategy, Technical SEO Audit Framework, Link Building Matrix.

**‚ö†Ô∏è REGRA OBRIGAT√ìRIA DE MOEDA:**

**üö® REGRA SOBRE DADOS E PROJE√á√ïES:**
- ‚ùå PROIBIDO afirmar SITUA√á√ÉO ATUAL sem dados reais (ex: "Voc√™ tem X seguidores" sem ter essa info)
- ‚úÖ PERMITIDO fazer PROJE√á√ïES e METAS baseadas no nicho, contexto e anota√ß√µes
- Para dados atuais desconhecidos ‚Üí use "A coletar" ou "Diagn√≥stico necess√°rio"
- Para metas e proje√ß√µes ‚Üí pode sugerir valores realistas baseados no contexto do neg√≥cio

Verifique no "üìã Contexto do Neg√≥cio" qual moeda usar (R$ ou $). Use a moeda identificada em TODOS os valores.

**OBJETIVO:** Criar estrat√©gia completa de SEO para posicionar o site como autoridade no nicho e gerar leads org√¢nicos qualificados.

**USE OS DADOS DAS ANOTA√á√ïES:** contexto do neg√≥cio, p√∫blico-alvo, produtos/servi√ßos, concorrentes, regi√£o de atua√ß√£o.

---

## 1Ô∏è‚É£ OBJETIVO CENTRAL DO RELAT√ìRIO
[Explique o prop√≥sito: transformar o site em m√°quina de capta√ß√£o org√¢nica]
- **Meta Principal:** [Ex: Posicionar nas 3 primeiras posi√ß√µes para palavras-chave de alta inten√ß√£o]
- **Resultado Esperado:** [Ex: Aumentar tr√°fego org√¢nico em X% e gerar Y leads/m√™s]
- **Prazo para Resultados:** [Curto/m√©dio/longo prazo]

---

## 2Ô∏è‚É£ CONTEXTO DO NEG√ìCIO (BASE ESTRAT√âGICA)
[Extraia das anota√ß√µes]
| Aspecto | Informa√ß√£o |
|---------|------------|
| Nicho/Segmento | [Anota√ß√µes] |
| P√∫blico-Alvo Principal | [Perfil ideal] |
| Regi√£o de Atua√ß√£o | [Local/Nacional/Internacional] |
| Ticket M√©dio | [Valor] |
| Diferenciais Competitivos | [O que destaca] |
| Principais Concorrentes | [Quem s√£o] |
| Dores do Cliente Ideal | [Problemas que resolve] |

**An√°lise:** Por que SEO √© crucial para este neg√≥cio espec√≠fico?

---

## 3Ô∏è‚É£ DIAGN√ìSTICO ATUAL DE TR√ÅFEGO ORG√ÇNICO
### Situa√ß√£o Atual (baseado nas anota√ß√µes):
| M√©trica | Situa√ß√£o Estimada | Meta Ideal |
|---------|-------------------|------------|
| Visitas org√¢nicas/m√™s | [Atual] | [Meta] |
| P√°ginas indexadas | [Atual] | [Meta] |
| Posi√ß√£o m√©dia | [Atual] | Top 10 |
| CTR org√¢nico | [Atual] | >3% |
| Bounce rate | [Atual] | <50% |

### Problemas Identificados:
- üî¥ **Cr√≠tico:** [Problemas graves]
- üü° **Aten√ß√£o:** [Problemas moderados]
- üü¢ **Oportunidade:** [Quick wins]

---

## 4Ô∏è‚É£ DIAGN√ìSTICO DE PALAVRAS-CHAVE (CORA√á√ÉO DO SEO)
### Mapeamento Estrat√©gico por Inten√ß√£o:

**üéØ PALAVRAS TRANSACIONAIS (Alta inten√ß√£o de compra):**
| Palavra-Chave | Volume Est. | Dificuldade | Prioridade | P√°gina Alvo |
|---------------|-------------|-------------|------------|-------------|
| [Termo] + pre√ßo | [Vol] | [Dif] | ALTA | /servicos |
| [Termo] + contratar | [Vol] | [Dif] | ALTA | /orcamento |
| melhor [termo] em [cidade] | [Vol] | [Dif] | ALTA | /sobre |

**üîç PALAVRAS INFORMACIONAIS (Topo de funil):**
| Palavra-Chave | Volume Est. | Tipo Conte√∫do | Objetivo |
|---------------|-------------|---------------|----------|
| como [resolver dor] | [Vol] | Blog post | Atrair leads |
| o que √© [termo do nicho] | [Vol] | Guia completo | Autoridade |
| [problema] + solu√ß√£o | [Vol] | Artigo | Nutri√ß√£o |

**üìç PALAVRAS LOCAIS (se aplic√°vel):**
| Palavra-Chave | Volume Est. | Relev√¢ncia |
|---------------|-------------|------------|
| [servi√ßo] em [cidade] | [Vol] | ALTA |
| [nicho] perto de mim | [Vol] | ALTA |

### Estrat√©gia de Long Tail:
[Liste 5-10 palavras long tail espec√≠ficas do nicho com menor concorr√™ncia]

---

## 5Ô∏è‚É£ DIAGN√ìSTICO DE ARQUITETURA SEO DO SITE
### Estrutura Ideal Recomendada:
\`\`\`
üè† HOME (palavra-chave principal)
‚îú‚îÄ‚îÄ üìã SOBRE (hist√≥ria + autoridade)
‚îÇ   ‚îî‚îÄ‚îÄ /equipe
‚îú‚îÄ‚îÄ üõ†Ô∏è SERVI√áOS (cluster principal)
‚îÇ   ‚îú‚îÄ‚îÄ /servico-1 (palavra-chave espec√≠fica)
‚îÇ   ‚îú‚îÄ‚îÄ /servico-2 (palavra-chave espec√≠fica)
‚îÇ   ‚îî‚îÄ‚îÄ /servico-3 (palavra-chave espec√≠fica)
‚îú‚îÄ‚îÄ üì∞ BLOG (conte√∫do estrat√©gico)
‚îÇ   ‚îú‚îÄ‚îÄ /categoria-1 (cluster tem√°tico)
‚îÇ   ‚îú‚îÄ‚îÄ /categoria-2 (cluster tem√°tico)
‚îÇ   ‚îî‚îÄ‚îÄ /categoria-3 (cluster tem√°tico)
‚îú‚îÄ‚îÄ üèÜ CASES/PORTF√ìLIO (prova social)
‚îú‚îÄ‚îÄ ‚ùì FAQ (featured snippets)
‚îú‚îÄ‚îÄ üìç LOCALIZA√á√ÉO (SEO local)
‚îî‚îÄ‚îÄ üìû CONTATO/OR√áAMENTO (convers√£o)
\`\`\`

### Checklist de Arquitetura:
- [ ] URLs amig√°veis e com palavras-chave
- [ ] Hierarquia clara H1 > H2 > H3
- [ ] Links internos estrat√©gicos
- [ ] Breadcrumbs implementados
- [ ] Sitemap.xml atualizado
- [ ] Robots.txt configurado

---

## 6Ô∏è‚É£ DIAGN√ìSTICO DE COPY SEO (Texto que Ranqueia e Converte)
### An√°lise por P√°gina:

**HOME:**
| Elemento | Status | Recomenda√ß√£o |
|----------|--------|--------------|
| Title Tag | [Atual] | [Ideal com palavra-chave] |
| Meta Description | [Atual] | [Ideal com CTA] |
| H1 | [Atual] | [Otimizado] |
| Densidade palavra-chave | [%] | 1-2% |
| CTA Principal | [Atual] | [Melhorado] |

**P√ÅGINAS DE SERVI√áO:**
[Mesma an√°lise para cada servi√ßo principal]

### Problemas de Copy Identificados:
- [ ] T√≠tulos sem palavras-chave
- [ ] Meta descriptions duplicadas
- [ ] Conte√∫do fino (< 300 palavras)
- [ ] Falta de CTAs claros
- [ ] Aus√™ncia de prova social

---

## 7Ô∏è‚É£ ESTRUTURA IDEAL DE COPY PARA SEO
### Template de P√°gina de Servi√ßo Otimizada:

**ACIMA DA DOBRA:**
- H1 com palavra-chave principal
- Subt√≠tulo com benef√≠cio + palavra secund√°ria
- CTA prim√°rio vis√≠vel
- Elemento de confian√ßa (selos, avalia√ß√µes)

**CORPO DO CONTE√öDO:**
\`\`\`
[Problema que resolve - 100 palavras]
[Como funciona o servi√ßo - 150 palavras]
[Benef√≠cios com bullet points - 100 palavras]
[Prova social/depoimentos]
[FAQ com schema markup - 5 perguntas]
[CTA final com urg√™ncia]
\`\`\`

### Template de Post de Blog SEO:
\`\`\`
T√≠tulo: [Palavra-chave] + [Benef√≠cio/N√∫mero]
Intro: Gancho + promessa (100 palavras)
H2: [Subt√≥pico 1 com keyword]
H2: [Subt√≥pico 2 com keyword]
H2: [Subt√≥pico 3 com keyword]
Conclus√£o: Resumo + CTA para servi√ßo
\`\`\`

---

## 8Ô∏è‚É£ DIAGN√ìSTICO DE SEO LOCAL (quando aplic√°vel)
### Google Meu Neg√≥cio:
| Elemento | Status | A√ß√£o |
|----------|--------|------|
| Perfil completo | [Sim/N√£o] | [Completar] |
| Categoria correta | [Atual] | [Ideal] |
| Fotos atualizadas | [Qtd] | M√≠n. 10 |
| Avalia√ß√µes | [Nota] | Meta: 4.5+ |
| Posts GMB | [Frequ√™ncia] | Semanal |
| Q&A respondidas | [Sim/N√£o] | Todas |

### NAP Consistency (Nome, Endere√ßo, Telefone):
- [ ] Consistente em todo o site
- [ ] Igual em todos os diret√≥rios
- [ ] Schema LocalBusiness implementado

### Cita√ß√µes Locais Priorit√°rias:
1. Google Meu Neg√≥cio
2. Facebook Business
3. LinkedIn Company
4. Yelp/TripAdvisor (se aplic√°vel)
5. Diret√≥rios do nicho

---

## 9Ô∏è‚É£ SEO T√âCNICO (Funda√ß√£o)
### Checklist T√©cnico:
| Fator | Status | Prioridade | A√ß√£o |
|-------|--------|------------|------|
| Velocidade mobile | [Score] | CR√çTICA | [A√ß√£o] |
| Core Web Vitals | [LCP/FID/CLS] | ALTA | [A√ß√£o] |
| Mobile-friendly | [Sim/N√£o] | CR√çTICA | [A√ß√£o] |
| SSL/HTTPS | [Sim/N√£o] | CR√çTICA | [A√ß√£o] |
| Sitemap.xml | [Sim/N√£o] | ALTA | [A√ß√£o] |
| Robots.txt | [Sim/N√£o] | ALTA | [A√ß√£o] |
| Schema Markup | [Tipos] | M√âDIA | [A√ß√£o] |
| Canonical tags | [Sim/N√£o] | M√âDIA | [A√ß√£o] |
| 404 pages | [Qtd] | M√âDIA | [Corrigir] |
| Redirects 301 | [Status] | M√âDIA | [A√ß√£o] |

### Schema Markup Recomendados:
- Organization
- LocalBusiness
- Product/Service
- FAQ
- Review/Rating
- Breadcrumb

---

## üîü INTEGRA√á√ÉO SEO + AN√öNCIOS + VENDAS
### Sinergia Estrat√©gica:

**SEO ‚Üí Remarketing:**
- Visitantes org√¢nicos ‚Üí Lista de remarketing
- Blog readers ‚Üí An√∫ncios de convers√£o
- P√°ginas de servi√ßo ‚Üí An√∫ncios de oferta

**SEO ‚Üí Vendas:**
| P√°gina SEO | A√ß√£o de Convers√£o | Destino CRM |
|------------|-------------------|-------------|
| Blog post | Lead magnet | Nutri√ß√£o |
| Servi√ßo | Or√ßamento | Comercial |
| Case | Contato | Qualificado |

### Funil Org√¢nico Completo:
\`\`\`
TOPO (Blog/Conte√∫do) ‚Üí MEIO (P√°ginas de Servi√ßo) ‚Üí FUNDO (Contato/Or√ßamento)
       ‚Üì                        ‚Üì                           ‚Üì
   Awareness              Considera√ß√£o                  Convers√£o
\`\`\`

---

## 1Ô∏è‚É£1Ô∏è‚É£ PLANO DE A√á√ÉO SEO (Orientado a Resultado)

### ‚ö° CURTO PRAZO (0-30 dias):
| A√ß√£o | Respons√°vel | Prazo | Impacto |
|------|-------------|-------|---------|
| Otimizar titles e metas das 5 p√°ginas principais | SEO | 7 dias | Alto |
| Corrigir problemas t√©cnicos cr√≠ticos | Dev | 14 dias | Alto |
| Configurar Google Meu Neg√≥cio | Marketing | 7 dias | Alto |
| Criar/otimizar p√°gina de cada servi√ßo | Conte√∫do | 21 dias | Alto |

### üìà M√âDIO PRAZO (30-90 dias):
| A√ß√£o | Respons√°vel | Prazo | Impacto |
|------|-------------|-------|---------|
| Publicar 4 posts de blog estrat√©gicos/m√™s | Conte√∫do | Cont√≠nuo | M√©dio |
| Implementar schema markup completo | Dev | 45 dias | M√©dio |
| Construir 5-10 backlinks de qualidade | SEO | 60 dias | Alto |
| Criar p√°gina de FAQ otimizada | Conte√∫do | 30 dias | M√©dio |

### üéØ LONGO PRAZO (90-180 dias):
| A√ß√£o | Respons√°vel | Prazo | Impacto |
|------|-------------|-------|---------|
| Dominar top 3 para palavras transacionais | SEO | 180 dias | Muito Alto |
| Criar 30+ posts estrat√©gicos | Conte√∫do | 180 dias | Alto |
| Autoridade de dom√≠nio +10 pontos | SEO | 180 dias | Alto |
| Gerar X leads org√¢nicos/m√™s | Equipe | 180 dias | Muito Alto |

---

## 1Ô∏è‚É£2Ô∏è‚É£ CONCLUS√ÉO ESTRAT√âGICA
### Resumo Executivo:
[S√≠ntese das principais descobertas e recomenda√ß√µes]

### Prioridades Imediatas:
1. **[A√ß√£o #1]** - [Por que √© urgente]
2. **[A√ß√£o #2]** - [Impacto esperado]
3. **[A√ß√£o #3]** - [Quick win]

### Proje√ß√£o de Resultados:
| Per√≠odo | Tr√°fego Org√¢nico | Leads Org√¢nicos | Posi√ß√£o M√©dia |
|---------|------------------|-----------------|---------------|
| Atual | [X] | [Y] | [Z] |
| 3 meses | [Meta] | [Meta] | [Meta] |
| 6 meses | [Meta] | [Meta] | [Meta] |
| 12 meses | [Meta] | [Meta] | [Meta] |

### KPIs de Acompanhamento:
- üìä Tr√°fego org√¢nico mensal
- üéØ Posi√ß√µes para palavras-chave alvo
- üìà Leads gerados via org√¢nico
- ‚≠ê Autoridade de dom√≠nio
- üîó Backlinks adquiridos

### ‚û°Ô∏è PR√ìXIMO PASSO
[Conex√£o com Estrat√©gias para Redes Sociais - amplificar conte√∫do SEO nas redes]`,
        prompt: `Voc√™ √© um especialista em SEO da Mediagrowth. Gere um documento de SITE & SEO.`
      },
      redes_sociais: {
        title: 'Estrat√©gias para Redes Sociais',
        weeks: ['semana3_4', 'semana5'],
        blocks: ['redes_sociais', 'conteudo_redes'],
        maxTokens: 12000,
        charts: {
          primary: 'calendar',
          secondary: 'pie',
          tertiary: 'funnel'
        },
        chartDescriptions: {
          primary: 'Calend√°rio de publica√ß√µes.',
          secondary: 'Mix de conte√∫do.',
          tertiary: 'Funil social.',
          radar: 'Performance comparativa entre redes.'
        },
        radarLabels: ['Instagram', 'LinkedIn', 'YouTube', 'TikTok', 'Facebook'],
        promptAnalise: `üì± OBJETIVO: Criar um PLANO ESTRAT√âGICO COMPLETO DE REDES SOCIAIS para gerar leads, engajamento e autoridade.

**üéì CONTEXTO DE EXPERTISE (USE INTERNAMENTE - N√ÉO MENCIONE NO RELAT√ìRIO):**
Aplique estrat√©gias de: Gary Vaynerchuk (Jab, Jab, Jab, Right Hook), Jasmine Star (Social Curator), Alex Cattoni (Copy Posse), Brendan Kane (One Million Followers), Sue B. Zimmerman (Instagram Expert). Use frameworks: Content Pillar Strategy, Engagement Loop System, Social Media Funnel, Hook-Story-Offer Framework, Platform-Specific Best Practices.

**‚ö†Ô∏è REGRA OBRIGAT√ìRIA DE MOEDA:**

**üö® REGRA SOBRE DADOS E PROJE√á√ïES:**
- ‚ùå PROIBIDO afirmar SITUA√á√ÉO ATUAL sem dados reais (ex: "Voc√™ tem X seguidores" sem ter essa info)
- ‚úÖ PERMITIDO fazer PROJE√á√ïES e METAS baseadas no nicho, contexto e anota√ß√µes
- Para dados atuais desconhecidos ‚Üí use "A coletar" ou "Diagn√≥stico necess√°rio"
- Para metas e proje√ß√µes ‚Üí pode sugerir valores realistas baseados no contexto do neg√≥cio

Verifique no "üìã Contexto do Neg√≥cio" qual moeda usar (R$ ou $). Use em TODOS os valores.

**OBJETIVO:** Criar estrat√©gia pr√°tica e humanizada para posicionar a marca, gerar leads e construir autoridade nas redes sociais.

**USE OS DADOS DAS ANOTA√á√ïES:** contexto do neg√≥cio, p√∫blico-alvo, objetivos do empres√°rio, tom de voz, posicionamento desejado.

---

## 1Ô∏è‚É£ OBJETIVO ESTRAT√âGICO DAS REDES SOCIAIS
### Por que a empresa precisa das redes sociais?
[Baseado nas anota√ß√µes e objetivos do empres√°rio]

| Pilar | Objetivo | Como Medir |
|-------|----------|------------|
| üéØ **Gera√ß√£o de Leads** | [Meta espec√≠fica] | DMs, cliques no link, convers√µes |
| üèÜ **Autoridade** | [Posicionamento desejado] | Compartilhamentos, saves, men√ß√µes |
| üí¨ **Engajamento** | [Comunidade ativa] | Coment√°rios, respostas, intera√ß√µes |
| üí∞ **Vendas** | [Convers√£o direta] | Vendas via redes, agendamentos |

### Meta Principal (pr√≥ximos 90 dias):
[Defina uma meta SMART baseada nas anota√ß√µes]

---

## 2Ô∏è‚É£ DIAGN√ìSTICO DO MOMENTO ATUAL NAS REDES
### Situa√ß√£o Atual (baseado nas anota√ß√µes):

**Presen√ßa Digital:**
| Rede | Status | Seguidores Est. | Frequ√™ncia Atual | Engajamento |
|------|--------|-----------------|------------------|-------------|
| Instagram | [Ativo/Inativo] | [Qtd] | [Posts/semana] | [Baixo/M√©dio/Alto] |
| LinkedIn | [Ativo/Inativo] | [Qtd] | [Posts/semana] | [Baixo/M√©dio/Alto] |
| YouTube | [Ativo/Inativo] | [Qtd] | [V√≠deos/m√™s] | [Baixo/M√©dio/Alto] |
| TikTok | [Ativo/Inativo] | [Qtd] | [Posts/semana] | [Baixo/M√©dio/Alto] |
| Facebook | [Ativo/Inativo] | [Qtd] | [Posts/semana] | [Baixo/M√©dio/Alto] |

### Problemas Identificados:
- üî¥ **Cr√≠tico:** [Problema grave que impede crescimento]
- üü° **Aten√ß√£o:** [Oportunidade perdida]
- üü¢ **Quick Win:** [Ajuste r√°pido de alto impacto]

### O que est√° funcionando:
[Pontos positivos identificados nas anota√ß√µes]

---

## 3Ô∏è‚É£ DEFINI√á√ÉO DE POSICIONAMENTO NAS REDES
### Como a marca quer ser percebida?
[Baseado no contexto do neg√≥cio e objetivos]

**Posicionamento Atual vs Desejado:**
| Aspecto | Hoje | Queremos Ser |
|---------|------|--------------|
| Percep√ß√£o | [Como veem] | [Como quer ser visto] |
| Diferencial | [O que faz] | [O que s√≥ voc√™ faz] |
| Emo√ß√£o | [O que sentem] | [O que devem sentir] |

### Pilares de Posicionamento:
1. **[Pilar 1]:** [Descri√ß√£o - Ex: Especialista em X]
2. **[Pilar 2]:** [Descri√ß√£o - Ex: Resultados comprovados]
3. **[Pilar 3]:** [Descri√ß√£o - Ex: Atendimento humanizado]

### Frase de Posicionamento:
> "[Empresa] ajuda [p√∫blico] a [transforma√ß√£o] atrav√©s de [m√©todo/diferencial]"

---

## 4Ô∏è‚É£ P√öBLICO-ALVO E COMPORTAMENTO NAS REDES
### Quem √© o cliente ideal nas redes?
[Use dados do PAI e anota√ß√µes]

**Perfil Demogr√°fico:**
| Caracter√≠stica | Detalhe |
|----------------|---------|
| Idade | [Faixa et√°ria] |
| G√™nero | [Predominante] |
| Localiza√ß√£o | [Regi√£o/Cidade] |
| Profiss√£o/Cargo | [Tipo] |
| Renda/Ticket | [Faixa] |

**Comportamento nas Redes:**
| Rede | Hor√°rio de Pico | Tipo de Conte√∫do Preferido | A√ß√£o mais comum |
|------|-----------------|---------------------------|-----------------|
| Instagram | [Hor√°rios] | [Reels/Carrossel/Stories] | [Curtir/Salvar/Comentar] |
| LinkedIn | [Hor√°rios] | [Artigos/Posts/V√≠deos] | [Comentar/Compartilhar] |
| YouTube | [Hor√°rios] | [Curtos/Longos] | [Inscrever/Comentar] |

### Dores que busca resolver nas redes:
1. [Dor 1 - O que pesquisa/consome]
2. [Dor 2 - Problemas que menciona]
3. [Dor 3 - Frustra√ß√µes comuns]

### O que faz seguir uma marca:
[Motivos espec√≠ficos do p√∫blico-alvo]

---

## 5Ô∏è‚É£ OBJETIVO DE CADA REDE SOCIAL
### Estrat√©gia por Plataforma:

**ÔøΩ INSTAGRAM** (Prioridade: [Alta/M√©dia/Baixa])
| Aspecto | Estrat√©gia |
|---------|-----------|
| **Objetivo** | [Ex: Gerar leads via DM e Link na Bio] |
| **Tipo de Conte√∫do** | Reels educativos, Carross√©is, Stories di√°rios |
| **Frequ√™ncia** | [X posts/semana + Stories di√°rios] |
| **Meta 90 dias** | [+X seguidores, X leads/m√™s] |

**üíº LINKEDIN** (Prioridade: [Alta/M√©dia/Baixa])
| Aspecto | Estrat√©gia |
|---------|-----------|
| **Objetivo** | [Ex: Autoridade B2B e networking] |
| **Tipo de Conte√∫do** | Posts de opini√£o, Cases, Artigos |
| **Frequ√™ncia** | [X posts/semana] |
| **Meta 90 dias** | [+X conex√µes, X leads B2B] |

**üé¨ YOUTUBE** (Prioridade: [Alta/M√©dia/Baixa])
| Aspecto | Estrat√©gia |
|---------|-----------|
| **Objetivo** | [Ex: SEO e conte√∫do evergreen] |
| **Tipo de Conte√∫do** | Tutoriais, Shorts, Lives |
| **Frequ√™ncia** | [X v√≠deos/m√™s] |
| **Meta 90 dias** | [X inscritos, X visualiza√ß√µes] |

**üéµ TIKTOK** (Prioridade: [Alta/M√©dia/Baixa])
| Aspecto | Estrat√©gia |
|---------|-----------|
| **Objetivo** | [Ex: Viraliza√ß√£o e alcance jovem] |
| **Tipo de Conte√∫do** | Trends, Bastidores, Dicas r√°pidas |
| **Frequ√™ncia** | [X v√≠deos/semana] |
| **Meta 90 dias** | [X seguidores, X views] |

---

## 6Ô∏è‚É£ ESTRAT√âGIA DE CONTE√öDO (CORA√á√ÉO DO DOCUMENTO)
### Pilares de Conte√∫do:

**üéì PILAR EDUCATIVO (40%)** - Gera autoridade
| Formato | Exemplo de Tema | Objetivo |
|---------|-----------------|----------|
| Carrossel | "5 erros que [p√∫blico] comete em [√°rea]" | Salvar + compartilhar |
| Reels | "Como [resolver problema] em 60 segundos" | Alcance + valor |
| Post | "O que ningu√©m te conta sobre [tema]" | Engajamento |

**üí¨ PILAR ENGAJAMENTO (25%)** - Cria comunidade
| Formato | Exemplo de Tema | Objetivo |
|---------|-----------------|----------|
| Stories | Enquetes, Caixinhas, Bastidores | Conex√£o |
| Reels | Trends adaptadas ao nicho | Viraliza√ß√£o |
| Post | "Voc√™ prefere A ou B?" | Coment√°rios |

**üèÜ PILAR PROVA SOCIAL (20%)** - Gera confian√ßa
| Formato | Exemplo de Tema | Objetivo |
|---------|-----------------|----------|
| Carrossel | Antes/Depois de cliente | Credibilidade |
| Reels | Depoimento em v√≠deo | Confian√ßa |
| Stories | Print de feedback | Valida√ß√£o |

**üí∞ PILAR VENDA (15%)** - Converte
| Formato | Exemplo de Tema | Objetivo |
|---------|-----------------|----------|
| Reels | "√â pra voc√™ se..." | Qualificar lead |
| Stories | Oferta + urg√™ncia | Convers√£o |
| Post | CTA direto + benef√≠cios | Venda |

---

## 7Ô∏è‚É£ ESTRUTURA DE CONTE√öDOS QUE GERAM LEADS

### üß≤ Conte√∫do Isca (Atrai):
**Roteiro de Reels Viral:**
\`\`\`
GANCHO (0-3s): [Frase pol√™mica ou curiosidade]
DESENVOLVIMENTO (3-25s): [Entrega valor real]
CTA (25-30s): "Salva e segue pra mais [tema]"
\`\`\`

**Exemplo pr√°tico para [nicho]:**
- Gancho: "Voc√™ est√° [fazendo erro] e nem sabe"
- Conte√∫do: [3 dicas pr√°ticas do nicho]
- CTA: "Comenta [palavra] que te envio [material]"

### üéØ Conte√∫do Qualificador (Filtra):
**Carrossel "√â pra voc√™ se...":**
\`\`\`
Slide 1: T√≠tulo chamativo
Slide 2-6: Crit√©rios do cliente ideal
Slide 7: "Se voc√™ marcou X+, chama no DM"
\`\`\`

### üí¨ Conte√∫do Conversor (Vende):
**Sequ√™ncia de Stories que vende:**
\`\`\`
Story 1: Dor do p√∫blico (enquete)
Story 2: Agitar a dor
Story 3: Apresentar solu√ß√£o
Story 4: Prova social
Story 5: CTA + urg√™ncia
\`\`\`

---

## 8Ô∏è‚É£ LINGUAGEM, COPY E TOM DE VOZ
### Identidade Verbal da Marca:

**Tom de Voz:**
| Aspecto | Como √â | Como N√ÉO √â |
|---------|--------|------------|
| Formalidade | [Ex: Pr√≥ximo mas profissional] | [Ex: N√£o √© informal demais] |
| Emo√ß√£o | [Ex: Inspirador e motivador] | [Ex: N√£o √© frio ou t√©cnico] |
| Personalidade | [Ex: Especialista acess√≠vel] | [Ex: N√£o √© arrogante] |

**Palavras da Marca (usar sempre):**
- [Palavra 1] - [Por que representa a marca]
- [Palavra 2] - [Por que representa a marca]
- [Palavra 3] - [Por que representa a marca]

**Palavras Proibidas (nunca usar):**
- [Palavra 1] - [Por que evitar]
- [Palavra 2] - [Por que evitar]

### Templates de Copy:

**LEGENDA EDUCATIVA:**
\`\`\`
[Gancho provocativo ou pergunta]

[Desenvolvimento com valor real - 3-5 par√°grafos curtos]

[Dica pr√°tica ou insight]

ÔøΩ [Resumo em uma frase]

[CTA: Salva, comenta, compartilha]
\`\`\`

**LEGENDA DE VENDA:**
\`\`\`
[Dor do p√∫blico em forma de pergunta]

[Agitar a dor com exemplo real]

[Apresentar a solu√ß√£o]

[Benef√≠cio principal + prova]

üëâ [CTA direto: Link na bio / Chama no DM]
\`\`\`

---

## 9Ô∏è‚É£ FREQU√äNCIA E CONSIST√äNCIA (REALIDADE DO NEG√ìCIO)
### Calend√°rio Semanal Realista:

**Considerando a capacidade do neg√≥cio:**
[Baseado nas anota√ß√µes sobre equipe e recursos]

| Dia | Instagram | LinkedIn | YouTube | TikTok |
|-----|-----------|----------|---------|--------|
| Seg | [Tipo] | [Tipo] | - | - |
| Ter | Stories | - | - | [Tipo] |
| Qua | [Tipo] | [Tipo] | - | - |
| Qui | Stories | - | [Upload] | [Tipo] |
| Sex | [Tipo] | - | - | - |
| S√°b | Stories | - | - | - |
| Dom | [Tipo] | - | - | - |

**M√≠nimo Vi√°vel (se tiver pouco tempo):**
- üì∏ Instagram: 3 posts + Stories di√°rios
- üíº LinkedIn: 2 posts por semana
- üé¨ YouTube: 1 v√≠deo quinzenal
- üéµ TikTok: Replicar Reels do Instagram

### Batching de Conte√∫do:
[Sugest√£o de como produzir em lote]

---

## üîü INTEGRA√á√ÉO REDES SOCIAIS + VENDAS
### Funil Social Completo:

\`\`\`
TOPO (Alcance)          MEIO (Engajamento)       FUNDO (Convers√£o)
    ‚îÇ                         ‚îÇ                        ‚îÇ
    ‚ñº                         ‚ñº                        ‚ñº
Reels Virais ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ Seguidor ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ Stories/DM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ Lead/Venda
    ‚îÇ                         ‚îÇ                        ‚îÇ
 Descoberta              Relacionamento            Convers√£o
\`\`\`

### Fluxo de Convers√£o:
| Etapa | A√ß√£o do Usu√°rio | A√ß√£o da Marca | Destino |
|-------|-----------------|---------------|---------|
| 1. Descoberta | V√™ Reels | Entrega valor | Seguir |
| 2. Interesse | Salva/Comenta | Responde + oferece | DM |
| 3. Considera√ß√£o | Chama no DM | Qualifica + agenda | WhatsApp/CRM |
| 4. Decis√£o | Recebe proposta | Follow-up | Venda |

### Automa√ß√µes Recomendadas:
- [ ] Resposta autom√°tica de DM com link
- [ ] Coment√°rio ‚Üí DM com material
- [ ] Link na bio ‚Üí P√°gina de captura

---

## 1Ô∏è‚É£1Ô∏è‚É£ M√âTRICAS QUE IMPORTAM (SEM VAIDADE)
### KPIs Estrat√©gicos:

**M√©tricas de Vaidade (N√ÉO focar):**
- ‚ùå N√∫mero de seguidores apenas
- ‚ùå Curtidas sem contexto
- ‚ùå Visualiza√ß√µes sem a√ß√£o

**M√©tricas que Importam (FOCAR):**
| M√©trica | O que Mede | Meta Mensal |
|---------|------------|-------------|
| **Taxa de Engajamento** | Conex√£o real | >3% |
| **Salvamentos** | Valor percebido | [Meta] |
| **Compartilhamentos** | Alcance org√¢nico | [Meta] |
| **DMs recebidas** | Interesse real | [X/m√™s] |
| **Cliques no Link** | Inten√ß√£o de a√ß√£o | [X/m√™s] |
| **Leads gerados** | Resultado real | [X/m√™s] |
| **Vendas via redes** | ROI das redes | [Valor/m√™s] |

### Dashboard de Acompanhamento:
| Semana | Alcance | Engajamento | DMs | Leads | Vendas |
|--------|---------|-------------|-----|-------|--------|
| 1 | | | | | |
| 2 | | | | | |
| 3 | | | | | |
| 4 | | | | | |

---

## 1Ô∏è‚É£2Ô∏è‚É£ PLANO DE A√á√ÉO ESTRAT√âGICO

### ‚ö° IMEDIATO (0-7 dias):
| A√ß√£o | Respons√°vel | Prazo | Impacto |
|------|-------------|-------|---------|
| Otimizar bio com CTA claro | [Quem] | 2 dias | Alto |
| Definir 3 pilares de conte√∫do | [Quem] | 3 dias | Alto |
| Criar banco de 10 ideias | [Quem] | 5 dias | M√©dio |
| Configurar link na bio | [Quem] | 2 dias | Alto |

### üìà CURTO PRAZO (7-30 dias):
| A√ß√£o | Respons√°vel | Prazo | Impacto |
|------|-------------|-------|---------|
| Publicar 12 conte√∫dos estrat√©gicos | [Quem] | 30 dias | Alto |
| Criar sequ√™ncia de Stories de venda | [Quem] | 15 dias | Alto |
| Responder 100% dos DMs em 24h | [Quem] | Cont√≠nuo | Alto |
| Testar 3 tipos de Reels | [Quem] | 21 dias | M√©dio |

### üéØ M√âDIO PRAZO (30-90 dias):
| A√ß√£o | Respons√°vel | Prazo | Impacto |
|------|-------------|-------|---------|
| Atingir meta de [X] leads/m√™s | Equipe | 60 dias | Muito Alto |
| Criar rotina de batching semanal | [Quem] | 45 dias | Alto |
| Implementar automa√ß√£o de DM | [Quem] | 60 dias | M√©dio |
| Primeira collab/parceria | [Quem] | 90 dias | M√©dio |

---

## 1Ô∏è‚É£3Ô∏è‚É£ IDEIAS DE CONTE√öDO PRONTAS
### Banco de 15 Ideias para Come√ßar:

**REELS EDUCATIVOS:**
1. "[X] erros que [p√∫blico] comete em [√°rea]"
2. "Como [resultado] em [tempo] - passo a passo"
3. "O que ningu√©m te conta sobre [tema do nicho]"
4. "Se voc√™ [situa√ß√£o], assiste at√© o final"
5. "[Mito] vs [Realidade] sobre [tema]"

**CARROSS√âIS QUE ENGAJAM:**
6. "Guia completo: [tema] para iniciantes"
7. "[X] ferramentas que uso no meu [trabalho]"
8. "Antes vs Depois: [transforma√ß√£o de cliente]"
9. "Checklist: [a√ß√£o importante do nicho]"
10. "[X] sinais de que voc√™ precisa de [servi√ßo]"

**STORIES QUE CONECTAM:**
11. Bastidores do dia a dia
12. Caixinha de perguntas sobre [tema]
13. "Um dia na vida de [profiss√£o/empresa]"
14. Enquete: "Qual seu maior desafio com [tema]?"
15. Depoimento de cliente (print ou v√≠deo)

---

## 1Ô∏è‚É£4Ô∏è‚É£ CONCLUS√ÉO ESTRAT√âGICA
### Resumo Executivo:
[S√≠ntese das principais estrat√©gias e por que funcionar√£o para este neg√≥cio espec√≠fico]

### 3 Prioridades Imediatas:
1. **[A√ß√£o #1]** - [Impacto esperado]
2. **[A√ß√£o #2]** - [Impacto esperado]
3. **[A√ß√£o #3]** - [Impacto esperado]

### Proje√ß√£o de Resultados:
| Per√≠odo | Seguidores | Engajamento | Leads | Vendas |
|---------|------------|-------------|-------|--------|
| Atual | [X] | [X%] | [X/m√™s] | [X/m√™s] |
| 30 dias | [Meta] | [Meta] | [Meta] | [Meta] |
| 90 dias | [Meta] | [Meta] | [Meta] | [Meta] |

### Mentalidade para o Sucesso:
> "Redes sociais n√£o s√£o sobre vender - s√£o sobre criar CONFIAN√áA que leva √† venda."

### ‚û°Ô∏è PR√ìXIMO PASSO
[Conex√£o com Email Marketing / CRM - nutrir leads capturados nas redes]`,
        prompt: `Voc√™ √© um social media da Mediagrowth. Gere um documento de REDES SOCIAIS.`
      },
      copywriting: {
        title: 'Copywriting Estrat√©gico',
        weeks: ['semana3_4'],
        blocks: ['copywriting', 'puv', 'pai'],
        charts: {
          primary: 'messagemap', // Mapa de mensagens
          secondary: 'triggers', // Gatilhos mentais
          tertiary: 'funnel' // Copy por etapa
        },
        radarLabels: ['Emo√ß√£o', 'L√≥gica', 'Urg√™ncia', 'Prova', 'Clareza'],
        maxTokens: 8000,
        promptAnalise: `‚úçÔ∏è OBJETIVO: Criar estrat√©gias de COPYWRITING - textos que vendem, conectam e convertem.

**ÔøΩ CONTEXTO DE EXPERTISE (USE INTERNAMENTE - N√ÉO MENCIONE NO RELAT√ìRIO):**
Aplique t√©cnicas de: Eugene Schwartz (Breakthrough Advertising), Gary Halbert (Boron Letters), Dan Kennedy (Magnetic Marketing), David Ogilvy (Confessions of an Advertising Man), Alex Cattoni (Copy Posse), Joanna Wiebe (Copyhackers). Use frameworks: AIDA, PAS (Problem-Agitate-Solution), BAB (Before-After-Bridge), 4Ps (Picture, Promise, Prove, Push), Emotional Triggers, Power Words Matrix.

**ÔøΩüåç REGRA OBRIGAT√ìRIA DE LOCALIZA√á√ÉO:**
ANTES de criar qualquer exemplo, VERIFIQUE no bloco "üìã Contexto do Neg√≥cio" qual o PA√çS de atua√ß√£o do cliente:

- ‚úÖ Se o pa√≠s for **Brasil** ou contiver "Brasil":
  - Use nomes BRASILEIROS em exemplos (Ex: Jo√£o, Maria, Pedro, Ana)
  - Use R$ (Real) para valores monet√°rios
  - Use express√µes brasileiras ("de gr√°tis", "na hora", "sem enrola√ß√£o")

- ‚úÖ Se o pa√≠s for **Estados Unidos (EUA)**, **USA** ou contiver "EUA":
  - Use nomes AMERICANOS em exemplos (Ex: John, Sarah, Michael, Emily)
  - Use $ (D√≥lar) para valores monet√°rios
  - Use express√µes americanas ("for free", "right now", "no hassle")

- ‚úÖ Para outros pa√≠ses:
  - Adapte nomes e express√µes conforme a cultura local
  - Use a moeda do pa√≠s informado

**üö® REGRA SOBRE DADOS E PROJE√á√ïES:**
- ‚ùå PROIBIDO afirmar SITUA√á√ÉO ATUAL sem dados reais (ex: "Voc√™ tem X seguidores" sem ter essa info)
- ‚úÖ PERMITIDO fazer PROJE√á√ïES e METAS baseadas no nicho, contexto e anota√ß√µes
- Para dados atuais desconhecidos ‚Üí use "A coletar" ou "Diagn√≥stico necess√°rio"
- Para metas e proje√ß√µes ‚Üí pode sugerir valores realistas baseados no contexto do neg√≥cio

---

# üìö MANUAL DE COPYWRITING ESTRAT√âGICO
## A Arte de Escrever Textos que Vendem

Este documento ensina a METODOLOGIA de copywriting - como pensar, estruturar e escrever cada palavra com inten√ß√£o estrat√©gica.

---

## PARTE 1: FUNDAMENTOS DA COMUNICA√á√ÉO PERSUASIVA

### üß† O QUE √â COPYWRITING DE VERDADE

Copywriting n√£o √© escrever bonito. √â escrever com **INTEN√á√ÉO ESTRAT√âGICA**.

**A diferen√ßa entre texto comum e copy:**
| Texto Comum | Copy Estrat√©gica |
|-------------|------------------|
| Informa | Transforma |
| Descreve | Provoca |
| Fala do produto | Fala da transforma√ß√£o |
| Espera resposta | Conduz √† a√ß√£o |

**O Princ√≠pio Fundamental:**
> "Pessoas n√£o compram produtos. Compram a vers√£o melhor de si mesmas."

### üé≠ DNA DE COMUNICA√á√ÉO DA MARCA

Com base nas anota√ß√µes, definir:

**1. ARQU√âTIPO DE MARCA:**
[Identificar o arqu√©tipo dominante: Her√≥i, S√°bio, Explorador, Rebelde, Mago, Cara Comum, Amante, Bobo da Corte, Cuidador, Criador, Governante, Inocente]

**Caracter√≠sticas do arqu√©tipo:**
- Tom de voz: [formal/informal/t√©cnico/inspirador/descontra√≠do]
- Ritmo: [frases curtas/longas/mistas]
- N√≠vel de proximidade: [voc√™/voc√™s/senhor(a)]

**2. PERSONA DE ESCRITA:**
Escreva como se voc√™ fosse: [definir persona baseada no neg√≥cio]
- Idade aparente: [X anos]
- Personalidade: [3 adjetivos]
- Como fala: [exemplo de frase t√≠pica]

**3. VOCABUL√ÅRIO ESTRAT√âGICO:**

| ‚úÖ PALAVRAS PARA USAR | ‚ùå PALAVRAS PARA EVITAR |
|-----------------------|------------------------|
| [10 palavras poderosas para o nicho] | [10 palavras gen√©ricas ou negativas] |

---

## PARTE 2: ARSENAL DE GATILHOS MENTAIS

### üß≤ OS 10 GATILHOS MAIS PODEROSOS (COM EXEMPLOS PR√ÅTICOS)

**1. ESPECIFICIDADE (O mais subestimado)**
‚ùå Gen√©rico: "Aumente suas vendas"
‚úÖ Espec√≠fico: "Aumente suas vendas em 47% nos primeiros 90 dias"

**Como aplicar para o NICHO do cliente:**
> [Escrever exemplo espec√≠fico para o cliente]

---

**2. PROVA SOCIAL**
O c√©rebro pensa: "Se outros fizeram, deve funcionar"

**3 formas de usar:**
- Num√©rica: "[X] clientes j√° transformaram..."
- Nominal: "A empresa [Nome] aumentou..."
- Categ√≥rica: "Empres√°rios como voc√™ est√£o..."

**Exemplo pr√°tico:**
> [Escrever exemplo para o cliente]

---

**3. AUTORIDADE**
O c√©rebro pensa: "Ele entende, posso confiar"

**Como construir em 3 n√≠veis:**
1. **Credenciais:** Anos de experi√™ncia, forma√ß√µes, certifica√ß√µes
2. **Resultados:** N√∫meros, casos de sucesso, antes/depois
3. **M√≠dia:** Onde foi mencionado, parcerias reconhecidas

**Frase de autoridade para o cliente:**
> [Escrever frase de autoridade]

---

**4. ESCASSEZ**
O c√©rebro pensa: "Se √© limitado, √© valioso"

**Tipos de escassez:**
- **Tempo:** "At√© sexta-feira" / "√öltimas 24h"
- **Quantidade:** "Apenas 10 vagas" / "√öltimos 3 em estoque"
- **Oportunidade:** "Primeira e √∫nica vez" / "N√£o se repetir√°"

**‚ö†Ô∏è REGRA DE OURO:** S√≥ use se for VERDADE. Escassez falsa destr√≥i credibilidade.

**Aplica√ß√£o √©tica para o cliente:**
> [Escrever exemplo de escassez real]

---

**5. RECIPROCIDADE**
O c√©rebro pensa: "Ele me deu algo, devo retribuir"

**Estrat√©gia de 3 camadas:**
1. **Gratuito:** [O que pode entregar de valor sem cobrar]
2. **Conte√∫do:** [Educa√ß√£o gratuita que posiciona como especialista]
3. **Diagn√≥stico:** [An√°lise gratuita que revela a necessidade]

---

**6. ANTECIPA√á√ÉO**
O c√©rebro pensa: "Preciso saber o que vem a seguir"

**T√©cnicas:**
- "Na pr√≥xima semana, vou revelar..."
- "O que voc√™ vai descobrir agora muda tudo..."
- "Prepare-se, porque..."

---

**7. PERTENCIMENTO**
O c√©rebro pensa: "Quero fazer parte desse grupo"

**Linguagem de comunidade:**
- "Junte-se a [X] profissionais que..."
- "Fa√ßa parte do grupo de..."
- "Seja um dos poucos que..."

---

**8. CONTRASTE**
O c√©rebro pensa: "Agora vejo a diferen√ßa"

**Estrutura:**
- ANTES: [Situa√ß√£o problem√°tica]
- DEPOIS: [Situa√ß√£o transformada]

**Exemplo para o cliente:**
> ANTES: [situa√ß√£o do p√∫blico antes]
> DEPOIS: [situa√ß√£o ap√≥s a transforma√ß√£o]

---

**9. CURIOSIDADE**
O c√©rebro pensa: "Preciso saber mais"

**T√©cnicas de loop aberto:**
- "O que voc√™ n√£o sabe sobre..."
- "O segredo por tr√°s de..."
- "A raz√£o pela qual 90% falham..."

---

**10. COMPROMISSO E COER√äNCIA**
O c√©rebro pensa: "J√° disse sim, preciso continuar"

**Micro-compromissos que funcionam:**
- "Voc√™ concorda que [X]?" (sim impl√≠cito)
- "Se voc√™ quer [resultado], continue lendo..."
- "Para quem busca [Y], a pr√≥xima linha √© crucial..."

---

## PARTE 3: FRAMEWORKS DE COPYWRITING (PASSO A PASSO)

### üèóÔ∏è FRAMEWORK 1: AIDA (O Cl√°ssico)

**A** = ATEN√á√ÉO ‚Üí Capturar em 3 segundos
**I** = INTERESSE ‚Üí Manter com relev√¢ncia
**D** = DESEJO ‚Üí Criar vontade emocional
**A** = A√á√ÉO ‚Üí Conduzir ao pr√≥ximo passo

**EXEMPLO COMPLETO PARA O CLIENTE:**

**[A] ATEN√á√ÉO (Hook):**
> [Escrever headline impactante espec√≠fica para o nicho]

**[I] INTERESSE (Desenvolvimento):**
> [Escrever 2-3 par√°grafos desenvolvendo o problema/oportunidade]

**[D] DESEJO (Benef√≠cios + Prova):**
> [Escrever 2-3 par√°grafos com transforma√ß√£o + prova social]

**[A] A√á√ÉO (CTA):**
> [Escrever CTA claro e direto]

---

### üèóÔ∏è FRAMEWORK 2: PAS (Problema-Agita√ß√£o-Solu√ß√£o)

**P** = PROBLEMA ‚Üí Identificar a dor
**A** = AGITA√á√ÉO ‚Üí Amplificar a dor
**S** = SOLU√á√ÉO ‚Üí Apresentar o al√≠vio

**EXEMPLO COMPLETO PARA O CLIENTE:**

**[P] PROBLEMA:**
> [Descrever o problema principal do p√∫blico-alvo]

**[A] AGITA√á√ÉO:**
> [Amplificar as consequ√™ncias de n√£o resolver - usar emo√ß√£o]
> "Se voc√™ continuar assim, em 6 meses..."
> "Enquanto isso, seus concorrentes est√£o..."
> "Cada dia que passa sem resolver isso significa..."

**[S] SOLU√á√ÉO:**
> [Apresentar a solu√ß√£o como al√≠vio natural - n√£o for√ßado]

---

### üèóÔ∏è FRAMEWORK 3: BAB (Before-After-Bridge)

**B** = BEFORE ‚Üí Situa√ß√£o atual (dor)
**A** = AFTER ‚Üí Situa√ß√£o desejada (prazer)
**B** = BRIDGE ‚Üí Como chegar l√° (solu√ß√£o)

**EXEMPLO COMPLETO PARA O CLIENTE:**

**[BEFORE] - Onde seu p√∫blico est√° agora:**
> [Descrever a realidade atual do p√∫blico com empatia]

**[AFTER] - Onde eles querem chegar:**
> [Pintar o cen√°rio de sucesso com detalhes sensoriais]

**[BRIDGE] - O caminho:**
> [Conectar os dois mundos com a solu√ß√£o]

---

### üèóÔ∏è FRAMEWORK 4: 4Ps (Promise-Picture-Proof-Push)

**P1** = PROMISE ‚Üí Promessa central
**P2** = PICTURE ‚Üí Imagem mental
**P3** = PROOF ‚Üí Prova irrefut√°vel
**P4** = PUSH ‚Üí Empurr√£o para a√ß√£o

**EXEMPLO COMPLETO PARA O CLIENTE:**

**[PROMISE]:**
> [Uma promessa clara e cr√≠vel]

**[PICTURE]:**
> [Descri√ß√£o sensorial do resultado - fa√ßa o leitor VISUALIZAR]
> "Imagine acordar amanh√£ e..."
> "Visualize o momento em que..."

**[PROOF]:**
> [Evid√™ncia: n√∫meros, depoimentos, garantias]

**[PUSH]:**
> [Urg√™ncia + CTA + Facilitador]

---

### üèóÔ∏è FRAMEWORK 5: QUEST (Qualify-Understand-Educate-Stimulate-Transition)

**Q** = QUALIFY ‚Üí Qualificar o leitor
**U** = UNDERSTAND ‚Üí Mostrar que entende
**E** = EDUCATE ‚Üí Educar sobre a solu√ß√£o
**S** = STIMULATE ‚Üí Estimular o desejo
**T** = TRANSITION ‚Üí Transicionar para a√ß√£o

---

## PARTE 4: T√âCNICAS AVAN√áADAS DE ESCRITA

### ‚úçÔ∏è HEADLINES QUE CAPTURAM

**F√≥rmulas comprovadas:**

1. **N√∫mero + Adjetivo + Substantivo + Promessa**
   > "7 Estrat√©gias Simples Para Dobrar Suas Vendas em 30 Dias"

2. **Como + Resultado Espec√≠fico**
   > "Como Transformar Visitantes em Clientes Sem Investir em An√∫ncios"

3. **Pergunta Provocativa**
   > "Voc√™ Est√° Cometendo Esses 3 Erros Que Afastam Clientes?"

4. **Segredo/Revela√ß√£o**
   > "O Que Top Vendedores Sabem e Nunca Contam"

5. **Antes vs Depois**
   > "De 0 a 100 Clientes: O M√©todo Que Transformou Meu Neg√≥cio"

**5 HEADLINES PRONTAS PARA O CLIENTE:**
1. > [Headline usando f√≥rmula 1]
2. > [Headline usando f√≥rmula 2]
3. > [Headline usando f√≥rmula 3]
4. > [Headline usando f√≥rmula 4]
5. > [Headline usando f√≥rmula 5]

---

### ‚úçÔ∏è HOOKS PARA PRIMEIRAS LINHAS

O hook tem 3 SEGUNDOS para funcionar. Use:

**1. Contradi√ß√£o:**
> "Tudo o que voc√™ sabe sobre [X] est√° errado."

**2. Estat√≠stica Chocante:**
> "93% dos neg√≥cios falham nos primeiros 5 anos. Este documento mostra como estar nos 7%."

**3. Hist√≥ria em 1 Linha:**
> "Eu tinha R$47 na conta quando descobri isso..."

**4. Pergunta Imposs√≠vel de Ignorar:**
> "E se eu te mostrasse exatamente como [resultado] em [tempo]?"

**5. Declara√ß√£o Ousada:**
> "Nos pr√≥ximos 5 minutos, voc√™ vai descobrir algo que pode mudar tudo."

**5 HOOKS PRONTOS PARA O CLIENTE:**
1. > [Hook 1 - espec√≠fico para o nicho]
2. > [Hook 2 - espec√≠fico para o nicho]
3. > [Hook 3 - espec√≠fico para o nicho]
4. > [Hook 4 - espec√≠fico para o nicho]
5. > [Hook 5 - espec√≠fico para o nicho]

---

### ‚úçÔ∏è CTAs QUE CONVERTEM

**Princ√≠pio:** O CTA n√£o √© um bot√£o. √â a CONCLUS√ÉO L√ìGICA de tudo que veio antes.

**Estrutura do CTA Perfeito:**
VERBO DE A√á√ÉO + BENEF√çCIO + FACILITADOR

**Exemplos por temperatura:**

**CTA para Topo de Funil (Conhecimento):**
- "Baixe o guia gratuito agora"
- "Assista √† aula de 10 minutos"
- "Receba as dicas no seu email"

**CTA para Meio de Funil (Considera√ß√£o):**
- "Agende uma an√°lise gratuita"
- "Veja como funciona na pr√°tica"
- "Compare os planos dispon√≠veis"

**CTA para Fundo de Funil (Decis√£o):**
- "Comece agora com 30 dias de garantia"
- "Garanta sua vaga antes que encerre"
- "Fale com um especialista em 2 minutos"

**5 CTAs PRONTOS PARA O CLIENTE:**
1. Topo: > [CTA topo de funil]
2. Meio: > [CTA meio de funil]
3. Fundo: > [CTA fundo de funil]
4. Urg√™ncia: > [CTA com gatilho de escassez]
5. WhatsApp: > [CTA para conversa direta]

---

### ‚úçÔ∏è TRANSI√á√ïES QUE PRENDEM

**O problema:** Perder o leitor entre par√°grafos.
**A solu√ß√£o:** Transi√ß√µes que criam curiosidade.

**Frases de transi√ß√£o poderosas:**
- "Mas isso √© s√≥ a ponta do iceberg..."
- "E aqui √© onde fica interessante..."
- "Agora, preste aten√ß√£o nisso..."
- "O que vou revelar agora pode surpreender voc√™..."
- "Mas espera, tem mais..."
- "E se eu te dissesse que..."

---

## PARTE 5: COPY POR CANAL (ADAPTA√á√ÉO ESTRAT√âGICA)

### üì± INSTAGRAM

**Bio (150 caracteres):**
[F√≥rmula: Quem voc√™ ajuda + Resultado + CTA]
> [Escrever bio completa]

**Caption (Legenda) - Estrutura:**
1. HOOK (primeira linha - parar o scroll)
2. CORPO (hist√≥ria ou valor)
3. CTA (pr√≥ximo passo)
4. HASHTAGS (estrat√©gicas)

**Modelo de Post Carrossel:**
> Slide 1: [t√≠tulo impactante - hook visual]
> Slide 2: [problema - criar identifica√ß√£o]
> Slide 3: [agravamento - amplificar]
> Slide 4: [insight 1 - come√ßar a solu√ß√£o]
> Slide 5: [insight 2 - aprofundar]
> Slide 6: [solu√ß√£o - entrega completa]
> Slide 7: [CTA - pr√≥ximo passo claro]

**Legenda Completa Pronta:**
> [Escrever legenda completa pronta para usar - 200-300 palavras]

---

### üí¨ WHATSAPP

**Regra de Ouro:** Mensagens curtas. Uma ideia por mensagem. Tom conversacional.

**Script de Primeira Abordagem (Lead Frio):**
> Mensagem 1: [Sauda√ß√£o + Como chegou at√© o lead - m√°x 2 linhas]
> Mensagem 2: [Proposta de valor em 1 linha]
> Mensagem 3: [Pergunta aberta que engaja]

**Script de Follow-up:**
> Ap√≥s 24h: [Mensagem de valor, N√ÉO cobran√ßa]
> Ap√≥s 48h: [Mensagem com novo √¢ngulo]
> Ap√≥s 72h: [√öltima tentativa com escassez real ou "porta aberta"]

**Quebra de Obje√ß√£o "Est√° Caro":**
> [Escrever 2-3 mensagens que reposicionam valor, n√£o pre√ßo]

**Quebra de Obje√ß√£o "Vou Pensar":**
> [Escrever 2-3 mensagens que criam urg√™ncia sem press√£o]

**Mensagem de Fechamento:**
> [Escrever mensagem final com CTA direto]

---

### ‚úâÔ∏è EMAIL

**Assunto (40-60 caracteres):**
[F√≥rmula: Curiosidade + Benef√≠cio OU Urg√™ncia + Personaliza√ß√£o]

**5 Assuntos Prontos:**
1. > [Assunto com curiosidade]
2. > [Assunto com benef√≠cio direto]
3. > [Assunto com urg√™ncia]
4. > [Assunto personalizado]
5. > [Assunto com n√∫mero espec√≠fico]

**Estrutura do Email Persuasivo:**
- **Linha 1:** Hook (continua a promessa do assunto)
- **Par√°grafo 1:** Empatia/Problema (mostrar que entende)
- **Par√°grafo 2:** Agita√ß√£o (consequ√™ncias de n√£o resolver)
- **Par√°grafo 3:** Solu√ß√£o (apresentar como al√≠vio)
- **Par√°grafo 4:** Prova (evid√™ncia que funciona)
- **CTA:** Claro e √∫nico
- **PS:** Gatilho extra ou lembrete de urg√™ncia

**Email de Boas-Vindas Completo:**
> [Escrever email completo - 200-400 palavras]

**Email de Oferta Completo:**
> [Escrever email completo - 300-500 palavras]

---

### üé¨ V√çDEO/REELS/STORIES

**Estrutura de V√≠deo 60 segundos:**
- 0-3s: HOOK (parar o scroll - algo inesperado)
- 3-15s: PROBLEMA (criar identifica√ß√£o)
- 15-45s: SOLU√á√ÉO (entregar valor real)
- 45-60s: CTA (pr√≥ximo passo espec√≠fico)

**5 Hooks de V√≠deo Prontos:**
1. > "[Hook provocativo para o nicho]"
2. > "[Hook com pergunta]"
3. > "[Hook com contradi√ß√£o]"
4. > "[Hook com estat√≠stica]"
5. > "[Hook com hist√≥ria]"

**Texto para Overlay (Legendas):**
> [3 textos curtos para usar em v√≠deos]

---

### üîç AN√öNCIOS PAGOS

**Facebook/Instagram Ads:**

**Headlines (5 op√ß√µes):**
1. [Headline com benef√≠cio]
2. [Headline com curiosidade]
3. [Headline com prova]
4. [Headline com urg√™ncia]
5. [Headline com pergunta]

**Copy Longa (Feed - 150-300 palavras):**
> [Escrever copy completa com hook, desenvolvimento, prova e CTA]

**Copy Curta (Stories - 2-3 linhas):**
> [Escrever copy direta e impactante]

**Google Ads:**

**Headlines (30 caracteres cada):**
1. [Headline 1 - palavra-chave]
2. [Headline 2 - benef√≠cio]
3. [Headline 3 - CTA]
4. [Headline 4 - diferencial]
5. [Headline 5 - urg√™ncia]

**Descri√ß√µes (90 caracteres cada):**
1. [Descri√ß√£o 1]
2. [Descri√ß√£o 2]

---

## PARTE 6: BIBLIOTECA DE COPIES PRONTAS

### üìã COPIES DE CAPTA√á√ÉO (Topo de Funil)

**Copy 1 - Educativa:**
> [Copy completa pronta para usar - educar e atrair]

**Copy 2 - Curiosidade:**
> [Copy completa pronta para usar - gerar interesse]

**Copy 3 - Estat√≠stica:**
> [Copy completa pronta para usar - autoridade via dados]

---

### üìã COPIES DE NUTRI√á√ÉO (Meio de Funil)

**Copy 1 - Autoridade:**
> [Copy completa que posiciona como especialista]

**Copy 2 - Prova Social:**
> [Copy completa com resultados e depoimentos]

**Copy 3 - Quebra de Obje√ß√£o:**
> [Copy completa que antecipa e resolve d√∫vidas]

---

### üìã COPIES DE CONVERS√ÉO (Fundo de Funil)

**Copy 1 - Oferta Direta:**
> [Copy completa com oferta clara e irresist√≠vel]

**Copy 2 - Escassez:**
> [Copy completa com gatilho de urg√™ncia real]

**Copy 3 - √öltima Chance:**
> [Copy completa para fechamento de campanha]

---

### üìã COPIES DE RETEN√á√ÉO (P√≥s-Venda)

**Copy 1 - Boas-Vindas:**
> [Copy para novos clientes - onboarding]

**Copy 2 - Reativa√ß√£o:**
> [Copy para clientes inativos]

**Copy 3 - Indica√ß√£o:**
> [Copy para programa de indica√ß√£o]

---

## PARTE 7: CHECKLIST DO COPYWRITER

### ‚úÖ ANTES DE PUBLICAR QUALQUER COPY:

**CLAREZA:**
‚òê O texto √© compreens√≠vel por algu√©m de 12 anos?
‚òê Cada frase tem no m√°ximo 20 palavras?
‚òê Usei palavras simples ao inv√©s de jarg√µes?
‚òê A promessa principal est√° clara?

**EMO√á√ÉO:**
‚òê O texto faz SENTIR algo? (medo, desejo, esperan√ßa, curiosidade)
‚òê H√° uma hist√≥ria ou exemplo concreto?
‚òê Usei palavras sensoriais? (ver, ouvir, sentir, tocar, saborear)
‚òê O leitor se v√™ no texto?

**PERSUAS√ÉO:**
‚òê H√° pelo menos 2 gatilhos mentais aplicados?
‚òê Os BENEF√çCIOS est√£o claros (n√£o s√≥ caracter√≠sticas)?
‚òê H√° prova social ou autoridade?
‚òê A transforma√ß√£o est√° evidente?

**A√á√ÉO:**
‚òê O CTA √© claro e espec√≠fico?
‚òê H√° senso de urg√™ncia REAL (n√£o for√ßada)?
‚òê O pr√≥ximo passo est√° √≥bvio?
‚òê S√≥ h√° UM CTA por copy?

**TOM:**
‚òê O texto soa como a marca falaria?
‚òê A linguagem √© consistente do in√≠cio ao fim?
‚òê Lendo em voz alta, soa natural?
‚òê Est√° alinhado com o arqu√©tipo definido?

---

## üìä M√âTRICAS DE COPY PARA ACOMPANHAR

| Canal | M√©trica Principal | Meta Sugerida | Como Melhorar |
|-------|-------------------|---------------|---------------|
| Email | Taxa de Abertura | >25% | Melhorar assuntos |
| Email | Taxa de Clique | >3% | Melhorar CTA |
| An√∫ncio | CTR | >1.5% | Testar headlines |
| Landing Page | Convers√£o | >3% | Revisar copy + oferta |
| WhatsApp | Taxa de Resposta | >40% | Personalizar abordagem |
| Instagram | Saves | >2% | Aumentar valor |

---

## üéØ PLANO DE A√á√ÉO EM COPYWRITING

### PR√ìXIMOS PASSOS RECOMENDADOS:

1. **HOJE:** [A√ß√£o imediata para aplicar - 1 copy espec√≠fica]
2. **ESTA SEMANA:** [A√ß√£o para os pr√≥ximos 7 dias - 3 copies para testar]
3. **ESTE M√äS:** [A√ß√£o para os pr√≥ximos 30 dias - sistema de copy completo]

---

## üí° PRINC√çPIOS FINAIS

> "Copy boa n√£o parece copy. Parece uma conversa com um amigo que entende exatamente o que voc√™ precisa."

> "Cada palavra tem um trabalho. Se n√£o est√° trabalhando, est√° atrapalhando."

> "Voc√™ n√£o est√° vendendo um produto. Est√° vendendo uma vers√£o melhor do seu cliente."

**LEMBRE-SE:** Copywriting √© ITERA√á√ÉO. Teste, me√ßa, ajuste, repita. A copy perfeita n√£o existe na primeira vers√£o - ela √© constru√≠da com dados e testes A/B.`,
        prompt: `Voc√™ √© um copywriter da Mediagrowth. Gere um documento de COPYWRITING.`
      },
      producao_conteudo: {
        title: 'Produ√ß√£o de Conte√∫do Guiada',
        weeks: ['semana5'],
        blocks: ['conteudo_redes', 'conteudo_blog', 'criativos'],
        charts: {
          primary: 'workflow', // Fluxo de produ√ß√£o
          secondary: 'types', // Tipos de v√≠deo
          tertiary: 'calendar' // Objetivos por pe√ßa
        },
        radarLabels: ['Roteiro', 'Produ√ß√£o', 'Edi√ß√£o', 'Distribui√ß√£o', 'Performance'],
        maxTokens: 8000,
        promptAnalise: `üé¨ OBJETIVO: Criar estrat√©gias de PRODU√á√ÉO DE CONTE√öDO - ideias VIRAIS, cen√°rios INUSITADOS e conte√∫dos que FURAM A BOLHA.

**ÔøΩ CONTEXTO DE EXPERTISE (USE INTERNAMENTE - N√ÉO MENCIONE NO RELAT√ìRIO):**
Aplique estrat√©gias de: MrBeast (Viral Content Formula), Alex Hormozi (Value Equation), Russell Brunson (Hook Story Offer), Gary Vee (Document Don't Create), Paddy Galloway (YouTube Strategy). Use frameworks: Pattern Interrupts, Zeigarnik Effect, Curiosity Gap, Story Arc Structure, Viral Coefficient Formula, Hook-Retain-Reward Framework.

**ÔøΩüåç REGRA OBRIGAT√ìRIA DE LOCALIZA√á√ÉO:**
ANTES de criar qualquer exemplo ou personagem, VERIFIQUE no bloco "üìã Contexto do Neg√≥cio" qual o PA√çS de atua√ß√£o do cliente:

- ‚úÖ Se o pa√≠s for **Brasil** ou contiver "Brasil":
  - Use nomes BRASILEIROS em exemplos e roteiros (Ex: Jo√£o, Maria, Pedro, Ana)
  - Use R$ (Real) para valores monet√°rios
  - Use refer√™ncias culturais brasileiras (memes, express√µes, contextos locais)

- ‚úÖ Se o pa√≠s for **Estados Unidos (EUA)**, **USA** ou contiver "EUA":
  - Use nomes AMERICANOS em exemplos e roteiros (Ex: John, Sarah, Michael, Emily)
  - Use $ (D√≥lar) para valores monet√°rios
  - Use refer√™ncias culturais americanas

- ‚úÖ Para outros pa√≠ses:
  - Adapte nomes e refer√™ncias culturais conforme o pa√≠s informado
  - Use a moeda do pa√≠s informado

**üö® REGRA SOBRE DADOS E PROJE√á√ïES:**
- ‚ùå PROIBIDO afirmar SITUA√á√ÉO ATUAL sem dados reais
- ‚úÖ PERMITIDO fazer PROJE√á√ïES e METAS baseadas no nicho e contexto
- Use informa√ß√µes das anota√ß√µes E das an√°lises j√° geradas anteriormente

---

# üé¨ LABORAT√ìRIO DE IDEIAS CRIATIVAS
## Conte√∫dos que Humanizam, Viralizam e Vendem

**FILOSOFIA:** Conte√∫do bom n√£o √© sobre voc√™. √â sobre como voc√™ faz SEU P√öBLICO se sentir.

---

## PARTE 1: DNA CRIATIVO DA MARCA

### üß¨ ARQU√âTIPO DE CONTE√öDO
[Baseado nas anota√ß√µes, definir: Qual "personagem" a marca deve ser nas redes?]

**Caracter√≠sticas do Arqu√©tipo:**
- Estilo de humor: [ir√¥nico/leve/sem humor/sarc√°stico/autodepreciativo]
- N√≠vel de exposi√ß√£o: [muito pessoal/equilibrado/mais institucional]
- Energia: [calma e reflexiva/energ√©tica e animada/s√©ria e profissional]

### üé≠ O PROTAGONISTA

Quem vai aparecer? Como essa pessoa deve se portar?

**Nome/Papel:** [identificar]
**Personalidade em c√¢mera:**
- 3 palavras que definem: [ex: aut√™ntico, direto, bem-humorado]
- Maneirismos √∫nicos: [o que torna essa pessoa memor√°vel?]
- Bord√µes potenciais: [frases que podem virar marca registrada]

### üî• A FAGULHA CRIATIVA

O que torna ESTA marca diferente de todas as outras do mesmo nicho?
> [Identificar o diferencial criativo - a "personalidade" √∫nica]

---

## PARTE 2: IDEIAS DE CEN√ÅRIOS CRIATIVOS

### üé¨ CEN√ÅRIO 1: O CL√ÅSSICO (Escrit√≥rio/Espa√ßo de Trabalho)

**Setup Visual:**
- Fundo: [descrever elementos espec√≠ficos baseados no neg√≥cio]
- Ilumina√ß√£o: [ring light frontal / luz natural lateral / duas luzes 45¬∞]
- Elementos de marca: [o que colocar que remete ao neg√≥cio]

**Tipos de conte√∫do ideais:**
- Dicas t√©cnicas diretas
- Respostas a perguntas
- Conte√∫do educativo formal

**IDEIAS INUSITADAS para este cen√°rio:**
1. [Ideia criativa espec√≠fica - descrever situa√ß√£o completa]
2. [Ideia criativa espec√≠fica]
3. [Ideia criativa espec√≠fica]

---

### üé¨ CEN√ÅRIO 2: O BASTIDOR (Processo/Making Of)

**Setup Visual:**
- Mostrar: [o que exatamente do processo pode ser filmado]
- √Çngulos: [POV primeira pessoa / c√¢mera fixa no trip√© / seguindo a√ß√£o]
- Som: [√°udio ambiente real ou narra√ß√£o?]

**Tipos de conte√∫do ideais:**
- "Um dia na vida de..."
- "Como fazemos X na pr√°tica"
- "O que ningu√©m v√™ por tr√°s de..."

**IDEIAS INUSITADAS para este cen√°rio:**
1. [Ideia criativa espec√≠fica]
2. [Ideia criativa espec√≠fica]
3. [Ideia criativa espec√≠fica]

---

### üé¨ CEN√ÅRIO 3: O INUSITADO (Locais Inesperados)

**Lugares que ningu√©m do nicho usa:**
- [Local 1 com explica√ß√£o de por que funcionaria]
- [Local 2 com explica√ß√£o]
- [Local 3 com explica√ß√£o]

**Por que funciona:** Contraste = Aten√ß√£o. O c√©rebro para quando v√™ algo fora do padr√£o.

**IDEIAS para gravar nesses locais:**
1. [Ideia espec√≠fica: o que falar + onde + como]
2. [Ideia espec√≠fica]
3. [Ideia espec√≠fica]

---

### üé¨ CEN√ÅRIO 4: O CASEIRO (Humaniza√ß√£o M√°xima)

**O que mostrar em casa:**
- [Elemento do cotidiano que conecta com o p√∫blico]
- [Momento pessoal que gera identifica√ß√£o]
- [Situa√ß√£o "real" que quebra a barreira profissional]

**CUIDADOS:** Manter limite saud√°vel - mostrar humanidade sem expor demais.

**IDEIAS para conte√∫do caseiro:**
1. [Ideia espec√≠fica]
2. [Ideia espec√≠fica]
3. [Ideia espec√≠fica]

---

## PARTE 3: BANCO DE IDEIAS VIRAIS (50 IDEIAS)

### üî• CATEGORIA 1: POL√äMICAS LEVES (Furar a bolha)
*Conte√∫dos que geram debate saud√°vel e coment√°rios*

1. **"A mentira que todo [nicho] conta"**
   > Roteiro: Hook provocativo ‚Üí revelar verdade inc√¥moda ‚Üí dar solu√ß√£o real
   > Copy AIDA: [escrever completo em 4 linhas]

2. **"Eu estava errado sobre [cren√ßa do nicho]"**
   > Roteiro: Admitir erro ‚Üí mostrar aprendizado ‚Üí nova perspectiva
   > Copy AIDA: [escrever completo]

3. **"Por que eu recuso [tipo de cliente/trabalho]"**
   > Roteiro: Declara√ß√£o forte ‚Üí justificativa ‚Üí posicionamento
   > Copy AIDA: [escrever completo]

4. **"O conselho ERRADO que todo iniciante recebe"**
   > Roteiro: Conselho comum ‚Üí por que √© problem√°tico ‚Üí o certo
   > Copy AIDA: [escrever completo]

5. **"Parei de [a√ß√£o comum] e [resultado]"**
   > Roteiro: O que fazia ‚Üí por que parou ‚Üí resultado surpreendente
   > Copy AIDA: [escrever completo]

---

### üí° CATEGORIA 2: SITUA√á√ïES INUSITADAS (Criatividade)
*Conte√∫dos que ningu√©m espera de algu√©m do seu nicho*

6. **"O que [profiss√£o inesperada] me ensinou sobre [seu nicho]"**
   > Cen√°rio: [descrever]
   > Roteiro resumido: [descrever em 3 linhas]
   > Copy AIDA: [escrever]

7. **"Resolvi [problema do nicho] usando t√©cnica de [√°rea totalmente diferente]"**
   > Cen√°rio: [descrever]
   > Roteiro resumido: [3 linhas]
   > Copy AIDA: [escrever]

8. **"Se eu perdesse tudo e tivesse que come√ßar do zero, faria isso..."**
   > Cen√°rio: [descrever]
   > Roteiro: [3 linhas]
   > Copy AIDA: [escrever]

9. **"O dia mais [adjetivo] da minha carreira"**
   > Cen√°rio: [descrever]
   > Roteiro: [3 linhas]
   > Copy AIDA: [escrever]

10. **"Gravando do [local bizarro] porque [raz√£o criativa]"**
    > Cen√°rio: [descrever local inusitado que faz sentido para o nicho]
    > Roteiro: [3 linhas]
    > Copy AIDA: [escrever]

---

### üé≠ CATEGORIA 3: HUMANIZA√á√ÉO (Conex√£o Real)
*Conte√∫dos que mostram a pessoa por tr√°s da marca*

11. **"3 coisas que eu nunca contei aqui..."**
    > Cen√°rio: Close, √≠ntimo, pessoal
    > O que revelar: [3 coisas pessoais mas apropriadas]
    > Copy AIDA: [escrever]

12. **"Minha rotina das 6h √†s 22h (vers√£o REAL)"**
    > Cen√°rio: Vlog estilo dia-a-dia
    > Roteiro: [momentos chave para mostrar]
    > Copy AIDA: [escrever]

13. **"O fracasso que me fez quem eu sou"**
    > Cen√°rio: Pessoal, reflexivo
    > Roteiro: Erro ‚Üí consequ√™ncia ‚Üí aprendizado ‚Üí quem virou
    > Copy AIDA: [escrever]

14. **"Resposta honesta: vale a pena [coisa do nicho]?"**
    > Cen√°rio: Direto para c√¢mera, sem filtro
    > Roteiro: Verdade nua e crua com nuances
    > Copy AIDA: [escrever]

15. **"O conselho que eu daria pro eu de 5 anos atr√°s"**
    > Cen√°rio: Reflexivo
    > Roteiro: Contexto passado ‚Üí erro ‚Üí conselho ‚Üí aplica√ß√£o
    > Copy AIDA: [escrever]

---

### üéØ CATEGORIA 4: VALOR DIRETO (Salvamentos)
*Conte√∫dos que as pessoas PRECISAM salvar*

16. **"Tutorial de 30 segundos: [resolver problema espec√≠fico]"**
    > Hook: "Voc√™ est√° fazendo errado..."
    > Passo a passo ultra-r√°pido
    > Copy AIDA: [escrever]

17. **"Checklist de [tema] que eu uso todo dia"**
    > Mostrar documento/lista real
    > Copy AIDA: [escrever]

18. **"Os 5 erros que [persona] comete sem perceber"**
    > Um erro por vez, r√°pido
    > Copy AIDA: [escrever]

19. **"Isso economiza [X horas/reais] por [semana/m√™s]"**
    > Dica pr√°tica com resultado quantific√°vel
    > Copy AIDA: [escrever]

20. **"Ferramenta/M√©todo que mudou minha forma de [a√ß√£o]"**
    > Demonstra√ß√£o r√°pida
    > Copy AIDA: [escrever]

---

### üé™ CATEGORIA 5: ENTRETENIMENTO INTELIGENTE (Viraliza√ß√£o)
*Conte√∫dos leves que ainda refor√ßam autoridade*

21. **"POV: Voc√™ √© um [cliente tipo] no meu escrit√≥rio"**
    > Humor com verdade
    > Copy AIDA: [escrever]

22. **"Expectativa vs Realidade de ser [profiss√£o]"**
    > Formato split screen ou transi√ß√£o
    > Copy AIDA: [escrever]

23. **"Se [situa√ß√£o absurda do nicho] fosse sincero"**
    > Com√©dia com cr√≠tica
    > Copy AIDA: [escrever]

24. **"Ranking das [X] piores coisas de [nicho]"**
    > Humor + verdade + identifica√ß√£o
    > Copy AIDA: [escrever]

25. **"Como eu explico [o que voc√™ faz] pra minha av√≥"**
    > Simplifica√ß√£o c√¥mica
    > Copy AIDA: [escrever]

---

### üí∞ CATEGORIA 6: CONVERS√ÉO SUTIL (Vendas sem vender)
*Conte√∫dos que vendem sem parecer propaganda*

26. **"Por que [cliente] escolheu [produto/servi√ßo] e n√£o a concorr√™ncia"**
    > Depoimento com storytelling
    > Copy AIDA: [escrever]

27. **"O antes e depois que eu mais me orgulho"**
    > Case real com emo√ß√£o
    > Copy AIDA: [escrever]

28. **"Quanto custa N√ÉO resolver [problema que voc√™ resolve]"**
    > C√°lculo de preju√≠zo da ina√ß√£o
    > Copy AIDA: [escrever]

29. **"A pergunta que todo cliente me faz (e a resposta)"**
    > FAQ em formato storytelling
    > Copy AIDA: [escrever]

30. **"Resultado de [X meses] trabalhando com [cliente/projeto]"**
    > Timelapse de transforma√ß√£o
    > Copy AIDA: [escrever]

---

### üì± CATEGORIA 7: TRENDS ADAPTADAS (Surfar a onda)
*Estruturas virais adaptadas ao nicho*

31. **"[Trend do momento] vers√£o [seu nicho]"**
    > [Identificar trend atual que pode adaptar]
    > Como adaptar: [explicar]

32. **"Respondendo coment√°rio com [a√ß√£o dram√°tica]"**
    > Stitch ou resposta com plot twist

33. **"Dueto com [conte√∫do viral] dando minha perspectiva"**
    > Opini√£o profissional sobre conte√∫do popular

34. **"[√Åudio viral] aplicado a [seu neg√≥cio]"**
    > Lip sync com contexto do nicho

35. **"POV com [trend atual] do meu dia-a-dia"**
    > Trend + bastidores

---

### üåü MAIS 15 IDEIAS R√ÅPIDAS:

36. "O que eu faria se tivesse apenas R$100 para [objetivo]"
37. "Red flags de [tipo de cliente/fornecedor/situa√ß√£o]"
38. "Green flags de [tipo de cliente/fornecedor/situa√ß√£o]"
39. "Mitos vs Verdades sobre [tema do nicho]"
40. "Gastei [X] em [curso/ferramenta] e aprendi [insight]"
41. "A maior obje√ß√£o que ou√ßo e como respondo"
42. "Isso √© o que diferencia [amador] de [profissional]"
43. "Mostrando minha tela: como eu [a√ß√£o do dia-a-dia]"
44. "Unboxing de [material/ferramenta de trabalho]"
45. "Tour pelo meu espa√ßo de trabalho"
46. "O que eu N√ÉO fa√ßo mais (e por qu√™)"
47. "Pedindo feedback real para [cliente/colega]"
48. "Colabora√ß√£o com [outro profissional do nicho]"
49. "Respondendo haters/cr√≠ticas com classe"
50. "Preview do que vem por a√≠ [gerar antecipa√ß√£o]"

---

## PARTE 4: FRASES PRONTAS (M√ÅXIMO 6 LINHAS CADA)

### ü™ù HOOKS MATADORES (Primeiros 3 segundos)

**Para Pol√™micas:**
1. "Vou falar uma coisa que talvez te incomode..."
2. "Isso vai irritar muita gente do meu nicho, mas..."
3. "Ningu√©m tem coragem de falar isso, ent√£o eu vou..."
4. "Voc√™ foi enganado sobre [tema] esse tempo todo."
5. "O que vou revelar agora pode mudar tudo pra voc√™."

**Para Curiosidade:**
6. "Descobri isso por acidente e mudou tudo..."
7. "O segredo que os [experts] n√£o querem que voc√™ saiba..."
8. "Existe um padr√£o que 99% das pessoas n√£o percebem..."
9. "Voc√™ nunca vai adivinhar o que aconteceu quando..."
10. "A resposta n√£o √© o que voc√™ est√° esperando..."

**Para Identifica√ß√£o:**
11. "Se voc√™ [situa√ß√£o comum], para tudo e assiste..."
12. "Voc√™ tamb√©m passa por isso ou sou s√≥ eu?"
13. "Algu√©m mais se sente assim ou t√¥ ficando louco?"
14. "Toda vez que [situa√ß√£o], eu penso [pensamento comum]..."
15. "Cansei de fingir que [verdade inconveniente]..."

**Para Autoridade:**
16. "Depois de [X anos/clientes/resultados], percebi que..."
17. "O erro que custa mais caro no [nicho] √©..."
18. "Se eu pudesse ensinar s√≥ UMA coisa, seria..."
19. "A diferen√ßa entre quem [resultado] e quem n√£o [resultado]..."
20. "Isso aqui √© o que separa [amador] de [profissional]..."

---

### üé¨ FRASES DE TRANSI√á√ÉO (Manter aten√ß√£o)

1. "Mas calma, a melhor parte vem agora..."
2. "E aqui que a m√°gica acontece..."
3. "Presta aten√ß√£o porque isso √© crucial..."
4. "Agora que voc√™ entendeu isso, olha o pr√≥ximo passo..."
5. "Mas tem um detalhe que muda tudo..."
6. "E se eu te contar que tem mais?"
7. "S√≥ que aqui mora o perigo..."
8. "Parece simples, mas olha o que acontece..."
9. "E foi a√≠ que eu descobri o verdadeiro segredo..."
10. "Mas antes de continuar, preciso te avisar..."

---

### üéØ CTAs CRIATIVOS (Gerar a√ß√£o)

1. "Salva esse v√≠deo. S√©rio. Voc√™ vai precisar."
2. "Comenta 'EU' se voc√™ se identificou."
3. "Manda pra aquela pessoa que PRECISA ver isso."
4. "Me segue antes que eu mude de ideia e apague."
5. "Deixa o like se eu ganhei sua aten√ß√£o."
6. "Comenta qual desses √© seu maior desafio."
7. "Quer a parte 2? Comenta 'QUERO'."
8. "Link na bio pra quem quer ir al√©m."
9. "Te vejo no pr√≥ximo v√≠deo. N√£o esquece de seguir."
10. "Agora me conta: voc√™ j√° passou por isso?"

---

### üí¨ FRASES PARA COPY AIDA (Legendas Prontas)

**Modelo 1 - Problema/Solu√ß√£o:**
> [A] Voc√™ est√° travado em [problema]?
> [I] A maioria tenta [solu√ß√£o errada] e continua frustrado.
> [D] Descobri um m√©todo que resolve isso em [tempo].
> [A] Comenta "QUERO" que te explico nos stories.

**Modelo 2 - Revela√ß√£o:**
> [A] Ningu√©m te conta isso sobre [tema]...
> [I] Eu passei [X tempo] fazendo errado at√© descobrir.
> [D] Agora consigo [resultado] em [tempo menor].
> [A] Salva esse post. Vai precisar.

**Modelo 3 - Hist√≥ria:**
> [A] H√° [X tempo], eu estava [situa√ß√£o ruim].
> [I] Tentei de tudo: [lista de tentativas].
> [D] At√© que [descoberta] mudou tudo.
> [A] Quer saber o que fiz? Me segue.

**Modelo 4 - Provoca√ß√£o:**
> [A] Voc√™ acha que sabe tudo sobre [tema]?
> [I] Aposto que nunca pensou em [√¢ngulo diferente].
> [D] Quem aplica isso [resultado impressionante].
> [A] Comenta se fez sentido pra voc√™.

**Modelo 5 - Valor:**
> [A] Gastei [X reais/horas] pra aprender isso.
> [I] E vou te entregar de gra√ßa em [tempo].
> [D] Quem aplicou teve [resultado espec√≠fico].
> [A] Salva e compartilha com quem precisa.

---

## PARTE 5: CALEND√ÅRIO CRIATIVO (4 SEMANAS)

### üìÖ SEMANA 1: Humaniza√ß√£o

| Dia | Tipo | Ideia Espec√≠fica | Cen√°rio | Hook |
|-----|------|------------------|---------|------|
| Seg | Story | [ideia] | [local] | [hook] |
| Ter | Reels | [ideia] | [local] | [hook] |
| Qua | Post | [ideia] | [local] | [hook] |
| Qui | Reels | [ideia] | [local] | [hook] |
| Sex | Story | [ideia] | [local] | [hook] |
| S√°b | Reels | [ideia] | [local] | [hook] |
| Dom | Post | [ideia] | [local] | [hook] |

### üìÖ SEMANA 2: Autoridade

[Mesmo formato - preencher com ideias espec√≠ficas]

### üìÖ SEMANA 3: Engajamento

[Mesmo formato - preencher com ideias espec√≠ficas]

### üìÖ SEMANA 4: Convers√£o

[Mesmo formato - preencher com ideias espec√≠ficas]

---

## PARTE 6: F√ìRMULAS DE CONTE√öDO VIRAL

### üß™ F√ìRMULA 1: CONTRASTE INESPERADO
**Estrutura:** [Expectativa comum] + [Realidade surpreendente]
**Exemplo aplicado ao cliente:** [escrever]
**Roteiro em 5 linhas:** [escrever]

### üß™ F√ìRMULA 2: HIST√ìRIA EM 3 ATOS
**Estrutura:** [Problema/Conflito] ‚Üí [Virada/Descoberta] ‚Üí [Resolu√ß√£o/Aprendizado]
**Exemplo aplicado ao cliente:** [escrever]
**Roteiro em 5 linhas:** [escrever]

### üß™ F√ìRMULA 3: O IMPOSS√çVEL
**Estrutura:** "Como [resultado dif√≠cil] em [tempo curto/condi√ß√£o adversa]"
**Exemplo aplicado ao cliente:** [escrever]
**Roteiro em 5 linhas:** [escrever]

### üß™ F√ìRMULA 4: A REVELA√á√ÉO
**Estrutura:** "O que [autoridades/maioria] n√£o quer que voc√™ saiba sobre [tema]"
**Exemplo aplicado ao cliente:** [escrever]
**Roteiro em 5 linhas:** [escrever]

### üß™ F√ìRMULA 5: O EXPERIMENTO
**Estrutura:** "Testei [coisa] por [tempo] e o resultado foi [inesperado]"
**Exemplo aplicado ao cliente:** [escrever]
**Roteiro em 5 linhas:** [escrever]

---

## PARTE 7: CHECKLIST DE CONTE√öDO CRIATIVO

### ‚úÖ ANTES DE CRIAR:

‚òê A ideia √© espec√≠fica pro MEU p√∫blico?
‚òê Resolve um problema ou gera uma emo√ß√£o?
‚òê Tem um hook nos primeiros 3 segundos?
‚òê √â diferente do que TODOS do meu nicho fazem?
‚òê Eu assistiria/leria at√© o final?
‚òê Gera vontade de comentar/compartilhar?

### ‚úÖ DURANTE A GRAVA√á√ÉO:

‚òê Estou falando COM a pessoa (n√£o para ela)?
‚òê Minha energia est√° compat√≠vel com o conte√∫do?
‚òê O cen√°rio refor√ßa a mensagem?
‚òê Frases curtas (m√°ximo 6 linhas faladas)?
‚òê Olho na c√¢mera nos momentos importantes?

### ‚úÖ ANTES DE POSTAR:

‚òê O hook prende em 1 segundo?
‚òê Tem CTA claro?
‚òê A legenda complementa (n√£o repete)?
‚òê Hashtags estrat√©gicas?
‚òê Hor√°rio ideal de postagem?

---

## üéØ PLANO DE A√á√ÉO IMEDIATO

### ESTA SEMANA:
1. **HOJE:** [1 conte√∫do espec√≠fico para gravar com roteiro pronto]
2. **AMANH√É:** [1 conte√∫do de cen√°rio diferente]
3. **PR√ìXIMOS 3 DIAS:** [3 ideias do banco para testar]

### EXPERIMENTOS PARA TESTAR:
- [ ] [Experimento 1 com hip√≥tese]
- [ ] [Experimento 2 com hip√≥tese]
- [ ] [Experimento 3 com hip√≥tese]

### M√âTRICAS PARA ACOMPANHAR:
- Qual tipo de conte√∫do gera mais SALVAMENTOS?
- Qual cen√°rio gera mais COMENT√ÅRIOS?
- Qual hook gera melhor RETEN√á√ÉO?

---

## üí° LEMBRE-SE:

> "O algoritmo recompensa quem faz as pessoas PARAREM de rolar."

> "Conte√∫do perfeito n√£o existe. Conte√∫do postado, sim."

> "Sua personalidade √© seu diferencial. Ningu√©m pode copiar VOC√ä."

> "Viralizar √© consequ√™ncia de resolver problemas reais de forma memor√°vel."`,
        prompt: `Voc√™ √© um diretor de conte√∫do da Mediagrowth. Gere um documento de PRODU√á√ÉO DE CONTE√öDO.`
      },
      criativos_anuncios: {
        title: 'Criativos para An√∫ncios Patrocinados',
        weeks: ['semana5', 'semana1_2'],
        blocks: ['criativos', 'puv', 'pai', 'benchmarks'],
        charts: {
          primary: 'formats', // Formatos por plataforma
          secondary: 'funnel', // Criativo por etapa
          tertiary: 'testing' // Matriz de testes
        },
        radarLabels: ['Visual', 'Copy', 'CTA', 'Relev√¢ncia', 'Convers√£o'],
        maxTokens: 8000,
        promptAnalise: `üé® OBJETIVO: Criar estrat√©gias de CRIATIVOS - an√∫ncios de alta performance para redes sociais.

**ÔøΩ CONTEXTO DE EXPERTISE (USE INTERNAMENTE - N√ÉO MENCIONE NO RELAT√ìRIO):**
Aplique estrat√©gias de: Ogilvy on Advertising (David Ogilvy), Claude Hopkins (Scientific Advertising), John Caples (Tested Advertising Methods), Alex Hormozi (Creative Testing), Nicholas Kusmich (H2H Marketing). Use frameworks: Thumb-Stopping Pattern Interrupts, Native Ad Design, Social Proof Integration, Benefit-Driven Headlines, Visual Hierarchy, A/B Testing Matrix, Creative Fatigue Indicators.

**ÔøΩüåç REGRA OBRIGAT√ìRIA DE LOCALIZA√á√ÉO:**
ANTES de criar qualquer exemplo ou copy, VERIFIQUE no bloco "üìã Contexto do Neg√≥cio" qual o PA√çS de atua√ß√£o do cliente:

- ‚úÖ Se o pa√≠s for **Brasil** ou contiver "Brasil":
  - Use nomes BRASILEIROS em exemplos (Ex: Jo√£o, Maria, Pedro, Ana)
  - Use R$ (Real) para valores monet√°rios
  - Use linguagem brasileira nas copies ("de gra√ßa", "na hora", "sem enrola√ß√£o")

- ‚úÖ Se o pa√≠s for **Estados Unidos (EUA)**, **USA** ou contiver "EUA":
  - Use nomes AMERICANOS em exemplos (Ex: John, Sarah, Michael, Emily)
  - Use $ (D√≥lar) para valores monet√°rios
  - Use linguagem americana nas copies ("for free", "right now", "no hassle")

- ‚úÖ Para outros pa√≠ses:
  - Adapte nomes e linguagem conforme o pa√≠s informado
  - Use a moeda do pa√≠s informado

**üö® REGRA SOBRE DADOS E PROJE√á√ïES:**
- ‚ùå PROIBIDO afirmar SITUA√á√ÉO ATUAL sem dados reais (ex: "Voc√™ tem X seguidores" sem ter essa info)
- ‚úÖ PERMITIDO fazer PROJE√á√ïES e METAS baseadas no nicho, contexto e anota√ß√µes
- Para dados atuais desconhecidos ‚Üí use "A coletar" ou "Diagn√≥stico necess√°rio"
- Para metas e proje√ß√µes ‚Üí pode sugerir valores realistas baseados no contexto do neg√≥cio


**üéØ OBJETIVO:**
Gerar um BANCO COMPLETO DE IDEIAS DE CRIATIVOS para an√∫ncios patrocinados, baseado em TODAS as informa√ß√µes coletadas nas anota√ß√µes das semanas de estrutura√ß√£o. Cada ideia deve ser espec√≠fica e adaptada √† realidade da empresa.

**IMPORTANTE:**
- Use TODAS as informa√ß√µes das anota√ß√µes (PUV, PAI, CDT, benchmarks, etc.)
- Crie ideias ESPEC√çFICAS para o nicho e p√∫blico da empresa
- Sugira refer√™ncias visuais baseadas nas fotos/v√≠deos anexados nas semanas
- Cada criativo deve ter descri√ß√£o visual detalhada + copy completa
- Adapte para cada rede social e formato

---

## üì∏ CONTE√öDOS DE REFER√äNCIA

### M√≠dias Anexadas na Semana 2 (Posicionamento e Estrutura)
> **IMPORTANTE:** Liste aqui TODAS as fotos e v√≠deos que foram anexados nas anota√ß√µes da Semana 2. Estas s√£o refer√™ncias visuais importantes que devem inspirar os criativos.

**Refer√™ncias Identificadas:**
[Liste cada m√≠dia anexada com descri√ß√£o do que cont√©m - pessoas, cen√°rios, produtos, etc.]

**Como Usar Estas Refer√™ncias:**
- [Sugest√£o de uso 1]
- [Sugest√£o de uso 2]
- [Sugest√£o de uso 3]

---

## üéØ ESTRAT√âGIA CRIATIVA GERAL

### Dire√ß√£o Criativa Principal
[Definir a linha visual e de comunica√ß√£o baseada nas anota√ß√µes - cores, estilo, tom]

### Elementos Visuais Obrigat√≥rios
- [Elemento 1 que deve aparecer em todos os criativos]
- [Elemento 2]
- [Elemento 3]

### Tom Visual
- **Estilo:** [moderno/cl√°ssico/minimalista/vibrante/etc.]
- **Paleta de Cores:** [baseado na marca]
- **Tipografia:** [sugest√µes]

---

## üì± CRIATIVOS PARA INSTAGRAM

### Feed (1080x1080 - Quadrado)

**CRIATIVO 1 - INSTITUCIONAL**
üì∑ **Descri√ß√£o Visual:**
[Descrever exatamente o que deve aparecer na imagem - cen√°rio, pessoas, elementos, cores]

‚úçÔ∏è **Copy do Criativo:**
> [Texto que aparece NA imagem]

üìù **Legenda:**
> [Texto completo da legenda]

üéØ **CTA:** [Bot√£o de a√ß√£o]
üìä **Objetivo:** Awareness

---

**CRIATIVO 2 - DOR/PROBLEMA**
üì∑ **Descri√ß√£o Visual:**
[Descrever a imagem que representa a dor do p√∫blico]

‚úçÔ∏è **Copy do Criativo:**
> [Texto impactante sobre o problema]

üìù **Legenda:**
> [Legenda que desenvolve a dor e apresenta solu√ß√£o]

üéØ **CTA:** [Bot√£o]
üìä **Objetivo:** Considera√ß√£o

---

**CRIATIVO 3 - SOLU√á√ÉO/BENEF√çCIO**
üì∑ **Descri√ß√£o Visual:**
[Imagem mostrando transforma√ß√£o/resultado]

‚úçÔ∏è **Copy do Criativo:**
> [Texto sobre benef√≠cio principal]

üìù **Legenda:**
> [Legenda vendedora]

üéØ **CTA:** [Bot√£o]
üìä **Objetivo:** Convers√£o

---

**CRIATIVO 4 - PROVA SOCIAL**
üì∑ **Descri√ß√£o Visual:**
[Depoimento visual, n√∫meros, resultados]

‚úçÔ∏è **Copy do Criativo:**
> [Texto de prova social]

üìù **Legenda:**
> [Legenda com hist√≥ria de sucesso]

üéØ **CTA:** [Bot√£o]
üìä **Objetivo:** Convers√£o

---

**CRIATIVO 5 - OFERTA/URG√äNCIA**
üì∑ **Descri√ß√£o Visual:**
[Visual de oferta com elementos de urg√™ncia]

‚úçÔ∏è **Copy do Criativo:**
> [Texto de oferta irresist√≠vel]

üìù **Legenda:**
> [Legenda com escassez]

üéØ **CTA:** [Bot√£o]
üìä **Objetivo:** Convers√£o Direta

---

### Stories/Reels (1080x1920 - Vertical)

**CRIATIVO 6 - HOOK R√ÅPIDO**
üé¨ **Tipo:** V√≠deo curto (5-15s)
üì∑ **Descri√ß√£o Visual:**
[Storyboard - o que acontece em cada segundo]

üéôÔ∏è **Roteiro/√Åudio:**
> [O que falar ou texto na tela]

üéØ **CTA:** Swipe Up / Link
üìä **Objetivo:** Tr√°fego

---

**CRIATIVO 7 - ANTES E DEPOIS**
üé¨ **Tipo:** Imagem ou v√≠deo
üì∑ **Descri√ß√£o Visual:**
[Split screen ou transi√ß√£o mostrando transforma√ß√£o]

‚úçÔ∏è **Texto na Tela:**
> [Copy curta e impactante]

üéØ **CTA:** [A√ß√£o]
üìä **Objetivo:** Considera√ß√£o

---

**CRIATIVO 8 - BASTIDORES**
üé¨ **Tipo:** V√≠deo aut√™ntico
üì∑ **Descri√ß√£o Visual:**
[Mostrar processo real, dia a dia, humaniza√ß√£o]

üéôÔ∏è **Roteiro:**
> [O que falar naturalmente]

üéØ **CTA:** [A√ß√£o]
üìä **Objetivo:** Conex√£o/Awareness

---

### Carrossel (M√∫ltiplas Imagens)

**CRIATIVO 9 - EDUCATIVO**
üì∑ **Slide 1 (Capa):** [Descri√ß√£o + copy]
üì∑ **Slide 2:** [Descri√ß√£o + copy]
üì∑ **Slide 3:** [Descri√ß√£o + copy]
üì∑ **Slide 4:** [Descri√ß√£o + copy]
üì∑ **Slide 5:** [Descri√ß√£o + copy]
üì∑ **Slide 6 (CTA):** [Descri√ß√£o + copy]

üìù **Legenda:**
> [Legenda completa]

üéØ **CTA:** Salve e Compartilhe
üìä **Objetivo:** Engajamento

---

**CRIATIVO 10 - LISTA DE BENEF√çCIOS**
üì∑ **Slide 1:** [Headline atrativa]
üì∑ **Slide 2-5:** [Um benef√≠cio por slide]
üì∑ **Slide 6:** [CTA final]

üìù **Legenda:**
> [Legenda vendedora]

---

## üìò CRIATIVOS PARA FACEBOOK

### Feed Facebook

**CRIATIVO 11 - TEXTO LONGO + IMAGEM**
üì∑ **Descri√ß√£o Visual:**
[Imagem impactante que para o scroll]

üìù **Copy Longa (200-300 palavras):**
> [Texto persuasivo completo estilo storytelling]

üéØ **CTA:** [Bot√£o]

---

**CRIATIVO 12 - V√çDEO TESTEMUNHAL**
üé¨ **Dura√ß√£o:** 30-60 segundos
üì∑ **Descri√ß√£o:**
[Cliente real contando hist√≥ria]

üéôÔ∏è **Roteiro Base:**
> [Estrutura do depoimento]

---

## üé¨ CRIATIVOS PARA YOUTUBE/GOOGLE

### YouTube Ads

**CRIATIVO 13 - BUMPER AD (6 segundos)**
üì∑ **Storyboard:**
[Segundo a segundo - muito objetivo]

üéôÔ∏è **√Åudio/Texto:**
> [Mensagem ultra condensada]

---

**CRIATIVO 14 - IN-STREAM (15-30 segundos)**
üì∑ **Estrutura:**
- 0-5s: [Hook - n√£o pode pular]
- 5-15s: [Desenvolvimento]
- 15-25s: [Benef√≠cio + Prova]
- 25-30s: [CTA forte]

üéôÔ∏è **Roteiro Completo:**
> [Script detalhado]

---

### Google Display

**CRIATIVO 15 - BANNER RESPONSIVO**
üì∑ **Elementos Visuais:**
- Logo: [posi√ß√£o]
- Imagem principal: [descri√ß√£o]
- Headline: [texto]
- Descri√ß√£o: [texto]
- CTA: [bot√£o]

---

## üéØ CRIATIVOS POR ETAPA DO FUNIL

### TOPO DE FUNIL (Awareness)
| # | Formato | Objetivo | Copy Principal |
|---|---------|----------|----------------|
| 1 | [formato] | [objetivo] | [copy] |
| 2 | [formato] | [objetivo] | [copy] |
| 3 | [formato] | [objetivo] | [copy] |

### MEIO DE FUNIL (Considera√ß√£o)
| # | Formato | Objetivo | Copy Principal |
|---|---------|----------|----------------|
| 1 | [formato] | [objetivo] | [copy] |
| 2 | [formato] | [objetivo] | [copy] |
| 3 | [formato] | [objetivo] | [copy] |

### FUNDO DE FUNIL (Convers√£o)
| # | Formato | Objetivo | Copy Principal |
|---|---------|----------|----------------|
| 1 | [formato] | [objetivo] | [copy] |
| 2 | [formato] | [objetivo] | [copy] |
| 3 | [formato] | [objetivo] | [copy] |

---

## üß™ MATRIZ DE TESTES A/B

### Teste 1: Headlines
| Vers√£o A | Vers√£o B | Hip√≥tese |
|----------|----------|----------|
| [Headline emocional] | [Headline racional] | [O que espera] |

### Teste 2: Visuais
| Vers√£o A | Vers√£o B | Hip√≥tese |
|----------|----------|----------|
| [Pessoa real] | [Produto/resultado] | [O que espera] |

### Teste 3: CTAs
| Vers√£o A | Vers√£o B | Hip√≥tese |
|----------|----------|----------|
| [CTA direto] | [CTA suave] | [O que espera] |

### Teste 4: Formatos
| Vers√£o A | Vers√£o B | Hip√≥tese |
|----------|----------|----------|
| [Imagem est√°tica] | [V√≠deo] | [O que espera] |

---

## üí° BANCO DE IDEIAS EXTRAS

### 10 Headlines para Testar
1. [Headline 1]
2. [Headline 2]
3. [Headline 3]
4. [Headline 4]
5. [Headline 5]
6. [Headline 6]
7. [Headline 7]
8. [Headline 8]
9. [Headline 9]
10. [Headline 10]

### 10 Hooks para V√≠deos
1. [Hook 1]
2. [Hook 2]
3. [Hook 3]
4. [Hook 4]
5. [Hook 5]
6. [Hook 6]
7. [Hook 7]
8. [Hook 8]
9. [Hook 9]
10. [Hook 10]

### 5 √Çngulos de Comunica√ß√£o
1. **[√Çngulo 1]:** [Como usar]
2. **[√Çngulo 2]:** [Como usar]
3. **[√Çngulo 3]:** [Como usar]
4. **[√Çngulo 4]:** [Como usar]
5. **[√Çngulo 5]:** [Como usar]

---

## ‚úÖ CHECKLIST DE PRODU√á√ÉO

### Para Cada Criativo
- [ ] Visual alinhado com identidade da marca
- [ ] Copy revisada e persuasiva
- [ ] CTA claro e objetivo
- [ ] Formatos corretos para cada plataforma
- [ ] Legendas complementares prontas
- [ ] Varia√ß√µes para teste A/B

---

## üöÄ PR√ìXIMOS PASSOS

1. [A√ß√£o imediata 1 - qual criativo produzir primeiro]
2. [A√ß√£o imediata 2]
3. [A√ß√£o imediata 3]
4. [A√ß√£o imediata 4]
5. [A√ß√£o imediata 5]`,
        prompt: `Voc√™ √© um designer de performance da Mediagrowth. Gere um documento de CRIATIVOS.`
      },
      crm_automacoes: {
        title: 'CRM e Automa√ß√µes',
        weeks: ['semana5', 'semana1', 'semana1_2'],
        blocks: ['crm', 'entendimento_negocio', 'estrutura_time', 'pai'],
        charts: {
          primary: 'pipeline', // Pipeline de vendas
          secondary: 'conversion', // Convers√£o por etapa
          tertiary: 'timeline' // Tempo de resposta
        },
        radarLabels: ['Organiza√ß√£o', 'Automa√ß√£o', 'Follow-up', 'An√°lise', 'Integra√ß√£o'],
        maxTokens: 8000,
        promptAnalise: `üîß OBJETIVO: Estruturar CRM E AUTOMA√á√ÉO COMERCIAL - sistemas de vendas de alta performance.

**ÔøΩ CONTEXTO DE EXPERTISE (USE INTERNAMENTE - N√ÉO MENCIONE NO RELAT√ìRIO):**
Aplique estrat√©gias de: Jill Konrath (SNAP Selling), Mike Weinberg (New Sales Simplified), Aaron Ross (Predictable Revenue), Steli Efti (Close CRM Philosophy), Ryan Levesque (Ask Method). Use frameworks: Lead Scoring Matrix, Pipeline Velocity Optimization, Sales Cadence Design, Conversion Rate Benchmarking, Customer Lifecycle Stages, Automated Nurture Sequences.

**ÔøΩüåç REGRA OBRIGAT√ìRIA DE LOCALIZA√á√ÉO:**
ANTES de criar scripts e mensagens, VERIFIQUE no bloco "üìã Contexto do Neg√≥cio" qual o PA√çS de atua√ß√£o do cliente:

- ‚úÖ Se o pa√≠s for **Brasil**:
  - Use nomes BRASILEIROS em exemplos (Ex: Jo√£o, Maria, Pedro)
  - Use R$ (Real) para valores monet√°rios
  - Use linguagem brasileira ("Ol√°", "Tudo bem?", "Vamos conversar?")

- ‚úÖ Se o pa√≠s for **Estados Unidos (EUA)**:
  - Use nomes AMERICANOS em exemplos (Ex: John, Sarah, Michael)
  - Use $ (D√≥lar) para valores monet√°rios
  - Use linguagem americana ("Hi", "How are you?", "Let's talk?")

**ÔøΩ CR√çTICO: NUNCA CONFUNDA CAC COM CPL**

No CRM, rastreie corretamente:

**CPL (Custo Por Lead):**
- Quanto custou para o lead ENTRAR no CRM
- Campo: "Origem" (Meta Ads, Google, Instagram)
- M√©trica para: avaliar ROI de cada canal

**CAC (Custo de Aquisi√ß√£o de Cliente):**
- Custo total at√© o lead virar CLIENTE
- Soma: CPL + custo operacional de vendas
- M√©trica para: calcular lucratividade real

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
100 leads ‚Üí CPL R$ 30 ‚Üí Investimento R$ 3.000
‚îú‚îÄ 20 qualificados
‚îú‚îÄ 10 propostas
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

**Campo "CAC" no CRM = custo total √∑ vendas fechadas**
**Campo "CPL" no CRM = investimento √∑ leads gerados**

**ÔøΩüö® REGRA SOBRE DADOS E PROJE√á√ïES:**
- ‚ùå PROIBIDO afirmar SITUA√á√ÉO ATUAL sem dados reais (ex: "Voc√™ tem X seguidores" sem ter essa info)
- ‚úÖ PERMITIDO fazer PROJE√á√ïES e METAS baseadas no nicho, contexto e anota√ß√µes
- Para dados atuais desconhecidos ‚Üí use "A coletar" ou "Diagn√≥stico necess√°rio"
- Para metas e proje√ß√µes ‚Üí pode sugerir valores realistas baseados no contexto do neg√≥cio


**üéØ OBJETIVO:**
Criar um DOCUMENTO COMPLETO DE IMPLEMENTA√á√ÉO DE CRM E AUTOMA√á√ïES dividido em duas partes principais:
1. **ESTRUTURA√á√ÉO DO CRM** - Como organizar o sistema para m√°ximo sucesso de vendas
2. **AUTOMA√á√ïES INTELIGENTES** - Fluxos automatizados de comunica√ß√£o com clientes

**IMPORTANTE:**
- Baseie TUDO nas informa√ß√µes espec√≠ficas da empresa coletadas nas semanas
- Crie scripts e mensagens REAIS e PERSONALIZADAS para o nicho
- Considere o p√∫blico-alvo (PAI) definido nas anota√ß√µes
- Seja espec√≠fico com tempos, gatilhos e a√ß√µes

---

# üìä PARTE 1: ESTRUTURA√á√ÉO DO CRM

## üéØ Vis√£o Geral do Sistema

### Diagn√≥stico do Processo Atual
[Analisar com base nas anota√ß√µes como est√° o processo comercial atual]

### Objetivo do CRM
[Definir claramente o que o CRM deve resolver para esta empresa]

---

## üîÑ ESTRUTURA DO PIPELINE DE VENDAS

### Pipeline Principal - Novos Leads

| Etapa | Nome da Etapa | Crit√©rio de Entrada | A√ß√£o Obrigat√≥ria | Tempo M√°ximo |
|-------|---------------|---------------------|------------------|--------------|
| 1 | üÜï Novo Lead | Lead entrou no sistema | Contato em at√© X min | X horas |
| 2 | üìû Em Contato | Primeira resposta do lead | Qualificar interesse | X horas |
| 3 | ‚úÖ Qualificado | Lead demonstrou interesse real | Agendar reuni√£o/apresenta√ß√£o | X dias |
| 4 | üìã Proposta Enviada | Reuni√£o realizada | Enviar proposta formal | X horas |
| 5 | ü§ù Em Negocia√ß√£o | Proposta analisada pelo lead | Follow-up de fechamento | X dias |
| 6 | ‚úîÔ∏è Fechado Ganho | Contrato assinado/pagamento | Onboarding | - |
| 7 | ‚ùå Fechado Perdido | Descartado/n√£o comprou | Registrar motivo | - |

### Regras de Movimenta√ß√£o
1. **Novo Lead ‚Üí Em Contato:** [Crit√©rio espec√≠fico]
2. **Em Contato ‚Üí Qualificado:** [Crit√©rio espec√≠fico]
3. **Qualificado ‚Üí Proposta:** [Crit√©rio espec√≠fico]
4. **Proposta ‚Üí Negocia√ß√£o:** [Crit√©rio espec√≠fico]
5. **Negocia√ß√£o ‚Üí Ganho/Perdido:** [Crit√©rio espec√≠fico]

---

## üìã CAMPOS OBRIGAT√ìRIOS NO CRM

### Dados do Lead
| Campo | Tipo | Obrigat√≥rio | Uso |
|-------|------|-------------|-----|
| Nome completo | Texto | ‚úÖ | Identifica√ß√£o |
| WhatsApp | Telefone | ‚úÖ | Contato principal |
| Email | Email | ‚ö†Ô∏è | Comunica√ß√£o formal |
| Origem | Lista | ‚úÖ | Rastrear canal |
| Data de entrada | Data | ‚úÖ Autom√°tico | Controle |

### Dados de Qualifica√ß√£o
| Campo | Tipo | Obrigat√≥rio | Uso |
|-------|------|-------------|-----|
| Interesse principal | Lista | ‚úÖ | Segmenta√ß√£o |
| Or√ßamento | Faixa de valor | ‚ö†Ô∏è | Qualifica√ß√£o |
| Urg√™ncia | 1-5 | ‚ö†Ô∏è | Prioriza√ß√£o |
| Obje√ß√£o principal | Lista | ‚ö†Ô∏è | Tratamento |

### Campos Personalizados para [Nicho]
| Campo | Tipo | Obrigat√≥rio | Uso |
|-------|------|-------------|-----|
| [Campo espec√≠fico 1] | [Tipo] | [Sim/N√£o] | [Uso] |
| [Campo espec√≠fico 2] | [Tipo] | [Sim/N√£o] | [Uso] |
| [Campo espec√≠fico 3] | [Tipo] | [Sim/N√£o] | [Uso] |

---

## ÔøΩ M√âTRICAS E KPIs DO CRM

### M√©tricas de Entrada
| M√©trica | F√≥rmula | Meta Sugerida |
|---------|---------|---------------|
| Leads/dia | Total leads √∑ dias | [X leads/dia] |
| Custo por Lead | Investimento √∑ leads | R$ [X] |
| Leads qualificados | Qualificados √∑ total | [X]% |

### M√©tricas de Pipeline
| M√©trica | F√≥rmula | Meta Sugerida |
|---------|---------|---------------|
| Taxa de convers√£o geral | Fechados √∑ total | [X]% |
| Tempo m√©dio de fechamento | Soma dias √∑ vendas | [X] dias |
| Ticket m√©dio | Faturamento √∑ vendas | R$ [X] |

### M√©tricas de Perda
| M√©trica | F√≥rmula | Meta Sugerida |
|---------|---------|---------------|
| Taxa de perda | Perdidos √∑ total | < [X]% |
| Principal motivo de perda | [Identificar] | Reduzir [X]% |

---

## üè∑Ô∏è SISTEMA DE TAGS E SEGMENTA√á√ÉO

### Tags de Origem
- üîµ **instagram** - Veio do Instagram
- üü¢ **whatsapp** - Contato direto WhatsApp
- üî¥ **google** - An√∫ncio Google
- üü° **indicacao** - Indica√ß√£o de cliente
- üü£ **site** - Formul√°rio do site

### Tags de Perfil
- üí∞ **alto_ticket** - Potencial alto valor
- ‚ö° **urgente** - Precisa resolver r√°pido
- üî• **quente** - Muito interessado
- ‚ùÑÔ∏è **frio** - Apenas pesquisando
- ‚≠ê **vip** - Cliente especial

### Tags de Status
- üìû **aguardando_contato** - Ainda n√£o falamos
- üí¨ **em_conversa** - Negocia√ß√£o ativa
- üìã **proposta_enviada** - Aguardando resposta
- üîÑ **reativar** - Lead antigo para retomar

---

## üìà RELAT√ìRIOS SEMANAIS

### Relat√≥rio de Entrada
- Total de novos leads na semana
- Origem dos leads (distribui√ß√£o %)
- Custo por lead por canal
- Comparativo semana anterior

### Relat√≥rio de Pipeline
- Leads em cada etapa
- Movimenta√ß√µes da semana
- Leads parados (sem atividade)
- Previs√£o de fechamento

### Relat√≥rio de Resultados
- Vendas fechadas na semana
- Faturamento total
- Taxa de convers√£o
- Motivos de perda

---

# ‚ö° PARTE 2: AUTOMA√á√ïES INTELIGENTES

## üì± FLUXO DE AUTOMA√á√ÉO WHATSAPP

### Automa√ß√£o 1: Boas-Vindas (Imediato)
**Gatilho:** Novo lead entra no sistema
**Tempo:** Imediato (0-2 minutos)
**Mensagem:**
\`\`\`
Ol√°, [NOME]! üëã

Tudo bem? Aqui √© [NOME DO ATENDENTE] da [EMPRESA].

Vi que voc√™ demonstrou interesse em [PRODUTO/SERVI√áO]. Que bom ter voc√™ aqui! üéâ

Para eu te ajudar melhor, me conta: qual √© a sua principal necessidade hoje?

Estou aqui para te ajudar! üòä
\`\`\`

### Automa√ß√£o 2: Follow-up 1 (Ap√≥s 4 horas sem resposta)
**Gatilho:** Lead n√£o respondeu mensagem inicial
**Tempo:** 4 horas ap√≥s √∫ltima mensagem
**Mensagem:**
\`\`\`
Oi, [NOME]! 

S√≥ passando para ver se voc√™ recebeu minha mensagem anterior üòä

Sei que a rotina √© corrida, mas fico √† disposi√ß√£o quando puder me responder!

Posso te ajudar com alguma d√∫vida sobre [PRODUTO/SERVI√áO]?
\`\`\`

### Automa√ß√£o 3: Follow-up 2 (Ap√≥s 24 horas)
**Gatilho:** Ainda sem resposta ap√≥s follow-up 1
**Tempo:** 24 horas ap√≥s √∫ltima mensagem
**Mensagem:**
\`\`\`
[NOME], tudo bem?

Percebi que ainda n√£o conseguimos conversar. Sem problemas!

Separei um [MATERIAL/INFORMA√á√ÉO] especial sobre [BENEF√çCIO PRINCIPAL] que pode te interessar:

[LINK ou INFO]

Quando tiver um tempinho, √© s√≥ me chamar! üôå
\`\`\`

### Automa√ß√£o 4: Follow-up 3 (Ap√≥s 48 horas)
**Gatilho:** √öltima tentativa antes de esfriar
**Tempo:** 48 horas ap√≥s √∫ltima mensagem
**Mensagem:**
\`\`\`
Oi [NOME]!

Essa √© minha √∫ltima mensagem por agora, n√£o quero te incomodar üòÖ

Mas fica registrado aqui: sempre que precisar de [SOLU√á√ÉO], √© s√≥ me chamar!

Vou deixar seu contato salvo e qualquer novidade especial, te aviso.

Cuida-se! üí™
\`\`\`

### Automa√ß√£o 5: P√≥s-Proposta (Ap√≥s envio)
**Gatilho:** Proposta/or√ßamento enviado
**Tempo:** 24 horas ap√≥s envio
**Mensagem:**
\`\`\`
Oi [NOME]! 

Espero que voc√™ tenha conseguido analisar a proposta que enviei üìã

Ficou alguma d√∫vida? Posso esclarecer qualquer ponto!

Se preferir, podemos fazer uma call r√°pida de 10 minutos para eu explicar os detalhes. O que acha?
\`\`\`

### Automa√ß√£o 6: Urg√™ncia/Escassez (Opcional)
**Gatilho:** Lead qualificado h√° mais de 5 dias
**Tempo:** 5 dias ap√≥s qualifica√ß√£o
**Mensagem:**
\`\`\`
[NOME], passando rapidinho! 

[INSERIR GATILHO DE URG√äNCIA ESPEC√çFICO DO NEG√ìCIO]

Exemplo: "Os valores especiais que conversamos s√£o v√°lidos at√© [DATA]"
Ou: "Temos apenas [X] vagas dispon√≠veis este m√™s"

Me avisa se posso contar contigo? üöÄ
\`\`\`

---

## üìß AUTOMA√á√ïES DE EMAIL (Se aplic√°vel ao nicho)

### Email 1: Boas-Vindas
**Assunto:** Bem-vindo(a)! Seu pr√≥ximo passo com a [EMPRESA] üéâ
**Conte√∫do:**
\`\`\`
Ol√° [NOME],

Que bom ter voc√™ aqui!

[Par√°grafo sobre a empresa e o que ela resolve]

[Par√°grafo sobre pr√≥ximos passos]

[CTA claro]

Abra√ßos,
[ASSINATURA]
\`\`\`

### Email 2: Nutri√ß√£o (Valor)
**Assunto:** [X] dicas de [TEMA] que v√£o te ajudar
**Conte√∫do:**
\`\`\`
[Email educativo com dicas relevantes para o nicho]
\`\`\`

### Email 3: Case de Sucesso
**Assunto:** Como [CLIENTE] conseguiu [RESULTADO]
**Conte√∫do:**
\`\`\`
[Email com hist√≥ria de sucesso de cliente]
\`\`\`

### Email 4: Oferta
**Assunto:** [OFERTA IRRESIST√çVEL] s√≥ para voc√™
**Conte√∫do:**
\`\`\`
[Email de convers√£o com oferta especial]
\`\`\`

---

## üîî AUTOMA√á√ïES DE NOTIFICA√á√ÉO INTERNA

### Notifica√ß√£o 1: Novo Lead Quente
**Gatilho:** Lead marcado como "quente" ou "urgente"
**A√ß√£o:** Notificar respons√°vel imediatamente
**Canais:** WhatsApp do vendedor + Email

### Notifica√ß√£o 2: Lead Parado
**Gatilho:** Lead sem atividade h√° 3 dias
**A√ß√£o:** Alerta para retomar contato
**Canais:** Notifica√ß√£o no CRM + Email di√°rio

### Notifica√ß√£o 3: Proposta Vencendo
**Gatilho:** Proposta enviada h√° mais de 5 dias
**A√ß√£o:** Lembrete de follow-up
**Canais:** Notifica√ß√£o no CRM

### Notifica√ß√£o 4: Meta do Dia
**Gatilho:** Di√°rio √†s 9h
**A√ß√£o:** Resumo de tarefas pendentes
**Canais:** Email + WhatsApp

---

## üìä FLUXOGRAMA DE AUTOMA√á√ïES

\`\`\`
[LEAD ENTRA]
     ‚Üì
[BOAS-VINDAS IMEDIATA]
     ‚Üì
   Respondeu? 
   ‚îú‚îÄ‚îÄ SIM ‚Üí [QUALIFICA√á√ÉO MANUAL]
   ‚îÇ            ‚Üì
   ‚îÇ         Qualificado?
   ‚îÇ         ‚îú‚îÄ‚îÄ SIM ‚Üí [PROPOSTA]
   ‚îÇ         ‚îÇ            ‚Üì
   ‚îÇ         ‚îÇ         [FOLLOW-UP P√ìS-PROPOSTA]
   ‚îÇ         ‚îÇ            ‚Üì
   ‚îÇ         ‚îÇ         Fechou?
   ‚îÇ         ‚îÇ         ‚îú‚îÄ‚îÄ SIM ‚Üí [ONBOARDING]
   ‚îÇ         ‚îÇ         ‚îî‚îÄ‚îÄ N√ÉO ‚Üí [PERDIDO + MOTIVO]
   ‚îÇ         ‚îÇ
   ‚îÇ         ‚îî‚îÄ‚îÄ N√ÉO ‚Üí [NUTRI√á√ÉO + REATIVA√á√ÉO FUTURA]
   ‚îÇ
   ‚îî‚îÄ‚îÄ N√ÉO ‚Üí [FOLLOW-UP 1 - 4h]
              ‚Üì
            Respondeu?
            ‚îú‚îÄ‚îÄ SIM ‚Üí [QUALIFICA√á√ÉO MANUAL]
            ‚îî‚îÄ‚îÄ N√ÉO ‚Üí [FOLLOW-UP 2 - 24h]
                        ‚Üì
                      Respondeu?
                      ‚îú‚îÄ‚îÄ SIM ‚Üí [QUALIFICA√á√ÉO MANUAL]
                      ‚îî‚îÄ‚îÄ N√ÉO ‚Üí [FOLLOW-UP 3 - 48h]
                                  ‚Üì
                                [LEAD FRIO - REATIVA√á√ÉO MENSAL]
\`\`\`

---

## ‚è∞ SLA DE ATENDIMENTO

| A√ß√£o | Tempo M√°ximo | Respons√°vel |
|------|--------------|-------------|
| Primeiro contato (novo lead) | 5 minutos | Automa√ß√£o + Vendedor |
| Resposta a mensagem | 30 minutos (hor√°rio comercial) | Vendedor |
| Envio de proposta ap√≥s reuni√£o | 24 horas | Vendedor |
| Follow-up p√≥s-proposta | 48 horas | Automa√ß√£o + Vendedor |
| Registro de atividade no CRM | Imediato | Vendedor |

---

## üõ†Ô∏è FERRAMENTAS RECOMENDADAS

### CRM
- [Sugerir ferramenta baseada no porte/nicho: Kommo, Pipedrive, HubSpot, etc.]

### Automa√ß√£o WhatsApp
- [Sugerir ferramenta: Kommo, Manychat, etc.]

### Email Marketing
- [Sugerir ferramenta: ActiveCampaign, Mailchimp, RD Station, etc.]

### Integra√ß√µes
- [Zapier, Make, n8n para conectar sistemas]

---

## üöÄ PLANO DE IMPLEMENTA√á√ÉO

### Semana 1: Configura√ß√£o Base
- [ ] Criar conta no CRM escolhido
- [ ] Configurar pipeline de vendas
- [ ] Cadastrar campos personalizados
- [ ] Importar contatos existentes

### Semana 2: Automa√ß√µes B√°sicas
- [ ] Configurar mensagem de boas-vindas
- [ ] Criar fluxo de follow-up
- [ ] Testar automa√ß√µes com leads de teste

### Semana 3: Refinamento
- [ ] Ajustar mensagens baseado em feedback
- [ ] Configurar relat√≥rios autom√°ticos
- [ ] Treinar equipe no novo processo

### Semana 4: Opera√ß√£o Plena
- [ ] Monitorar m√©tricas
- [ ] Otimizar taxas de convers√£o
- [ ] Documentar aprendizados

---

## üí° PR√ìXIMOS PASSOS IMEDIATOS

1. [A√ß√£o espec√≠fica 1 para esta empresa]
2. [A√ß√£o espec√≠fica 2]
3. [A√ß√£o espec√≠fica 3]
4. [A√ß√£o espec√≠fica 4]
5. [A√ß√£o espec√≠fica 5]`,
        prompt: `Voc√™ √© um especialista em automa√ß√£o da Mediagrowth. Gere um documento de CRM.`
      },
      processo_comercial: {
        title: 'Estrutura√ß√£o do Processo Comercial',
        weeks: ['semana1', 'semana1_2', 'semana5'],
        blocks: ['entendimento_negocio', 'estrutura_time', 'pai', 'puv', 'crm'],
        charts: {
          primary: 'pipeline', // Pipeline comercial
          secondary: 'losspoints', // Pontos de perda
          tertiary: 'cycle' // Ciclo de vendas
        },
        radarLabels: ['Prospec√ß√£o', 'Qualifica√ß√£o', 'Apresenta√ß√£o', 'Negocia√ß√£o', 'Fechamento'],
        maxTokens: 8000,
        promptAnalise: `üíº OBJETIVO: Estruturar PROCESSO COMERCIAL - times comerciais de alta performance.

**ÔøΩ CONTEXTO DE EXPERTISE (USE INTERNAMENTE - N√ÉO MENCIONE NO RELAT√ìRIO):**
Aplique metodologias de: Neil Rackham (SPIN Selling), Matthew Dixon (Challenger Sale), Chet Holmes (Ultimate Sales Machine), Grant Cardone (10X Rule), Jordan Belfort (Straight Line Persuasion). Use frameworks: BANT Qualification, MEDDIC/MEDDPICC, Value Selling, Consultative Selling, Objection Handling Matrix, Sales Playbook Structure, Win/Loss Analysis.

**ÔøΩüåç REGRA OBRIGAT√ìRIA DE LOCALIZA√á√ÉO:**
ANTES de criar scripts e exemplos, VERIFIQUE no bloco "üìã Contexto do Neg√≥cio" qual o PA√çS de atua√ß√£o do cliente:

- ‚úÖ Se o pa√≠s for **Brasil**:
  - Use nomes BRASILEIROS em exemplos de vendedores e clientes (Ex: Jo√£o Vendedor falando com Maria Cliente)
  - Use R$ (Real) para valores monet√°rios
  - Use linguagem de vendas brasileira

- ‚úÖ Se o pa√≠s for **Estados Unidos (EUA)**:
  - Use nomes AMERICANOS em exemplos (Ex: John Sales Rep falando com Sarah Customer)
  - Use $ (D√≥lar) para valores monet√°rios
  - Use linguagem de vendas americana

**ÔøΩ CR√çTICO: NUNCA CONFUNDA CAC COM CPL**

No processo comercial, use corretamente:

**CAC (Custo de Aquisi√ß√£o de Cliente):**
- Custo total at√© FECHAR A VENDA
- Inclui: marketing + vendas + comiss√µes
- Usado para: calcular rentabilidade da opera√ß√£o comercial

**CPL (Custo Por Lead):**
- Custo apenas para GERAR O LEAD
- Inclui: somente investimento em marketing/tr√°fego
- Usado para: avaliar efici√™ncia de capta√ß√£o

**Na an√°lise do funil:**
- Lead gerado ‚Üí entra no CRM (custo = CPL)
- Lead qualificado ‚Üí conversa iniciada
- Proposta enviada ‚Üí em negocia√ß√£o
- Venda fechada ‚Üí cliente ganho (custo total = CAC)

**Taxa de convers√£o = Vendas √∑ Leads (N√ÉO use CAC aqui)**

**ÔøΩüö® REGRA SOBRE DADOS E PROJE√á√ïES:**
- ‚ùå PROIBIDO afirmar SITUA√á√ÉO ATUAL sem dados reais (ex: "Voc√™ tem X seguidores" sem ter essa info)
- ‚úÖ PERMITIDO fazer PROJE√á√ïES e METAS baseadas no nicho, contexto e anota√ß√µes
- Para dados atuais desconhecidos ‚Üí use "A coletar" ou "Diagn√≥stico necess√°rio"
- Para metas e proje√ß√µes ‚Üí pode sugerir valores realistas baseados no contexto do neg√≥cio


**üéØ OBJETIVO:**
Criar um DOCUMENTO COMPLETO DE REESTRUTURA√á√ÉO DO PROCESSO COMERCIAL que transforme o time de vendas em uma m√°quina de convers√£o afiada e persuasiva. Tudo baseado nas informa√ß√µes coletadas nas semanas de estrutura√ß√£o.

**IMPORTANTE:**
- Analise os gargalos REAIS baseados nas anota√ß√µes
- Crie scripts COMPLETOS e PERSONALIZADOS para o nicho
- Considere o PAI (P√∫blico-Alvo Ideal) definido
- Considere a PUV (Proposta √önica de Valor) definida
- Seja espec√≠fico com tempos, processos e a√ß√µes

---

# üìä DIAGN√ìSTICO DO PROCESSO ATUAL

## üîç An√°lise da Situa√ß√£o Atual
[Analisar baseado nas anota√ß√µes como est√° o processo comercial hoje]

### Pontos Fortes Identificados
1. [Ponto forte 1 baseado nas anota√ß√µes]
2. [Ponto forte 2]
3. [Ponto forte 3]

### Gargalos e Problemas Cr√≠ticos
| # | Gargalo | Impacto | Urg√™ncia | Solu√ß√£o Proposta |
|---|---------|---------|----------|------------------|
| 1 | [Gargalo 1] | [Alto/M√©dio/Baixo] | [Imediato/Curto/M√©dio prazo] | [Solu√ß√£o] |
| 2 | [Gargalo 2] | [Impacto] | [Urg√™ncia] | [Solu√ß√£o] |
| 3 | [Gargalo 3] | [Impacto] | [Urg√™ncia] | [Solu√ß√£o] |
| 4 | [Gargalo 4] | [Impacto] | [Urg√™ncia] | [Solu√ß√£o] |
| 5 | [Gargalo 5] | [Impacto] | [Urg√™ncia] | [Solu√ß√£o] |

---

# ÔøΩÔ∏è MAPEAMENTO DA JORNADA DE COMPRA

## Etapas da Jornada do Cliente

### 1Ô∏è‚É£ DESCOBERTA (Awareness)
**O cliente percebe que tem um problema/necessidade**
- **Como ele nos encontra:** [Canais baseados nas anota√ß√µes]
- **O que ele busca:** [Informa√ß√µes iniciais]
- **Nosso papel:** [Como atra√≠mos]
- **Conte√∫do ideal:** [Tipo de conte√∫do]

### 2Ô∏è‚É£ CONSIDERA√á√ÉO (Interest)
**O cliente busca solu√ß√µes para o problema**
- **O que ele pesquisa:** [Compara√ß√µes, reviews]
- **D√∫vidas principais:** [Liste as d√∫vidas comuns]
- **Nosso papel:** [Como nos posicionamos]
- **Conte√∫do ideal:** [Tipo de conte√∫do]

### 3Ô∏è‚É£ DECIS√ÉO (Decision)
**O cliente avalia fornecedores**
- **Crit√©rios de decis√£o:** [O que ele considera]
- **Obje√ß√µes nesta fase:** [Liste obje√ß√µes]
- **Nosso papel:** [Como diferenciamos]
- **Conte√∫do ideal:** [Propostas, cases]

### 4Ô∏è‚É£ COMPRA (Action)
**O cliente decide comprar**
- **Gatilhos de compra:** [O que faz ele decidir]
- **Fric√ß√µes comuns:** [O que impede a compra]
- **Nosso papel:** [Como facilitamos]
- **A√ß√£o ideal:** [Fechamento]

### 5Ô∏è‚É£ P√ìS-VENDA (Loyalty)
**O cliente vira promotor**
- **Expectativas:** [O que ele espera ap√≥s comprar]
- **Oportunidades:** [Upsell, indica√ß√µes]
- **Nosso papel:** [Como encantamos]
- **A√ß√£o ideal:** [Fideliza√ß√£o]

---

# üéØ QUALIFICA√á√ÉO DE LEADS

## Framework de Qualifica√ß√£o: BANT+

### Crit√©rios de Qualifica√ß√£o

| Crit√©rio | Pergunta-Chave | Lead Qualificado | Lead Desqualificado |
|----------|----------------|------------------|---------------------|
| **B**udget (Or√ßamento) | "Voc√™ j√° tem uma ideia de investimento para isso?" | Tem verba reservada ou consegue | Sem verba e sem previs√£o |
| **A**uthority (Autoridade) | "Voc√™ √© quem decide ou tem mais algu√©m?" | Decide sozinho ou influencia | Apenas pesquisando para outro |
| **N**eed (Necessidade) | "Qual problema voc√™ precisa resolver?" | Problema claro e urgente | N√£o sabe o que precisa |
| **T**imeline (Prazo) | "Para quando voc√™ precisa disso funcionando?" | Prazo definido (< 30 dias) | "Um dia", "quando der" |
| **+** Fit (Perfil) | "Conta mais sobre seu neg√≥cio" | Perfil ideal (PAI) | Fora do perfil ideal |

### Pontua√ß√£o de Leads (Lead Scoring)

| A√ß√£o/Caracter√≠stica | Pontos |
|---------------------|--------|
| Solicitou contato/or√ßamento | +30 |
| Respondeu em at√© 1h | +20 |
| Tem urg√™ncia declarada | +25 |
| Perfil ideal (PAI) | +25 |
| Or√ßamento adequado | +20 |
| Decide sozinho | +15 |
| Veio por indica√ß√£o | +20 |
| J√° conhece a empresa | +10 |
| Apenas "curioso" | -20 |
| Sem or√ßamento | -30 |
| Fora do perfil | -40 |

### Classifica√ß√£o por Pontua√ß√£o
| Pontua√ß√£o | Classifica√ß√£o | A√ß√£o |
|-----------|---------------|------|
| 80-100+ | üî• HOT | Prioridade m√°xima - Contato imediato |
| 60-79 | üü° WARM | Alta prioridade - Contato em at√© 2h |
| 40-59 | üü¢ MEDIUM | M√©dia prioridade - Contato em at√© 24h |
| 20-39 | ‚ùÑÔ∏è COLD | Baixa prioridade - Nutri√ß√£o autom√°tica |
| < 20 | ‚õî DESQUALIFICADO | N√£o investir tempo comercial |

---

# üìã RECEBIMENTO E TEMPO DE RESPOSTA

## Processo de Entrada de Leads

### Fluxo de Recebimento
\`\`\`
[LEAD ENTRA]
     ‚Üì
[NOTIFICA√á√ÉO IMEDIATA] ‚Üí Vendedor + Gestor
     ‚Üì
[PRIMEIRO CONTATO] ‚Üí M√°ximo 5 minutos
     ‚Üì
[QUALIFICA√á√ÉO R√ÅPIDA] ‚Üí Perguntas BANT (3-5 min)
     ‚Üì
   Qualificado?
   ‚îú‚îÄ‚îÄ SIM ‚Üí [AGENDAMENTO/PROPOSTA]
   ‚îî‚îÄ‚îÄ N√ÉO ‚Üí [NUTRI√á√ÉO AUTOM√ÅTICA]
\`\`\`

### SLA de Tempo de Resposta

| Situa√ß√£o | Tempo M√°ximo | Respons√°vel | Consequ√™ncia se Atrasar |
|----------|--------------|-------------|------------------------|
| Novo lead (hor√°rio comercial) | 5 minutos | Vendedor da vez | Alerta ao gestor |
| Novo lead (fora do hor√°rio) | Pr√≥xima abertura + 30min | Primeiro dispon√≠vel | Revis√£o de escala |
| Resposta a d√∫vida | 30 minutos | Vendedor respons√°vel | Alerta autom√°tico |
| Envio de proposta | 2 horas ap√≥s reuni√£o | Vendedor | Cobran√ßa do gestor |
| Follow-up p√≥s-proposta | 24 horas | Vendedor | Alerta no CRM |

### Escala de Atendimento
| Hor√°rio | Segunda a Sexta | S√°bado | Domingo |
|---------|-----------------|--------|---------|
| 08h-12h | [Vendedor A] | [Escala] | [Se aplic√°vel] |
| 12h-14h | [Vendedor B] | - | - |
| 14h-18h | [Vendedor A] | - | - |
| 18h-20h | [Plant√£o - se aplic√°vel] | - | - |

---

# üí¨ SCRIPTS DE ATENDIMENTO E VENDAS

## Script 1: Primeiro Contato (Novo Lead)

### Abertura (Rapport)
\`\`\`
"Ol√°, [NOME]! Tudo bem?

Aqui √© o/a [SEU NOME] da [EMPRESA]. Vi que voc√™ entrou em contato sobre [PRODUTO/SERVI√áO].

Que bom falar com voc√™! Posso te ajudar agora ou prefere que eu ligue em outro momento?"
\`\`\`

### Qualifica√ß√£o R√°pida
\`\`\`
"Perfeito! Para eu entender melhor como te ajudar, me conta rapidinho:

1. O que te motivou a buscar [PRODUTO/SERVI√áO] agora?
   [ESCUTAR]

2. Voc√™ j√° tem alguma experi√™ncia com [SOLU√á√ÉO SIMILAR]?
   [ESCUTAR]

3. E para quando voc√™ gostaria de ter isso funcionando?
   [ESCUTAR]
\`\`\`

### Transi√ß√£o para Apresenta√ß√£o
\`\`\`
"Entendi perfeitamente! Pelo que voc√™ me contou, a gente consegue te ajudar sim.

Deixa eu te explicar rapidinho como funciona e depois a gente v√™ se faz sentido pra voc√™, combinado?"
\`\`\`

---

## Script 2: Apresenta√ß√£o da Solu√ß√£o

### Estrutura AIDA

**ATEN√á√ÉO:**
\`\`\`
"[NOME], voc√™ sabia que [DADO IMPACTANTE DO MERCADO/NICHO]?

A maioria das pessoas/empresas que nos procura est√° passando exatamente pelo que voc√™ descreveu: [REPETIR DOR DO CLIENTE]."
\`\`\`

**INTERESSE:**
\`\`\`
"O que a gente faz aqui na [EMPRESA] √© [PUV - Proposta √önica de Valor em uma frase].

Diferente de [CONCORRENTES], a gente [DIFERENCIAL 1], [DIFERENCIAL 2] e [DIFERENCIAL 3]."
\`\`\`

**DESEJO:**
\`\`\`
"Imagina voc√™ [RESULTADO DESEJADO] em [PRAZO]?

A gente tem clientes que [CASE DE SUCESSO RESUMIDO]."
\`\`\`

**A√á√ÉO:**
\`\`\`
"E olha, considerando tudo que voc√™ me contou, eu consigo [OFERTA ESPECIAL/CONDI√á√ÉO].

O que voc√™ acha de a gente [PR√ìXIMO PASSO]?"
\`\`\`

---

## Script 3: Contorno de Obje√ß√µes

### "Est√° caro" / "N√£o tenho or√ßamento"
\`\`\`
"Entendo, [NOME]. Investimento √© sempre uma preocupa√ß√£o v√°lida.

Me ajuda a entender: quando voc√™ diz que est√° caro, √© em rela√ß√£o a qu√™? A outro fornecedor, ou ao momento financeiro mesmo?

[SE FOR COMPARA√á√ÉO]
Olha, o que acontece √© que [EXPLICAR DIFERENCIAL QUE JUSTIFICA O PRE√áO].
Se a gente comparar [RESULTADO], na verdade voc√™ est√° investindo [VALOR] para conseguir [RETORNO].

[SE FOR MOMENTO]
Entendi. E se a gente parcela em [X vezes], fica em [VALOR/M√äS]. Isso caberia no seu or√ßamento?
\`\`\`

### "Preciso pensar" / "Vou analisar"
\`\`\`
"Claro, [NOME]! Decis√£o importante merece reflex√£o mesmo.

S√≥ pra eu te ajudar nessa an√°lise: o que exatamente voc√™ ainda precisa avaliar? √â sobre [OP√á√ÉO 1], [OP√á√ÉO 2] ou outra coisa?

[ESCUTAR E RESPONDER]

Olha, e que tal a gente marcar uma liga√ß√£o r√°pida amanh√£/[DIA], tipo 10 minutinhos, s√≥ pra eu tirar qualquer d√∫vida que surgir? Assim voc√™ decide com mais seguran√ßa."
\`\`\`

### "Tenho que falar com [s√≥cio/esposa/financeiro]"
\`\`\`
"Perfeito, √© importante mesmo alinhar com [PESSOA].

Me conta: ele(a) j√° conhece a situa√ß√£o ou voc√™ vai apresentar agora?

[SE N√ÉO CONHECE]
Que tal a gente fazer uma call r√°pida com voc√™s dois? Assim eu explico direitinho e tiro as d√∫vidas de voc√™s na hora. Fica mais f√°cil pra voc√™s decidirem juntos!

Quando seria um bom hor√°rio pra voc√™s dois?
\`\`\`

### "Vou pesquisar outros fornecedores"
\`\`\`
"Faz total sentido comparar! Decis√£o inteligente.

Olha, j√° que voc√™ vai pesquisar, deixa eu te dar uma dica do que olhar:

1. [CRIT√âRIO 1 - onde voc√™ √© forte]
2. [CRIT√âRIO 2 - onde voc√™ √© forte]
3. [CRIT√âRIO 3 - onde voc√™ √© forte]

E depois me conta o que voc√™ encontrou? Posso te ajudar a comparar. Inclusive, se voc√™ achar algo melhor, sem problema - o importante √© voc√™ fazer a melhor escolha!"
\`\`\`

---

## Script 4: Follow-up Estrat√©gico

### Follow-up 1 (24h ap√≥s proposta)
\`\`\`
"Oi, [NOME]! Tudo bem?

Passando para ver se voc√™ conseguiu analisar a proposta que enviei ontem.

Ficou alguma d√∫vida? Posso esclarecer qualquer ponto!"
\`\`\`

### Follow-up 2 (48h - com valor agregado)
\`\`\`
"[NOME], lembrei de voc√™!

Estava vendo um case aqui de um cliente nosso do mesmo segmento que o seu, e o resultado foi [RESULTADO ESPEC√çFICO].

Pensei que poderia te interessar. Quer que eu te mande?

Ali√°s, como est√° a an√°lise da proposta?"
\`\`\`

### Follow-up 3 (5 dias - urg√™ncia suave)
\`\`\`
"Oi, [NOME]!

Sei que a semana √© corrida, mas queria te dar um toque:

[GATILHO DE URG√äNCIA REAL - ex: "os valores especiais que conversamos s√£o v√°lidos at√© X" ou "o pr√≥ximo slot de implementa√ß√£o √© s√≥ m√™s que vem"]

Consigo te ajudar a fechar essa semana? üöÄ"
\`\`\`

---

## Script 5: Fechamento

### Fechamento Direto (Lead quente)
\`\`\`
"[NOME], pelo que conversamos, parece que [SOLU√á√ÉO] resolve exatamente o que voc√™ precisa, certo?

Ent√£o vamos fazer o seguinte: eu preparo tudo aqui e te mando o link/contrato pra voc√™ finalizar. Posso fazer isso agora?"
\`\`\`

### Fechamento Alternativo
\`\`\`
"[NOME], a gente tem duas op√ß√µes que encaixam bem no que voc√™ precisa:

**Op√ß√£o A:** [Descrever - geralmente a mais completa]
**Op√ß√£o B:** [Descrever - mais acess√≠vel]

Qual dessas faz mais sentido pra voc√™ come√ßar?"
\`\`\`

### Fechamento com Resumo
\`\`\`
"Ent√£o, resumindo o que a gente combinou:

‚úÖ [Item 1]
‚úÖ [Item 2]
‚úÖ [Item 3]
üí∞ Investimento: [VALOR] em [CONDI√á√ÉO]
üìÖ In√≠cio: [DATA]

Est√° tudo certo? Posso gerar o contrato/link de pagamento?"
\`\`\`

---

# üìÑ PROPOSTA COMERCIAL PADRONIZADA

## Estrutura da Proposta

### Capa
- Logo da empresa
- "Proposta Comercial"
- Nome do cliente
- Data

### Se√ß√£o 1: Entendimento
\`\`\`
"Entendemos que [NOME DA EMPRESA/CLIENTE] busca [OBJETIVO PRINCIPAL] e enfrenta desafios como [PROBLEMA 1] e [PROBLEMA 2].

Nossa proposta foi elaborada considerando [CONTEXTO ESPEC√çFICO DO CLIENTE]."
\`\`\`

### Se√ß√£o 2: Solu√ß√£o
\`\`\`
"Para atender √†s suas necessidades, propomos:

**[NOME DA SOLU√á√ÉO/PACOTE]**

O que est√° incluso:
‚úÖ [Item 1]
‚úÖ [Item 2]
‚úÖ [Item 3]
‚úÖ [Item 4]
‚úÖ [Item 5]

Diferenciais:
üéØ [Diferencial 1]
üéØ [Diferencial 2]
üéØ [Diferencial 3]
\`\`\`

### Se√ß√£o 3: Investimento
\`\`\`
üí∞ **Investimento:**

| Item | Valor |
|------|-------|
| [Servi√ßo/Produto] | R$ [X] |
| [Adicional se houver] | R$ [X] |
| **Total** | **R$ [X]** |

**Condi√ß√µes de Pagamento:**
- √Ä vista: R$ [X] (desconto de X%)
- Parcelado: [X]x de R$ [X]
- Recorrente: R$ [X]/m√™s

*Proposta v√°lida at√© [DATA]*
\`\`\`

### Se√ß√£o 4: Pr√≥ximos Passos
\`\`\`
üìã **Como Contratar:**

1. Aceite desta proposta
2. [Passo 2]
3. [Passo 3]
4. In√≠cio do projeto: [PRAZO]

Para d√∫vidas: [CONTATO]
\`\`\`

---

# üìä PLANO DE A√á√ÉO PARA IMPLEMENTA√á√ÉO

## Semana 1: Estrutura√ß√£o
- [ ] Definir pipeline no CRM
- [ ] Criar campos de qualifica√ß√£o
- [ ] Configurar alertas de tempo de resposta
- [ ] Treinar equipe nos novos scripts

## Semana 2: Documenta√ß√£o
- [ ] Padronizar proposta comercial
- [ ] Criar banco de obje√ß√µes e respostas
- [ ] Documentar processo no manual
- [ ] Testar fluxo completo

## Semana 3: Opera√ß√£o
- [ ] Iniciar com novos leads
- [ ] Monitorar tempos de resposta
- [ ] Ajustar scripts conforme feedback
- [ ] Revisar m√©tricas diariamente

## Semana 4: Otimiza√ß√£o
- [ ] Analisar resultados
- [ ] Identificar novos gargalos
- [ ] Refinar processo
- [ ] Celebrar vit√≥rias üéâ

---

# üí° PR√ìXIMOS PASSOS IMEDIATOS

1. [A√ß√£o espec√≠fica 1 - mais urgente]
2. [A√ß√£o espec√≠fica 2]
3. [A√ß√£o espec√≠fica 3]
4. [A√ß√£o espec√≠fica 4]
5. [A√ß√£o espec√≠fica 5]`,
        prompt: `Voc√™ √© um consultor comercial da Mediagrowth. Gere um documento de PROCESSO COMERCIAL.`
      },
      landing_pages: {
        title: 'Landing Pages Estrat√©gicas',
        weeks: ['semana3_4', 'semana5', 'semana1_2'],
        blocks: ['site_seo', 'copywriting', 'puv', 'pai', 'crm'],
        charts: {
          primary: 'wireframe', // Estrutura da p√°gina
          secondary: 'hotspots', // Pontos de convers√£o
          tertiary: 'testing' // Testes A/B
        },
        radarLabels: ['Copy', 'Design', 'Velocidade', 'Mobile', 'Convers√£o'],
        maxTokens: 8000,
        promptAnalise: `üìÑ OBJETIVO: Criar estrat√©gias de LANDING PAGES - p√°ginas de alta performance para Google Ads e Meta Ads.

**üéì CONTEXTO DE EXPERTISE (USE INTERNAMENTE - N√ÉO MENCIONE NO RELAT√ìRIO):**
Aplique estrat√©gias de: Oli Gardner (Unbounce/Landing Page Optimization), Tim Ash (Conversion Rate Optimization), Peep Laja (CXL Institute), Bryan Eisenberg (Persuasion Architecture), Talia Wolf (Emotional Targeting). Use frameworks: Attention Ratio, Visual Hierarchy, Conversion Centered Design, Hick's Law, F-Pattern & Z-Pattern, Above the Fold Optimization, Progressive Disclosure.

**‚ö†Ô∏è REGRA OBRIGAT√ìRIA DE MOEDA:**

**üö® REGRA SOBRE DADOS E PROJE√á√ïES:**
- ‚ùå PROIBIDO afirmar SITUA√á√ÉO ATUAL sem dados reais (ex: "Voc√™ tem X seguidores" sem ter essa info)
- ‚úÖ PERMITIDO fazer PROJE√á√ïES e METAS baseadas no nicho, contexto e anota√ß√µes
- Para dados atuais desconhecidos ‚Üí use "A coletar" ou "Diagn√≥stico necess√°rio"
- Para metas e proje√ß√µes ‚Üí pode sugerir valores realistas baseados no contexto do neg√≥cio

Antes de gerar qualquer valor monet√°rio, VERIFIQUE no bloco "üìã Contexto do Neg√≥cio" das anota√ß√µes qual moeda o cliente utiliza (R$ Real ou $ D√≥lar/USD). 
- Se encontrar "d√≥lar", "USD", "dollar" ou "$" no contexto ‚Üí Use $ (d√≥lar americano)
- Se encontrar "real", "reais", "BRL" ou "R$" no contexto ‚Üí Use R$ (real brasileiro)  
- Se n√£o estiver especificado ‚Üí Pergunte ou use R$ como padr√£o
TODOS os valores monet√°rios do relat√≥rio devem seguir a moeda identificada.


**üéØ OBJETIVO:**
Criar at√© 3 LANDING PAGES COMPLETAS com estrutura profissional, copy persuasiva usando t√©cnica AIDA, formul√°rios de qualifica√ß√£o, CTAs estrat√©gicos e funis de convers√£o. Tudo otimizado para m√°xima convers√£o em campanhas de tr√°fego pago.

**IMPORTANTE:**
- Use as informa√ß√µes do PAI, PUV e anota√ß√µes para personalizar
- Cada LP deve ter copy COMPLETA e pronta para usar
- Inclua formul√°rios com campos de qualifica√ß√£o
- Crie funis p√≥s-convers√£o (ap√≥s preencher, o que acontece?)
- Foque em convers√£o m√°xima para Google Ads e Meta Ads

---

# üéØ ESTRAT√âGIA DE LANDING PAGES

## Vis√£o Geral do Projeto

### Objetivo Principal
[Definir baseado nas anota√ß√µes - captura de leads, vendas diretas, agendamentos, etc.]

### P√∫blico-Alvo das LPs
[Resumo do PAI definido nas anota√ß√µes]

### Proposta de Valor Central
[PUV definida nas anota√ß√µes]

---

## üìä Matriz de Landing Pages

| LP | Nome | Objetivo | P√∫blico | CTA Principal | Canal |
|----|------|----------|---------|---------------|-------|
| 1 | [Nome] | [Captura/Venda/Agendamento] | [Segmento] | [A√ß√£o] | Google/Meta |
| 2 | [Nome] | [Objetivo] | [Segmento] | [A√ß√£o] | [Canal] |
| 3 | [Nome] | [Objetivo] | [Segmento] | [A√ß√£o] | [Canal] |

---

# üìÑ LANDING PAGE 1: [NOME DA LP]

## üéØ Informa√ß√µes Estrat√©gicas

| Item | Detalhe |
|------|---------|
| **Objetivo** | [Captura de leads/Venda/Agendamento] |
| **Canal Principal** | [Google Ads / Meta Ads] |
| **P√∫blico** | [Segmento espec√≠fico do PAI] |
| **Promessa Principal** | [Uma frase] |
| **CTA Principal** | [Bot√£o/Formul√°rio/WhatsApp] |

---

## üì± ESTRUTURA COMPLETA DA P√ÅGINA

### üîù SE√á√ÉO 1: HERO (Above the Fold)

**Layout:**
\`\`\`
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  [LOGO]                          [Tel/WhatsApp] ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                 ‚îÇ
‚îÇ  HEADLINE PRINCIPAL                             ‚îÇ
‚îÇ  (Aten√ß√£o - Promessa clara)                     ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  Subheadline explicativa                        ‚îÇ
‚îÇ  (Interesse - Benef√≠cio expandido)             ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  ‚úÖ Benef√≠cio 1  ‚úÖ Benef√≠cio 2  ‚úÖ Benef√≠cio 3 ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  [    BOT√ÉO CTA PRINCIPAL    ]                  ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê "X clientes satisfeitos"             ‚îÇ
‚îÇ                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
\`\`\`

**COPY COMPLETA:**

**Headline (ATEN√á√ÉO):**
> [Escrever headline completa - m√°ximo 10 palavras - impacto direto]

**Subheadline (INTERESSE):**
> [Escrever subheadline completa - expandir a promessa - 20-30 palavras]

**Bullets de Benef√≠cios:**
> ‚úÖ [Benef√≠cio 1 - curto e direto]
> ‚úÖ [Benef√≠cio 2 - curto e direto]
> ‚úÖ [Benef√≠cio 3 - curto e direto]

**CTA Button:**
> [Texto do bot√£o - verbo de a√ß√£o + benef√≠cio]

**Prova Social R√°pida:**
> ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê [N√∫mero] clientes [resultado]

---

### üî¥ SE√á√ÉO 2: PROBLEMA/DOR

**Layout:**
\`\`\`
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                                                 ‚îÇ
‚îÇ  "Voc√™ tamb√©m passa por isso?"                  ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  ‚ùå [Dor 1 - situa√ß√£o frustrante]               ‚îÇ
‚îÇ  ‚ùå [Dor 2 - consequ√™ncia negativa]             ‚îÇ
‚îÇ  ‚ùå [Dor 3 - medo/preocupa√ß√£o]                  ‚îÇ
‚îÇ  ‚ùå [Dor 4 - perda/preju√≠zo]                    ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  "Se voc√™ se identificou, temos a solu√ß√£o..."   ‚îÇ
‚îÇ                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
\`\`\`

**COPY COMPLETA:**

**T√≠tulo da Se√ß√£o:**
> [Pergunta que gera identifica√ß√£o]

**Lista de Dores:**
> ‚ùå [Dor 1 - descrever situa√ß√£o espec√≠fica do p√∫blico]
> ‚ùå [Dor 2 - consequ√™ncia de n√£o resolver]
> ‚ùå [Dor 3 - medo comum do p√∫blico]
> ‚ùå [Dor 4 - o que est√° perdendo]

**Transi√ß√£o:**
> [Frase que conecta problema √† solu√ß√£o]

---

### ‚úÖ SE√á√ÉO 3: SOLU√á√ÉO/OFERTA (DESEJO)

**Layout:**
\`\`\`
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                                                 ‚îÇ
‚îÇ  "Apresentamos: [NOME DA SOLU√á√ÉO]"              ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  [Descri√ß√£o breve do que √©]                     ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  O que voc√™ vai ter:                            ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  ‚úÖ [Entreg√°vel 1] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ [Benef√≠cio]           ‚îÇ
‚îÇ  ‚úÖ [Entreg√°vel 2] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ [Benef√≠cio]           ‚îÇ
‚îÇ  ‚úÖ [Entreg√°vel 3] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ [Benef√≠cio]           ‚îÇ
‚îÇ  ‚úÖ [Entreg√°vel 4] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ [Benef√≠cio]           ‚îÇ
‚îÇ  ‚úÖ [Entreg√°vel 5] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ [Benef√≠cio]           ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  [    QUERO ESSA SOLU√á√ÉO    ]                   ‚îÇ
‚îÇ                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
\`\`\`

**COPY COMPLETA:**

**T√≠tulo:**
> [Apresentar a solu√ß√£o de forma atrativa]

**Descri√ß√£o:**
> [2-3 frases explicando o que √© e como funciona]

**Lista de Entreg√°veis:**
> ‚úÖ **[Entreg√°vel 1]** ‚Äî [Benef√≠cio que isso traz]
> ‚úÖ **[Entreg√°vel 2]** ‚Äî [Benef√≠cio que isso traz]
> ‚úÖ **[Entreg√°vel 3]** ‚Äî [Benef√≠cio que isso traz]
> ‚úÖ **[Entreg√°vel 4]** ‚Äî [Benef√≠cio que isso traz]
> ‚úÖ **[Entreg√°vel 5]** ‚Äî [Benef√≠cio que isso traz]

**CTA:**
> [Texto do bot√£o]

---

### ‚≠ê SE√á√ÉO 4: PROVA SOCIAL

**Layout:**
\`\`\`
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                                                 ‚îÇ
‚îÇ  "Veja o que nossos clientes dizem:"            ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îÇ
‚îÇ  ‚îÇ üì∑      ‚îÇ  ‚îÇ üì∑      ‚îÇ  ‚îÇ üì∑      ‚îÇ          ‚îÇ
‚îÇ  ‚îÇ Depoi-  ‚îÇ  ‚îÇ Depoi-  ‚îÇ  ‚îÇ Depoi-  ‚îÇ          ‚îÇ
‚îÇ  ‚îÇ mento 1 ‚îÇ  ‚îÇ mento 2 ‚îÇ  ‚îÇ mento 3 ‚îÇ          ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  [Logos de empresas ou selos de confian√ßa]      ‚îÇ
‚îÇ                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
\`\`\`

**COPY COMPLETA:**

**T√≠tulo:**
> [T√≠tulo da se√ß√£o de depoimentos]

**Depoimento 1:**
> "[Depoimento fict√≠cio mas realista baseado no tipo de resultado]"
> ‚Äî **[Nome]**, [Cargo/Cidade]

**Depoimento 2:**
> "[Depoimento focado em outro benef√≠cio]"
> ‚Äî **[Nome]**, [Cargo/Cidade]

**Depoimento 3:**
> "[Depoimento focado em obje√ß√£o comum quebrada]"
> ‚Äî **[Nome]**, [Cargo/Cidade]

**N√∫meros de Autoridade:**
> üìä [X]+ clientes atendidos
> ‚≠ê [X] anos de experi√™ncia
> üèÜ [X]% de satisfa√ß√£o

---

### ÔøΩ SE√á√ÉO 5: FORMUL√ÅRIO DE QUALIFICA√á√ÉO (A√á√ÉO)

**Layout:**
\`\`\`
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                                                 ‚îÇ
‚îÇ  üéØ [HEADLINE DO FORMUL√ÅRIO]                    ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  [Subhead - urg√™ncia ou benef√≠cio]              ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ
‚îÇ  ‚îÇ Nome completo *                       ‚îÇ      ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§      ‚îÇ
‚îÇ  ‚îÇ WhatsApp *                            ‚îÇ      ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§      ‚îÇ
‚îÇ  ‚îÇ Email *                               ‚îÇ      ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§      ‚îÇ
‚îÇ  ‚îÇ [Campo qualificador 1] *              ‚îÇ      ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§      ‚îÇ
‚îÇ  ‚îÇ [Campo qualificador 2]                ‚îÇ      ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§      ‚îÇ
‚îÇ  ‚îÇ                                       ‚îÇ      ‚îÇ
‚îÇ  ‚îÇ  [     ENVIAR E RECEBER     ]         ‚îÇ      ‚îÇ
‚îÇ  ‚îÇ                                       ‚îÇ      ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  üîí Seus dados est√£o seguros conosco            ‚îÇ
‚îÇ                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
\`\`\`

**COPY COMPLETA:**

**Headline do Form:**
> [Headline atrativa - ex: "Receba sua proposta personalizada"]

**Subhead:**
> [Urg√™ncia ou benef√≠cio - ex: "Resposta em at√© 24h √∫teis"]

**Campos do Formul√°rio:**

| Campo | Tipo | Obrigat√≥rio | Prop√≥sito |
|-------|------|-------------|-----------|
| Nome completo | Texto | ‚úÖ | Personaliza√ß√£o |
| WhatsApp | Tel | ‚úÖ | Contato principal |
| Email | Email | ‚úÖ | Nutri√ß√£o |
| [Campo qualificador 1] | Select | ‚úÖ | [Ex: "Qual seu interesse?"] |
| [Campo qualificador 2] | Select | ‚ùå | [Ex: "Or√ßamento dispon√≠vel"] |

**Op√ß√µes do Select Qualificador 1:**
- [Op√ß√£o 1]
- [Op√ß√£o 2]
- [Op√ß√£o 3]
- [Op√ß√£o 4]

**Texto do Bot√£o:**
> [CTA forte - ex: "QUERO MINHA PROPOSTA AGORA"]

**Texto de Seguran√ßa:**
> üîí Seus dados est√£o protegidos e n√£o ser√£o compartilhados

---

### ÔøΩ SE√á√ÉO 6: CTA ALTERNATIVO (WhatsApp)

**Layout:**
\`\`\`
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                                                 ‚îÇ
‚îÇ  "Prefere falar diretamente com um especialista?"‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  [  üí¨ CHAMAR NO WHATSAPP  ]                    ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  Atendimento [hor√°rio]                          ‚îÇ
‚îÇ                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
\`\`\`

**COPY:**
> [Texto alternativo para quem prefere WhatsApp]

**Bot√£o WhatsApp:**
> üí¨ FALAR COM ESPECIALISTA AGORA

**Mensagem Pr√©-Preenchida:**
> Ol√°! Vim da landing page [NOME] e gostaria de saber mais sobre [SOLU√á√ÉO].

---

### ‚ùì SE√á√ÉO 7: FAQ (Quebra de Obje√ß√µes)

**Perguntas e Respostas:**

**P1: [Obje√ß√£o de pre√ßo]**
> R: [Resposta que quebra a obje√ß√£o e mostra valor]

**P2: [Obje√ß√£o de tempo/prazo]**
> R: [Resposta com expectativa realista]

**P3: [Obje√ß√£o de confian√ßa]**
> R: [Resposta com garantias/provas]

**P4: [D√∫vida sobre funcionamento]**
> R: [Explica√ß√£o clara do processo]

**P5: [D√∫vida sobre resultados]**
> R: [Resposta com cases/expectativas]

---

### üîö SE√á√ÉO 8: FOOTER

**Elementos:**
- Logo
- Endere√ßo (se aplic√°vel)
- Telefone/WhatsApp
- Redes sociais
- Links legais (Pol√≠tica de Privacidade, Termos)

---

## üîÑ FUNIL P√ìS-CONVERS√ÉO (LP1)

### Ap√≥s Preencher o Formul√°rio:

**Etapa 1: P√°gina de Obrigado**
\`\`\`
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                                                 ‚îÇ
‚îÇ  ‚úÖ [NOME], recebemos seu contato!              ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  Em breve um especialista vai falar com voc√™.  ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  ‚è∞ Tempo m√©dio de resposta: [X] horas          ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  Enquanto isso, que tal:                        ‚îÇ
‚îÇ  [  üì± SALVAR NOSSO WHATSAPP  ]                 ‚îÇ
‚îÇ  [  üìò SEGUIR NO INSTAGRAM    ]                 ‚îÇ
‚îÇ                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
\`\`\`

**Etapa 2: Email Autom√°tico**
\`\`\`
Assunto: [NOME], recebemos sua solicita√ß√£o! ‚úÖ

Ol√° [NOME],

[Corpo do email confirmando recebimento e pr√≥ximos passos]

Abra√ßos,
[ASSINATURA]
\`\`\`

**Etapa 3: WhatsApp Autom√°tico**
\`\`\`
Ol√°, [NOME]! üëã

Aqui √© [ATENDENTE] da [EMPRESA].

Recebi sua solicita√ß√£o sobre [INTERESSE].

[Mensagem de qualifica√ß√£o/agendamento]
\`\`\`

---

# üìÑ LANDING PAGE 2: [NOME DA LP]

[Repetir estrutura completa para LP2 - com foco diferente]

## üéØ Informa√ß√µes Estrat√©gicas

| Item | Detalhe |
|------|---------|
| **Objetivo** | [Diferente da LP1] |
| **Canal Principal** | [Google Ads / Meta Ads] |
| **P√∫blico** | [Outro segmento do PAI] |
| **Promessa Principal** | [Outra abordagem] |
| **CTA Principal** | [Pode ser diferente] |

[Desenvolver estrutura completa...]

---

# üìÑ LANDING PAGE 3: [NOME DA LP]

[Repetir estrutura completa para LP3 - com foco diferente]

## üéØ Informa√ß√µes Estrat√©gicas

| Item | Detalhe |
|------|---------|
| **Objetivo** | [Diferente das anteriores] |
| **Canal Principal** | [Google Ads / Meta Ads] |
| **P√∫blico** | [Outro segmento] |
| **Promessa Principal** | [Outra abordagem] |
| **CTA Principal** | [Pode ser diferente] |

[Desenvolver estrutura completa...]

---

# üß™ PLANO DE TESTES A/B

## Testes Priorit√°rios

### Teste 1: Headlines
| Elemento | Vers√£o A | Vers√£o B | Hip√≥tese |
|----------|----------|----------|----------|
| Headline LP1 | [Vers√£o atual] | [Vers√£o alternativa] | [O que espera] |

### Teste 2: CTAs
| Elemento | Vers√£o A | Vers√£o B | Hip√≥tese |
|----------|----------|----------|----------|
| Bot√£o principal | [Texto A] | [Texto B] | [O que espera] |

### Teste 3: Formul√°rio
| Elemento | Vers√£o A | Vers√£o B | Hip√≥tese |
|----------|----------|----------|----------|
| Qtd campos | [X campos] | [Y campos] | [O que espera] |

### Teste 4: Cores
| Elemento | Vers√£o A | Vers√£o B | Hip√≥tese |
|----------|----------|----------|----------|
| Cor do CTA | [Cor A] | [Cor B] | [O que espera] |

---

# ‚ö° CHECKLIST T√âCNICO

## Antes de Publicar

### Performance
- [ ] Velocidade < 3 segundos (mobile)
- [ ] Imagens otimizadas (WebP)
- [ ] Lazy loading ativado
- [ ] Minifica√ß√£o CSS/JS

### Mobile
- [ ] 100% responsivo
- [ ] Bot√µes com tamanho adequado (44px m√≠nimo)
- [ ] Formul√°rio f√°cil de preencher
- [ ] Click-to-call funcionando

### Convers√£o
- [ ] Pixel do Facebook instalado
- [ ] Google Tag Manager configurado
- [ ] Eventos de convers√£o rastreados
- [ ] Thank You Page configurada

### SEO/Ads
- [ ] Title tag otimizado
- [ ] Meta description atrativa
- [ ] Consist√™ncia com an√∫ncio (headline = ad)
- [ ] URL amig√°vel

---

# üí° PR√ìXIMOS PASSOS

1. [A√ß√£o espec√≠fica 1 - desenvolver LP1]
2. [A√ß√£o espec√≠fica 2]
3. [A√ß√£o espec√≠fica 3]
4. [A√ß√£o espec√≠fica 4]
5. [A√ß√£o espec√≠fica 5]`,
        prompt: `Voc√™ √© um especialista em convers√£o da Mediagrowth. Gere um documento de LANDING PAGES.`
      },
      website: {
        title: 'Constru√ß√£o ou Atualiza√ß√£o de Website',
        weeks: ['semana3_4'],
        blocks: ['site_seo', 'puv', 'pai'],
        charts: {
          primary: 'sitemap', // Mapa do site
          secondary: 'userflow', // Fluxo do usu√°rio
          tertiary: 'checklist' // Checklist t√©cnico
        },
        radarLabels: ['Design', 'UX', 'SEO', 'Velocidade', 'Convers√£o'],
        maxTokens: 8000,
        promptAnalise: `üåê OBJETIVO: Estruturar WEBSITE CORPORATIVO - sites de alta convers√£o e performance.

**üéì CONTEXTO DE EXPERTISE (USE INTERNAMENTE - N√ÉO MENCIONE NO RELAT√ìRIO):**
Aplique metodologias de: Don Norman (Design of Everyday Things), Steve Krug (Don't Make Me Think), Jakob Nielsen (Usability Heuristics), Luke Wroblewski (Mobile First), Vitaly Friedman (Smashing Magazine). Use frameworks: Information Architecture, Card Sorting, User Flow Mapping, Gestalt Principles, Fitts's Law, Miller's Law, Progressive Enhancement, Core Web Vitals Optimization.

**‚ö†Ô∏è REGRA OBRIGAT√ìRIA DE MOEDA:**

**üö® REGRA SOBRE DADOS E PROJE√á√ïES:**
- ‚ùå PROIBIDO afirmar SITUA√á√ÉO ATUAL sem dados reais (ex: "Voc√™ tem X seguidores" sem ter essa info)
- ‚úÖ PERMITIDO fazer PROJE√á√ïES e METAS baseadas no nicho, contexto e anota√ß√µes
- Para dados atuais desconhecidos ‚Üí use "A coletar" ou "Diagn√≥stico necess√°rio"
- Para metas e proje√ß√µes ‚Üí pode sugerir valores realistas baseados no contexto do neg√≥cio

Antes de gerar qualquer valor monet√°rio, VERIFIQUE no bloco "üìã Contexto do Neg√≥cio" das anota√ß√µes qual moeda o cliente utiliza (R$ Real ou $ D√≥lar/USD). 
- Se encontrar "d√≥lar", "USD", "dollar" ou "$" no contexto ‚Üí Use $ (d√≥lar americano)
- Se encontrar "real", "reais", "BRL" ou "R$" no contexto ‚Üí Use R$ (real brasileiro)  
- Se n√£o estiver especificado ‚Üí Pergunte ou use R$ como padr√£o
TODOS os valores monet√°rios do relat√≥rio devem seguir a moeda identificada.


**üéØ OBJETIVO:**
Criar uma estrutura COMPLETA de website institucional/comercial com todas as p√°ginas, se√ß√µes, copy persuasiva e CTAs estrat√©gicos. O site deve ser otimizado para convers√£o e integrado √† estrat√©gia de marketing digital.

**IMPORTANTE:**
- Use as informa√ß√µes do PAI, PUV e anota√ß√µes para personalizar
- Cada p√°gina deve ter estrutura detalhada de se√ß√µes
- Inclua copy completa para textos principais
- Crie fluxos de navega√ß√£o e convers√£o claros
- Considere SEO e experi√™ncia do usu√°rio

---

# üåê PROJETO DE WEBSITE

## üìä BRIEFING DO PROJETO

### Sobre a Empresa
[Resumo baseado nas anota√ß√µes - quem √©, o que faz, diferenciais]

### P√∫blico-Alvo
[Baseado no PAI das anota√ß√µes]

### Proposta de Valor
[Baseado no PUV das anota√ß√µes]

### Objetivos do Site
| Objetivo | Prioridade | M√©trica de Sucesso |
|----------|------------|-------------------|
| [Ex: Captar leads] | Alta | [Convers√µes/m√™s] |
| [Ex: Apresentar servi√ßos] | M√©dia | [Tempo na p√°gina] |
| [Ex: Fortalecer marca] | M√©dia | [Sess√µes] |

---

## üó∫Ô∏è ARQUITETURA DO SITE

### Mapa de P√°ginas
\`\`\`
üè† HOME
‚îú‚îÄ‚îÄ üìã SOBRE / QUEM SOMOS
‚îú‚îÄ‚îÄ üõ†Ô∏è SERVI√áOS (ou PRODUTOS)
‚îÇ   ‚îú‚îÄ‚îÄ Servi√ßo 1
‚îÇ   ‚îú‚îÄ‚îÄ Servi√ßo 2
‚îÇ   ‚îî‚îÄ‚îÄ Servi√ßo 3
‚îú‚îÄ‚îÄ üì∞ BLOG (opcional)
‚îú‚îÄ‚îÄ üìû CONTATO
‚îî‚îÄ‚îÄ üîí Pol√≠tica de Privacidade
\`\`\`

### Fluxo de Convers√£o Principal
\`\`\`
Visitante ‚Üí Home ‚Üí Servi√ßos ‚Üí Contato ‚Üí Lead
         ‚Üì
      Blog ‚Üí CTA ‚Üí Isca Digital ‚Üí Lead
\`\`\`

---

## üìÑ ESTRUTURA DETALHADA POR P√ÅGINA

### üè† P√ÅGINA: HOME

**Objetivo:** Causar impacto, apresentar proposta de valor, direcionar para convers√£o

**SE√á√ïES:**

| # | Se√ß√£o | Objetivo | CTA |
|---|-------|----------|-----|
| 1 | Hero Banner | Impacto + Proposta de Valor | [CTA principal] |
| 2 | Problemas/Dores | Identifica√ß√£o com p√∫blico | - |
| 3 | Solu√ß√£o/Servi√ßos | Apresentar ofertas | [Ver mais] |
| 4 | Diferenciais | Por que escolher | - |
| 5 | Prova Social | Cases/Depoimentos | - |
| 6 | CTA Final | Convers√£o | [Contato/WhatsApp] |

**COPY DO HERO:**

**Headline:**
> [Headline principal com promessa clara - 8-12 palavras]

**Subheadline:**
> [Complemento que expande a promessa - 15-25 palavras]

**CTA Principal:**
> [Texto do bot√£o de a√ß√£o]

---

### üìã P√ÅGINA: SOBRE / QUEM SOMOS

**Objetivo:** Construir confian√ßa e conex√£o emocional

**SE√á√ïES:**

| # | Se√ß√£o | Conte√∫do |
|---|-------|----------|
| 1 | Hist√≥ria | Origem, miss√£o, vis√£o |
| 2 | Valores | 3-5 valores principais |
| 3 | Equipe | Fotos e bios (opcional) |
| 4 | N√∫meros | Resultados em dados |
| 5 | CTA | Pr√≥ximo passo |

---

### üõ†Ô∏è P√ÅGINA: SERVI√áOS

**Objetivo:** Apresentar ofertas e gerar interesse

**ESTRUTURA POR SERVI√áO:**

| Elemento | Descri√ß√£o |
|----------|-----------|
| T√≠tulo | [Nome do servi√ßo] |
| Subt√≠tulo | [Benef√≠cio principal] |
| Descri√ß√£o | [3-4 par√°grafos explicativos] |
| Benef√≠cios | [Lista com 4-6 bullets] |
| Para quem √© | [P√∫blico ideal] |
| Entreg√°veis | [O que est√° incluso] |
| CTA | [Bot√£o de a√ß√£o] |

---

### üìû P√ÅGINA: CONTATO

**Objetivo:** Capturar leads e facilitar contato

**ELEMENTOS ESSENCIAIS:**

| Elemento | Conte√∫do |
|----------|----------|
| Formul√°rio | Nome, Email, Telefone, Mensagem |
| WhatsApp | Bot√£o direto com mensagem pr√©-preenchida |
| Email | [email de contato] |
| Telefone | [n√∫mero comercial] |
| Endere√ßo | [se aplic√°vel] |
| Mapa | [Google Maps embed] |
| Hor√°rios | [funcionamento] |

**Copy do Formul√°rio:**
> **Headline:** [T√≠tulo persuasivo]
> **Descri√ß√£o:** [O que acontece ap√≥s preencher]
> **CTA:** [Texto do bot√£o]

---

## ‚ö° REQUISITOS T√âCNICOS

### Performance
- [ ] Carregamento < 3 segundos
- [ ] Core Web Vitals aprovados
- [ ] Imagens otimizadas (WebP)
- [ ] Lazy loading ativado

### Mobile
- [ ] Design responsivo
- [ ] Mobile-first
- [ ] Bot√µes touch-friendly
- [ ] Menu hamburguer funcional

### SEO B√°sico
- [ ] Meta titles √∫nicos
- [ ] Meta descriptions persuasivas
- [ ] URLs amig√°veis
- [ ] Sitemap.xml
- [ ] Robots.txt
- [ ] Schema markup b√°sico

### Seguran√ßa
- [ ] SSL/HTTPS
- [ ] Pol√≠tica de privacidade
- [ ] Termos de uso
- [ ] LGPD compliance

---

## üì± INTEGRA√á√ïES

| Ferramenta | Finalidade |
|------------|-----------|
| Google Analytics 4 | M√©tricas de acesso |
| Google Tag Manager | Gest√£o de tags |
| Google Search Console | SEO t√©cnico |
| Meta Pixel | Remarketing |
| WhatsApp Business | Atendimento |
| CRM/Make | Leads do formul√°rio |

---

## ‚úÖ CHECKLIST DE LAN√áAMENTO

### Pr√©-lan√ßamento
- [ ] Revisar todos os textos
- [ ] Testar formul√°rios
- [ ] Verificar links quebrados
- [ ] Testar em dispositivos m√≥veis
- [ ] Configurar analytics
- [ ] Configurar backups

### P√≥s-lan√ßamento
- [ ] Submeter sitemap ao Google
- [ ] Monitorar erros 404
- [ ] Acompanhar m√©tricas
- [ ] Coletar feedback

---

## ‚û°Ô∏è PLANO DE A√á√ÉO

### Pr√≥ximos Passos

1. [A√ß√£o espec√≠fica 1 - aprovar estrutura]
2. [A√ß√£o espec√≠fica 2 - definir wireframes]
3. [A√ß√£o espec√≠fica 3 - produzir conte√∫do]
4. [A√ß√£o espec√≠fica 4 - desenvolvimento]
5. [A√ß√£o espec√≠fica 5 - testes e lan√ßamento]`,
        prompt: `Voc√™ √© um arquiteto de informa√ß√£o da Mediagrowth. Gere um documento de WEBSITE.`
      },
      padronizacao_visual: {
        title: 'Padroniza√ß√£o Visual e de Comunica√ß√£o',
        weeks: ['semana5'],
        blocks: ['criativos', 'copywriting'],
        charts: {
          primary: 'brandbook', // Mini brand book
          secondary: 'ecosystem', // Ecossistema de canais
          tertiary: 'consistency' // Checklist de consist√™ncia
        },
        radarLabels: ['Cores', 'Tipografia', 'Imagens', 'Tom', 'Aplica√ß√£o'],
        maxTokens: 8000,
        promptAnalise: `üé® OBJETIVO: Criar GUIA DE PADRONIZA√á√ÉO VISUAL completo e pr√°tico para a marca.

**üéì CONTEXTO DE EXPERTISE (USE INTERNAMENTE - N√ÉO MENCIONE NO RELAT√ìRIO):**
Aplique conceitos de: Marty Neumeier (The Brand Gap), David Airey (Logo Design Love), Debbie Millman (Brand Thinking), Paul Rand (Design Philosophy), Michael Bierut (Pentagram). Use frameworks: Brand Identity Prism, Color Psychology, Typography Hierarchy, Modular Scale, Grid Systems, Style Guide Architecture, Brand Guidelines Best Practices.

**‚ö†Ô∏è REGRA OBRIGAT√ìRIA DE MOEDA:**

**üö® REGRA SOBRE DADOS E PROJE√á√ïES:**
- ‚ùå PROIBIDO afirmar SITUA√á√ÉO ATUAL sem dados reais (ex: "Voc√™ tem X seguidores" sem ter essa info)
- ‚úÖ PERMITIDO fazer PROJE√á√ïES e METAS baseadas no nicho, contexto e anota√ß√µes
- Para dados atuais desconhecidos ‚Üí use "A coletar" ou "Diagn√≥stico necess√°rio"
- Para metas e proje√ß√µes ‚Üí pode sugerir valores realistas baseados no contexto do neg√≥cio

Antes de gerar qualquer valor monet√°rio, VERIFIQUE no bloco "üìã Contexto do Neg√≥cio" das anota√ß√µes qual moeda o cliente utiliza (R$ Real ou $ D√≥lar/USD). 
- Se encontrar "d√≥lar", "USD", "dollar" ou "$" no contexto ‚Üí Use $ (d√≥lar americano)
- Se encontrar "real", "reais", "BRL" ou "R$" no contexto ‚Üí Use R$ (real brasileiro)  
- Se n√£o estiver especificado ‚Üí Pergunte ou use R$ como padr√£o
TODOS os valores monet√°rios do relat√≥rio devem seguir a moeda identificada.


**üéØ OBJETIVO:**
Criar um DOCUMENTO DE PADRONIZA√á√ÉO VISUAL E DE COMUNICA√á√ÉO completo, objetivo e f√°cil de seguir. Este guia deve ser a "b√≠blia" da marca para garantir consist√™ncia em TODOS os canais.

**IMPORTANTE:**
- Use TODAS as informa√ß√µes coletadas nas anota√ß√µes (PAI, PUV, tons de voz, cores, etc.)
- Seja ESPEC√çFICO - nada de [preencher aqui], PREENCHA com dados reais das anota√ß√µes
- Formato PR√ÅTICO e APLIC√ÅVEL - o time precisa conseguir seguir facilmente
- Se alguma informa√ß√£o n√£o foi coletada, fa√ßa recomenda√ß√µes baseadas no nicho

---

# üìã GUIA DE PADRONIZA√á√ÉO VISUAL E DE COMUNICA√á√ÉO

## üìå Informa√ß√µes do Documento

| Campo | Informa√ß√£o |
|-------|------------|
| **Marca** | [Nome da marca/empresa das anota√ß√µes] |
| **Data** | [Data atual] |
| **Respons√°vel** | Mediagrowth |
| **Vers√£o** | 1.0 |

---

# 1. üéØ IDENTIDADE DA MARCA (Funda√ß√£o)

## 1.1 Posicionamento

| Elemento | Defini√ß√£o |
|----------|-----------|
| **O que a marca faz** | [Frase clara e direta] |
| **Para quem existe** | [P√∫blico-alvo principal - do PAI] |
| **Problema que resolve** | [Dor principal do cliente] |
| **Diferencial competitivo** | [O que torna √∫nica - da PUV] |

## 1.2 Proposta de Valor

| Aspecto | Descri√ß√£o |
|---------|-----------|
| **Por que escolher esta marca** | [Raz√£o principal] |
| **Promessa central** | [O que o cliente pode esperar] |
| **Benef√≠cio funcional** | [Resultado pr√°tico] |
| **Benef√≠cio emocional** | [Como o cliente se sente] |

## 1.3 Personalidade da Marca

> A marca se comunica como se fosse uma pessoa com estas caracter√≠sticas:

| Caracter√≠stica | Defini√ß√£o |
|----------------|-----------|
| **Tom** | [Ex: profissional, pr√≥ximo, premium, descontra√≠do] |
| **Linguagem** | [Ex: simples, t√©cnica, aspiracional] |
| **Emo√ß√µes transmitidas** | [Ex: confian√ßa, autoridade, acolhimento] |
| **Arqu√©tipo** | [Ex: O Especialista, O Cuidador, O Criador] |

---

# 2. üé® IDENTIDADE VISUAL (Padroniza√ß√£o Visual)

## 2.1 Logotipo

**Vers√µes dispon√≠veis:**
- ‚úÖ Vers√£o principal (colorida)
- ‚úÖ Vers√£o horizontal
- ‚úÖ Vers√£o vertical/s√≠mbolo
- ‚úÖ Vers√£o monocrom√°tica (branca/preta)

**Regras de uso:**

| Situa√ß√£o | Vers√£o a usar |
|----------|---------------|
| Fundo claro | [Vers√£o recomendada] |
| Fundo escuro | [Vers√£o recomendada] |
| Espa√ßo reduzido | [Vers√£o s√≠mbolo] |
| Materiais impressos | [Vers√£o recomendada] |

**‚ö†Ô∏è Usos incorretos (NUNCA fazer):**
- ‚ùå Distorcer propor√ß√µes
- ‚ùå Alterar cores
- ‚ùå Aplicar sobre fundos que prejudiquem leitura
- ‚ùå Adicionar efeitos (sombras, gradientes n√£o autorizados)

## 2.2 Paleta de Cores

### Cores Prim√°rias
| Nome | HEX | RGB | Uso |
|------|-----|-----|-----|
| **[Cor Principal]** | #[c√≥digo] | rgb(x,x,x) | Elementos principais, logo, destaques |
| **[Cor Secund√°ria]** | #[c√≥digo] | rgb(x,x,x) | Fundos, elementos de apoio |

### Cores de Apoio
| Nome | HEX | RGB | Uso |
|------|-----|-----|-----|
| **[Cor Apoio 1]** | #[c√≥digo] | rgb(x,x,x) | [Fun√ß√£o] |
| **[Cor Apoio 2]** | #[c√≥digo] | rgb(x,x,x) | [Fun√ß√£o] |

### Cor de Destaque (CTAs)
| Nome | HEX | Uso |
|------|-----|-----|
| **[Cor CTA]** | #[c√≥digo] | Bot√µes, chamadas para a√ß√£o, urg√™ncia |

### Regras de Contraste
- ‚úÖ Texto escuro sobre fundo claro
- ‚úÖ Texto claro sobre fundo escuro
- ‚ö†Ô∏è M√≠nimo de 4.5:1 de contraste para acessibilidade

## 2.3 Tipografia

### Fontes Oficiais
| Uso | Fonte | Peso | Tamanho Base |
|-----|-------|------|--------------|
| **T√≠tulos/Headlines** | [Nome da fonte] | Bold/Semibold | 24-48px |
| **Subt√≠tulos** | [Nome da fonte] | Medium | 18-24px |
| **Corpo de texto** | [Nome da fonte] | Regular | 14-16px |
| **Legendas/Small** | [Nome da fonte] | Regular | 12-14px |

### Hierarquia Visual
\`\`\`
H1 - T√≠tulos Principais (32-48px, Bold)
    H2 - Subt√≠tulos (24-32px, Semibold)
        H3 - Se√ß√µes (18-24px, Medium)
            Corpo - Texto padr√£o (14-16px, Regular)
                Small - Legendas (12px, Regular)
\`\`\`

## 2.4 Estilo Visual

| Elemento | Padr√£o |
|----------|--------|
| **Estilo de imagens** | [Real/lifestyle/institucional/minimalista] |
| **Uso de √≠cones** | [Estilo: line/solid/duotone] |
| **Ilustra√ß√µes** | [Se usa ou n√£o, estilo] |
| **Formas/Padr√µes** | [Elementos gr√°ficos recorrentes] |
| **Espa√ßamento** | [Generoso/compacto] |

---

# 3. ÔøΩÔ∏è COMUNICA√á√ÉO VERBAL (Padroniza√ß√£o de Linguagem)

## 3.1 Tom de Voz

### Como a marca FALA ‚úÖ
| Contexto | Tom | Exemplo |
|----------|-----|---------|
| Redes Sociais | [Tom] | "[Exemplo de frase]" |
| E-mail/WhatsApp | [Tom] | "[Exemplo de frase]" |
| Site | [Tom] | "[Exemplo de frase]" |
| Atendimento | [Tom] | "[Exemplo de frase]" |

### Como a marca N√ÉO FALA ‚ùå
| Evitar | Motivo | Em vez disso, dizer |
|--------|--------|---------------------|
| "[Express√£o incorreta]" | [Porque evitar] | "[Alternativa correta]" |
| "[Express√£o incorreta]" | [Porque evitar] | "[Alternativa correta]" |

## 3.2 Vocabul√°rio Oficial

### Palavras que USAMOS ‚úÖ
| Categoria | Palavras/Express√µes |
|-----------|---------------------|
| **Para resultados** | [Lista de palavras] |
| **Para a√ß√£o** | [Lista de palavras] |
| **Para conex√£o** | [Lista de palavras] |

### Palavras que EVITAMOS ‚ùå
| Evitar | Motivo |
|--------|--------|
| [Palavra] | [Porque n√£o usar] |
| [Palavra] | [Porque n√£o usar] |

### Termos T√©cnicos do Nicho
| Termo | Significado | Quando usar |
|-------|-------------|-------------|
| [Termo] | [Explica√ß√£o] | [Contexto] |

### Hashtags Padr√£o (Redes Sociais)
| Tipo | Hashtags |
|------|----------|
| **Marca** | #[hashtag] #[hashtag] |
| **Nicho** | #[hashtag] #[hashtag] |
| **Conte√∫do** | #[hashtag] #[hashtag] |

## 3.3 Mensagens-Chave

**üéØ Mensagem Principal (Slogan/Tagline):**
> "[Mensagem principal da marca]"

**üìå Mensagens Secund√°rias:**
1. "[Mensagem sobre expertise/autoridade]"
2. "[Mensagem sobre resultado/transforma√ß√£o]"
3. "[Mensagem sobre diferencial]"
4. "[Mensagem sobre confian√ßa]"

**‚ö° Frases de Impacto (para CTAs e destaques):**
- "[Frase 1]"
- "[Frase 2]"
- "[Frase 3]"

---

# 4. üì± APLICA√á√ÉO NOS CANAIS

## 4.1 Redes Sociais (Instagram/Facebook)

| Elemento | Padr√£o |
|----------|--------|
| **Cores do feed** | [Paleta predominante] |
| **Estilo de posts** | [Educativo/Institucional/Promocional/Mix] |
| **Formato de legendas** | [Curta/M√©dia/Longa + CTA] |
| **Uso de emojis** | [Sim/N√£o/Moderado + quais] |
| **Frequ√™ncia** | [X posts por semana] |
| **Hor√°rios** | [Melhores hor√°rios] |

**Tipos de Conte√∫do:**
| Tipo | Frequ√™ncia | Objetivo |
|------|------------|----------|
| Educativo | X% | Autoridade |
| Institucional | X% | Confian√ßa |
| Promocional | X% | Convers√£o |
| Entretenimento | X% | Engajamento |

## 4.2 Site / Landing Pages

| Elemento | Padr√£o |
|----------|--------|
| **Hierarquia visual** | [Estrutura principal] |
| **Proposta de valor** | [Onde fica / como aparece] |
| **CTAs** | [Cores, textos padr√£o] |
| **Linguagem** | [Tom espec√≠fico para site] |
| **Formul√°rios** | [Campos essenciais] |

## 4.3 WhatsApp/Atendimento

| Elemento | Padr√£o |
|----------|--------|
| **Sauda√ß√£o** | "[Mensagem padr√£o]" |
| **Tom** | [Profissional mas pr√≥ximo] |
| **Tempo de resposta** | [Expectativa] |
| **Encerramento** | "[Frase padr√£o]" |

## 4.4 E-mail Marketing

| Elemento | Padr√£o |
|----------|--------|
| **Assunto** | [Estilo: direto/curioso/personalizado] |
| **Remetente** | [Nome + marca] |
| **Tom** | [Tom do e-mail] |
| **CTA** | [Padr√£o de bot√µes] |
| **Assinatura** | [Formato] |

## 4.5 Materiais Institucionais

| Material | Padr√£o |
|----------|--------|
| **Apresenta√ß√µes** | [Template, cores, fontes] |
| **Propostas comerciais** | [Estrutura, tom] |
| **PDFs/Cat√°logos** | [Estilo visual] |
| **Assinatura de e-mail** | [Formato padr√£o] |

---

# 5. ‚ùå INCONSIST√äNCIAS ENCONTRADAS (An√°lise Cr√≠tica)

> ‚ö†Ô∏è Baseado nas informa√ß√µes coletadas, identifiquei estas inconsist√™ncias:

| √Årea | Inconsist√™ncia | Impacto |
|------|----------------|---------|
| **Visual** | [O que est√° inconsistente] | [Como afeta a marca] |
| **Comunica√ß√£o** | [O que est√° inconsistente] | [Como afeta a marca] |
| **Canais** | [O que est√° inconsistente] | [Como afeta a marca] |
| **Posicionamento** | [O que est√° inconsistente] | [Como afeta a marca] |

---

# 6. ‚úÖ RECOMENDA√á√ïES ESTRAT√âGICAS

## Prioridade ALTA (Fazer Agora)
1. [Recomenda√ß√£o urgente 1]
2. [Recomenda√ß√£o urgente 2]
3. [Recomenda√ß√£o urgente 3]

## Prioridade M√âDIA (Pr√≥ximos 30 dias)
1. [Recomenda√ß√£o importante 1]
2. [Recomenda√ß√£o importante 2]

## Prioridade BAIXA (Pr√≥ximos 90 dias)
1. [Recomenda√ß√£o de melhoria 1]
2. [Recomenda√ß√£o de melhoria 2]

---

# 7. üìå GUIA R√ÅPIDO DE USO (Resumo Pr√°tico)

> üìã **Imprima esta p√°gina e deixe vis√≠vel para o time!**

## üé® Visual R√°pido
| Elemento | Padr√£o |
|----------|--------|
| **Cor Principal** | #[c√≥digo] - [nome] |
| **Cor Secund√°ria** | #[c√≥digo] - [nome] |
| **Cor CTA** | #[c√≥digo] - [nome] |
| **Fonte T√≠tulos** | [Nome da fonte] |
| **Fonte Textos** | [Nome da fonte] |

## üó£Ô∏è Comunica√ß√£o R√°pida
| Elemento | Padr√£o |
|----------|--------|
| **Tom de Voz** | [3 palavras] |
| **Mensagem-Chave** | "[Frase principal]" |
| **Palavras-Chave** | [3-5 palavras que sempre usar] |

## ‚úÖ FAZER (DO's)
- ‚úÖ [Regra 1]
- ‚úÖ [Regra 2]
- ‚úÖ [Regra 3]
- ‚úÖ [Regra 4]
- ‚úÖ [Regra 5]

## ‚ùå N√ÉO FAZER (DON'Ts)
- ‚ùå [Regra 1]
- ‚ùå [Regra 2]
- ‚ùå [Regra 3]
- ‚ùå [Regra 4]
- ‚ùå [Regra 5]

---

**üìß D√∫vidas sobre este guia?**
Entre em contato com a Mediagrowth para esclarecimentos.`,
        prompt: `Voc√™ √© um brand strategist da Mediagrowth. Gere um documento de PADRONIZA√á√ÉO VISUAL.`
      },
      plataforma_mediagrowth: {
        title: 'Plataforma Mediagrowth',
        weeks: ['semana1', 'semana1_2', 'semana2', 'semana3_4', 'semana5'],
        blocks: [],
        charts: {
          primary: 'ecosystem', // Vis√£o macro
          secondary: 'dataflow', // Fluxo de dados
          tertiary: 'modules' // M√≥dulos da plataforma
        },
        chartDescriptions: {
          primary: 'Ecossistema integrado: vis√£o macro de todos os componentes estrat√©gicos trabalhados.',
          secondary: 'Fluxo de dados: como as informa√ß√µes transitam entre marketing, vendas e an√°lise.',
          tertiary: 'M√≥dulos ativos: funcionalidades da plataforma utilizadas no projeto.',
          radar: 'Maturidade em Planejamento, Execu√ß√£o, An√°lise, uso de IA e Gest√£o estrat√©gica.'
        },
        radarLabels: ['Planejamento', 'Execu√ß√£o', 'An√°lise', 'IA', 'Gest√£o'],
        maxTokens: 16000,
        promptAnalise: `üìã OBJETIVO: Criar o PLANO MESTRE ANUAL completo de marketing e vendas.

**üéì CONTEXTO DE EXPERTISE (USE INTERNAMENTE - N√ÉO MENCIONE NO RELAT√ìRIO):**
Aplique frameworks de: John Doerr (Measure What Matters/OKRs), Dan Martell (Buy Back Your Time), Gino Wickman (Traction/EOS), Alex Hormozi (100M Offers), Russell Brunson (DotCom Secrets), Dave Ramsey (EntreLeadership). Use metodologias: Strategic Planning Process, Annual Operating Plan (AOP), Quarterly Business Reviews (QBRs), Rocks & Big Hairy Audacious Goals (BHAGs), Marketing Mix Modeling, Resource Allocation Matrix.

**‚ö†Ô∏è REGRA OBRIGAT√ìRIA DE MOEDA:**

**üö® REGRA SOBRE DADOS E PROJE√á√ïES:**
- ‚ùå PROIBIDO afirmar SITUA√á√ÉO ATUAL sem dados reais (ex: "Voc√™ tem X seguidores" sem ter essa info)
- ‚úÖ PERMITIDO fazer PROJE√á√ïES e METAS baseadas no nicho, contexto e anota√ß√µes
- Para dados atuais desconhecidos ‚Üí use "A coletar" ou "Diagn√≥stico necess√°rio"
- Para metas e proje√ß√µes ‚Üí pode sugerir valores realistas baseados no contexto do neg√≥cio

Antes de gerar qualquer valor monet√°rio, VERIFIQUE no bloco "üìã Contexto do Neg√≥cio" das anota√ß√µes qual moeda o cliente utiliza (R$ Real ou $ D√≥lar/USD). 
- Se encontrar "d√≥lar", "USD", "dollar" ou "$" no contexto ‚Üí Use $ (d√≥lar americano)
- Se encontrar "real", "reais", "BRL" ou "R$" no contexto ‚Üí Use R$ (real brasileiro)  
- Se n√£o estiver especificado ‚Üí Pergunte ou use R$ como padr√£o
TODOS os valores monet√°rios do relat√≥rio devem seguir a moeda identificada.


**üéØ OBJETIVO CR√çTICO:**
Este √© o DOCUMENTO MAIS IMPORTANTE da plataforma. Voc√™ vai consolidar TODAS as informa√ß√µes coletadas em todas as semanas de estrutura√ß√£o e TODOS os relat√≥rios gerados para criar um PLANO ANUAL EXECUT√ÅVEL que ser√° usado nas abas: Planejamento, Calend√°rio, Metas, CAC e Leads.

**üìÖ CONTEXTO TEMPORAL:**
- Considere a DATA ATUAL como in√≠cio do plano
- O plano deve cobrir 12 MESES a partir de hoje
- Divida em trimestres (Q1, Q2, Q3, Q4) e meses
- Considere sazonalidades e datas comemorativas do nicho

**üìä FONTES DE DADOS (USE TUDO):**
1. Informa√ß√µes do neg√≥cio (nome, nicho, tempo de mercado, or√ßamento)
2. PAI - Perfis de P√∫blico definidos
3. PUV - Proposta de Valor
4. Matriz CDT - Canais, Diferenciais, Tend√™ncias
5. Diagn√≥stico Estrat√©gico
6. Estrutura de Campanhas
7. Copywriting e Criativos
8. CRM e Automa√ß√µes
9. Processo Comercial
10. Landing Pages e Website
11. Padroniza√ß√£o Visual
12. TODAS as anota√ß√µes dos checklists de todas as semanas

**IMPORTANTE:**
- N√ÉO USE placeholders gen√©ricos - PREENCHA com dados REAIS das anota√ß√µes
- Seja ESPEC√çFICO com datas, n√∫meros e a√ß√µes
- Tudo deve ser EXECUT√ÅVEL e MENSUR√ÅVEL
- Considere a capacidade da equipe e or√ßamento informado

---

# üìã PLANO MESTRE ANUAL - PLATAFORMA MEDIAGROWTH

## üìå Informa√ß√µes do Plano

| Campo | Informa√ß√£o |
|-------|------------|
| **Empresa** | [Nome da empresa das anota√ß√µes] |
| **Nicho** | [Segmento de atua√ß√£o] |
| **Data de In√≠cio** | [M√™s/Ano atual] |
| **Per√≠odo** | 12 meses |
| **Or√ßamento Mensal** | [Valor informado nas anota√ß√µes] |
| **Respons√°vel** | Mediagrowth |

---

# üìä PARTE 1: VIS√ÉO ESTRAT√âGICA CONSOLIDADA

## 1.1 Resumo Executivo

### Situa√ß√£o Atual
[Resumo do diagn√≥stico - onde a empresa est√° hoje]

### Objetivo Principal do Ano
[Meta principal a ser alcan√ßada em 12 meses]

### Estrat√©gia Central
[Abordagem macro que ser√° seguida]

## 1.2 P√∫blico-Alvo Priorizado

| Prioridade | Persona | Caracter√≠sticas | Canais | Abordagem |
|------------|---------|-----------------|--------|-----------|
| ü•á Alta | [Persona 1 do PAI] | [Resumo] | [Canais] | [Como abordar] |
| ü•à M√©dia | [Persona 2 do PAI] | [Resumo] | [Canais] | [Como abordar] |
| ü•â Baixa | [Persona 3 do PAI] | [Resumo] | [Canais] | [Como abordar] |

## 1.3 Proposta de Valor (PUV)

> "[PUV completa das anota√ß√µes]"

**Mensagem-Chave para o Ano:**
> "[Frase que resume a comunica√ß√£o do ano]"

---

# üìÖ PARTE 2: PLANEJAMENTO ANUAL (Para Aba PLANEJAMENTO)

## 2.1 Vis√£o Trimestral

### üî∑ Q1 - [M√™s 1] a [M√™s 3]: FUNDA√á√ÉO
**Foco:** Estruturar bases, implementar ferramentas, primeiras campanhas

| M√™s | Objetivo Principal | Entreg√°veis-Chave |
|-----|-------------------|-------------------|
| [M√™s 1] | [Objetivo] | [Lista de entregas] |
| [M√™s 2] | [Objetivo] | [Lista de entregas] |
| [M√™s 3] | [Objetivo] | [Lista de entregas] |

### üî∑ Q2 - [M√™s 4] a [M√™s 6]: CRESCIMENTO
**Foco:** Escalar campanhas, otimizar convers√µes, expandir canais

| M√™s | Objetivo Principal | Entreg√°veis-Chave |
|-----|-------------------|-------------------|
| [M√™s 4] | [Objetivo] | [Lista de entregas] |
| [M√™s 5] | [Objetivo] | [Lista de entregas] |
| [M√™s 6] | [Objetivo] | [Lista de entregas] |

### üî∑ Q3 - [M√™s 7] a [M√™s 9]: OTIMIZA√á√ÉO
**Foco:** Refinar estrat√©gias, aumentar ticket m√©dio, fideliza√ß√£o

| M√™s | Objetivo Principal | Entreg√°veis-Chave |
|-----|-------------------|-------------------|
| [M√™s 7] | [Objetivo] | [Lista de entregas] |
| [M√™s 8] | [Objetivo] | [Lista de entregas] |
| [M√™s 9] | [Objetivo] | [Lista de entregas] |

### ÔøΩ Q4 - [M√™s 10] a [M√™s 12]: CONSOLIDA√á√ÉO
**Foco:** Maximizar resultados, preparar pr√≥ximo ciclo

| M√™s | Objetivo Principal | Entreg√°veis-Chave |
|-----|-------------------|-------------------|
| [M√™s 10] | [Objetivo] | [Lista de entregas] |
| [M√™s 11] | [Objetivo] | [Lista de entregas] |
| [M√™s 12] | [Objetivo] | [Lista de entregas] |

## 2.2 Plano de A√ß√µes Detalhado

### M√™s 1: [Nome do M√™s]

| # | A√ß√£o | Objetivo | Respons√°vel | Prazo | Status |
|---|------|----------|-------------|-------|--------|
| 1 | [A√ß√£o espec√≠fica] | [Resultado esperado] | [Quem] | [Data] | üî≤ |
| 2 | [A√ß√£o espec√≠fica] | [Resultado esperado] | [Quem] | [Data] | üî≤ |
| 3 | [A√ß√£o espec√≠fica] | [Resultado esperado] | [Quem] | [Data] | üî≤ |
| 4 | [A√ß√£o espec√≠fica] | [Resultado esperado] | [Quem] | [Data] | üî≤ |
| 5 | [A√ß√£o espec√≠fica] | [Resultado esperado] | [Quem] | [Data] | üî≤ |

### M√™s 2: [Nome do M√™s]

| # | A√ß√£o | Objetivo | Respons√°vel | Prazo | Status |
|---|------|----------|-------------|-------|--------|
| 1 | [A√ß√£o espec√≠fica] | [Resultado esperado] | [Quem] | [Data] | üî≤ |
| 2 | [A√ß√£o espec√≠fica] | [Resultado esperado] | [Quem] | [Data] | üî≤ |
| 3 | [A√ß√£o espec√≠fica] | [Resultado esperado] | [Quem] | [Data] | üî≤ |
| 4 | [A√ß√£o espec√≠fica] | [Resultado esperado] | [Quem] | [Data] | üî≤ |
| 5 | [A√ß√£o espec√≠fica] | [Resultado esperado] | [Quem] | [Data] | üî≤ |

### M√™s 3: [Nome do M√™s]

| # | A√ß√£o | Objetivo | Respons√°vel | Prazo | Status |
|---|------|----------|-------------|-------|--------|
| 1 | [A√ß√£o espec√≠fica] | [Resultado esperado] | [Quem] | [Data] | üî≤ |
| 2 | [A√ß√£o espec√≠fica] | [Resultado esperado] | [Quem] | [Data] | üî≤ |
| 3 | [A√ß√£o espec√≠fica] | [Resultado esperado] | [Quem] | [Data] | üî≤ |

[Continue para os demais meses com a√ß√µes espec√≠ficas baseadas nas anota√ß√µes]

---

# üìÜ PARTE 3: CALEND√ÅRIO DE CONTE√öDO E CAMPANHAS (Para Aba CALEND√ÅRIO)

## 3.1 Calend√°rio Editorial Mensal

### [M√™s 1]

**Semana 1 ([Datas]):**
| Dia | Canal | Tipo | Tema/Conte√∫do | CTA |
|-----|-------|------|---------------|-----|
| Seg | Instagram | Post | [Tema] | [CTA] |
| Qua | Instagram | Reels | [Tema] | [CTA] |
| Sex | Blog | Artigo | [Tema] | [CTA] |

**Semana 2 ([Datas]):**
| Dia | Canal | Tipo | Tema/Conte√∫do | CTA |
|-----|-------|------|---------------|-----|
| Seg | Instagram | Post | [Tema] | [CTA] |
| Ter | Stories | Enquete | [Tema] | [CTA] |
| Qua | Instagram | Carrossel | [Tema] | [CTA] |
| Sex | E-mail | Newsletter | [Tema] | [CTA] |

**Semana 3 ([Datas]):**
[Continuar padr√£o...]

**Semana 4 ([Datas]):**
[Continuar padr√£o...]

### [M√™s 2]
[Mesmo formato...]

### [M√™s 3]
[Mesmo formato...]

## 3.2 Calend√°rio de Campanhas Pagas

| M√™s | Campanha | Plataforma | Objetivo | Or√ßamento | Per√≠odo |
|-----|----------|------------|----------|-----------|---------|
| [M√™s 1] | [Nome] | Google/Meta | [Objetivo] | R$ [valor] | [datas] |
| [M√™s 1] | [Nome] | Meta Ads | [Objetivo] | R$ [valor] | [datas] |
| [M√™s 2] | [Nome] | Google Ads | [Objetivo] | R$ [valor] | [datas] |
| [M√™s 2] | [Nome] | Meta Ads | [Objetivo] | R$ [valor] | [datas] |
[Continuar para todos os meses...]

## 3.3 Datas Comemorativas do Nicho

| Data | Evento | A√ß√£o Planejada | Anteced√™ncia |
|------|--------|----------------|--------------|
| [Data] | [Evento relevante] | [Campanha/Conte√∫do] | [Dias antes] |
| [Data] | [Evento relevante] | [Campanha/Conte√∫do] | [Dias antes] |
| [Data] | [Evento relevante] | [Campanha/Conte√∫do] | [Dias antes] |

---

# ÔøΩ PARTE 4: PROJE√á√ÉO DE METAS (Para Aba METAS)

## 4.1 Metas Anuais Consolidadas

| M√©trica | Meta Anual | Meta Mensal M√©dia |
|---------|------------|-------------------|
| **Investimento em Publicidade** | R$ [valor] | R$ [valor] |
| **Faturamento Tr√°fego Pago** | R$ [valor] | R$ [valor] |
| **Leads Gerados** | [n√∫mero] | [n√∫mero] |
| **ROAS** | [valor]x | [valor]x |
| **Taxa MQL** | [%] | [%] |
| **CPL** | R$ [valor] | R$ [valor] |
| **CAC** | R$ [valor] | R$ [valor] |
| **Neg√≥cios Fechados** | [n√∫mero] | [n√∫mero] |
| **Taxa Convers√£o** | [%] | [%] |
| **Seguidores** | +[n√∫mero] | +[n√∫mero] |
| **Faturamento Total** | R$ [valor] | R$ [valor] |

## 4.2 Metas Mensais Detalhadas

### M√™s 1: [Nome]

| M√©trica | Meta | Base de C√°lculo |
|---------|------|-----------------|
| Investimento Ads | R$ [valor] | [Or√ßamento dispon√≠vel] |
| Leads Gerados | [n√∫mero] | CPL estimado: R$ [valor] |
| Leads Qualificados (MQL) | [n√∫mero] | Taxa MQL: [%] |
| Neg√≥cios Fechados | [n√∫mero] | Taxa convers√£o: [%] |
| Faturamento Tr√°fego | R$ [valor] | Ticket m√©dio: R$ [valor] |
| ROAS | [valor]x | Faturamento / Investimento |
| CAC | R$ [valor] | Investimento / Clientes |

### M√™s 2: [Nome]

| M√©trica | Meta | Crescimento vs M1 |
|---------|------|-------------------|
| Investimento Ads | R$ [valor] | +[%] |
| Leads Gerados | [n√∫mero] | +[%] |
| Leads Qualificados (MQL) | [n√∫mero] | +[%] |
| Neg√≥cios Fechados | [n√∫mero] | +[%] |
| Faturamento Tr√°fego | R$ [valor] | +[%] |
| ROAS | [valor]x | +[%] |

### M√™s 3: [Nome]

| M√©trica | Meta | Crescimento vs M2 |
|---------|------|-------------------|
| Investimento Ads | R$ [valor] | +[%] |
| Leads Gerados | [n√∫mero] | +[%] |
| Leads Qualificados (MQL) | [n√∫mero] | +[%] |
| Neg√≥cios Fechados | [n√∫mero] | +[%] |
| Faturamento Tr√°fego | R$ [valor] | +[%] |
| ROAS | [valor]x | +[%] |

[Continue para os 12 meses com proje√ß√£o de crescimento gradual]

## 4.3 Curva de Crescimento Projetada

\`\`\`
PROJE√á√ÉO DE LEADS (12 meses)

M1  ‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë  [n√∫mero]
M2  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë  [n√∫mero]
M3  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë  [n√∫mero]
M4  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë  [n√∫mero]
M5  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë  [n√∫mero]
M6  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë  [n√∫mero]
M7  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë  [n√∫mero]
M8  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë  [n√∫mero]
M9  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë  [n√∫mero]
M10 ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë  [n√∫mero]
M11 ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë  [n√∫mero]
M12 ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë  [n√∫mero]
\`\`\`

---

# ÔøΩ PARTE 5: AN√ÅLISE CAC E UNIT ECONOMICS (Para Aba CAC)

## 5.1 Estrutura de Custos

| Categoria | Custo Mensal | % do Total |
|-----------|--------------|------------|
| **Tr√°fego Pago** | R$ [valor] | [%] |
| **Ferramentas** | R$ [valor] | [%] |
| **Equipe/Ag√™ncia** | R$ [valor] | [%] |
| **Conte√∫do** | R$ [valor] | [%] |
| **Total** | R$ [valor] | 100% |

## 5.2 Proje√ß√£o de CAC por Trimestre

| Trimestre | Investimento | Clientes | CAC | Meta CAC |
|-----------|--------------|----------|-----|----------|
| Q1 | R$ [valor] | [n√∫mero] | R$ [valor] | R$ [valor] |
| Q2 | R$ [valor] | [n√∫mero] | R$ [valor] | R$ [valor] |
| Q3 | R$ [valor] | [n√∫mero] | R$ [valor] | R$ [valor] |
| Q4 | R$ [valor] | [n√∫mero] | R$ [valor] | R$ [valor] |

## 5.3 An√°lise de Viabilidade

| M√©trica | Valor | Status |
|---------|-------|--------|
| **Ticket M√©dio** | R$ [valor] | - |
| **CAC Atual** | R$ [valor] | ‚ö†Ô∏è/‚úÖ |
| **LTV Estimado** | R$ [valor] | - |
| **Rela√ß√£o LTV/CAC** | [valor]x | ‚ö†Ô∏è/‚úÖ |
| **Payback** | [meses] meses | ‚ö†Ô∏è/‚úÖ |

**An√°lise:**
[Explica√ß√£o se o CAC est√° saud√°vel e recomenda√ß√µes]

---

# üë• PARTE 6: GEST√ÉO DE LEADS (Para Aba LEADS)

## 6.1 Funil de Vendas Projetado

\`\`\`
FUNIL MENSAL PROJETADO

Visitantes     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  [n√∫mero]
     ‚Üì [%]%
Leads          ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë  [n√∫mero]
     ‚Üì [%]%
MQL            ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë  [n√∫mero]
     ‚Üì [%]%
Oportunidades  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë  [n√∫mero]
     ‚Üì [%]%
Clientes       ‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë  [n√∫mero]
\`\`\`

## 6.2 Origem de Leads (Mix de Canais)

| Canal | % do Total | Leads/M√™s | CPL Estimado |
|-------|------------|-----------|--------------|
| Google Ads | [%] | [n√∫mero] | R$ [valor] |
| Meta Ads | [%] | [n√∫mero] | R$ [valor] |
| Org√¢nico | [%] | [n√∫mero] | R$ 0 |
| Indica√ß√£o | [%] | [n√∫mero] | R$ 0 |
| WhatsApp | [%] | [n√∫mero] | R$ [valor] |

## 6.3 Fluxo de Nutri√ß√£o de Leads

| Etapa | A√ß√£o | Prazo | Respons√°vel |
|-------|------|-------|-------------|
| Lead Novo | [A√ß√£o imediata] | < 5 min | [Quem] |
| Qualifica√ß√£o | [Como qualificar] | 24h | [Quem] |
| Nutri√ß√£o | [Sequ√™ncia de follow-up] | 7 dias | [Quem] |
| Reengajamento | [A√ß√£o para leads frios] | 30 dias | [Quem] |

## 6.4 Scripts de Atendimento

**Primeiro Contato (WhatsApp):**
> "[Script baseado no processo comercial definido]"

**Follow-up (24h sem resposta):**
> "[Script de follow-up]"

**Qualifica√ß√£o (Perguntas-chave):**
1. [Pergunta qualificadora 1]
2. [Pergunta qualificadora 2]
3. [Pergunta qualificadora 3]

---

# ‚úÖ PARTE 7: CHECKLIST DE IMPLEMENTA√á√ÉO

## 7.1 Primeiros 30 Dias (Prioridade M√°xima)

- [ ] [A√ß√£o cr√≠tica 1]
- [ ] [A√ß√£o cr√≠tica 2]
- [ ] [A√ß√£o cr√≠tica 3]
- [ ] [A√ß√£o cr√≠tica 4]
- [ ] [A√ß√£o cr√≠tica 5]
- [ ] [A√ß√£o cr√≠tica 6]
- [ ] [A√ß√£o cr√≠tica 7]
- [ ] [A√ß√£o cr√≠tica 8]
- [ ] [A√ß√£o cr√≠tica 9]
- [ ] [A√ß√£o cr√≠tica 10]

## 7.2 60-90 Dias (Consolida√ß√£o)

- [ ] [A√ß√£o importante 1]
- [ ] [A√ß√£o importante 2]
- [ ] [A√ß√£o importante 3]
- [ ] [A√ß√£o importante 4]
- [ ] [A√ß√£o importante 5]

## 7.3 Revis√µes Mensais

| M√™s | Data Revis√£o | Foco |
|-----|--------------|------|
| M1 | [Data] | Validar funda√ß√£o |
| M2 | [Data] | Otimizar campanhas |
| M3 | [Data] | Analisar CAC |
| M4 | [Data] | Escalar |
| M5 | [Data] | Revisar metas |
| M6 | [Data] | Ajuste de meio de ano |

---

# üìä PARTE 8: DASHBOARD DE ACOMPANHAMENTO

## 8.1 KPIs Principais (Acompanhar Semanalmente)

| KPI | Meta | F√≥rmula |
|-----|------|---------|
| **Leads/Semana** | [n√∫mero] | Total de leads novos |
| **CPL** | R$ [valor] | Investimento / Leads |
| **Taxa de Resposta** | [%] | Leads respondidos / Total |
| **Agendamentos** | [n√∫mero] | Reuni√µes marcadas |
| **Fechamentos** | [n√∫mero] | Vendas realizadas |

## 8.2 Alertas e Gatilhos

| Situa√ß√£o | Gatilho | A√ß√£o |
|----------|---------|------|
| CPL alto | > R$ [valor] | [A√ß√£o corretiva] |
| Poucos leads | < [n√∫mero]/semana | [A√ß√£o corretiva] |
| Baixa convers√£o | < [%]% | [A√ß√£o corretiva] |
| ROAS baixo | < [valor]x | [A√ß√£o corretiva] |

---

# üìÖ PARTE 9: PLANO DE A√á√ÉO MENSAL DETALHADO

> **INSTRU√á√ïES:** Este √© seu guia de execu√ß√£o m√™s a m√™s. Cada m√™s tem a√ß√µes espec√≠ficas com passo-a-passo claro. Baseado em todo o contexto da estrutura√ß√£o e relat√≥rios anteriores.

---

## üìÜ M√äS 1: FUNDA√á√ÉO E SETUP

**Objetivo do M√™s:** Estabelecer toda a base t√©cnica e estrat√©gica para os pr√≥ximos 11 meses.

### ‚úÖ Checklist de A√ß√µes (M√™s 1)

| # | A√ß√£o | O Que Fazer (Passo a Passo) | Prazo | Status |
|---|------|----------------------------|-------|--------|
| 1 | **Configurar CRM** | 1. Escolher ferramenta (RD Station/HubSpot/Pipedrive) 2. Criar pipeline de vendas 3. Configurar campos personalizados 4. Integrar com WhatsApp | Semana 1 | ‚¨ú |
| 2 | **Setup de Campanhas** | 1. Criar conta de an√∫ncios 2. Instalar Pixel/Tag 3. Configurar convers√µes 4. Criar p√∫blicos base | Semana 1-2 | ‚¨ú |
| 3 | **Identidade Visual** | 1. Finalizar logo e cores 2. Criar templates de posts 3. Definir tom de voz 4. Montar kit de marca | Semana 2 | ‚¨ú |
| 4 | **Primeira Campanha** | 1. Criar landing page 2. Escrever copy 3. Produzir criativos 4. Subir campanha teste | Semana 3-4 | ‚¨ú |
| 5 | **Automa√ß√µes B√°sicas** | 1. Criar fluxo de boas-vindas 2. Configurar notifica√ß√µes 3. Setup de follow-up autom√°tico | Semana 4 | ‚¨ú |

**Meta do M√™s:** [X] leads gerados | Investimento: R$ [valor]

**Respons√°veis:**
- Marketing: [Nome] ‚Üí Campanhas e Criativos
- Comercial: [Nome] ‚Üí CRM e Follow-up
- Gestor: [Nome] ‚Üí Acompanhamento geral

---

## üìÜ M√äS 2: TRA√á√ÉO INICIAL

**Objetivo do M√™s:** Gerar os primeiros leads qualificados e validar a estrat√©gia.

### ‚úÖ Checklist de A√ß√µes (M√™s 2)

| # | A√ß√£o | O Que Fazer (Passo a Passo) | Prazo | Status |
|---|------|----------------------------|-------|--------|
| 1 | **Otimizar Campanhas** | 1. Analisar dados da semana 1 2. Pausar an√∫ncios fracos 3. Escalar os melhores 4. Testar novos p√∫blicos | Semanal | ‚¨ú |
| 2 | **Processo Comercial** | 1. Criar script de abordagem 2. Definir tempo m√°ximo de resposta 3. Implementar qualifica√ß√£o BANT 4. Treinar equipe | Semana 1-2 | ‚¨ú |
| 3 | **Conte√∫do Org√¢nico** | 1. Criar calend√°rio de 30 dias 2. Produzir 8-12 posts 3. Gravar 2-4 v√≠deos curtos 4. Agendar publica√ß√µes | Semana 2-3 | ‚¨ú |
| 4 | **An√°lise de CAC** | 1. Calcular custo por lead 2. Calcular custo por venda 3. Comparar com ticket m√©dio 4. Ajustar or√ßamento | Semana 4 | ‚¨ú |
| 5 | **Remarketing** | 1. Criar p√∫blico de visitantes 2. Criar p√∫blico de engajados 3. Lan√ßar campanha de remarketing 4. Testar ofertas diferentes | Semana 3-4 | ‚¨ú |

**Meta do M√™s:** [X] leads | [X] agendamentos | [X] vendas
**CPL Alvo:** R$ [valor] | **CAC Alvo:** R$ [valor]

---

## üìÜ M√äS 3: VALIDA√á√ÉO E AJUSTES

**Objetivo do M√™s:** Validar o que funciona e corrigir o que n√£o funciona.

### ‚úÖ Checklist de A√ß√µes (M√™s 3)

| # | A√ß√£o | O Que Fazer (Passo a Passo) | Prazo | Status |
|---|------|----------------------------|-------|--------|
| 1 | **An√°lise Completa Q1** | 1. Exportar dados de 90 dias 2. Calcular todas as m√©tricas 3. Identificar padr√µes 4. Documentar aprendizados | Semana 1 | ‚¨ú |
| 2 | **Novo Funil de Vendas** | 1. Revisar etapas do pipeline 2. Ajustar gatilhos de passagem 3. Criar novos scripts 4. Implementar obje√ß√µes comuns | Semana 2 | ‚¨ú |
| 3 | **Testes A/B** | 1. Testar 2 headlines diferentes 2. Testar 2 CTAs diferentes 3. Testar cores de bot√£o 4. Documentar vencedores | Semana 2-3 | ‚¨ú |
| 4 | **Escalar Vencedores** | 1. Identificar top 3 an√∫ncios 2. Aumentar or√ßamento gradualmente 3. Expandir para novos p√∫blicos 4. Manter monitoramento di√°rio | Semana 3-4 | ‚¨ú |
| 5 | **Planejamento Q2** | 1. Definir metas do pr√≥ximo trimestre 2. Ajustar or√ßamento 3. Planejar novas campanhas 4. Definir datas importantes | Semana 4 | ‚¨ú |

**Meta do M√™s:** [X] leads | Taxa de convers√£o: [X]%
**Revis√£o:** O que funcionou? O que precisa mudar?

---

## üìÜ M√äS 4: CRESCIMENTO ACELERADO

**Objetivo do M√™s:** Escalar as estrat√©gias validadas no Q1.

### ‚úÖ Checklist de A√ß√µes (M√™s 4)

| # | A√ß√£o | O Que Fazer (Passo a Passo) | Prazo | Status |
|---|------|----------------------------|-------|--------|
| 1 | **Aumentar Investimento** | 1. Subir or√ßamento em 20-30% 2. Monitorar CPL diariamente 3. Pausar se CPL subir muito 4. Documentar limites | Semana 1-2 | ‚¨ú |
| 2 | **Novos Canais** | 1. Avaliar Google Ads 2. Testar LinkedIn (se B2B) 3. Explorar YouTube Ads 4. Escolher 1 novo canal | Semana 2-3 | ‚¨ú |
| 3 | **Automa√ß√£o Avan√ßada** | 1. Criar sequ√™ncia de nutri√ß√£o 2. Configurar lead scoring 3. Automatizar qualifica√ß√£o 4. Criar alertas de lead quente | Semana 3 | ‚¨ú |
| 4 | **Conte√∫do Estrat√©gico** | 1. Criar 2 materiais ricos 2. Produzir cases de sucesso 3. Fazer depoimentos em v√≠deo 4. Criar comparativos | Semana 3-4 | ‚¨ú |
| 5 | **Parcerias** | 1. Mapear 10 potenciais parceiros 2. Fazer contato inicial 3. Propor colabora√ß√£o 4. Fechar 1-2 parcerias | Semana 4 | ‚¨ú |

**Meta do M√™s:** Crescimento de [X]% em leads | [X] vendas

---

## üìÜ M√äS 5: OTIMIZA√á√ÉO DE CONVERS√ÉO

**Objetivo do M√™s:** Melhorar taxas de convers√£o em todo o funil.

### ‚úÖ Checklist de A√ß√µes (M√™s 5)

| # | A√ß√£o | O Que Fazer (Passo a Passo) | Prazo | Status |
|---|------|----------------------------|-------|--------|
| 1 | **An√°lise de Funil** | 1. Mapear taxa de cada etapa 2. Identificar gargalos 3. Priorizar melhorias 4. Definir metas por etapa | Semana 1 | ‚¨ú |
| 2 | **Melhoria de LP** | 1. Analisar heatmaps 2. Revisar headline e copy 3. Otimizar formul√°rio 4. Acelerar carregamento | Semana 2 | ‚¨ú |
| 3 | **Script de Vendas** | 1. Gravar liga√ß√µes para an√°lise 2. Identificar obje√ß√µes frequentes 3. Criar respostas para obje√ß√µes 4. Treinar equipe | Semana 2-3 | ‚¨ú |
| 4 | **Follow-up Agressivo** | 1. Reduzir tempo de resposta 2. Criar cad√™ncia de 7 toques 3. Usar WhatsApp + Liga√ß√£o + Email 4. Medir taxas de resposta | Semana 3 | ‚¨ú |
| 5 | **Recupera√ß√£o de Leads** | 1. Listar leads n√£o convertidos 2. Criar campanha de reativa√ß√£o 3. Oferecer benef√≠cio especial 4. Medir recupera√ß√µes | Semana 4 | ‚¨ú |

**Meta do M√™s:** Aumentar convers√£o em [X]% | Reduzir CAC em [X]%

---

## üìÜ M√äS 6: REVIS√ÉO DE MEIO DE ANO

**Objetivo do M√™s:** Fazer balan√ßo completo e ajustar estrat√©gia para o 2¬∫ semestre.

### ‚úÖ Checklist de A√ß√µes (M√™s 6)

| # | A√ß√£o | O Que Fazer (Passo a Passo) | Prazo | Status |
|---|------|----------------------------|-------|--------|
| 1 | **Relat√≥rio Semestral** | 1. Compilar todos os dados 2. Calcular ROI do semestre 3. Comparar metas vs realizado 4. Apresentar para stakeholders | Semana 1-2 | ‚¨ú |
| 2 | **Revis√£o de Or√ßamento** | 1. Analisar gastos vs retorno 2. Realocar verbas 3. Definir or√ßamento S2 4. Aprovar com diretoria | Semana 2 | ‚¨ú |
| 3 | **Ajuste de Metas** | 1. Revisar metas anuais 2. Ajustar para realidade 3. Definir metas S2 4. Comunicar equipe | Semana 2-3 | ‚¨ú |
| 4 | **Limpeza de Base** | 1. Identificar leads frios 2. Tentar reativar 3. Arquivar inativos 4. Manter base saud√°vel | Semana 3 | ‚¨ú |
| 5 | **Planejamento S2** | 1. Definir campanhas S2 2. Planejar datas comemorativas 3. Reservar or√ßamento extra 4. Preparar Black Friday | Semana 4 | ‚¨ú |

**Meta do M√™s:** Relat√≥rio completo | Plano S2 aprovado

---

## üìÜ M√äS 7: ESCALA DO 2¬∫ SEMESTRE

**Objetivo do M√™s:** Implementar as melhorias e escalar com base nos aprendizados do S1.

### ‚úÖ Checklist de A√ß√µes (M√™s 7)

| # | A√ß√£o | O Que Fazer (Passo a Passo) | Prazo | Status |
|---|------|----------------------------|-------|--------|
| 1 | **Novas Campanhas S2** | 1. Criar novos criativos 2. Testar novas abordagens 3. Explorar dores diferentes 4. Lan√ßar com for√ßa | Semana 1-2 | ‚¨ú |
| 2 | **Expans√£o de P√∫blico** | 1. Criar lookalikes de compradores 2. Testar interesses novos 3. Expandir geograficamente 4. Medir performance | Semana 2-3 | ‚¨ú |
| 3 | **Conte√∫do de Autoridade** | 1. Criar webinar/live 2. Fazer colabora√ß√£o 3. Publicar artigo longo 4. Divulgar em todos canais | Semana 3 | ‚¨ú |
| 4 | **Processo de Indica√ß√£o** | 1. Criar programa de indica√ß√£o 2. Definir recompensas 3. Comunicar clientes 4. Acompanhar indica√ß√µes | Semana 3-4 | ‚¨ú |
| 5 | **Preparar Q4** | 1. Mapear datas do Q4 2. Reservar estoque/capacidade 3. Planejar promo√ß√µes 4. Criar cronograma | Semana 4 | ‚¨ú |

**Meta do M√™s:** [X] leads | In√≠cio do plano Q4

---

## üìÜ M√äS 8: PREPARA√á√ÉO PARA ALTA TEMPORADA

**Objetivo do M√™s:** Preparar toda a estrutura para o per√≠odo de maior demanda.

### ‚úÖ Checklist de A√ß√µes (M√™s 8)

| # | A√ß√£o | O Que Fazer (Passo a Passo) | Prazo | Status |
|---|------|----------------------------|-------|--------|
| 1 | **Campanhas de Aquecimento** | 1. Criar antecipa√ß√£o 2. Capturar lista de interessados 3. Fazer countdown 4. Gerar expectativa | Semana 1-2 | ‚¨ú |
| 2 | **Estrutura de Atendimento** | 1. Refor√ßar equipe se necess√°rio 2. Criar turnos extras 3. Preparar respostas r√°pidas 4. Treinar para volume | Semana 2 | ‚¨ú |
| 3 | **Landing Pages Sazonais** | 1. Criar LP para Black Friday 2. Criar LP para fim de ano 3. Preparar ofertas 4. Testar convers√£o | Semana 2-3 | ‚¨ú |
| 4 | **Estoque de Conte√∫do** | 1. Produzir 30 posts antecipados 2. Gravar v√≠deos extras 3. Criar emails prontos 4. Agendar tudo | Semana 3-4 | ‚¨ú |
| 5 | **Testes de Sistema** | 1. Testar fluxo completo 2. Verificar integra√ß√µes 3. Simular alto volume 4. Corrigir problemas | Semana 4 | ‚¨ú |

**Meta do M√™s:** Estrutura 100% pronta para Q4

---

## üìÜ M√äS 9: ACELERA√á√ÉO PR√â-Q4

**Objetivo do M√™s:** Maximizar resultados antes do per√≠odo de pico.

### ‚úÖ Checklist de A√ß√µes (M√™s 9)

| # | A√ß√£o | O Que Fazer (Passo a Passo) | Prazo | Status |
|---|------|----------------------------|-------|--------|
| 1 | **An√°lise Q3** | 1. Revisar m√©tricas do trimestre 2. Identificar top performers 3. Calcular proje√ß√£o Q4 4. Ajustar expectativas | Semana 1 | ‚¨ú |
| 2 | **Campanha de Urg√™ncia** | 1. Criar oferta limitada 2. Usar escassez real 3. Comunicar deadline 4. Medir convers√£o | Semana 2 | ‚¨ú |
| 3 | **Lista VIP** | 1. Segmentar melhores leads 2. Criar oferta exclusiva 3. Fazer pr√©-venda 4. Garantir primeiras vendas | Semana 2-3 | ‚¨ú |
| 4 | **Revis√£o de Pre√ßos** | 1. Analisar margem atual 2. Definir pre√ßos promocionais 3. Calcular limite de desconto 4. Aprovar tabela | Semana 3 | ‚¨ú |
| 5 | **Final de Or√ßamento** | 1. Revisar verba dispon√≠vel 2. Alocar para Q4 3. Definir prioridades 4. Comunicar equipe | Semana 4 | ‚¨ú |

**Meta do M√™s:** [X] leads | Tudo pronto para Black Friday

---

## üìÜ M√äS 10: BLACK FRIDAY E PICO

**Objetivo do M√™s:** Executar a maior campanha do ano com excel√™ncia.

### ‚úÖ Checklist de A√ß√µes (M√™s 10)

| # | A√ß√£o | O Que Fazer (Passo a Passo) | Prazo | Status |
|---|------|----------------------------|-------|--------|
| 1 | **Pr√©-Black Friday** | 1. Lan√ßar esquenta 2. Capturar lista de espera 3. Gerar antecipa√ß√£o 4. Testar ofertas | Semana 1-2 | ‚¨ú |
| 2 | **Black Friday** | 1. Ativar todas as campanhas 2. Monitorar em tempo real 3. Responder leads imediatamente 4. Escalar o que funciona | Semana 4 | ‚¨ú |
| 3 | **Atendimento Intensivo** | 1. Equipe em plant√£o 2. Resposta em at√© 5 min 3. Follow-up agressivo 4. Fechar m√°ximo poss√≠vel | Semana 4 | ‚¨ú |
| 4 | **Extens√£o Cyber Monday** | 1. Prolongar ofertas 2. Remarketing pesado 3. √öltima chance 4. Fechar retardat√°rios | Fim do m√™s | ‚¨ú |
| 5 | **Documentar Tudo** | 1. Gravar m√©tricas por hora 2. Documentar problemas 3. Anotar aprendizados 4. Preparar relat√≥rio | P√≥s-BF | ‚¨ú |

**Meta do M√™s:** [X] vendas (maior m√™s do ano) | Faturamento: R$ [valor]

---

## üìÜ M√äS 11: FECHAMENTO E FIM DE ANO

**Objetivo do M√™s:** Maximizar vendas de fim de ano e preparar encerramento.

### ‚úÖ Checklist de A√ß√µes (M√™s 11)

| # | A√ß√£o | O Que Fazer (Passo a Passo) | Prazo | Status |
|---|------|----------------------------|-------|--------|
| 1 | **Campanha Natal** | 1. Criar ofertas natalinas 2. Comunicar prazos de entrega 3. Usar urg√™ncia 4. Fechar vendas | Semana 1-3 | ‚¨ú |
| 2 | **Fim de Ano Comercial** | 1. √öltima oferta do ano 2. Mensagem de agradecimento 3. Retrospectiva com clientes 4. Pedir indica√ß√µes | Semana 2-3 | ‚¨ú |
| 3 | **An√°lise Q4** | 1. Compilar dados do trimestre 2. Calcular ROI Black Friday 3. Comparar anos anteriores 4. Documentar insights | Semana 3 | ‚¨ú |
| 4 | **Planejamento Ano Novo** | 1. Definir metas do pr√≥ximo ano 2. Planejar or√ßamento 3. Identificar prioridades 4. Criar roadmap | Semana 3-4 | ‚¨ú |
| 5 | **F√©rias e Escalas** | 1. Definir quem est√° de folga 2. Criar escala m√≠nima 3. Automatizar o poss√≠vel 4. Preparar respostas | Semana 4 | ‚¨ú |

**Meta do M√™s:** [X] vendas | Planejamento do pr√≥ximo ano pronto

---

## üìÜ M√äS 12: ENCERRAMENTO E RENOVA√á√ÉO

**Objetivo do M√™s:** Fechar o ano com chave de ouro e preparar o pr√≥ximo ciclo.

### ‚úÖ Checklist de A√ß√µes (M√™s 12)

| # | A√ß√£o | O Que Fazer (Passo a Passo) | Prazo | Status |
|---|------|----------------------------|-------|--------|
| 1 | **Relat√≥rio Anual** | 1. Compilar 12 meses de dados 2. Calcular ROI anual 3. Comparar metas vs realizado 4. Apresentar resultados | Semana 1-2 | ‚¨ú |
| 2 | **Retrospectiva de Equipe** | 1. Reunir time 2. Celebrar conquistas 3. Discutir aprendizados 4. Agradecer a todos | Semana 2 | ‚¨ú |
| 3 | **Limpeza Geral** | 1. Arquivar leads antigos 2. Limpar base de emails 3. Organizar arquivos 4. Backup de tudo | Semana 2-3 | ‚¨ú |
| 4 | **Renova√ß√£o de Contratos** | 1. Revisar fornecedores 2. Negociar renova√ß√µes 3. Buscar melhores condi√ß√µes 4. Assinar contratos | Semana 3 | ‚¨ú |
| 5 | **Setup Ano Novo** | 1. Criar novos dashboards 2. Zerar contadores 3. Configurar metas 4. Preparar primeira campanha | Semana 4 | ‚¨ú |

**Meta do M√™s:** Ano fechado | Pr√≥ximo ano 100% planejado

---

## üìä RESUMO VISUAL: VIS√ÉO ANUAL

| Trim | Meses | Foco | Meta Leads | Meta Vendas | Investimento |
|------|-------|------|------------|-------------|--------------|
| **Q1** | Jan-Mar | FUNDA√á√ÉO | [Total Q1] | [Total Q1] | R$ [Total Q1] |
| **Q2** | Abr-Jun | CRESCIMENTO | [Total Q2] | [Total Q2] | R$ [Total Q2] |
| **Q3** | Jul-Set | ESCALA | [Total Q3] | [Total Q3] | R$ [Total Q3] |
| **Q4** | Out-Dez | CONVERS√ÉO | [Total Q4] | [Total Q4] | R$ [Total Q4] |
| **ANO** | 12 meses | RESULTADO | [Total Ano] | [Total Ano] | R$ [Total Ano] |

**Legenda de Status:** ‚¨ú Pendente | üîÑ Em andamento | ‚úÖ Conclu√≠do | ‚ö†Ô∏è Atrasado | ‚ùå Cancelado

---

# üí° PARTE 10: RECOMENDA√á√ïES ESTRAT√âGICAS

# ÔøΩüí° PARTE 10: RECOMENDA√á√ïES ESTRAT√âGICAS

## 10.1 Quick Wins (Resultados R√°pidos)
1. [A√ß√£o de resultado r√°pido 1]
2. [A√ß√£o de resultado r√°pido 2]
3. [A√ß√£o de resultado r√°pido 3]

## 10.2 Investimentos Recomendados
| Prioridade | Investimento | Valor | Retorno Esperado |
|------------|--------------|-------|------------------|
| Alta | [O qu√™] | R$ [valor] | [Resultado] |
| M√©dia | [O qu√™] | R$ [valor] | [Resultado] |
| Baixa | [O qu√™] | R$ [valor] | [Resultado] |

## 10.3 Riscos e Mitiga√ß√µes
| Risco | Probabilidade | Impacto | Mitiga√ß√£o |
|-------|---------------|---------|-----------|
| [Risco 1] | [Alta/M√©dia/Baixa] | [Alto/M√©dio/Baixo] | [Como evitar] |
| [Risco 2] | [Alta/M√©dia/Baixa] | [Alto/M√©dio/Baixo] | [Como evitar] |

---

**üìß Este documento deve ser revisado mensalmente.**
**Pr√≥xima revis√£o:** [Data do pr√≥ximo m√™s]

**Mediagrowth - Transformando estrat√©gia em resultados.**`,
        prompt: `Voc√™ √© um consultor da Mediagrowth. Gere o PLANO MESTRE ANUAL completo.`
      }
    };

    // Fun√ß√£o para coletar dados de um entreg√°vel
    function collectEntregavelData(entregavelId) {
      const mapping = ENTREGAVEL_MAPPING[entregavelId];
      if (!mapping) return null;

      const collectedData = {
        title: mapping.title,
        weeks: [],
        notes: [],
        files: [],
        items: []
      };

      // Iterar sobre as semanas mapeadas
      mapping.weeks.forEach(weekId => {
        const weekData = ESTRUTURACAO_DATA.find(w => w.id === weekId);
        const weekState = ESTRUTURACAO_STATE[weekId] || { blocks: {}, weekData: {} };
        
        if (!weekData) return;

        // Coletar notas da semana
        if (weekState.weekData && weekState.weekData.note) {
          collectedData.notes.push({
            source: weekData.title,
            type: 'week_note',
            content: weekState.weekData.note
          });
        }

        // Coletar arquivos da semana
        if (weekState.weekData && weekState.weekData.files && weekState.weekData.files.length > 0) {
          weekState.weekData.files.forEach(file => {
            collectedData.files.push({
              source: weekData.title,
              name: file.name || 'Arquivo',
              url: file.url
            });
          });
        }

        // Iterar sobre os blocos mapeados
        weekData.blocks.forEach(block => {
          // Verificar se o bloco est√° no mapping ou se n√£o h√° blocos espec√≠ficos
          if (mapping.blocks.length === 0 || mapping.blocks.includes(block.id)) {
            const blockState = weekState.blocks[block.id] || { items: {} };

            // Coletar itens e suas notas
            block.items.forEach((itemText, itemIdx) => {
              const itemState = blockState.items[itemIdx] || {};
              
              collectedData.items.push({
                weekTitle: weekData.title,
                blockTitle: block.title,
                text: itemText,
                completed: itemState.completed || false,
                note: itemState.note || ''
              });

              // Coletar notas dos itens
              if (itemState.note && itemState.note.trim()) {
                collectedData.notes.push({
                  source: `${block.title} > ${itemText}`,
                  type: 'item_note',
                  content: itemState.note
                });
              }

              // Coletar arquivos dos itens
              if (itemState.files && itemState.files.length > 0) {
                itemState.files.forEach(file => {
                  collectedData.files.push({
                    source: `${block.title} > ${itemText}`,
                    name: file.name || 'Arquivo',
                    url: file.url
                  });
                });
              }
            });
          }
        });

        collectedData.weeks.push(weekData.title);
      });

      return collectedData;
    }

    // Fun√ß√£o para gerar o prompt completo - VERS√ÉO INTELIGENTE
    function generateDocPrompt(entregavelId, data) {
      const mapping = ENTREGAVEL_MAPPING[entregavelId];
      if (!mapping || !data) return '';

      // Obter insights espec√≠ficos para este entreg√°vel
      const expertiseInsights = getEntregavelExpertiseInsights(entregavelId);
      
      // Obter informa√ß√µes do neg√≥cio (preenchidas pelo usu√°rio)
      const businessInfo = getBusinessInfoForAI();

      // Calcular estat√≠sticas dos dados para dar contexto quantitativo
      const totalItems = data.items.length;
      const completedItems = data.items.filter(i => i.completed);
      const completionRate = totalItems > 0 ? Math.round((completedItems.length / totalItems) * 100) : 0;
      const itemsWithNotes = data.items.filter(i => i.note && i.note.trim()).length;
      const notesQuality = itemsWithNotes > 0 ? 'H√° contexto rico nas anota√ß√µes' : '‚ö†Ô∏è POUCAS ANOTA√á√ïES - voc√™ precisar√° inferir ou sugerir';

      let contextData = `## üìä DADOS COLETADOS DA ESTRUTURA√á√ÉO\n\n`;
      
      // Adicionar informa√ß√µes do neg√≥cio se dispon√≠veis
      if (businessInfo) {
        contextData += businessInfo;
      }
      
      contextData += `**Empresa (cadastro):** ${USER_DATA.company || '[N√£o informado - solicite o nome]'}\n`;
      contextData += `**Respons√°vel:** ${USER_DATA.displayName || '[N√£o informado]'}\n`;
      contextData += `**Data de Gera√ß√£o:** ${new Date().toLocaleDateString('pt-BR')}\n\n`;
      
      // Adicionar an√°lise de completude dos dados
      contextData += `### üìà An√°lise de Completude dos Dados\n\n`;
      contextData += `- **Itens preenchidos:** ${completedItems.length} de ${totalItems} (${completionRate}%)\n`;
      contextData += `- **Itens com anota√ß√µes detalhadas:** ${itemsWithNotes}\n`;
      contextData += `- **Notas gerais coletadas:** ${data.notes.length}\n`;
      contextData += `- **Arquivos anexados:** ${data.files.length}\n`;
      contextData += `- **Qualidade do contexto:** ${notesQuality}\n\n`;

      // Adicionar notas coletadas com categoriza√ß√£o
      if (data.notes.length > 0) {
        contextData += `### üìù Anota√ß√µes Registradas (FONTE PRIM√ÅRIA DE INFORMA√á√ÉO)\n\n`;
        contextData += `> ‚ö†Ô∏è **ATEN√á√ÉO IA**: Estas anota√ß√µes s√£o a principal fonte de dados do cliente.\n`;
        contextData += `> Analise criticamente, identifique gaps e fa√ßa infer√™ncias estrat√©gicas.\n\n`;
        
        data.notes.forEach(note => {
          contextData += `**üîπ ${note.source}:**\n`;
          contextData += `\`\`\`\n${note.content}\n\`\`\`\n\n`;
        });
      } else {
        contextData += `### ‚ö†Ô∏è ATEN√á√ÉO: Nenhuma anota√ß√£o detalhada foi registrada\n\n`;
        contextData += `O consultor n√£o preencheu anota√ß√µes espec√≠ficas para este entreg√°vel.\n`;
        contextData += `**Voc√™ deve:**\n`;
        contextData += `1. Usar os itens marcados como base\n`;
        contextData += `2. Aplicar benchmarks de mercado para preencher gaps\n`;
        contextData += `3. Indicar claramente o que precisa ser validado com o cliente\n\n`;
      }

      // Adicionar itens completados com mais contexto
      if (completedItems.length > 0) {
        contextData += `### ‚úÖ Itens Trabalhados/Conclu√≠dos\n\n`;
        
        // Agrupar por bloco para melhor organiza√ß√£o
        const itemsByBlock = {};
        completedItems.forEach(item => {
          if (!itemsByBlock[item.blockTitle]) {
            itemsByBlock[item.blockTitle] = [];
          }
          itemsByBlock[item.blockTitle].push(item);
        });

        Object.keys(itemsByBlock).forEach(blockTitle => {
          contextData += `**üìÇ ${blockTitle}:**\n`;
          itemsByBlock[blockTitle].forEach(item => {
            contextData += `- ‚úÖ ${item.text}\n`;
            if (item.note) {
              contextData += `  ÔøΩ _"${item.note}"_\n`;
            }
          });
          contextData += '\n';
        });
      }

      // Itens N√ÉO completados (gaps identificados)
      const pendingItems = data.items.filter(i => !i.completed);
      if (pendingItems.length > 0) {
        contextData += `### ‚ö†Ô∏è Itens N√ÉO Trabalhados (GAPS A CONSIDERAR)\n\n`;
        contextData += `> Estes itens n√£o foram marcados como conclu√≠dos. Considere se s√£o relevantes.\n\n`;
        
        const pendingByBlock = {};
        pendingItems.forEach(item => {
          if (!pendingByBlock[item.blockTitle]) {
            pendingByBlock[item.blockTitle] = [];
          }
          pendingByBlock[item.blockTitle].push(item);
        });

        Object.keys(pendingByBlock).forEach(blockTitle => {
          contextData += `**${blockTitle}:**\n`;
          pendingByBlock[blockTitle].forEach(item => {
            contextData += `- ‚è≥ ${item.text}\n`;
          });
          contextData += '\n';
        });
      }

      // Adicionar refer√™ncia de arquivos
      if (data.files.length > 0) {
        contextData += `### üìé Arquivos Anexados\n\n`;
        contextData += `> Estes arquivos foram anexados e podem conter informa√ß√µes adicionais.\n\n`;
        data.files.forEach(file => {
          contextData += `- ÔøΩ **${file.name}** (origem: ${file.source})\n`;
        });
        contextData += '\n';
      }

      // Adicionar semanas coletadas
      if (data.weeks.length > 0) {
        contextData += `### üìÖ Semanas de Origem dos Dados\n\n`;
        contextData += data.weeks.join(', ') + '\n\n';
      }

      // Montar prompt final com intelig√™ncia
      const fullPrompt = `# üéØ GERA√á√ÉO INTELIGENTE DE DOCUMENTO: ${mapping.title}

${MEDIAGROWTH_EXPERTISE_CONTEXT}

${expertiseInsights}

---

## üìã PROMPT ESPEC√çFICO DO ENTREG√ÅVEL

${mapping.promptAnalise || mapping.prompt}

---

${contextData}

---

## ‚ö° INSTRU√á√ïES FINAIS DE GERA√á√ÉO

1. **ANALISE CRITICAMENTE** todos os dados acima antes de gerar
2. **CONECTE os pontos** - como as informa√ß√µes se relacionam?
3. **IDENTIFIQUE GAPS** - o que est√° faltando que voc√™ deveria perguntar?
4. **APLIQUE BENCHMARKS** - compare com os dados de mercado fornecidos
5. **SUGIRA PROATIVAMENTE** - v√° al√©m do √≥bvio, use sua expertise
6. **ALERTE SOBRE RISCOS** - viu algo preocupante? Mencione!
7. **PRIORIZE** - nem tudo tem a mesma import√¢ncia

### üìå Formato de Sa√≠da Esperado

- Use a estrutura do promptAnalise como guia
- Adicione se√ß√µes extras se identificar necessidade
- Inclua uma se√ß√£o **"üß† Insights do Consultor IA"** ao final
- Quando faltar informa√ß√£o, N√ÉO apenas escreva "[Aguardando]"
  - Em vez disso: sugira um valor baseado em benchmarks OU
  - Liste as perguntas espec√≠ficas que devem ser feitas ao cliente

### üîÑ Se√ß√£o Obrigat√≥ria ao Final

Adicione sempre uma se√ß√£o:
**"üìä AN√ÅLISE DE GAPS E RECOMENDA√á√ïES"**
- O que est√° faltando nos dados?
- O que voc√™ assumiu baseado em benchmarks?
- Quais perguntas fazer ao cliente?
- Qual o pr√≥ximo passo recomendado?

---

Gere agora o documento completo e estrat√©gico.`;

      return fullPrompt;
    }

    // Fun√ß√£o principal para gerar o documento
    async function gerarDocEntregavel(entregavelId) {
      const mapping = ENTREGAVEL_MAPPING[entregavelId];
      if (!mapping) {
        alert('Entreg√°vel n√£o encontrado.');
        return;
      }

      // Mostrar modal com loading
      const modal = document.getElementById('docPreviewModal');
      const titleText = document.getElementById('docPreviewTitleText');
      const content = document.getElementById('docPreviewContent');
      const sourceSection = document.getElementById('docPreviewSource');
      const sourceList = document.getElementById('docPreviewSourceList');

      if (!modal) return;

      titleText.textContent = mapping.title;
      content.innerHTML = `
        <div class="doc-preview-loading">
          <div class="spinner-large"></div>
          <span>Coletando dados e gerando documento...</span>
        </div>
      `;
      sourceSection.style.display = 'none';
      modal.classList.add('show');

      try {
        // Coletar dados
        const data = collectEntregavelData(entregavelId);
        
        if (!data || (data.notes.length === 0 && data.items.filter(i => i.completed).length === 0)) {
          content.innerHTML = `
            <div style="text-align:center;padding:40px;color:rgba(255,255,255,.7);">
              <div style="font-size:3rem;margin-bottom:16px;">üìù</div>
              <h3 style="margin:0 0 12px;color:#fff;">Dados insuficientes</h3>
              <p style="margin:0;">Complete as anota√ß√µes nas semanas de estrutura√ß√£o relacionadas a este entreg√°vel para gerar o documento.</p>
              <p style="margin-top:16px;font-size:.85rem;opacity:.7;">
                <strong>Semanas relacionadas:</strong> ${mapping.weeks.map(w => {
                  const week = ESTRUTURACAO_DATA.find(wd => wd.id === w);
                  return week ? week.title : w;
                }).join(', ')}
              </p>
            </div>
          `;
          return;
        }

        // Gerar prompt
        const prompt = generateDocPrompt(entregavelId, data);

        // Verificar se temos a fun√ß√£o de IA dispon√≠vel
        if (typeof window.sendIAMessage === 'function') {
          // Usar a IA do sistema
          const response = await window.sendIAMessage(prompt, true);
          displayGeneratedDoc(response, data);
        } else {
          // Fallback: mostrar o prompt para o usu√°rio copiar
          displayPromptFallback(prompt, data, mapping.title);
        }

      } catch (error) {
        console.error('Erro ao gerar documento:', error);
        content.innerHTML = `
          <div style="text-align:center;padding:40px;color:#ff6b6b;">
            <div style="font-size:3rem;margin-bottom:16px;">‚ö†Ô∏è</div>
            <h3 style="margin:0 0 12px;">Erro ao gerar documento</h3>
            <p style="margin:0;">${error.message || 'Tente novamente mais tarde.'}</p>
          </div>
        `;
      }
    }

    // Exibir documento gerado
    function displayGeneratedDoc(docContent, data) {
      const content = document.getElementById('docPreviewContent');
      const sourceSection = document.getElementById('docPreviewSource');
      const sourceList = document.getElementById('docPreviewSourceList');

      // Renderizar Markdown para HTML
      let htmlContent = docContent;
      if (typeof renderMarkdownText === 'function') {
        htmlContent = renderMarkdownText(docContent);
      }

      content.innerHTML = htmlContent;

      // Mostrar fontes
      if (data && data.weeks && data.weeks.length > 0) {
        sourceSection.style.display = 'block';
        sourceList.innerHTML = data.weeks.map(w => 
          `<span class="doc-preview-source-item">üìÖ ${w}</span>`
        ).join('') + 
        (data.notes.length > 0 ? `<span class="doc-preview-source-item">üìù ${data.notes.length} anota√ß√µes</span>` : '') +
        (data.files.length > 0 ? `<span class="doc-preview-source-item">üìé ${data.files.length} arquivos</span>` : '');
      }

      // Salvar conte√∫do para download/copy
      content.dataset.rawContent = docContent;
    }

    // Fallback: mostrar prompt para copiar
    function displayPromptFallback(prompt, data, title) {
      const content = document.getElementById('docPreviewContent');
      const sourceSection = document.getElementById('docPreviewSource');
      const sourceList = document.getElementById('docPreviewSourceList');

      content.innerHTML = `
        <div style="margin-bottom:20px;">
          <h2 style="color:#fff;margin:0 0 12px;">üìã Prompt para Gera√ß√£o do Documento</h2>
          <p style="color:rgba(255,255,255,.7);margin:0 0 16px;">
            Copie o prompt abaixo e cole em uma ferramenta de IA (ChatGPT, Claude, etc.) para gerar o documento "${title}".
          </p>
        </div>
        <div style="background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:16px;font-family:monospace;font-size:.85rem;white-space:pre-wrap;max-height:400px;overflow:auto;color:rgba(255,255,255,.9);">
${escapeHtml(prompt)}
        </div>
        <div style="margin-top:16px;text-align:center;">
          <button onclick="copyPromptToClipboard()" class="doc-preview-btn primary" style="display:inline-flex;">
            üìã Copiar Prompt
          </button>
        </div>
      `;

      content.dataset.rawContent = prompt;

      // Mostrar fontes
      if (data && data.weeks && data.weeks.length > 0) {
        sourceSection.style.display = 'block';
        sourceList.innerHTML = data.weeks.map(w => 
          `<span class="doc-preview-source-item">üìÖ ${w}</span>`
        ).join('') + 
        (data.notes.length > 0 ? `<span class="doc-preview-source-item">üìù ${data.notes.length} anota√ß√µes</span>` : '') +
        (data.files.length > 0 ? `<span class="doc-preview-source-item">üìé ${data.files.length} arquivos</span>` : '');
      }
    }

    // Copiar prompt para clipboard
    window.copyPromptToClipboard = async function() {
      const content = document.getElementById('docPreviewContent');
      const rawContent = content.dataset.rawContent || content.innerText;
      
      const copiado = await mgCopyToClipboard(rawContent);
      if(copiado) {
        showToast('Prompt copiado para a √°rea de transfer√™ncia!', 'success');
      } else {
        console.error('Erro ao copiar prompt');
        showToast('Erro ao copiar. Selecione e copie manualmente.', 'error');
      }
    };

    // Exportar fun√ß√£o para uso global
    window.gerarDocEntregavel = gerarDocEntregavel;

    // Event listeners do modal de preview
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('docPreviewModal');
      const closeBtn = document.getElementById('docPreviewCloseBtn');
      const copyBtn = document.getElementById('docPreviewCopyBtn');
      const downloadBtn = document.getElementById('docPreviewDownloadBtn');

      if (closeBtn) {
        closeBtn.addEventListener('click', () => {
          modal.classList.remove('show');
        });
      }

      if (copyBtn) {
        copyBtn.addEventListener('click', async () => {
          const content = document.getElementById('docPreviewContent');
          const rawContent = content.dataset.rawContent || content.innerText;
          
          const copiado = await mgCopyToClipboard(rawContent);
          if(copiado) {
            showToast('Conte√∫do copiado!', 'success');
          } else {
            console.error('Erro ao copiar conte√∫do');
            showToast('Erro ao copiar. Tente selecionar e copiar manualmente.', 'error');
          }
        });
      }

      if (downloadBtn) {
        downloadBtn.addEventListener('click', () => {
          const content = document.getElementById('docPreviewContent');
          const titleText = document.getElementById('docPreviewTitleText');
          const rawContent = content.dataset.rawContent || content.innerText;
          const fileName = (titleText.textContent || 'documento').replace(/[^a-zA-Z0-9]/g, '_') + '.md';
          
          const blob = new Blob([rawContent], { type: 'text/markdown;charset=utf-8' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          
          showToast('Documento baixado!', 'success');
        });
      }

      // Fechar modal ao clicar fora
      if (modal) {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.classList.remove('show');
          }
        });
      }
    });

    // ===== AN√ÅLISE COM GR√ÅFICOS =====
    let analiseCharts = {
      pizza: null,
      barras: null,
      linha: null,
      radar: null
    };

    // Cores para os gr√°ficos
    const ANALISE_COLORS = {
      primary: '#10b981',
      secondary: '#6366f1',
      warning: '#f59e0b',
      danger: '#ef4444',
      success: '#22c55e',
      info: '#3b82f6',
      purple: '#8b5cf6',
      pink: '#ec4899'
    };

    // Coletar dados expandidos para an√°lise
    function collectAnaliseData(entregavelId) {
      const mapping = ENTREGAVEL_MAPPING[entregavelId];
      if (!mapping) return null;

      const data = {
        title: mapping.title,
        weeks: [],
        totalItems: 0,
        completedItems: 0,
        pendingItems: 0,
        notes: [],
        files: [],
        midiasTagueadas: [], // M√≠dias tagueadas espec√≠ficas para este entreg√°vel
        weekProgress: [],
        monthlyData: {},
        dimensions: {
          completude: 0,
          documentacao: 0,
          qualidade: 0,
          organizacao: 0,
          engajamento: 0
        }
      };

      // Processar cada semana mapeada
      mapping.weeks.forEach(weekId => {
        const weekData = ESTRUTURACAO_DATA.find(w => w.id === weekId);
        if (!weekData) return;

        const weekState = ESTRUTURACAO_STATE[weekId] || { blocks: {}, weekData: {} };
        let weekCompleted = 0;
        let weekTotal = 0;
        let weekNotes = 0;

        // Coletar nota geral da semana
        if (weekState.weekData && weekState.weekData.note && weekState.weekData.note.trim()) {
          data.notes.push({
            week: weekData.title,
            block: 'üìù Nota Geral da Semana',
            item: 'Anota√ß√£o da Semana',
            content: weekState.weekData.note,
            date: weekState.weekData.noteDate || null
          });
        }

        // Processar blocos espec√≠ficos ou todos os blocos
        const blocksToProcess = mapping.blocks && mapping.blocks[weekId] 
          ? mapping.blocks[weekId].map(idx => weekData.blocks[idx]).filter(Boolean)
          : weekData.blocks;

        blocksToProcess.forEach(block => {
          if (!block.items) return;
          
          const blockState = weekState.blocks[block.id] || { items: {}, notes: '' };
          
          // Coletar nota do bloco
          if (blockState.notes && blockState.notes.trim()) {
            data.notes.push({
              week: weekData.title,
              block: block.title,
              item: 'üìã Nota do Bloco',
              content: blockState.notes,
              date: null
            });
          }
          
          block.items.forEach((itemText, itemIdx) => {
            weekTotal++;
            data.totalItems++;
            
            const itemState = blockState.items[itemIdx] || {};
            
            if (itemState.completed) {
              weekCompleted++;
              data.completedItems++;
            } else {
              data.pendingItems++;
            }

            // Coletar anota√ß√µes dos itens
            if (itemState.note && itemState.note.trim()) {
              data.notes.push({
                week: weekData.title,
                block: block.title,
                item: itemText,
                content: itemState.note,
                date: itemState.noteDate || null
              });
              weekNotes++;
            }

            // Coletar arquivos
            if (itemState.files && itemState.files.length > 0) {
              itemState.files.forEach(file => {
                data.files.push({
                  week: weekData.title,
                  block: block.title,
                  item: itemText,
                  ...file
                });
              });
            }
          });
        });

        const weekProgressPct = weekTotal > 0 ? Math.round((weekCompleted / weekTotal) * 100) : 0;
        data.weekProgress.push({
          title: weekData.title.replace('Semana ', 'S'),
          completed: weekCompleted,
          total: weekTotal,
          percentage: weekProgressPct,
          notes: weekNotes
        });

        data.weeks.push(weekData.title);

        // Agrupar por m√™s (simular evolu√ß√£o mensal)
        const monthKey = `M√™s ${Math.ceil((parseInt(weekId.replace('semana', '')) || 1) / 4)}`;
        if (!data.monthlyData[monthKey]) {
          data.monthlyData[monthKey] = { completed: 0, total: 0 };
        }
        data.monthlyData[monthKey].completed += weekCompleted;
        data.monthlyData[monthKey].total += weekTotal;
      });

      // Calcular dimens√µes
      const progressPct = data.totalItems > 0 ? (data.completedItems / data.totalItems) * 100 : 0;
      const notesPct = Math.min(100, (data.notes.length / Math.max(data.totalItems, 1)) * 150);
      const filesPct = Math.min(100, (data.files.length / Math.max(data.totalItems, 1)) * 200);
      
      data.dimensions.completude = Math.round(progressPct);
      data.dimensions.documentacao = Math.round(notesPct);
      data.dimensions.qualidade = Math.round((progressPct * 0.5) + (notesPct * 0.3) + (filesPct * 0.2));
      data.dimensions.organizacao = data.weeks.length > 0 ? Math.round(Math.min(100, (data.weekProgress.filter(w => w.percentage > 50).length / data.weeks.length) * 100)) : 0;
      data.dimensions.engajamento = Math.round((notesPct * 0.6) + (filesPct * 0.4));

      return data;
    }

    // Destruir gr√°ficos anteriores
    function destroyAnaliseCharts() {
      Object.keys(analiseCharts).forEach(key => {
        if (analiseCharts[key]) {
          analiseCharts[key].destroy();
          analiseCharts[key] = null;
        }
      });
      
      // Limpar containers HTML dos gr√°ficos especiais do diagn√≥stico
      ['funilVisualDiagnostico', 'mapaDiferenciacaoVisual', 'clarezaMarcaVisual', 'sazonalidadeLegenda'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = '';
      });
    }

    // Mapeamento de tipos de gr√°fico para configura√ß√µes
    const CHART_CONFIG = {
      funnel: { icon: 'üîÑ', title: 'Funil de Convers√£o', type: 'bar', description: 'Mostra as etapas do funil de vendas e onde ocorrem as maiores perdas de convers√£o.' },
      radar: { icon: 'üéØ', title: 'Radar de Maturidade', type: 'radar', description: 'Avalia m√∫ltiplas dimens√µes simultaneamente, revelando pontos fortes e √°reas de melhoria.' },
      matrix: { icon: 'üìä', title: 'Matriz Estrat√©gica', type: 'scatter', description: 'Posiciona elementos em dois eixos para an√°lise comparativa de impacto vs. esfor√ßo.' },
      line: { icon: 'üìà', title: 'Evolu√ß√£o/Proje√ß√£o', type: 'line', description: 'Visualiza tend√™ncias ao longo do tempo e projeta resultados futuros esperados.' },
      bar: { icon: 'üìä', title: 'Comparativo', type: 'bar', description: 'Compara valores entre diferentes categorias de forma clara e objetiva.' },
      gauge: { icon: 'üéØ', title: 'Indicador de Meta', type: 'doughnut', description: 'Mostra o progresso em rela√ß√£o √† meta estabelecida de forma visual e intuitiva.' },
      scatter: { icon: 'üó∫Ô∏è', title: 'Mapa de Posicionamento', type: 'scatter', description: 'Posiciona elementos no mercado em rela√ß√£o a pre√ßo, valor e competitividade.' },
      comparison: { icon: '‚öîÔ∏è', title: 'An√°lise Comparativa', type: 'bar', description: 'Compara sua empresa com concorrentes em aspectos-chave do mercado.' },
      wordcloud: { icon: '‚òÅÔ∏è', title: 'Tend√™ncias', type: 'bar', description: 'Identifica os termos e temas mais relevantes para o seu p√∫blico-alvo.' },
      heatmap: { icon: 'üî•', title: 'Matriz de Intensidade', type: 'bar', description: 'Mostra a intensidade de atividades ou engajamento em diferentes per√≠odos.' },
      journey: { icon: 'üõ§Ô∏è', title: 'Jornada do Cliente', type: 'line', description: 'Mapeia os pontos de contato e emo√ß√µes do cliente ao longo da experi√™ncia.' },
      pyramid: { icon: 'üî∫', title: 'Pir√¢mide de Valor', type: 'bar', description: 'Hierarquiza propostas de valor do b√°sico ao diferencial exclusivo.' },
      perception: { icon: 'üëÅÔ∏è', title: 'Percep√ß√£o', type: 'radar', description: 'Avalia como a marca √© percebida em diferentes atributos pelo p√∫blico.' },
      persona: { icon: 'üë§', title: 'Perfil de Persona', type: 'radar', description: 'Caracteriza o cliente ideal em m√∫ltiplas dimens√µes comportamentais.' },
      channels: { icon: 'üì±', title: 'Canais Priorit√°rios', type: 'doughnut', description: 'Distribui a prioridade entre os canais de comunica√ß√£o e vendas.' },
      pie: { icon: 'ü•ß', title: 'Distribui√ß√£o', type: 'doughnut', description: 'Mostra a propor√ß√£o de cada elemento em rela√ß√£o ao todo.' },
      projection: { icon: 'üìà', title: 'Simula√ß√£o de Resultados', type: 'line', description: 'Projeta cen√°rios futuros baseados em premissas e tend√™ncias atuais.' },
      sitemap: { icon: 'üó∫Ô∏è', title: 'Arquitetura', type: 'bar', description: 'Mapeia a estrutura de p√°ginas e se√ß√µes do site ou plataforma.' },
      userflow: { icon: 'üîÑ', title: 'Fluxo do Usu√°rio', type: 'line', description: 'Visualiza o caminho que o usu√°rio percorre at√© a convers√£o.' },
      keywords: { icon: 'üîç', title: 'Palavras-chave', type: 'bar', description: 'Identifica as palavras-chave mais relevantes para SEO e conte√∫do.' },
      calendar: { icon: 'üìÖ', title: 'Calend√°rio de Conte√∫do', type: 'bar', description: 'Distribui√ß√£o de publica√ß√µes ao longo do per√≠odo planejado.' },
      messagemap: { icon: 'üí¨', title: 'Mapa de Mensagens', type: 'radar', description: 'Organiza as mensagens-chave por tipo e objetivo de comunica√ß√£o.' },
      triggers: { icon: 'üß†', title: 'Gatilhos Mentais', type: 'bar', description: 'Prioriza os gatilhos psicol√≥gicos mais efetivos para persuas√£o.' },
      workflow: { icon: '‚öôÔ∏è', title: 'Fluxo de Produ√ß√£o', type: 'line', description: 'Visualiza as etapas do processo de cria√ß√£o e aprova√ß√£o de conte√∫do.' },
      types: { icon: 'üé¨', title: 'Tipos de Conte√∫do', type: 'doughnut', description: 'Distribui√ß√£o entre tipos de conte√∫do: educativo, institucional, convers√£o.' },
      formats: { icon: 'üñºÔ∏è', title: 'Formatos', type: 'bar', description: 'Compara a performance e prioridade de diferentes formatos de m√≠dia.' },
      testing: { icon: 'üß™', title: 'Matriz de Testes', type: 'bar', description: 'Organiza experimentos de A/B testing por impacto e complexidade.' },
      pipeline: { icon: 'üîÑ', title: 'Pipeline de Vendas', type: 'bar', description: 'Mostra o volume de oportunidades em cada fase do processo comercial.' },
      conversion: { icon: 'üìä', title: 'Convers√£o por Etapa', type: 'bar', description: 'Taxa de convers√£o entre cada etapa do funil de vendas.' },
      timeline: { icon: '‚è±Ô∏è', title: 'Tempo de Resposta', type: 'bar', description: 'Mede o tempo m√©dio de resposta em cada ponto de contato com o cliente.' },
      losspoints: { icon: 'üî¥', title: 'Pontos de Perda', type: 'bar', description: 'Identifica onde e por que os leads est√£o sendo perdidos no processo.' },
      cycle: { icon: 'üîÑ', title: 'Ciclo de Vendas', type: 'doughnut', description: 'Visualiza a dura√ß√£o m√©dia do ciclo de vendas e suas fases.' },
      wireframe: { icon: 'üìÑ', title: 'Estrutura da P√°gina', type: 'bar', description: 'Representa os elementos e se√ß√µes de uma p√°gina de convers√£o.' },
      hotspots: { icon: 'üî•', title: 'Pontos de Convers√£o', type: 'bar', description: 'Mapeia as √°reas de maior engajamento e cliques nas p√°ginas.' },
      checklist: { icon: '‚úÖ', title: 'Checklist', type: 'bar', description: 'Acompanha a completude de itens essenciais para o entreg√°vel.' },
      brandbook: { icon: 'üé®', title: 'Identidade Visual', type: 'radar', description: 'Avalia a consist√™ncia e aplica√ß√£o dos elementos da marca.' },
      ecosystem: { icon: 'üåê', title: 'Ecossistema', type: 'radar', description: 'Mapeia a integra√ß√£o entre canais, ferramentas e plataformas.' },
      consistency: { icon: '‚úì', title: 'Consist√™ncia', type: 'bar', description: 'Mede a uniformidade da comunica√ß√£o em diferentes pontos de contato.' },
      dataflow: { icon: 'üîÑ', title: 'Fluxo de Dados', type: 'line', description: 'Visualiza como os dados fluem entre sistemas e etapas do processo.' },
      modules: { icon: 'üì¶', title: 'M√≥dulos', type: 'bar', description: 'Organiza os m√≥dulos e funcionalidades da plataforma ou sistema.' }
    };

    // Renderizar gr√°fico din√¢mico baseado no tipo
    function renderDynamicChart(canvasId, chartType, data, mapping, chartKey) {
      const canvas = document.getElementById(canvasId);
      if (!canvas || typeof Chart === 'undefined') return;

      const ctx = canvas.getContext('2d');
      const config = CHART_CONFIG[chartType] || CHART_CONFIG.bar;
      
      // Dados base para diferentes tipos de gr√°ficos
      let chartConfig = {};
      
      switch(config.type) {
        case 'doughnut':
          chartConfig = createDoughnutConfig(data, chartType, mapping);
          break;
        case 'bar':
          chartConfig = createBarConfig(data, chartType, mapping);
          break;
        case 'line':
          chartConfig = createLineConfig(data, chartType, mapping);
          break;
        case 'radar':
          chartConfig = createRadarConfig(data, chartType, mapping);
          break;
        case 'scatter':
          chartConfig = createScatterConfig(data, chartType, mapping);
          break;
        default:
          chartConfig = createBarConfig(data, chartType, mapping);
      }
      
      analiseCharts[chartKey] = new Chart(ctx, chartConfig);
    }

    // Configura√ß√£o de gr√°fico Doughnut/Pie
    function createDoughnutConfig(data, chartType, mapping) {
      let labels, values, bgColors;
      
      switch(chartType) {
        case 'funnel':
          labels = ['Visitantes', 'Leads', 'Or√ßamentos', 'Vendas'];
          values = [100, Math.round(data.dimensions.completude * 0.6), Math.round(data.dimensions.completude * 0.3), Math.round(data.dimensions.completude * 0.15)];
          bgColors = ['#6366f1', '#8b5cf6', '#a855f7', '#10b981'];
          break;
        case 'channels':
        case 'pie':
          labels = mapping.radarLabels || ['Canal 1', 'Canal 2', 'Canal 3', 'Canal 4', 'Canal 5'];
          values = labels.map((_, i) => 20 + Math.random() * 30);
          bgColors = ['#10b981', '#6366f1', '#f59e0b', '#ef4444', '#8b5cf6'];
          break;
        case 'gauge':
        case 'cycle':
          labels = ['Alcan√ßado', 'Restante'];
          values = [data.dimensions.completude, 100 - data.dimensions.completude];
          bgColors = ['#10b981', 'rgba(255,255,255,0.1)'];
          break;
        case 'types':
          labels = ['Institucional', 'Educativo', 'Convers√£o', 'Engajamento'];
          values = [25, 35, 20, 20];
          bgColors = ['#6366f1', '#10b981', '#f59e0b', '#8b5cf6'];
          break;
        default:
          labels = ['Conclu√≠do', 'Pendente'];
          values = [data.completedItems, data.pendingItems];
          bgColors = [ANALISE_COLORS.success, ANALISE_COLORS.warning];
      }
      
      return {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{ data: values, backgroundColor: bgColors, borderColor: 'rgba(0,0,0,0.3)', borderWidth: 2 }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: chartType === 'gauge' ? '75%' : '60%',
          plugins: {
            legend: { position: 'bottom', labels: { color: 'rgba(255,255,255,0.8)', padding: 12 } }
          }
        }
      };
    }

    // Configura√ß√£o de gr√°fico Bar
    function createBarConfig(data, chartType, mapping) {
      let labels, values, bgColors;
      
      switch(chartType) {
        case 'funnel':
          labels = ['Visitantes', 'Leads', 'Or√ßamentos', 'Vendas'];
          values = [100, 60, 30, 15];
          bgColors = labels.map((_, i) => `rgba(99, 102, 241, ${1 - i * 0.2})`);
          break;
        case 'comparison':
          labels = ['Sua Empresa', 'Concorrente 1', 'Concorrente 2', 'Concorrente 3'];
          values = [data.dimensions.completude, 65, 72, 58];
          bgColors = ['#10b981', '#6366f1', '#8b5cf6', '#a855f7'];
          break;
        case 'wordcloud':
        case 'keywords':
          labels = ['Principal', 'Secund√°ria', 'Long-tail 1', 'Long-tail 2', 'Long-tail 3'];
          values = [100, 75, 50, 45, 40];
          bgColors = ['#10b981', '#10b981', '#6366f1', '#6366f1', '#6366f1'];
          break;
        case 'heatmap':
        case 'matrix':
          labels = ['Baixo Impacto', 'M√©dio Impacto', 'Alto Impacto', 'Cr√≠tico'];
          values = [20, 35, 30, 15];
          bgColors = ['#22c55e', '#f59e0b', '#ef4444', '#dc2626'];
          break;
        case 'pipeline':
        case 'conversion':
          labels = ['Novo Lead', 'Em Contato', 'Negocia√ß√£o', 'Proposta', 'Fechamento'];
          values = [100, 80, 50, 30, 15];
          bgColors = ['#6366f1', '#8b5cf6', '#a855f7', '#f59e0b', '#10b981'];
          break;
        case 'timeline':
        case 'losspoints':
          labels = data.weekProgress.map(w => w.title);
          values = data.weekProgress.map(w => w.percentage);
          bgColors = data.weekProgress.map(w => 
            w.percentage >= 80 ? '#10b981' :
            w.percentage >= 50 ? '#6366f1' :
            w.percentage >= 25 ? '#f59e0b' : '#ef4444'
          );
          break;
        case 'formats':
        case 'sitemap':
        case 'wireframe':
        case 'hotspots':
        case 'checklist':
        case 'consistency':
        case 'modules':
        case 'triggers':
        case 'testing':
          labels = ['Elemento 1', 'Elemento 2', 'Elemento 3', 'Elemento 4', 'Elemento 5'];
          values = [data.dimensions.completude, data.dimensions.documentacao, data.dimensions.qualidade, data.dimensions.organizacao, data.dimensions.engajamento];
          bgColors = ['#10b981', '#6366f1', '#8b5cf6', '#f59e0b', '#ef4444'];
          break;
        case 'calendar':
          labels = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b', 'Dom'];
          values = [3, 2, 3, 2, 3, 1, 1];
          bgColors = ['#10b981', '#10b981', '#10b981', '#10b981', '#10b981', '#6366f1', '#6366f1'];
          break;
        default:
          labels = data.weekProgress.map(w => w.title);
          values = data.weekProgress.map(w => w.percentage);
          bgColors = values.map(v => v >= 80 ? '#10b981' : v >= 50 ? '#6366f1' : v >= 25 ? '#f59e0b' : '#ef4444');
      }
      
      return {
        type: 'bar',
        data: {
          labels,
          datasets: [{ 
            label: 'Valor', 
            data: values, 
            backgroundColor: bgColors, 
            borderRadius: 6, 
            borderSkipped: false 
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: chartType === 'funnel' ? 'y' : 'x',
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { display: false }, ticks: { color: 'rgba(255,255,255,0.7)' } },
            y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: 'rgba(255,255,255,0.7)' } }
          }
        }
      };
    }

    // Configura√ß√£o de gr√°fico Line
    function createLineConfig(data, chartType, mapping) {
      const months = Object.keys(data.monthlyData).sort();
      let labels, values, label;
      
      switch(chartType) {
        case 'journey':
        case 'userflow':
        case 'workflow':
        case 'dataflow':
          labels = ['Etapa 1', 'Etapa 2', 'Etapa 3', 'Etapa 4', 'Etapa 5'];
          values = [100, 85, 70, 55, 45];
          label = 'Fluxo';
          break;
        case 'projection':
          labels = ['M√™s 1', 'M√™s 2', 'M√™s 3', 'M√™s 4', 'M√™s 5', 'M√™s 6'];
          values = [0, 20, 40, 60, 80, 100].map(v => v * (data.dimensions.completude / 100) + 10);
          label = 'Proje√ß√£o';
          break;
        default:
          labels = months.length > 0 ? months : ['M√™s 1', 'M√™s 2', 'M√™s 3'];
          let accumulated = 0;
          values = months.length > 0 ? months.map(m => {
            accumulated += data.monthlyData[m].completed;
            const totalSoFar = months.slice(0, months.indexOf(m) + 1)
              .reduce((sum, mk) => sum + data.monthlyData[mk].total, 0);
            return totalSoFar > 0 ? Math.round((accumulated / totalSoFar) * 100) : 0;
          }) : [30, 60, 90];
          label = 'Evolu√ß√£o';
      }
      
      return {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label,
            data: values,
            borderColor: '#10b981',
            backgroundColor: 'rgba(16,185,129,0.1)',
            fill: true,
            tension: 0.4,
            pointRadius: 6,
            pointBackgroundColor: '#10b981',
            pointBorderColor: '#fff',
            pointBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: true, position: 'bottom', labels: { color: 'rgba(255,255,255,0.8)' } } },
          scales: {
            x: { grid: { display: false }, ticks: { color: 'rgba(255,255,255,0.7)' } },
            y: { min: 0, max: 100, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: 'rgba(255,255,255,0.7)', callback: v => v + '%' } }
          }
        }
      };
    }

    // Configura√ß√£o de gr√°fico Radar
    function createRadarConfig(data, chartType, mapping) {
      const labels = mapping.radarLabels || ['Completude', 'Documenta√ß√£o', 'Qualidade', 'Organiza√ß√£o', 'Engajamento'];
      const values = labels.map((_, i) => {
        const dims = [data.dimensions.completude, data.dimensions.documentacao, data.dimensions.qualidade, data.dimensions.organizacao, data.dimensions.engajamento];
        return dims[i % dims.length];
      });
      
      return {
        type: 'radar',
        data: {
          labels,
          datasets: [{
            label: 'Avalia√ß√£o',
            data: values,
            backgroundColor: 'rgba(16,185,129,0.2)',
            borderColor: '#10b981',
            borderWidth: 2,
            pointBackgroundColor: '#10b981',
            pointBorderColor: '#fff',
            pointRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            r: {
              min: 0,
              max: 100,
              ticks: { stepSize: 25, color: 'rgba(255,255,255,0.5)', backdropColor: 'transparent' },
              grid: { color: 'rgba(255,255,255,0.15)' },
              angleLines: { color: 'rgba(255,255,255,0.15)' },
              pointLabels: { color: 'rgba(255,255,255,0.8)', font: { size: 11 } }
            }
          }
        }
      };
    }

    // Configura√ß√£o de gr√°fico Scatter (Mapa de Posicionamento)
    function createScatterConfig(data, chartType, mapping) {
      const points = [
        { x: 80, y: 85, label: 'Sua Empresa' },
        { x: 60, y: 70, label: 'Concorrente 1' },
        { x: 70, y: 50, label: 'Concorrente 2' },
        { x: 40, y: 60, label: 'Concorrente 3' }
      ];
      
      return {
        type: 'scatter',
        data: {
          datasets: [{
            label: 'Posicionamento',
            data: points.map(p => ({ x: p.x, y: p.y })),
            backgroundColor: ['#10b981', '#6366f1', '#8b5cf6', '#f59e0b'],
            pointRadius: 12,
            pointHoverRadius: 16
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => points[ctx.dataIndex]?.label || `Ponto ${ctx.dataIndex + 1}`
              }
            }
          },
          scales: {
            x: { 
              min: 0, max: 100, 
              title: { display: true, text: 'Pre√ßo', color: 'rgba(255,255,255,0.7)' },
              grid: { color: 'rgba(255,255,255,0.1)' }, 
              ticks: { color: 'rgba(255,255,255,0.7)' } 
            },
            y: { 
              min: 0, max: 100, 
              title: { display: true, text: 'Valor Percebido', color: 'rgba(255,255,255,0.7)' },
              grid: { color: 'rgba(255,255,255,0.1)' }, 
              ticks: { color: 'rgba(255,255,255,0.7)' } 
            }
          }
        }
      };
    }

    // Configurar gr√°ficos din√¢micos baseados no entreg√°vel
    // NOTA: Gr√°ficos desativados - exibir apenas An√°lise Estrat√©gica Profunda em texto
    function setupDynamicCharts(data, mapping, entregavelId) {
      // ================================================================
      // ESCONDER TODOS OS GR√ÅFICOS para todos os entreg√°veis
      // Exibir apenas a An√°lise Estrat√©gica Profunda (texto da IA)
      // ================================================================
      
      // 1. Cards de m√©tricas (Progresso Geral, Tarefas Conclu√≠das, Pendentes, Anota√ß√µes) - ESCONDER
      const metricsRow = document.querySelector('.analise-metrics-row');
      if (metricsRow) metricsRow.style.display = 'none';
      
      // 2. Gr√°fico Prim√°rio (Mapa de Posicionamento) - ESCONDER
      const chartCardPrimary = document.getElementById('chartCardPrimary');
      if (chartCardPrimary) chartCardPrimary.style.display = 'none';
      
      // 3. Gr√°fico Secund√°rio (An√°lise Comparativa) - ESCONDER
      const chartCardSecondary = document.getElementById('chartCardSecondary');
      if (chartCardSecondary) chartCardSecondary.style.display = 'none';
      
      // 4. Gr√°fico Terci√°rio (Tend√™ncias) - ESCONDER
      const chartCardTertiary = document.getElementById('chartCardTertiary');
      if (chartCardTertiary) chartCardTertiary.style.display = 'none';
      
      // 5. Gr√°fico Radar (Pre√ßo, Qualidade, Atendimento...) - ESCONDER
      const chartCardRadar = document.getElementById('chartCardRadar');
      if (chartCardRadar) chartCardRadar.style.display = 'none';
      
      // 6. Gr√°ficos especiais do Diagn√≥stico Estrat√©gico - ESCONDER
      const chartCardFunilDetalhado = document.getElementById('chartCardFunilDetalhado');
      if (chartCardFunilDetalhado) chartCardFunilDetalhado.style.display = 'none';
      
      const chartCardMapaDiferenciacao = document.getElementById('chartCardMapaDiferenciacao');
      if (chartCardMapaDiferenciacao) chartCardMapaDiferenciacao.style.display = 'none';
      
      const chartCardSazonalidade = document.getElementById('chartCardSazonalidade');
      if (chartCardSazonalidade) chartCardSazonalidade.style.display = 'none';
      
      const chartCardClarezaMarca = document.getElementById('chartCardClarezaMarca');
      if (chartCardClarezaMarca) chartCardClarezaMarca.style.display = 'none';
      
      console.log('üìä Gr√°ficos desativados - exibindo apenas An√°lise Estrat√©gica Profunda');
    }

    // Renderizar Radar com labels customizadas
    function renderRadarWithCustomLabels(data, mapping) {
      const canvas = document.getElementById('chartRadarDimensoes');
      if (!canvas || typeof Chart === 'undefined') return;

      const ctx = canvas.getContext('2d');
      const labels = mapping.radarLabels || ['Completude', 'Documenta√ß√£o', 'Qualidade', 'Organiza√ß√£o', 'Engajamento'];
      const dims = [data.dimensions.completude, data.dimensions.documentacao, data.dimensions.qualidade, data.dimensions.organizacao, data.dimensions.engajamento];
      const values = labels.map((_, i) => dims[i % dims.length]);
      
      analiseCharts.radar = new Chart(ctx, {
        type: 'radar',
        data: {
          labels,
          datasets: [{
            label: 'Avalia√ß√£o',
            data: values,
            backgroundColor: 'rgba(16,185,129,0.2)',
            borderColor: '#10b981',
            borderWidth: 2,
            pointBackgroundColor: '#10b981',
            pointBorderColor: '#fff',
            pointRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            r: {
              min: 0,
              max: 100,
              ticks: { stepSize: 25, color: 'rgba(255,255,255,0.5)', backdropColor: 'transparent' },
              grid: { color: 'rgba(255,255,255,0.15)' },
              angleLines: { color: 'rgba(255,255,255,0.15)' },
              pointLabels: { color: 'rgba(255,255,255,0.8)', font: { size: 11 } }
            }
          }
        }
      });
    }

    // ===== NOVOS GR√ÅFICOS: DIAGN√ìSTICO ESTRAT√âGICO COMPLETO =====
    
    // Fun√ß√£o para chamar a IA via OpenRouter (aiProxy) - protege a API key no backend
    // Agora usa window.callAIProxy que tem fallback autom√°tico
    async function callGeminiAPI(prompt) {
      try {
        // Obter userId para rate limiting (usa auth modular do Firebase)
        const userId = (auth && auth.currentUser) ? auth.currentUser.uid : 'anonymous-' + Date.now();
        
        console.log('ü§ñ [IA/OpenRouter] Enviando requisi√ß√£o via callAIProxy...');
        console.log('ü§ñ [IA/OpenRouter] userId:', userId);
        console.log('ü§ñ [IA/OpenRouter] Tamanho do prompt:', prompt?.length || 0, 'caracteres');
        
        // Usar callAIProxy que tem fallback para m√∫ltiplas URLs
        const data = await window.callAIProxy(
          'google/gemini-2.5-flash',
          [{ role: 'user', content: prompt }],
          userId,
          8192,
          0.3
        );
        
        // OpenRouter retorna no formato OpenAI: choices[0].message.content
        const text = data?.choices?.[0]?.message?.content;
        console.log('ü§ñ [IA/OpenRouter] Resposta recebida:', text ? 'Texto OK (' + text.length + ' chars)' : 'Sem texto');
        
        if (text) {
          return text;
        }
        
        console.warn('ü§ñ [IA/OpenRouter] Resposta inesperada:', data);
        return null;
      } catch (error) {
        console.error('ü§ñ [IA/OpenRouter] Erro na requisi√ß√£o:', error);
        // Mostrar toast com mensagem amig√°vel se for erro de API key
        if (error.isAPIKeyError && typeof mgToast === 'function') {
          mgToast(error.message, 'error');
        }
        return null;
      }
    }
    
    // Sistema de an√°lise estruturada com IA para o Diagn√≥stico Estrat√©gico
    const DIAGNOSTICO_ESTRATEGICO = {
      dadosAnalisados: null,
      
      // An√°lise principal - processa todas as notas e cria estrutura coerente
      async analisarNotasComIA(data) {
        // Criar resumo textual de todas as notas para enviar √† IA
        const notasTexto = data.notes.map(n => 
          `[${n.block}] ${n.item}: ${n.content}`
        ).join('\n');
        
        // Se n√£o h√° notas suficientes, usar dados padr√£o
        if (data.notes.length < 3) {
          return this.gerarDadosPadrao(data);
        }
        
        // Tentar gerar an√°lise com IA
        try {
          const prompt = `Analise estas anota√ß√µes de estrutura√ß√£o empresarial e extraia dados estruturados para um diagn√≥stico estrat√©gico de marketing e vendas.

ANOTA√á√ïES DO CLIENTE:
${notasTexto.substring(0, 4000)}

TOTAL DE ITENS: ${data.totalItems} | CONCLU√çDOS: ${data.completedItems}

Responda APENAS com um JSON v√°lido (sem markdown, sem explica√ß√µes) no formato:
{
  "funil": {
    "visitantesMes": [n√∫mero estimado de visitantes/acessos mensais, baseado nas notas ou 5000 se n√£o mencionado],
    "leadsMes": [n√∫mero de leads/contatos mensais, baseado nas notas ou calcule 3% dos visitantes],
    "taxaQualificacao": [percentual de leads qualificados, 30-70%, baseado nas notas],
    "orcamentosMes": [n√∫mero de or√ßamentos/propostas, baseado nas notas],
    "vendasMes": [n√∫mero de vendas/clientes fechados por m√™s],
    "ticketMedio": [valor m√©dio por venda em reais, ex: 150],
    "faturamentoMes": [faturamento mensal em reais]
  },
  "concorrentes": [
    {"nome": "Nome do concorrente 1", "posicao": "forte/medio/fraco", "diferencial": "o que ele faz bem"},
    {"nome": "Nome do concorrente 2", "posicao": "forte/medio/fraco", "diferencial": "o que ele faz bem"}
  ],
  "diferenciais": ["diferencial 1 da empresa", "diferencial 2", "diferencial 3"],
  "gargalos": ["gargalo 1 identificado", "gargalo 2"],
  "oportunidades": ["oportunidade 1", "oportunidade 2"],
  "sazonalidade": {
    "mesesPico": ["nome dos meses de alta demanda"],
    "mesesBaixa": ["nome dos meses de baixa"],
    "padrao": "fim_de_ano ou verao ou inverno ou constante"
  },
  "marca": {
    "clarezaAtual": [0-100, baseado nas notas sobre marca/identidade],
    "consistenciaVisual": [0-100],
    "diferenciacaoPercebida": [0-100],
    "confianca": [0-100]
  }
}`;

          const response = await callGeminiAPI(prompt);
          
          if (response) {
            // Limpar resposta e fazer parse
            let jsonStr = response.trim();
            if (jsonStr.startsWith('```')) {
              jsonStr = jsonStr.replace(/```json?\n?/g, '').replace(/```/g, '');
            }
            
            const dadosIA = JSON.parse(jsonStr);
            this.dadosAnalisados = this.validarECorrigirDados(dadosIA, data);
            return this.dadosAnalisados;
          }
        } catch (error) {
          console.warn('Erro ao analisar com IA, usando an√°lise local:', error);
        }
        
        // Fallback: an√°lise local
        return this.analisarLocalmente(data);
      },
      
      // Validar e corrigir dados para garantir coer√™ncia
      validarECorrigirDados(dados, dataOriginal) {
        const d = dados || {};
        const completude = dataOriginal.dimensions?.completude || 50;
        
        // Funil - garantir valores realistas e coerentes
        const funil = d.funil || {};
        const visitantes = Math.round(Math.min(100000, Math.max(500, funil.visitantesMes || 5000)));
        const leads = Math.round(Math.min(visitantes * 0.15, Math.max(5, funil.leadsMes || visitantes * 0.03)));
        const taxaQual = Math.min(80, Math.max(20, funil.taxaQualificacao || 50));
        const qualificados = Math.round(leads * taxaQual / 100);
        const orcamentos = Math.round(Math.min(qualificados, Math.max(1, funil.orcamentosMes || qualificados * 0.6)));
        const vendas = Math.round(Math.min(orcamentos, Math.max(1, funil.vendasMes || orcamentos * 0.3)));
        const ticketMedio = Math.round(Math.min(50000, Math.max(50, funil.ticketMedio || 200)));
        const faturamento = funil.faturamentoMes || vendas * ticketMedio;
        
        // Concorrentes
        const concorrentes = (d.concorrentes || []).slice(0, 5).map(c => ({
          nome: (c.nome || 'Concorrente').substring(0, 20),
          posicao: ['forte', 'medio', 'fraco'].includes(c.posicao) ? c.posicao : 'medio',
          diferencial: (c.diferencial || '').substring(0, 100)
        }));
        
        // Marca - garantir valores entre 0-100
        const marca = d.marca || {};
        const clarezaBase = Math.min(60, Math.max(20, completude * 0.6));
        
        return {
          funil: {
            visitantes,
            leads,
            taxaLeads: Math.round((leads / visitantes) * 100),
            qualificados,
            taxaQualificacao: taxaQual,
            orcamentos,
            taxaOrcamentos: qualificados > 0 ? Math.round((orcamentos / qualificados) * 100) : 0,
            vendas,
            taxaFechamento: orcamentos > 0 ? Math.round((vendas / orcamentos) * 100) : 0,
            ticketMedio,
            faturamento
          },
          concorrentes: concorrentes.length > 0 ? concorrentes : [
            { nome: 'Concorrente 1', posicao: 'medio', diferencial: 'N√£o identificado' },
            { nome: 'Concorrente 2', posicao: 'fraco', diferencial: 'N√£o identificado' }
          ],
          diferenciais: (d.diferenciais || ['Qualidade', 'Atendimento']).slice(0, 5),
          gargalos: (d.gargalos || ['Capta√ß√£o de leads']).slice(0, 3),
          oportunidades: (d.oportunidades || ['Expandir marketing digital']).slice(0, 3),
          sazonalidade: {
            mesesPico: (d.sazonalidade?.mesesPico || ['Novembro', 'Dezembro']).slice(0, 3),
            mesesBaixa: (d.sazonalidade?.mesesBaixa || ['Janeiro', 'Fevereiro']).slice(0, 3),
            padrao: d.sazonalidade?.padrao || 'fim_de_ano'
          },
          marca: {
            clarezaAtual: Math.round(Math.min(70, Math.max(15, marca.clarezaAtual || clarezaBase))),
            consistenciaVisual: Math.round(Math.min(75, Math.max(20, marca.consistenciaVisual || clarezaBase + 5))),
            diferenciacaoPercebida: Math.round(Math.min(65, Math.max(15, marca.diferenciacaoPercebida || clarezaBase - 5))),
            confianca: Math.round(Math.min(70, Math.max(20, marca.confianca || clarezaBase)))
          },
          completude,
          totalNotas: dataOriginal.notes.length
        };
      },
      
      // An√°lise local sem IA (fallback)
      analisarLocalmente(data) {
        const completude = data.dimensions?.completude || 50;
        const totalNotas = data.notes.length;
        
        // Extrair informa√ß√µes b√°sicas das notas
        const todasNotas = data.notes.map(n => n.content.toLowerCase()).join(' ');
        
        // Detectar concorrentes mencionados
        const concorrentes = [];
        const nomesConcorrentes = todasNotas.match(/[A-Z][a-z√°√†√¢√£√©√®√™√≠√Ø√≥√¥√µ√∂√∫√ß]+(?:\s[A-Z][a-z√°√†√¢√£√©√®√™√≠√Ø√≥√¥√µ√∂√∫√ß]+)?/g) || [];
        const exclusoes = ['Marketing', 'Vendas', 'Empresa', 'Cliente', 'Google', 'Facebook', 'Instagram', 'WhatsApp'];
        nomesConcorrentes.filter(n => n.length > 3 && !exclusoes.includes(n)).slice(0, 4).forEach(nome => {
          concorrentes.push({ nome: nome.substring(0, 15), posicao: 'medio', diferencial: 'Identificado nas notas' });
        });
        
        // Detectar sazonalidade
        const mesesPico = [];
        const mesesBaixa = [];
        const meses = ['janeiro', 'fevereiro', 'mar√ßo', 'abril', 'maio', 'junho', 'julho', 'agosto', 'setembro', 'outubro', 'novembro', 'dezembro'];
        meses.forEach((mes, idx) => {
          if (todasNotas.includes(mes)) {
            if (todasNotas.includes('pico') || todasNotas.includes('alto') || todasNotas.includes('melhor')) {
              mesesPico.push(mes.charAt(0).toUpperCase() + mes.slice(1));
            }
            if (todasNotas.includes('baixa') || todasNotas.includes('fraco')) {
              mesesBaixa.push(mes.charAt(0).toUpperCase() + mes.slice(1));
            }
          }
        });
        
        // Valores baseados na completude
        const visitantes = Math.round(3000 + completude * 100);
        const leads = Math.round(visitantes * (0.02 + completude * 0.001));
        const qualificados = Math.round(leads * 0.5);
        const orcamentos = Math.round(qualificados * 0.6);
        const vendas = Math.round(orcamentos * 0.3);
        
        return {
          funil: {
            visitantes,
            leads,
            taxaLeads: Math.round((leads / visitantes) * 100),
            qualificados,
            taxaQualificacao: 50,
            orcamentos,
            taxaOrcamentos: 60,
            vendas,
            taxaFechamento: 30,
            ticketMedio: 200,
            faturamento: vendas * 200
          },
          concorrentes: concorrentes.length > 0 ? concorrentes : [
            { nome: 'Concorrente A', posicao: 'forte', diferencial: 'Pre√ßo' },
            { nome: 'Concorrente B', posicao: 'medio', diferencial: 'Localiza√ß√£o' }
          ],
          diferenciais: ['Qualidade do servi√ßo', 'Atendimento personalizado'],
          gargalos: ['Capta√ß√£o de leads', 'Taxa de convers√£o'],
          oportunidades: ['Marketing digital', 'Fideliza√ß√£o'],
          sazonalidade: {
            mesesPico: mesesPico.length > 0 ? mesesPico : ['Novembro', 'Dezembro'],
            mesesBaixa: mesesBaixa.length > 0 ? mesesBaixa : ['Janeiro', 'Fevereiro'],
            padrao: 'fim_de_ano'
          },
          marca: {
            clarezaAtual: Math.round(20 + completude * 0.4),
            consistenciaVisual: Math.round(25 + completude * 0.35),
            diferenciacaoPercebida: Math.round(18 + completude * 0.35),
            confianca: Math.round(22 + completude * 0.4)
          },
          completude,
          totalNotas
        };
      },
      
      // Dados padr√£o quando n√£o h√° notas suficientes
      gerarDadosPadrao(data) {
        const completude = data.dimensions?.completude || 30;
        return {
          funil: {
            visitantes: 5000,
            leads: 150,
            taxaLeads: 3,
            qualificados: 75,
            taxaQualificacao: 50,
            orcamentos: 45,
            taxaOrcamentos: 60,
            vendas: 15,
            taxaFechamento: 33,
            ticketMedio: 200,
            faturamento: 3000
          },
          concorrentes: [
            { nome: 'Concorrente 1', posicao: 'forte', diferencial: 'N√£o identificado' },
            { nome: 'Concorrente 2', posicao: 'medio', diferencial: 'N√£o identificado' }
          ],
          diferenciais: ['A definir'],
          gargalos: ['Preencha as anota√ß√µes para identificar'],
          oportunidades: ['Preencha as anota√ß√µes para identificar'],
          sazonalidade: {
            mesesPico: ['Novembro', 'Dezembro'],
            mesesBaixa: ['Janeiro', 'Fevereiro'],
            padrao: 'fim_de_ano'
          },
          marca: {
            clarezaAtual: 25,
            consistenciaVisual: 30,
            diferenciacaoPercebida: 20,
            confianca: 25
          },
          completude,
          totalNotas: data.notes.length
        };
      }
    };
    
    // ===== DIAGN√ìSTICO ESTRAT√âGICO BASEADO EM AN√ÅLISE REAL DAS NOTAS =====
    
    // Analisar notas por √°rea para identificar lacunas e clareza
    function analisarNotasPorArea(data) {
      const areas = {
        mercado: { notas: [], itens: ['P√∫blico-alvo', 'Segmenta√ß√£o', 'Persona', 'Nicho', 'Mercado', 'Cliente ideal', 'Target'], preenchido: 0, total: 0 },
        produto: { notas: [], itens: ['Produto', 'Servi√ßo', 'Oferta', 'Proposta de valor', 'Diferencial', 'Benef√≠cio'], preenchido: 0, total: 0 },
        concorrencia: { notas: [], itens: ['Concorrente', 'Competidor', 'Benchmark', 'An√°lise competitiva'], preenchido: 0, total: 0 },
        marca: { notas: [], itens: ['Marca', 'Branding', 'Identidade', 'Logo', 'Visual', 'Tom de voz'], preenchido: 0, total: 0 },
        vendas: { notas: [], itens: ['Venda', 'Comercial', 'Ticket', 'Pre√ßo', 'Faturamento', 'Receita', 'CAC'], preenchido: 0, total: 0 },
        marketing: { notas: [], itens: ['Marketing', 'Tr√°fego', 'Lead', 'Funil', 'Campanha', 'An√∫ncio', 'Conte√∫do'], preenchido: 0, total: 0 },
        objetivo: { notas: [], itens: ['Meta', 'Objetivo', 'Resultado', 'KPI', 'Indicador', 'Crescimento'], preenchido: 0, total: 0 }
      };
      
      // Classificar cada nota
      (data.notes || []).forEach(note => {
        const texto = `${note.item || ''} ${note.content || ''}`.toLowerCase();
        const temConteudo = (note.content || '').trim().length > 5;
        
        Object.keys(areas).forEach(areaKey => {
          const area = areas[areaKey];
          const encontrado = area.itens.some(item => texto.includes(item.toLowerCase()));
          if (encontrado) {
            area.total++;
            if (temConteudo) {
              area.preenchido++;
              area.notas.push({ item: note.item, content: note.content, week: note.week, block: note.block });
            }
          }
        });
      });
      
      // Calcular percentuais
      Object.keys(areas).forEach(key => {
        const area = areas[key];
        area.percentual = area.total > 0 ? Math.round((area.preenchido / area.total) * 100) : 0;
        area.status = area.percentual >= 80 ? 'completo' : area.percentual >= 50 ? 'parcial' : area.percentual > 0 ? 'inicial' : 'vazio';
      });
      
      return areas;
    }
    
    // Renderizar Diagn√≥stico de Lacunas (substitui funil de n√∫meros falsos)
    function renderFunilDetalhado(data, mapping, dadosAnalisados) {
      const container = document.getElementById('funilVisualDiagnostico');
      const card = document.getElementById('chartCardFunilDetalhado');
      if (!container || !card) return;
      
      card.style.display = 'block';
      
      // ========================================
      // AN√ÅLISE DAS NOTAS POR SEMANA PARA CALCULAR LEADS NECESS√ÅRIOS
      // ========================================
      const notas = data.notes || [];
      const notasComConteudo = notas.filter(n => (n.content || '').trim().length > 5);
      
      // Agrupar notas por semana
      const notasPorSemana = {};
      notasComConteudo.forEach(nota => {
        const semana = nota.week || 'Sem semana';
        if (!notasPorSemana[semana]) {
          notasPorSemana[semana] = [];
        }
        notasPorSemana[semana].push(nota);
      });
      
      // Extrair dados num√©ricos das notas (metas, tickets, volumes)
      const extrairNumero = (texto) => {
        if (!texto) return null;
        const matches = texto.match(/(\d+[\.,]?\d*)/g);
        if (matches && matches.length > 0) {
          return parseFloat(matches[0].replace(',', '.'));
        }
        return null;
      };
      
      // Buscar metas e dados financeiros nas notas
      let metaVendas = null;
      let ticketMedio = null;
      let metaFaturamento = null;
      let taxaConversao = null;
      
      notasComConteudo.forEach(nota => {
        const item = (nota.item || '').toLowerCase();
        const conteudo = (nota.content || '').toLowerCase();
        const textoCompleto = item + ' ' + conteudo;
        
        // Identificar meta de vendas
        if (textoCompleto.includes('meta') && (textoCompleto.includes('venda') || textoCompleto.includes('cliente'))) {
          const num = extrairNumero(nota.content);
          if (num && num <= 10000) metaVendas = num;
        }
        
        // Identificar ticket m√©dio
        if (textoCompleto.includes('ticket') || (textoCompleto.includes('valor') && textoCompleto.includes('m√©dio'))) {
          const num = extrairNumero(nota.content);
          if (num && num >= 10) ticketMedio = num;
        }
        
        // Identificar meta de faturamento
        if (textoCompleto.includes('faturamento') || textoCompleto.includes('receita')) {
          const num = extrairNumero(nota.content);
          if (num && num >= 1000) metaFaturamento = num;
        }
        
        // Identificar taxa de convers√£o
        if (textoCompleto.includes('conver') && (textoCompleto.includes('taxa') || textoCompleto.includes('%'))) {
          const num = extrairNumero(nota.content);
          if (num && num <= 100) taxaConversao = num;
        }
      });
      
      // Calcular leads necess√°rios baseado nos dados encontrados
      const taxaConversaoReal = taxaConversao || 5; // 5% padr√£o se n√£o especificado
      const ticketMedioReal = ticketMedio || 500; // R$ 500 padr√£o
      const metaVendasReal = metaVendas || (metaFaturamento ? Math.ceil(metaFaturamento / ticketMedioReal) : 20);
      const leadsNecessarios = Math.ceil(metaVendasReal / (taxaConversaoReal / 100));
      const leadsSemanais = Math.ceil(leadsNecessarios / 4);
      
      // Defini√ß√£o das semanas com cores e foco
      const semanas = [
        {
          nome: 'Semana 1',
          titulo: 'Clareza e Diagn√≥stico Estrat√©gico',
          foco: 'Entender o neg√≥cio e definir metas',
          cor: '#6366f1',
          corGradient: 'linear-gradient(135deg, #6366f1, #8b5cf6)',
          icon: 'üéØ'
        },
        {
          nome: 'Semana 2',
          titulo: 'Posicionamento e Estrutura',
          foco: 'Definir p√∫blico e proposta de valor',
          cor: '#8b5cf6',
          corGradient: 'linear-gradient(135deg, #8b5cf6, #a855f7)',
          icon: 'üß≠'
        },
        {
          nome: 'Semana 3',
          titulo: 'Estrat√©gias e Plano de A√ß√£o',
          foco: 'Canais de aquisi√ß√£o e funil',
          cor: '#f59e0b',
          corGradient: 'linear-gradient(135deg, #f59e0b, #f97316)',
          icon: 'üìã'
        },
        {
          nome: 'Semana 4',
          titulo: 'Execu√ß√£o e M√©tricas',
          foco: 'Implementa√ß√£o e acompanhamento',
          cor: '#10b981',
          corGradient: 'linear-gradient(135deg, #10b981, #059669)',
          icon: 'üöÄ'
        }
      ];
      
      // Renderizar semana com c√°lculo de leads
      const renderSemanaPorLead = (semanaConfig, index) => {
        const notasDaSemana = notasPorSemana[semanaConfig.nome] || notasPorSemana[`Semana ${index + 1}`] || [];
        const temNotas = notasDaSemana.length > 0;
        const leadsAcumulados = leadsSemanais * (index + 1);
        const vendasEsperadas = Math.round(leadsAcumulados * (taxaConversaoReal / 100));
        
        return `
          <div style="background:${semanaConfig.corGradient};border-radius:14px;padding:20px;position:relative;overflow:hidden;">
            <div style="position:absolute;top:0;left:0;right:0;height:50%;background:linear-gradient(180deg,rgba(255,255,255,.1),transparent);pointer-events:none;"></div>
            
            <div style="position:relative;z-index:1;">
              <!-- Cabe√ßalho da Semana -->
              <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:15px;flex-wrap:wrap;gap:10px;">
                <div style="display:flex;align-items:center;gap:12px;">
                  <span style="font-size:2rem;">${semanaConfig.icon}</span>
                  <div>
                    <div style="font-weight:800;color:#fff;font-size:1.1rem;">${semanaConfig.nome}</div>
                    <div style="font-size:.85rem;color:rgba(255,255,255,.7);">${semanaConfig.titulo}</div>
                  </div>
                </div>
                <div style="background:rgba(0,0,0,.3);padding:8px 14px;border-radius:10px;text-align:right;">
                  <div style="font-size:.7rem;color:rgba(255,255,255,.6);">Meta de Leads</div>
                  <div style="font-size:1.4rem;font-weight:800;color:#fff;">${leadsSemanais.toLocaleString('pt-BR')}</div>
                </div>
              </div>
              
              <!-- M√©tricas do Funil -->
              <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:15px;">
                <div style="background:rgba(0,0,0,.2);border-radius:8px;padding:12px;text-align:center;">
                  <div style="font-size:1.3rem;font-weight:700;color:#fff;">${leadsAcumulados.toLocaleString('pt-BR')}</div>
                  <div style="font-size:.7rem;color:rgba(255,255,255,.6);">Leads Acumulados</div>
                </div>
                <div style="background:rgba(0,0,0,.2);border-radius:8px;padding:12px;text-align:center;">
                  <div style="font-size:1.3rem;font-weight:700;color:#fff;">${taxaConversaoReal}%</div>
                  <div style="font-size:.7rem;color:rgba(255,255,255,.6);">Taxa Convers√£o</div>
                </div>
                <div style="background:rgba(0,0,0,.2);border-radius:8px;padding:12px;text-align:center;">
                  <div style="font-size:1.3rem;font-weight:700;color:#fff;">${vendasEsperadas}</div>
                  <div style="font-size:.7rem;color:rgba(255,255,255,.6);">Vendas Esperadas</div>
                </div>
              </div>
              
              <!-- Notas da Semana -->
              <div style="border-top:1px solid rgba(255,255,255,.15);padding-top:12px;">
                ${temNotas ? `
                  <div style="font-size:.75rem;color:rgba(255,255,255,.5);margin-bottom:8px;">üìã ${notasDaSemana.length} anota√ß√µes nesta semana:</div>
                  ${notasDaSemana.slice(0, 2).map(nota => `
                    <div style="background:rgba(0,0,0,.25);padding:10px;border-radius:8px;border-left:3px solid rgba(255,255,255,.3);margin-bottom:6px;">
                      <div style="font-size:.7rem;color:rgba(255,255,255,.5);margin-bottom:2px;">${nota.item || nota.block}</div>
                      <div style="font-size:.8rem;color:rgba(255,255,255,.9);line-height:1.4;">"${(nota.content || '').substring(0, 100)}${(nota.content || '').length > 100 ? '...' : ''}"</div>
                    </div>
                  `).join('')}
                  ${notasDaSemana.length > 2 ? `<div style="font-size:.7rem;color:rgba(255,255,255,.5);text-align:center;">+${notasDaSemana.length - 2} mais</div>` : ''}
                ` : `
                  <div style="background:rgba(239,68,68,0.2);padding:12px;border-radius:8px;border-left:3px solid #ef4444;">
                    <div style="color:#fca5a5;font-size:.8rem;font-weight:500;">‚ö†Ô∏è Complete as anota√ß√µes desta semana na aba Estrutura√ß√£o</div>
                    <div style="font-size:.75rem;color:rgba(255,255,255,.5);margin-top:4px;">Foco: ${semanaConfig.foco}</div>
                  </div>
                `}
              </div>
            </div>
          </div>
        `;
      };
      
      // HTML principal
      let html = `
        <!-- Resumo do Funil de Convers√£o -->
        <div style="padding:18px;margin-bottom:20px;background:linear-gradient(135deg,rgba(99,102,241,0.2),rgba(16,185,129,0.15));border-radius:14px;border:1px solid rgba(99,102,241,0.3);">
          <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px;margin-bottom:15px;">
            <div>
              <div style="font-size:1.3rem;font-weight:800;color:#fff;margin-bottom:4px;">ÔøΩ Funil de Convers√£o - Meta de Leads</div>
              <div style="font-size:.85rem;color:rgba(255,255,255,.6);">Quantidade de leads necess√°rios para atingir seu resultado</div>
            </div>
          </div>
          
          <!-- KPIs Principais -->
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;">
            <div style="background:rgba(0,0,0,.3);border-radius:10px;padding:15px;text-align:center;border:1px solid rgba(99,102,241,0.3);">
              <div style="font-size:1.8rem;font-weight:800;color:#6366f1;">${leadsNecessarios.toLocaleString('pt-BR')}</div>
              <div style="font-size:.75rem;color:rgba(255,255,255,.6);margin-top:4px;">Leads Totais/M√™s</div>
            </div>
            <div style="background:rgba(0,0,0,.3);border-radius:10px;padding:15px;text-align:center;border:1px solid rgba(245,158,11,0.3);">
              <div style="font-size:1.8rem;font-weight:800;color:#f59e0b;">${leadsSemanais.toLocaleString('pt-BR')}</div>
              <div style="font-size:.75rem;color:rgba(255,255,255,.6);margin-top:4px;">Leads/Semana</div>
            </div>
            <div style="background:rgba(0,0,0,.3);border-radius:10px;padding:15px;text-align:center;border:1px solid rgba(16,185,129,0.3);">
              <div style="font-size:1.8rem;font-weight:800;color:#10b981;">${metaVendasReal}</div>
              <div style="font-size:.75rem;color:rgba(255,255,255,.6);margin-top:4px;">Vendas/M√™s</div>
            </div>
            <div style="background:rgba(0,0,0,.3);border-radius:10px;padding:15px;text-align:center;border:1px solid rgba(139,92,246,0.3);">
              <div style="font-size:1.8rem;font-weight:800;color:#a855f7;">R$ ${ticketMedioReal.toLocaleString('pt-BR')}</div>
              <div style="font-size:.75rem;color:rgba(255,255,255,.6);margin-top:4px;">Ticket M√©dio</div>
            </div>
          </div>
          
          ${metaFaturamento ? `
            <div style="margin-top:15px;padding:12px;background:rgba(16,185,129,0.15);border-radius:10px;text-align:center;border:1px solid rgba(16,185,129,0.3);">
              <span style="font-size:.9rem;color:rgba(255,255,255,.7);">Meta de Faturamento: </span>
              <span style="font-size:1.2rem;font-weight:700;color:#10b981;">R$ ${metaFaturamento.toLocaleString('pt-BR')}</span>
            </div>
          ` : ''}
        </div>
        
        <!-- Grid de Semanas -->
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;">
          ${semanas.map((s, i) => renderSemanaPorLead(s, i)).join('')}
        </div>
        
        <!-- Dica -->
        <div style="margin-top:20px;padding:15px;background:rgba(245,158,11,0.1);border-radius:10px;border-left:4px solid #f59e0b;">
          <div style="display:flex;align-items:flex-start;gap:10px;">
            <span style="font-size:1.5rem;">ÔøΩ</span>
            <div>
              <div style="font-weight:600;color:#fbbf24;margin-bottom:4px;">Como usamos esses dados?</div>
              <div style="font-size:.85rem;color:rgba(255,255,255,.7);line-height:1.5;">
                Os leads s√£o calculados automaticamente baseados nas informa√ß√µes que voc√™ preenche na aba <strong>Estrutura√ß√£o</strong>.
                ${!ticketMedio && !metaVendas && !metaFaturamento ? 
                  '<br><span style="color:#f87171;">‚ö†Ô∏è Preencha suas metas de vendas, ticket m√©dio ou faturamento para um c√°lculo mais preciso.</span>' : 
                  '<br><span style="color:#34d399;">‚úÖ Detectamos dados das suas anota√ß√µes e calculamos as metas automaticamente.</span>'
                }
              </div>
            </div>
          </div>
        </div>
      `;
      
      container.innerHTML = html;
    }
    
    // Renderizar An√°lise de Posicionamento (baseado nas notas reais sobre concorr√™ncia e diferenciais)
    function renderMapaDiferenciacao(data, mapping, dadosAnalisados) {
      const container = document.getElementById('mapaDiferenciacaoVisual');
      const card = document.getElementById('chartCardMapaDiferenciacao');
      if (!container || !card) return;
      
      card.style.display = 'block';
      
      // Extrair informa√ß√µes REAIS das notas
      const notas = data.notes || [];
      const totalNotas = notas.length;
      
      // Buscar notas sobre concorr√™ncia
      const notasConcorrencia = notas.filter(n => {
        const texto = `${n.item || ''} ${n.content || ''}`.toLowerCase();
        return texto.includes('concorr') || texto.includes('competidor') || texto.includes('benchmark') || 
               texto.includes('mercado') || texto.includes('rival');
      });
      
      // Buscar notas sobre diferenciais
      const notasDiferenciais = notas.filter(n => {
        const texto = `${n.item || ''} ${n.content || ''}`.toLowerCase();
        return texto.includes('diferencial') || texto.includes('√∫nico') || texto.includes('exclusivo') ||
               texto.includes('destaque') || texto.includes('vantagem') || texto.includes('proposta de valor');
      });
      
      // Buscar notas sobre p√∫blico/posicionamento
      const notasPosicionamento = notas.filter(n => {
        const texto = `${n.item || ''} ${n.content || ''}`.toLowerCase();
        return texto.includes('posicion') || texto.includes('p√∫blico') || texto.includes('target') ||
               texto.includes('nicho') || texto.includes('segmento') || texto.includes('persona');
      });
      
      const temDadosConcorrencia = notasConcorrencia.length > 0;
      const temDadosDiferenciais = notasDiferenciais.length > 0;
      const temDadosPosicionamento = notasPosicionamento.length > 0;
      
      // Calcular n√≠vel de clareza de posicionamento
      const clarezaPosicionamento = Math.round(
        ((temDadosConcorrencia ? 30 : 0) + 
         (temDadosDiferenciais ? 40 : 0) + 
         (temDadosPosicionamento ? 30 : 0))
      );
      
      let html = `
        <div style="padding:12px;margin-bottom:15px;background:linear-gradient(135deg,rgba(16,185,129,0.15),rgba(99,102,241,0.1));border-radius:10px;border-left:4px solid #10b981;">
          <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
            <div>
              <strong style="color:#6ee7b7;">üéØ An√°lise de Posicionamento Estrat√©gico</strong>
              <div style="font-size:.75rem;color:rgba(255,255,255,.5);margin-top:4px;">Baseado em ${totalNotas} anota√ß√µes reais do seu neg√≥cio</div>
            </div>
            <div style="background:${clarezaPosicionamento >= 70 ? 'rgba(16,185,129,0.2)' : clarezaPosicionamento >= 40 ? 'rgba(245,158,11,0.2)' : 'rgba(239,68,68,0.2)'};padding:6px 12px;border-radius:8px;">
              <span style="color:${clarezaPosicionamento >= 70 ? '#10b981' : clarezaPosicionamento >= 40 ? '#f59e0b' : '#ef4444'};font-weight:600;">${clarezaPosicionamento}% clareza</span>
            </div>
          </div>
        </div>
        
        <!-- Status das 3 dimens√µes de posicionamento -->
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;">
          <div style="background:${temDadosConcorrencia ? 'rgba(16,185,129,0.15)' : 'rgba(239,68,68,0.15)'};border-radius:10px;padding:15px;text-align:center;border:1px solid ${temDadosConcorrencia ? 'rgba(16,185,129,0.3)' : 'rgba(239,68,68,0.3)'};">
            <div style="font-size:1.5rem;margin-bottom:8px;">${temDadosConcorrencia ? '‚úÖ' : '‚ùå'}</div>
            <div style="font-weight:600;color:${temDadosConcorrencia ? '#34d399' : '#f87171'};margin-bottom:4px;">Concorr√™ncia</div>
            <div style="font-size:.75rem;color:rgba(255,255,255,.5);">${notasConcorrencia.length} anota√ß√µes</div>
          </div>
          <div style="background:${temDadosDiferenciais ? 'rgba(16,185,129,0.15)' : 'rgba(239,68,68,0.15)'};border-radius:10px;padding:15px;text-align:center;border:1px solid ${temDadosDiferenciais ? 'rgba(16,185,129,0.3)' : 'rgba(239,68,68,0.3)'};">
            <div style="font-size:1.5rem;margin-bottom:8px;">${temDadosDiferenciais ? '‚úÖ' : '‚ùå'}</div>
            <div style="font-weight:600;color:${temDadosDiferenciais ? '#34d399' : '#f87171'};margin-bottom:4px;">Diferenciais</div>
            <div style="font-size:.75rem;color:rgba(255,255,255,.5);">${notasDiferenciais.length} anota√ß√µes</div>
          </div>
          <div style="background:${temDadosPosicionamento ? 'rgba(16,185,129,0.15)' : 'rgba(239,68,68,0.15)'};border-radius:10px;padding:15px;text-align:center;border:1px solid ${temDadosPosicionamento ? 'rgba(16,185,129,0.3)' : 'rgba(239,68,68,0.3)'};">
            <div style="font-size:1.5rem;margin-bottom:8px;">${temDadosPosicionamento ? '‚úÖ' : '‚ùå'}</div>
            <div style="font-weight:600;color:${temDadosPosicionamento ? '#34d399' : '#f87171'};margin-bottom:4px;">P√∫blico-alvo</div>
            <div style="font-size:.75rem;color:rgba(255,255,255,.5);">${notasPosicionamento.length} anota√ß√µes</div>
          </div>
        </div>
        
        <!-- O que foi documentado -->
        ${temDadosDiferenciais || temDadosConcorrencia || temDadosPosicionamento ? `
          <div style="background:rgba(99,102,241,0.1);border-radius:10px;padding:15px;margin-bottom:15px;">
            <div style="font-weight:600;color:#a5b4fc;margin-bottom:12px;">üìù O que voc√™ j√° documentou:</div>
            
            ${temDadosDiferenciais ? `
              <div style="margin-bottom:12px;padding:10px;background:rgba(16,185,129,0.1);border-radius:8px;border-left:3px solid #10b981;">
                <div style="font-weight:500;color:#34d399;margin-bottom:6px;">üåü Seus Diferenciais:</div>
                ${notasDiferenciais.slice(0,3).map(n => `
                  <div style="font-size:.85rem;color:rgba(255,255,255,.75);margin-bottom:4px;padding-left:10px;border-left:2px solid rgba(16,185,129,0.3);">
                    <strong>${n.item}:</strong> "${(n.content || '').substring(0,100)}${(n.content || '').length > 100 ? '...' : ''}"
                  </div>
                `).join('')}
              </div>
            ` : ''}
            
            ${temDadosConcorrencia ? `
              <div style="margin-bottom:12px;padding:10px;background:rgba(239,68,68,0.1);border-radius:8px;border-left:3px solid #ef4444;">
                <div style="font-weight:500;color:#f87171;margin-bottom:6px;">‚öîÔ∏è Sobre a Concorr√™ncia:</div>
                ${notasConcorrencia.slice(0,2).map(n => `
                  <div style="font-size:.85rem;color:rgba(255,255,255,.75);margin-bottom:4px;padding-left:10px;border-left:2px solid rgba(239,68,68,0.3);">
                    <strong>${n.item}:</strong> "${(n.content || '').substring(0,100)}${(n.content || '').length > 100 ? '...' : ''}"
                  </div>
                `).join('')}
              </div>
            ` : ''}
            
            ${temDadosPosicionamento ? `
              <div style="padding:10px;background:rgba(139,92,246,0.1);border-radius:8px;border-left:3px solid #8b5cf6;">
                <div style="font-weight:500;color:#c4b5fd;margin-bottom:6px;">üéØ Seu P√∫blico-alvo:</div>
                ${notasPosicionamento.slice(0,2).map(n => `
                  <div style="font-size:.85rem;color:rgba(255,255,255,.75);margin-bottom:4px;padding-left:10px;border-left:2px solid rgba(139,92,246,0.3);">
                    <strong>${n.item}:</strong> "${(n.content || '').substring(0,100)}${(n.content || '').length > 100 ? '...' : ''}"
                  </div>
                `).join('')}
              </div>
            ` : ''}
          </div>
        ` : ''}
        
        <!-- O que est√° faltando -->
        ${!temDadosDiferenciais || !temDadosConcorrencia || !temDadosPosicionamento ? `
          <div style="background:rgba(239,68,68,0.1);border-radius:10px;padding:15px;border-left:3px solid #ef4444;">
            <div style="font-weight:600;color:#f87171;margin-bottom:12px;">‚ö†Ô∏è Para um posicionamento claro, voc√™ precisa documentar:</div>
            
            ${!temDadosDiferenciais ? `
              <div style="display:flex;gap:10px;align-items:flex-start;margin-bottom:10px;padding:10px;background:rgba(0,0,0,.2);border-radius:8px;">
                <span style="font-size:1.2rem;">üåü</span>
                <div>
                  <div style="color:#fca5a5;font-weight:500;">Seus Diferenciais</div>
                  <div style="font-size:.8rem;color:rgba(255,255,255,.6);">O que torna seu neg√≥cio √∫nico? Por que clientes devem escolher voc√™?</div>
                </div>
              </div>
            ` : ''}
            
            ${!temDadosConcorrencia ? `
              <div style="display:flex;gap:10px;align-items:flex-start;margin-bottom:10px;padding:10px;background:rgba(0,0,0,.2);border-radius:8px;">
                <span style="font-size:1.2rem;">‚öîÔ∏è</span>
                <div>
                  <div style="color:#fca5a5;font-weight:500;">An√°lise de Concorr√™ncia</div>
                  <div style="font-size:.8rem;color:rgba(255,255,255,.6);">Quem s√£o seus concorrentes? O que eles fazem bem/mal?</div>
                </div>
              </div>
            ` : ''}
            
            ${!temDadosPosicionamento ? `
              <div style="display:flex;gap:10px;align-items:flex-start;padding:10px;background:rgba(0,0,0,.2);border-radius:8px;">
                <span style="font-size:1.2rem;">üéØ</span>
                <div>
                  <div style="color:#fca5a5;font-weight:500;">Defini√ß√£o de P√∫blico-alvo</div>
                  <div style="font-size:.8rem;color:rgba(255,255,255,.6);">Quem √© seu cliente ideal? Qual nicho voc√™ atende?</div>
                </div>
              </div>
            ` : ''}
          </div>
        ` : `
          <div style="background:rgba(16,185,129,0.15);border-radius:10px;padding:15px;border-left:3px solid #10b981;">
            <div style="font-weight:600;color:#34d399;margin-bottom:8px;">‚úÖ Posicionamento Bem Documentado!</div>
            <div style="font-size:.9rem;color:rgba(255,255,255,.7);">
              Voc√™ tem informa√ß√µes sobre concorr√™ncia, diferenciais e p√∫blico-alvo. 
              Continue refinando essas informa√ß√µes para um posicionamento ainda mais preciso.
            </div>
          </div>
        `}
      `;
      
      container.innerHTML = html;
    }
    // Renderizar Progresso por Semana (substituiu gr√°fico de sazonalidade fict√≠cio)
    function renderSazonalidade(data, mapping) {
      const canvas = document.getElementById('chartSazonalidade');
      const card = document.getElementById('chartCardSazonalidade');
      const legenda = document.getElementById('sazonalidadeLegenda');
      if (!canvas || !card || typeof Chart === 'undefined') return;
      
      card.style.display = 'block';
      
      // Agrupar notas REAIS por semana
      const notas = data.notes || [];
      const notasPorSemana = {};
      const semanas = ['Semana 1', 'Semana 2', 'Semana 3', 'Semana 4', 'Semana 5', 'Semana 6'];
      
      semanas.forEach(s => {
        notasPorSemana[s] = notas.filter(n => (n.week || '').includes(s.replace('Semana ', '')));
      });
      
      // Calcular progresso real por semana
      const progressoPorSemana = semanas.map(s => {
        const notasSemana = notasPorSemana[s];
        const totalNotas = notasSemana.length;
        const notasPreenchidas = notasSemana.filter(n => (n.content || '').trim().length > 5).length;
        return totalNotas > 0 ? Math.round((notasPreenchidas / totalNotas) * 100) : 0;
      });
      
      const ctx = canvas.getContext('2d');
      
      // Cores baseadas no progresso real
      const cores = progressoPorSemana.map(p => 
        p >= 80 ? '#10b981' : p >= 50 ? '#f59e0b' : p > 0 ? '#ef4444' : '#374151'
      );
      
      // Destruir gr√°fico anterior se existir
      if (analiseCharts.sazonalidade) {
        analiseCharts.sazonalidade.destroy();
      }
      
      analiseCharts.sazonalidade = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: semanas,
          datasets: [{
            label: 'Progresso Real (%)',
            data: progressoPorSemana,
            backgroundColor: cores,
            borderRadius: 8,
            borderSkipped: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                afterBody: (context) => {
                  const idx = context[0].dataIndex;
                  const semana = semanas[idx];
                  const totalNotas = notasPorSemana[semana].length;
                  const preenchidas = notasPorSemana[semana].filter(n => (n.content || '').trim().length > 5).length;
                  return `${preenchidas} de ${totalNotas} itens preenchidos`;
                }
              }
            }
          },
          scales: {
            x: { grid: { display: false }, ticks: { color: 'rgba(255,255,255,0.7)', font: { weight: 'bold' } } },
            y: { 
              grid: { color: 'rgba(255,255,255,0.1)' }, 
              ticks: { color: 'rgba(255,255,255,0.7)', callback: v => v + '%' },
              min: 0,
              max: 100
            }
          }
        }
      });
      
      // Legenda com informa√ß√µes REAIS
      if (legenda) {
        const totalPreenchidas = notas.filter(n => (n.content || '').trim().length > 5).length;
        const totalNotas = notas.length;
        const progressoGeral = totalNotas > 0 ? Math.round((totalPreenchidas / totalNotas) * 100) : 0;
        
        // Identificar semana mais/menos completa
        const maxProgresso = Math.max(...progressoPorSemana);
        const minProgresso = Math.min(...progressoPorSemana.filter(p => p > 0));
        const semanaCompleta = semanas[progressoPorSemana.indexOf(maxProgresso)];
        const semanaPendente = semanas[progressoPorSemana.indexOf(minProgresso)];
        
        legenda.innerHTML = `
          <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:10px;margin-top:12px;">
            <div style="background:rgba(16,185,129,0.15);padding:10px;border-radius:8px;text-align:center;">
              <div style="font-size:1.5rem;font-weight:700;color:#10b981;">${totalPreenchidas}</div>
              <div style="font-size:.75rem;color:rgba(255,255,255,.6);">Itens preenchidos</div>
            </div>
            <div style="background:rgba(245,158,11,0.15);padding:10px;border-radius:8px;text-align:center;">
              <div style="font-size:1.5rem;font-weight:700;color:#f59e0b;">${totalNotas - totalPreenchidas}</div>
              <div style="font-size:.75rem;color:rgba(255,255,255,.6);">Itens pendentes</div>
            </div>
            <div style="background:rgba(99,102,241,0.15);padding:10px;border-radius:8px;text-align:center;">
              <div style="font-size:1.5rem;font-weight:700;color:#6366f1;">${progressoGeral}%</div>
              <div style="font-size:.75rem;color:rgba(255,255,255,.6);">Progresso geral</div>
            </div>
          </div>
          ${minProgresso < 50 && minProgresso > 0 ? `
            <div style="margin-top:12px;padding:10px;background:rgba(239,68,68,0.1);border-radius:8px;font-size:.8rem;color:rgba(255,255,255,.7);border-left:3px solid #ef4444;">
              ‚ö†Ô∏è <strong>${semanaPendente}</strong> est√° com apenas ${minProgresso}% de progresso. Foque em completar essa semana!
            </div>
          ` : maxProgresso >= 80 ? `
            <div style="margin-top:12px;padding:10px;background:rgba(16,185,129,0.1);border-radius:8px;font-size:.8rem;color:rgba(255,255,255,.7);border-left:3px solid #10b981;">
              ‚úÖ <strong>${semanaCompleta}</strong> est√° ${maxProgresso}% completa. Excelente progresso!
            </div>
          ` : ''}
        `;
      }
    }
    
    // Renderizar Plano de A√ß√£o baseado no que est√° faltando (substituiu gr√°fico de marca fict√≠cio)
    function renderClarezaMarca(data, mapping) {
      const container = document.getElementById('clarezaMarcaVisual');
      const card = document.getElementById('chartCardClarezaMarca');
      if (!container || !card) return;
      
      card.style.display = 'block';
      
      // Analisar notas REAIS
      const notas = data.notes || [];
      const totalNotas = notas.length;
      const notasPreenchidas = notas.filter(n => (n.content || '').trim().length > 5);
      const notasVazias = notas.filter(n => (n.content || '').trim().length <= 5);
      const completude = data.dimensions?.completude || 0;
      
      // Agrupar notas vazias por bloco para identificar lacunas
      const lacunasPorBloco = {};
      notasVazias.forEach(n => {
        const bloco = n.block || 'Outros';
        if (!lacunasPorBloco[bloco]) lacunasPorBloco[bloco] = [];
        lacunasPorBloco[bloco].push(n.item);
      });
      
      // Ordenar blocos por quantidade de lacunas
      const blocosComLacunas = Object.entries(lacunasPorBloco)
        .map(([bloco, itens]) => ({ bloco, itens, total: itens.length }))
        .sort((a, b) => b.total - a.total);
      
      // Extrair insights das notas preenchidas
      const notasRelevantes = notasPreenchidas
        .filter(n => (n.content || '').length > 20)
        .slice(0, 5);
      
      // Determinar status geral
      const status = completude >= 80 ? 'excelente' : completude >= 60 ? 'bom' : completude >= 40 ? 'progresso' : 'inicial';
      
      let html = `
        <div style="padding:15px;margin-bottom:15px;background:linear-gradient(135deg,${
          status === 'excelente' ? 'rgba(16,185,129,0.2)' : 
          status === 'bom' ? 'rgba(99,102,241,0.2)' : 
          status === 'progresso' ? 'rgba(245,158,11,0.2)' : 
          'rgba(239,68,68,0.2)'
        },transparent);border-radius:12px;border-left:4px solid ${
          status === 'excelente' ? '#10b981' : 
          status === 'bom' ? '#6366f1' : 
          status === 'progresso' ? '#f59e0b' : 
          '#ef4444'
        };">
          <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
            <div>
              <strong style="color:${
                status === 'excelente' ? '#34d399' : 
                status === 'bom' ? '#a5b4fc' : 
                status === 'progresso' ? '#fbbf24' : 
                '#f87171'
              };">üéØ Seu Plano de A√ß√£o Estrat√©gico</strong>
              <div style="font-size:.75rem;color:rgba(255,255,255,.5);margin-top:4px;">
                Baseado em ${totalNotas} itens (${notasPreenchidas.length} preenchidos, ${notasVazias.length} pendentes)
              </div>
            </div>
            <div style="background:rgba(0,0,0,.2);padding:8px 15px;border-radius:20px;">
              <span style="font-size:1.2rem;font-weight:700;color:${
                status === 'excelente' ? '#10b981' : 
                status === 'bom' ? '#6366f1' : 
                status === 'progresso' ? '#f59e0b' : 
                '#ef4444'
              };">${completude}%</span>
              <span style="font-size:.8rem;color:rgba(255,255,255,.6);"> completo</span>
            </div>
          </div>
        </div>
        
        <!-- Status Visual -->
        <div style="margin-bottom:20px;">
          <div style="display:flex;gap:3px;height:12px;border-radius:6px;overflow:hidden;">
            <div style="flex:${notasPreenchidas.length};background:#10b981;transition:flex .3s;"></div>
            <div style="flex:${notasVazias.length};background:#ef4444;transition:flex .3s;"></div>
          </div>
          <div style="display:flex;justify-content:space-between;margin-top:6px;font-size:.75rem;color:rgba(255,255,255,.5);">
            <span>‚úÖ ${notasPreenchidas.length} preenchidos</span>
            <span>‚ùå ${notasVazias.length} pendentes</span>
          </div>
        </div>
        
        ${blocosComLacunas.length > 0 ? `
          <!-- Pr√≥ximas A√ß√µes Priorit√°rias -->
          <div style="background:rgba(239,68,68,0.1);border-radius:12px;padding:15px;margin-bottom:15px;border:1px solid rgba(239,68,68,0.2);">
            <div style="font-weight:600;color:#f87171;margin-bottom:12px;display:flex;align-items:center;gap:8px;">
              <span>üö®</span> O Que Voc√™ Precisa Fazer Agora
            </div>
            
            ${blocosComLacunas.slice(0, 3).map((lacuna, idx) => `
              <div style="background:rgba(0,0,0,.2);border-radius:10px;padding:12px;margin-bottom:10px;border-left:3px solid ${idx === 0 ? '#ef4444' : idx === 1 ? '#f59e0b' : '#6366f1'};">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                  <span style="font-weight:600;color:${idx === 0 ? '#fca5a5' : idx === 1 ? '#fcd34d' : '#a5b4fc'};">
                    ${idx === 0 ? 'üî• URGENTE' : idx === 1 ? '‚ö° IMPORTANTE' : 'üìã PR√ìXIMO'}: ${lacuna.bloco}
                  </span>
                  <span style="background:rgba(239,68,68,0.2);padding:2px 8px;border-radius:10px;font-size:.7rem;color:#f87171;">
                    ${lacuna.total} itens pendentes
                  </span>
                </div>
                <div style="font-size:.8rem;color:rgba(255,255,255,.6);">
                  Preencher: ${lacuna.itens.slice(0, 3).join(', ')}${lacuna.itens.length > 3 ? ` +${lacuna.itens.length - 3} mais` : ''}
                </div>
              </div>
            `).join('')}
          </div>
        ` : ''}
        
        ${notasRelevantes.length > 0 ? `
          <!-- O que j√° foi documentado -->
          <div style="background:rgba(16,185,129,0.1);border-radius:12px;padding:15px;border:1px solid rgba(16,185,129,0.2);">
            <div style="font-weight:600;color:#34d399;margin-bottom:12px;display:flex;align-items:center;gap:8px;">
              <span>‚úÖ</span> Principais Informa√ß√µes Documentadas
            </div>
            
            ${notasRelevantes.map(n => `
              <div style="background:rgba(0,0,0,.2);border-radius:8px;padding:10px;margin-bottom:8px;border-left:3px solid #10b981;">
                <div style="font-weight:500;color:#6ee7b7;font-size:.85rem;margin-bottom:4px;">${n.item}</div>
                <div style="font-size:.8rem;color:rgba(255,255,255,.65);">"${(n.content || '').substring(0, 120)}${(n.content || '').length > 120 ? '...' : ''}"</div>
              </div>
            `).join('')}
          </div>
        ` : ''}
        
        <!-- Mensagem de Orienta√ß√£o -->
        <div style="margin-top:15px;padding:15px;background:linear-gradient(135deg,rgba(139,92,246,0.15),rgba(99,102,241,0.1));border-radius:12px;text-align:center;">
          <div style="font-size:1rem;margin-bottom:8px;">
            ${status === 'excelente' ? 'üèÜ' : status === 'bom' ? 'üëç' : status === 'progresso' ? 'üí™' : 'üöÄ'}
          </div>
          <div style="color:rgba(255,255,255,.85);font-size:.9rem;line-height:1.5;">
            ${status === 'excelente' 
              ? 'Excelente trabalho! Sua estrutura√ß√£o est√° quase completa. Revise os √∫ltimos detalhes para finalizar.' 
              : status === 'bom' 
              ? 'Bom progresso! Continue preenchendo as informa√ß√µes para ter um diagn√≥stico ainda mais preciso.'
              : status === 'progresso'
              ? 'Voc√™ est√° no caminho certo! Foque em completar os blocos marcados como urgentes acima.'
              : 'Estamos no in√≠cio da jornada. Complete as informa√ß√µes b√°sicas para que possamos criar sua estrat√©gia personalizada.'}
          </div>
        </div>
      `;
      
      container.innerHTML = html;
    }
    
    // Fun√ß√£o para ativar gr√°ficos espec√≠ficos do diagn√≥stico estrat√©gico - AN√ÅLISE REAL DAS NOTAS
    function setupDiagnosticoEstrategicoCharts(data, mapping, entregavelId) {
      // S√≥ ativar se for o diagn√≥stico estrat√©gico
      if (entregavelId !== 'diagnostico_estrategico') {
        ['chartCardFunilDetalhado', 'chartCardMapaDiferenciacao', 'chartCardSazonalidade', 'chartCardClarezaMarca'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.style.display = 'none';
        });
        return;
      }
      
      console.log('üìä Gerando diagn√≥stico estrat√©gico baseado em dados reais...');
      
      // ================================================================
      // ESCONDER TODOS os elementos - deixar apenas An√°lise Estrat√©gica Profunda
      // ================================================================
      
      // 1. Cards de m√©tricas (Progresso Geral, Tarefas Conclu√≠das, Pendentes, Anota√ß√µes) - REMOVER
      const metricsRow = document.querySelector('.analise-metrics-row');
      if (metricsRow) metricsRow.style.display = 'none';
      
      // 2. Gr√°fico Radar (Marketing, Vendas, Marca...) - REMOVER
      const chartCardRadar = document.getElementById('chartCardRadar');
      if (chartCardRadar) chartCardRadar.style.display = 'none';
      
      // 3. Gr√°fico Terci√°rio (Matriz Estrat√©gica) - REMOVER
      const chartCardTertiary = document.getElementById('chartCardTertiary');
      if (chartCardTertiary) chartCardTertiary.style.display = 'none';
      
      // 4. Gr√°fico Secund√°rio - REMOVER
      const chartCardSecondary = document.getElementById('chartCardSecondary');
      if (chartCardSecondary) chartCardSecondary.style.display = 'none';
      
      // 5. Gr√°fico Prim√°rio - REMOVER
      const chartCardPrimary = document.getElementById('chartCardPrimary');
      if (chartCardPrimary) chartCardPrimary.style.display = 'none';
      
      // 6. Esconder Mapa de Diferencia√ß√£o, Sazonalidade e Clareza de Marca
      const chartCardMapaDiferenciacao = document.getElementById('chartCardMapaDiferenciacao');
      if (chartCardMapaDiferenciacao) chartCardMapaDiferenciacao.style.display = 'none';
      
      const chartCardSazonalidade = document.getElementById('chartCardSazonalidade');
      if (chartCardSazonalidade) chartCardSazonalidade.style.display = 'none';
      
      const chartCardClarezaMarca = document.getElementById('chartCardClarezaMarca');
      if (chartCardClarezaMarca) chartCardClarezaMarca.style.display = 'none';
      
      // 7. ESCONDER Funil de Marketing e Vendas (Diagn√≥stico de Convers√£o) - REMOVER
      const chartCardFunilDetalhado = document.getElementById('chartCardFunilDetalhado');
      if (chartCardFunilDetalhado) chartCardFunilDetalhado.style.display = 'none';
      
      // ================================================================
      // Deixar apenas a An√°lise Estrat√©gica Profunda (texto da IA)
      // ================================================================
      
      console.log('‚úÖ Diagn√≥stico estrat√©gico - apenas An√°lise Estrat√©gica Profunda');
    }

    // Fun√ß√£o para gerar se√ß√£o de m√≠dias de refer√™ncia (fotos/v√≠deos) das anota√ß√µes
    function gerarSecaoMidiasReferencia(files, entregavelId) {
      // Entreg√°veis que devem mostrar m√≠dias de refer√™ncia
      const entregaveisComMidias = ['criativos_anuncios', 'producao_conteudo', 'copywriting', 'redes_sociais'];
      
      if (!entregaveisComMidias.includes(entregavelId)) {
        return ''; // N√£o mostrar m√≠dias para outros entreg√°veis
      }
      
      if (!files || files.length === 0) {
        return ''; // Sem arquivos
      }
      
      // Filtrar apenas imagens e v√≠deos
      const midias = files.filter(file => {
        const name = (file.name || '').toLowerCase();
        const url = (file.url || '').toLowerCase();
        const isImage = /\.(jpg|jpeg|png|gif|webp|svg|bmp)$/i.test(name) || /\.(jpg|jpeg|png|gif|webp|svg|bmp)/i.test(url);
        const isVideo = /\.(mp4|mov|avi|webm|mkv|m4v)$/i.test(name) || /\.(mp4|mov|avi|webm|mkv|m4v)/i.test(url);
        return isImage || isVideo;
      });
      
      if (midias.length === 0) {
        return ''; // Sem m√≠dias de imagem/v√≠deo
      }
      
      // Gerar HTML da se√ß√£o
      let html = `
        <div style="background:linear-gradient(135deg, rgba(99,102,241,0.1) 0%, rgba(139,92,246,0.1) 100%); border-radius:16px; padding:24px; margin-bottom:24px; border:1px solid rgba(99,102,241,0.3);">
          <h3 style="color:#a5b4fc; margin:0 0 16px 0; font-size:1.1rem; display:flex; align-items:center; gap:8px;">
            üì∏ Conte√∫dos de Refer√™ncia das Anota√ß√µes
            <span style="font-size:0.75rem; background:rgba(99,102,241,0.3); padding:4px 10px; border-radius:20px; font-weight:normal;">${midias.length} ${midias.length === 1 ? 'arquivo' : 'arquivos'}</span>
          </h3>
          <p style="color:rgba(255,255,255,0.7); font-size:0.85rem; margin:0 0 16px 0;">
            Use estas refer√™ncias visuais das semanas de estrutura√ß√£o para criar os criativos:
          </p>
          <div class="midias-referencia-grid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(150px, 1fr)); gap:12px;">
      `;
      
      midias.forEach((file, idx) => {
        const name = (file.name || '').toLowerCase();
        const url = file.url || '';
        const isVideo = /\.(mp4|mov|avi|webm|mkv|m4v)$/i.test(name) || /\.(mp4|mov|avi|webm|mkv|m4v)/i.test(url);
        
        if (isVideo) {
          html += `
            <div style="position:relative; border-radius:12px; overflow:hidden; background:#1a1a2e; aspect-ratio:1; cursor:pointer;" onclick="abrirMidiaFullscreen('${url}', true)">
              <video src="${url}" style="width:100%; height:100%; object-fit:cover;" muted preload="metadata"></video>
              <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.7); border-radius:50%; width:40px; height:40px; display:flex; align-items:center; justify-content:center;">
                <span style="color:white; font-size:1.2rem;">‚ñ∂</span>
              </div>
              <div style="position:absolute; bottom:0; left:0; right:0; background:linear-gradient(transparent, rgba(0,0,0,0.8)); padding:8px; font-size:0.7rem; color:rgba(255,255,255,0.8);">
                üìπ ${file.source || 'V√≠deo'}
              </div>
            </div>
          `;
        } else {
          html += `
            <div style="position:relative; border-radius:12px; overflow:hidden; background:#1a1a2e; aspect-ratio:1; cursor:pointer;" onclick="abrirMidiaFullscreen('${url}', false)">
              <img src="${url}" alt="${file.name || 'Refer√™ncia'}" style="width:100%; height:100%; object-fit:cover;" onerror="this.parentElement.style.display='none'"/>
              <div style="position:absolute; bottom:0; left:0; right:0; background:linear-gradient(transparent, rgba(0,0,0,0.8)); padding:8px; font-size:0.7rem; color:rgba(255,255,255,0.8);">
                üì∑ ${file.source || 'Imagem'}
              </div>
            </div>
          `;
        }
      });
      
      html += `
          </div>
          <p style="color:rgba(255,255,255,0.5); font-size:0.75rem; margin:16px 0 0 0; text-align:center;">
            üí° Clique nas m√≠dias para ampliar em tela cheia
          </p>
        </div>
      `;
      
      return html;
    }
    
    // Lista de entreg√°veis para tags - TODOS os entreg√°veis do sistema
    const ENTREGAVEIS_TAGS = [
      'Diagn√≥stico Estrat√©gico Completo',
      'Direcionamento Estrat√©gico e Metas',
      'An√°lise de Concorr√™ncia e Mercado',
      'Matriz CDT - Caracter√≠sticas, Dores e Transforma√ß√µes',
      'PUV - Proposta √önica de Valor',
      'PAI - P√∫blico Alvo Ideal',
      'Estrutura√ß√£o de An√∫ncios Pagos',
      'Estrutura√ß√£o Site & SEO',
      'Estrat√©gias para Redes Sociais',
      'Copywriting Estrat√©gico',
      'Produ√ß√£o de Conte√∫do Guiada',
      'Criativos para An√∫ncios Patrocinados',
      'CRM e Automa√ß√µes',
      'Estrutura√ß√£o do Processo Comercial',
      'Landing Pages Estrat√©gicas',
      'Constru√ß√£o ou Atualiza√ß√£o de Website',
      'Padroniza√ß√£o Visual e de Comunica√ß√£o',
      'Plataforma Mediagrowth'
    ];
    
    // Exportar para uso global
    window.ENTREGAVEIS_TAGS = ENTREGAVEIS_TAGS;

    // Mapeamento de nome da TAG para o entregavelId correspondente - TODOS vinculados
    const TAG_TO_ENTREGAVEL_ID = {
      'Diagn√≥stico Estrat√©gico Completo': 'diagnostico_estrategico',
      'Direcionamento Estrat√©gico e Metas': 'direcionamento_metas',
      'An√°lise de Concorr√™ncia e Mercado': 'analise_concorrencia',
      'Matriz CDT - Caracter√≠sticas, Dores e Transforma√ß√µes': 'matriz_cdt',
      'PUV - Proposta √önica de Valor': 'puv',
      'PAI - P√∫blico Alvo Ideal': 'pai',
      'Estrutura√ß√£o de An√∫ncios Pagos': 'anuncios_pagos',
      'Estrutura√ß√£o Site & SEO': 'site_seo',
      'Estrat√©gias para Redes Sociais': 'redes_sociais',
      'Copywriting Estrat√©gico': 'copywriting',
      'Produ√ß√£o de Conte√∫do Guiada': 'producao_conteudo',
      'Criativos para An√∫ncios Patrocinados': 'criativos_anuncios',
      'CRM e Automa√ß√µes': 'crm_automacoes',
      'Estrutura√ß√£o do Processo Comercial': 'processo_comercial',
      'Landing Pages Estrat√©gicas': 'landing_pages',
      'Constru√ß√£o ou Atualiza√ß√£o de Website': 'website',
      'Padroniza√ß√£o Visual e de Comunica√ß√£o': 'padronizacao_visual',
      'Plataforma Mediagrowth': 'plataforma_mediagrowth'
    };

    // Mapeamento inverso: entregavelId para nome da TAG
    const ENTREGAVEL_ID_TO_TAG = {};
    Object.keys(TAG_TO_ENTREGAVEL_ID).forEach(tag => {
      ENTREGAVEL_ID_TO_TAG[TAG_TO_ENTREGAVEL_ID[tag]] = tag;
    });

    // Buscar todas as m√≠dias tagueadas para um entreg√°vel espec√≠fico
    async function buscarMidiasTagueadasPorEntregavel(entregavelId) {
      const tagName = ENTREGAVEL_ID_TO_TAG[entregavelId];
      
      if (!tagName) {
        console.log('üì∏ Nenhuma tag correspondente para entregavelId:', entregavelId);
        return [];
      }

      try {
        const user = auth?.currentUser;
        if (!user) {
          return [];
        }

        // Buscar m√≠dias com a tag espec√≠fica
        const midiasRef = collection(db, 'usuarios', user.uid, 'midias_metadados');
        const q = query(midiasRef, where('tags', 'array-contains', tagName));
        const snapshot = await getDocs(q);

        const midiasTagueadas = [];
        const urlsJaAdicionadas = new Set(); // Para evitar duplicatas
        
        snapshot.forEach(doc => {
          const data = doc.data();
          const url = data.url;
          
          // Verificar se j√° adicionamos esta URL (evitar duplicatas)
          if (url && !urlsJaAdicionadas.has(url)) {
            urlsJaAdicionadas.add(url);
            midiasTagueadas.push({
              id: doc.id,
              url: url,
              tags: data.tags || [],
              descricao: data.descricao || '',
              weekId: data.weekId || '',
              blockId: data.blockId || '',
              itemIdx: data.itemIdx,
              filename: data.filename || data.fileInfo?.name || '',
              dataAtualizacao: data.updatedAt || data.dataAtualizacao
            });
          }
        });

        console.log(`üì∏ ${midiasTagueadas.length} m√≠dia(s) √∫nica(s) para "${entregavelId}"`);
        return midiasTagueadas;
      } catch (error) {
        console.error('‚ùå Erro ao buscar m√≠dias tagueadas:', error);
        return [];
      }
    }

    // Gerar se√ß√£o de m√≠dias tagueadas para exibir na an√°lise
    function gerarSecaoMidiasTagueadas(midiasTagueadas, entregavelId) {
      if (!midiasTagueadas || midiasTagueadas.length === 0) {
        return '';
      }

      // Deduplicar m√≠dias por URL (garantir que cada URL apare√ßa apenas 1 vez)
      const urlsVistas = new Set();
      const midiasUnicas = midiasTagueadas.filter(midia => {
        if (!midia.url || urlsVistas.has(midia.url)) {
          return false;
        }
        urlsVistas.add(midia.url);
        return true;
      });
      
      if (midiasUnicas.length === 0) {
        return '';
      }

      const tagName = ENTREGAVEL_ID_TO_TAG[entregavelId] || 'Este Entreg√°vel';
      
      // Definir layout baseado na quantidade de m√≠dias
      const qtdMidias = midiasUnicas.length;
      let gridStyle = '';
      
      if (qtdMidias === 1) {
        // Uma m√≠dia: centralizada e maior
        gridStyle = 'display:flex; justify-content:center;';
      } else if (qtdMidias === 2) {
        // Duas m√≠dias: lado a lado
        gridStyle = 'display:grid; grid-template-columns:repeat(2, 1fr); gap:16px;';
      } else if (qtdMidias <= 4) {
        // 3-4 m√≠dias: grid 2x2
        gridStyle = 'display:grid; grid-template-columns:repeat(2, 1fr); gap:12px;';
      } else {
        // 5+ m√≠dias: galeria responsiva
        gridStyle = 'display:grid; grid-template-columns:repeat(auto-fill, minmax(150px, 1fr)); gap:12px;';
      }
      
      let html = `
        <div class="midias-tagueadas-section" style="background:linear-gradient(135deg, rgba(34,197,94,0.1) 0%, rgba(16,185,129,0.1) 100%); border-radius:16px; padding:24px; margin-bottom:24px; border:1px solid rgba(34,197,94,0.3);">
          <h3 style="color:#86efac; margin:0 0 16px 0; font-size:1.1rem; display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
            üè∑Ô∏è M√≠dias Tagueadas: ${tagName}
            <span style="font-size:0.75rem; background:rgba(34,197,94,0.3); padding:4px 10px; border-radius:20px; font-weight:normal;">${qtdMidias} ${qtdMidias === 1 ? 'm√≠dia' : 'm√≠dias'}</span>
          </h3>
          <p style="color:rgba(255,255,255,0.7); font-size:0.85rem; margin:0 0 16px 0;">
            Estas fotos e v√≠deos foram tagueados para este entreg√°vel durante as semanas de estrutura√ß√£o:
          </p>
          <div class="midias-tagueadas-grid" style="${gridStyle}">
      `;

      // Usar midiasUnicas (j√° deduplicadas) para gerar o HTML
      midiasUnicas.forEach((midia, idx) => {
        const url = midia.url || '';
        const isVideo = /\.(mp4|mov|avi|webm|mkv|m4v)/i.test(url);
        const descricao = midia.descricao ? midia.descricao.substring(0, 100) + (midia.descricao.length > 100 ? '...' : '') : '';
        
        // Ajustar tamanho baseado na quantidade
        let itemStyle = '';
        if (qtdMidias === 1) {
          itemStyle = 'max-width:400px; width:100%;';
        } else if (qtdMidias === 2) {
          itemStyle = 'width:100%;';
        } else {
          itemStyle = 'width:100%;';
        }
        
        if (isVideo) {
          html += `
            <div class="midia-tagueada-item" style="position:relative; border-radius:12px; overflow:hidden; background:#1a1a2e; cursor:pointer; transition:transform 0.2s ease, box-shadow 0.2s ease; ${itemStyle}" onclick="abrirMidiaFullscreen('${url}', true)" onmouseover="this.style.transform='scale(1.02)';this.style.boxShadow='0 8px 24px rgba(34,197,94,0.3)';" onmouseout="this.style.transform='scale(1)';this.style.boxShadow='none';">
              <div style="aspect-ratio:16/9; position:relative;">
                <video src="${url}" style="width:100%; height:100%; object-fit:cover;" muted preload="metadata"></video>
                <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.7); border-radius:50%; width:48px; height:48px; display:flex; align-items:center; justify-content:center;">
                  <span style="color:white; font-size:1.5rem;">‚ñ∂</span>
                </div>
                <div style="position:absolute; top:8px; right:8px; background:rgba(0,0,0,0.7); padding:4px 8px; border-radius:6px; font-size:0.7rem; color:#fff;">üé¨ V√≠deo</div>
              </div>
              ${descricao ? `<div style="padding:10px; font-size:0.75rem; color:rgba(255,255,255,0.8); background:rgba(0,0,0,0.5);"><em>"${descricao}"</em></div>` : ''}
            </div>
          `;
        } else {
          html += `
            <div class="midia-tagueada-item" style="position:relative; border-radius:12px; overflow:hidden; background:#1a1a2e; cursor:pointer; transition:transform 0.2s ease, box-shadow 0.2s ease; ${itemStyle}" onclick="abrirMidiaFullscreen('${url}', false)" onmouseover="this.style.transform='scale(1.02)';this.style.boxShadow='0 8px 24px rgba(34,197,94,0.3)';" onmouseout="this.style.transform='scale(1)';this.style.boxShadow='none';">
              <div style="aspect-ratio:${qtdMidias === 1 ? '16/9' : '4/3'}; position:relative;">
                <img src="${url}" alt="M√≠dia tagueada" style="width:100%; height:100%; object-fit:cover;" onerror="this.parentElement.parentElement.style.display='none'"/>
                <div style="position:absolute; top:8px; right:8px; background:rgba(0,0,0,0.7); padding:4px 8px; border-radius:6px; font-size:0.7rem; color:#fff;">üì∑ Foto</div>
              </div>
              ${descricao ? `<div style="padding:10px; font-size:0.75rem; color:rgba(255,255,255,0.8); background:rgba(0,0,0,0.5);"><em>"${descricao}"</em></div>` : ''}
            </div>
          `;
        }
      });

      html += `
          </div>
          <p style="color:rgba(255,255,255,0.5); font-size:0.75rem; margin:16px 0 0 0; text-align:center;">
            üí° Clique nas m√≠dias para ampliar ‚Ä¢ As descri√ß√µes s√£o usadas pela IA na gera√ß√£o da an√°lise
          </p>
        </div>
      `;

      return html;
    }

    // Fun√ß√£o para abrir m√≠dia em fullscreen com formul√°rio de tags
    window.abrirMidiaFullscreen = async function(url, isVideo, weekData = {}) {
      // Buscar metadados existentes
      const metadados = await buscarMetadadosMidia(url);
      
      // Criar overlay fullscreen
      const overlay = document.createElement('div');
      overlay.id = 'midiaFullscreenOverlay';
      overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);z-index:99999999;display:flex;align-items:center;justify-content:center;animation:fadeIn .2s ease;overflow-y:auto;padding:20px;';
      overlay.onclick = (e) => { if(e.target === overlay) fecharMidiaFullscreen(); };
      
      const container = document.createElement('div');
      container.style.cssText = 'display:flex;flex-direction:column;gap:20px;max-width:1400px;width:100%;';
      container.onclick = (e) => e.stopPropagation();
      
      // Preview da m√≠dia
      const mediaPreview = document.createElement('div');
      mediaPreview.style.cssText = 'flex:1;display:flex;align-items:center;justify-content:center;';
      
      if (isVideo) {
        mediaPreview.innerHTML = `<video src="${url}" style="max-width:100%;max-height:70vh;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,0.5);" controls autoplay></video>`;
      } else {
        mediaPreview.innerHTML = `<img src="${url}" style="max-width:100%;max-height:70vh;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,0.5);object-fit:contain;"/>`;
      }
      
      // Formul√°rio de metadados
      const form = document.createElement('div');
      form.id = 'midiaMetadadosForm';
      form.style.cssText = 'background:rgba(20,20,30,0.95);border-radius:16px;padding:24px;box-shadow:0 10px 40px rgba(0,0,0,0.5);max-width:600px;margin:0 auto;';
      form.innerHTML = `
        <h3 style="color:#fff;margin:0 0 20px 0;font-size:1.2rem;display:flex;align-items:center;gap:10px;">
          <span>üè∑Ô∏è</span>
          <span>Vincular a Entreg√°veis</span>
        </h3>
        
        <div style="margin-bottom:20px;">
          <label style="color:rgba(255,255,255,0.7);font-size:0.9rem;display:block;margin-bottom:8px;">üìù Descri√ß√£o breve:</label>
          <textarea 
            id="midiaDescricao" 
            placeholder="Ex: Print do dashboard mostrando aumento de 300% nas vendas..."
            style="width:100%;min-height:80px;background:#1a1a2e;border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:12px;color:#fff;font-size:0.95rem;resize:vertical;"
          >${metadados?.descricao || ''}</textarea>
        </div>
        
        <div style="margin-bottom:20px;">
          <label style="color:rgba(255,255,255,0.7);font-size:0.9rem;display:block;margin-bottom:12px;">üè∑Ô∏è Tags (selecione os entreg√°veis relacionados):</label>
          <div id="midiaTagsContainer" style="display:flex;flex-wrap:wrap;gap:8px;max-height:300px;overflow-y:auto;padding:4px;">
            ${ENTREGAVEIS_TAGS.map(tag => {
              const isSelected = metadados?.tags?.includes(tag) || false;
              return `
                <label class="midia-tag-option ${isSelected ? 'selected' : ''}" style="display:flex;align-items:center;gap:6px;background:${isSelected ? 'rgba(99,102,241,0.3)' : 'rgba(255,255,255,0.05)'};border:2px solid ${isSelected ? 'rgba(99,102,241,0.8)' : 'rgba(255,255,255,0.1)'};border-radius:8px;padding:8px 12px;cursor:pointer;transition:all 0.2s ease;font-size:0.85rem;color:#fff;">
                  <input type="checkbox" value="${tag}" ${isSelected ? 'checked' : ''} style="display:none;" onchange="this.parentElement.classList.toggle('selected', this.checked); this.parentElement.style.background = this.checked ? 'rgba(99,102,241,0.3)' : 'rgba(255,255,255,0.05)'; this.parentElement.style.borderColor = this.checked ? 'rgba(99,102,241,0.8)' : 'rgba(255,255,255,0.1)';">
                  <span>${tag}</span>
                </label>
              `;
            }).join('')}
          </div>
        </div>
        
        <div style="display:flex;gap:12px;margin-top:24px;">
          <button 
            onclick="fecharMidiaFullscreen()" 
            style="flex:1;background:rgba(255,255,255,0.1);border:none;color:rgba(255,255,255,0.7);padding:12px 20px;border-radius:8px;font-size:0.95rem;cursor:pointer;transition:all 0.2s ease;"
            onmouseover="this.style.background='rgba(255,255,255,0.15)'" 
            onmouseout="this.style.background='rgba(255,255,255,0.1)'"
          >
            Cancelar
          </button>
          <button 
            onclick="salvarMetadadosMidia('${url}', ${isVideo})" 
            style="flex:2;background:linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);border:none;color:#fff;padding:12px 20px;border-radius:8px;font-size:0.95rem;font-weight:600;cursor:pointer;transition:all 0.2s ease;box-shadow:0 4px 12px rgba(99,102,241,0.3);"
            onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(99,102,241,0.4)'" 
            onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 12px rgba(99,102,241,0.3)'"
          >
            üíæ Salvar e Fechar
          </button>
        </div>
      `;
      
      // Bot√£o fechar no canto
      const closeBtn = document.createElement('button');
      closeBtn.onclick = () => fecharMidiaFullscreen();
      closeBtn.style.cssText = 'position:fixed;top:20px;right:20px;background:rgba(255,255,255,0.2);border:none;color:white;font-size:24px;width:44px;height:44px;border-radius:50%;cursor:pointer;z-index:999999999;transition:all 0.2s ease;';
      closeBtn.innerHTML = '‚úï';
      closeBtn.onmouseover = () => { closeBtn.style.background = 'rgba(255,255,255,0.3)'; closeBtn.style.transform = 'scale(1.1)'; };
      closeBtn.onmouseout = () => { closeBtn.style.background = 'rgba(255,255,255,0.2)'; closeBtn.style.transform = 'scale(1)'; };
      
      container.appendChild(mediaPreview);
      container.appendChild(form);
      overlay.appendChild(container);
      overlay.appendChild(closeBtn);
      document.body.appendChild(overlay);
      
      // Fechar com ESC
      const handleEsc = (e) => {
        if (e.key === 'Escape') {
          fecharMidiaFullscreen();
          document.removeEventListener('keydown', handleEsc);
        }
      };
      document.addEventListener('keydown', handleEsc);
    };
    
    // Fun√ß√£o para fechar modal
    window.fecharMidiaFullscreen = function() {
      const overlay = document.getElementById('midiaFullscreenOverlay');
      if (overlay) overlay.remove();
    };
    
    // Fun√ß√£o para buscar metadados de uma m√≠dia
    // UNIFICADO: Usa caminho usuarios/{uid}/midias_metadados
    async function buscarMetadadosMidia(url) {
      const user = auth.currentUser;
      if (!user) return null;
      
      const uid = user.uid;
      
      // Gerar ID √∫nico baseado na URL (igual ao usado no salvar)
      const urlPart = url.substring(url.lastIndexOf('/') + 1).replace(/[^a-zA-Z0-9_-]/g, '').substring(0, 20);
      let hash = 0;
      for (let i = 0; i < url.length; i++) {
        const char = url.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      const midiaId = `${urlPart}_${Math.abs(hash).toString(16)}`;
      
      try {
        const metadadosRef = doc(db, 'usuarios', uid, 'midias_metadados', midiaId);
        const metadadosSnap = await getDoc(metadadosRef);
        
        if (metadadosSnap.exists()) {
          console.log('üì∏ Metadados encontrados para m√≠dia:', midiaId);
          return metadadosSnap.data();
        }
        
        // Fallback: tentar buscar no caminho antigo (plataformas)
        const plataforma = user.email.replace('@', '_').replace(/\./g, '_');
        const oldRef = doc(db, 'plataformas', plataforma, 'midias_metadados', encodeURIComponent(url));
        const oldSnap = await getDoc(oldRef);
        if (oldSnap.exists()) {
          console.log('üì∏ Metadados encontrados no caminho legado');
          return oldSnap.data();
        }
        
        return null;
      } catch (error) {
        console.error('Erro ao buscar metadados:', error);
        return null;
      }
    }
    
    // Fun√ß√£o para salvar metadados de uma m√≠dia
    // UNIFICADO: Usa caminho usuarios/{uid}/midias_metadados para sincronizar com busca
    window.salvarMetadadosMidia = async function(url, isVideo) {
      const descricaoEl = document.getElementById('midiaDescricao');
      const tagsContainer = document.getElementById('midiaTagsContainer');
      
      if (!descricaoEl || !tagsContainer) {
        alert('Erro: Formul√°rio n√£o encontrado');
        return;
      }
      
      const descricao = descricaoEl.value.trim();
      const checkboxes = tagsContainer.querySelectorAll('input[type="checkbox"]:checked');
      const tags = Array.from(checkboxes).map(cb => cb.value);
      
      const user = auth.currentUser;
      if (!user) {
        alert('Erro: Usu√°rio n√£o autenticado');
        return;
      }
      
      const uid = user.uid;
      
      // Gerar ID √∫nico baseado na URL (igual ao usado na busca)
      const urlPart = url.substring(url.lastIndexOf('/') + 1).replace(/[^a-zA-Z0-9_-]/g, '').substring(0, 20);
      let hash = 0;
      for (let i = 0; i < url.length; i++) {
        const char = url.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      const midiaId = `${urlPart}_${Math.abs(hash).toString(16)}`;
      
      try {
        const metadados = {
          url,
          isVideo,
          descricao,
          tags,
          updatedAt: new Date().toISOString(),
          updatedBy: user.email
        };
        
        // CORRIGIDO: Usar caminho usuarios/{uid} ao inv√©s de plataformas/{plataforma}
        const metadadosRef = doc(db, 'usuarios', uid, 'midias_metadados', midiaId);
        await setDoc(metadadosRef, metadados, { merge: true });
        
        console.log('‚úÖ Metadados salvos em usuarios/' + uid + '/midias_metadados/' + midiaId + ':', metadados);
        console.log('üìù Tags salvas:', tags);
        
        // Mostrar feedback
        if (typeof mgToast === 'function') {
          mgToast('‚úÖ M√≠dia vinculada aos entreg√°veis!');
        } else {
          alert('‚úÖ M√≠dia vinculada aos entreg√°veis com sucesso!');
        }
        
        // Fechar modal
        fecharMidiaFullscreen();
        
      } catch (error) {
        console.error('Erro ao salvar metadados:', error);
        alert('Erro ao salvar. Tente novamente.');
      }
    };
    
    // Fun√ß√£o para buscar m√≠dias por tag
    // UNIFICADO: Usa caminho usuarios/{uid}/midias_metadados
    async function buscarMidiasPorTag(tagName) {
      const user = auth.currentUser;
      if (!user) return [];
      
      const uid = user.uid;
      
      try {
        const metadadosRef = collection(db, 'usuarios', uid, 'midias_metadados');
        const q = query(metadadosRef, where('tags', 'array-contains', tagName));
        const querySnapshot = await getDocs(q);
        
        const midias = [];
        querySnapshot.forEach((doc) => {
          midias.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        console.log(`üì∏ buscarMidiasPorTag: ${midias.length} m√≠dias encontradas com tag "${tagName}"`);
        return midias;
      } catch (error) {
        console.error('Erro ao buscar m√≠dias por tag:', error);
        return [];
      }
    }

    // Gerar an√°lise com IA para outros entreg√°veis (n√£o Diagn√≥stico Estrat√©gico)
    async function generateAnaliseInsights(data, mapping, insightContent) {
      // Verificar se insightContent existe
      if (!insightContent) {
        console.error('generateAnaliseInsights: insightContent n√£o encontrado');
        return;
      }
      
      // Verificar se mapping existe
      if (!mapping) {
        console.error('generateAnaliseInsights: mapping n√£o encontrado');
        insightContent.innerHTML = `
          <div style="background:rgba(239,68,68,.1);border-radius:12px;padding:20px;border-left:4px solid #ef4444;">
            <p style="margin:0;">Erro: Configura√ß√£o do entreg√°vel n√£o encontrada.</p>
          </div>
        `;
        return;
      }
      
      // Se n√£o tem anota√ß√µes suficientes, mostrar mensagem
      if (!data.notes || data.notes.length < 3) {
        insightContent.innerHTML = `
          <div style="background:rgba(255,193,7,.1);border-radius:12px;padding:20px;border-left:4px solid #ffc107;">
            <p style="margin:0;">Complete as anota√ß√µes nas semanas de estrutura√ß√£o para gerar uma an√°lise mais detalhada com insights da IA.</p>
          </div>
        `;
        return;
      }

      // üéØ LIMITES DE OTIMIZA√á√ÉO PARA ESTRUTURA√á√ÉO (economia de tokens)
      const ESTRUTURACAO_LIMITS = {
        notasPorSemana: 1500,      // Max chars por semana de notas
        totalNotas: 8000,          // Max chars total de notas
        businessInfo: 2000,        // Max chars do business info
        midiasDescricao: 1000,     // Max chars de descri√ß√£o de m√≠dias
        promptExtra: 500           // Max chars de instru√ß√µes extras
      };

      // Preparar contexto das anota√ß√µes COM LIMITE
      const notasAgrupadas = {};
      data.notes.forEach(note => {
        if (!notasAgrupadas[note.week]) {
          notasAgrupadas[note.week] = [];
        }
        // Limitar tamanho de cada nota individual
        const notaTexto = `‚Ä¢ ${note.block} - ${note.item}:\n  "${note.content.substring(0, 300)}"`;
        notasAgrupadas[note.week].push(notaTexto);
      });

      // Limitar chars por semana
      let contextoDasNotas = Object.keys(notasAgrupadas).map(week => {
        const notasSemana = notasAgrupadas[week].join('\n');
        return `**${week}:**\n${notasSemana.substring(0, ESTRUTURACAO_LIMITS.notasPorSemana)}`;
      }).join('\n\n');
      
      // Limitar total de notas
      if (contextoDasNotas.length > ESTRUTURACAO_LIMITS.totalNotas) {
        contextoDasNotas = contextoDasNotas.substring(0, ESTRUTURACAO_LIMITS.totalNotas) + '\n\n[... anota√ß√µes adicionais resumidas para otimiza√ß√£o ...]';
      }

      // Preparar contexto das m√≠dias tagueadas com descri√ß√µes
      let contextoMidiasTagueadas = '';
      if (data.midiasTagueadas && data.midiasTagueadas.length > 0) {
        const midiasComDescricao = data.midiasTagueadas.filter(m => m.descricao && m.descricao.trim());
        if (midiasComDescricao.length > 0) {
          contextoMidiasTagueadas = `\n\n**üì∏ M√çDIAS TAGUEADAS COM DESCRI√á√ïES (${midiasComDescricao.length} arquivos):**
As seguintes fotos/v√≠deos foram tagueados especificamente para este entreg√°vel, com descri√ß√µes fornecidas pelo usu√°rio que devem ser consideradas na an√°lise:

${midiasComDescricao.map((m, idx) => `${idx + 1}. **M√≠dia ${idx + 1}** ${m.filename ? `(${m.filename})` : ''}:
   - Descri√ß√£o: "${m.descricao}"
   - Tags: ${m.tags.join(', ')}`).join('\n\n')}

**IMPORTANTE:** Use estas descri√ß√µes das m√≠dias para enriquecer sua an√°lise. Elas cont√™m contexto visual importante sobre o neg√≥cio, produtos, servi√ßos ou refer√™ncias que o usu√°rio considerou relevantes para este entreg√°vel.

---
`;
        }
      }

      // Usar promptAnalise espec√≠fico se dispon√≠vel, sen√£o usar prompt padr√£o
      const promptEspecifico = mapping.promptAnalise || mapping.prompt || `Analise o progresso do entreg√°vel "${mapping.title}" da Mediagrowth.`;
      
      // Obter contexto do neg√≥cio usando a fun√ß√£o global - COM LIMITE
      let businessInfo = typeof getBusinessInfoForAI === 'function' ? getBusinessInfoForAI() : '';
      if (businessInfo.length > ESTRUTURACAO_LIMITS.businessInfo) {
        businessInfo = businessInfo.substring(0, ESTRUTURACAO_LIMITS.businessInfo) + '\n[... contexto resumido ...]';
      }
      
      const prompt = `${promptEspecifico}

${businessInfo ? `**üìã CONTEXTO DO NEG√ìCIO:**
${businessInfo}

---

` : ''}**INFORMA√á√ïES COLETADAS DAS SEMANAS DE ESTRUTURA√á√ÉO:**

${contextoDasNotas}
${contextoMidiasTagueadas}

${window.metricasPrimeiroMes ? `**üìä M√âTRICAS DO PRIMEIRO M√äS (FORNECIDAS PELO USU√ÅRIO - USE ESTAS COMO BASE EXATA):**

üóìÔ∏è **M√™s de Refer√™ncia:** ${window.metricasPrimeiroMes.mesReferencia}

üí∞ **Investimento em M√≠dia Paga:** ${window.metricasPrimeiroMes.investimento}
üìä **Leads Org√¢nicos Esperados:** ${window.metricasPrimeiroMes.leadsOrganicos}
üí∏ **Leads Tr√°fego Pago Esperados:** ${window.metricasPrimeiroMes.leadsTrafegoPago}
üìà **Taxa de Convers√£o (Pago):** ${window.metricasPrimeiroMes.convPago}%
üìà **Taxa de Convers√£o (Org√¢nico):** ${window.metricasPrimeiroMes.convOrg}%
üéØ **Vendas Esperadas:** ${window.metricasPrimeiroMes.vendasEsperadas} (${window.metricasPrimeiroMes.vendasPago} do pago + ${window.metricasPrimeiroMes.vendasOrg} do org√¢nico)
üíµ **Faturamento Esperado:** ${window.metricasPrimeiroMes.faturamentoEsperado}

**üö® INSTRU√á√ÉO CR√çTICA PARA O PRIMEIRO M√äS:**

1. Use EXATAMENTE estas m√©tricas para o **${window.metricasPrimeiroMes.mesReferencia}** (primeiro m√™s da tabela)
2. N√ÉO modifique os valores acima - eles foram fornecidos pelo cliente
3. Calcule o CPL baseado em: Investimento √∑ Leads Tr√°fego Pago = CPL
4. Calcule o CAC baseado em: Investimento √∑ Vendas = CAC
5. Calcule o ROAS baseado em: Faturamento √∑ Investimento = ROAS

**üìà PARA OS PR√ìXIMOS 11 MESES:**

- Aplique crescimento gradual e realista (n√£o linear!)
- Considere sazonalidade do nicho
- Melhore progressivamente CPL, CAC e ROAS conforme otimiza√ß√µes
- Aumente leads org√¢nicos mais rapidamente que leads pagos (efeito do trabalho de conte√∫do)
- Mantenha o ticket m√©dio: R$ ${window.metricasPrimeiroMes.ticketMedio ? window.metricasPrimeiroMes.ticketMedio.toLocaleString('pt-BR') : 'N/A'}

${window.metricasPrimeiroMes.observacoes ? `**üìù OBSERVA√á√ïES E CONTEXTO ADICIONAL DO CLIENTE:**

${window.metricasPrimeiroMes.observacoes}

**üéØ IMPORTANTE:** Leve estas observa√ß√µes em considera√ß√£o ao projetar os 12 meses. Adapte crescimento, sazonalidade, investimentos e estrat√©gias conforme o contexto fornecido acima.

` : ''}${window.metricasPrimeiroMes && window.metricasPrimeiroMes.redesSociais ? `**üì± METAS DE REDES SOCIAIS (FORNECIDAS PELO USU√ÅRIO):**

${(() => {
  const redes = window.metricasPrimeiroMes.redesSociais;
  let texto = '';
  
  // Instagram
  if (redes.instagram.atual || redes.instagram.mes3 || redes.instagram.mes6 || redes.instagram.mes12) {
    texto += `üì∏ **Instagram:**\n`;
    if (redes.instagram.atual) texto += `   - Base Atual: ${redes.instagram.atual} seguidores\n`;
    if (redes.instagram.mes3) texto += `   - Meta M√™s 3: ${redes.instagram.mes3} seguidores\n`;
    if (redes.instagram.mes6) texto += `   - Meta M√™s 6: ${redes.instagram.mes6} seguidores\n`;
    if (redes.instagram.mes12) texto += `   - Meta M√™s 12: ${redes.instagram.mes12} seguidores\n`;
    texto += `   - Objetivo: Leads, DMs, prova social\n\n`;
  }
  
  // Facebook
  if (redes.facebook.atual || redes.facebook.mes3 || redes.facebook.mes6 || redes.facebook.mes12) {
    texto += `üìò **Facebook:**\n`;
    if (redes.facebook.atual) texto += `   - Base Atual: ${redes.facebook.atual} seguidores\n`;
    if (redes.facebook.mes3) texto += `   - Meta M√™s 3: ${redes.facebook.mes3} seguidores\n`;
    if (redes.facebook.mes6) texto += `   - Meta M√™s 6: ${redes.facebook.mes6} seguidores\n`;
    if (redes.facebook.mes12) texto += `   - Meta M√™s 12: ${redes.facebook.mes12} seguidores\n`;
    texto += `   - Objetivo: Mensagens, tr√°fego\n\n`;
  }
  
  // LinkedIn
  if (redes.linkedin.atual || redes.linkedin.mes3 || redes.linkedin.mes6 || redes.linkedin.mes12) {
    texto += `üíº **LinkedIn:**\n`;
    if (redes.linkedin.atual) texto += `   - Base Atual: ${redes.linkedin.atual} seguidores\n`;
    if (redes.linkedin.mes3) texto += `   - Meta M√™s 3: ${redes.linkedin.mes3} seguidores\n`;
    if (redes.linkedin.mes6) texto += `   - Meta M√™s 6: ${redes.linkedin.mes6} seguidores\n`;
    if (redes.linkedin.mes12) texto += `   - Meta M√™s 12: ${redes.linkedin.mes12} seguidores\n`;
    texto += `   - Objetivo: Leads B2B, networking\n\n`;
  }
  
  // TikTok
  if (redes.tiktok.atual || redes.tiktok.mes3 || redes.tiktok.mes6 || redes.tiktok.mes12) {
    texto += `üéµ **TikTok:**\n`;
    if (redes.tiktok.atual) texto += `   - Base Atual: ${redes.tiktok.atual} seguidores\n`;
    if (redes.tiktok.mes3) texto += `   - Meta M√™s 3: ${redes.tiktok.mes3} seguidores\n`;
    if (redes.tiktok.mes6) texto += `   - Meta M√™s 6: ${redes.tiktok.mes6} seguidores\n`;
    if (redes.tiktok.mes12) texto += `   - Meta M√™s 12: ${redes.tiktok.mes12} seguidores\n`;
    texto += `   - Objetivo: Alcance viral, leads\n\n`;
  }
  
  if (texto) {
    return texto + `**üéØ IMPORTANTE:** Inclua estas metas de redes sociais na se√ß√£o "Metas de Redes Sociais" do relat√≥rio. Se alguma rede n√£o tiver dados, use "A coletar" na tabela.`;
  }
  
  return '';
})()}

` : ''}---

` : ''}**M√âTRICAS QUANTITATIVAS:**
- Progresso geral: ${data.totalItems > 0 ? Math.round((data.completedItems / data.totalItems) * 100) : 0}%
- Tarefas conclu√≠das: ${data.completedItems} de ${data.totalItems}
- Total de anota√ß√µes: ${data.notes.length}
- Arquivos anexados: ${data.files.length}
- M√≠dias tagueadas para este entreg√°vel: ${data.midiasTagueadas ? data.midiasTagueadas.length : 0}
- Semanas trabalhadas: ${data.weeks.join(', ')}

**DIMENS√ïES AVALIADAS (de 0 a 100%):**
${mapping.radarLabels ? mapping.radarLabels.map((label, i) => {
  const values = [data.dimensions.completude, data.dimensions.documentacao, data.dimensions.qualidade, data.dimensions.organizacao, data.dimensions.engajamento];
  return `- ${label}: ${values[i % values.length]}%`;
}).join('\n') : `- Completude: ${data.dimensions.completude}%
- Documenta√ß√£o: ${data.dimensions.documentacao}%
- Qualidade: ${data.dimensions.qualidade}%
- Organiza√ß√£o: ${data.dimensions.organizacao}%
- Engajamento: ${data.dimensions.engajamento}%`}

---

${window.landingPagesInfo ? `
**üéØ INFORMA√á√ïES ESPEC√çFICAS PARA LANDING PAGES/WEBSITE (FORNECIDAS PELO USU√ÅRIO):**

üì¶ **Produtos/Servi√ßos a Promover:**
${window.landingPagesInfo.produtos}

üéØ **Objetivo Principal:** ${window.landingPagesInfo.objetivoTexto}

${window.landingPagesInfo.preco ? `üí∞ **Faixa de Pre√ßo:** ${window.landingPagesInfo.preco}` : ''}

${window.landingPagesInfo.canalTexto ? `üì¢ **Canal de Tr√°fego Principal:** ${window.landingPagesInfo.canalTexto}` : ''}

${window.landingPagesInfo.diferenciais ? `‚ú® **Diferenciais/Garantias:** ${window.landingPagesInfo.diferenciais}` : ''}

${window.landingPagesInfo.observacoes ? `üìù **Observa√ß√µes Adicionais:** ${window.landingPagesInfo.observacoes}` : ''}

**IMPORTANTE:** Use TODAS estas informa√ß√µes acima para criar landing pages/website ESPEC√çFICOS para estes produtos, com copy persuasiva AIDA direcionada ao objetivo escolhido, CTAs otimizados para o canal de tr√°fego indicado, e incluindo os diferenciais mencionados.

---
` : ''}

${window.regenerateExtraInstructions ? `
**‚ö†Ô∏è INSTRU√á√ïES ESPECIAIS DO USU√ÅRIO (PRIORIDADE M√ÅXIMA):**
${window.regenerateExtraInstructions}

---
` : ''}

Baseie toda sua an√°lise nas anota√ß√µes acima. Seja ESPEC√çFICO e cite informa√ß√µes reais. Use formata√ß√£o Markdown profissional.`;

      // Para Plataforma Mediagrowth, adicionar resumo dos relat√≥rios j√° gerados
      let promptFinal = prompt + "\n\n" + (INSTRUCAO_NAO_INVENTAR || "");
      const entregavelAtual = window.currentEntregavelId || '';
      if (entregavelAtual === 'plataforma_mediagrowth' && window.USER_DATA && window.USER_DATA.analises) {
        const analises = window.USER_DATA.analises;
        const resumoRelatorios = Object.keys(analises).filter(k => k !== 'plataforma_mediagrowth').map(key => {
          const analise = analises[key];
          if (analise && analise.insightHtml) {
            // Extrair apenas texto do HTML (sem tags)
            const textoLimpo = analise.insightHtml
              .replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '')
              .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '')
              .replace(/<[^>]+>/g, ' ')
              .replace(/\s+/g, ' ')
              .trim()
              .substring(0, 2000); // Limitar a 2000 chars por relat√≥rio
            return '**üìä RELAT√ìRIO: ' + key.toUpperCase() + '**\n' + textoLimpo + '\n';
          }
          return '';
        }).filter(r => r).join('\n---\n');
        
        if (resumoRelatorios) {
          promptFinal = prompt + '\n\n**üìö RELAT√ìRIOS J√Å GERADOS (USAR COMO BASE):**\n\n' + resumoRelatorios + '\n\n---\n';
        }
      }

      try {
        // Mostrar loading
        const hasInstructions = window.regenerateExtraInstructions ? ' com instru√ß√µes personalizadas' : '';
        const isPlataforma = (window.currentEntregavelId === 'plataforma_mediagrowth');
        insightContent.innerHTML = `
          <div style="text-align:center;padding:40px;color:rgba(255,255,255,.7);">
            <div class="spinner-large" style="margin:0 auto 16px;"></div>
            <p>${isPlataforma ? 'üöÄ Gerando Plano Mestre Anual...' : 'Analisando ' + data.notes.length + ' anota√ß√µes com IA' + hasInstructions + '...'}</p>
            ${isPlataforma ? '<p style="font-size:0.8rem;opacity:0.7;">Este relat√≥rio pode demorar mais por ser o documento mais completo.</p>' : ''}
          </div>
        `;

        // üîí Verificar se temos o proxy de IA dispon√≠vel (API key agora est√° no backend)
        if (typeof window.callAIProxy === 'function') {
          // Determinar max_tokens baseado no tipo de entreg√°vel
          // PAI precisa de mais tokens para gerar 5 personas completas
          const entregavelId = window.currentEntregavelId || '';
          
          // üîç DEBUG COMPLETO: Verificar o que est√° sendo enviado para a IA
          console.log(`\n${'='.repeat(80)}`);
          console.log(`üìä INICIANDO GERA√á√ÉO DE AN√ÅLISE: ${entregavelId}`);
          console.log(`${'='.repeat(80)}\n`);
          
          console.log(`üìè Tamanho do promptEspecifico: ${promptEspecifico.length} caracteres`);
          
          if (entregavelId === 'direcionamento_metas') {
            console.log(`\n${'‚îÄ'.repeat(80)}`);
            console.log(`ÔøΩ AN√ÅLISE: DIRECIONAMENTO ESTRAT√âGICO E METAS`);
            console.log(`${'‚îÄ'.repeat(80)}`);
            console.log(`\n‚úÖ CONTEXTOS QUE SER√ÉO ENVIADOS PARA A IA:\n`);
            
            // 1. Prompt espec√≠fico
            console.log(`1Ô∏è‚É£ PROMPT ESPEC√çFICO (Estrutura com 7 se√ß√µes):`);
            console.log(`   üìè Tamanho: ${promptEspecifico.length} caracteres`);
            console.log(`   ÔøΩüìù Primeiros 200 chars:`, promptEspecifico.substring(0, 200) + '...');
            
            // 2. Contexto do neg√≥cio
            console.log(`\n2Ô∏è‚É£ CONTEXTO DO NEG√ìCIO:`);
            if (businessInfo) {
              console.log(`   ‚úÖ Presente (${businessInfo.length} caracteres)`);
              console.log(`   üìù Resumo:`, businessInfo.substring(0, 150) + '...');
            } else {
              console.log(`   ‚ùå N√ÉO PRESENTE`);
            }
            
            // 3. Anota√ß√µes das semanas
            console.log(`\n3Ô∏è‚É£ ANOTA√á√ïES DAS SEMANAS DE ESTRUTURA√á√ÉO:`);
            console.log(`   ‚úÖ Presente (${contextoDasNotas.length} caracteres)`);
            console.log(`   üìù Total de notas: ${data.notes.length}`);
            
            // 4. M√©tricas do primeiro m√™s
            console.log(`\n4Ô∏è‚É£ M√âTRICAS DO PRIMEIRO M√äS (do Modal):`);
            if (window.metricasPrimeiroMes) {
              console.log(`   ‚úÖ PRESENTE - Dados coletados:`);
              console.log(`      üìÖ M√™s: ${window.metricasPrimeiroMes.mesReferencia}`);
              console.log(`      üí∞ Investimento: ${window.metricasPrimeiroMes.investimento}`);
              console.log(`      üìä Leads Org√¢nicos: ${window.metricasPrimeiroMes.leadsOrganicos}`);
              console.log(`      üí∏ Leads Tr√°fego Pago: ${window.metricasPrimeiroMes.leadsTrafegoPago}`);
              console.log(`      üìà Conv. Pago: ${window.metricasPrimeiroMes.convPago}%`);
              console.log(`      üìà Conv. Org: ${window.metricasPrimeiroMes.convOrg}%`);
              console.log(`      üéØ Vendas: ${window.metricasPrimeiroMes.vendasEsperadas}`);
              console.log(`      üíµ Faturamento: ${window.metricasPrimeiroMes.faturamentoEsperado}`);
              console.log(`      üé´ Ticket M√©dio: R$ ${window.metricasPrimeiroMes.ticketMedio || 'N/A'}`);
              if (window.metricasPrimeiroMes.observacoes) {
                console.log(`      üìù Observa√ß√µes: "${window.metricasPrimeiroMes.observacoes.substring(0, 100)}..."`);
              }
              if (window.metricasPrimeiroMes.redesSociais) {
                const redes = window.metricasPrimeiroMes.redesSociais;
                const redesPreenchidas = [];
                if (redes.instagram.atual || redes.instagram.mes12) redesPreenchidas.push('Instagram');
                if (redes.facebook.atual || redes.facebook.mes12) redesPreenchidas.push('Facebook');
                if (redes.linkedin.atual || redes.linkedin.mes12) redesPreenchidas.push('LinkedIn');
                if (redes.tiktok.atual || redes.tiktok.mes12) redesPreenchidas.push('TikTok');
                if (redesPreenchidas.length > 0) {
                  console.log(`      üì± Redes Sociais: ${redesPreenchidas.join(', ')}`);
                }
              }
              
              // üö® LOG CR√çTICO: Mostrar o TEXTO EXATO que ser√° enviado √† IA
              console.log(`\n      üîç TEXTO EXATO QUE SER√Å ENVIADO √Ä IA:`);
              console.log(`      ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`);
              console.log(`      üóìÔ∏è M√™s de Refer√™ncia: ${window.metricasPrimeiroMes.mesReferencia}`);
              console.log(`      üí∞ Investimento em M√≠dia Paga: ${window.metricasPrimeiroMes.investimento}`);
              console.log(`      üìä Leads Org√¢nicos Esperados: ${window.metricasPrimeiroMes.leadsOrganicos}`);
              console.log(`      üí∏ Leads Tr√°fego Pago Esperados: ${window.metricasPrimeiroMes.leadsTrafegoPago}`);
              console.log(`      üìà Taxa de Convers√£o (Pago): ${window.metricasPrimeiroMes.convPago}%`);
              console.log(`      üìà Taxa de Convers√£o (Org√¢nico): ${window.metricasPrimeiroMes.convOrg}%`);
              console.log(`      üéØ Vendas Esperadas: ${window.metricasPrimeiroMes.vendasEsperadas} (${window.metricasPrimeiroMes.vendasPago} pago + ${window.metricasPrimeiroMes.vendasOrg} org√¢nico)`);
              console.log(`      üíµ Faturamento Esperado: ${window.metricasPrimeiroMes.faturamentoEsperado}`);
              console.log(`      ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`);
            } else {
              console.log(`   ‚ö†Ô∏è N√ÉO PRESENTE (modal n√£o foi preenchido)`);
              console.log(`   ‚ùå ERRO CR√çTICO: window.metricasPrimeiroMes est√° undefined!`);
              console.log(`   ‚ö†Ô∏è A IA N√ÉO receber√° as m√©tricas do primeiro m√™s!\n`);
            }
            
            // 5. M√≠dias tagueadas
            console.log(`\n5Ô∏è‚É£ M√çDIAS TAGUEADAS:`);
            if (data.midiasTagueadas && data.midiasTagueadas.length > 0) {
              console.log(`   ‚úÖ ${data.midiasTagueadas.length} m√≠dias tagueadas`);
            } else {
              console.log(`   ‚ÑπÔ∏è Nenhuma m√≠dia tagueada`);
            }
            
            // 6. Instru√ß√µes extras
            console.log(`\n6Ô∏è‚É£ INSTRU√á√ïES EXTRAS DO USU√ÅRIO:`);
            if (window.regenerateExtraInstructions) {
              console.log(`   ‚úÖ Presente: "${window.regenerateExtraInstructions}"`);
            } else {
              console.log(`   ‚ÑπÔ∏è Nenhuma instru√ß√£o extra`);
            }
            
            console.log(`\n${'‚îÄ'.repeat(80)}`);
            console.log(`üì¶ TAMANHO TOTAL DO PROMPT: ${prompt.length} caracteres (~${Math.ceil(prompt.length / 4)} tokens)`);
            console.log(`${'‚îÄ'.repeat(80)}\n`);
          }
          
          let maxTokensAnalise = 2000; // padr√£o
          
          // Entreg√°veis que precisam de mais tokens
          const entregaveisExtendidos = ['pai', 'diagnostico_estrategico', 'direcionamento_metas', 'matriz_cdt', 'puv', 'copywriting', 'producao_conteudo', 'criativos_anuncios', 'crm_automacoes', 'processo_comercial', 'landing_pages', 'website', 'padronizacao_visual', 'anuncios_pagos', 'analise_concorrencia', 'site_seo', 'redes_sociais'];
          if (entregaveisExtendidos.includes(entregavelId)) {
            maxTokensAnalise = 8000; // Muito mais tokens para an√°lises completas
          }
          
          // Entreg√°veis que precisam de MUITOS tokens (estruturas complexas com 12+ se√ß√µes)
          if (['anuncios_pagos', 'analise_concorrencia', 'site_seo', 'redes_sociais'].includes(entregavelId)) {
            maxTokensAnalise = 12000; // Estrutura√ß√£o completa com 12-14 se√ß√µes detalhadas
          }
          
          // Direcionamento e Metas precisa de muitos tokens (planejamento 12 meses)
          if (entregavelId === 'direcionamento_metas') {
            maxTokensAnalise = 12000; // Planejamento completo de 12 meses com todas as m√©tricas
          }
          
          // Plataforma Mediagrowth precisa de ainda mais tokens (Plano Mestre Anual)
          if (entregavelId === 'plataforma_mediagrowth') {
            maxTokensAnalise = 16000; // Documento mestre com planejamento anual completo
          }
          
          // ‚ö†Ô∏è CR√çTICO: Adicionar instru√ß√£o de COMPLETUDE no final do prompt
          const instrucoesCompletude = `

---

üö® **INSTRU√á√ÉO CR√çTICA DE COMPLETUDE:**

Voc√™ tem EXATAMENTE ${maxTokensAnalise} tokens dispon√≠veis para esta an√°lise.

**REGRAS OBRIGAT√ìRIAS:**
1. **NUNCA** termine a an√°lise no meio de uma frase ou se√ß√£o
2. **SEMPRE** conclua TODAS as se√ß√µes planejadas
3. Se perceber que est√° chegando ao limite de tokens, **REDUZA o tamanho de cada se√ß√£o** proporcionalmente
4. √â MELHOR ter 10 se√ß√µes completas e concisas do que 8 se√ß√µes detalhadas e 2 incompletas
5. **PRIORIDADE ABSOLUTA:** An√°lise completa > An√°lise parcial detalhada
6. A √∫ltima frase DEVE ser uma conclus√£o profissional, NUNCA cortada

**ESTRUTURA OBRIGAT√ìRIA:**
- ‚úÖ Todas as se√ß√µes principais presentes
- ‚úÖ Todas as tabelas/checklists completos
- ‚úÖ Conclus√£o final presente
- ‚úÖ Sem texto cortado no meio

**SE NECESS√ÅRIO:** Reduza o detalhamento mas MANTENHA a estrutura completa.

IMPORTANTE: Distribua os tokens de forma inteligente para cobrir TODO o conte√∫do solicitado at√© o final.`;

          const promptComInstrucoes = promptFinal + instrucoesCompletude;
          
          // üîç DEBUG: Verificar tamanho do prompt final
          console.log(`üì¶ Tamanho do prompt FINAL: ${promptComInstrucoes.length} caracteres (~${Math.ceil(promptComInstrucoes.length / 4)} tokens)`);
          
          // üéØ MODELO ESPECIAL: Gemini 2.5 Pro para Direcionamento Estrat√©gico e Metas
          const modeloIA = entregavelId === 'direcionamento_metas' 
            ? 'google/gemini-2.5-pro' 
            : window.IA_CONFIG.model;
          
          // Debug: Mostrar qual modelo est√° sendo usado
          console.log(`\n${'='.repeat(80)}`);
          console.log(`ü§ñ CONFIGURA√á√ÉO DA IA`);
          console.log(`${'='.repeat(80)}`);
          console.log(`üìã Entreg√°vel: ${entregavelId}`);
          console.log(`üéØ Modelo IA: ${modeloIA}`);
          console.log(`üìä Max tokens: ${maxTokensAnalise}`);
          console.log(`üå°Ô∏è Temperature: ${window.IA_CONFIG.temperature.default}`);
          
          if (entregavelId === 'direcionamento_metas') {
            console.log(`‚ú® Usando Google Gemini 2.5 Pro (modelo avan√ßado do Google para an√°lise de Metas)`);
            console.log(`\nüì§ RESUMO DO QUE SER√Å ENVIADO PARA A IA:`);
            console.log(`   - Prompt estruturado em 7 se√ß√µes com f√≥rmulas obrigat√≥rias`);
            console.log(`   - Contexto completo do neg√≥cio (nicho, ticket, or√ßamento)`);
            console.log(`   - Todas as anota√ß√µes das semanas de estrutura√ß√£o`);
            console.log(`   - M√©tricas do primeiro m√™s (do modal)`);
            console.log(`   - Metas de redes sociais (se fornecidas)`);
            console.log(`   - Observa√ß√µes adicionais do usu√°rio`);
            console.log(`   - Instru√ß√µes de completude e realismo`);
            console.log(`\nüéØ A IA receber√° TODOS os dados necess√°rios para gerar o relat√≥rio de 12 meses!`);
            
            // üîç VERIFICA√á√ÉO CR√çTICA: Mostrar trecho do prompt com as m√©tricas
            console.log(`\nüîç VERIFICA√á√ÉO DO PROMPT (primeiros 3000 chars):`);
            console.log(`${'‚îÄ'.repeat(80)}`);
            console.log(promptComInstrucoes.substring(0, 3000));
            console.log(`${'‚îÄ'.repeat(80)}`);
            
            // Verificar se as m√©tricas est√£o no prompt
            if (promptComInstrucoes.includes('M√âTRICAS DO PRIMEIRO M√äS')) {
              console.log(`\n‚úÖ CONFIRMADO: Se√ß√£o "M√âTRICAS DO PRIMEIRO M√äS" est√° no prompt!`);
              
              // Extrair e mostrar a se√ß√£o de m√©tricas
              const inicioMetricas = promptComInstrucoes.indexOf('üìä M√âTRICAS DO PRIMEIRO M√äS');
              if (inicioMetricas !== -1) {
                const trechoMetricas = promptComInstrucoes.substring(inicioMetricas, inicioMetricas + 800);
                console.log(`\nüìä TRECHO DA SE√á√ÉO DE M√âTRICAS NO PROMPT:`);
                console.log(`${'‚îÄ'.repeat(80)}`);
                console.log(trechoMetricas);
                console.log(`${'‚îÄ'.repeat(80)}\n`);
              }
            } else {
              console.log(`\n‚ùå ERRO CR√çTICO: Se√ß√£o "M√âTRICAS DO PRIMEIRO M√äS" N√ÉO est√° no prompt!`);
              console.log(`‚ö†Ô∏è A IA N√ÉO receber√° os valores do primeiro m√™s!\n`);
            }
          }
          console.log(`${'='.repeat(80)}\n`);
          
          // üöÄ LOG FINAL: Chamada da API
          console.log(`üöÄ CHAMANDO API DO OPENROUTER`);
          console.log(`   ü§ñ Modelo: ${modeloIA}`);
          console.log(`   üìä Max tokens: ${maxTokensAnalise}`);
          console.log(`   üå°Ô∏è Temperature: ${window.IA_CONFIG.temperature.default}`);
          console.log(`   üìè Tamanho total do prompt: ${promptComInstrucoes.length} caracteres`);
          if (window.metricasPrimeiroMes) {
            console.log(`   ‚úÖ M√©tricas do modal INCLU√çDAS no prompt`);
            console.log(`      ‚îî‚îÄ Investimento: ${window.metricasPrimeiroMes.investimento}`);
            console.log(`      ‚îî‚îÄ Leads total: ${(parseInt(window.metricasPrimeiroMes.leadsOrganicos) || 0) + (parseInt(window.metricasPrimeiroMes.leadsTrafegoPago) || 0)}`);
            console.log(`      ‚îî‚îÄ Vendas: ${window.metricasPrimeiroMes.vendasEsperadas}`);
          } else {
            console.log(`   ‚ö†Ô∏è M√©tricas do modal N√ÉO dispon√≠veis`);
          }
          console.log(``);
          
          // üîí Usando proxy seguro (API key no backend)
          const systemContent = entregavelId === 'plataforma_mediagrowth' 
            ? 'Voc√™ √© o DIRETOR DE ESTRAT√âGIA da Mediagrowth. Sua miss√£o √© criar o PLANO MESTRE ANUAL mais completo poss√≠vel, consolidando TODAS as informa√ß√µes coletadas. Use dados REAIS das anota√ß√µes e relat√≥rios. Seja EXTREMAMENTE detalhado com datas, n√∫meros, a√ß√µes e metas. Este √© o documento mais importante da plataforma. ‚ö†Ô∏è CR√çTICO: SEMPRE complete a an√°lise INTEIRA dentro do limite de tokens - ajuste o n√≠vel de detalhe mas NUNCA deixe incompleto.'
            : 'Voc√™ √© um consultor s√™nior de marketing digital da Mediagrowth, especializado em an√°lise estrat√©gica de entreg√°veis. Sua miss√£o √© fornecer insights profundos, espec√≠ficos e acion√°veis baseados em dados reais. N√£o limite suas respostas - forne√ßa an√°lises completas e detalhadas. ‚ö†Ô∏è CR√çTICO: SEMPRE complete a an√°lise INTEIRA dentro do limite de tokens - ajuste o n√≠vel de detalhe mas NUNCA deixe incompleto.';
          
          const messagesEntregavel = [
            { role: 'system', content: systemContent },
            { role: 'user', content: promptComInstrucoes }
          ];
          
          const result = await window.callAIProxy(modeloIA, messagesEntregavel, auth.currentUser?.uid, maxTokensAnalise, window.IA_CONFIG.temperature.default);

          if (result && result.choices) {
            const result = await response.json();
            let insightText = result.choices?.[0]?.message?.content || '';
            
            // üí∞ LOG DETALHADO DE CUSTOS - ESTRUTURA√á√ÉO
            const usage = result.usage || {};
            const inputTokens = usage.prompt_tokens || Math.ceil(promptComInstrucoes.length / 4);
            const outputTokens = usage.completion_tokens || Math.ceil(insightText.length / 4);
            const totalTokens = inputTokens + outputTokens;
            
            // Pre√ßos por modelo (por 1M tokens)
            const precos = {
              'google/gemini-2.5-flash': { input: 0.15, output: 0.60, nome: 'Gemini Flash' },
              'google/gemini-2.5-pro': { input: 1.25, output: 10.00, nome: 'Gemini Pro' },
              'anthropic/claude-sonnet': { input: 3.00, output: 15.00, nome: 'Claude Sonnet' },
              'openai/gpt-4o-mini': { input: 0.15, output: 0.60, nome: 'GPT-4o Mini' },
              'openai/gpt-4o': { input: 5.00, output: 15.00, nome: 'GPT-4o' }
            };
            
            const modeloPreco = precos[modeloIA] || precos['google/gemini-2.5-flash'];
            const custoInput = (inputTokens / 1000000) * modeloPreco.input;
            const custoOutput = (outputTokens / 1000000) * modeloPreco.output;
            const custoTotal = custoInput + custoOutput;
            
            // Rastrear custos da sess√£o de estrutura√ß√£o
            if (!window.ESTRUTURACAO_CUSTOS) {
              window.ESTRUTURACAO_CUSTOS = { total: 0, geracoes: 0 };
            }
            window.ESTRUTURACAO_CUSTOS.total += custoTotal;
            window.ESTRUTURACAO_CUSTOS.geracoes++;
            
            console.log(`\n%cüí∞ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`, 'color: #22c55e; font-weight: bold');
            console.log(`%cüí∞ CUSTO DA AN√ÅLISE: ${entregavelId.toUpperCase()}`, 'color: #22c55e; font-weight: bold');
            console.log(`%cüí∞ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`, 'color: #22c55e; font-weight: bold');
            console.log(`   ü§ñ Modelo: ${modeloIA} (${modeloPreco.nome})`);
            console.log(`   üì• Input tokens: ${inputTokens.toLocaleString()}`);
            console.log(`   üì§ Output tokens: ${outputTokens.toLocaleString()}`);
            console.log(`   üìä Total tokens: ${totalTokens.toLocaleString()}`);
            console.log(`%cüí∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ`, 'color: #22c55e');
            console.log(`   üíµ Custo input:  $${custoInput.toFixed(6)} (${inputTokens} √ó $${modeloPreco.input}/1M)`);
            console.log(`   üíµ Custo output: $${custoOutput.toFixed(6)} (${outputTokens} √ó $${modeloPreco.output}/1M)`);
            console.log(`   üí∞ CUSTO TOTAL:  $${custoTotal.toFixed(6)}`);
            console.log(`%cüí∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ`, 'color: #22c55e');
            
            // Breakdown do prompt
            console.log(`%cüìä BREAKDOWN DO PROMPT:`, 'color: #f59e0b; font-weight: bold');
            console.log(`   üìù Prompt espec√≠fico: ${promptEspecifico.length.toLocaleString()} chars (~${Math.ceil(promptEspecifico.length/4).toLocaleString()} tokens)`);
            console.log(`   üìã Contexto notas: ${contextoDasNotas.length.toLocaleString()} chars (~${Math.ceil(contextoDasNotas.length/4).toLocaleString()} tokens)`);
            console.log(`   üè¢ Business info: ${businessInfo.length.toLocaleString()} chars (~${Math.ceil(businessInfo.length/4).toLocaleString()} tokens)`);
            if (window.metricasPrimeiroMes) {
              console.log(`   üìä M√©tricas modal: ~500 chars (~125 tokens)`);
            }
            console.log(`   üìè TOTAL PROMPT: ${promptComInstrucoes.length.toLocaleString()} chars (~${Math.ceil(promptComInstrucoes.length/4).toLocaleString()} tokens)`);
            
            // Comparativo com outros modelos
            console.log(`%cüí° SE USASSE OUTRO MODELO:`, 'color: #f59e0b');
            Object.entries(precos).forEach(([modelo, p]) => {
              if (modelo !== modeloIA) {
                const custoAlt = (inputTokens / 1000000) * p.input + (outputTokens / 1000000) * p.output;
                const diff = custoAlt - custoTotal;
                const emoji = diff > 0 ? 'üìà' : 'üìâ';
                console.log(`   ${emoji} ${p.nome}: $${custoAlt.toFixed(6)} (${diff > 0 ? '+' : ''}$${diff.toFixed(6)})`);
              }
            });
            
            // Oportunidades de economia
            console.log(`%cüí° OPORTUNIDADES DE ECONOMIA:`, 'color: #ef4444; font-weight: bold');
            if (contextoDasNotas.length > 8000) {
              console.log(`   ‚ö†Ô∏è Notas muito extensas (${Math.ceil(contextoDasNotas.length/4)} tokens) - Considere resumir`);
            }
            if (businessInfo.length > 3000) {
              console.log(`   ‚ö†Ô∏è Business info grande (${Math.ceil(businessInfo.length/4)} tokens) - Poderia ser mais conciso`);
            }
            if (inputTokens > 15000) {
              console.log(`   üö® ALERTA: ${inputTokens.toLocaleString()} tokens de input √© MUITO! Meta √© <10k`);
            } else if (inputTokens < 8000) {
              console.log(`   ‚úÖ Consumo otimizado! Menos de 8k tokens de input.`);
            }
            
            // Custos acumulados da sess√£o
            console.log(`%cüìà CUSTOS DA SESS√ÉO DE ESTRUTURA√á√ÉO:`, 'color: #22c55e');
            console.log(`   üìä An√°lises geradas: ${window.ESTRUTURACAO_CUSTOS.geracoes}`);
            console.log(`   üíµ Custo total sess√£o: $${window.ESTRUTURACAO_CUSTOS.total.toFixed(6)}`);
            console.log(`   üìâ Custo m√©dio por an√°lise: $${(window.ESTRUTURACAO_CUSTOS.total / window.ESTRUTURACAO_CUSTOS.geracoes).toFixed(6)}`);
            console.log(`%cüí∞ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`, 'color: #22c55e; font-weight: bold');
            
            // Renderizar markdown
            let htmlContent = '';
            if (typeof renderMarkdownText === 'function') {
              htmlContent = renderMarkdownText(insightText);
            } else {
              htmlContent = insightText.replace(/\n/g, '<br>');
            }
            
            // Adicionar se√ß√£o de m√≠dias tagueadas espec√≠ficas deste entreg√°vel
            // (Substituiu o sistema anterior de m√≠dias de refer√™ncia - agora s√≥ mostra m√≠dias com tags)
            const midiasTagueadasHtml = gerarSecaoMidiasTagueadas(data.midiasTagueadas, entregavelId);
            if (midiasTagueadasHtml) {
              htmlContent = midiasTagueadasHtml + htmlContent;
            }
            
            // Processar HTML para adicionar blocos regener√°veis
            htmlContent = processarBlocosRegeneraveis(htmlContent);
            
            insightContent.innerHTML = htmlContent;
            return;
          } else {
            console.warn('Erro na API:', response.status);
          }
        }
        
        // Fallback sem IA
        generateFallbackInsights(data, insightContent);
        
      } catch (error) {
        console.error('Erro ao gerar insights:', error);
        generateFallbackInsights(data, insightContent);
      }
    }

    // ============================================
    // BLOCOS REGENER√ÅVEIS - FUN√á√ïES DE PROCESSAMENTO E REGENERA√á√ÉO
    // ============================================
    
    // Vari√°veis globais para controle de regenera√ß√£o de bloco
    window.currentBlocoIndex = null;
    window.currentBlocoTitulo = '';
    window.currentBlocoConteudo = '';
    
    /**
     * Processa o HTML da an√°lise para adicionar wrappers de bloco regener√°vel
     * Cada se√ß√£o (h1, h2, h3) se torna um bloco com bot√£o de regenerar
     */
    function processarBlocosRegeneraveis(htmlContent) {
      if (!htmlContent) return htmlContent;
      
      // Criar um container tempor√°rio para manipular o DOM
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = htmlContent;
      
      // IMPORTANTE: Verificar se j√° foi processado (evitar duplica√ß√£o de bot√µes)
      // Se j√° existem wrappers de bloco, remover e reprocessar do zero
      const wrappersExistentes = tempDiv.querySelectorAll('.analise-bloco-wrapper');
      if (wrappersExistentes.length > 0) {
        // J√° foi processado - extrair conte√∫do sem os wrappers
        wrappersExistentes.forEach(wrapper => {
          const content = wrapper.querySelector('.analise-bloco-content');
          if (content) {
            // Mover o conte√∫do para fora do wrapper
            while (content.firstChild) {
              wrapper.parentNode.insertBefore(content.firstChild, wrapper);
            }
          }
          wrapper.remove();
        });
        
        // Tamb√©m remover containers de bot√µes √≥rf√£os
        tempDiv.querySelectorAll('.analise-bloco-btns').forEach(btn => btn.remove());
      }
      
      // Encontrar apenas t√≠tulos principais (h1 e h2) - N√ÉO h3 e menores
      const headings = tempDiv.querySelectorAll('h1, h2');
      
      if (headings.length === 0) {
        return tempDiv.innerHTML;
      }
      
      let blocoIndex = 0;
      
      headings.forEach((heading, idx) => {
        // Coletar todo o conte√∫do at√© o pr√≥ximo heading de mesmo n√≠vel ou superior
        const blocoContent = [];
        let sibling = heading.nextElementSibling;
        const headingLevel = parseInt(heading.tagName.charAt(1));
        
        while (sibling) {
          const siblingTag = sibling.tagName.toLowerCase();
          // Para se encontrar outro heading de n√≠vel igual ou superior (h1 ou h2)
          if (['h1', 'h2'].includes(siblingTag)) {
            break; // Para ao encontrar outro h1 ou h2
          }
          blocoContent.push(sibling);
          sibling = sibling.nextElementSibling;
        }
        
        // Criar o wrapper do bloco
        const wrapper = document.createElement('div');
        wrapper.className = 'analise-bloco-wrapper';
        wrapper.setAttribute('data-bloco-index', blocoIndex);
        wrapper.setAttribute('data-bloco-titulo', heading.textContent.trim());
        
        // Container dos bot√µes
        const btnsContainer = document.createElement('div');
        btnsContainer.className = 'analise-bloco-btns';
        
        // Bot√£o de regenerar (minimalista)
        const regenBtn = document.createElement('button');
        regenBtn.className = 'analise-bloco-regen-btn';
        regenBtn.setAttribute('data-bloco-index', blocoIndex);
        regenBtn.innerHTML = '‚ú® IA+';
        regenBtn.title = 'Ajustar esta se√ß√£o com IA';
        regenBtn.setAttribute('onclick', `event.preventDefault(); event.stopPropagation(); window.abrirModalBlocoRegen(${blocoIndex});`);
        
        // Bot√£o de excluir bloco
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'analise-bloco-delete-btn';
        deleteBtn.setAttribute('data-bloco-index', blocoIndex);
        deleteBtn.innerHTML = 'üóëÔ∏è';
        deleteBtn.title = 'Excluir esta se√ß√£o';
        deleteBtn.setAttribute('onclick', `event.preventDefault(); event.stopPropagation(); window.excluirBlocoAnalise(${blocoIndex});`);
        
        btnsContainer.appendChild(regenBtn);
        btnsContainer.appendChild(deleteBtn);
        
        // Div do conte√∫do do bloco
        const contentDiv = document.createElement('div');
        contentDiv.className = 'analise-bloco-content';
        contentDiv.setAttribute('data-bloco-index', blocoIndex);
        
        // Mover heading para o wrapper
        heading.parentNode.insertBefore(wrapper, heading);
        wrapper.appendChild(btnsContainer);
        contentDiv.appendChild(heading);
        
        // Mover conte√∫do do bloco (incluindo h3, h4, etc)
        blocoContent.forEach(el => {
          contentDiv.appendChild(el);
        });
        
        wrapper.appendChild(contentDiv);
        blocoIndex++;
      });
      
      return tempDiv.innerHTML;
    }
    
    /**
     * Abre o modal para regenerar um bloco espec√≠fico
     */
    function abrirModalBlocoRegen(blocoIndex) {
      console.log('üéØ abrirModalBlocoRegen chamado com blocoIndex:', blocoIndex);
      
      const modal = document.getElementById('blocoRegenModal');
      const preview = document.getElementById('blocoRegenPreview');
      const input = document.getElementById('blocoRegenInput');
      
      if (!modal) {
        console.error('Modal blocoRegenModal n√£o encontrado!');
        return;
      }
      
      // Encontrar o bloco pelo √≠ndice
      const wrapper = document.querySelector(`.analise-bloco-wrapper[data-bloco-index="${blocoIndex}"]`);
      if (!wrapper) {
        console.warn('Bloco n√£o encontrado:', blocoIndex);
        return;
      }
      
      const titulo = wrapper.getAttribute('data-bloco-titulo') || 'Se√ß√£o';
      const contentDiv = wrapper.querySelector('.analise-bloco-content');
      const conteudoTexto = contentDiv ? contentDiv.innerText.substring(0, 300) : '';
      
      // Armazenar dados do bloco atual
      window.currentBlocoIndex = blocoIndex;
      window.currentBlocoTitulo = titulo;
      window.currentBlocoConteudo = contentDiv ? contentDiv.innerHTML : '';
      
      // Atualizar preview
      if (preview) {
        preview.textContent = titulo + (conteudoTexto.length > 100 ? ': ' + conteudoTexto.substring(0, 150) + '...' : ': ' + conteudoTexto);
      }
      
      // Limpar input
      if (input) {
        input.value = '';
        input.focus();
      }
      
      // Mostrar modal
      console.log('üéØ Modal antes:', modal.style.display, modal);
      modal.style.display = 'flex';
      console.log('üéØ Modal depois:', modal.style.display);
    }
    
    /**
     * Fecha o modal de regenerar bloco
     */
    function fecharModalBlocoRegen() {
      const modal = document.getElementById('blocoRegenModal');
      if (modal) {
        modal.style.display = 'none';
      }
      window.currentBlocoIndex = null;
      window.currentBlocoTitulo = '';
      window.currentBlocoConteudo = '';
    }
    
    /**
     * Exclui um bloco da an√°lise
     */
    function excluirBlocoAnalise(blocoIndex) {
      const wrapper = document.querySelector(`.analise-bloco-wrapper[data-bloco-index="${blocoIndex}"]`);
      if (!wrapper) {
        console.warn('Bloco n√£o encontrado para excluir:', blocoIndex);
        return;
      }
      
      const titulo = wrapper.getAttribute('data-bloco-titulo') || 'esta se√ß√£o';
      
      // Confirmar exclus√£o
      if (!confirm(`üóëÔ∏è Tem certeza que deseja excluir a se√ß√£o:\n\n"${titulo}"?\n\nEsta a√ß√£o n√£o pode ser desfeita.`)) {
        return;
      }
      
      // Anima√ß√£o de fade out
      wrapper.style.transition = 'all 0.3s ease';
      wrapper.style.opacity = '0';
      wrapper.style.transform = 'translateX(20px)';
      
      setTimeout(() => {
        wrapper.remove();
        
        // Salvar an√°lise atualizada no Firebase
        atualizarAnaliseSalvaAposEdicaoBloco();
        
        // Mostrar toast de confirma√ß√£o
        if (typeof showToast === 'function') {
          showToast('‚úÖ Se√ß√£o exclu√≠da com sucesso!');
        }
        
        console.log('üóëÔ∏è Bloco exclu√≠do:', titulo);
      }, 300);
    }
    
    // Exportar fun√ß√£o globalmente
    window.excluirBlocoAnalise = excluirBlocoAnalise;
    
    /**
     * Executa a regenera√ß√£o de um bloco espec√≠fico
     */
    async function executarRegeneracaoBloco() {
      console.log('üöÄ executarRegeneracaoBloco chamado');
      console.log('üîç currentBlocoIndex:', window.currentBlocoIndex);
      console.log('üîç currentBlocoTitulo:', window.currentBlocoTitulo);
      
      if (window.currentBlocoIndex === null) {
        console.warn('‚ùå currentBlocoIndex √© null!');
        return;
      }
      
      const input = document.getElementById('blocoRegenInput');
      const confirmBtn = document.getElementById('blocoRegenConfirmBtn');
      const instrucoes = input ? input.value.trim() : '';
      
      // Obter tamanho selecionado
      const sizeInput = document.querySelector('input[name="blocoRegenSize"]:checked');
      const tamanho = sizeInput ? sizeInput.value : 'medio';
      
      // Obter modo selecionado (refazer ou adicionar)
      const modeInput = document.querySelector('input[name="blocoRegenMode"]:checked');
      const modo = modeInput ? modeInput.value : 'refazer';
      
      // Obter formato selecionado (auto, texto ou planilha)
      const formatInput = document.querySelector('input[name="blocoRegenFormat"]:checked');
      const formato = formatInput ? formatInput.value : 'auto';
      
      console.log('üìù Instru√ß√µes digitadas:', instrucoes);
      console.log('üìè Tamanho selecionado:', tamanho);
      console.log('üîÑ Modo selecionado:', modo);
      console.log('üìä Formato selecionado:', formato);
      
      // Encontrar o wrapper e conte√∫do do bloco
      const wrapper = document.querySelector(`.analise-bloco-wrapper[data-bloco-index="${window.currentBlocoIndex}"]`);
      console.log('üì¶ Wrapper encontrado:', wrapper);
      
      if (!wrapper) {
        console.error('‚ùå Wrapper n√£o encontrado!');
        fecharModalBlocoRegen();
        return;
      }
      
      const contentDiv = wrapper.querySelector('.analise-bloco-content');
      const btnsContainer = wrapper.querySelector('.analise-bloco-btns');
      const regenBtn = wrapper.querySelector('.analise-bloco-regen-btn');
      
      console.log('üìÑ ContentDiv encontrado:', contentDiv);
      
      // Guardar valores antes de fechar modal (que limpa as vari√°veis)
      const blocoTitulo = window.currentBlocoTitulo;
      const blocoConteudo = window.currentBlocoConteudo;
      
      console.log('üìã Titulo guardado:', blocoTitulo);
      console.log('üìã Conte√∫do guardado (primeiros 100 chars):', blocoConteudo?.substring(0, 100));
      
      // Fechar modal
      fecharModalBlocoRegen();
      
      // Estado de loading no bot√£o do bloco
      if (regenBtn) {
        regenBtn.classList.add('loading');
        regenBtn.innerHTML = '‚è≥...';
      }
      if (contentDiv) {
        contentDiv.classList.add('loading');
      }
      
      // Mostrar loading vis√≠vel
      if (btnsContainer) {
        btnsContainer.style.opacity = '1';
      }
      
      try {
        console.log('ü§ñ Chamando regenerarBlocoComIA...');
        // Gerar novo conte√∫do com IA (passando tamanho, modo e formato)
        const novoHtml = await regenerarBlocoComIA(blocoTitulo, blocoConteudo, instrucoes, tamanho, modo, formato);
        
        console.log('‚úÖ Resposta da IA recebida:', novoHtml ? 'SIM' : 'N√ÉO');
        console.log('üìÑ Novo HTML (primeiros 200 chars):', novoHtml?.substring(0, 200));
        
        if (novoHtml && contentDiv) {
          // Atualizar conte√∫do do bloco
          contentDiv.innerHTML = novoHtml;
          
          console.log('‚úÖ Conte√∫do do bloco atualizado!');
          
          // Atualizar an√°lise salva no Firebase
          await atualizarAnaliseSalvaAposEdicaoBloco();
          
          if (typeof mgToast === 'function') {
            mgToast('‚úÖ Se√ß√£o atualizada com sucesso!');
          }
        } else {
          console.error('‚ùå novoHtml vazio ou contentDiv n√£o existe');
          if (typeof mgToast === 'function') {
            mgToast('‚ùå Erro: IA n√£o retornou conte√∫do.');
          }
        }
      } catch (error) {
        console.error('‚ùå Erro ao regenerar bloco:', error);
        if (typeof mgToast === 'function') {
          mgToast('‚ùå Erro ao regenerar se√ß√£o. Tente novamente.');
        }
      } finally {
        // Restaurar estados
        if (regenBtn) {
          regenBtn.classList.remove('loading');
          regenBtn.innerHTML = '‚ú® IA+';
        }
        if (contentDiv) {
          contentDiv.classList.remove('loading');
        }
        if (btnsContainer) {
          btnsContainer.style.opacity = '';
        }
      }
    }
    
    /**
     * Regenera um bloco espec√≠fico usando a IA
     */
    async function regenerarBlocoComIA(titulo, conteudoAtual, instrucoes, tamanho = 'medio', modo = 'refazer', formato = 'auto') {
      console.log('ü§ñ regenerarBlocoComIA iniciado');
      console.log('üìå Titulo:', titulo);
      console.log('üìù Instru√ß√µes:', instrucoes);
      console.log('üìè Tamanho:', tamanho);
      console.log('üîÑ Modo:', modo);
      console.log('üìä Formato:', formato);
      
      // üîí Verificar se o proxy de IA est√° dispon√≠vel (API key agora est√° no backend)
      if (typeof window.callAIProxy !== 'function') {
        console.warn('‚ùå Proxy de IA n√£o dispon√≠vel');
        alert('Servi√ßo de IA n√£o dispon√≠vel. Recarregue a p√°gina.');
        return null;
      }
      
      // Configura√ß√µes de tamanho
      const configTamanho = {
        pequeno: { 
          tokens: 1500, 
          instrucao: 'Seja CONCISO e DIRETO. Texto curto e resumido, apenas o essencial. M√°ximo 3-4 par√°grafos.',
          desc: 'curto e resumido'
        },
        medio: { 
          tokens: 4000, 
          instrucao: 'Texto balanceado com bom n√≠vel de detalhe. Entre 5-8 par√°grafos com informa√ß√µes relevantes.',
          desc: 'm√©dio e balanceado'
        },
        grande: { 
          tokens: 12000, 
          instrucao: 'Seja EXTENSO e DETALHADO. Texto longo e completo com muitos detalhes, exemplos, explica√ß√µes aprofundadas. M√≠nimo 10 par√°grafos. Inclua subt√≥picos, listas detalhadas e an√°lises profundas.',
          desc: 'extenso e detalhado'
        }
      };
      
      const config = configTamanho[tamanho] || configTamanho.medio;
      
      // Extrair texto limpo do conte√∫do atual
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = conteudoAtual;
      const textoAtual = tempDiv.innerText;
      
      // Detectar se o conte√∫do atual cont√©m tabela/planilha
      const temTabela = conteudoAtual.includes('<table') || conteudoAtual.includes('<th') || conteudoAtual.includes('|---|');
      const tabelaOriginal = temTabela ? conteudoAtual : '';
      
      console.log('üìÑ Texto atual (primeiros 300 chars):', textoAtual.substring(0, 300));
      console.log('üìä Conte√∫do tem tabela:', temTabela);
      
      // Determinar formato final baseado na sele√ß√£o
      let formatoFinal = formato;
      if (formato === 'auto' && temTabela) {
        formatoFinal = 'planilha'; // Auto detecta e mant√©m planilha
      } else if (formato === 'auto') {
        formatoFinal = 'texto'; // Auto sem tabela = texto
      }
      
      console.log('üìä Formato final determinado:', formatoFinal);
      
      // Instru√ß√µes de formato
      const formatoInstrucao = formatoFinal === 'planilha' 
        ? `## üìä FORMATO: PLANILHA/TABELA
VOC√ä DEVE OBRIGATORIAMENTE gerar uma TABELA em formato Markdown!

Formato de tabela Markdown:
| Coluna 1 | Coluna 2 | Coluna 3 |
|---|---|---|
| dado 1 | dado 2 | dado 3 |
| dado 4 | dado 5 | dado 6 |

${temTabela ? `‚ö†Ô∏è O CONTE√öDO ORIGINAL J√Å CONT√âM UMA TABELA - MANTENHA O MESMO FORMATO DE TABELA!
TABELA ORIGINAL PARA REFER√äNCIA:
${conteudoAtual}` : ''}

REGRAS PARA TABELA:
- Crie uma tabela organizada e bem estruturada
- Use separadores |---|---|---| ap√≥s o cabe√ßalho
- Cada linha deve ter o mesmo n√∫mero de colunas
- Inclua dados relevantes e organizados
- Se houver tabela original, mantenha as mesmas colunas e adicione/atualize dados`
        : `## üìù FORMATO: TEXTO
Gere conte√∫do em formato de texto normal com par√°grafos, listas e formata√ß√£o Markdown.
- Use **negrito** para destaque
- Use listas com - para itens
- Organize em par√°grafos claros`;

      // Obter contexto COMPLETO do neg√≥cio
      const businessInfo = typeof getBusinessInfoForAI === 'function' ? getBusinessInfoForAI() : '';
      
      // Obter TODAS as notas preenchidas nas semanas de estrutura√ß√£o
      const allNotesContext = typeof getAllFilledNotesContext === 'function' ? getAllFilledNotesContext() : '';
      const instrucaoNaoInventar = INSTRUCAO_NAO_INVENTAR || "";
      
      // Definir instru√ß√µes de modo
      const modoInstrucao = modo === 'adicionar' 
        ? `## ‚ö†Ô∏è MODO: ADICIONAR (N√ÉO REFAZER!)
IMPORTANTE: Voc√™ deve MANTER TODO O TEXTO ORIGINAL e apenas ADICIONAR mais conte√∫do ap√≥s ele.
- N√ÉO reescreva o texto existente
- N√ÉO remova nada do texto original
- Apenas ADICIONE novos par√°grafos, detalhes, exemplos ou informa√ß√µes AP√ìS o texto existente
- O texto original deve aparecer INTEIRO no in√≠cio da resposta`
        : `## ‚ö†Ô∏è MODO: REFAZER
Reescreva toda a se√ß√£o do zero, melhorando o conte√∫do.`;

      // Construir prompt FOCADO nas instru√ß√µes do usu√°rio
      const prompt = `# TAREFA: ${modo === 'adicionar' ? 'ADICIONAR CONTE√öDO' : 'REESCREVER SE√á√ÉO'} (Tamanho: ${config.desc.toUpperCase()})

${modoInstrucao}

${formatoInstrucao}

## üìè TAMANHO DO TEXTO SOLICITADO: ${config.desc.toUpperCase()}
${config.instrucao}

${instrucoes ? `## üéØ O QUE O USU√ÅRIO QUER (FA√áA EXATAMENTE ISSO):
"${instrucoes}"

VOC√ä DEVE APLICAR ESSAS INSTRU√á√ïES!
` : ''}

---

## SE√á√ÉO ATUAL:

**T√≠tulo da Se√ß√£o:** ${titulo}

**Conte√∫do Atual:**
${formatoFinal === 'planilha' && temTabela ? conteudoAtual : textoAtual}

---

${businessInfo ? `## CONTEXTO DO NEG√ìCIO (use essas informa√ß√µes):
${businessInfo}
` : ''}

${allNotesContext ? `## NOTAS DO PROJETO (informa√ß√µes reais coletadas):
${allNotesContext}
` : ''}

---

## INSTRU√á√ïES:

${modo === 'adicionar' ? `
1. MANTENHA TODO O TEXTO ORIGINAL (copie ele inteiro no in√≠cio)
2. ADICIONE novos par√°grafos, detalhes ou exemplos AP√ìS o texto original
3. ${instrucoes ? `Foque em adicionar: "${instrucoes}"` : 'Adicione mais detalhes relevantes'}
4. Use dados REAIS do contexto e notas - n√£o invente
5. Mantenha formata√ß√£o Markdown
` : `
1. TAMANHO: Escreva um texto ${config.desc}. ${config.instrucao}
2. ${instrucoes ? `PRIORIDADE: Aplique o que o usu√°rio pediu: "${instrucoes}"` : 'Melhore a clareza e profundidade da an√°lise'}
3. COMECE com o t√≠tulo da se√ß√£o (ex: ## ${titulo})
4. Use dados REAIS do contexto e notas - n√£o invente
5. Mantenha formata√ß√£o Markdown (## para t√≠tulos, **negrito**, - listas)
`}

üö® **INSTRU√á√ÉO CR√çTICA DE COMPLETUDE:**
Voc√™ tem EXATAMENTE ${config.tokens} tokens para esta se√ß√£o.
- **NUNCA** termine no meio de uma frase
- **SEMPRE** conclua o conte√∫do de forma profissional
- Se perceber que est√° chegando ao limite, **REDUZA proporcionalmente** mas **COMPLETE a se√ß√£o**
- √â MELHOR uma se√ß√£o completa e concisa do que uma se√ß√£o incompleta e detalhada
- A √∫ltima frase DEVE ser uma conclus√£o, NUNCA cortada

${modo === 'adicionar' ? 'COPIE O TEXTO ORIGINAL E ADICIONE MAIS CONTE√öDO:' : 'REESCREVA A SE√á√ÉO AGORA:'}`;

      console.log('üì§ Enviando para API com max_tokens:', config.tokens);
      
      try {
        // üîí Usando proxy seguro (API key no backend)
        const systemContentRegen = modo === 'adicionar' 
          ? `Voc√™ √© um consultor de marketing digital. MODO ADICIONAR: Mantenha TODO o texto original e ADICIONE mais conte√∫do ap√≥s ele. N√ÉO reescreva, apenas adicione. TAMANHO: ${config.desc.toUpperCase()}. ${formatoFinal === 'planilha' ? 'FORMATO: GERE UMA TABELA MARKDOWN! Use |---|---|---| para separadores.' : ''} ${instrucoes ? `ADICIONE conte√∫do sobre: "${instrucoes}"` : ''} Use formata√ß√£o Markdown. ‚ö†Ô∏è CR√çTICO: Complete TODA a se√ß√£o dentro dos ${config.tokens} tokens - ajuste o detalhe mas NUNCA deixe incompleto.`
          : `Voc√™ √© um consultor de marketing digital. MODO REFAZER: Reescreva toda a se√ß√£o. TAMANHO: ${config.desc.toUpperCase()}. ${config.instrucao} ${formatoFinal === 'planilha' ? 'FORMATO OBRIGAT√ìRIO: GERE UMA TABELA MARKDOWN! Use | coluna1 | coluna2 | e |---|---|---| para separadores. N√ÉO GERE TEXTO, GERE TABELA!' : ''} ${instrucoes ? `O USU√ÅRIO PEDIU: "${instrucoes}" - VOC√ä DEVE FAZER ISSO!` : ''} Use formata√ß√£o Markdown. Comece sempre com o t√≠tulo da se√ß√£o. ‚ö†Ô∏è CR√çTICO: Complete TODA a se√ß√£o dentro dos ${config.tokens} tokens - ajuste o detalhe mas NUNCA deixe incompleto ou cortado no meio.`;
        
        const messagesRegen = [
          { role: 'system', content: systemContentRegen },
          { role: 'user', content: prompt }
        ];
        
        const result = await window.callAIProxy(window.IA_CONFIG.model, messagesRegen, auth.currentUser?.uid, config.tokens, window.IA_CONFIG.temperature.default);

        console.log('üì• Response recebido');
        
        if (result && result.choices) {
          let novoTexto = result.choices?.[0]?.message?.content || '';
          
          console.log('‚úÖ Texto recebido da IA (primeiros 500 chars):', novoTexto.substring(0, 500));
          
          if (!novoTexto || novoTexto.trim().length < 50) {
            console.error('‚ùå Resposta da IA muito curta ou vazia');
            return null;
          }
          
          // Renderizar markdown
          if (typeof renderMarkdownText === 'function') {
            const htmlRenderizado = renderMarkdownText(novoTexto);
            console.log('‚úÖ HTML renderizado (primeiros 300 chars):', htmlRenderizado.substring(0, 300));
            return htmlRenderizado;
          } else {
            return novoTexto.replace(/\n/g, '<br>');
          }
        } else {
          console.error('‚ùå Erro na API:', result?.error);
          alert(`Erro na API: ${result?.error || 'Resposta inv√°lida'}`);
          return null;
        }
      } catch (error) {
        console.error('‚ùå Erro ao chamar API:', error);
        alert(`Erro ao chamar API: ${error.message}`);
        return null;
      }
    }
    
    /**
     * Atualiza a an√°lise salva no Firebase ap√≥s edi√ß√£o de bloco
     */
    async function atualizarAnaliseSalvaAposEdicaoBloco() {
      const insightContent = document.getElementById('analiseInsightContent');
      if (!insightContent || !currentEntregavelId) return;
      
      // Coletar HTML atualizado (sem os bot√µes de regenerar para salvar)
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = insightContent.innerHTML;
      
      // Remover bot√µes de regenerar do HTML salvo
      tempDiv.querySelectorAll('.analise-bloco-regen-btn').forEach(btn => btn.remove());
      
      // Desenrolar wrappers (manter apenas o conte√∫do)
      tempDiv.querySelectorAll('.analise-bloco-wrapper').forEach(wrapper => {
        const content = wrapper.querySelector('.analise-bloco-content');
        if (content) {
          wrapper.replaceWith(...content.childNodes);
        }
      });
      
      const htmlLimpo = tempDiv.innerHTML;
      
      // Atualizar no Firebase
      try {
        const analiseData = {
          insightHtml: htmlLimpo,
          updatedAt: new Date().toISOString()
        };
        
        await salvarAnaliseFirebase(currentEntregavelId, analiseData);
        console.log('‚úÖ An√°lise atualizada no Firebase ap√≥s edi√ß√£o de bloco');
      } catch (error) {
        console.error('Erro ao salvar an√°lise atualizada:', error);
      }
    }
    
    // Exportar fun√ß√µes globais
    window.abrirModalBlocoRegen = abrirModalBlocoRegen;
    window.fecharModalBlocoRegen = fecharModalBlocoRegen;
    window.executarRegeneracaoBloco = executarRegeneracaoBloco;
    
    /**
     * Limpa o HTML para exporta√ß√£o PDF - remove bot√µes e wrappers de regenerar
     */
    function limparHtmlParaPDF(htmlOriginal) {
      if (!htmlOriginal) return '';
      
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = htmlOriginal;
      
      // Remover bot√µes de regenerar e excluir
      tempDiv.querySelectorAll('.analise-bloco-regen-btn, .analise-bloco-delete-btn, .analise-bloco-btns').forEach(btn => btn.remove());
      
      // Desenrolar wrappers (manter apenas o conte√∫do)
      tempDiv.querySelectorAll('.analise-bloco-wrapper').forEach(wrapper => {
        const content = wrapper.querySelector('.analise-bloco-content');
        if (content) {
          // Mover conte√∫do para fora do wrapper
          while (content.firstChild) {
            wrapper.parentNode.insertBefore(content.firstChild, wrapper);
          }
          wrapper.remove();
        }
      });
      
      // Remover classes de loading
      tempDiv.querySelectorAll('.loading').forEach(el => el.classList.remove('loading'));
      
      return tempDiv.innerHTML;
    }
    
    // Exportar para uso global
    window.limparHtmlParaPDF = limparHtmlParaPDF;

    // Fallback de insights sem IA
    function generateFallbackInsights(data, insightContent) {
      // Verificar se insightContent existe
      if (!insightContent) {
        console.error('generateFallbackInsights: insightContent n√£o encontrado');
        return;
      }
      
      const progressPct = data.totalItems > 0 ? Math.round((data.completedItems / data.totalItems) * 100) : 0;
      
      let status = 'inicial';
      if (progressPct >= 80) status = 'avan√ßado';
      else if (progressPct >= 50) status = 'intermedi√°rio';
      else if (progressPct >= 25) status = 'em progresso';
      
      const strengths = [];
      const improvements = [];
      
      if (data.dimensions.completude >= 50) strengths.push('Bom ritmo de conclus√£o de tarefas');
      else improvements.push('Acelerar o ritmo de conclus√£o de tarefas');
      
      if (data.dimensions.documentacao >= 50) strengths.push('Boa documenta√ß√£o com anota√ß√µes');
      else improvements.push('Adicionar mais anota√ß√µes para documentar o processo');
      
      if (data.dimensions.organizacao >= 50) strengths.push('Progresso distribu√≠do entre as semanas');
      else improvements.push('Equilibrar o progresso entre todas as semanas');
      
      if (data.files.length >= 3) strengths.push('Bom uso de arquivos de refer√™ncia');
      else improvements.push('Anexar mais arquivos de suporte');

      // Mostrar resumo das anota√ß√µes
      const notasResumo = data.notes.slice(0, 5).map(n => 
        `<li><strong>${n.week} - ${n.block}:</strong> ${n.content.substring(0, 150)}${n.content.length > 150 ? '...' : ''}</li>`
      ).join('');

      insightContent.innerHTML = `
        <h3>üìã Resumo Executivo</h3>
        <p>O entreg√°vel est√° em est√°gio <strong>${status}</strong> com ${progressPct}% de progresso. 
        ${progressPct < 50 ? '√â recomendado intensificar os esfor√ßos para alcan√ßar as metas.' : 'Continue mantendo o ritmo para concluir dentro do prazo.'}</p>
        
        ${data.notes.length > 0 ? `
        <h3>üìù Anota√ß√µes Registradas (${data.notes.length})</h3>
        <ul style="font-size:.85rem;line-height:1.6;margin-bottom:24px;">
          ${notasResumo}
        </ul>
        ` : ''}
        
        <h3>‚úÖ Pontos Fortes</h3>
        <ul>
          ${strengths.length > 0 ? strengths.map(s => `<li>${s}</li>`).join('') : '<li>Continue trabalhando para desenvolver pontos fortes</li>'}
        </ul>
        
        <h3>‚ö†Ô∏è √Åreas de Melhoria</h3>
        <ul>
          ${improvements.length > 0 ? improvements.map(i => `<li>${i}</li>`).join('') : '<li>Nenhuma √°rea cr√≠tica identificada no momento</li>'}
        </ul>
        
        <h3>üéØ Pr√≥ximos Passos</h3>
        <ul>
          <li>Revisar as tarefas pendentes nas semanas com menor progresso</li>
          <li>Documentar decis√µes importantes nas anota√ß√µes</li>
          <li>Agendar revis√£o semanal do progresso</li>
        </ul>
        
        ${data.notes.length === 0 ? `
        <div style="margin-top:24px;padding:16px;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:8px;">
          <strong style="color:#ef4444;">üí° Dica:</strong> Adicione mais anota√ß√µes nas semanas de estrutura√ß√£o para obter insights mais detalhados da IA!
        </div>
        ` : ''}
      `;
    }

    // ==================== FIREBASE - SALVAR/CARREGAR AN√ÅLISES (SUBCOLE√á√ÉO) ====================
    
    // Flag para indicar se an√°lises usam subcole√ß√£o
    let analisesUsesSubcollection = false;
    
    // Salvar an√°lise no Firebase (usando subcole√ß√£o para evitar limite de 1MB)
    async function salvarAnaliseFirebase(entregavelId, analiseData) {
      try {
        // Determinar o UID correto: se admin est√° visualizando cliente, usar UID do cliente
        // Se √© cliente direto, usar auth.currentUser.uid
        let targetUid;
        
        if (Array.isArray(clientDocPathParts) && clientDocPathParts.length >= 2) {
          // Admin visualizando cliente: usar UID do clientDocPathParts
          targetUid = clientDocPathParts[1]; // ['usuarios', 'uid-do-cliente', ...]
          console.log('üíº Admin salvando para cliente:', targetUid);
        } else {
          // Cliente direto: usar UID do auth
          targetUid = auth.currentUser?.uid;
          console.log('üë§ Cliente salvando para si mesmo:', targetUid);
        }
        
        if (!targetUid) {
          console.warn('Usu√°rio n√£o autenticado para salvar an√°lise');
          return false;
        }
        
        // Preparar dados para salvar
        const dataToSave = {
          entregavelId: entregavelId,
          insightHtml: analiseData.insightHtml || '',
          metrics: analiseData.metrics || {},
          chartData: analiseData.chartData || {},
          generatedAt: new Date().toISOString(),
          notesCount: analiseData.notesCount || 0,
          progressPct: analiseData.progressPct || 0,
          lastSavedAt: new Date().toISOString() // Timestamp para for√ßar atualiza√ß√£o
        };
        
        // Se for direcionamento_metas e houver m√©tricas do primeiro m√™s, salvar
        if (entregavelId === 'direcionamento_metas' && window.metricasPrimeiroMes) {
          dataToSave.metricasPrimeiroMes = window.metricasPrimeiroMes;
          console.log('üí∞ M√©tricas do primeiro m√™s salvas:', window.metricasPrimeiroMes);
        }
        
        // Se houver informa√ß√µes de landing pages, salvar
        if (window.landingPagesInfo) {
          dataToSave.landingPagesInfo = window.landingPagesInfo;
          console.log('üéØ Informa√ß√µes de landing pages salvas:', window.landingPagesInfo);
        }
        
        // IMPORTANTE: Salvar snapshot do contexto do neg√≥cio junto com a an√°lise
        // Isso permitir√° detectar se os dados mudaram e precisam regera√ß√£o
        if (ESTRUTURACAO_STATE.businessInfo) {
          dataToSave.businessInfoSnapshot = {
            ticket: ESTRUTURACAO_STATE.businessInfo.ticket,
            budget: ESTRUTURACAO_STATE.businessInfo.budget,
            agencyFee: ESTRUTURACAO_STATE.businessInfo.agencyFee,
            country: ESTRUTURACAO_STATE.businessInfo.country,
            niche: ESTRUTURACAO_STATE.businessInfo.niche,
            updatedAt: ESTRUTURACAO_STATE.businessInfo.updatedAt
          };
          console.log('üì∏ Snapshot do contexto do neg√≥cio salvo:', dataToSave.businessInfoSnapshot);
        }
        
        console.log('üíæ Salvando an√°lise em subcole√ß√£o:', {
          entregavelId,
          targetUid,
          tamanhoHtml: (dataToSave.insightHtml || '').length,
          timestamp: dataToSave.lastSavedAt
        });
        
        // Salvar na SUBCOLE√á√ÉO "analises" em vez do documento principal
        const analiseRef = doc(db, 'usuarios', targetUid, 'analises', entregavelId);
        await setDoc(analiseRef, dataToSave, { merge: false }); // merge: false para substituir completamente
        
        // Marcar que este usu√°rio usa subcole√ß√£o para an√°lises
        await setDoc(doc(db, 'usuarios', targetUid), { 
          analisesUsesSubcollection: true 
        }, { merge: true });
        
        // FOR√áAR ATUALIZA√á√ÉO DO CACHE LOCAL - limpar cache antigo primeiro
        const currentUserData = USER_DATA || window.USER_DATA || {};
        if (!currentUserData.analises) currentUserData.analises = {};
        
        // Substituir completamente a an√°lise no cache
        currentUserData.analises[entregavelId] = dataToSave;
        currentUserData.analisesUsesSubcollection = true;
        
        // Atualizar todas as refer√™ncias globais
        if (USER_DATA) {
          if (!USER_DATA.analises) USER_DATA.analises = {};
          USER_DATA.analises[entregavelId] = dataToSave;
          USER_DATA.analisesUsesSubcollection = true;
          window.USER_DATA = USER_DATA;
        }
        if (window.USER_DATA) {
          if (!window.USER_DATA.analises) window.USER_DATA.analises = {};
          window.USER_DATA.analises[entregavelId] = dataToSave;
          window.USER_DATA.analisesUsesSubcollection = true;
        }
        
        analisesUsesSubcollection = true;
        
        console.log(`‚úÖ An√°lise "${entregavelId}" salva na subcole√ß√£o Firebase e cache atualizado`);
        
        // Verificar se salvou corretamente lendo de volta
        const verificacao = await getDoc(analiseRef);
        if (verificacao.exists()) {
          const dados = verificacao.data();
          console.log(`‚úÖ VERIFICADO: An√°lise salva no Firebase com ${dados.insightHtml?.length || 0} caracteres`);
        }
        
        return true;
      } catch (error) {
        console.error('Erro ao salvar an√°lise no Firebase:', error);
        return false;
      }
    }
    
    // Carregar an√°lise do Firebase (da subcole√ß√£o)
    async function carregarAnaliseFirebase(entregavelId, forceRefresh = false) {
      try {
        // Usar USER_DATA ou window.USER_DATA (garantir sincroniza√ß√£o)
        const userData = USER_DATA || window.USER_DATA || {};
        
        console.log('üìÇ Tentando carregar an√°lise:', {
          entregavelId,
          forceRefresh,
          temUserData: !!userData,
          temAnalises: !!userData?.analises,
          tipoAnalises: typeof userData?.analises,
          analisesKeys: userData?.analises ? Object.keys(userData.analises) : [],
          usesSubcollection: userData?.analisesUsesSubcollection || analisesUsesSubcollection
        });
        
        // Se forceRefresh=true, pular cache e buscar direto do Firebase
        if (!forceRefresh) {
          // Primeiro verificar no cache local (USER_DATA.analises)
          const analises = userData?.analises || {};
          const analiseLocal = analises[entregavelId];
          
          if (analiseLocal && analiseLocal.insightHtml) {
            console.log(`‚úÖ An√°lise "${entregavelId}" carregada do cache local (gerada em: ${analiseLocal.generatedAt})`);
            return analiseLocal;
          }
        } else {
          console.log('üîÑ ForceRefresh ativado - pulando cache e buscando do Firebase');
        }
        
        // Se n√£o encontrou no cache (ou forceRefresh) e usu√°rio usa subcole√ß√£o, buscar da subcole√ß√£o
        if (userData?.analisesUsesSubcollection || analisesUsesSubcollection) {
          // Determinar UID
          let targetUid;
          if (Array.isArray(clientDocPathParts) && clientDocPathParts.length >= 2) {
            targetUid = clientDocPathParts[1];
          } else {
            targetUid = auth.currentUser?.uid;
          }
          
          if (targetUid) {
            console.log(`üîç Buscando an√°lise "${entregavelId}" da subcole√ß√£o para UID: ${targetUid}`);
            const analiseRef = doc(db, 'usuarios', targetUid, 'analises', entregavelId);
            const analiseSnap = await getDoc(analiseRef);
            
            if (analiseSnap.exists()) {
              const analiseData = analiseSnap.data();
              
              // Salvar no cache local para pr√≥xima vez
              if (!userData.analises) userData.analises = {};
              userData.analises[entregavelId] = analiseData;
              
              if (USER_DATA) {
                if (!USER_DATA.analises) USER_DATA.analises = {};
                USER_DATA.analises[entregavelId] = analiseData;
              }
              if (window.USER_DATA) {
                if (!window.USER_DATA.analises) window.USER_DATA.analises = {};
                window.USER_DATA.analises[entregavelId] = analiseData;
              }
              
              console.log(`‚úÖ An√°lise "${entregavelId}" carregada da subcole√ß√£o Firebase (gerada em: ${analiseData.generatedAt})`);
              return analiseData;
            }
          }
        }
        
        console.log(`‚ùå An√°lise "${entregavelId}" n√£o encontrada`);
        return null;
      } catch (error) {
        console.error('Erro ao carregar an√°lise do Firebase:', error);
        return null;
      }
    }
    
    // Carregar TODAS as an√°lises da subcole√ß√£o (para pr√©-carregar no login)
    async function carregarTodasAnalisesFirebase(targetUid) {
      try {
        if (!targetUid) {
          console.warn('UID n√£o fornecido para carregar an√°lises');
          return {};
        }
        
        console.log(`üì• Carregando todas as an√°lises da subcole√ß√£o para: ${targetUid}`);
        
        const analisesRef = collection(db, 'usuarios', targetUid, 'analises');
        const snapshot = await getDocs(analisesRef);
        
        if (snapshot.empty) {
          console.log('üì≠ Nenhuma an√°lise encontrada na subcole√ß√£o');
          return {};
        }
        
        const analises = {};
        snapshot.forEach(docSnap => {
          analises[docSnap.id] = docSnap.data();
        });
        
        console.log(`‚úÖ Carregadas ${Object.keys(analises).length} an√°lises da subcole√ß√£o:`, Object.keys(analises));
        
        // Atualizar cache local
        const userData = USER_DATA || window.USER_DATA || {};
        userData.analises = analises;
        userData.analisesUsesSubcollection = true;
        
        if (USER_DATA) {
          USER_DATA.analises = analises;
          USER_DATA.analisesUsesSubcollection = true;
        }
        if (window.USER_DATA) {
          window.USER_DATA.analises = analises;
          window.USER_DATA.analisesUsesSubcollection = true;
        }
        
        analisesUsesSubcollection = true;
        
        return analises;
      } catch (error) {
        console.error('Erro ao carregar todas as an√°lises:', error);
        return {};
      }
    }
    
    // FUN√á√ÉO DE DIAGN√ìSTICO E RECUPERA√á√ÉO DE AN√ÅLISES
    // Execute no console: diagnosticarAnalises()
    window.diagnosticarAnalises = async function() {
      console.log('üîç DIAGN√ìSTICO DE AN√ÅLISES');
      console.log('========================');
      
      const user = auth.currentUser;
      if (!user) {
        console.error('‚ùå Usu√°rio n√£o autenticado');
        return;
      }
      
      console.log('üë§ Usu√°rio:', user.email, '(UID:', user.uid, ')');
      
      // Verificar cache local
      const cacheLocal = window.USER_DATA?.analises || {};
      console.log('\nüì¶ CACHE LOCAL:');
      console.log('An√°lises no cache:', Object.keys(cacheLocal).length);
      for (const [key, value] of Object.entries(cacheLocal)) {
        console.log(`  - ${key}: ${value.insightHtml?.length || 0} chars, gerado em ${value.generatedAt || value.lastSavedAt || 'desconhecido'}`);
      }
      
      // Buscar do Firebase
      console.log('\n‚òÅÔ∏è FIREBASE (Subcole√ß√£o):');
      try {
        const analisesRef = collection(db, 'usuarios', user.uid, 'analises');
        const snapshot = await getDocs(analisesRef);
        
        if (snapshot.empty) {
          console.warn('‚ö†Ô∏è Nenhuma an√°lise encontrada na subcole√ß√£o Firebase');
        } else {
          console.log('An√°lises no Firebase:', snapshot.size);
          snapshot.forEach(doc => {
            const data = doc.data();
            console.log(`  - ${doc.id}: ${data.insightHtml?.length || 0} chars, salvo em ${data.lastSavedAt || data.generatedAt || 'desconhecido'}`);
          });
        }
      } catch (error) {
        console.error('‚ùå Erro ao buscar do Firebase:', error);
      }
      
      console.log('\n‚úÖ Diagn√≥stico completo');
    };
    
    // FUN√á√ÉO DE RECUPERA√á√ÉO FOR√áADA
    // Execute no console: recuperarAnalisesDoFirebase()
    window.recuperarAnalisesDoFirebase = async function() {
      console.log('üîÑ RECUPERANDO AN√ÅLISES DO FIREBASE...');
      
      const user = auth.currentUser;
      if (!user) {
        console.error('‚ùå Usu√°rio n√£o autenticado');
        return;
      }
      
      try {
        // Limpar cache local primeiro
        if (window.USER_DATA) {
          window.USER_DATA.analises = {};
        }
        if (USER_DATA) {
          USER_DATA.analises = {};
        }
        console.log('üóëÔ∏è Cache local limpo');
        
        // Buscar todas as an√°lises do Firebase
        const analises = await carregarTodasAnalisesFirebase(user.uid);
        console.log(`‚úÖ ${Object.keys(analises).length} an√°lises recuperadas do Firebase`);
        
        // Exibir detalhes
        for (const [key, value] of Object.entries(analises)) {
          console.log(`  ‚úì ${key}: ${value.insightHtml?.length || 0} chars, gerado em ${value.lastSavedAt || value.generatedAt || 'N/A'}`);
        }
        
        console.log('\n‚úÖ Recupera√ß√£o conclu√≠da!');
        console.log('üí° PR√ìXIMO PASSO: Abra qualquer an√°lise para ver a vers√£o atualizada.');
        return analises;
      } catch (error) {
        console.error('‚ùå Erro na recupera√ß√£o:', error);
        throw error;
      }
    };
    
    // üöÄ FUN√á√ÉO DE LIMPEZA TOTAL E REFRESH
    // Execute no console: limparCacheEAtualizar()
    window.limparCacheEAtualizar = async function() {
      console.log('üßπ LIMPANDO CACHE COMPLETO E ATUALIZANDO...');
      
      const user = auth.currentUser;
      if (!user) {
        console.error('‚ùå Usu√°rio n√£o autenticado');
        return;
      }
      
      try {
        // 1. Limpar TUDO do cache
        console.log('üóëÔ∏è Passo 1/3: Limpando cache...');
        if (window.USER_DATA) {
          window.USER_DATA.analises = {};
        }
        if (USER_DATA) {
          USER_DATA.analises = {};
        }
        
        // 2. Buscar tudo do Firebase
        console.log('‚òÅÔ∏è Passo 2/3: Buscando do Firebase...');
        const analisesRef = collection(db, 'usuarios', user.uid, 'analises');
        const snapshot = await getDocs(analisesRef);
        
        if (snapshot.empty) {
          console.warn('‚ö†Ô∏è Nenhuma an√°lise encontrada no Firebase');
          return {};
        }
        
        const analises = {};
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          analises[docSnap.id] = data;
          console.log(`  ‚úì ${docSnap.id}: ${data.insightHtml?.length || 0} chars, ${data.lastSavedAt || data.generatedAt || 'N/A'}`);
        });
        
        // 3. Atualizar cache
        console.log('üíæ Passo 3/3: Atualizando cache...');
        if (window.USER_DATA) {
          window.USER_DATA.analises = analises;
        }
        if (USER_DATA) {
          USER_DATA.analises = analises;
        }
        
        console.log(`\nüéâ SUCESSO! ${Object.keys(analises).length} an√°lises atualizadas do Firebase`);
        console.log('‚úÖ Cache sincronizado com Firebase');
        console.log('üí° Agora voc√™ pode abrir qualquer an√°lise - ela vir√° direto do Firebase atualizado!');
        
        return analises;
      } catch (error) {
        console.error('‚ùå Erro:', error);
        throw error;
      }
    };
    
    console.log('üõ†Ô∏è Fun√ß√µes de diagn√≥stico carregadas:');
    console.log('  - diagnosticarAnalises() - Ver status das an√°lises');
    console.log('  - diagnosticarMetas() - Ver estado das metas e estrutura');
    console.log('  - diagnosticarConversasIA() - Ver estado das conversas I.A.');
    console.log('  - recuperarAnalisesDoFirebase() - For√ßar recupera√ß√£o do Firebase');
    console.log('  - limparConversasIA() - Limpar conversas travadas da I.A.');
    console.log('  - reduzirDocumentoUsuario() - Reduzir tamanho do documento (EMERG√äNCIA)');
    
    /**
     * ‚ö†Ô∏è FUN√á√ÉO DE DIAGN√ìSTICO: Limpar conversas da I.A. com mensagens travadas em loading
     */
    window.limparConversasIA = async function() {
      console.log('üßπ LIMPANDO CONVERSAS TRAVADAS DA I.A...');
      
      const user = auth.currentUser;
      if (!user) {
        console.error('‚ùå Usu√°rio n√£o autenticado');
        return;
      }
      
      try {
        let totalLoading = 0;
        let totalConversas = 0;
        
        if (window.USER_DATA && window.USER_DATA.iaChats) {
          totalConversas = window.USER_DATA.iaChats.length;
          
          // Contar mensagens em loading
          window.USER_DATA.iaChats.forEach((chat, idx) => {
            const loadingMsgs = (chat.messages || []).filter(msg => msg.loading);
            if (loadingMsgs.length > 0) {
              console.log(`  üîç Conversa ${idx + 1} "${chat.title}": ${loadingMsgs.length} mensagem(ns) em loading`);
              totalLoading += loadingMsgs.length;
            }
          });
          
          if (totalLoading === 0) {
            console.log('‚úÖ Nenhuma mensagem travada encontrada!');
            return;
          }
          
          console.log(`\nüóëÔ∏è Removendo ${totalLoading} mensagem(ns) travada(s)...`);
          
          // Limpar mensagens em loading
          window.USER_DATA.iaChats = window.USER_DATA.iaChats.map(chat => ({
            ...chat,
            messages: (chat.messages || []).filter(msg => !msg.loading)
          }));
          
          // Atualizar vari√°vel global
          if (typeof loadIAChatsFromUserData === 'function') {
            loadIAChatsFromUserData();
          }
          
          // Salvar no Firebase com prote√ß√£o
          console.log('üíæ Salvando no Firebase...');
          const result = await safeWriteUserDoc({ iaChats: window.USER_DATA.iaChats });
          if(!result.success) {
            console.error('‚ùå Falha ao salvar conversas limpas:', result.error);
            throw new Error(result.error);
          }
          
          // Re-renderizar
          if (typeof renderIAChatList === 'function') {
            renderIAChatList();
          }
          if (typeof renderIAHistory === 'function') {
            renderIAHistory();
          }
          
          console.log(`\nüéâ SUCESSO! ${totalLoading} mensagem(ns) removida(s)`);
          console.log(`‚úÖ ${totalConversas} conversa(s) limpas e sincronizadas`);
          console.log('üí° O hist√≥rico agora deve aparecer normalmente!');
          
        } else {
          console.warn('‚ö†Ô∏è Nenhuma conversa encontrada em USER_DATA.iaChats');
        }
        
      } catch (error) {
        console.error('‚ùå Erro ao limpar conversas:', error);
        throw error;
      }
    };
    
    /**
     * ‚ö†Ô∏è FUN√á√ÉO DE EMERG√äNCIA: Reduzir tamanho do documento quando excede 1MB
     * Use: reduzirDocumentoUsuario() no console
     */
    window.reduzirDocumentoUsuario = async function() {
      console.log('üö® REDUZINDO TAMANHO DO DOCUMENTO DO USU√ÅRIO...');
      
      const user = auth.currentUser;
      if (!user) {
        console.error('‚ùå Usu√°rio n√£o autenticado');
        return;
      }
      
      try {
        // 1. Identificar o que est√° ocupando espa√ßo
        console.log('üîç Analisando tamanhos dos campos...');
        const userDocRef = doc(db, 'usuarios', user.uid);
        const userSnap = await getDoc(userDocRef);
        
        if (!userSnap.exists()) {
          console.error('‚ùå Documento n√£o encontrado');
          return;
        }
        
        const data = userSnap.data();
        const fieldSizes = {};
        
        for (const [key, value] of Object.entries(data)) {
          try {
            const size = JSON.stringify(value).length;
            fieldSizes[key] = size;
            if (size > 10000) { // Campos > 10KB
              console.log(`   ${key}: ${Math.round(size/1024)} KB`);
            }
          } catch (e) {
            console.log(`   ${key}: [n√£o serializ√°vel]`);
          }
        }
        
        // 2. Limpar conversas da I.A. (M√ÅXIMO 3 conversas, 10 mensagens cada)
        let iaChats = data.iaChats || [];
        if (iaChats.length > 0) {
          const antes = iaChats.length;
          const tamanhoAntes = JSON.stringify(iaChats).length;
          
          iaChats = iaChats
            .sort((a, b) => (b.updatedAt || b.createdAt || 0) - (a.updatedAt || a.createdAt || 0))
            .slice(0, 3) // APENAS 3 conversas
            .map(chat => ({
              ...chat,
              messages: (chat.messages || [])
                .filter(msg => !msg.loading)
                .slice(-10) // APENAS 10 mensagens
                .map(msg => ({
                  role: msg.role,
                  content: msg.content && msg.content.length > 5000 
                    ? msg.content.slice(0, 5000) + '...' 
                    : msg.content,
                  timestamp: msg.timestamp
                }))
            }));
          
          const depois = iaChats.length;
          const tamanhoDepois = JSON.stringify(iaChats).length;
          
          console.log(`üìä Conversas I.A.: ${antes} ‚Üí ${depois} (${Math.round(tamanhoAntes/1024)}KB ‚Üí ${Math.round(tamanhoDepois/1024)}KB)`);
        }
        
        // 3. Limpar hist√≥rico de posts antigos (manter √∫ltimos 30 dias)
        let posts = data.posts || [];
        if (posts.length > 0) {
          const antes = posts.length;
          const tamanhoAntes = JSON.stringify(posts).length;
          
          const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
          posts = posts.filter(post => {
            const postDate = post.scheduledDate || post.createdAt || 0;
            return postDate > thirtyDaysAgo;
          });
          
          const depois = posts.length;
          const tamanhoDepois = JSON.stringify(posts).length;
          
          if (antes !== depois) {
            console.log(`ÔøΩ Posts: ${antes} ‚Üí ${depois} (${Math.round(tamanhoAntes/1024)}KB ‚Üí ${Math.round(tamanhoDepois/1024)}KB)`);
          }
        }
        
        // 4. Limpar hist√≥rico de leads antigos (manter √∫ltimos 90 dias)
        let leads = data.leads || [];
        if (leads.length > 0) {
          const antes = leads.length;
          const tamanhoAntes = JSON.stringify(leads).length;
          
          const ninetyDaysAgo = Date.now() - (90 * 24 * 60 * 60 * 1000);
          leads = leads.filter(lead => {
            const leadDate = lead.timestamp || lead.createdAt || 0;
            return leadDate > ninetyDaysAgo;
          });
          
          const depois = leads.length;
          const tamanhoDepois = JSON.stringify(leads).length;
          
          if (antes !== depois) {
            console.log(`üë• Leads: ${antes} ‚Üí ${depois} (${Math.round(tamanhoAntes/1024)}KB ‚Üí ${Math.round(tamanhoDepois/1024)}KB)`);
          }
        }
        
        // 5. Limpar campo notes (maior vil√£o do tamanho)
        let cleanedNotes = data.notes || '';
        if (cleanedNotes && typeof cleanedNotes === 'string') {
          const notesSize = new Blob([cleanedNotes]).size;
          const maxNotesSize = 200 * 1024; // 200 KB m√°ximo
          
          if (notesSize > maxNotesSize) {
            console.log(`üìù Notes muito grande (${Math.round(notesSize/1024)}KB) - reduzindo para 200KB`);
            // Manter apenas os √∫ltimos 200KB de caracteres (notas mais recentes geralmente est√£o no final)
            const maxChars = 200000; // aproximadamente 200KB
            cleanedNotes = '...[notas antigas removidas para economizar espa√ßo]...\n\n' + 
                          cleanedNotes.slice(-maxChars);
            console.log(`   ‚Üí Reduzido para ${Math.round(new Blob([cleanedNotes]).size/1024)}KB`);
          }
        }
        
        // 6. Limpar campos tempor√°rios/cache
        const cleanedData = {
          _lastCleanup: new Date().toISOString()
        };
        
        // Adicionar apenas campos que existem e n√£o s√£o undefined
        if (data.email) cleanedData.email = data.email;
        if (data.displayName) cleanedData.displayName = data.displayName;
        if (data.photoURL) cleanedData.photoURL = data.photoURL;
        if (data.clientKey) cleanedData.clientKey = data.clientKey;
        if (iaChats && iaChats.length > 0) cleanedData.iaChats = iaChats;
        if (posts && posts.length > 0) cleanedData.posts = posts;
        if (leads && leads.length > 0) cleanedData.leads = leads;
        if (data.metas2025) cleanedData.metas2025 = data.metas2025;
        if (data.metas2026) cleanedData.metas2026 = data.metas2026;
        if (data.analises) cleanedData.analises = data.analises;
        if (cleanedNotes) cleanedData.notes = cleanedNotes;
        if (data.observacoes) cleanedData.observacoes = data.observacoes;
        if (data.demandas) cleanedData.demandas = data.demandas;
        if (data.cacData) cleanedData.cacData = data.cacData;
        if (data.demandaMonthPlans) cleanedData.demandaMonthPlans = data.demandaMonthPlans;
        if (data.trafegoOptimizationHistory) cleanedData.trafegoOptimizationHistory = data.trafegoOptimizationHistory;
        if (data.widgets) cleanedData.widgets = data.widgets;
        if (data.calendarioPosts) cleanedData.calendarioPosts = data.calendarioPosts;
        
        // Remover campos grandes desnecess√°rios:
        // estruturacao: dados movidos para subcole√ß√£o
        // iaHistory: redundante com iaChats
        // tempData, cache, etc.
        
        // 7. Verificar tamanho final antes de salvar
        const finalDataStr = JSON.stringify(cleanedData);
        const finalSize = new Blob([finalDataStr]).size;
        console.log(`üìä Tamanho final do documento: ${Math.round(finalSize/1024)}KB / 1024KB`);
        
        if (finalSize > 1048576) {
          throw new Error(`‚ùå Documento ainda muito grande (${Math.round(finalSize/1024)}KB)! Precisamos remover mais dados.`);
        }
        
        // 8. Salvar documento reduzido
        console.log('üíæ Salvando documento limpo...');
        await setDoc(userDocRef, cleanedData);
        
        console.log('‚úÖ Documento reduzido com sucesso!');
        console.log('üí° Recarregue a p√°gina (Cmd+R) para continuar.');
        
        // Atualizar USER_DATA
        if (window.USER_DATA) {
          window.USER_DATA.iaChats = iaChats;
          window.USER_DATA.posts = posts;
          window.USER_DATA.leads = leads;
        }
        
        // Recarregar interface
        if (typeof loadIAChatsFromUserData === 'function') {
          loadIAChatsFromUserData();
        }
        if (typeof renderIAChatList === 'function') {
          renderIAChatList();
        }
        
        mgToast('‚úÖ Documento reduzido! Recarregue a p√°gina.', 'success', 5000);
        
      } catch (error) {
        console.error('‚ùå Erro ao reduzir documento:', error);
        mgToast('‚ùå Erro ao limpar documento. Veja o console.', 'error', 5000);
      }
    };
    
    /**
     * üéØ FUN√á√ÉO DE DIAGN√ìSTICO: Verificar estado das metas
     * Use: diagnosticarMetas() no console
     */
    window.diagnosticarMetas = function() {
      console.log('üéØ ========== DIAGN√ìSTICO DE METAS ==========');
      
      console.log('üìä Vari√°veis globais:');
      console.log('  METAS existe?', typeof METAS !== 'undefined');
      console.log('  METAS length:', Array.isArray(METAS) ? METAS.length : 'n√£o √© array');
      console.log('  CURRENT_METAS_YEAR:', CURRENT_METAS_YEAR);
      console.log('  META_MONTHS:', META_MONTHS);
      console.log('  META_MONTH_LABELS:', META_MONTH_LABELS);
      
      if(Array.isArray(METAS) && METAS.length > 0){
        console.log('\nüìã Lista de Metas:');
        METAS.forEach((meta, idx) => {
          console.log(`\n  Meta ${idx + 1}:`);
          console.log(`    ID: ${meta.id}`);
          console.log(`    Descri√ß√£o: ${meta.descricao || 'sem descri√ß√£o'}`);
          console.log(`    Setor: ${meta.setor || 'n√£o definido'}`);
          console.log(`    Unidade: ${meta.unidade || 'sem unidade'}`);
          console.log(`    Ativa?: ${meta.ativo !== false}`);
          console.log(`    Tem estrutura meses?`, !!meta.meses);
          
          if(meta.meses){
            const mesesComDados = Object.keys(meta.meses).filter(k => {
              const m = meta.meses[k];
              return m && (m.p || m.r);
            });
            console.log(`    Meses com dados: ${mesesComDados.length}/12`);
            console.log(`    Meses: ${mesesComDados.join(', ')}`);
            
            // Mostrar primeiros 3 meses
            const primeiros3 = META_MONTHS.slice(0, 3);
            primeiros3.forEach(mes => {
              if(meta.meses[mes]){
                console.log(`      ${mes}: P=${meta.meses[mes].p || 0}, R=${meta.meses[mes].r || 0}`);
              }
            });
          }
        });
      } else {
        console.warn('‚ö†Ô∏è Nenhuma meta encontrada ou METAS n√£o √© um array!');
      }
      
      console.log('\nüíæ USER_DATA:');
      const yearKey = `metas_${CURRENT_METAS_YEAR}`;
      console.log(`  ${yearKey} existe?`, !!USER_DATA[yearKey]);
      console.log(`  ${yearKey} length:`, Array.isArray(USER_DATA[yearKey]) ? USER_DATA[yearKey].length : 'n√£o √© array');
      
      console.log('\nüéØ Estado do Mapper:');
      console.log('  METAS_MAPPER_STATE:', METAS_MAPPER_STATE);
      
      console.log('\n‚úÖ Diagn√≥stico completo!');
      console.log('==========================================');
      
      return {
        METAS: METAS,
        CURRENT_METAS_YEAR: CURRENT_METAS_YEAR,
        yearKey: yearKey,
        USER_DATA_metas: USER_DATA[yearKey],
        METAS_MAPPER_STATE: METAS_MAPPER_STATE
      };
    };
    
    /**
     * üí¨ FUN√á√ÉO DE DIAGN√ìSTICO: Verificar estado das conversas I.A.
     * Use: diagnosticarConversasIA() no console
     */
    window.diagnosticarConversasIA = function() {
      console.log('üí¨ ========== DIAGN√ìSTICO CONVERSAS I.A. ==========');
      
      console.log('üìä Vari√°veis globais:');
      console.log('  IA_CHATS existe?', typeof IA_CHATS !== 'undefined');
      console.log('  IA_CHATS length:', Array.isArray(IA_CHATS) ? IA_CHATS.length : 'n√£o √© array');
      console.log('  CURRENT_CHAT:', CURRENT_CHAT);
      
      if(Array.isArray(IA_CHATS) && IA_CHATS.length > 0){
        console.log('\nüìã Lista de Conversas:');
        IA_CHATS.forEach((chat, idx) => {
          const msgCount = chat.messages?.length || 0;
          const userMsgs = chat.messages?.filter(m => m.role === 'user').length || 0;
          const assistantMsgs = chat.messages?.filter(m => m.role === 'assistant').length || 0;
          const loadingMsgs = chat.messages?.filter(m => m.loading === true).length || 0;
          
          console.log(`\n  Conversa ${idx + 1}:`);
          console.log(`    ID: ${chat.id}`);
          console.log(`    T√≠tulo: ${chat.title}`);
          console.log(`    Total mensagens: ${msgCount}`);
          console.log(`    User: ${userMsgs}, Assistant: ${assistantMsgs}, Loading: ${loadingMsgs}`);
          console.log(`    Criada em: ${chat.createdAt ? new Date(chat.createdAt).toLocaleString('pt-BR') : 'desconhecido'}`);
          console.log(`    Atualizada em: ${chat.updatedAt ? new Date(chat.updatedAt).toLocaleString('pt-BR') : 'desconhecido'}`);
          console.log(`    Location: ${chat.location || 'main'}`);
          
          // Calcular tamanho aproximado
          const chatStr = JSON.stringify(chat);
          const chatSize = new Blob([chatStr]).size;
          console.log(`    Tamanho: ${(chatSize / 1024).toFixed(2)} KB`);
        });
        
        // Calcular tamanho total
        const totalStr = JSON.stringify(IA_CHATS);
        const totalSize = new Blob([totalStr]).size;
        console.log(`\nüìè Tamanho total de todas as conversas: ${(totalSize / 1024).toFixed(2)} KB`);
        
        if(totalSize > 900000) {
          console.warn('‚ö†Ô∏è ATEN√á√ÉO: Conversas est√£o muito grandes! Pode causar problemas de salvamento.');
          console.warn('üí° Considere executar: await reduzirDocumentoUsuario()');
        }
        
      } else {
        console.warn('‚ö†Ô∏è Nenhuma conversa encontrada ou IA_CHATS n√£o √© um array!');
      }
      
      console.log('\nüíæ USER_DATA:');
      console.log('  iaChats existe?', !!USER_DATA?.iaChats);
      console.log('  iaChats length:', Array.isArray(USER_DATA?.iaChats) ? USER_DATA.iaChats.length : 'n√£o √© array');
      
      console.log('\n‚úÖ Diagn√≥stico completo!');
      console.log('==================================================');
      
      return {
        IA_CHATS: IA_CHATS,
        CURRENT_CHAT: CURRENT_CHAT,
        USER_DATA_iaChats: USER_DATA?.iaChats
      };
    };
    
    console.log('  - diagnosticarMetas() - Ver estado das metas e estrutura');
    console.log('  - diagnosticarConversasIA() - Ver estado das conversas I.A.');
    console.log('  - reduzirDocumentoUsuario() - Reduzir tamanho do documento (EMERG√äNCIA)');
    
    // Formatar data para exibi√ß√£o
    function formatarDataAnalise(isoString) {
      if (!isoString) return '';
      const date = new Date(isoString);
      const dia = date.getDate().toString().padStart(2, '0');
      const mes = (date.getMonth() + 1).toString().padStart(2, '0');
      const ano = date.getFullYear();
      const hora = date.getHours().toString().padStart(2, '0');
      const min = date.getMinutes().toString().padStart(2, '0');
      return `${dia}/${mes}/${ano} √†s ${hora}:${min}`;
    }
    
    // Vari√°veis para armazenar entreg√°vel e usu√°rio atual
    let currentEntregavelId = null;
    let currentUserId = null;
    
    // Expor para o escopo global (para uso nos event listeners)
    window.currentEntregavelId = null;
    window.currentUserId = null;

    // ==================== FIM FIREBASE AN√ÅLISES ====================

    // Atualizar m√©tricas
    function updateAnaliseMetrics(data) {
      const progressPct = data.totalItems > 0 ? Math.round((data.completedItems / data.totalItems) * 100) : 0;
      
      const metricProgresso = document.getElementById('metricProgresso');
      const metricConcluidas = document.getElementById('metricConcluidas');
      const metricPendentes = document.getElementById('metricPendentes');
      const metricAnotacoes = document.getElementById('metricAnotacoes');

      if (metricProgresso) {
        metricProgresso.textContent = progressPct + '%';
        metricProgresso.className = 'analise-metric-value ' + 
          (progressPct >= 70 ? 'positive' : progressPct >= 40 ? 'neutral' : 'negative');
      }
      if (metricConcluidas) {
        metricConcluidas.textContent = data.completedItems;
        metricConcluidas.className = 'analise-metric-value positive';
      }
      if (metricPendentes) {
        metricPendentes.textContent = data.pendingItems;
        metricPendentes.className = 'analise-metric-value ' + 
          (data.pendingItems === 0 ? 'positive' : data.pendingItems <= 5 ? 'neutral' : 'negative');
      }
      if (metricAnotacoes) {
        metricAnotacoes.textContent = data.notes.length;
        metricAnotacoes.className = 'analise-metric-value ' + 
          (data.notes.length >= 5 ? 'positive' : data.notes.length >= 2 ? 'neutral' : 'negative');
      }
    }

    // Entreg√°veis que precisam de informa√ß√µes extras antes de gerar (popup de landing pages)
    const entregaveisComInfoExtra = ['landing_pages', 'website'];

    // Fun√ß√£o para gerar an√°lise em background (sem abrir modal)
    async function gerarAnaliseRapida(entregavelId, btnElement) {
      const mapping = ENTREGAVEL_MAPPING[entregavelId];
      if (!mapping) {
        console.error('Entreg√°vel n√£o encontrado:', entregavelId);
        return;
      }

      // Verificar se j√° existe an√°lise gerada
      const analiseSalva = await carregarAnaliseFirebase(entregavelId, true);
      if (analiseSalva && analiseSalva.insightHtml) {
        // J√° existe - abrir direto
        mostrarSuccessPopup(`An√°lise de "${mapping.title}" j√° est√° pronta!`);
        abrirAnaliseEntregavel(entregavelId);
        return;
      }

      // Marcar bot√£o como gerando
      const originalText = btnElement.innerHTML;
      btnElement.classList.add('generating');
      btnElement.innerHTML = '‚è≥ Gerando...';
      btnElement.disabled = true;

      try {
        // Para landing_pages e website: pedir info antes
        if (entregaveisComInfoExtra.includes(entregavelId) && !window.landingPagesInfo) {
          btnElement.classList.remove('generating');
          btnElement.innerHTML = originalText;
          btnElement.disabled = false;
          abrirModalLandingInfo(entregavelId, false);
          return;
        }

        // Coletar dados
        const data = collectAnaliseData(entregavelId);
        
        // Buscar m√≠dias tagueadas
        if (data) {
          try {
            const midiasTagueadas = await buscarMidiasTagueadasPorEntregavel(entregavelId);
            data.midiasTagueadas = midiasTagueadas;
          } catch (error) {
            console.warn('Erro ao buscar m√≠dias:', error);
            data.midiasTagueadas = [];
          }
        }

        if (!data) {
          btnElement.classList.remove('generating');
          btnElement.innerHTML = originalText;
          btnElement.disabled = false;
          alert('N√£o foi poss√≠vel coletar dados para gerar a an√°lise.');
          return;
        }

        // Criar elemento tempor√°rio para receber o HTML da an√°lise
        const tempInsightContent = document.createElement('div');
        tempInsightContent.id = 'tempAnaliseInsight';
        tempInsightContent.style.display = 'none';
        document.body.appendChild(tempInsightContent);

        console.log('üéØ Iniciando gera√ß√£o de an√°lise para:', entregavelId);
        
        // Gerar an√°lise usando a mesma fun√ß√£o do modal
        await generateAnaliseInsights(data, mapping, tempInsightContent);
        
        // Aguardar um momento para garantir que o DOM foi atualizado
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Pegar o HTML gerado
        let insightHtml = tempInsightContent.innerHTML;
        
        console.log('üìè Tamanho do HTML gerado:', insightHtml.length, 'caracteres');
        console.log('üìù Primeiros 200 chars:', insightHtml.substring(0, 200));
        console.log('üìù √öltimos 200 chars:', insightHtml.substring(insightHtml.length - 200));
        
        // Remover elemento tempor√°rio
        tempInsightContent.remove();
        
        // Remover se√ß√µes de m√≠dias tagueadas do HTML antes de salvar
        insightHtml = insightHtml.replace(/<div class="midias-tagueadas-section"[^>]*>[\s\S]*?<\/div>\s*<\/div>\s*<\/div>/gi, '');
        insightHtml = insightHtml.replace(/<div[^>]*>[\s\S]*?üè∑Ô∏è M√≠dias Tagueadas:[\s\S]*?<\/div>\s*<\/div>\s*<\/div>/gi, '');
        
        // Salvar no Firebase usando a fun√ß√£o existente
        if (insightHtml) {
          const progressPct = data.totalItems > 0 ? Math.round((data.completedItems / data.totalItems) * 100) : 0;
          
          const analiseData = {
            insightHtml: insightHtml,
            metrics: {
              completedItems: data.completedItems,
              totalItems: data.totalItems,
              pendingItems: data.pendingItems
            },
            chartData: data.dimensions || {},
            notesCount: data.notes?.length || 0,
            progressPct: progressPct
          };
          
          // Salvar landingPagesInfo se for landing_pages ou website
          if (entregaveisComInfoExtra.includes(entregavelId) && window.landingPagesInfo) {
            analiseData.landingPagesInfo = window.landingPagesInfo;
          }
          
          // Usar fun√ß√£o existente que j√° cuida de clientKey e currentUserId
          const saved = await salvarAnaliseFirebase(entregavelId, analiseData);
          
          if (saved) {
            // For√ßar atualiza√ß√£o do cache
            await carregarAnaliseFirebase(entregavelId, true);
            console.log('‚úÖ An√°lise salva no Firebase:', entregavelId);
          }

          // Sucesso! Marcar bot√£o como gerado
          btnElement.classList.remove('generating');
          btnElement.classList.add('generated');
          btnElement.innerHTML = '‚úÖ Gerado';
          btnElement.disabled = false;
          
          // Mostrar popup de sucesso
          mostrarSuccessPopup(`An√°lise de "${mapping.title}" gerada com sucesso!`);
          
          // Ap√≥s 2 segundos, voltar ao normal
          setTimeout(() => {
            btnElement.classList.remove('generated');
            btnElement.innerHTML = originalText;
          }, 2000);
        } else {
          throw new Error('Falha ao gerar an√°lise');
        }
      } catch (error) {
        console.error('Erro ao gerar an√°lise r√°pida:', error);
        btnElement.classList.remove('generating');
        btnElement.innerHTML = originalText;
        btnElement.disabled = false;
        alert('Erro ao gerar an√°lise. Tente novamente.');
      }
    }

    // Expor fun√ß√£o para o escopo global (acess√≠vel nos bot√µes HTML)
    window.gerarAnaliseRapida = gerarAnaliseRapida;

    // Fun√ß√£o para mostrar popup de sucesso
    function mostrarSuccessPopup(mensagem) {
      // Remover popup anterior se existir
      const popupAntigo = document.querySelector('.analise-success-popup');
      if (popupAntigo) {
        popupAntigo.remove();
      }

      // Criar novo popup
      const popup = document.createElement('div');
      popup.className = 'analise-success-popup';
      popup.textContent = mensagem;
      document.body.appendChild(popup);

      // Remover ap√≥s anima√ß√£o
      setTimeout(() => {
        popup.remove();
      }, 3000);
    }

    // Expor fun√ß√£o para o escopo global
    window.mostrarSuccessPopup = mostrarSuccessPopup;

    // Fun√ß√£o principal de an√°lise
    async function abrirAnaliseEntregavel(entregavelId, forceRegenerate = false, skipInfoModal = false) {
      const mapping = ENTREGAVEL_MAPPING[entregavelId];
      if (!mapping) {
        alert('Entreg√°vel n√£o encontrado.');
        return;
      }
      
      // üìä DIRECIONAMENTO_METAS: pedir m√©tricas do primeiro m√™s ANTES de gerar/regenerar
      if (entregavelId === 'direcionamento_metas' && !skipInfoModal) {
        console.log('üìä Entreg√°vel direcionamento_metas detectado');
        
        // ‚ö° CRITICAL FIX: Se N√ÉO est√° regenerando, verificar se j√° existe an√°lise completa salva
        if (!forceRegenerate) {
          console.log('üìã Verificando se j√° existe an√°lise salva...');
          const analiseSalvaExistente = await carregarAnaliseFirebase(entregavelId);
          
          if (analiseSalvaExistente && analiseSalvaExistente.insightHtml) {
            console.log('‚úÖ An√°lise completa encontrada no Firebase - carregando sem pedir m√©tricas');
            
            // Recuperar m√©tricas salvas para uso futuro
            if (analiseSalvaExistente.metricasPrimeiroMes) {
              window.metricasPrimeiroMes = analiseSalvaExistente.metricasPrimeiroMes;
            }
            
            // Continuar para exibir a an√°lise salva (n√£o retornar aqui)
          } else {
            // N√£o existe an√°lise completa - precisa coletar m√©tricas
            console.log('‚ùå An√°lise completa n√£o encontrada - precisa coletar m√©tricas');
            
            // Se j√° tem m√©tricas em mem√≥ria, continuar; sen√£o abrir modal
            if (!window.metricasPrimeiroMes) {
              console.log('üìù Abrindo modal de m√©tricas para gerar nova an√°lise');
              abrirModalMetricasMes(entregavelId, forceRegenerate);
              return; // Parar aqui - aguardar usu√°rio preencher modal
            } else {
              console.log('‚úÖ M√©tricas j√° em mem√≥ria, continuando com gera√ß√£o');
            }
          }
        } else {
          // Modo regenera√ß√£o - precisa das m√©tricas
          console.log('üîÑ Modo regenera√ß√£o - verificando m√©tricas');
          
          if (window.metricasPrimeiroMes) {
            console.log('‚úÖ M√©tricas j√° em mem√≥ria, continuando com regenera√ß√£o');
          } else {
            // Tentar carregar m√©tricas salvas do Firebase
            const analiseSalvaExistente = await carregarAnaliseFirebase(entregavelId);
            
            if (analiseSalvaExistente && analiseSalvaExistente.metricasPrimeiroMes) {
              console.log('üì• M√©tricas recuperadas do Firebase:', analiseSalvaExistente.metricasPrimeiroMes);
              window.metricasPrimeiroMes = analiseSalvaExistente.metricasPrimeiroMes;
            } else {
              // N√£o tem m√©tricas - abrir modal
              console.log('üìù Abrindo modal de m√©tricas para regenera√ß√£o');
              abrirModalMetricasMes(entregavelId, forceRegenerate);
              return; // Parar aqui - aguardar usu√°rio preencher modal
            }
          }
        }
      }
      
      // Para landing_pages e website: verificar se j√° existe an√°lise salva ANTES de pedir info
      if (entregaveisComInfoExtra.includes(entregavelId) && !skipInfoModal && !window.landingPagesInfo) {
        // Verificar se existe an√°lise salva no Firebase
        const analiseSalvaExistente = !forceRegenerate ? await carregarAnaliseFirebase(entregavelId) : null;
        
        if (analiseSalvaExistente && analiseSalvaExistente.insightHtml) {
          // Existe an√°lise salva! Recuperar landingPagesInfo se houver e continuar
          console.log('üìã An√°lise salva encontrada para', entregavelId, '- carregando sem pedir info');
          if (analiseSalvaExistente.landingPagesInfo) {
            window.landingPagesInfo = analiseSalvaExistente.landingPagesInfo;
          }
          // N√ÉO retornar aqui - deixar continuar para mostrar a an√°lise
        } else {
          // N√£o existe an√°lise salva - precisa pedir informa√ß√µes
          abrirModalLandingInfo(entregavelId, forceRegenerate);
          return;
        }
      }

      
      // Salvar ID do entreg√°vel e usu√°rio atual (para edi√ß√£o)
      currentEntregavelId = entregavelId;
      window.currentEntregavelId = entregavelId;
      
      // Obter o userId do Firebase Auth (usando vari√°vel global auth)
      const user = auth.currentUser;
      if (user) {
        currentUserId = user.uid;
        window.currentUserId = user.uid;
      }

      const modal = document.getElementById('analiseModal');
      const titleText = document.getElementById('analiseTitleText');
      const loading = document.getElementById('analiseLoading');
      const content = document.getElementById('analiseContent');
      const actionsBar = document.getElementById('analiseActions');
      const statusContainer = document.getElementById('analiseStatus');
      const regenerateBtn = document.getElementById('analiseRegenerateBtn');
      const savedBadge = document.getElementById('analiseSavedBadge');
      const savedDate = document.getElementById('analiseSavedDate');

      if (!modal) return;

      // Resetar estados visuais
      if (savedBadge) savedBadge.style.display = 'none';
      if (regenerateBtn) regenerateBtn.style.display = 'none';
      
      // Resetar estado do editor de an√°lise
      const editBtn = document.getElementById('analiseEditBtn');
      const saveBtn = document.getElementById('analiseSaveBtn');
      const cancelBtn = document.getElementById('analiseCancelBtn');
      const editor = document.getElementById('analiseInsightEditor');
      const insightContent = document.getElementById('analiseInsightContent');
      
      if (editBtn) editBtn.style.display = 'inline-flex';
      if (saveBtn) saveBtn.style.display = 'none';
      if (cancelBtn) cancelBtn.style.display = 'none';
      if (editor) editor.style.display = 'none';
      if (insightContent) insightContent.style.display = 'block';

      // Mostrar modal com loading
      titleText.textContent = `üìä An√°lise: ${mapping.title}`;
      loading.style.display = 'flex';
      content.style.display = 'none';
      if (actionsBar) actionsBar.style.display = 'none';
      modal.classList.add('show');

      try {
        // Destruir gr√°ficos anteriores
        destroyAnaliseCharts();

        // ‚ö†Ô∏è CRITICAL: Se forceRegenerate=true, N√ÉO buscar an√°lise antiga do Firebase
        // Isso garante que sempre geramos nova an√°lise com m√©tricas atualizadas do modal
        let analiseSalva = null;
        
        if (forceRegenerate) {
          console.log('');
          console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
          console.log('üî• MODO REGENERA√á√ÉO ATIVADO - PULANDO CACHE DO FIREBASE');
          console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
          console.log('   ‚ùå N√ÉO vai buscar an√°lise antiga do Firebase');
          console.log('   ‚úÖ Vai gerar an√°lise NOVA com m√©tricas do modal');
          console.log('   üìä M√©tricas dispon√≠veis:', !!window.metricasPrimeiroMes);
          if (window.metricasPrimeiroMes) {
            console.log('      ‚îî‚îÄ M√™s:', window.metricasPrimeiroMes.mesReferencia);
            console.log('      ‚îî‚îÄ Investimento:', window.metricasPrimeiroMes.investimento);
            console.log('      ‚îî‚îÄ Leads Org:', window.metricasPrimeiroMes.leadsOrganicos);
            console.log('      ‚îî‚îÄ Leads Pago:', window.metricasPrimeiroMes.leadsTrafegoPago);
            console.log('      ‚îî‚îÄ Vendas:', window.metricasPrimeiroMes.vendasEsperadas);
          }
          console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
          console.log('');
          analiseSalva = null; // For√ßar gera√ß√£o nova
        } else {
          console.log('üìã Buscando an√°lise salva do Firebase (forceRegenerate=false)...');
          analiseSalva = await carregarAnaliseFirebase(entregavelId, true);
        }
        
        console.log('üîç Debug An√°lise:', {
          entregavelId,
          forceRegenerate,
          temUserData: !!window.USER_DATA,
          temAnalisesNoUserData: !!window.USER_DATA?.analises,
          analisesSalvas: window.USER_DATA?.analises ? Object.keys(window.USER_DATA.analises) : [],
          analiseSalvaEncontrada: !!analiseSalva,
          timestampAnaliseSalva: analiseSalva?.lastSavedAt || analiseSalva?.generatedAt,
          modoRegeneracao: forceRegenerate ? 'üîÑ REGENERA√á√ÉO FOR√áADA - ignorando cache' : 'üìã Tentando carregar salva'
        });

        // Coletar dados atuais
        const data = collectAnaliseData(entregavelId);
        
        // Buscar m√≠dias tagueadas para este entreg√°vel
        if (data) {
          try {
            const midiasTagueadas = await buscarMidiasTagueadasPorEntregavel(entregavelId);
            data.midiasTagueadas = midiasTagueadas;
            console.log(`üì∏ ${midiasTagueadas.length} m√≠dias tagueadas encontradas para ${entregavelId}`);
          } catch (error) {
            console.warn('Erro ao buscar m√≠dias tagueadas:', error);
            data.midiasTagueadas = [];
          }
        }
        
        if (!data && !analiseSalva) {
          loading.innerHTML = `
            <div style="font-size:3rem;margin-bottom:16px;">‚ö†Ô∏è</div>
            <div class="analise-loading-text" style="color:#ff6b6b;">N√£o foi poss√≠vel coletar dados</div>
            <div class="analise-loading-sub">Verifique se o entreg√°vel est√° configurado corretamente.</div>
          `;
          return;
        }

        // Mostrar conte√∫do
        loading.style.display = 'none';
        content.style.display = 'grid';

        // Mostrar barra de a√ß√µes e bot√£o regenerar
        if (actionsBar) actionsBar.style.display = 'flex';
        if (regenerateBtn) regenerateBtn.style.display = 'inline-flex';

        // ‚ö†Ô∏è CRITICAL: APENAS exibir an√°lise salva se N√ÉO estamos regenerando
        if (analiseSalva && analiseSalva.insightHtml && !forceRegenerate) {
          console.log('üìã Exibindo an√°lise salva do Firebase');
          console.log('   ‚ÑπÔ∏è N√£o est√° regenerando - usando cache');
          console.log('   üìÖ An√°lise gerada em:', analiseSalva.generatedAt || analiseSalva.lastSavedAt);
          
          // VERIFICAR SE CONTEXTO DO NEG√ìCIO MUDOU desde a √∫ltima gera√ß√£o
          let contextChanged = false;
          let changedFields = [];
          
          if (analiseSalva.businessInfoSnapshot && ESTRUTURACAO_STATE.businessInfo) {
            const saved = analiseSalva.businessInfoSnapshot;
            const current = ESTRUTURACAO_STATE.businessInfo;
            
            // Verificar campos cr√≠ticos
            if (saved.ticket !== current.ticket) {
              contextChanged = true;
              changedFields.push(`Ticket M√©dio: "${saved.ticket || 'vazio'}" ‚Üí "${current.ticket || 'vazio'}"`);
            }
            if (saved.budget !== current.budget) {
              contextChanged = true;
              changedFields.push(`Or√ßamento: "${saved.budget || 'vazio'}" ‚Üí "${current.budget || 'vazio'}"`);
            }
            if (saved.agencyFee !== current.agencyFee) {
              contextChanged = true;
              changedFields.push(`Taxa Ag√™ncia: "${saved.agencyFee || 'vazio'}" ‚Üí "${current.agencyFee || 'vazio'}"`);
            }
            if (saved.country !== current.country) {
              contextChanged = true;
              changedFields.push(`Pa√≠s: "${saved.country || 'vazio'}" ‚Üí "${current.country || 'vazio'}"`);
            }
          }
          
          // Se o contexto mudou, mostrar aviso e sugerir regera√ß√£o
          if (contextChanged) {
            console.warn('‚ö†Ô∏è Contexto do neg√≥cio mudou desde √∫ltima gera√ß√£o:', changedFields);
            
            // Mostrar modal de aviso
            const avisoHtml = `
              <div style="background:rgba(255,193,7,.15);border:2px solid #ffc107;border-radius:12px;padding:20px;margin-bottom:24px;">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                  <span style="font-size:2rem;">‚ö†Ô∏è</span>
                  <div>
                    <strong style="color:#ffc107;font-size:1.1rem;">Contexto do Neg√≥cio Atualizado</strong>
                    <p style="margin:4px 0 0;opacity:0.9;font-size:0.9rem;">
                      Os seguintes dados foram alterados desde a √∫ltima an√°lise:
                    </p>
                  </div>
                </div>
                <ul style="margin:12px 0;padding-left:20px;opacity:0.9;">
                  ${changedFields.map(field => `<li>${field}</li>`).join('')}
                </ul>
                <p style="margin:12px 0 0;font-size:0.9rem;opacity:0.8;">
                  <strong>Recomenda√ß√£o:</strong> Clique em "üîÑ Regenerar An√°lise" para atualizar com os dados mais recentes.
                </p>
                <button onclick="regenerarAnalise()" style="margin-top:12px;padding:10px 20px;background:#ffc107;color:#000;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:0.95rem;">
                  üîÑ Regenerar Agora
                </button>
              </div>
            `;
            
            // Preparar o HTML limpo (remover m√≠dias antigas)
            const insightContent = document.getElementById('analiseInsightContent');
            let htmlLimpo = analiseSalva.insightHtml || '';
            
            // Remover TODAS as se√ß√µes de m√≠dias tagueadas antigas do HTML salvo
            htmlLimpo = htmlLimpo.replace(/<div class="midias-tagueadas-section"[^>]*>[\s\S]*?<\/div>\s*<\/div>\s*<\/div>/gi, '');
            htmlLimpo = htmlLimpo.replace(/<div[^>]*>[\s\S]*?üè∑Ô∏è M√≠dias Tagueadas:[\s\S]*?<\/div>\s*<\/div>\s*<\/div>/gi, '');
            
            // Gerar se√ß√£o de m√≠dias ATUAL (sempre buscar as mais recentes)
            let midiasAtuaisHtml = '';
            if (data && data.midiasTagueadas && data.midiasTagueadas.length > 0) {
              midiasAtuaisHtml = gerarSecaoMidiasTagueadas(data.midiasTagueadas, entregavelId);
            }
            
            // Processar HTML para adicionar blocos regener√°veis
            const htmlComBlocos = processarBlocosRegeneraveis(htmlLimpo);
            
            // Se contexto mudou, inserir aviso; sen√£o apenas renderizar conte√∫do
            if (insightContent) {
              if (contextChanged) {
                insightContent.innerHTML = avisoHtml + midiasAtuaisHtml + htmlComBlocos;
              } else {
                insightContent.innerHTML = midiasAtuaisHtml + htmlComBlocos;
              }
            }
          } else {
            // Sem mudan√ßas no contexto - renderizar normalmente
            const insightContent = document.getElementById('analiseInsightContent');
            if (insightContent) {
              // Preparar o HTML limpo (remover m√≠dias antigas)
              let htmlLimpo = analiseSalva.insightHtml || '';
              
              // Remover TODAS as se√ß√µes de m√≠dias tagueadas antigas do HTML salvo
              htmlLimpo = htmlLimpo.replace(/<div class="midias-tagueadas-section"[^>]*>[\s\S]*?<\/div>\s*<\/div>\s*<\/div>/gi, '');
              htmlLimpo = htmlLimpo.replace(/<div[^>]*>[\s\S]*?üè∑Ô∏è M√≠dias Tagueadas:[\s\S]*?<\/div>\s*<\/div>\s*<\/div>/gi, '');
              
              // Gerar se√ß√£o de m√≠dias ATUAL
              let midiasAtuaisHtml = '';
              if (data && data.midiasTagueadas && data.midiasTagueadas.length > 0) {
                midiasAtuaisHtml = gerarSecaoMidiasTagueadas(data.midiasTagueadas, entregavelId);
              }
              
              // Processar HTML para adicionar blocos regener√°veis
              const htmlComBlocos = processarBlocosRegeneraveis(htmlLimpo);
              insightContent.innerHTML = midiasAtuaisHtml + htmlComBlocos;
            }
          }
          
          // Mostrar badge de salvo no header
          if (savedBadge) {
            savedBadge.style.display = 'inline-flex';
            if (savedDate) savedDate.textContent = formatarDataAnalise(analiseSalva.generatedAt);
          }

          // Atualizar status na barra de a√ß√µes
          if (statusContainer) {
            statusContainer.innerHTML = `
              <span class="status-badge saved">‚úì Salvo</span>
              <span class="status-date">Gerado em ${formatarDataAnalise(analiseSalva.generatedAt)}</span>
            `;
          }

          // Atualizar m√©tricas (usar dados salvos ou atuais)
          if (data) {
            updateAnaliseMetrics(data);
          } else if (analiseSalva.metrics) {
            // Usar m√©tricas salvas se n√£o tiver dados atuais
            const metricProgresso = document.getElementById('metricProgresso');
            const metricConcluidas = document.getElementById('metricConcluidas');
            const metricPendentes = document.getElementById('metricPendentes');
            const metricAnotacoes = document.getElementById('metricAnotacoes');
            if (metricProgresso) metricProgresso.textContent = (analiseSalva.progressPct || 0) + '%';
            if (metricAnotacoes) metricAnotacoes.textContent = analiseSalva.notesCount || 0;
          }

          // Renderizar gr√°ficos
          if (data) {
            setTimeout(() => {
              setupDynamicCharts(data, mapping, entregavelId);
            }, 100);
          }

          return;
        }

        // ‚ö†Ô∏è MODO REGENERA√á√ÉO: Limpar conte√∫do anterior e exibir loading espec√≠fico
        if (forceRegenerate) {
          console.log(`\n${'='.repeat(80)}`);
          console.log('ÔøΩ MODO REGENERA√á√ÉO ATIVADO');
          console.log(`${'='.repeat(80)}`);
          console.log('   üßπ Limpando an√°lise antiga do cache');
          console.log('   üÜï For√ßando gera√ß√£o completamente nova');
          console.log('   üìä Usando m√©tricas atualizadas do modal');
          if (window.metricasPrimeiroMes) {
            console.log('   ‚úÖ M√©tricas dispon√≠veis:', {
              mes: window.metricasPrimeiroMes.mesReferencia,
              investimento: window.metricasPrimeiroMes.investimento,
              leads: `${window.metricasPrimeiroMes.leadsOrganicos} org + ${window.metricasPrimeiroMes.leadsTrafegoPago} pago`,
              vendas: window.metricasPrimeiroMes.vendasEsperadas
            });
          } else {
            console.log('   ‚ö†Ô∏è AVISO: M√©tricas n√£o encontradas em window.metricasPrimeiroMes!');
          }
          console.log(`${'='.repeat(80)}\n`);
          
          // Limpar completamente o conte√∫do de insight
          const insightContent = document.getElementById('analiseInsightContent');
          if (insightContent) {
            insightContent.innerHTML = `
              <div style="text-align:center; padding:60px 20px; color:#666;">
                <div style="font-size:3rem;margin-bottom:16px;">üîÑ</div>
                <div style="font-size:1.2rem;font-weight:600;margin-bottom:8px;">Regenerando An√°lise...</div>
                <div style="font-size:0.9rem;opacity:0.7;">Criando uma an√°lise completamente nova com as m√©tricas atualizadas</div>
              </div>
            `;
          }
          
          // Ocultar badge de "salvo"
          if (savedBadge) savedBadge.style.display = 'none';
        }

        // Atualizar status para "nova an√°lise" ou "regenerando"
        if (statusContainer) {
          statusContainer.innerHTML = `
            <span class="status-badge new">${forceRegenerate ? 'üîÑ Regenerando...' : 'üîÑ Gerando...'}</span>
          `;
        }

        // Atualizar m√©tricas
        updateAnaliseMetrics(data);

        // Renderizar gr√°ficos din√¢micos baseados no entreg√°vel
        setTimeout(() => {
          setupDynamicCharts(data, mapping, entregavelId);
        }, 100);

        // Gerar insights com IA usando prompt espec√≠fico do entreg√°vel
        await generateAnaliseInsightsAndSave(data, entregavelId, mapping);

      } catch (error) {
        console.error('Erro ao abrir an√°lise:', error);
        loading.innerHTML = `
          <div style="font-size:3rem;margin-bottom:16px;">‚ö†Ô∏è</div>
          <div class="analise-loading-text" style="color:#ff6b6b;">Erro ao gerar an√°lise</div>
          <div class="analise-loading-sub">${error.message || 'Tente novamente mais tarde.'}</div>
        `;
      }
    }

    // Gerar insights E salvar no Firebase
    async function generateAnaliseInsightsAndSave(data, entregavelId, mapping) {
      const insightContent = document.getElementById('analiseInsightContent');
      
      // Verificar se insightContent existe
      if (!insightContent) {
        console.error('Elemento analiseInsightContent n√£o encontrado');
        return;
      }
      
      // Obter mapping se n√£o foi passado
      const entregavelMapping = mapping || ENTREGAVEL_MAPPING[entregavelId];
      if (!entregavelMapping) {
        console.error('Mapping n√£o encontrado para:', entregavelId);
        insightContent.innerHTML = `
          <div style="background:rgba(239,68,68,.1);border-radius:12px;padding:20px;border-left:4px solid #ef4444;">
            <p style="margin:0;">Erro: Configura√ß√£o do entreg√°vel n√£o encontrada.</p>
          </div>
        `;
        return;
      }
      
      // Chamar fun√ß√£o original com par√¢metros corretos
      await generateAnaliseInsights(data, entregavelMapping, insightContent);
      
      // Ap√≥s gerar, salvar no Firebase
      // IMPORTANTE: Remover se√ß√£o de m√≠dias do HTML antes de salvar
      // As m√≠dias ser√£o sempre buscadas dinamicamente ao exibir
      let insightHtml = insightContent ? insightContent.innerHTML : '';
      
      // Remover se√ß√µes de m√≠dias tagueadas do HTML a ser salvo
      insightHtml = insightHtml.replace(/<div class="midias-tagueadas-section"[^>]*>[\s\S]*?<\/div>\s*<\/div>\s*<\/div>/gi, '');
      insightHtml = insightHtml.replace(/<div[^>]*>[\s\S]*?üè∑Ô∏è M√≠dias Tagueadas:[\s\S]*?<\/div>\s*<\/div>\s*<\/div>/gi, '');
      
      const progressPct = data.totalItems > 0 ? Math.round((data.completedItems / data.totalItems) * 100) : 0;
      
      console.log('üìù Preparando para salvar (sem m√≠dias no HTML):', {
        entregavelId,
        temInsightHtml: !!insightHtml,
        tamanhoHtml: insightHtml.length
      });
      
      const analiseData = {
        insightHtml: insightHtml,
        metrics: {
          completedItems: data.completedItems,
          totalItems: data.totalItems,
          pendingItems: data.pendingItems
        },
        chartData: data.dimensions || {},
        notesCount: data.notes?.length || 0,
        progressPct: progressPct
      };
      
      // Salvar landingPagesInfo junto com a an√°lise para poder recuperar depois
      if (entregaveisComInfoExtra.includes(entregavelId) && window.landingPagesInfo) {
        analiseData.landingPagesInfo = window.landingPagesInfo;
        console.log('üíæ Salvando landingPagesInfo junto com an√°lise');
      }
      
      const saved = await salvarAnaliseFirebase(entregavelId, analiseData);
      
      // FOR√áAR ATUALIZA√á√ÉO DO CACHE ap√≥s salvar
      if (saved) {
        console.log('üîÑ For√ßando atualiza√ß√£o do cache ap√≥s salvar...');
        await carregarAnaliseFirebase(entregavelId, true); // forceRefresh = true
      }
      
      // Atualizar status e badge
      const statusContainer = document.getElementById('analiseStatus');
      const savedBadge = document.getElementById('analiseSavedBadge');
      const savedDate = document.getElementById('analiseSavedDate');
      
      if (saved) {
        // Mostrar badge de salvo no header
        if (savedBadge) {
          savedBadge.style.display = 'inline-flex';
          if (savedDate) savedDate.textContent = 'agora';
        }
        
        // Atualizar status na barra de a√ß√µes
        if (statusContainer) {
          statusContainer.innerHTML = `
            <span class="status-badge saved">‚úì Salvo</span>
            <span class="status-date">Gerado agora</span>
          `;
        }
      }
    }

    // Vari√°vel global para armazenar instru√ß√µes extras do usu√°rio
    window.regenerateExtraInstructions = '';
    
    // Vari√°vel global para armazenar informa√ß√µes de Landing Pages
    window.landingPagesInfo = null;
    
    // Fun√ß√£o para abrir modal de informa√ß√µes de Landing Pages/Website
    function abrirModalLandingInfo(entregavelId, isRegenerate = false) {
      const modal = document.getElementById('landingPagesInfoModal');
      const title = document.getElementById('landingInfoTitle');
      const intro = document.getElementById('landingInfoIntro');
      const confirmBtn = document.getElementById('landingInfoConfirmBtn');
      
      if (!modal) return;
      
      // Configurar t√≠tulo e texto baseado no entreg√°vel
      const isWebsite = entregavelId === 'website';
      if (title) {
        title.textContent = isWebsite 
          ? 'üåê Informa√ß√µes para Website' 
          : 'üéØ Informa√ß√µes para Landing Pages';
      }
      if (intro) {
        intro.textContent = isWebsite 
          ? 'Para criar um website estrat√©gico e personalizado, precisamos de algumas informa√ß√µes sobre seus produtos/servi√ßos e objetivos.' 
          : 'Para criar landing pages estrat√©gicas e personalizadas, precisamos de algumas informa√ß√µes sobre seus produtos/servi√ßos e objetivos.';
      }
      if (confirmBtn) {
        confirmBtn.textContent = isRegenerate ? 'üöÄ Gerar Nova An√°lise' : 'üöÄ Gerar An√°lise';
      }
      
      // Salvar estado para saber se √© regenera√ß√£o
      window.landingInfoIsRegenerate = isRegenerate;
      window.landingInfoEntregavelId = entregavelId;
      
      // Limpar campos
      const campos = ['landingInfoProdutos', 'landingInfoObjetivo', 'landingInfoPreco', 'landingInfoCanal', 'landingInfoDiferenciais', 'landingInfoObservacoes'];
      campos.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
      
      // Pr√©-preencher com dados salvos se existirem
      if (window.landingPagesInfo) {
        document.getElementById('landingInfoProdutos').value = window.landingPagesInfo.produtos || '';
        document.getElementById('landingInfoObjetivo').value = window.landingPagesInfo.objetivo || '';
        document.getElementById('landingInfoPreco').value = window.landingPagesInfo.preco || '';
        document.getElementById('landingInfoCanal').value = window.landingPagesInfo.canal || '';
        document.getElementById('landingInfoDiferenciais').value = window.landingPagesInfo.diferenciais || '';
        document.getElementById('landingInfoObservacoes').value = window.landingPagesInfo.observacoes || '';
      }
      
      modal.style.display = 'flex';
      document.getElementById('landingInfoProdutos')?.focus();
    }
    
    // Fun√ß√£o para fechar modal de Landing Pages
    function fecharModalLandingInfo() {
      const modal = document.getElementById('landingPagesInfoModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }
    
    // Fun√ß√£o para confirmar e gerar an√°lise com informa√ß√µes de Landing Pages
    async function confirmarLandingInfo() {
      const produtos = document.getElementById('landingInfoProdutos')?.value.trim();
      const objetivo = document.getElementById('landingInfoObjetivo')?.value;
      
      // Validar campos obrigat√≥rios
      if (!produtos) {
        alert('Por favor, informe os produtos/servi√ßos que deseja promover.');
        document.getElementById('landingInfoProdutos')?.focus();
        return;
      }
      if (!objetivo) {
        alert('Por favor, selecione o objetivo principal da p√°gina.');
        document.getElementById('landingInfoObjetivo')?.focus();
        return;
      }
      
      // Coletar todas as informa√ß√µes
      window.landingPagesInfo = {
        produtos: produtos,
        objetivo: objetivo,
        objetivoTexto: document.getElementById('landingInfoObjetivo')?.options[document.getElementById('landingInfoObjetivo').selectedIndex]?.text || objetivo,
        preco: document.getElementById('landingInfoPreco')?.value.trim() || '',
        canal: document.getElementById('landingInfoCanal')?.value || '',
        canalTexto: document.getElementById('landingInfoCanal')?.options[document.getElementById('landingInfoCanal').selectedIndex]?.text || '',
        diferenciais: document.getElementById('landingInfoDiferenciais')?.value.trim() || '',
        observacoes: document.getElementById('landingInfoObservacoes')?.value.trim() || ''
      };
      
      fecharModalLandingInfo();
      
      const entregavelId = window.landingInfoEntregavelId;
      const isRegenerate = window.landingInfoIsRegenerate;
      
      if (isRegenerate) {
        // Se for regenera√ß√£o, chamar a execu√ß√£o direta
        const regenerateBtn = document.getElementById('analiseRegenerateBtn');
        if (regenerateBtn) {
          regenerateBtn.disabled = true;
          regenerateBtn.classList.add('loading');
          regenerateBtn.textContent = 'Gerando...';
        }
        
        try {
          await abrirAnaliseEntregavel(entregavelId, true, true);
        } finally {
          if (regenerateBtn) {
            regenerateBtn.disabled = false;
            regenerateBtn.classList.remove('loading');
            regenerateBtn.textContent = 'üîÑ Gerar Novamente';
          }
        }
      } else {
        // Primeira gera√ß√£o
        await abrirAnaliseEntregavel(entregavelId, false, true);
      }
    }
    
    // Exportar fun√ß√µes globais
    window.fecharModalLandingInfo = fecharModalLandingInfo;
    window.confirmarLandingInfo = confirmarLandingInfo;

    // ========================================
    // üìä MODAL DE M√âTRICAS DO PRIMEIRO M√äS
    // ========================================
    
    // Fun√ß√£o para calcular sugest√µes de m√©tricas baseadas no contexto
    function calcularMetricasSugeridas() {
      const businessInfo = ESTRUTURACAO_STATE.businessInfo || {};
      console.log('üßÆ Calculando m√©tricas sugeridas com:', businessInfo);
      
      // Usar os nomes corretos dos campos (ticket e budget s√£o os originais)
      const ticketMedio = parseFloat((businessInfo.ticket || businessInfo.ticketMedio || '0').replace(/[^\d,.-]/g, '').replace(',', '.')) || 1000;
      const orcamento = parseFloat((businessInfo.budget || businessInfo.orcamento || '0').replace(/[^\d,.-]/g, '').replace(',', '.')) || 1000;
      
      console.log('üìä Valores extra√≠dos - Ticket:', ticketMedio, 'Or√ßamento:', orcamento);
      
      // Detectar se √© R$ ou $
      const moeda = (businessInfo.ticket || businessInfo.budget || businessInfo.ticketMedio || businessInfo.orcamento || '').includes('R$') ? 'R$' : '$';
      
      // Ajustar investimento inicial (30-50% do or√ßamento mensal)
      let investimentoSugerido = Math.round(orcamento * 0.4);
      
      // CPL estimado baseado no ticket (quanto maior o ticket, maior o CPL aceit√°vel)
      let cplEstimado = 20; // default
      if (ticketMedio < 200) cplEstimado = 25;
      else if (ticketMedio < 500) cplEstimado = 35;
      else if (ticketMedio < 1000) cplEstimado = 50;
      else if (ticketMedio < 2000) cplEstimado = 70;
      else if (ticketMedio < 5000) cplEstimado = 100;
      else cplEstimado = 150;
      
      // Calcular leads pagos baseado no CPL
      let leadsPagoSugerido = investimentoSugerido > 0 ? Math.round(investimentoSugerido / cplEstimado) : 0;
      
      // Leads org√¢nicos (come√ßar conservador: 10-30 dependendo do est√°gio)
      let leadsOrgSugerido = 15;
      if (businessInfo.observations && businessInfo.observations.toLowerCase().includes('come√ßando')) {
        leadsOrgSugerido = 10;
      } else if (businessInfo.observations && businessInfo.observations.toLowerCase().includes('consolidado')) {
        leadsOrgSugerido = 25;
      }
      
      // Taxas de convers√£o realistas
      let convPago = 4; // 4% inicial para leads pagos (mais frios)
      let convOrg = 10; // 10% inicial para leads org√¢nicos (mais quentes)
      
      // Calcular vendas esperadas
      let vendasPago = Math.round(leadsPagoSugerido * (convPago / 100));
      let vendasOrg = Math.round(leadsOrgSugerido * (convOrg / 100));
      let vendasTotal = vendasPago + vendasOrg;
      
      return {
        investimento: investimentoSugerido,
        moeda: moeda,
        leadsOrg: leadsOrgSugerido,
        leadsPago: leadsPagoSugerido,
        convPago: convPago,
        convOrg: convOrg,
        vendas: vendasTotal,
        ticketMedio: ticketMedio
      };
    }
    
    // Fun√ß√£o para abrir modal de m√©tricas
    function abrirModalMetricasMes(entregavelId, isRegenerate = false) {
      console.log('üîµ abrirModalMetricasMes CHAMADA:', { entregavelId, isRegenerate });
      
      const modal = document.getElementById('metricasPrimeiroMesModal');
      if (!modal) {
        console.error('‚ùå Modal metricasPrimeiroMesModal n√£o encontrado no DOM!');
        return;
      }
      
      console.log('‚úÖ Modal encontrado, preparando para abrir...');
      
      // Salvar estado
      window.metricasMesEntregavelId = entregavelId;
      window.metricasMesIsRegenerate = isRegenerate;
      
      // Atualizar t√≠tulo do modal conforme contexto
      const tituloModal = document.getElementById('metricasModalTitulo');
      const avisoRegeneracao = document.getElementById('metricasAvisoRegeneracao');
      
      if (tituloModal) {
        if (isRegenerate) {
          tituloModal.textContent = 'üîÑ Ajustar M√©tricas e Regenerar An√°lise';
          if (avisoRegeneracao) avisoRegeneracao.style.display = 'block';
        } else {
          tituloModal.textContent = 'üìä M√©tricas do Primeiro M√™s de Atua√ß√£o';
          if (avisoRegeneracao) avisoRegeneracao.style.display = 'none';
        }
      }
      
      // Preencher contexto do neg√≥cio
      const businessInfo = ESTRUTURACAO_STATE.businessInfo || {};
      console.log('üìã Business Info carregado:', businessInfo);
      
      // Usar os nomes corretos dos campos do businessInfo
      document.getElementById('metricasContextoNicho').textContent = businessInfo.niche || businessInfo.nicho || 'N√£o informado';
      document.getElementById('metricasContextoTicket').textContent = businessInfo.ticket || businessInfo.ticketMedio || 'N√£o informado';
      document.getElementById('metricasContextoOrcamento').textContent = businessInfo.budget || businessInfo.orcamento || 'N√£o informado';
      
      // Calcular meta anual baseada no ticket e tempo (se n√£o houver meta expl√≠cita)
      let metaAnualTexto = businessInfo.metaAnual || 'N√£o informado';
      if (metaAnualTexto === 'N√£o informado' && businessInfo.ticket && businessInfo.time) {
        // Tentar calcular uma meta baseada no contexto
        const ticketNum = parseFloat((businessInfo.ticket || '0').replace(/[^\d,.-]/g, '').replace(',', '.'));
        const timeMatch = (businessInfo.time || '').match(/(\d+)/);
        const vendas = timeMatch ? parseInt(timeMatch[0]) : 0;
        if (ticketNum > 0 && vendas > 0) {
          const metaAnual = ticketNum * vendas * 12;
          const moeda = (businessInfo.ticket || '').includes('R$') ? 'R$' : '$';
          metaAnualTexto = `${moeda} ${metaAnual.toLocaleString('pt-BR')}`;
        }
      }
      document.getElementById('metricasContextoMetaAnual').textContent = metaAnualTexto;
      
      document.getElementById('metricasContextoSituacao').textContent = businessInfo.observations || businessInfo.situacao || 'N√£o informado';
      
      // Calcular m√™s atual (pr√≥ximo m√™s do atual)
      const hoje = new Date();
      const proximoMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 1);
      const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
      const mesTexto = `${meses[proximoMes.getMonth()]} ${proximoMes.getFullYear()}`;
      document.getElementById('metricasMesAtual').textContent = mesTexto;
      
      // Calcular e exibir sugest√µes
      const sugestoes = calcularMetricasSugeridas();
      window.metricasSugeridas = sugestoes; // Salvar globalmente
      
      document.getElementById('sugInvestimento').textContent = `${sugestoes.moeda} ${sugestoes.investimento.toLocaleString('pt-BR')}`;
      document.getElementById('sugLeadsOrg').textContent = sugestoes.leadsOrg;
      document.getElementById('sugLeadsPago').textContent = sugestoes.leadsPago;
      document.getElementById('sugConvPago').textContent = `${sugestoes.convPago}%`;
      document.getElementById('sugConvOrg').textContent = `${sugestoes.convOrg}%`;
      document.getElementById('sugVendas').textContent = sugestoes.vendas;
      
      // Se for regenera√ß√£o E j√° existirem m√©tricas salvas, preencher os campos
      if (isRegenerate && window.metricasPrimeiroMes) {
        console.log('üîÑ Regenera√ß√£o detectada - preenchendo com m√©tricas anteriores:', window.metricasPrimeiroMes);
        document.getElementById('metricasInvestimento').value = window.metricasPrimeiroMes.investimento || '';
        document.getElementById('metricasLeadsOrg').value = window.metricasPrimeiroMes.leadsOrganicos || '';
        document.getElementById('metricasLeadsPago').value = window.metricasPrimeiroMes.leadsTrafegoPago || '';
        document.getElementById('metricasConvPago').value = window.metricasPrimeiroMes.convPago || '';
        document.getElementById('metricasConvOrg').value = window.metricasPrimeiroMes.convOrg || '';
        document.getElementById('metricasObservacoes').value = window.metricasPrimeiroMes.observacoes || '';
        
        // Calcular proje√ß√£o automaticamente
        setTimeout(calcularProjecaoAnual, 100);
      } else {
        // Limpar campos manuais (primeira vez)
        console.log('‚ú® Primeira gera√ß√£o - campos vazios');
        document.getElementById('metricasInvestimento').value = '';
        document.getElementById('metricasLeadsOrg').value = '';
        document.getElementById('metricasLeadsPago').value = '';
        document.getElementById('metricasConvPago').value = '';
        document.getElementById('metricasConvOrg').value = '';
        document.getElementById('metricasObservacoes').value = '';
      }
      
      // Mostrar modal
      console.log('üéØ Exibindo modal de m√©tricas...');
      modal.style.display = 'flex';
      console.log('‚úÖ Modal display definido como flex');
    }
    
    // Fun√ß√£o para fechar modal de m√©tricas
    function fecharModalMetricasMes() {
      const modal = document.getElementById('metricasPrimeiroMesModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }
    
    // Fun√ß√£o para usar estimativas sugeridas
    function usarEstimativasSugeridas() {
      const sug = window.metricasSugeridas;
      if (!sug) return;
      
      document.getElementById('metricasInvestimento').value = `${sug.moeda} ${sug.investimento}`;
      document.getElementById('metricasLeadsOrg').value = sug.leadsOrg;
      document.getElementById('metricasLeadsPago').value = sug.leadsPago;
      document.getElementById('metricasConvPago').value = sug.convPago;
      document.getElementById('metricasConvOrg').value = sug.convOrg;
      
      // Scroll suave para os campos
      document.getElementById('metricasInvestimento').scrollIntoView({ behavior: 'smooth', block: 'center' });
      
      // Calcular proje√ß√£o anual ap√≥s preencher
      calcularProjecaoAnual();
    }
    
    // Fun√ß√£o para calcular e exibir proje√ß√£o anual baseada nas m√©tricas do primeiro m√™s
    function calcularProjecaoAnual() {
      // Coletar valores dos campos
      const investimentoStr = document.getElementById('metricasInvestimento').value.trim();
      const leadsOrgStr = document.getElementById('metricasLeadsOrg').value.trim();
      const leadsPagoStr = document.getElementById('metricasLeadsPago').value.trim();
      const convPagoStr = document.getElementById('metricasConvPago').value.trim();
      const convOrgStr = document.getElementById('metricasConvOrg').value.trim();
      
      // Verificar se todos os campos est√£o preenchidos
      if (!investimentoStr || !leadsOrgStr || !leadsPagoStr || !convPagoStr || !convOrgStr) {
        // Ocultar pr√©via se campos incompletos
        document.getElementById('metricasPrevisaoAnual').style.display = 'none';
        return;
      }
      
      // Extrair valores num√©ricos EXATOS fornecidos pelo usu√°rio
      const investimentoMensal = parseFloat(investimentoStr.replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
      const leadsOrgMensal = parseInt(leadsOrgStr) || 0;
      const leadsPagoMensal = parseInt(leadsPagoStr) || 0;
      const convPago = parseFloat(convPagoStr) || 0;
      const convOrg = parseFloat(convOrgStr) || 0;
      
      // Obter ticket m√©dio e moeda
      const businessInfo = ESTRUTURACAO_STATE.businessInfo || {};
      const ticketMedio = parseFloat((businessInfo.ticket || businessInfo.ticketMedio || '0').replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
      const moeda = (businessInfo.ticket || businessInfo.budget || investimentoStr || '').includes('R$') ? 'R$' : '$';
      
      // C√ÅLCULO SIMPLES E DIRETO - M√âDIA DOS PR√ìXIMOS 6 MESES
      // Baseado EXATAMENTE nos valores fornecidos, SEM inventar crescimento
      
      const meses = 6; // Pr√≥ximos 6 meses
      
      // Total de leads por m√™s (soma de org√¢nicos + pagos)
      const leadsTotaisMensal = leadsOrgMensal + leadsPagoMensal;
      
      // Calcular vendas mensais baseadas nas taxas de convers√£o fornecidas
      const vendasPagoMensal = Math.round(leadsPagoMensal * (convPago / 100));
      const vendasOrgMensal = Math.round(leadsOrgMensal * (convOrg / 100));
      const vendasTotaisMensal = vendasPagoMensal + vendasOrgMensal;
      
      // Calcular faturamento mensal
      const faturamentoMensal = vendasTotaisMensal * ticketMedio;
      
      // PROJE√á√ÉO PARA 6 MESES - Multiplica√ß√£o simples dos valores mensais
      const investimentoTotal6Meses = investimentoMensal * meses;
      const leadsTotal6Meses = leadsTotaisMensal * meses;
      const vendasTotal6Meses = vendasTotaisMensal * meses;
      const faturamentoTotal6Meses = faturamentoMensal * meses;
      
      // Exibir resultados (M√âDIA DOS 6 MESES = valores fornecidos √ó 6)
      document.getElementById('prevInvestimentoTotal').textContent = `${moeda} ${investimentoTotal6Meses.toLocaleString('pt-BR', {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;
      document.getElementById('prevLeadsTotal').textContent = leadsTotal6Meses.toLocaleString('pt-BR');
      document.getElementById('prevVendasTotal').textContent = vendasTotal6Meses.toLocaleString('pt-BR');
      document.getElementById('prevFaturamentoTotal').textContent = `${moeda} ${faturamentoTotal6Meses.toLocaleString('pt-BR', {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;
      
      console.log('üìä Proje√ß√£o 6 meses calculada:', {
        investimentoMensal,
        leadsMensal: leadsTotaisMensal,
        vendasMensal: vendasTotaisMensal,
        faturamentoMensal,
        investimentoTotal: investimentoTotal6Meses,
        leadsTotal: leadsTotal6Meses,
        vendasTotal: vendasTotal6Meses,
        faturamentoTotal: faturamentoTotal6Meses
      });
      
      // Mostrar se√ß√£o de pr√©via
      document.getElementById('metricasPrevisaoAnual').style.display = 'block';
      
      // Scroll suave para a pr√©via
      setTimeout(() => {
        document.getElementById('metricasPrevisaoAnual').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }, 100);
    }
    
    // Adicionar event listeners nos campos para calcular automaticamente
    function inicializarCalculoAutomatico() {
      const campos = [
        'metricasInvestimento',
        'metricasLeadsOrg', 
        'metricasLeadsPago',
        'metricasConvPago',
        'metricasConvOrg'
      ];
      
      campos.forEach(campoId => {
        const campo = document.getElementById(campoId);
        if (campo) {
          campo.addEventListener('input', calcularProjecaoAnual);
          campo.addEventListener('change', calcularProjecaoAnual);
        }
      });
    }
    
    // Inicializar quando o documento estiver pronto
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', inicializarCalculoAutomatico);
    } else {
      inicializarCalculoAutomatico();
    }
    
    // Fun√ß√£o para confirmar e gerar an√°lise
    async function confirmarMetricasMes() {
      // Coletar dados manuais
      const investimento = document.getElementById('metricasInvestimento').value.trim();
      const leadsOrg = document.getElementById('metricasLeadsOrg').value.trim();
      const leadsPago = document.getElementById('metricasLeadsPago').value.trim();
      const convPago = document.getElementById('metricasConvPago').value.trim();
      const convOrg = document.getElementById('metricasConvOrg').value.trim();
      
      // Validar campos obrigat√≥rios
      if (!investimento) {
        alert('‚ö†Ô∏è Por favor, informe o investimento em m√≠dia paga para o primeiro m√™s.');
        document.getElementById('metricasInvestimento').focus();
        return;
      }
      if (!leadsOrg) {
        alert('‚ö†Ô∏è Por favor, informe a estimativa de leads org√¢nicos.');
        document.getElementById('metricasLeadsOrg').focus();
        return;
      }
      if (!leadsPago) {
        alert('‚ö†Ô∏è Por favor, informe a estimativa de leads pagos.');
        document.getElementById('metricasLeadsPago').focus();
        return;
      }
      if (!convPago) {
        alert('‚ö†Ô∏è Por favor, informe a taxa de convers√£o de leads pagos.');
        document.getElementById('metricasConvPago').focus();
        return;
      }
      if (!convOrg) {
        alert('‚ö†Ô∏è Por favor, informe a taxa de convers√£o de leads org√¢nicos.');
        document.getElementById('metricasConvOrg').focus();
        return;
      }
      
      // Salvar m√©tricas do primeiro m√™s globalmente
      const businessInfo = ESTRUTURACAO_STATE.businessInfo || {};
      const ticketMedio = parseFloat((businessInfo.ticket || businessInfo.ticketMedio || '0').replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
      
      // Calcular vendas baseadas nas convers√µes
      const leadsOrgNum = parseInt(leadsOrg) || 0;
      const leadsPagoNum = parseInt(leadsPago) || 0;
      const convPagoNum = parseFloat(convPago) || 0;
      const convOrgNum = parseFloat(convOrg) || 0;
      
      const vendasPago = Math.round(leadsPagoNum * (convPagoNum / 100));
      const vendasOrg = Math.round(leadsOrgNum * (convOrgNum / 100));
      const vendasTotal = vendasPago + vendasOrg;
      
      // Calcular faturamento esperado
      const faturamentoEsperado = ticketMedio > 0 ? ticketMedio * vendasTotal : 0;
      const moeda = (businessInfo.ticket || businessInfo.budget || '').includes('R$') ? 'R$' : '$';
      const faturamentoFormatado = `${moeda} ${faturamentoEsperado.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
      
      const mesReferencia = document.getElementById('metricasMesAtual').textContent;
      const observacoes = document.getElementById('metricasObservacoes').value.trim();
      
      // Coletar metas de redes sociais (opcional)
      const redesSociais = {
        instagram: {
          atual: document.getElementById('metricasInstagramAtual').value.trim(),
          mes3: document.getElementById('metricasInstagramMes3').value.trim(),
          mes6: document.getElementById('metricasInstagramMes6').value.trim(),
          mes12: document.getElementById('metricasInstagramMes12').value.trim()
        },
        facebook: {
          atual: document.getElementById('metricasFacebookAtual').value.trim(),
          mes3: document.getElementById('metricasFacebookMes3').value.trim(),
          mes6: document.getElementById('metricasFacebookMes6').value.trim(),
          mes12: document.getElementById('metricasFacebookMes12').value.trim()
        },
        linkedin: {
          atual: document.getElementById('metricasLinkedinAtual').value.trim(),
          mes3: document.getElementById('metricasLinkedinMes3').value.trim(),
          mes6: document.getElementById('metricasLinkedinMes6').value.trim(),
          mes12: document.getElementById('metricasLinkedinMes12').value.trim()
        },
        tiktok: {
          atual: document.getElementById('metricasTiktokAtual').value.trim(),
          mes3: document.getElementById('metricasTiktokMes3').value.trim(),
          mes6: document.getElementById('metricasTiktokMes6').value.trim(),
          mes12: document.getElementById('metricasTiktokMes12').value.trim()
        }
      };
      
      window.metricasPrimeiroMes = {
        mesReferencia: mesReferencia,
        investimento: investimento,
        leadsOrganicos: leadsOrgNum,
        leadsTrafegoPago: leadsPagoNum,
        convPago: convPagoNum,
        convOrg: convOrgNum,
        vendasEsperadas: vendasTotal,
        faturamentoEsperado: faturamentoFormatado,
        observacoes: observacoes, // Observa√ß√µes adicionais para a IA
        redesSociais: redesSociais, // Metas de redes sociais
        // Dados para c√°lculos
        vendasPago: vendasPago,
        vendasOrg: vendasOrg,
        ticketMedio: ticketMedio
      };
      
      console.log('üíæ M√©tricas do primeiro m√™s salvas:', window.metricasPrimeiroMes);
      
      // Fechar modal
      fecharModalMetricasMes();
      
      // Gerar an√°lise FOR√áANDO NOVA GERA√á√ÉO (n√£o usar cache)
      const entregavelId = window.metricasMesEntregavelId;
      const isRegenerate = window.metricasMesIsRegenerate;
      
      console.log(`üöÄ Iniciando gera√ß√£o de an√°lise: ${entregavelId}`);
      console.log(`   üîÑ √â regenera√ß√£o? ${isRegenerate}`);
      console.log(`   üìä M√©tricas salvas? ${!!window.metricasPrimeiroMes}`);
      
      // ‚ö° CRITICAL FIX: SEMPRE usar forceRegenerate=true quando temos m√©tricas novas
      // Isso garante que n√£o carregamos an√°lise antiga do Firebase
      console.log(`üî• SEMPRE FOR√áAR NOVA GERA√á√ÉO quando modal de m√©tricas √© confirmado`);
      console.log(`   üìä M√©tricas do modal:`, {
        mes: window.metricasPrimeiroMes.mesReferencia,
        investimento: window.metricasPrimeiroMes.investimento,
        leadsOrg: window.metricasPrimeiroMes.leadsOrganicos,
        leadsPago: window.metricasPrimeiroMes.leadsTrafegoPago,
        vendas: window.metricasPrimeiroMes.vendasEsperadas
      });
      
      if (isRegenerate) {
        const regenerateBtn = document.getElementById('analiseRegenerateBtn');
        if (regenerateBtn) {
          regenerateBtn.disabled = true;
          regenerateBtn.classList.add('loading');
          regenerateBtn.textContent = 'Gerando...';
        }
        
        try {
          // ‚úÖ FOR√áAR NOVA GERA√á√ÉO - forceRegenerate=true + skipInfoModal=false
          console.log(`ÔøΩ REGENERA√á√ÉO: Gerando com m√©tricas atualizadas...`);
          await abrirAnaliseEntregavel(entregavelId, true, false);
        } finally {
          if (regenerateBtn) {
            regenerateBtn.disabled = false;
            regenerateBtn.classList.remove('loading');
            regenerateBtn.textContent = 'üîÑ Gerar Novamente';
          }
        }
      } else {
        // ‚úÖ CRITICAL FIX: Usar forceRegenerate=true MESMO na primeira vez
        // Isso evita carregar an√°lise antiga do Firebase
        console.log(`üÜï PRIMEIRA GERA√á√ÉO: Gerando com m√©tricas do modal (forceRegenerate=true)...`);
        await abrirAnaliseEntregavel(entregavelId, true, false);
      }
    }
    
    // Exportar fun√ß√µes globais
    window.abrirModalMetricasMes = abrirModalMetricasMes;
    window.fecharModalMetricasMes = fecharModalMetricasMes;
    window.usarEstimativasSugeridas = usarEstimativasSugeridas;
    window.confirmarMetricasMes = confirmarMetricasMes;

    // Fun√ß√£o para abrir modal de instru√ß√µes antes de regenerar
    function abrirModalInstrucoes() {
      const modal = document.getElementById('regenerateInstructionsModal');
      const input = document.getElementById('regenerateInstructionsInput');
      if (modal) {
        modal.style.display = 'flex';
        if (input) {
          input.value = '';
          input.focus();
        }
      }
    }

    // Fun√ß√£o para fechar modal de instru√ß√µes
    function fecharModalInstrucoes() {
      const modal = document.getElementById('regenerateInstructionsModal');
      if (modal) {
        modal.style.display = 'none';
      }
    }

    // Fun√ß√£o para regenerar an√°lise (agora abre o popup primeiro)
    async function regenerarAnalise() {
      if (!currentEntregavelId) {
        console.warn('Nenhum entreg√°vel selecionado para regenerar');
        return;
      }
      
      // üìä Se for direcionamento_metas, abrir modal de m√©tricas
      if (currentEntregavelId === 'direcionamento_metas') {
        console.log('üîÑ Regenerando direcionamento_metas - abrindo modal de m√©tricas');
        abrirModalMetricasMes(currentEntregavelId, true);
        return;
      }
      
      // Verificar se √© entreg√°vel que precisa de informa√ß√µes extras (landing pages/website)
      if (entregaveisComInfoExtra.includes(currentEntregavelId)) {
        abrirModalLandingInfo(currentEntregavelId, true);
        return;
      }
      
      // Para outros entreg√°veis, abrir modal de instru√ß√µes
      abrirModalInstrucoes();
    }

    // Fun√ß√£o que efetivamente regenera a an√°lise com as instru√ß√µes
    async function executarRegeneracao() {
      fecharModalInstrucoes();
      
      const input = document.getElementById('regenerateInstructionsInput');
      window.regenerateExtraInstructions = input ? input.value.trim() : '';
      
      const regenerateBtn = document.getElementById('analiseRegenerateBtn');
      if (regenerateBtn) {
        regenerateBtn.disabled = true;
        regenerateBtn.classList.add('loading');
        regenerateBtn.textContent = 'Gerando...';
      }
      
      try {
        await abrirAnaliseEntregavel(currentEntregavelId, true);
      } finally {
        if (regenerateBtn) {
          regenerateBtn.disabled = false;
          regenerateBtn.classList.remove('loading');
          regenerateBtn.textContent = 'üîÑ Gerar Novamente';
        }
        // Limpar instru√ß√µes ap√≥s uso
        window.regenerateExtraInstructions = '';
      }
    }

    // Exportar fun√ß√£o para uso global
    window.abrirAnaliseEntregavel = abrirAnaliseEntregavel;
    window.regenerarAnalise = regenerarAnalise;
    window.executarRegeneracao = executarRegeneracao;
    
    // üîÑ NOVA FUN√á√ÉO: For√ßar refresh do Firebase e recarregar an√°lise
    window.forceRefreshAnalise = async function() {
      if (!currentEntregavelId) {
        console.warn('Nenhum entreg√°vel selecionado para atualizar');
        return;
      }
      
      const refreshBtn = document.getElementById('analiseRefreshBtn');
      const originalText = refreshBtn ? refreshBtn.innerHTML : '';
      
      if (refreshBtn) {
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = '‚è≥ Atualizando...';
        refreshBtn.style.opacity = '0.6';
      }
      
      try {
        console.log('üîÑ FOR√áANDO ATUALIZA√á√ÉO DO FIREBASE para:', currentEntregavelId);
        
        // Limpar cache local para este entreg√°vel
        if (window.USER_DATA?.analises) {
          delete window.USER_DATA.analises[currentEntregavelId];
        }
        if (USER_DATA?.analises) {
          delete USER_DATA.analises[currentEntregavelId];
        }
        
        // Fechar modal atual
        const modal = document.getElementById('analiseModal');
        if (modal) modal.classList.remove('show');
        
        // Aguardar um momento
        await new Promise(resolve => setTimeout(resolve, 300));
        
        // Reabrir com forceRefresh (abrirAnaliseEntregavel j√° usa forceRefresh=true agora)
        await abrirAnaliseEntregavel(currentEntregavelId, false);
        
        console.log('‚úÖ An√°lise atualizada do Firebase');
      } catch (error) {
        console.error('‚ùå Erro ao atualizar an√°lise:', error);
        alert('Erro ao atualizar an√°lise. Verifique o console.');
      } finally {
        if (refreshBtn) {
          refreshBtn.disabled = false;
          refreshBtn.innerHTML = originalText || '‚Üª Atualizar';
          refreshBtn.style.opacity = '1';
        }
      }
    };

    // ===== FUN√á√ÉO COPIAR LINK DE APROVA√á√ÉO DE AN√ÅLISE =====
    const ENTREGAVEL_TITLES_COPY = {
      diagnostico_estrategico: 'Diagn√≥stico Estrat√©gico Completo',
      direcionamento_metas: 'Direcionamento Estrat√©gico e Metas',
      analise_concorrencia: 'An√°lise de Concorr√™ncia e Mercado',
      matriz_cdt: 'Matriz CDT',
      puv: 'PUV - Proposta √önica de Valor',
      pai: 'PAI - P√∫blico Alvo Ideal',
      anuncios_pagos: 'Estrutura√ß√£o de An√∫ncios Pagos',
      site_seo: 'Estrutura√ß√£o Site & SEO',
      redes_sociais: 'Estrat√©gias para Redes Sociais',
      copywriting: 'Copywriting Estrat√©gico',
      producao_conteudo: 'Produ√ß√£o de Conte√∫do',
      criativos_anuncios: 'Criativos de An√∫ncios',
      crm_automacoes: 'CRM e Automa√ß√µes',
      processo_comercial: 'Processo Comercial',
      landing_pages: 'Landing Pages',
      website: 'Website',
      padronizacao_visual: 'Padroniza√ß√£o Visual',
      plataforma_mediagrowth: 'Plataforma MediaGrowth'
    };

    async function copiarLinkAprovacao(entregavelId, btnElement) {
      if (!entregavelId) {
        alert('Entreg√°vel n√£o especificado.');
        return;
      }

      // Verificar se existe an√°lise salva para este entreg√°vel
      const userData = USER_DATA || window.USER_DATA || {};
      const analises = userData?.analises || {};
      const analise = analises[entregavelId];

      if (!analise || !analise.insightHtml) {
        alert('Nenhuma an√°lise encontrada para este entreg√°vel. Gere a an√°lise primeiro clicando no bot√£o "An√°lise".');
        return;
      }

      // Mudar visual do bot√£o para loading
      if (btnElement) {
        btnElement.classList.add('loading');
        btnElement.innerHTML = '‚è≥ Gerando...';
      }

      try {
        // Determinar o UID do cliente (para atualizar a an√°lise dele)
        let clientUid;
        if (Array.isArray(clientDocPathParts) && clientDocPathParts.length >= 2) {
          clientUid = clientDocPathParts[1];
        } else {
          clientUid = auth.currentUser?.uid;
        }

        // O UID para as regras do Firebase deve ser o do usu√°rio autenticado atual
        const authUid = auth.currentUser?.uid;

        if (!authUid) {
          throw new Error('Usu√°rio n√£o autenticado');
        }

        // Gerar token √∫nico para o link de aprova√ß√£o
        const token = 'aa_' + Date.now().toString(36) + '_' + Math.random().toString(36).substring(2, 10);

        // Obter nome do cliente se dispon√≠vel
        const clientName = userData?.nome || userData?.empresa || userData?.displayName || '';

        // Criar documento de aprova√ß√£o no Firebase
        // IMPORTANTE: 'uid' deve ser o auth.currentUser.uid para satisfazer as regras
        const approvalData = {
          token: token,
          uid: authUid,
          entregavelId: entregavelId,
          entregavelTitle: ENTREGAVEL_TITLES_COPY[entregavelId] || entregavelId,
          insightHtml: analise.insightHtml,
          generatedAt: analise.generatedAt || new Date().toISOString(),
          userId: clientUid,
          clientName: clientName,
          approved: false,
          approvedAt: null,
          createdAt: new Date().toISOString()
        };

        // Salvar no Firebase
        const approvalRef = doc(db, 'analiseApprovals', token);
        await setDoc(approvalRef, approvalData);

        // Construir URL de aprova√ß√£o
        const baseUrl = window.location.origin;
        const approvalUrl = baseUrl + '/analise-aprovacao.html?token=' + token;

        // Copiar para √°rea de transfer√™ncia com fallback para iframes
        const copiado = await mgCopyToClipboard(approvalUrl);

        // Feedback visual de sucesso
        if (btnElement) {
          btnElement.classList.remove('loading');
          btnElement.classList.add('copied');
          btnElement.innerHTML = copiado ? '‚úÖ Copiado!' : 'üìã Link gerado';
          
          setTimeout(() => {
            btnElement.classList.remove('copied');
            btnElement.innerHTML = 'üîó Copiar Link';
          }, 2500);
        }

        // Toast de confirma√ß√£o
        if(copiado) {
          mostrarToast('Link de aprova√ß√£o copiado! üìã');
        } else {
          prompt('Copie o link de aprova√ß√£o:', approvalUrl);
        }

      } catch (error) {
        console.error('Erro ao gerar link de aprova√ß√£o:', error);
        
        if (btnElement) {
          btnElement.classList.remove('loading');
          btnElement.innerHTML = '‚ùå Erro';
          
          setTimeout(() => {
            btnElement.innerHTML = 'üîó Copiar Link';
          }, 2000);
        }

        alert('Erro ao gerar link de aprova√ß√£o: ' + error.message);
      }
    }

    // ===== FUN√á√ÉO PARA COPIAR LINK DO RELAT√ìRIO COMPLETO =====
    async function copiarLinkRelatorioCompleto(btnElement) {
      // Verificar se existem an√°lises salvas
      const userData = USER_DATA || window.USER_DATA || {};
      const analises = userData?.analises || {};
      
      // Verificar se h√° pelo menos uma an√°lise
      const analisesArray = Object.keys(analises).filter(key => analises[key]?.insightHtml);
      
      if (analisesArray.length === 0) {
        alert('Nenhuma an√°lise encontrada. Gere pelo menos uma an√°lise antes de criar o link de compartilhamento.');
        return;
      }

      // Mudar visual do bot√£o para loading
      if (btnElement) {
        btnElement.classList.add('loading');
        btnElement.innerHTML = '‚è≥ Gerando...';
      }

      try {
        // Determinar o UID do cliente (para atualizar a an√°lise dele)
        let clientUid;
        if (Array.isArray(clientDocPathParts) && clientDocPathParts.length >= 2) {
          clientUid = clientDocPathParts[1];
        } else {
          clientUid = auth.currentUser?.uid;
        }

        // O UID para as regras do Firebase deve ser o do usu√°rio autenticado atual
        const authUid = auth.currentUser?.uid;

        if (!authUid) {
          throw new Error('Usu√°rio n√£o autenticado');
        }

        // Gerar token √∫nico para o link de relat√≥rio
        const token = 'rel_' + Date.now().toString(36) + '_' + Math.random().toString(36).substring(2, 10);

        // Obter dados do cliente
        const clientName = userData?.nome || userData?.empresa || userData?.displayName || 'Cliente';
        const businessData = {
          nome: userData?.nome || '',
          empresa: userData?.empresa || '',
          nicho: userData?.nicho || '',
          publicoAlvo: userData?.publicoAlvo || ''
        };

        // Preparar dados de todas as an√°lises (incluindo m√≠dias tagueadas)
        const analisesData = {};
        
        // Usar Promise.all para buscar m√≠dias tagueadas em paralelo
        await Promise.all(analisesArray.map(async (entregavelId) => {
          const analise = analises[entregavelId];
          
          // Buscar m√≠dias tagueadas para este entreg√°vel
          let midiasTagueadas = [];
          try {
            midiasTagueadas = await buscarMidiasTagueadasPorEntregavel(entregavelId);
          } catch (e) {
            console.warn(`Erro ao buscar m√≠dias para ${entregavelId}:`, e);
          }
          
          // Gerar HTML das m√≠dias tagueadas
          let midiasHtml = '';
          if (midiasTagueadas && midiasTagueadas.length > 0) {
            midiasHtml = gerarSecaoMidiasTagueadas(midiasTagueadas, entregavelId);
          }
          
          analisesData[entregavelId] = {
            insightHtml: analise.insightHtml + midiasHtml,
            generatedAt: analise.generatedAt || new Date().toISOString(),
            title: ENTREGAVEL_TITLES_RELATORIO[entregavelId] || ENTREGAVEL_TITLES_COPY[entregavelId] || entregavelId
          };
        }));

        // Criar documento de relat√≥rio compartilhado no Firebase
        const relatorioData = {
          token: token,
          uid: authUid,
          userId: clientUid,
          clientName: clientName,
          businessData: businessData,
          analises: analisesData,
          totalAnalises: analisesArray.length,
          createdAt: new Date().toISOString()
        };

        // Salvar no Firebase
        const relatorioRef = doc(db, 'relatoriosCompartilhados', token);
        await setDoc(relatorioRef, relatorioData);

        // Construir URL do relat√≥rio compartilhado
        const baseUrl = window.location.origin;
        const relatorioUrl = baseUrl + '/relatorio-compartilhado.html?token=' + token;

        // Copiar para √°rea de transfer√™ncia com fallback para iframes
        const copiado = await mgCopyToClipboard(relatorioUrl);

        // Feedback visual de sucesso
        if (btnElement) {
          btnElement.classList.remove('loading');
          btnElement.classList.add('copied');
          btnElement.innerHTML = copiado ? '‚úÖ Copiado!' : 'üìã Link gerado';
          
          setTimeout(() => {
            btnElement.classList.remove('copied');
            btnElement.innerHTML = 'üîó Copiar Link';
          }, 2500);
        }

        // Toast de confirma√ß√£o
        if(copiado) {
          mostrarToast('Link do relat√≥rio copiado! üìã');
        } else {
          prompt('Copie o link do relat√≥rio:', relatorioUrl);
        }
        console.log('üìã Link do relat√≥rio compartilhado:', relatorioUrl);

      } catch (error) {
        console.error('Erro ao gerar link do relat√≥rio:', error);
        
        if (btnElement) {
          btnElement.classList.remove('loading');
          btnElement.innerHTML = '‚ùå Erro';
          
          setTimeout(() => {
            btnElement.innerHTML = 'üîó Copiar Link';
          }, 2000);
        }

        alert('Erro ao gerar link do relat√≥rio: ' + error.message);
      }
    }

    // Exportar fun√ß√£o globalmente
    window.copiarLinkRelatorioCompleto = copiarLinkRelatorioCompleto;

    // Fun√ß√£o auxiliar para mostrar toast
    function mostrarToast(msg) {
      let toast = document.querySelector('.mg-toast');
      if (!toast) {
        toast = document.createElement('div');
        toast.className = 'mg-toast';
        document.body.appendChild(toast);
      }
      toast.textContent = msg;
      toast.style.display = 'block';
      setTimeout(() => {
        toast.style.display = 'none';
      }, 3000);
    }

    // Exportar fun√ß√£o globalmente
    window.copiarLinkAprovacao = copiarLinkAprovacao;

    // ===== VERIFICAR E MARCAR ENTREG√ÅVEIS APROVADOS PELO CLIENTE =====
    async function verificarEntregaveisAprovados() {
      try {
        const userData = USER_DATA || window.USER_DATA || {};
        const analises = userData?.analises || {};

        // Iterar sobre todos os entreg√°veis e verificar aprova√ß√µes
        for (const entregavelId in analises) {
          const analise = analises[entregavelId];
          if (analise && analise.clientApproved) {
            marcarEntregavelAprovado(entregavelId);
          }
        }
      } catch (error) {
        console.warn('Erro ao verificar entreg√°veis aprovados:', error);
      }
    }

    function marcarEntregavelAprovado(entregavelId) {
      const card = document.querySelector(`.entregavel-card[data-entregavel="${entregavelId}"]`);
      if (card && !card.classList.contains('cliente-aprovado')) {
        card.classList.add('cliente-aprovado');
        console.log(`‚úÖ Entreg√°vel "${entregavelId}" marcado como aprovado pelo cliente`);
      }
    }

    // Exportar fun√ß√µes
    window.verificarEntregaveisAprovados = verificarEntregaveisAprovados;
    window.marcarEntregavelAprovado = marcarEntregavelAprovado;

    // Verificar entreg√°veis aprovados ap√≥s carregar dados do usu√°rio
    setTimeout(() => {
      verificarEntregaveisAprovados();
    }, 3000);

    // ===== RELAT√ìRIO COMPLETO UNIFICADO =====
    
    // Mapeamento de IDs para t√≠tulos dos entreg√°veis
    const ENTREGAVEL_TITLES_RELATORIO = {
      'diagnostico_estrategico': 'Diagn√≥stico Estrat√©gico Completo',
      'direcionamento_metas': 'Direcionamento Estrat√©gico e Metas',
      'analise_concorrencia': 'An√°lise de Concorr√™ncia',
      'matriz_cdt': 'Matriz CDT',
      'puv': 'Proposta √önica de Valor (PUV)',
      'pai': 'Plano de A√ß√£o Inicial (PAI)',
      'anuncios_pagos': 'Estrat√©gia de An√∫ncios Pagos',
      'site_seo': 'Site e SEO Otimizado',
      'redes_sociais': 'Estrat√©gia de Redes Sociais',
      'copywriting': 'Copywriting Estrat√©gico',
      'producao_conteudo': 'Produ√ß√£o de Conte√∫do',
      'criativos_anuncios': 'Criativos para An√∫ncios',
      'crm_automacoes': 'CRM e Automa√ß√µes',
      'processo_comercial': 'Processo Comercial',
      'landing_pages': 'Landing Pages',
      'website': 'Website Profissional',
      'padronizacao_visual': 'Padroniza√ß√£o Visual',
      'plataforma_mediagrowth': 'Plataforma Mediagrowth'
    };

    // Ordem dos entreg√°veis no relat√≥rio
    const ORDEM_ENTREGAVEIS = [
      'diagnostico_estrategico',
      'direcionamento_metas',
      'analise_concorrencia',
      'matriz_cdt',
      'puv',
      'pai',
      'anuncios_pagos',
      'site_seo',
      'redes_sociais',
      'copywriting',
      'producao_conteudo',
      'criativos_anuncios',
      'crm_automacoes',
      'processo_comercial',
      'landing_pages',
      'website',
      'padronizacao_visual',
      'plataforma_mediagrowth'
    ];

    // Mapeamento de imagens dos entreg√°veis
    const ENTREGAVEL_IMAGES = {
      'diagnostico_estrategico': 'assets/entregaveis mediagrwoth/Diagn√≥stico Estrat√©gico Completo.png',
      'direcionamento_metas': 'assets/entregaveis mediagrwoth/Direcionamento Estrat√©gico e Metas.png',
      'analise_concorrencia': 'assets/entregaveis mediagrwoth/An√°lise de Concorr√™ncia e Mercado.png',
      'matriz_cdt': 'assets/entregaveis mediagrwoth/matriz cdt.png',
      'puv': 'assets/entregaveis mediagrwoth/puv Proposta √∫nica de valor.png',
      'pai': 'assets/entregaveis mediagrwoth/p.a.i p√∫blico alvo ideal.png',
      'anuncios_pagos': 'assets/entregaveis mediagrwoth/estrutura√ß√£o  an√∫ncios pagos.png',
      'site_seo': 'assets/entregaveis mediagrwoth/Estrutura√ß√£o  Site & SEO.png',
      'redes_sociais': 'assets/entregaveis mediagrwoth/Estrat√©gias para as  Redes Sociais.png',
      'copywriting': 'assets/entregaveis mediagrwoth/Copywriting Estrat√©gico.png',
      'producao_conteudo': 'assets/entregaveis mediagrwoth/Produ√ß√£o de Conte√∫do Guiada.png',
      'criativos_anuncios': 'assets/entregaveis mediagrwoth/Criativos para  an√∫ncios patrocinados.png',
      'crm_automacoes': 'assets/entregaveis mediagrwoth/acesso CRM e Automa√ß√µes.png',
      'processo_comercial': 'assets/entregaveis mediagrwoth/Estrutura√ß√£o do Processo Comercial.png',
      'landing_pages': 'assets/entregaveis mediagrwoth/Landing pages estrat√©gicas.png',
      'website': 'assets/entregaveis mediagrwoth/Constru√ß√£o ou atualiza√ß√£o de website.png',
      'padronizacao_visual': 'assets/entregaveis mediagrwoth/Padroniza√ß√£o visual  e de comunica√ß√£o.png',
      'plataforma_mediagrowth': 'assets/entregaveis mediagrwoth/_plataforma mediagrowth.png'
    };

    async function abrirRelatorioCompleto() {
      const modal = document.getElementById('relatorioModal');
      const body = document.getElementById('relatorioModalBody');

      // Mostrar loading enquanto carrega
      body.innerHTML = `
        <div class="relatorio-empty">
          <div class="relatorio-empty-icon">‚è≥</div>
          <h4>Carregando an√°lises...</h4>
          <p>Aguarde enquanto buscamos as an√°lises mais recentes.</p>
        </div>
      `;
      modal.classList.add('active');

      try {
        // SEMPRE buscar an√°lises atualizadas do Firebase
        let analises = {};
        
        // Determinar o UID correto
        let targetUid;
        if (Array.isArray(clientDocPathParts) && clientDocPathParts.length >= 2) {
          targetUid = clientDocPathParts[1]; // Admin vendo cliente
        } else if (auth?.currentUser?.uid) {
          targetUid = auth.currentUser.uid;
        }

        if (targetUid && typeof carregarTodasAnalisesFirebase === 'function') {
          console.log('üì• Relat√≥rio: Carregando an√°lises atualizadas do Firebase...');
          analises = await carregarTodasAnalisesFirebase(targetUid);
          console.log('‚úÖ Relat√≥rio: An√°lises carregadas do Firebase:', Object.keys(analises).length);
        } else {
          console.warn('‚ö†Ô∏è Relat√≥rio: N√£o foi poss√≠vel buscar do Firebase, usando cache local');
          // Fallback para cache apenas se n√£o conseguir buscar do Firebase
          let userData = USER_DATA || window.USER_DATA || {};
          analises = userData?.analises || {};
        }

        const userData = USER_DATA || window.USER_DATA || {};
        const clientName = userData?.nome || userData?.empresa || 'Cliente';
      
        // Filtrar apenas an√°lises com conte√∫do
        const analisesDisponiveis = ORDEM_ENTREGAVEIS.filter(id => {
          const analise = analises[id];
          return analise && analise.insightHtml && analise.insightHtml.trim().length > 0;
        });

        if (analisesDisponiveis.length === 0) {
          body.innerHTML = `
            <div class="relatorio-empty">
              <div class="relatorio-empty-icon">üì≠</div>
              <h4>Nenhuma an√°lise encontrada</h4>
              <p>Gere an√°lises nos entreg√°veis clicando no bot√£o "üìä An√°lise" em cada card.</p>
            </div>
          `;
          return;
        }

        // Calcular estat√≠sticas
        const totalEntregaveis = ORDEM_ENTREGAVEIS.length;
        const analisesGeradas = analisesDisponiveis.length;
        const aprovados = analisesDisponiveis.filter(id => analises[id]?.clientApproved).length;
        const dataAtual = new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });

        // Montar HTML do relat√≥rio com capa, sum√°rio e p√°ginas
        let html = `
          <!-- CAPA DO RELAT√ìRIO -->
          <div class="relatorio-capa">
            <div class="relatorio-capa-logo">
              <img src="assets/mediagrowth-logo.svg" alt="Mediagrowth" onerror="this.style.display='none'">
              <span class="relatorio-capa-brand">üìä mediagrowth</span>
            </div>
            <h1 class="relatorio-capa-title">Relat√≥rio Completo de An√°lises</h1>
            <h2 class="relatorio-capa-client">${clientName}</h2>
            <div class="relatorio-capa-date">${dataAtual}</div>
            <div class="relatorio-capa-stats">
              <div class="relatorio-capa-stat">
                <span class="stat-value">${analisesGeradas}</span>
                <span class="stat-label">An√°lises</span>
              </div>
              <div class="relatorio-capa-stat">
                <span class="stat-value">${aprovados}</span>
                <span class="stat-label">Aprovadas</span>
              </div>
              <div class="relatorio-capa-stat">
                <span class="stat-value">${Math.round((analisesGeradas/totalEntregaveis)*100)}%</span>
                <span class="stat-label">Cobertura</span>
              </div>
            </div>
          </div>

          <!-- SUM√ÅRIO -->
          <div class="relatorio-sumario">
            <h2 class="relatorio-sumario-title">üìë Sum√°rio</h2>
            <div class="relatorio-sumario-list">
        `;

        // Adicionar itens do sum√°rio
        analisesDisponiveis.forEach((entregavelId, index) => {
          const titulo = ENTREGAVEL_TITLES_RELATORIO[entregavelId] || entregavelId;
          const aprovadoBadge = analises[entregavelId]?.clientApproved ? ' ‚úÖ' : '';
          html += `
              <a href="#relatorio-secao-${entregavelId}" class="relatorio-sumario-item">
                <span class="sumario-numero">${index + 1}</span>
                <span class="sumario-titulo">${titulo}${aprovadoBadge}</span>
                <span class="sumario-dots"></span>
                <span class="sumario-pagina">P√°g. ${index + 1}</span>
              </a>
          `;
        });

        html += `
            </div>
          </div>
        `;

        // Adicionar cada an√°lise com imagem em TELA CHEIA
        analisesDisponiveis.forEach((entregavelId, index) => {
          const analise = analises[entregavelId];
          const titulo = ENTREGAVEL_TITLES_RELATORIO[entregavelId] || entregavelId;
          const imagem = ENTREGAVEL_IMAGES[entregavelId] || '';
          const dataGeracao = analise.generatedAt ? new Date(analise.generatedAt).toLocaleDateString('pt-BR') : '';
          const aprovadoCliente = analise.clientApproved ? `<div class="relatorio-chapter-badge">‚úÖ Aprovado pelo Cliente</div>` : '';

          html += `
            <div class="relatorio-section relatorio-page" id="relatorio-secao-${entregavelId}">
              <div class="relatorio-page-number">P√°gina ${index + 1} de ${analisesGeradas}</div>
              
              <!-- CAPA DO CAP√çTULO - IMAGEM TELA CHEIA -->
              <div class="relatorio-chapter-cover">
                ${imagem ? `<img src="${imagem}" alt="${titulo}" class="relatorio-chapter-image">` : ''}
                <div class="relatorio-chapter-info">
                  <div class="relatorio-chapter-number">${index + 1}</div>
                  <h2 class="relatorio-chapter-title">${titulo}</h2>
                  ${dataGeracao ? `<span class="relatorio-chapter-date">Gerado em ${dataGeracao}</span>` : ''}
                  ${aprovadoCliente}
                </div>
              </div>
              
              <!-- Conte√∫do da an√°lise -->
              <div class="analise-insight-content" style="background:rgba(15,23,42,.4);border-radius:12px;padding:24px;margin-top:20px;">
                ${analise.insightHtml}
              </div>
            </div>
          `;
        });

        body.innerHTML = html;

      } catch (error) {
        console.error('Erro ao carregar relat√≥rio:', error);
        body.innerHTML = `
          <div class="relatorio-empty">
            <div class="relatorio-empty-icon">‚ùå</div>
            <h4>Erro ao carregar an√°lises</h4>
            <p>${error.message}</p>
          </div>
        `;
      }
    }

    function fecharRelatorioModal() {
      const modal = document.getElementById('relatorioModal');
      modal.classList.remove('active');
    }

    // Carregar html2pdf se n√£o existir
    function carregarHtml2Pdf() {
      return new Promise((resolve, reject) => {
        if (window.html2pdf) {
          resolve();
          return;
        }
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    async function baixarRelatorioPDF() {
      // Refer√™ncia robusta aos bot√µes
      const btns = Array.from(document.querySelectorAll('.btn-relatorio-pdf'));
      const originalHTML = '<span>üì•</span> Baixar PDF';
      
      // Fun√ß√£o para restaurar bot√µes
      const restaurarBotoes = () => {
        btns.forEach(btn => {
          btn.disabled = false;
          btn.innerHTML = originalHTML;
        });
      };
      
      // Mostrar loading nos bot√µes
      btns.forEach(btn => {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Gerando...';
      });

      try {
        // SEMPRE buscar an√°lises atualizadas do Firebase
        let analises = {};
        
        let targetUid;
        if (Array.isArray(clientDocPathParts) && clientDocPathParts.length >= 2) {
          targetUid = clientDocPathParts[1];
        } else if (auth?.currentUser?.uid) {
          targetUid = auth.currentUser.uid;
        }

        if (targetUid && typeof carregarTodasAnalisesFirebase === 'function') {
          console.log('üì• PDF: Carregando an√°lises atualizadas do Firebase...');
          analises = await carregarTodasAnalisesFirebase(targetUid);
          console.log('‚úÖ PDF: An√°lises carregadas do Firebase:', Object.keys(analises).length);
        } else {
          console.warn('‚ö†Ô∏è PDF: N√£o foi poss√≠vel buscar do Firebase, usando cache local');
          // Fallback para cache apenas se n√£o conseguir buscar do Firebase
          let userData = USER_DATA || window.USER_DATA || {};
          analises = userData?.analises || {};
        }

        const userData = USER_DATA || window.USER_DATA || {};
        const clientName = userData?.nome || userData?.empresa || 'Cliente';
      
        // Filtrar apenas an√°lises com conte√∫do
        const analisesDisponiveis = ORDEM_ENTREGAVEIS.filter(id => {
          const analise = analises[id];
          return analise && analise.insightHtml && analise.insightHtml.trim().length > 0;
        });

        if (analisesDisponiveis.length === 0) {
          alert('Nenhuma an√°lise encontrada para gerar o PDF. Gere an√°lises nos entreg√°veis primeiro.');
          restaurarBotoes();
          return;
        }

        // Estat√≠sticas
        const dataAtual = new Date().toLocaleDateString('pt-BR');
        const aprovados = analisesDisponiveis.filter(id => analises[id]?.clientApproved).length;
        const totalEntregaveis = ORDEM_ENTREGAVEIS.length;

        // Gerar sum√°rio
        let sumarioHtml = '';
        analisesDisponiveis.forEach((entregavelId, index) => {
          const titulo = ENTREGAVEL_TITLES_RELATORIO[entregavelId] || entregavelId;
          const aprovadoBadge = analises[entregavelId]?.clientApproved ? ' ‚úì' : '';
          sumarioHtml += `<div style="padding:8px 0;border-bottom:1px dotted #ddd;display:flex;justify-content:space-between;"><span>${index + 1}. ${titulo}${aprovadoBadge}</span><span>P√°g. ${index + 2}</span></div>`;
        });

        // Gerar conte√∫do das an√°lises
        let analisesHtml = '';
        analisesDisponiveis.forEach((entregavelId, index) => {
          const analise = analises[entregavelId];
          const titulo = ENTREGAVEL_TITLES_RELATORIO[entregavelId] || entregavelId;
          const imagem = ENTREGAVEL_IMAGES[entregavelId] || '';
          const dataGeracao = analise.generatedAt ? new Date(analise.generatedAt).toLocaleDateString('pt-BR') : '';
          const aprovadoBadge = analise.clientApproved ? '<span style="background:#22c55e;color:#fff;padding:4px 12px;border-radius:12px;font-size:10pt;margin-left:10px;">‚úì Aprovado</span>' : '';

          analisesHtml += `
            <div style="page-break-before:always;padding-top:30px;">
              <!-- Capa do Cap√≠tulo -->
              <div style="text-align:center;padding:40px 20px;margin-bottom:30px;background:linear-gradient(135deg,#f0fdf4,#e0f2fe);border-radius:16px;border:1px solid #d1fae5;">
                ${imagem ? `<img src="${imagem}" style="max-width:300px;max-height:300px;margin-bottom:24px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.15);">` : ''}
                <div style="background:#f97316;color:#fff;width:50px;height:50px;border-radius:12px;display:inline-flex;align-items:center;justify-content:center;font-size:22pt;font-weight:800;margin-bottom:16px;">${index + 1}</div>
                <h2 style="font-size:20pt;color:#1e3a5f;margin:0 0 8px 0;">${titulo}${aprovadoBadge}</h2>
                ${dataGeracao ? `<div style="font-size:10pt;color:#666;">Gerado em ${dataGeracao}</div>` : ''}
              </div>
              
              <!-- Conte√∫do da An√°lise -->
              <div style="background:#fafafa;border:1px solid #e5e5e5;border-radius:12px;padding:24px;line-height:1.8;">
                ${analise.insightHtml}
              </div>
            </div>
          `;
        });

        // Montar HTML completo do PDF
        const htmlContent = `
          <!DOCTYPE html>
          <html lang="pt-BR">
          <head>
            <meta charset="UTF-8">
            <title>Relat√≥rio de An√°lises - ${clientName}</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body { 
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                font-size: 11pt;
                line-height: 1.6;
                color: #1f2937;
                padding: 40px;
                max-width: 210mm;
                margin: 0 auto;
              }
              h1, h2, h3, h4 { color: #1f2937; margin-top: 20px; margin-bottom: 10px; page-break-after: avoid; }
              h1 { font-size: 18pt; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px; }
              h2 { font-size: 16pt; color: #374151; }
              h3 { font-size: 14pt; color: #4b5563; }
              h4 { font-size: 12pt; color: #6b7280; }
              p { margin-bottom: 10px; text-align: justify; }
              ul, ol { margin: 10px 0 10px 24px; }
              li { margin-bottom: 5px; }
              strong { color: #059669; }
              table { width: 100%; border-collapse: collapse; margin: 16px 0; font-size: 10pt; }
              table th, table td { border: 1px solid #d1d5db; padding: 8px 10px; text-align: left; }
              table th { background: #6366f1; color: #fff; font-weight: 600; }
              table tr:nth-child(even) { background: #f9fafb; }
              blockquote { border-left: 4px solid #f97316; padding-left: 16px; margin: 16px 0; color: #4b5563; font-style: italic; }
              img { max-width: 100%; height: auto; border-radius: 8px; }
              @media print {
                body { padding: 20px; }
                h1, h2, h3 { page-break-after: avoid; }
                table, pre, blockquote { page-break-inside: avoid; }
              }
            </style>
          </head>
          <body>
            <!-- CAPA -->
            <div style="text-align:center;min-height:85vh;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:40px;">
              <div style="font-size:24pt;font-weight:700;color:#f97316;margin-bottom:20px;">üìä MEDIAGROWTH</div>
              <h1 style="font-size:26pt;color:#1e3a5f;margin-bottom:16px;border:none;">Relat√≥rio Completo de An√°lises</h1>
              <div style="font-size:18pt;color:#374151;margin-bottom:8px;">${clientName}</div>
              <div style="font-size:12pt;color:#6b7280;margin-bottom:40px;">Gerado em ${dataAtual}</div>
              <div style="display:flex;gap:30px;justify-content:center;margin-top:20px;">
                <div style="text-align:center;padding:20px 30px;background:#f0fdf4;border-radius:12px;border:1px solid #d1fae5;">
                  <div style="font-size:28pt;font-weight:800;color:#22c55e;">${analisesDisponiveis.length}</div>
                  <div style="font-size:10pt;color:#666;text-transform:uppercase;">An√°lises</div>
                </div>
                <div style="text-align:center;padding:20px 30px;background:#f0fdf4;border-radius:12px;border:1px solid #d1fae5;">
                  <div style="font-size:28pt;font-weight:800;color:#22c55e;">${aprovados}</div>
                  <div style="font-size:10pt;color:#666;text-transform:uppercase;">Aprovadas</div>
                </div>
                <div style="text-align:center;padding:20px 30px;background:#f0fdf4;border-radius:12px;border:1px solid #d1fae5;">
                  <div style="font-size:28pt;font-weight:800;color:#22c55e;">${Math.round((analisesDisponiveis.length/totalEntregaveis)*100)}%</div>
                  <div style="font-size:10pt;color:#666;text-transform:uppercase;">Cobertura</div>
                </div>
              </div>
            </div>

            <!-- SUM√ÅRIO -->
            <div style="page-break-before:always;padding:40px 0;">
              <h2 style="font-size:18pt;color:#22c55e;margin-bottom:24px;padding-bottom:12px;border-bottom:2px solid #22c55e;">üìë Sum√°rio</h2>
              ${sumarioHtml}
            </div>

            <!-- AN√ÅLISES -->
            ${analisesHtml}

            <!-- FOOTER -->
            <div style="page-break-before:always;text-align:center;padding:60px 40px;">
              <div style="font-size:16pt;color:#f97316;margin-bottom:16px;">üìä MEDIAGROWTH</div>
              <p style="color:#666;">Relat√≥rio gerado automaticamente pela plataforma Mediagrowth</p>
              <p style="color:#22c55e;font-weight:600;">www.mediagrowth.com.br</p>
              <p style="color:#999;font-size:10pt;margin-top:20px;">${dataAtual} ‚Ä¢ Este documento √© confidencial</p>
            </div>
          </body>
          </html>
        `;

        // Abrir janela de impress√£o para salvar como PDF (mesmo m√©todo que funciona nos entreg√°veis)
        const nomeArquivo = `Relatorio_Analises_${clientName.replace(/\s+/g, '_')}_${dataAtual.replace(/\//g, '-')}`;
        
        const printWindow = window.open('', '_blank', 'width=900,height=700');
        if (printWindow) {
          printWindow.document.write(htmlContent);
          printWindow.document.close();
          printWindow.document.title = `Relat√≥rio de An√°lises - ${clientName}`;
          
          // Aguardar carregar e abrir di√°logo de impress√£o
          printWindow.onload = () => {
            setTimeout(() => {
              printWindow.print();
            }, 500);
          };
          
          mostrarToast('üìÑ Use "Salvar como PDF" na janela de impress√£o!');
        } else {
          // Fallback: Download como HTML
          const blob = new Blob([htmlContent], { type: 'text/html' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${nomeArquivo}.html`;
          a.click();
          URL.revokeObjectURL(url);
          mostrarToast('üìÑ Arquivo baixado como HTML. Abra e salve como PDF.');
        }

        restaurarBotoes();

      } catch (error) {
        console.error('‚ùå Erro ao gerar PDF:', error);
        alert('Erro ao gerar PDF: ' + error.message);
        restaurarBotoes();
      }
    }

    // Fechar modal ao clicar fora
    document.addEventListener('click', function(e) {
      const modal = document.getElementById('relatorioModal');
      if (e.target === modal) {
        fecharRelatorioModal();
      }
    });

    // Exportar fun√ß√µes globalmente
    window.abrirRelatorioCompleto = abrirRelatorioCompleto;
    window.fecharRelatorioModal = fecharRelatorioModal;
    window.baixarRelatorioPDF = baixarRelatorioPDF;

    // Event listeners do modal de an√°lise
    // üîí VARI√ÅVEL GLOBAL para evitar m√∫ltiplos event listeners
    let analiseModalListenersSetup = false;

    document.addEventListener('DOMContentLoaded', function() {
      // ‚ö†Ô∏è CRITICAL: Prevenir m√∫ltiplos event listeners
      if (analiseModalListenersSetup) {
        console.log('‚ö†Ô∏è Event listeners de an√°lise j√° configurados - pulando duplica√ß√£o');
        return;
      }
      analiseModalListenersSetup = true;

      const modal = document.getElementById('analiseModal');
      const closeBtn = document.getElementById('analiseCloseBtn');
      const regenerateBtn = document.getElementById('analiseRegenerateBtn');
      
      // Event listeners do modal de instru√ß√µes
      const instructionsModal = document.getElementById('regenerateInstructionsModal');
      const instructionsCloseBtn = document.getElementById('regenerateCloseBtn');
      const instructionsCancelBtn = document.getElementById('regenerateCancelBtn');
      const instructionsConfirmBtn = document.getElementById('regenerateConfirmBtn');
      
      if (instructionsCloseBtn) {
        instructionsCloseBtn.addEventListener('click', fecharModalInstrucoes, { once: false });
      }
      
      if (instructionsCancelBtn) {
        instructionsCancelBtn.addEventListener('click', fecharModalInstrucoes, { once: false });
      }
      
      if (instructionsConfirmBtn) {
        instructionsConfirmBtn.addEventListener('click', executarRegeneracao, { once: false });
      }
      
      // Fechar modal ao clicar fora
      if (instructionsModal) {
        instructionsModal.addEventListener('click', (e) => {
          if (e.target === instructionsModal) {
            fecharModalInstrucoes();
          }
        }, { once: false });
      }
      
      // Permitir Enter + Ctrl para confirmar
      const instructionsInput = document.getElementById('regenerateInstructionsInput');
      if (instructionsInput) {
        instructionsInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && e.ctrlKey) {
            executarRegeneracao();
          }
        }, { once: false });
      }

      if (closeBtn) {
        closeBtn.addEventListener('click', () => {
          modal.classList.remove('show');
          destroyAnaliseCharts();
        }, { once: false });
      }

      // Event listener para bot√£o "Gerar Novamente" (apenas uma vez)
      if (regenerateBtn) {
        regenerateBtn.addEventListener('click', regenerarAnalise, { once: false });
      }

      // Fechar modal ao clicar fora
      if (modal) {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.classList.remove('show');
            destroyAnaliseCharts();
          }
        });
      }

      // Event listeners para edi√ß√£o de an√°lise
      const editBtn = document.getElementById('analiseEditBtn');
      const saveBtn = document.getElementById('analiseSaveBtn');
      const cancelBtn = document.getElementById('analiseCancelBtn');
      const editor = document.getElementById('analiseInsightEditor');
      const insightContent = document.getElementById('analiseInsightContent');

      // Vari√°vel para guardar o conte√∫do original antes de editar
      let conteudoOriginal = '';

      if (editBtn) {
        editBtn.addEventListener('click', (e) => {
          e.preventDefault();
          if (insightContent) {
            // Guardar posi√ß√£o do scroll antes de editar
            const analiseBody = document.querySelector('.analise-body');
            const scrollPosition = analiseBody ? analiseBody.scrollTop : 0;
            
            // Guardar conte√∫do original para caso de cancelar
            conteudoOriginal = insightContent.innerHTML;
            // Tornar o conte√∫do edit√°vel diretamente (inline)
            insightContent.setAttribute('contenteditable', 'true');
            insightContent.style.outline = '2px solid #6366f1';
            insightContent.style.borderRadius = '10px';
            insightContent.style.padding = '16px';
            insightContent.style.backgroundColor = 'rgba(99,102,241,0.1)';
            
            // N√ÉO dar focus para n√£o pular a posi√ß√£o do scroll
            // insightContent.focus();
            
            // Restaurar posi√ß√£o do scroll
            if (analiseBody) {
              setTimeout(() => {
                analiseBody.scrollTop = scrollPosition;
              }, 0);
            }
            
            // Mostrar bot√µes de salvar/cancelar, esconder editar
            editBtn.style.display = 'none';
            if (saveBtn) saveBtn.style.display = 'inline-flex';
            if (cancelBtn) cancelBtn.style.display = 'inline-flex';
          }
        });
      }

      if (saveBtn) {
        saveBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          if (insightContent) {
            // Guardar posi√ß√£o do scroll
            const analiseBody = document.querySelector('.analise-body');
            const scrollPosition = analiseBody ? analiseBody.scrollTop : 0;
            
            // Parar edi√ß√£o inline
            insightContent.setAttribute('contenteditable', 'false');
            insightContent.style.outline = 'none';
            insightContent.style.backgroundColor = 'transparent';
            
            // Limpar HTML dos wrappers de bloco antes de salvar
            const novoConteudo = limparHtmlParaPDF(insightContent.innerHTML);
            
            // Salvar no Firebase se houver entreg√°vel atual
            if (window.currentEntregavelId) {
              try {
                // Carregar an√°lise existente e atualizar apenas o insight
                const analiseExistente = window.USER_DATA?.analises?.[window.currentEntregavelId] || {};
                const analiseAtualizada = {
                  ...analiseExistente,
                  insightHtml: novoConteudo,
                  editadoEm: new Date().toISOString()
                };
                
                const saved = await salvarAnaliseFirebase(window.currentEntregavelId, analiseAtualizada);
                if (saved) {
                  console.log('‚úÖ An√°lise editada e salva no Firebase');
                  showToast('An√°lise salva com sucesso!', 'success');
                } else {
                  showToast('Erro ao salvar. Tente novamente.', 'error');
                }
              } catch (error) {
                console.error('Erro ao salvar edi√ß√£o:', error);
                showToast('Erro ao salvar. Tente novamente.', 'error');
              }
            }
            
            // Voltar ao modo de visualiza√ß√£o
            if (editBtn) editBtn.style.display = 'inline-flex';
            saveBtn.style.display = 'none';
            if (cancelBtn) cancelBtn.style.display = 'none';
            
            // Restaurar posi√ß√£o do scroll
            if (analiseBody) {
              setTimeout(() => { analiseBody.scrollTop = scrollPosition; }, 0);
            }
          }
        });
      }

      if (cancelBtn) {
        cancelBtn.addEventListener('click', (e) => {
          e.preventDefault();
          if (insightContent) {
            // Guardar posi√ß√£o do scroll
            const analiseBody = document.querySelector('.analise-body');
            const scrollPosition = analiseBody ? analiseBody.scrollTop : 0;
            
            // Restaurar conte√∫do original e sair do modo de edi√ß√£o
            insightContent.innerHTML = conteudoOriginal;
            insightContent.setAttribute('contenteditable', 'false');
            insightContent.style.outline = 'none';
            insightContent.style.backgroundColor = 'transparent';
            // Voltar aos bot√µes normais
            if (editBtn) editBtn.style.display = 'inline-flex';
            if (saveBtn) saveBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
            
            // Restaurar posi√ß√£o do scroll
            if (analiseBody) {
              setTimeout(() => {
                analiseBody.scrollTop = scrollPosition;
              }, 0);
            }
          }
        });
      }

      // Event listener para bot√£o de download PDF
      const pdfBtn = document.getElementById('analisePdfBtn');
      if (pdfBtn) {
        pdfBtn.addEventListener('click', async () => {
          await downloadAnalisePDF();
        });
      }
    });

    // Fun√ß√£o para gerar e baixar PDF da an√°lise
    async function downloadAnalisePDF() {
      const pdfBtn = document.getElementById('analisePdfBtn');
      const insightContent = document.getElementById('analiseInsightContent');
      const modalTitle = document.querySelector('.analise-header h2');
      
      if (!insightContent) {
        showToast('Nenhuma an√°lise para exportar', 'error');
        return;
      }
      
      // Mudar bot√£o para loading
      const originalText = pdfBtn.innerHTML;
      pdfBtn.innerHTML = '‚è≥ Gerando...';
      pdfBtn.disabled = true;
      
      try {
        // Obter t√≠tulo do entreg√°vel - usar o ENTREGAVEL_MAPPING para pegar o t√≠tulo correto
        const entregavelId = window.currentEntregavelId || '';
        let title = 'An√°lise Estrat√©gica';
        
        // Tentar obter do ENTREGAVEL_MAPPING primeiro (mais confi√°vel)
        if (entregavelId && typeof ENTREGAVEL_MAPPING !== 'undefined' && ENTREGAVEL_MAPPING[entregavelId]) {
          title = ENTREGAVEL_MAPPING[entregavelId].title;
        } else if (modalTitle?.textContent?.trim()) {
          // Fallback para o t√≠tulo do modal
          title = modalTitle.textContent.trim()
            .replace('üìä An√°lise:', '')
            .replace('üìä', '')
            .replace('An√°lise:', '')
            .trim();
        }
        
        // Obter nome do neg√≥cio do Contexto do Neg√≥cio (prioridade) ou fallback para TENANT
        const businessInfo = ESTRUTURACAO_STATE?.businessInfo || {};
        const clientName = businessInfo.name || TENANT || 'Cliente';
        const dataAtual = new Date().toLocaleDateString('pt-BR');
        
        // Criar conte√∫do HTML para o PDF
        const htmlContent = `
          <!DOCTYPE html>
          <html lang="pt-BR">
          <head>
            <meta charset="UTF-8">
            <title>${title} - ${clientName}</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body { 
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                font-size: 11pt;
                line-height: 1.6;
                color: #1f2937;
                padding: 40px;
                max-width: 210mm;
                margin: 0 auto;
              }
              .header {
                text-align: center;
                padding-bottom: 20px;
                margin-bottom: 30px;
                border-bottom: 3px solid #ff6600;
              }
              .header h1 {
                font-size: 22pt;
                color: #1f2937;
                margin-bottom: 8px;
              }
              .header .subtitle {
                font-size: 12pt;
                color: #6b7280;
              }
              .header .meta {
                font-size: 10pt;
                color: #9ca3af;
                margin-top: 10px;
              }
              .logo-text {
                font-size: 14pt;
                font-weight: bold;
                color: #ff6600;
                margin-bottom: 15px;
              }
              .content {
                line-height: 1.8;
              }
              .content h1, .content h2, .content h3, .content h4 {
                color: #1f2937;
                margin-top: 24px;
                margin-bottom: 12px;
                page-break-after: avoid;
              }
              .content h1 { font-size: 18pt; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px; }
              .content h2 { font-size: 16pt; color: #374151; }
              .content h3 { font-size: 14pt; color: #4b5563; }
              .content h4 { font-size: 12pt; color: #6b7280; }
              .content p { margin-bottom: 12px; text-align: justify; }
              .content ul, .content ol { margin: 12px 0 12px 24px; }
              .content li { margin-bottom: 6px; }
              .content strong { color: #111827; }
              .content table {
                width: 100%;
                border-collapse: collapse;
                margin: 16px 0;
                font-size: 10pt;
              }
              .content table th, .content table td {
                border: 1px solid #d1d5db;
                padding: 8px 12px;
                text-align: left;
              }
              .content table th {
                background: #f3f4f6;
                font-weight: 600;
                color: #374151;
              }
              .content table tr:nth-child(even) {
                background: #f9fafb;
              }
              .content blockquote {
                border-left: 4px solid #ff6600;
                padding-left: 16px;
                margin: 16px 0;
                color: #4b5563;
                font-style: italic;
              }
              .footer {
                margin-top: 40px;
                padding-top: 20px;
                border-top: 1px solid #e5e7eb;
                text-align: center;
                font-size: 9pt;
                color: #9ca3af;
              }
              @media print {
                body { padding: 20px; }
                .header { page-break-after: avoid; }
                h1, h2, h3 { page-break-after: avoid; }
                table, pre { page-break-inside: avoid; }
              }
            </style>
          </head>
          <body>
            <div class="header">
              <div class="logo-text">MEDIAGROWTH</div>
              <h1>${title}</h1>
              <div class="subtitle">Relat√≥rio de An√°lise Estrat√©gica</div>
              <div class="meta">Cliente: ${clientName} | Data: ${dataAtual}</div>
            </div>
            <div class="content">
              ${limparHtmlParaPDF(insightContent.innerHTML)}
            </div>
            <div class="footer">
              <p>Relat√≥rio gerado automaticamente por Mediagrowth Dashboard</p>
              <p>${dataAtual} ‚Ä¢ Este documento √© confidencial</p>
            </div>
          </body>
          </html>
        `;
        
        // Abrir janela de impress√£o para salvar como PDF
        // Criar nome de arquivo limpo e descritivo
        const nomeArquivoLimpo = title
          .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Remove acentos
          .replace(/[^a-zA-Z0-9\s]/g, '') // Remove caracteres especiais
          .replace(/\s+/g, '_') // Espa√ßos para underscore
          .substring(0, 50); // Limitar tamanho
        const nomeArquivo = `${nomeArquivoLimpo}_${clientName}_${dataAtual.replace(/\//g, '-')}`;
        
        const printWindow = window.open('', '_blank', `width=900,height=700`);
        if (printWindow) {
          printWindow.document.write(htmlContent);
          printWindow.document.close();
          
          // Definir t√≠tulo da janela (aparece como sugest√£o de nome do PDF)
          printWindow.document.title = `${title} - ${clientName}`;
          
          // Aguardar carregar e abrir di√°logo de impress√£o
          printWindow.onload = () => {
            setTimeout(() => {
              printWindow.print();
            }, 250);
          };
          
          showToast(`üìÑ Salve como PDF com o nome: "${title}"`, 'success');
        } else {
          // Fallback: Download como HTML
          const blob = new Blob([htmlContent], { type: 'text/html' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${nomeArquivo}.html`;
          a.click();
          URL.revokeObjectURL(url);
          showToast(`üìÑ Arquivo "${title}" baixado como HTML`, 'success');
        }
        
      } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        showToast('Erro ao gerar PDF', 'error');
      } finally {
        pdfBtn.innerHTML = originalText;
        pdfBtn.disabled = false;
      }
    }
    
    // For√ßar blur em campos de input ativos na estrutura√ß√£o antes de rerender
    function blurActiveEstruturacaoFields(){
      const weeksContainer = document.getElementById('estruturacaoWeeks');
      if(!weeksContainer) return;
      
      // For√ßar blur em todos os campos de input e contenteditable ativos
      const activeElement = document.activeElement;
      if(activeElement && weeksContainer.contains(activeElement)){
        if(activeElement.tagName === 'INPUT' || 
           activeElement.tagName === 'TEXTAREA' || 
           activeElement.isContentEditable){
          activeElement.blur();
          console.log('[Estrutura√ß√£o] Blur for√ßado no campo ativo antes de rerender');
        }
      }
    }

    function renderEstruturacao(){
      // For√ßar salvamento de campos ativos antes de rerender
      blurActiveEstruturacaoFields();
      
      loadEstruturacaoFromUserData();
      loadBusinessInfo(); // Carregar informa√ß√µes do neg√≥cio
      initBusinessInfoAutoSave(); // Inicializar auto-save
      
      const weeksContainer = document.getElementById('estruturacaoWeeks');
      const progressFill = document.getElementById('estruturacaoProgressFill');
      const progressText = document.getElementById('estruturacaoProgressText');
      const progressCount = document.getElementById('estruturacaoProgressCount');
      
      // Salvar estado do filtro de busca antes de recriar o DOM
      const searchInput = document.getElementById('estruturacaoSearchInput');
      const savedSearchQuery = searchInput ? searchInput.value : '';
      
      if(!weeksContainer) return;
      
      const progress = calculateProgress();
      if(progressFill) progressFill.style.width = `${progress.percentage}%`;
      if(progressText) progressText.textContent = `${progress.percentage}% conclu√≠do`;
      if(progressCount) progressCount.textContent = `${progress.completed} de ${progress.total} itens`;
      
      // Salvar estado de quais weeks est√£o abertas antes de recriar
      const openWeeks = new Set();
      const openBlocks = new Map(); // Map<weekIdx, Set<blockIdx>>
      const openItems = new Map(); // Map<"weekIdx-blockIdx", Set<itemIdx>>
      const existingWeeks = weeksContainer.querySelectorAll('.estruturacao-week');
      existingWeeks.forEach((weekEl, weekIdx) => {
        if(weekEl.classList.contains('open')){
          openWeeks.add(weekIdx);
        }
        // Salvar blocos abertos dentro desta week
        const blocks = weekEl.querySelectorAll('.estruturacao-block');
        blocks.forEach((blockEl, blockIdx) => {
          if(blockEl.classList.contains('open')){
            if(!openBlocks.has(weekIdx)){
              openBlocks.set(weekIdx, new Set());
            }
            openBlocks.get(weekIdx).add(blockIdx);
          }
          // Salvar itens abertos dentro deste bloco
          const items = blockEl.querySelectorAll('.estruturacao-item.open');
          if(items.length > 0){
            const itemIndices = new Set();
            items.forEach((itemEl) => {
              const allItems = Array.from(blockEl.querySelectorAll('.estruturacao-item'));
              const realIdx = allItems.indexOf(itemEl);
              if(realIdx !== -1) itemIndices.add(realIdx);
            });
            if(itemIndices.size > 0){
              openItems.set(`${weekIdx}-${blockIdx}`, itemIndices);
            }
          }
        });
      });
      
      weeksContainer.innerHTML = '';
      
      ESTRUTURACAO_DATA.forEach((week, weekIdx) => {
        // Garantir que weekState existe com estrutura correta
        if(!ESTRUTURACAO_STATE[week.id]) {
          ESTRUTURACAO_STATE[week.id] = { blocks: {}, weekData: { note: '', files: [], checklist: [] } };
        }
        if(!ESTRUTURACAO_STATE[week.id].weekData) {
          ESTRUTURACAO_STATE[week.id].weekData = { note: '', files: [], checklist: [] };
        }
        
        const weekState = ESTRUTURACAO_STATE[week.id];
        
        let weekTotal = 0;
        let weekCompleted = 0;
        week.blocks.forEach(block => {
          weekTotal += block.items.length;
          const blockState = weekState.blocks[block.id];
          if(blockState){
            block.items.forEach((_, idx) => {
              if(blockState.items?.[idx]?.completed) weekCompleted++;
            });
          }
        });
        
        const weekProgress = weekTotal > 0 ? Math.round((weekCompleted / weekTotal) * 100) : 0;
        const isCompleted = weekProgress === 100;
        
        // Estado da semana (note, files, checklist) - USAR REFER√äNCIA DIRETA
        const weekDataState = weekState.weekData;
        const weekHasContent = weekDataState.note || (weekDataState.files && weekDataState.files.length > 0) || (weekDataState.checklist && weekDataState.checklist.length > 0);
        
        // Gerar HTML dos disclaimers
        const disclaimers = ESTRUTURACAO_DISCLAIMERS[week.id];
        const disclaimersHtml = disclaimers ? `
          <div class="estruturacao-disclaimers">
            <div class="estruturacao-disclaimer-icon icon-explain" title="Explica√ß√£o">
              üìò
              <div class="estruturacao-disclaimer-tooltip tooltip-explain">
                <div class="estruturacao-disclaimer-tooltip-title">üìò ${disclaimers.explain.title.replace('üìò ', '')}</div>
                <div class="estruturacao-disclaimer-tooltip-content">${disclaimers.explain.content}</div>
              </div>
            </div>
            <div class="estruturacao-disclaimer-icon icon-warning" title="Aviso">
              ‚ö†Ô∏è
              <div class="estruturacao-disclaimer-tooltip tooltip-warning">
                <div class="estruturacao-disclaimer-tooltip-title">‚ö†Ô∏è ${disclaimers.warning.title.replace('‚ö†Ô∏è ', '')}</div>
                <div class="estruturacao-disclaimer-tooltip-content">${disclaimers.warning.content}</div>
              </div>
            </div>
            <div class="estruturacao-disclaimer-icon icon-importance" title="Import√¢ncia">
              üéØ
              <div class="estruturacao-disclaimer-tooltip tooltip-importance">
                <div class="estruturacao-disclaimer-tooltip-title">üéØ ${disclaimers.importance.title.replace('üéØ ', '')}</div>
                <div class="estruturacao-disclaimer-tooltip-content">${disclaimers.importance.content}</div>
              </div>
            </div>
          </div>
        ` : '';
        
        const weekEl = document.createElement('div');
        // Restaurar estado de abertura se estava aberto antes
        const wasOpen = openWeeks.has(weekIdx);
        weekEl.className = `estruturacao-week ${isCompleted ? 'completed' : ''} ${wasOpen ? 'open' : ''}`;
        weekEl.dataset.weekId = week.id;
        
        // Preparar conte√∫do da nota da semana (se existir)
        const weekNoteHtml = weekDataState.note && typeof renderMarkdownText === 'function' ? renderMarkdownText(weekDataState.note) : (weekDataState.note || '');
        const weekNoteRaw = weekDataState.note || '';
        
        weekEl.innerHTML = `
          <div class="estruturacao-week-header">
            <div class="estruturacao-week-badge">${weekIdx + 1}</div>
            <div class="estruturacao-week-info">
              <h3 class="estruturacao-week-title">${week.title}</h3>
              <p class="estruturacao-week-desc">${week.subtitle}</p>
            </div>
            ${disclaimersHtml}
            <div class="estruturacao-week-progress">
              <span>${weekCompleted}/${weekTotal}</span>
              <div class="estruturacao-week-progress-mini">
                <div class="estruturacao-week-progress-mini-fill" style="width:${weekProgress}%"></div>
              </div>
            </div>
            <span class="estruturacao-week-chevron">‚ñæ</span>
          </div>
          <div class="estruturacao-week-body">
            <div class="estruturacao-week-content">
              <!-- √Årea de extras da semana: Notas, Arquivos e Checklist -->
              <div class="estruturacao-week-extras">
                <div class="estruturacao-week-actions">
                  <button class="estruturacao-week-action-btn ${weekDataState.note ? 'active' : ''}" data-action="toggle-week-note">üìù Bloco de Notas</button>
                  <button class="estruturacao-week-action-btn ${weekDataState.files && weekDataState.files.length > 0 ? 'active' : ''}" data-action="toggle-week-files">üóÇÔ∏è Arquivos (${weekDataState.files?.length || 0})</button>
                  <button class="estruturacao-week-action-btn ${weekDataState.checklist && weekDataState.checklist.length > 0 ? 'active' : ''}" data-action="toggle-week-checklist">‚úÖ Checklist (${weekDataState.checklist?.length || 0})</button>
                </div>
                <div class="estruturacao-week-expand ${weekHasContent ? '' : 'hidden'}">
                  <!-- Se√ß√£o de Notas -->
                  <div class="estruturacao-week-note-section" style="${weekDataState.note ? '' : 'display:none'}">
                    <div class="estruturacao-week-section-label">üìù Bloco de Notas da Semana</div>
                    <div class="estruturacao-week-markdown-editor">
                      <div class="estruturacao-week-markdown-toolbar">
                        <button type="button" data-md-action="bold" title="Negrito (Ctrl+B)"><strong>B</strong></button>
                        <button type="button" data-md-action="italic" title="It√°lico (Ctrl+I)"><em>I</em></button>
                        <button type="button" data-md-action="h1" title="T√≠tulo 1">#</button>
                        <button type="button" data-md-action="h2" title="T√≠tulo 2">##</button>
                        <button type="button" data-md-action="ul" title="Lista">‚Ä¢</button>
                        <button type="button" data-md-action="ol" title="Lista numerada">1.</button>
                        <button type="button" data-md-action="quote" title="Cita√ß√£o">‚ùù</button>
                      </div>
                      <div class="estruturacao-week-note" contenteditable="true" data-placeholder="Escreva suas anota√ß√µes da semana aqui... (suporta Markdown)">${weekNoteHtml}</div>
                      <textarea class="estruturacao-week-note-raw" style="display:none">${weekNoteRaw}</textarea>
                    </div>
                  </div>
                  
                  <!-- Se√ß√£o de Arquivos -->
                  <div class="estruturacao-week-files-section" style="${weekDataState.files && weekDataState.files.length > 0 ? '' : 'display:none'}">
                    <div class="estruturacao-week-section-label">üóÇÔ∏è Arquivos da Semana</div>
                    <div class="estruturacao-week-files">
                      <div class="estruturacao-week-files-header">
                        <button class="estruturacao-week-upload-btn">üì§ Upload de Arquivo</button>
                      </div>
                      <div class="estruturacao-week-paste-zone" tabindex="0">
                        <p>üìã Cole ou arraste imagens/arquivos aqui</p>
                        <p style="font-size:.75rem;opacity:.7">Ou clique para selecionar</p>
                      </div>
                      <div class="estruturacao-week-files-list" data-week-id="${week.id}"></div>
                    </div>
                  </div>
                  
                  <!-- Se√ß√£o de Checklist -->
                  <div class="estruturacao-week-checklist-section" style="${weekDataState.checklist && weekDataState.checklist.length > 0 ? '' : 'display:none'}">
                    <div class="estruturacao-week-section-label">‚úÖ Checklist da Semana</div>
                    <div class="estruturacao-week-checklist">
                      <div class="estruturacao-week-checklist-header">
                        <button class="estruturacao-week-checklist-add">‚ûï Adicionar Item</button>
                      </div>
                      <div class="estruturacao-week-checklist-items" data-week-id="${week.id}"></div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="estruturacao-blocks" data-week-id="${week.id}"></div>
            </div>
          </div>
        `;
        
        const header = weekEl.querySelector('.estruturacao-week-header');
        header.addEventListener('click', (e) => {
          // S√≥ toggle se clicou diretamente no header, n√£o em elementos internos que propagaram
          // Verificar se o clique veio de dentro do body da week
          if(e.target.closest('.estruturacao-week-body')){
            return;
          }
          if(e.target.closest('.estruturacao-block') || 
             e.target.closest('.estruturacao-item') || 
             e.target.closest('.estruturacao-checkbox') || 
             e.target.closest('.estruturacao-checkbox-wrap') ||
             e.target.closest('.estruturacao-item-checkbox') || 
             e.target.closest('.estruturacao-item-checkbox-wrap') ||
             e.target.closest('.estruturacao-week-check-box') ||
             e.target.closest('button') || 
             e.target.closest('textarea') || 
             e.target.closest('input') || 
             e.target.closest('.estruturacao-week-extras') || 
             e.target.closest('.estruturacao-week-check') || 
             e.target.closest('.estruturacao-week-checklist') ||
             e.target.closest('.estruturacao-disclaimers') ||
             e.target.closest('.estruturacao-disclaimer-icon')){
            return;
          }
          const isOpening = !weekEl.classList.contains('open');
          weekEl.classList.toggle('open');
          
          // Se est√° fechando a semana, fechar todos os blocos, itens e se√ß√µes extras dentro dela
          if(!isOpening){
            // Fechar blocos
            weekEl.querySelectorAll('.estruturacao-block.open').forEach(block => {
              block.classList.remove('open');
            });
            // Fechar itens
            weekEl.querySelectorAll('.estruturacao-item.open').forEach(item => {
              item.classList.remove('open');
            });
            // Fechar se√ß√µes de notas, arquivos e checklist da semana
            const noteSection = weekEl.querySelector('.estruturacao-week-note-section');
            const filesSection = weekEl.querySelector('.estruturacao-week-files-section');
            const checklistSection = weekEl.querySelector('.estruturacao-week-checklist-section');
            if(noteSection) noteSection.style.display = 'none';
            if(filesSection) filesSection.style.display = 'none';
            if(checklistSection) checklistSection.style.display = 'none';
          }
        });
        
        // Prevenir que cliques dentro do body da week propaguem para o header
        const weekBody = weekEl.querySelector('.estruturacao-week-body');
        if(weekBody){
          weekBody.addEventListener('click', (e) => {
            e.stopPropagation();
          });
        }
        
        // Event listeners para a semana
        setupWeekExtrasListeners(weekEl, week.id, weekDataState);
        
        const blocksContainer = weekEl.querySelector('.estruturacao-blocks');
        
        // Pegar blocos abertos desta week
        const thisWeekOpenBlocks = openBlocks.get(weekIdx) || new Set();
        
        week.blocks.forEach((block, blockIdx) => {
          const blockState = weekState.blocks[block.id] || { items: {}, notes: '' };
          const blockCompleted = block.items.every((_, idx) => blockState.items[idx]?.completed);
          
          // Calcular resumo do bloco
          let completedCount = 0;
          let notesCount = 0;
          let filesCount = 0;
          let notesPreviews = [];
          
          block.items.forEach((item, idx) => {
            const itemState = blockState.items[idx];
            if(itemState?.completed) completedCount++;
            if(itemState?.note && itemState.note.trim()) {
              notesCount++;
              // Pegar preview da nota (primeiros 30 chars)
              const preview = itemState.note.trim().substring(0, 40);
              notesPreviews.push(preview + (itemState.note.length > 40 ? '...' : ''));
            }
            if(itemState?.files && itemState.files.length > 0) filesCount += itemState.files.length;
          });
          
          // Gerar HTML do resumo
          let summaryHtml = '';
          if(completedCount > 0 || notesCount > 0 || filesCount > 0){
            summaryHtml = '<div class="estruturacao-block-summary">';
            if(completedCount > 0){
              summaryHtml += `<span class="estruturacao-block-summary-item completed"><span class="icon">‚úÖ</span> ${completedCount}/${block.items.length}</span>`;
            }
            if(notesCount > 0){
              summaryHtml += `<span class="estruturacao-block-summary-item notes"><span class="icon">üìù</span> ${notesCount} nota${notesCount > 1 ? 's' : ''}</span>`;
            }
            if(filesCount > 0){
              summaryHtml += `<span class="estruturacao-block-summary-item files"><span class="icon">üìé</span> ${filesCount} arquivo${filesCount > 1 ? 's' : ''}</span>`;
            }
            summaryHtml += '</div>';
            
            // Adicionar preview das notas (todas, sem limite)
            if(notesPreviews.length > 0){
              summaryHtml += '<div class="estruturacao-block-summary-preview">';
              notesPreviews.forEach(preview => {
                summaryHtml += `<span>üìå ${preview}</span>`;
              });
              summaryHtml += '</div>';
            }
          }
          
          const blockEl = document.createElement('div');
          // Restaurar estado de abertura do bloco se estava aberto antes
          const wasBlockOpen = thisWeekOpenBlocks.has(blockIdx);
          blockEl.className = `estruturacao-block ${blockCompleted ? 'completed' : ''} ${wasBlockOpen ? 'open' : ''}`;
          blockEl.dataset.blockId = block.id;
          blockEl.innerHTML = `
            <div class="estruturacao-block-header">
              <div class="estruturacao-checkbox-wrap">
                <div class="estruturacao-checkbox ${blockCompleted ? 'checked' : ''}" data-week-id="${week.id}" data-block-id="${block.id}"></div>
              </div>
              <div class="estruturacao-block-info">
                <h4 class="estruturacao-block-title">${block.title}</h4>
                <p class="estruturacao-block-items">${block.items.length} item${block.items.length !== 1 ? 's' : ''}${completedCount > 0 ? ` ‚Ä¢ ${completedCount} conclu√≠do${completedCount > 1 ? 's' : ''}` : ''}</p>
                ${summaryHtml}
              </div>
              <button type="button" class="estruturacao-block-ai-btn" data-week-id="${week.id}" data-week-title="${week.title}" data-block-id="${block.id}" data-block-title="${block.title}" title="Gerar IA para todos os itens deste bloco">
                <span class="ai-icon">‚ú®</span> IA para Todos
              </button>
            </div>
            <div class="estruturacao-block-body">
              <div class="estruturacao-block-content">
                <div class="estruturacao-items"></div>
              </div>
            </div>
          `;
          
          const blockHeader = blockEl.querySelector('.estruturacao-block-header');
          const blockCheckbox = blockEl.querySelector('.estruturacao-checkbox');
          const blockCheckboxWrap = blockEl.querySelector('.estruturacao-checkbox-wrap');
          
          blockCheckbox.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleBlock(week.id, block.id);
          });
          
          // Prevenir propaga√ß√£o do wrapper tamb√©m
          if(blockCheckboxWrap){
            blockCheckboxWrap.addEventListener('click', (e) => {
              e.stopPropagation();
            });
          }
          
          blockHeader.addEventListener('click', (e) => {
            // S√≥ toggle se clicou diretamente no header do bloco
            if(e.target.closest('.estruturacao-item') || 
               e.target.closest('.estruturacao-item-checkbox') || 
               e.target.closest('.estruturacao-item-checkbox-wrap') ||
               e.target.closest('button') || 
               e.target.closest('textarea') || 
               e.target.closest('input') || 
               e.target.closest('.estruturacao-item-expand')){
              return;
            }
            e.stopPropagation();
            const isOpening = !blockEl.classList.contains('open');
            blockEl.classList.toggle('open');
            
            // Se est√° fechando o bloco, fechar todos os itens dentro dele
            if(!isOpening){
              blockEl.querySelectorAll('.estruturacao-item.open').forEach(item => {
                item.classList.remove('open');
              });
            }
          });
          
          // Prevenir que cliques dentro do bloco propaguem para o week header
          blockEl.addEventListener('click', (e) => {
            e.stopPropagation();
          });
          
          // Event listener para o bot√£o de IA global do bloco
          const blockAiBtn = blockEl.querySelector('.estruturacao-block-ai-btn');
          if(blockAiBtn){
            blockAiBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              e.preventDefault();
              gerarIAParaTodosItensBloco(week.id, week.title, block.id, block.title, block.items);
            });
          }
          
          const itemsContainer = blockEl.querySelector('.estruturacao-items');
          
          // Pegar itens abertos deste bloco
          const thisBlockOpenItems = openItems.get(`${weekIdx}-${blockIdx}`) || new Set();
          
          block.items.forEach((item, itemIdx) => {
            const itemState = blockState.items[itemIdx] || { completed: false, note: '', files: [] };
            const hasExtras = (itemState.note && itemState.note.trim().length > 0) || (itemState.files && itemState.files.length > 0);
            
            const itemEl = document.createElement('div');
            // Restaurar estado de abertura do item se estava aberto antes
            const wasItemOpen = thisBlockOpenItems.has(itemIdx);
            itemEl.className = `estruturacao-item ${itemState.completed ? 'completed' : ''} ${hasExtras ? 'has-extras' : ''} ${wasItemOpen ? 'open' : ''}`;
            itemEl.dataset.weekId = week.id;
            itemEl.dataset.blockId = block.id;
            itemEl.dataset.itemIdx = itemIdx;
            
            // Altura salva do textarea
            const savedHeight = itemState.noteHeight || 80;
            
            // Gerar preview da nota e arquivos (usa todo espa√ßo horizontal)
            let previewHtml = '';
            const hasNote = itemState.note && itemState.note.trim();
            const hasFiles = itemState.files && itemState.files.length > 0;
            
            if(hasNote || hasFiles){
              previewHtml = '<div class="estruturacao-item-preview">';
              
              // Preview das notas
              if(hasNote){
                const noteText = itemState.note.trim();
                // Pegar as linhas n√£o vazias e extrair um preview de cada
                const lines = noteText.split(/\r?\n/).filter(l => l.trim());
                const previews = lines.slice(0, 8).map(line => {
                  // Remover marcadores Markdown e limitar tamanho
                  const clean = line.replace(/^#+\s*/, '').replace(/^\*+\s*/, '').replace(/^-\s*/, '').replace(/^\d+\.\s*/, '').replace(/^>\s*/, '').trim();
                  return clean.length > 60 ? clean.substring(0, 60) + '...' : clean;
                }).filter(p => p);
                previews.forEach(p => {
                  previewHtml += `<span>üìå ${escapeHtml(p)}</span>`;
                });
              }
              
              // Preview dos arquivos
              if(hasFiles){
                const fileCount = itemState.files.length;
                previewHtml += `<span class="preview-file">ÔøΩ ${fileCount} arquivo${fileCount > 1 ? 's' : ''}</span>`;
              }
              
              previewHtml += '</div>';
            }
            
            itemEl.innerHTML = `
              <div class="estruturacao-item-main">
                <div class="estruturacao-item-checkbox-wrap">
                  <div class="estruturacao-item-checkbox ${itemState.completed ? 'checked' : ''}" data-week-id="${week.id}" data-block-id="${block.id}" data-item-idx="${itemIdx}"></div>
                </div>
                <div class="estruturacao-item-text">${item}</div>
                <button class="estruturacao-item-remind ${itemState.reminded ? 'active' : ''}" title="Lembrar depois" data-week-id="${week.id}" data-block-id="${block.id}" data-item-idx="${itemIdx}">üîî</button>
                <button class="estruturacao-item-toggle" title="Adicionar informa√ß√µes">üìé</button>
              </div>
              ${previewHtml}
              <div class="estruturacao-item-extras">
                <div class="estruturacao-markdown-editor">
                  <div class="estruturacao-markdown-toolbar">
                    <button type="button" class="estruturacao-markdown-btn" data-md-action="h1" title="T√≠tulo Principal (# )">H1</button>
                    <button type="button" class="estruturacao-markdown-btn" data-md-action="h2" title="Se√ß√£o (## )">H2</button>
                    <button type="button" class="estruturacao-markdown-btn" data-md-action="h3" title="Sub-se√ß√£o (### )">H3</button>
                    <span class="estruturacao-markdown-btn-sep"></span>
                    <button type="button" class="estruturacao-markdown-btn" data-md-action="bold" title="Negrito (**texto**)"><strong>B</strong></button>
                    <button type="button" class="estruturacao-markdown-btn" data-md-action="italic" title="It√°lico (*texto*)"><em>I</em></button>
                    <span class="estruturacao-markdown-btn-sep"></span>
                    <button type="button" class="estruturacao-markdown-btn" data-md-action="ul" title="Lista (- item)">‚Ä¢ Lista</button>
                    <button type="button" class="estruturacao-markdown-btn" data-md-action="ol" title="Lista numerada (1. item)">1. Lista</button>
                    <span class="estruturacao-markdown-btn-sep"></span>
                    <button type="button" class="estruturacao-markdown-btn" data-md-action="quote" title="Cita√ß√£o (> texto)">‚ùù</button>
                    <button type="button" class="estruturacao-markdown-btn" data-md-action="hr" title="Separador (---)">‚Äî</button>
                    <button type="button" class="estruturacao-markdown-btn" data-md-action="link" title="Link [texto](url)">üîó</button>
                    <button type="button" class="estruturacao-ai-fill-btn" data-week-id="${week.id}" data-week-title="${week.title}" data-block-id="${block.id}" data-block-title="${block.title}" data-item-text="${escapeHtml(item)}" data-item-idx="${itemIdx}" title="Gerar prompt IA para preencher"><span class="ai-icon">‚ú®</span> IA</button>
                    <div class="estruturacao-markdown-help">
                      <button type="button" class="estruturacao-markdown-btn" title="Ajuda de formata√ß√£o">?</button>
                      <div class="estruturacao-markdown-help-tooltip">
                        <h4>üìò Guia de Formata√ß√£o Markdown</h4>
                        <table>
                          <tr><td><code># T√≠tulo</code></td><td>T√≠tulo Principal</td></tr>
                          <tr><td><code>## Se√ß√£o</code></td><td>Se√ß√£o</td></tr>
                          <tr><td><code>### Sub-se√ß√£o</code></td><td>Sub-se√ß√£o</td></tr>
                          <tr><td><code>**negrito**</code></td><td><strong>Negrito</strong></td></tr>
                          <tr><td><code>*it√°lico*</code></td><td><em>It√°lico</em></td></tr>
                          <tr><td><code>- item</code></td><td>‚Ä¢ Lista</td></tr>
                          <tr><td><code>1. item</code></td><td>1. Lista numerada</td></tr>
                          <tr><td><code>> cita√ß√£o</code></td><td>Bloco de cita√ß√£o</td></tr>
                          <tr><td><code>---</code></td><td>Separador</td></tr>
                          <tr><td><code>[texto](url)</code></td><td>Link</td></tr>
                        </table>
                      </div>
                    </div>
                  </div>
                  <div class="estruturacao-item-note" contenteditable="true" data-placeholder="üìù Cole ou digite texto com formata√ß√£o Markdown..." data-week-id="${week.id}" data-block-id="${block.id}" data-item-idx="${itemIdx}">${itemState.note ? renderMarkdownText(itemState.note) : ''}</div>
                  <input type="hidden" class="estruturacao-item-note-raw" value="${escapeHtml(itemState.note || '')}">
                </div>
                <div class="estruturacao-item-files">
                  <div class="estruturacao-item-files-grid" data-week-id="${week.id}" data-block-id="${block.id}" data-item-idx="${itemIdx}"></div>
                  <div class="estruturacao-item-dropzone" data-week-id="${week.id}" data-block-id="${block.id}" data-item-idx="${itemIdx}">
                    <div class="estruturacao-item-dropzone-icon">üìÅ</div>
                    <div>Arraste arquivos ou clique para enviar</div>
                    <div style="font-size:.65rem;margin-top:4px;opacity:.7">Imagens, v√≠deos, PDFs, documentos</div>
                  </div>
                </div>
              </div>
            `;
            
            const itemCheckbox = itemEl.querySelector('.estruturacao-item-checkbox');
            const itemCheckboxWrap = itemEl.querySelector('.estruturacao-item-checkbox-wrap');
            
            itemCheckbox.addEventListener('click', (e) => {
              e.stopPropagation();
              toggleItem(week.id, block.id, itemIdx);
            });
            
            // Prevenir propaga√ß√£o do wrapper tamb√©m
            if(itemCheckboxWrap){
              itemCheckboxWrap.addEventListener('click', (e) => {
                e.stopPropagation();
              });
            }
            
            const toggleBtn = itemEl.querySelector('.estruturacao-item-toggle');
            toggleBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              itemEl.classList.toggle('open');
            });
            
            // Bot√£o Lembrar Depois
            const remindBtn = itemEl.querySelector('.estruturacao-item-remind');
            if(remindBtn){
              remindBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const wId = remindBtn.dataset.weekId;
                const bId = remindBtn.dataset.blockId;
                const iIdx = parseInt(remindBtn.dataset.itemIdx);
                toggleReminder(wId, bId, iIdx);
              });
            }
            
            // Clicar na √°rea principal do item tamb√©m faz toggle (exceto no checkbox)
            const itemMain = itemEl.querySelector('.estruturacao-item-main');
            itemMain.addEventListener('click', (e) => {
              // Ignorar cliques no checkbox, bot√£o toggle ou bot√£o lembrar
              if(e.target.closest('.estruturacao-item-checkbox') || 
                 e.target.closest('.estruturacao-item-checkbox-wrap') ||
                 e.target.closest('.estruturacao-item-toggle') ||
                 e.target.closest('.estruturacao-item-remind')){
                return;
              }
              e.stopPropagation();
              itemEl.classList.toggle('open');
            });
            
            // Prevenir que cliques na √°rea de extras propaguem
            const itemExtras = itemEl.querySelector('.estruturacao-item-extras');
            if(itemExtras){
              itemExtras.addEventListener('click', (e) => {
                e.stopPropagation();
              });
            }
            
            const noteArea = itemEl.querySelector('.estruturacao-item-note');
            const noteRaw = itemEl.querySelector('.estruturacao-item-note-raw');
            let noteSaveTimeout;
            
            // Handler para salvar conte√∫do e processar Markdown ao colar
            noteArea.addEventListener('paste', (e) => {
              e.preventDefault();
              e.stopPropagation();
              
              // Pegar texto puro do clipboard
              const text = (e.clipboardData || window.clipboardData).getData('text/plain');
              if(!text) return;
              
              // Converter Markdown para HTML
              const html = renderMarkdownText(text);
              
              // Se o contenteditable est√° vazio ou seleciona tudo, substituir tudo
              const selection = window.getSelection();
              const range = selection.rangeCount > 0 ? selection.getRangeAt(0) : null;
              
              // Verificar se est√° selecionando todo o conte√∫do ou se est√° vazio
              const isEmptyOrAllSelected = !noteArea.textContent.trim() || 
                (range && range.toString().trim() === noteArea.textContent.trim());
              
              if(isEmptyOrAllSelected){
                // Substituir todo o conte√∫do
                noteArea.innerHTML = html;
                noteRaw.value = text;
              } else {
                // Inserir no cursor
                document.execCommand('insertHTML', false, html);
                // Atualizar raw combinando
                const fullMarkdown = htmlToMarkdown(noteArea.innerHTML);
                noteRaw.value = fullMarkdown;
              }
              
              // Mover cursor para o final
              const newRange = document.createRange();
              newRange.selectNodeContents(noteArea);
              newRange.collapse(false);
              selection.removeAllRanges();
              selection.addRange(newRange);
              
              // Trigger save
              clearTimeout(noteSaveTimeout);
              noteSaveTimeout = setTimeout(() => {
                saveItemNote(week.id, block.id, itemIdx, noteRaw.value);
                updateItemHasExtras(itemEl, week.id, block.id, itemIdx);
              }, 500);
            });
            
            noteArea.addEventListener('input', (e) => {
              e.stopPropagation();
              clearTimeout(noteSaveTimeout);
              noteSaveTimeout = setTimeout(() => {
                // Converter HTML de volta para Markdown e salvar
                const rawMarkdown = htmlToMarkdown(noteArea.innerHTML);
                noteRaw.value = rawMarkdown;
                saveItemNote(week.id, block.id, itemIdx, rawMarkdown);
                updateItemHasExtras(itemEl, week.id, block.id, itemIdx);
              }, 500);
            });
            noteArea.addEventListener('click', (e) => e.stopPropagation());
            noteArea.addEventListener('focus', (e) => e.stopPropagation());
            
            // Salvar imediatamente ao sair do campo
            let lastSavedItemNote = itemState.note || '';
            noteArea.addEventListener('blur', (e) => {
              e.stopPropagation();
              clearTimeout(noteSaveTimeout);
              const currentNote = htmlToMarkdown(noteArea.innerHTML);
              if(currentNote !== lastSavedItemNote){
                saveItemNote(week.id, block.id, itemIdx, currentNote);
                updateItemHasExtras(itemEl, week.id, block.id, itemIdx);
                lastSavedItemNote = currentNote;
                console.log('[Estrutura√ß√£o] Nota item salva no blur:', week.id, block.id, itemIdx);
              }
            });
            
            // Atalhos de teclado para formata√ß√£o
            noteArea.addEventListener('keydown', (e) => {
              if(e.ctrlKey || e.metaKey){
                let action = null;
                switch(e.key.toLowerCase()){
                  case 'b': action = 'bold'; break;
                  case 'i': action = 'italic'; break;
                }
                if(action){
                  e.preventDefault();
                  applyMarkdownFormatting(noteArea, action);
                }
              }
            });
            
            // Markdown toolbar handlers
            const mdToolbar = itemEl.querySelector('.estruturacao-markdown-toolbar');
            
            if(mdToolbar){
              mdToolbar.addEventListener('click', (e) => {
                e.stopPropagation();
                const btn = e.target.closest('[data-md-action]');
                if(!btn) return;
                
                const action = btn.dataset.mdAction;
                applyMarkdownFormatting(noteArea, action);
              });
            }
            
            // AI Fill button handler - mostra popup para observa√ß√£o antes de gerar
            const aiBtn = itemEl.querySelector('.estruturacao-ai-fill-btn');
            if(aiBtn){
              aiBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
                
                const weekTitle = aiBtn.dataset.weekTitle || '';
                const blockTitle = aiBtn.dataset.blockTitle || '';
                const itemText = aiBtn.dataset.itemText;
                
                // Mostrar popup para observa√ß√£o
                showAIQuickInputPopup(weekTitle, blockTitle, itemText, noteArea, noteRaw, week.id, block.id, itemIdx, aiBtn);
              });
            }
            
            // Dropzone handlers
            const dropzone = itemEl.querySelector('.estruturacao-item-dropzone');
            dropzone.addEventListener('click', (e) => {
              e.stopPropagation();
              promptItemFileUpload(week.id, block.id, itemIdx);
            });
            dropzone.addEventListener('dragover', (e) => {
              e.preventDefault();
              e.stopPropagation();
              dropzone.classList.add('dragover');
            });
            dropzone.addEventListener('dragleave', (e) => {
              e.stopPropagation();
              dropzone.classList.remove('dragover');
            });
            dropzone.addEventListener('drop', (e) => {
              e.preventDefault();
              e.stopPropagation();
              dropzone.classList.remove('dragover');
              const files = e.dataTransfer?.files;
              if(files && files.length > 0){
                Array.from(files).forEach(file => handleItemFileUpload(week.id, block.id, itemIdx, file));
              }
            });
            
            // Paste handler for images
            noteArea.addEventListener('paste', (e) => {
              const items = e.clipboardData?.items;
              if(items){
                for(let i = 0; i < items.length; i++){
                  if(items[i].type.indexOf('image') !== -1){
                    e.preventDefault();
                    const file = items[i].getAsFile();
                    if(file) handleItemFileUpload(week.id, block.id, itemIdx, file);
                    break;
                  }
                }
              }
            });
            
            // Render existing files
            renderItemFiles(itemEl, week.id, block.id, itemIdx, itemState);
            
            // Prevenir que cliques dentro do item propaguem para o week header ou block header
            itemEl.addEventListener('click', (e) => {
              e.stopPropagation();
            });
            
            itemsContainer.appendChild(itemEl);
          });
          
          blocksContainer.appendChild(blockEl);
          
          if(blockIdx < week.blocks.length - 1){
            const arrow = document.createElement('div');
            arrow.className = 'estruturacao-arrow';
            arrow.textContent = '‚Üì';
            blocksContainer.appendChild(arrow);
          }
        });
        
        weeksContainer.appendChild(weekEl);
      });
      
      // Renderizar lista de lembretes
      renderReminders();
      
      // Atualizar contadores da galeria de m√≠dia
      updateMediaFilterCounts();
      
      // Restaurar estado do filtro de busca ap√≥s recriar o DOM
      if(savedSearchQuery){
        const newSearchInput = document.getElementById('estruturacaoSearchInput');
        if(newSearchInput){
          newSearchInput.value = savedSearchQuery;
          // Reaplicar o filtro com um pequeno delay para garantir que o DOM esteja pronto
          // Usa skipScroll para n√£o mover a tela quando √© uma restaura√ß√£o
          setTimeout(() => {
            if(typeof performEstruturacaoSearch === 'function'){
              performEstruturacaoSearch(savedSearchQuery, { skipScroll: true });
            }
          }, 50);
        }
      }
    }

    function toggleItem(weekId, blockId, itemIdx){
      if(!ESTRUTURACAO_STATE[weekId]) ESTRUTURACAO_STATE[weekId] = { blocks: {} };
      if(!ESTRUTURACAO_STATE[weekId].blocks[blockId]) ESTRUTURACAO_STATE[weekId].blocks[blockId] = { items: {}, notes: '' };
      if(!ESTRUTURACAO_STATE[weekId].blocks[blockId].items[itemIdx]) ESTRUTURACAO_STATE[weekId].blocks[blockId].items[itemIdx] = { completed: false, note: '' };
      
      const newState = !ESTRUTURACAO_STATE[weekId].blocks[blockId].items[itemIdx].completed;
      ESTRUTURACAO_STATE[weekId].blocks[blockId].items[itemIdx].completed = newState;
      ESTRUTURACAO_STATE[weekId].blocks[blockId].items[itemIdx].completedAt = newState ? new Date().toISOString() : null;
      
      console.log('[Estrutura√ß√£o] Toggle item:', weekId, blockId, 'item', itemIdx, '- novo estado:', newState);
      persistEstruturacao();
      renderEstruturacao();
    }
    
    function saveItemNote(weekId, blockId, itemIdx, note){
      if(!ESTRUTURACAO_STATE[weekId]) ESTRUTURACAO_STATE[weekId] = { blocks: {} };
      if(!ESTRUTURACAO_STATE[weekId].blocks[blockId]) ESTRUTURACAO_STATE[weekId].blocks[blockId] = { items: {}, notes: '' };
      if(!ESTRUTURACAO_STATE[weekId].blocks[blockId].items[itemIdx]) ESTRUTURACAO_STATE[weekId].blocks[blockId].items[itemIdx] = { completed: false, note: '', files: [] };
      
      ESTRUTURACAO_STATE[weekId].blocks[blockId].items[itemIdx].note = note;
      ESTRUTURACAO_STATE[weekId].blocks[blockId].items[itemIdx].noteUpdatedAt = new Date().toISOString();
      
      console.log('[Estrutura√ß√£o] Nota salva:', weekId, blockId, 'item', itemIdx, '- tamanho:', note?.length || 0);
      persistEstruturacao();
    }
    
    // ======== SISTEMA DE IA PARA PREENCHIMENTO ========
    
    // Coleta todas as notas preenchidas em todas as semanas para contexto da IA
    function getAllFilledNotesContext(){
      let context = '';
      let notesCount = 0;
      
      ESTRUTURACAO_DATA.forEach(week => {
        const weekState = ESTRUTURACAO_STATE[week.id];
        if(!weekState || !weekState.blocks) return;
        
        let weekContext = '';
        
        week.blocks.forEach(block => {
          const blockState = weekState.blocks[block.id];
          if(!blockState || !blockState.items) return;
          
          let blockNotes = '';
          
          block.items.forEach((item, idx) => {
            const itemState = blockState.items[idx];
            if(itemState && itemState.note && itemState.note.trim().length > 10){
              // Limitar cada nota a 200 caracteres para n√£o estourar contexto
              const shortNote = itemState.note.trim().substring(0, 200);
              blockNotes += `  ‚Ä¢ ${item}: ${shortNote}${itemState.note.length > 200 ? '...' : ''}\n`;
              notesCount++;
            }
          });
          
          if(blockNotes){
            weekContext += `\n**${block.title}:**\n${blockNotes}`;
          }
        });
        
        if(weekContext){
          context += `\nüìÖ ${week.title} - ${week.subtitle}:${weekContext}\n`;
        }
      });
      
      if(notesCount === 0) return '';
      
      return `\n---\n**üìã CONTEXTO J√Å PREENCHIDO (${notesCount} itens):**${context}\n---\n`;
    }
    
    // Gera prompt espec√≠fico para cada item do checklist
    function generateAIFillPrompt(weekTitle, blockTitle, itemText, existingNote){
      const businessInfo = ESTRUTURACAO_STATE.businessInfo || {};
      const bizName = businessInfo.name || '[Nome n√£o informado]';
      const bizNiche = businessInfo.niche || '[Nicho n√£o informado]';
      const bizTime = businessInfo.time || '[Tempo n√£o informado]';
      const bizBudget = businessInfo.budget || '';
      const bizAgencyFee = businessInfo.agencyFee || '';
      const bizTicket = businessInfo.ticket || '';
      const bizObs = businessInfo.observations || '';
      
      // Coletar contexto de todas as notas j√° preenchidas
      const allNotesContext = getAllFilledNotesContext();
      
      // Detectar contexto espec√≠fico baseado na HIERARQUIA (bloco + item)
      const blockLower = blockTitle.toLowerCase();
      const itemLower = itemText.toLowerCase();
      const weekLower = weekTitle.toLowerCase();
      
      // Detectar se √© Copywriting nas Semanas 3 ou 4 (textos longos permitidos)
      const isWeek3or4 = weekLower.includes('semana 3') || weekLower.includes('semana 4') || weekLower.includes('week 3') || weekLower.includes('week 4');
      const isCopywriting = blockLower.includes('copy') || blockLower.includes('criativo') || blockLower.includes('an√∫ncio') || blockLower.includes('texto') || blockLower.includes('script');
      const isLongCopyMode = isWeek3or4 && isCopywriting;
      
      // Detectar se √© Blog (modo super extenso - 3 blogs completos)
      const isBlogItem = itemLower.includes('blog') || itemLower.includes('artigo') || itemLower.includes('post de blog') || blockLower.includes('blog');
      const isBlogMode = isWeek3or4 && isCopywriting && isBlogItem;
      
      // Detectar plataforma espec√≠fica
      const isGoogle = blockLower.includes('google') || itemLower.includes('google') || itemLower.includes('search') || itemLower.includes('display');
      const isMeta = blockLower.includes('meta') || blockLower.includes('facebook') || blockLower.includes('instagram') || itemLower.includes('meta') || itemLower.includes('facebook') || itemLower.includes('instagram');
      const isLinkedin = blockLower.includes('linkedin') || itemLower.includes('linkedin');
      const isTiktok = blockLower.includes('tiktok') || itemLower.includes('tiktok');
      
      // Detectar tipo de conte√∫do baseado no BLOCO (header/categoria)
      const isCopy = blockLower.includes('copy') || blockLower.includes('criativo') || blockLower.includes('an√∫ncio') || blockLower.includes('texto');
      const isCampaign = blockLower.includes('campanha') || blockLower.includes('campaign') || blockLower.includes('estrutura de campanha');
      const isFunnel = blockLower.includes('funil') || blockLower.includes('funnel') || blockLower.includes('jornada');
      const isAudience = blockLower.includes('p√∫blico') || blockLower.includes('audi√™ncia') || blockLower.includes('segmenta√ß√£o');
      const isStrategy = blockLower.includes('estrat√©g') || blockLower.includes('planejamento');
      const isAnalysis = blockLower.includes('an√°lise') || blockLower.includes('diagn√≥stico') || blockLower.includes('situa√ß√£o');
      
      // Construir contexto espec√≠fico da hierarquia
      let hierarchyContext = '';
      let platformContext = '';
      
      if(isGoogle){
        platformContext = 'GOOGLE ADS (Search, Display, YouTube, Performance Max)';
      } else if(isMeta){
        platformContext = 'META ADS (Facebook, Instagram, Audience Network)';
      } else if(isLinkedin){
        platformContext = 'LINKEDIN ADS';
      } else if(isTiktok){
        platformContext = 'TIKTOK ADS';
      }
      
      if(isCopy && platformContext){
        hierarchyContext = `Voc√™ est√° criando COPYS/TEXTOS para ${platformContext}. Foque em headlines, descri√ß√µes e CTAs espec√≠ficos para esta plataforma.`;
      } else if(isCampaign && platformContext){
        hierarchyContext = `Voc√™ est√° estruturando CAMPANHAS para ${platformContext}. Foque em estrutura de campanhas, grupos de an√∫ncios, objetivos e configura√ß√µes espec√≠ficas desta plataforma.`;
      } else if(isAudience && platformContext){
        hierarchyContext = `Voc√™ est√° definindo P√öBLICOS/SEGMENTA√á√ÉO para ${platformContext}. Foque em interesses, comportamentos e p√∫blicos personalizados desta plataforma.`;
      } else if(isCopy){
        hierarchyContext = `Voc√™ est√° criando COPYS/TEXTOS publicit√°rios. Foque em headlines persuasivos, descri√ß√µes e CTAs.`;
      } else if(isCampaign){
        hierarchyContext = `Voc√™ est√° estruturando CAMPANHAS de tr√°fego pago. Foque em estrutura, objetivos e configura√ß√µes.`;
      } else if(isFunnel){
        hierarchyContext = `Voc√™ est√° definindo FUNIL de convers√£o. Foque em etapas, gatilhos e fluxo do cliente.`;
      } else if(isAudience){
        hierarchyContext = `Voc√™ est√° definindo P√öBLICO-ALVO e segmenta√ß√£o. Foque em caracter√≠sticas, comportamentos e dores.`;
      } else if(isStrategy){
        hierarchyContext = `Voc√™ est√° definindo ESTRAT√âGIA de marketing. Foque em objetivos, m√©tricas e a√ß√µes.`;
      } else if(isAnalysis){
        hierarchyContext = `Voc√™ est√° fazendo AN√ÅLISE/DIAGN√ìSTICO. Foque em pontos fortes, fracos e oportunidades.`;
      }
      
      // Detectar tipo de resposta baseado no item espec√≠fico
      const hasExisting = existingNote && existingNote.trim().length > 20;
      const isList = itemLower.includes('principais') || itemLower.includes('pontos') || itemLower.includes('obje√ß√µes') || itemLower.includes('concorrentes') || itemLower.includes('lista');
      const isExample = itemLower.includes('exemplo') || itemLower.includes('modelo') || itemLower.includes('sugest√£o');
      
      let instruction = 'Responda de forma direta e aplic√°vel.';
      let formatInstruction = '**FORMATO:** Apenas o conte√∫do. Sem t√≠tulos. Direto ao ponto.';
      
      if(hasExisting){
        instruction = 'Complete ou melhore o texto existente. Mantenha o que j√° est√° bom.';
      } else if(isBlogMode){
        instruction = 'Escreva 3 ARTIGOS DE BLOG COMPLETOS para o neg√≥cio do cliente.';
        formatInstruction = `**FORMATO BLOGS (3 ARTIGOS COMPLETOS):**

Escreva EXATAMENTE 3 artigos de blog completos seguindo esta estrutura para CADA artigo:

---
üìù **BLOG 1: [T√≠tulo SEO-friendly]**

**Introdu√ß√£o** (2-3 par√°grafos engajantes)

**Desenvolvimento** (3-5 se√ß√µes com subt√≠tulos)
- Cada se√ß√£o com 2-3 par√°grafos
- Inclua dados, exemplos pr√°ticos
- Use linguagem do nicho

**Conclus√£o** (1-2 par√°grafos + CTA)

---
üìù **BLOG 2: [T√≠tulo diferente]**
[mesma estrutura]

---
üìù **BLOG 3: [T√≠tulo diferente]**
[mesma estrutura]

IMPORTANTE:
- Cada blog deve ter 500-800 palavras
- Temas diferentes mas relacionados ao nicho
- Otimizado para SEO
- Tom de voz adequado ao p√∫blico
- Inclua CTAs no final de cada blog`;
      } else if(isLongCopyMode){
        instruction = 'Crie textos completos e persuasivos para an√∫ncios. Seja detalhado e criativo.';
        formatInstruction = `**FORMATO COPYWRITING:**
- Crie textos COMPLETOS prontos para usar
- Inclua varia√ß√µes de headlines (3-5 op√ß√µes)
- Inclua descri√ß√µes/body copy completas
- Inclua CTAs variados
- Use t√©cnicas de copywriting (AIDA, PAS, etc.)
- Pode ser mais extenso (at√© 800 palavras)
- Separe cada vers√£o claramente`;
      } else if(isExample || isCopy){
        instruction = 'Crie exemplos pr√°ticos e prontos para usar.';
      } else if(isList){
        instruction = 'Liste em t√≥picos curtos (m√°ximo 5-7 itens).';
      }
      
      const prompt = `**CONTEXTO DO NEG√ìCIO:**
- Empresa: ${bizName}
- Nicho: ${bizNiche}
- Tempo de mercado: ${bizTime}
${bizBudget ? `- Investimento em An√∫ncios/Marketing/m√™s: ${bizBudget}` : ''}
${bizAgencyFee ? `- Valor Pago para Ag√™ncia/m√™s: ${bizAgencyFee}` : ''}
${bizBudget && bizAgencyFee ? `- **INVESTIMENTO TOTAL EM MARKETING/m√™s:** (${bizBudget} + ${bizAgencyFee}) - Use este valor para c√°lculos de CAC` : ''}
${bizTicket ? `- Ticket m√©dio: ${bizTicket}` : ''}
${bizObs ? `- Observa√ß√µes: ${bizObs}` : ''}
${allNotesContext}
**HIERARQUIA ATUAL:**
üìÖ SEMANA: ${weekTitle}
üìÅ BLOCO/CATEGORIA: ${blockTitle}
üìù ITEM A PREENCHER: ${itemText}
${hierarchyContext ? `\n‚ö†Ô∏è CONTEXTO ESPEC√çFICO: ${hierarchyContext}` : ''}

${hasExisting ? `**TEXTO ATUAL:**\n${existingNote}\n` : ''}

**INSTRU√á√ÉO:** ${instruction}

${formatInstruction}`;

      // Definir tokens baseado no modo
      let maxTokens = 1200; // padr√£o aumentado para respostas mais completas
      if(isBlogMode){
        maxTokens = 5000; // 3 blogs completos
      } else if(isLongCopyMode){
        maxTokens = 2500; // copywriting extenso
      }

      // Retornar objeto com prompt e configura√ß√µes
      return {
        prompt: prompt,
        isLongCopy: isLongCopyMode,
        isBlog: isBlogMode,
        maxTokens: maxTokens
      };
    }
    
    // ===== GERAR IA PARA TODOS OS ITENS DE UM BLOCO =====
    // Mostra popup para adicionar observa√ß√£o global e gera para todos os itens n√£o preenchidos do bloco
    async function gerarIAParaTodosItensBloco(weekId, weekTitle, blockId, blockTitle, items){
      // Remover popup existente se houver
      const existingPopup = document.querySelector('.ai-quick-input-overlay');
      if(existingPopup) existingPopup.remove();
      
      // Contar itens vazios (sem nota)
      const blockState = ESTRUTURACAO_STATE[weekId]?.blocks?.[blockId] || { items: {} };
      let emptyItems = [];
      let filledItems = [];
      
      items.forEach((item, idx) => {
        const itemState = blockState.items?.[idx] || {};
        const hasNote = itemState.note && itemState.note.trim().length > 0;
        if(hasNote){
          filledItems.push({ idx, text: item, note: itemState.note });
        } else {
          emptyItems.push({ idx, text: item });
        }
      });
      
      // Se todos os itens j√° est√£o preenchidos, perguntar se quer sobrescrever
      const allFilled = emptyItems.length === 0;
      
      const overlay = document.createElement('div');
      overlay.className = 'ai-quick-input-overlay';
      overlay.innerHTML = `
        <div class="ai-quick-input-popup" style="max-width:550px">
          <div class="ai-quick-input-header">
            <span class="ai-quick-input-title">‚ú® IA para Todos os Itens do Bloco</span>
            <button class="ai-quick-input-close" title="Fechar">√ó</button>
          </div>
          
          <div style="padding:12px;background:rgba(139,92,246,.1);border-radius:8px;margin-bottom:12px;">
            <div style="font-weight:600;margin-bottom:4px;">üì¶ ${blockTitle}</div>
            <div style="font-size:.8rem;opacity:.8;">
              ${items.length} item${items.length > 1 ? 's' : ''} no total
              ${emptyItems.length > 0 ? `‚Ä¢ ${emptyItems.length} vazio${emptyItems.length > 1 ? 's' : ''}` : ''}
              ${filledItems.length > 0 ? `‚Ä¢ ${filledItems.length} j√° preenchido${filledItems.length > 1 ? 's' : ''}` : ''}
            </div>
          </div>
          
          <div style="margin-bottom:12px;">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:.85rem;">
              <input type="checkbox" id="aiBlockOverwrite" ${allFilled ? 'checked' : ''}>
              <span>${allFilled ? 'Sobrescrever todos os itens' : 'Tamb√©m sobrescrever itens j√° preenchidos'}</span>
            </label>
          </div>
          
          <div class="ai-quick-input-hint">üí° Adicione uma observa√ß√£o geral que ser√° aplicada a TODOS os itens</div>
          <textarea class="ai-quick-input-field" placeholder="Ex: foco em ticket alto, cliente B2B, tom de voz profissional..." style="min-height:80px;"></textarea>
          
          <div class="ai-quick-input-actions">
            <button class="ai-quick-input-skip">Cancelar</button>
            <button class="ai-quick-input-generate" style="min-width:180px;">
              ‚ú® Gerar para ${allFilled ? items.length : emptyItems.length} item${(allFilled ? items.length : emptyItems.length) > 1 ? 's' : ''}
            </button>
          </div>
          
          <div id="aiBlockProgress" style="display:none;margin-top:12px;padding:12px;background:rgba(0,0,0,.3);border-radius:8px;">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
              <span class="ai-icon" style="animation:spin 1s linear infinite;">‚è≥</span>
              <span id="aiBlockProgressText">Processando item 1 de X...</span>
            </div>
            <div style="height:4px;background:rgba(255,255,255,.1);border-radius:2px;overflow:hidden;">
              <div id="aiBlockProgressBar" style="height:100%;background:linear-gradient(90deg,#8b5cf6,#a855f7);width:0%;transition:width .3s ease;"></div>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(overlay);
      
      const inputField = overlay.querySelector('.ai-quick-input-field');
      const closeBtn = overlay.querySelector('.ai-quick-input-close');
      const cancelBtn = overlay.querySelector('.ai-quick-input-skip');
      const generateBtn = overlay.querySelector('.ai-quick-input-generate');
      const overwriteCheckbox = overlay.querySelector('#aiBlockOverwrite');
      const progressDiv = overlay.querySelector('#aiBlockProgress');
      const progressText = overlay.querySelector('#aiBlockProgressText');
      const progressBar = overlay.querySelector('#aiBlockProgressBar');
      
      // Atualizar texto do bot√£o quando checkbox muda
      overwriteCheckbox.addEventListener('change', () => {
        const count = overwriteCheckbox.checked ? items.length : emptyItems.length;
        generateBtn.textContent = `‚ú® Gerar para ${count} item${count > 1 ? 's' : ''}`;
      });
      
      // Focar no campo
      setTimeout(() => inputField.focus(), 100);
      
      // Fechar popup
      const closePopup = () => overlay.remove();
      
      closeBtn.onclick = closePopup;
      cancelBtn.onclick = closePopup;
      overlay.onclick = (e) => { if(e.target === overlay) closePopup(); };
      
      // Gerar para todos os itens
      generateBtn.onclick = async () => {
        const userObservation = inputField.value.trim();
        const shouldOverwrite = overwriteCheckbox.checked;
        
        // Determinar quais itens processar
        const itemsToProcess = shouldOverwrite ? 
          items.map((item, idx) => ({ idx, text: item })) : 
          emptyItems;
        
        if(itemsToProcess.length === 0){
          showToast('Nenhum item para processar', 'info');
          closePopup();
          return;
        }
        
        // Mostrar progresso
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<span class="ai-icon" style="animation:spin 1s linear infinite;">‚è≥</span> Processando...';
        inputField.disabled = true;
        overwriteCheckbox.disabled = true;
        progressDiv.style.display = 'block';
        
        // Processar cada item sequencialmente
        for(let i = 0; i < itemsToProcess.length; i++){
          const item = itemsToProcess[i];
          progressText.textContent = `Processando item ${i + 1} de ${itemsToProcess.length}: "${item.text.substring(0, 30)}..."`;
          progressBar.style.width = `${((i + 1) / itemsToProcess.length) * 100}%`;
          
          try{
            // Gerar IA para este item (sem popup, direto)
            await gerarIAParaItemDireto(weekId, weekTitle, blockId, blockTitle, item.idx, item.text, userObservation);
            
            // Pequeno delay entre chamadas para n√£o sobrecarregar a API
            if(i < itemsToProcess.length - 1){
              await new Promise(resolve => setTimeout(resolve, 500));
            }
          }catch(err){
            console.error(`Erro ao gerar IA para item ${item.idx}:`, err);
          }
        }
        
        // Conclu√≠do
        progressText.textContent = `‚úÖ Conclu√≠do! ${itemsToProcess.length} item${itemsToProcess.length > 1 ? 's' : ''} processado${itemsToProcess.length > 1 ? 's' : ''}`;
        progressBar.style.width = '100%';
        progressBar.style.background = 'linear-gradient(90deg,#10b981,#22c55e)';
        
        // Renderizar novamente a estrutura√ß√£o
        setTimeout(() => {
          renderEstruturacao();
          closePopup();
          showToast(`‚úÖ IA gerada para ${itemsToProcess.length} item${itemsToProcess.length > 1 ? 's' : ''}!`, 'success');
        }, 1000);
      };
      
      // Escape para fechar
      inputField.addEventListener('keydown', (e) => {
        if(e.key === 'Escape'){
          closePopup();
        }
      });
    }
    
    // Gerar IA para um item sem popup (chamada direta)
    async function gerarIAParaItemDireto(weekId, weekTitle, blockId, blockTitle, itemIdx, itemText, userObservation = ''){
      // Garantir estrutura do state
      if(!ESTRUTURACAO_STATE[weekId]) ESTRUTURACAO_STATE[weekId] = { blocks: {}, weekData: { note: '', files: [], checklist: [] } };
      if(!ESTRUTURACAO_STATE[weekId].blocks) ESTRUTURACAO_STATE[weekId].blocks = {};
      if(!ESTRUTURACAO_STATE[weekId].blocks[blockId]) ESTRUTURACAO_STATE[weekId].blocks[blockId] = { items: {}, notes: '' };
      if(!ESTRUTURACAO_STATE[weekId].blocks[blockId].items[itemIdx]) ESTRUTURACAO_STATE[weekId].blocks[blockId].items[itemIdx] = { completed: false, note: '', files: [] };
      
      const itemState = ESTRUTURACAO_STATE[weekId].blocks[blockId].items[itemIdx];
      const existingNote = itemState.note || '';
      
      const promptData = generateAIFillPrompt(weekTitle, blockTitle, itemText, existingNote);
      let prompt = promptData.prompt;
      
      // Adicionar observa√ß√£o do usu√°rio ao prompt se fornecida
      if(userObservation){
        prompt += `\n\n**OBSERVA√á√ÉO DO USU√ÅRIO (aplicar a este item):** ${userObservation}`;
      }
      
      // üîí Verificar se o proxy de IA est√° dispon√≠vel (API key agora est√° no backend)
      if(typeof window.callAIProxy !== 'function'){
        throw new Error('Servi√ßo de IA n√£o dispon√≠vel');
      }
      
      // System prompt simplificado
      const systemPrompt = `Voc√™ √© um consultor de marketing e copywriter da Mediagrowth.

IMPORTANTE - ENTENDA A HIERARQUIA:
- O usu√°rio est√° preenchendo um CHECKLIST organizado em SEMANAS > BLOCOS > ITENS
- O BLOCO/CATEGORIA define o TIPO de conte√∫do
- Se est√° em "Copies" ‚Üí foque em TEXTOS, HEADLINES, DESCRI√á√ïES
- Se est√° em "Campanhas" ‚Üí foque em ESTRUTURA, OBJETIVOS, CONFIGURA√á√ïES
- Se est√° em "P√∫blicos" ‚Üí foque em SEGMENTA√á√ÉO, INTERESSES, AUDI√äNCIAS

FORMATA√á√ÉO OBRIGAT√ìRIA:
- Use **negrito** para destacar t√≠tulos/palavras-chave
- Separe cada item com linha em branco
- Seja pr√°tico e direto (5-7 itens no m√°ximo)
- Comece DIRETO com o conte√∫do (sem sauda√ß√µes)`;

      try{
        // üîí Usando proxy seguro (API key no backend)
        const messagesBloco = [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: prompt }
        ];
        
        const data = await window.callAIProxy(window.IA_CONFIG.model, messagesBloco, auth.currentUser?.uid, promptData.maxTokens, window.IA_CONFIG.temperature.default);
        
        if(!data || data.error){
          throw new Error(data?.error || 'Erro na API');
        }
        
        const aiText = data.choices?.[0]?.message?.content || '';
        
        if(aiText){
          // Atualizar o estado do item com o texto gerado
          itemState.note = aiText;
          itemState.aiGeneratedAt = new Date().toISOString();
          
          // Salvar
          persistEstruturacao();
          
          console.log(`[IA Bloco] Item ${itemIdx} gerado com sucesso: ${aiText.substring(0, 50)}...`);
        }
      }catch(err){
        console.error(`[IA Bloco] Erro ao gerar item ${itemIdx}:`, err);
        throw err;
      }
    }
    
    // Mostrar popup para adicionar observa√ß√£o antes de gerar com IA
    function showAIQuickInputPopup(weekTitle, blockTitle, itemText, noteArea, noteRaw, weekId, blockId, itemIdx, aiBtn){
      // Remover popup existente se houver
      const existingPopup = document.querySelector('.ai-quick-input-overlay');
      if(existingPopup) existingPopup.remove();
      
      // Buscar imagens anexadas a este item
      const itemState = ESTRUTURACAO_STATE[weekId]?.blocks?.[blockId]?.items?.[itemIdx] || {};
      const itemFiles = itemState.files || [];
      const imageFiles = itemFiles.filter(f => f.type && f.type.startsWith('image/'));
      
      // Carregar hist√≥rico de prompts do item (salvo no state)
      const promptHistory = itemState.aiPromptHistory || [];
      const lastPrompt = promptHistory.length > 0 ? promptHistory[promptHistory.length - 1] : '';
      
      // Limitar a 5 imagens para n√£o exceder limite da API
      const MAX_IMAGES = 5;
      const limitedImages = imageFiles.slice(0, MAX_IMAGES);
      const hasMoreImages = imageFiles.length > MAX_IMAGES;
      
      // Gerar HTML das imagens selecion√°veis
      let imagesHtml = '';
      if(limitedImages.length > 0){
        imagesHtml = `
          <div class="ai-quick-input-images">
            <div class="ai-quick-input-images-label">
              üì∏ Imagens anexadas (${limitedImages.length}${hasMoreImages ? '/' + imageFiles.length : ''}) <span class="vision-badge">Vision AI</span>
            </div>
            <div class="ai-quick-input-images-grid">
              ${limitedImages.map((img, idx) => `
                <div class="ai-quick-input-image-item selected" data-image-idx="${idx}" data-image-url="${img.url}" title="${img.name || 'Imagem'}">
                  <img src="${img.url}" alt="${img.name || 'Imagem'}" loading="lazy">
                  <span class="check-badge">‚úì</span>
                </div>
              `).join('')}
            </div>
            <div class="ai-quick-input-images-hint">
              üëÜ Clique para selecionar/deselecionar. Imagens s√£o redimensionadas automaticamente.
              ${hasMoreImages ? '<br>‚ö†Ô∏è M√°ximo 5 imagens por vez. Restantes ser√£o ignoradas.' : ''}
            </div>
          </div>
        `;
      }
      
      // Gerar HTML do hist√≥rico de prompts (se houver)
      let historyHtml = '';
      if(promptHistory.length > 0){
        historyHtml = `
          <div class="ai-quick-input-history">
            <div class="ai-quick-input-history-label">üìú Prompts anteriores (${promptHistory.length})</div>
            <div class="ai-quick-input-history-list">
              ${promptHistory.slice(-5).reverse().map((prompt, idx) => `
                <div class="ai-quick-input-history-item" data-prompt="${escapeHtml(prompt)}" title="Clique para usar">
                  ${prompt.length > 50 ? prompt.substring(0, 50) + '...' : prompt}
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }
      
      const overlay = document.createElement('div');
      overlay.className = 'ai-quick-input-overlay';
      overlay.innerHTML = `
        <div class="ai-quick-input-popup" style="${limitedImages.length > 0 || promptHistory.length > 0 ? 'max-width:520px' : ''}">
          <div class="ai-quick-input-header">
            <span class="ai-quick-input-title">‚ú® Gerar com IA ${limitedImages.length > 0 ? '+ Vision' : ''}</span>
            <button class="ai-quick-input-close" title="Fechar">√ó</button>
          </div>
          ${imagesHtml}
          ${historyHtml}
          <div class="ai-quick-input-hint">üí° Adicione suas ideias ou deixe em branco para gerar automaticamente</div>
          <textarea class="ai-quick-input-field" placeholder="Ex: foco em ticket alto, cliente premium, estrat√©gia de conte√∫do educativo...">${escapeHtml(lastPrompt)}</textarea>
          <div class="ai-quick-input-actions">
            <button class="ai-quick-input-skip">Pular</button>
            <button class="ai-quick-input-generate">‚ú® Gerar${limitedImages.length > 0 ? ' com Imagens' : ''}</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(overlay);
      
      const inputField = overlay.querySelector('.ai-quick-input-field');
      const closeBtn = overlay.querySelector('.ai-quick-input-close');
      const skipBtn = overlay.querySelector('.ai-quick-input-skip');
      const generateBtn = overlay.querySelector('.ai-quick-input-generate');
      const imageItems = overlay.querySelectorAll('.ai-quick-input-image-item');
      const historyItems = overlay.querySelectorAll('.ai-quick-input-history-item');
      
      // Handler para clicar em item do hist√≥rico (preenche o campo)
      historyItems.forEach(item => {
        item.addEventListener('click', () => {
          inputField.value = item.dataset.prompt;
          inputField.focus();
        });
      });
      
      // Handler para selecionar/deselecionar imagens
      imageItems.forEach(item => {
        item.addEventListener('click', () => {
          item.classList.toggle('selected');
        });
      });
      
      // Fun√ß√£o para coletar URLs das imagens selecionadas
      const getSelectedImageUrls = () => {
        const selected = overlay.querySelectorAll('.ai-quick-input-image-item.selected');
        return Array.from(selected).map(item => item.dataset.imageUrl);
      };
      
      // Fun√ß√£o para salvar prompt no hist√≥rico
      const savePromptToHistory = (prompt) => {
        if(!prompt || prompt.trim().length < 3) return;
        
        // Garantir estrutura do state
        if(!ESTRUTURACAO_STATE[weekId]) ESTRUTURACAO_STATE[weekId] = { blocks: {} };
        if(!ESTRUTURACAO_STATE[weekId].blocks[blockId]) ESTRUTURACAO_STATE[weekId].blocks[blockId] = { items: {}, notes: '' };
        if(!ESTRUTURACAO_STATE[weekId].blocks[blockId].items[itemIdx]) ESTRUTURACAO_STATE[weekId].blocks[blockId].items[itemIdx] = { completed: false, note: '', files: [] };
        
        const item = ESTRUTURACAO_STATE[weekId].blocks[blockId].items[itemIdx];
        if(!item.aiPromptHistory) item.aiPromptHistory = [];
        
        // Evitar duplicatas (n√£o adicionar se for igual ao √∫ltimo)
        const lastInHistory = item.aiPromptHistory[item.aiPromptHistory.length - 1];
        if(lastInHistory !== prompt.trim()){
          item.aiPromptHistory.push(prompt.trim());
          // Manter apenas os √∫ltimos 10 prompts
          if(item.aiPromptHistory.length > 10){
            item.aiPromptHistory = item.aiPromptHistory.slice(-10);
          }
          persistEstruturacao();
        }
      };
      
      // Focar no campo e selecionar texto existente
      setTimeout(() => {
        inputField.focus();
        if(lastPrompt) inputField.select();
      }, 100);
      
      // Fechar popup
      const closePopup = () => overlay.remove();
      
      closeBtn.onclick = closePopup;
      overlay.onclick = (e) => { if(e.target === overlay) closePopup(); };
      
      // Gerar sem observa√ß√£o (pular)
      skipBtn.onclick = async () => {
        const selectedImages = getSelectedImageUrls();
        closePopup();
        await fillNoteWithAI(weekTitle, blockTitle, itemText, noteArea, noteRaw, weekId, blockId, itemIdx, aiBtn, '', selectedImages);
      };
      
      // Gerar com observa√ß√£o
      generateBtn.onclick = async () => {
        const userNote = inputField.value.trim();
        const selectedImages = getSelectedImageUrls();
        
        // Salvar prompt no hist√≥rico antes de fechar
        savePromptToHistory(userNote);
        
        closePopup();
        await fillNoteWithAI(weekTitle, blockTitle, itemText, noteArea, noteRaw, weekId, blockId, itemIdx, aiBtn, userNote, selectedImages);
      };
      
      // Enter para gerar
      inputField.addEventListener('keydown', (e) => {
        if(e.key === 'Enter' && !e.shiftKey){
          e.preventDefault();
          generateBtn.click();
        }
        if(e.key === 'Escape'){
          closePopup();
        }
      });
    }
    
    // Fun√ß√£o para redimensionar e comprimir imagem para Vision AI
    // Limita a 1200px de largura m√°xima e comprime para ~200KB por imagem
    async function imageUrlToBase64(url){
      try {
        const response = await fetch(url);
        const blob = await response.blob();
        
        // Criar imagem para obter dimens√µes
        const img = new Image();
        img.crossOrigin = 'anonymous';
        
        return new Promise((resolve, reject) => {
          img.onload = () => {
            try {
              // Dimens√µes m√°ximas para Vision AI (balanceando qualidade e tamanho)
              const MAX_WIDTH = 1200;
              const MAX_HEIGHT = 1200;
              
              let { width, height } = img;
              
              // Calcular novo tamanho mantendo propor√ß√£o
              if (width > MAX_WIDTH || height > MAX_HEIGHT) {
                const ratio = Math.min(MAX_WIDTH / width, MAX_HEIGHT / height);
                width = Math.round(width * ratio);
                height = Math.round(height * ratio);
              }
              
              // Criar canvas para redimensionar
              const canvas = document.createElement('canvas');
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              
              // Desenhar imagem redimensionada
              ctx.drawImage(img, 0, 0, width, height);
              
              // Converter para JPEG com qualidade 0.7 (boa qualidade, tamanho reduzido)
              // Tentar diferentes qualidades at√© ficar abaixo de 500KB
              let quality = 0.8;
              let base64 = canvas.toDataURL('image/jpeg', quality);
              
              // Se ainda estiver muito grande, reduzir qualidade
              while (base64.length > 700000 && quality > 0.3) { // ~500KB em base64
                quality -= 0.1;
                base64 = canvas.toDataURL('image/jpeg', quality);
              }
              
              // Se ainda estiver muito grande, redimensionar mais
              if (base64.length > 700000) {
                const smallerRatio = 0.7;
                canvas.width = Math.round(width * smallerRatio);
                canvas.height = Math.round(height * smallerRatio);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                base64 = canvas.toDataURL('image/jpeg', 0.6);
              }
              
              // Extrair apenas os dados base64
              const base64Data = base64.split(',')[1];
              
              console.log(`üì∏ Imagem processada: ${width}x${height}, qualidade ${quality.toFixed(1)}, ~${Math.round(base64Data.length / 1024)}KB`);
              
              resolve({
                base64: base64Data,
                mediaType: 'image/jpeg'
              });
            } catch (canvasErr) {
              console.error('Erro ao processar canvas:', canvasErr);
              reject(canvasErr);
            }
          };
          
          img.onerror = () => {
            console.error('Erro ao carregar imagem para redimensionar');
            reject(new Error('Falha ao carregar imagem'));
          };
          
          // Carregar imagem do blob
          img.src = URL.createObjectURL(blob);
        });
      } catch(err) {
        console.error('Erro ao converter imagem para base64:', err);
        return null;
      }
    }
    
    // Fun√ß√£o para chamar a IA via OpenRouter e preencher automaticamente
    async function fillNoteWithAI(weekTitle, blockTitle, itemText, noteArea, noteRaw, weekId, blockId, itemIdx, aiBtn, userObservation = '', selectedImageUrls = []){
      const existingNote = noteRaw ? noteRaw.value : '';
      const promptData = generateAIFillPrompt(weekTitle, blockTitle, itemText, existingNote);
      let prompt = promptData.prompt;
      const isLongCopy = promptData.isLongCopy;
      const isBlog = promptData.isBlog;
      const maxTokens = promptData.maxTokens;
      
      // Adicionar observa√ß√£o do usu√°rio ao prompt se fornecida
      if(userObservation){
        prompt += `\n\n**OBSERVA√á√ÉO DO USU√ÅRIO:** ${userObservation}`;
      }
      
      // üîí Verificar se o proxy de IA est√° dispon√≠vel (API key agora est√° no backend)
      if(typeof window.callAIProxy !== 'function'){
        showToast('‚ùå Servi√ßo de IA n√£o dispon√≠vel. Recarregue a p√°gina.', 'error');
        return;
      }
      
      // Mudar visual do bot√£o para loading
      const originalHTML = aiBtn.innerHTML;
      if(isBlog){
        aiBtn.innerHTML = '<span class="ai-icon">‚è≥</span> Escrevendo 3 blogs...';
      } else {
        aiBtn.innerHTML = '<span class="ai-icon">‚è≥</span> Gerando...';
      }
      aiBtn.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
      aiBtn.disabled = true;
      
      // System prompt din√¢mico baseado no contexto
      let systemPrompt = `Voc√™ √© um consultor de marketing e copywriter da Mediagrowth.

IMPORTANTE - ENTENDA A HIERARQUIA:
- O usu√°rio est√° preenchendo um CHECKLIST organizado em SEMANAS > BLOCOS > ITENS
- O BLOCO/CATEGORIA define o TIPO de conte√∫do (ex: "Copies Meta" = criar textos, "Estrutura de Campanhas" = configurar campanhas)
- Itens com mesmo nome em blocos diferentes precisam de respostas DIFERENTES
- Se est√° em "Copies" ‚Üí foque em TEXTOS, HEADLINES, DESCRI√á√ïES
- Se est√° em "Campanhas" ‚Üí foque em ESTRUTURA, OBJETIVOS, CONFIGURA√á√ïES
- Se est√° em "P√∫blicos" ‚Üí foque em SEGMENTA√á√ÉO, INTERESSES, AUDI√äNCIAS

FORMATA√á√ÉO OBRIGAT√ìRIA:
- SEMPRE separe cada item/etapa com LINHA EM BRANCO
- Use este formato:

**T√≠tulo/Nome do Item**
Descri√ß√£o detalhada aqui

**Pr√≥ximo Item**
Descri√ß√£o do pr√≥ximo

- NUNCA coloque t√≠tulo e descri√ß√£o na mesma linha
- NUNCA use "‚Äî" ou ":" para separar t√≠tulo de descri√ß√£o na mesma linha
- Cada bloco deve ter espa√ßamento visual claro

PROIBIDO:
- NUNCA crie t√≠tulos com # ou ##
- NUNCA use TEXTO TODO EM MAI√öSCULAS como t√≠tulo principal
- NUNCA comece com emoji + t√≠tulo gen√©rico
- NUNCA fa√ßa "T√≠tulo ‚Äî descri√ß√£o" tudo na mesma linha`;

      if(isBlog){
        systemPrompt += `

üî• MODO BLOG ATIVADO - ESCREVA 3 ARTIGOS COMPLETOS üî•

Voc√™ DEVE escrever EXATAMENTE 3 artigos de blog COMPLETOS e EXTENSOS.

ESTRUTURA OBRIGAT√ìRIA PARA CADA BLOG:
1. T√≠tulo SEO-friendly (pode usar emoji no in√≠cio)
2. Introdu√ß√£o engajante (2-3 par√°grafos)
3. Desenvolvimento com 3-5 se√ß√µes/subt√≠tulos
4. Cada se√ß√£o deve ter 2-4 par√°grafos completos
5. Conclus√£o com CTA

REQUISITOS:
- Cada blog deve ter entre 500-800 palavras
- Use linguagem adequada ao nicho do cliente
- Inclua palavras-chave relevantes para SEO
- Tom de voz profissional mas acess√≠vel
- Separe cada blog com "---" 
- Os 3 blogs devem ter temas DIFERENTES mas relacionados ao nicho
- Inclua exemplos pr√°ticos e dados quando poss√≠vel`;
      } else if(isLongCopy){
        systemPrompt += `

MODO COPYWRITING ATIVADO:
- Voc√™ est√° criando COPIES para an√∫ncios (Semana 3/4)
- Crie textos COMPLETOS e persuasivos
- Inclua m√∫ltiplas varia√ß√µes de headlines
- Inclua body copy/descri√ß√µes completas
- Use t√©cnicas de copywriting (AIDA, PAS, antes/depois, prova social)
- Pode ser EXTENSO - at√© 800 palavras
- Separe cada vers√£o/varia√ß√£o com DUAS linhas em branco
- Adapte o tom de voz ao nicho do cliente

FORMATO PARA COPIES:

**Vers√£o 1 - [Abordagem]**

Headline: texto aqui

Descri√ß√£o: texto aqui

CTA: texto aqui

---

**Vers√£o 2 - [Abordagem]**
...`;
      } else {
        systemPrompt += `

FORMATO PADR√ÉO:
- Comece DIRETO com o conte√∫do
- Use formato:

‚Ä¢ **Item 1**
  Descri√ß√£o do item

‚Ä¢ **Item 2**
  Descri√ß√£o do item

- Use **negrito** para destacar t√≠tulos/palavras-chave
- M√°ximo 5-7 itens
- Seja pr√°tico e direto
- SEMPRE pule linha entre cada item`;
      }
      
      // Se h√° imagens selecionadas, adicionar instru√ß√µes de an√°lise de imagem
      const hasImages = selectedImageUrls && selectedImageUrls.length > 0;
      if(hasImages){
        systemPrompt += `

üñºÔ∏è MODO VISION ATIVADO - ANALISANDO IMAGENS:
- O usu√°rio anexou ${selectedImageUrls.length} imagem(ns) para voc√™ analisar
- ANALISE CUIDADOSAMENTE cada imagem antes de responder
- Use as informa√ß√µes visuais das imagens para enriquecer sua resposta
- Se as imagens forem prints de concorrentes, analise o que est√£o fazendo
- Se forem prints de m√©tricas/relat√≥rios, extraia os dados relevantes
- Se forem refer√™ncias visuais, descreva e incorpore no contexto
- Mencione insights espec√≠ficos que voc√™ observou nas imagens`;
      }
      
      try{
        // Preparar mensagens - com ou sem imagens
        let userMessage;
        
        if(hasImages){
          // Atualizar bot√£o para mostrar que est√° processando imagens
          aiBtn.innerHTML = '<span class="ai-icon">üñºÔ∏è</span> Processando imagens...';
          
          // Converter imagens para base64
          const imageContents = [];
          for(const imageUrl of selectedImageUrls){
            const imageData = await imageUrlToBase64(imageUrl);
            if(imageData){
              imageContents.push({
                type: 'image',
                source: {
                  type: 'base64',
                  media_type: imageData.mediaType,
                  data: imageData.base64
                }
              });
            }
          }
          
          aiBtn.innerHTML = '<span class="ai-icon">‚è≥</span> Gerando com Vision...';
          
          // Montar mensagem multimodal
          userMessage = {
            role: 'user',
            content: [
              ...imageContents,
              {
                type: 'text',
                text: prompt
              }
            ]
          };
        } else {
          // Mensagem normal sem imagens
          userMessage = { 
            role: 'user', 
            content: prompt 
          };
        }
        
        // üîí Usando proxy seguro (API key no backend)
        const tempForProxy = isBlog ? window.IA_CONFIG.temperature.creative : (isLongCopy ? window.IA_CONFIG.temperature.longform : window.IA_CONFIG.temperature.default);
        const messagesEstruturacao = [
          { role: 'system', content: systemPrompt },
          userMessage
        ];
        
        const result = await window.callAIProxy(window.IA_CONFIG.model, messagesEstruturacao, auth.currentUser?.uid, maxTokens, tempForProxy);

        if(!result || result.error){
          throw new Error(result?.error || 'Erro na resposta da API');
        }

        let aiResponse = result.choices?.[0]?.message?.content || '';
        
        if(!aiResponse.trim()){
          throw new Error('Resposta vazia da IA');
        }
        
        // Limpar formata√ß√£o excessiva da resposta
        aiResponse = aiResponse.trim();
        
        // Remover t√≠tulos markdown (##, ###, etc.)
        aiResponse = aiResponse.replace(/^#{1,6}\s+.+\n*/gm, '');
        
        // Remover linhas que parecem t√≠tulos (emoji + TEXTO EM MAI√öSCULAS)
        aiResponse = aiResponse.replace(/^[\p{Emoji}\s]*[A-Z√Ä√Å√Ç√É√Ñ√â√ä√ç√ì√î√ï√ö√á\s]{10,}:?\s*\n*/gmu, '');
        
        // Remover linhas s√≥ com emoji e texto em caps
        aiResponse = aiResponse.replace(/^[üõëüéØüìå‚ö†Ô∏è‚úÖ‚ùåüí°üî•‚≠êÔ∏èüìäüí∞üöÄ]+\s*[A-Z√Ä√Å√Ç√É√Ñ√â√ä√ç√ì√î√ï√ö√á\s]+\n*/gm, '');
        
        // Remover **T√çTULO EM NEGRITO E CAPS** no in√≠cio
        aiResponse = aiResponse.replace(/^\*\*[A-Z√Ä√Å√Ç√É√Ñ√â√ä√ç√ì√î√ï√ö√á\süõëüéØüìå‚ö†Ô∏è‚úÖ‚ùåüí°üî•‚≠êÔ∏èüìäüí∞üöÄ]+\*\*:?\s*\n*/gm, '');
        
        aiResponse = aiResponse.trim();
        
        // Atualizar o campo de notas
        if(noteArea && noteRaw){
          let finalContent = aiResponse;
          
          // Se j√° existe conte√∫do, adicionar abaixo sem sobrescrever
          if(existingNote.trim()){
            finalContent = existingNote.trim() + '\n\n' + aiResponse;
          }
          
          // Salvar markdown raw
          noteRaw.value = finalContent;
          
          // Renderizar markdown no visual
          if(typeof renderMarkdownText === 'function'){
            noteArea.innerHTML = renderMarkdownText(finalContent);
          } else {
            noteArea.innerHTML = finalContent.replace(/\n/g, '<br>');
          }
          
          // Salvar no Firebase
          if(typeof saveItemNote === 'function'){
            saveItemNote(weekId, blockId, itemIdx, finalContent);
          }
          
          // Atualizar indicador visual
          if(typeof updateItemHasExtras === 'function'){
            const itemEl = noteArea.closest('.estruturacao-item');
            if(itemEl) updateItemHasExtras(itemEl, weekId, blockId, itemIdx);
          }
        }
        
        // Sucesso
        aiBtn.innerHTML = '<span class="ai-icon">‚úÖ</span> Gerado!';
        aiBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
        showToast('‚ú® Conte√∫do adicionado!', 'success');
        
        setTimeout(() => {
          aiBtn.innerHTML = originalHTML;
          aiBtn.style.background = '';
          aiBtn.disabled = false;
        }, 2000);
        
      }catch(err){
        console.error('Erro ao gerar com IA:', err);
        aiBtn.innerHTML = '<span class="ai-icon">‚ùå</span> Erro';
        aiBtn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
        showToast(`Erro: ${err.message}`, 'error');
        
        setTimeout(() => {
          aiBtn.innerHTML = originalHTML;
          aiBtn.style.background = '';
          aiBtn.disabled = false;
        }, 3000);
      }
    }
    
    // Abrir modal com prompt de IA
    function openAIFillModal(weekTitle, blockTitle, itemText, itemIdx, noteEl){
      const rawInput = noteEl.parentElement.querySelector('.estruturacao-item-note-raw');
      const existingNote = rawInput ? rawInput.value : '';
      
      const prompt = generateAIFillPrompt(weekTitle, blockTitle, itemText, existingNote);
      
      // Criar modal simples
      const modal = document.createElement('div');
      modal.className = 'ai-fill-modal-overlay';
      modal.innerHTML = `
        <div class="ai-fill-modal">
          <div class="ai-fill-modal-header">
            <span>‚ú® Prompt IA - ${itemText.substring(0, 40)}${itemText.length > 40 ? '...' : ''}</span>
            <button class="ai-fill-modal-close" title="Fechar">‚úï</button>
          </div>
          <div class="ai-fill-modal-body">
            <textarea class="ai-fill-prompt-text" readonly>${prompt}</textarea>
          </div>
          <div class="ai-fill-modal-footer">
            <button class="ai-fill-copy-btn">üìã Copiar Prompt</button>
            <span class="ai-fill-tip">Cole no ChatGPT ou Claude e copie a resposta de volta</span>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Event listeners
      modal.querySelector('.ai-fill-modal-close').onclick = () => modal.remove();
      modal.querySelector('.ai-fill-modal-overlay')?.addEventListener('click', (e) => {
        if(e.target === modal) modal.remove();
      });
      modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
      
      modal.querySelector('.ai-fill-copy-btn').onclick = async () => {
        const copiado = await mgCopyToClipboard(prompt);
        const btn = modal.querySelector('.ai-fill-copy-btn');
        if(copiado) {
          btn.textContent = '‚úì Copiado!';
          btn.style.background = '#22c55e';
          setTimeout(() => {
            btn.textContent = 'üìã Copiar Prompt';
            btn.style.background = '';
          }, 2000);
        } else {
          btn.textContent = '‚ùå Erro ao copiar';
          setTimeout(() => {
            btn.textContent = 'üìã Copiar Prompt';
          }, 2000);
        }
      };
      
      // Selecionar texto ao clicar
      modal.querySelector('.ai-fill-prompt-text').onclick = function(){ this.select(); };
    }
    

    function saveItemNoteHeight(weekId, blockId, itemIdx, height){
      if(!ESTRUTURACAO_STATE[weekId]) ESTRUTURACAO_STATE[weekId] = { blocks: {} };
      if(!ESTRUTURACAO_STATE[weekId].blocks[blockId]) ESTRUTURACAO_STATE[weekId].blocks[blockId] = { items: {}, notes: '' };
      if(!ESTRUTURACAO_STATE[weekId].blocks[blockId].items[itemIdx]) ESTRUTURACAO_STATE[weekId].blocks[blockId].items[itemIdx] = { completed: false, note: '', files: [] };
      
      ESTRUTURACAO_STATE[weekId].blocks[blockId].items[itemIdx].noteHeight = height;
      persistEstruturacao();
    }
    
    function ensureItemState(weekId, blockId, itemIdx){
      if(!ESTRUTURACAO_STATE[weekId]) ESTRUTURACAO_STATE[weekId] = { blocks: {} };
      if(!ESTRUTURACAO_STATE[weekId].blocks[blockId]) ESTRUTURACAO_STATE[weekId].blocks[blockId] = { items: {}, notes: '' };
      if(!ESTRUTURACAO_STATE[weekId].blocks[blockId].items[itemIdx]) ESTRUTURACAO_STATE[weekId].blocks[blockId].items[itemIdx] = { completed: false, note: '', files: [] };
      const itemState = ESTRUTURACAO_STATE[weekId].blocks[blockId].items[itemIdx];
      if(!itemState.files) itemState.files = [];
      return itemState;
    }
    
    function updateItemHasExtras(itemEl, weekId, blockId, itemIdx){
      const itemState = ESTRUTURACAO_STATE[weekId]?.blocks[blockId]?.items[itemIdx] || {};
      const hasExtras = (itemState.note && itemState.note.trim().length > 0) || (itemState.files && itemState.files.length > 0);
      itemEl.classList.toggle('has-extras', hasExtras);
    }
    
    function promptItemFileUpload(weekId, blockId, itemIdx){
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*,video/*,application/pdf,.doc,.docx,.txt,.xls,.xlsx';
      input.multiple = true;
      input.style.display = 'none';
      document.body.appendChild(input);
      
      input.addEventListener('change', () => {
        const files = input.files;
        if(files && files.length > 0){
          Array.from(files).forEach(file => handleItemFileUpload(weekId, blockId, itemIdx, file));
        }
        document.body.removeChild(input);
      });
      
      input.click();
    }
    
    async function handleItemFileUpload(weekId, blockId, itemIdx, file){
      try{
        if(typeof auth === 'undefined' || !auth){
          console.error('Firebase Auth n√£o inicializado');
          alert('Sistema de autentica√ß√£o n√£o dispon√≠vel.');
          return;
        }
        
        const uid = auth.currentUser?.uid;
        if(!uid){
          alert('Fa√ßa login para enviar arquivos.');
          return;
        }
        
        const safeTenant = (typeof TENANT!=="undefined" && TENANT) ? TENANT : null;
        if(!safeTenant || safeTenant === 'no-client'){
          alert('Cliente n√£o definido.');
          return;
        }
        
        if(!STORAGE){
          try{ 
            STORAGE = getStorage(app); 
          }catch(err){ 
            console.error('Storage error:', err); 
            alert('Storage n√£o dispon√≠vel.'); 
            return; 
          }
        }
        
        if(typeof mgToast === 'function') mgToast('Enviando...');
        
        const safeName = (file.name||'file').replace(/[^a-zA-Z0-9._-]/g,'_');
        const path = `users/${uid}/tenant-${safeTenant}/estruturacao/${weekId}/${blockId}/item${itemIdx}/${Date.now()}_${safeName}`;
        const ref = sRef(STORAGE, path);
        
        await uploadBytes(ref, file);
        const url = await getDownloadURL(ref);
        
        const itemState = ensureItemState(weekId, blockId, itemIdx);
        itemState.files.push({
          name: file.name || 'arquivo',
          size: file.size,
          type: file.type,
          url: url,
          path: path,
          uploadedAt: Date.now()
        });
        
        persistEstruturacao();
        renderEstruturacao();
        updateMediaFilterCounts();
        
        if(typeof mgToast === 'function') mgToast('Arquivo enviado!');
      }catch(err){
        console.error('Upload error:', err);
        alert('Erro ao enviar: ' + (err?.message || String(err)));
      }
    }
    
    async function deleteItemFile(weekId, blockId, itemIdx, fileIdx){
      const itemState = ESTRUTURACAO_STATE[weekId]?.blocks[blockId]?.items[itemIdx];
      if(!itemState?.files?.[fileIdx]) return;
      
      if(!confirm('Remover este arquivo?')) return;
      
      const file = itemState.files[fileIdx];
      
      try{
        if(file.path && STORAGE && typeof deleteObject !== 'undefined'){
          const ref = sRef(STORAGE, file.path);
          await deleteObject(ref);
        }
      }catch(err){
        console.warn('Erro ao deletar:', err);
      }
      
      itemState.files.splice(fileIdx, 1);
      persistEstruturacao();
      renderEstruturacao();
      updateMediaFilterCounts();
      
      if(typeof mgToast === 'function') mgToast('Arquivo removido!');
    }
    
    function renderItemFiles(itemEl, weekId, blockId, itemIdx, itemState){
      const container = itemEl.querySelector(`.estruturacao-item-files-grid[data-week-id="${weekId}"][data-block-id="${blockId}"][data-item-idx="${itemIdx}"]`);
      if(!container) return;
      
      const files = itemState.files || [];
      container.innerHTML = '';
      
      if(files.length === 0) return;
      
      files.forEach((file, fIdx) => {
        const fileEl = document.createElement('div');
        fileEl.className = 'estruturacao-item-file';
        
        const isImage = file.type?.startsWith('image/');
        const isVideo = file.type?.startsWith('video/');
        
        if(isImage){
          fileEl.innerHTML = `
            <img src="${file.url}" alt="${file.name}">
            <button class="estruturacao-item-file-delete" title="Remover">‚úï</button>
          `;
        }else if(isVideo){
          fileEl.innerHTML = `
            <video src="${file.url}" muted></video>
            <button class="estruturacao-item-file-delete" title="Remover">‚úï</button>
          `;
        }else{
          const icon = getFileIcon(file.name);
          fileEl.innerHTML = `
            <div class="estruturacao-item-file-doc">
              ${icon}
              <span>${file.name}</span>
            </div>
            <button class="estruturacao-item-file-delete" title="Remover">‚úï</button>
          `;
        }
        
        fileEl.addEventListener('click', (e) => {
          // Ignorar clique no bot√£o delete
          if(e.target.classList.contains('estruturacao-item-file-delete')){
            return;
          }
          e.stopPropagation();
          e.preventDefault();
          // Para imagens/v√≠deos abre zoom, para documentos abre preview popup
          if(isImage || isVideo){
            // Criar fileInfo com contexto completo para ID √∫nico
            const fileInfo = {
              url: file.url,
              name: file.name,
              weekId: weekId,
              blockId: blockId,
              itemIdx: itemIdx,
              fileIdx: fIdx
            };
            showZoomOverlay(file.url, isVideo, () => {
              deleteItemFile(weekId, blockId, itemIdx, fIdx);
            }, fileInfo);
          }else{
            // Documento - abrir popup de preview igual ao da galeria
            showDocumentPreviewPopup(file, () => {
              deleteItemFile(weekId, blockId, itemIdx, fIdx);
            });
          }
        });
        
        const deleteBtn = fileEl.querySelector('.estruturacao-item-file-delete');
        deleteBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          deleteItemFile(weekId, blockId, itemIdx, fIdx);
        });
        
        container.appendChild(fileEl);
      });
    }
    
    function getFileIcon(filename){
      const ext = (filename || '').split('.').pop()?.toLowerCase() || '';
      const icons = {
        'pdf': 'üìÑ',
        'doc': 'üìù', 'docx': 'üìù',
        'xls': 'üìä', 'xlsx': 'üìä',
        'ppt': 'üìΩÔ∏è', 'pptx': 'üìΩÔ∏è',
        'txt': 'üìÉ',
        'zip': 'üì¶', 'rar': 'üì¶',
        'mp3': 'üéµ', 'wav': 'üéµ',
        'mp4': 'üé¨', 'mov': 'üé¨', 'avi': 'üé¨'
      };
      return icons[ext] || 'üìÅ';
    }

    // ===== POPUP PREVIEW PARA DOCUMENTOS =====
    let docPreviewOverlay = null;
    let currentDocDeleteCallback = null;
    
    function showDocumentPreviewPopup(file, onDelete = null){
      currentDocDeleteCallback = onDelete;
      
      // Criar overlay se n√£o existe
      if(!docPreviewOverlay){
        docPreviewOverlay = document.createElement('div');
        docPreviewOverlay.className = 'doc-preview-overlay';
        docPreviewOverlay.id = 'docPreviewOverlay';
        document.body.appendChild(docPreviewOverlay);
        
        // Fechar ao clicar no overlay
        docPreviewOverlay.addEventListener('click', (e) => {
          if(e.target === docPreviewOverlay){
            hideDocumentPreviewPopup();
          }
        });
        
        // Fechar com ESC
        document.addEventListener('keydown', (e) => {
          if(e.key === 'Escape' && docPreviewOverlay?.classList.contains('active')){
            hideDocumentPreviewPopup();
          }
        });
      }
      
      const ext = (file.name || '').split('.').pop().toLowerCase();
      const isPDF = ext === 'pdf';
      const docIcon = getDocumentIcon(file.name, file.type);
      const docSize = formatDocSize(file.size);
      
      if(isPDF){
        // PDF - mostrar em iframe
        docPreviewOverlay.innerHTML = `
          <div class="doc-preview-container">
            <div class="doc-preview-header">
              <div class="doc-preview-title">
                <span class="doc-preview-icon">${docIcon}</span>
                <span class="doc-preview-name">${file.name}</span>
                <span class="doc-preview-size">${docSize}</span>
              </div>
              <div class="doc-preview-actions">
                <a href="${file.url}" target="_blank" class="doc-btn-open" title="Abrir em nova aba">‚Üó Abrir</a>
                <a href="${file.url}" download="${file.name}" class="doc-btn-download" title="Baixar">‚¨á Baixar</a>
                ${onDelete ? '<button class="doc-btn-delete" title="Excluir arquivo">üóëÔ∏è Excluir</button>' : ''}
                <button class="doc-preview-close" title="Fechar">‚úï</button>
              </div>
            </div>
            <iframe src="${file.url}" class="doc-preview-iframe"></iframe>
          </div>
        `;
      } else {
        // Outros documentos - mostrar preview com √≠cone e op√ß√µes
        docPreviewOverlay.innerHTML = `
          <div class="doc-preview-container doc-preview-compact">
            <div class="doc-preview-header">
              <div class="doc-preview-title">
                <span class="doc-preview-icon">${docIcon}</span>
                <span class="doc-preview-name">${file.name}</span>
                <span class="doc-preview-size">${docSize}</span>
              </div>
              <button class="doc-preview-close" title="Fechar">‚úï</button>
            </div>
            <div class="doc-preview-body">
              <div class="doc-preview-large-icon">${docIcon}</div>
              <div class="doc-preview-info">
                <div class="doc-preview-filename">${file.name}</div>
                <div class="doc-preview-filesize">${docSize}</div>
              </div>
              <div class="doc-preview-buttons">
                <a href="${file.url}" target="_blank" class="doc-btn-open">‚Üó Abrir arquivo</a>
                <a href="${file.url}" download="${file.name}" class="doc-btn-download">‚¨á Baixar arquivo</a>
                ${onDelete ? '<button class="doc-btn-delete">üóëÔ∏è Excluir arquivo</button>' : ''}
              </div>
            </div>
          </div>
        `;
      }
      
      // Event listeners
      const closeBtn = docPreviewOverlay.querySelector('.doc-preview-close');
      closeBtn?.addEventListener('click', hideDocumentPreviewPopup);
      
      const deleteBtn = docPreviewOverlay.querySelector('.doc-btn-delete');
      if(deleteBtn && onDelete){
        deleteBtn.addEventListener('click', () => {
          if(confirm('Tem certeza que deseja excluir este arquivo?')){
            hideDocumentPreviewPopup();
            onDelete();
          }
        });
      }
      
      docPreviewOverlay.classList.add('active');
    }
    
    function hideDocumentPreviewPopup(){
      if(docPreviewOverlay){
        docPreviewOverlay.classList.remove('active');
        docPreviewOverlay.innerHTML = '';
      }
      currentDocDeleteCallback = null;
    }

    // ===== ZOOM OVERLAY PARA IMAGENS =====
    let zoomOverlayEl = null;
    let currentZoomDeleteCallback = null;
    
    function createZoomOverlay(){
      if(zoomOverlayEl) return zoomOverlayEl;
      
      zoomOverlayEl = document.createElement('div');
      zoomOverlayEl.className = 'zoom-overlay';
      zoomOverlayEl.id = 'zoomOverlay';
      zoomOverlayEl.innerHTML = '';
      document.body.appendChild(zoomOverlayEl);
      
      // Fechar ao clicar no overlay (mas n√£o nos bot√µes ou m√≠dia)
      zoomOverlayEl.addEventListener('click', (e) => {
        if(e.target === zoomOverlayEl){
          hideZoomOverlay();
        }
      });
      
      // Fechar com ESC
      document.addEventListener('keydown', (e) => {
        if(e.key === 'Escape' && zoomOverlayEl?.classList.contains('active')){
          hideZoomOverlay();
        }
      });
      
      return zoomOverlayEl;
    }
    
    function showZoomOverlay(url, isVideo = false, onDelete = null, fileInfo = null){
      const overlay = createZoomOverlay();
      currentZoomDeleteCallback = onDelete;
      
      // Guardar refer√™ncia ao fileInfo para uso no salvar
      overlay.dataset.currentFileInfo = fileInfo ? JSON.stringify(fileInfo) : '';
      
      let mediaHtml;
      if(isVideo){
        mediaHtml = `<video src="${url}" autoplay loop muted playsinline controls></video>`;
      }else{
        mediaHtml = `<img src="${url}" alt="Zoom">`;
      }
      
      // Buscar metadados existentes e gerar formul√°rio
      buscarMetadadosMidiaZoom(url, fileInfo).then(metadados => {
        const tagsHtml = (window.ENTREGAVEIS_TAGS || [
          'Diagn√≥stico Estrat√©gico Completo',
          'Direcionamento Estrat√©gico e Metas',
          'An√°lise de Concorr√™ncia e Mercado',
          'Matriz CDT - Caracter√≠sticas, Dores e Transforma√ß√µes',
          'PUV - Proposta √önica de Valor',
          'PAI - P√∫blico Alvo Ideal',
          'Estrutura√ß√£o de An√∫ncios Pagos',
          'Estrutura√ß√£o Site & SEO',
          'Estrat√©gias para Redes Sociais',
          'Copywriting Estrat√©gico',
          'Produ√ß√£o de Conte√∫do Guiada',
          'Criativos para An√∫ncios Patrocinados',
          'CRM e Automa√ß√µes',
          'Estrutura√ß√£o do Processo Comercial',
          'Landing Pages Estrat√©gicas',
          'Constru√ß√£o ou Atualiza√ß√£o de Website',
          'Padroniza√ß√£o Visual e de Comunica√ß√£o',
          'Plataforma Mediagrowth'
        ]).map(tag => {
          const isSelected = metadados?.tags?.includes(tag) || false;
          return `
            <label class="zoom-tag-option ${isSelected ? 'selected' : ''}" data-tag-value="${tag}">
              <input type="checkbox" value="${tag}" ${isSelected ? 'checked' : ''} style="display:none;">
              <span>${tag}</span>
            </label>
          `;
        }).join('');
        
        // Montar HTML com formul√°rio de tags
        overlay.innerHTML = `
          <div class="zoom-overlay-layout">
            <div class="zoom-overlay-media">
              ${mediaHtml}
            </div>
            <div class="zoom-overlay-sidebar">
              <h3 class="zoom-sidebar-title">üè∑Ô∏è Vincular a Entreg√°veis</h3>
              
              <div class="zoom-sidebar-section">
                <label class="zoom-sidebar-label">üìù Descri√ß√£o breve:</label>
                <textarea 
                  id="zoomMidiaDescricao" 
                  class="zoom-sidebar-textarea"
                  placeholder="Ex: Print do dashboard mostrando aumento de 300% nas vendas..."
                >${metadados?.descricao || ''}</textarea>
              </div>
              
              <div class="zoom-sidebar-section">
                <label class="zoom-sidebar-label">üè∑Ô∏è Tags (selecione os entreg√°veis):</label>
                <div id="zoomTagsContainer" class="zoom-tags-container">
                  ${tagsHtml}
                </div>
              </div>
              
              <div class="zoom-sidebar-actions">
                ${onDelete ? `<button class="zoom-overlay-btn delete" id="zoomDeleteBtn">
                  <span>üóëÔ∏è</span> Excluir
                </button>` : ''}
                <button class="zoom-overlay-btn primary" id="zoomSaveBtn">
                  <span>üíæ</span> Salvar
                </button>
                <button class="zoom-overlay-btn" id="zoomCloseBtn">
                  <span>‚úï</span> Fechar
                </button>
              </div>
            </div>
          </div>
          <div class="zoom-overlay-hint">Pressione ESC ou clique fora da imagem para fechar</div>
        `;
        
        // Event listeners para os bot√µes
        const closeBtn = overlay.querySelector('#zoomCloseBtn');
        if(closeBtn){
          closeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            hideZoomOverlay();
          });
        }
        
        const saveBtn = overlay.querySelector('#zoomSaveBtn');
        if(saveBtn){
          saveBtn.addEventListener('click', async (e) => {
            e.stopPropagation();
            // Passar fileInfo para garantir ID √∫nico
            await salvarMetadadosMidiaZoom(url, isVideo, fileInfo);
          });
        }
        
        const deleteBtn = overlay.querySelector('#zoomDeleteBtn');
        if(deleteBtn && onDelete){
          deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if(confirm('Tem certeza que deseja excluir este arquivo?')){
              hideZoomOverlay();
              onDelete();
            }
          });
        }
        
        // Event listeners para os tag labels
        const tagLabels = overlay.querySelectorAll('.zoom-tag-option');
        tagLabels.forEach(label => {
          label.addEventListener('click', (e) => {
            e.stopPropagation();
            e.preventDefault();
            label.classList.toggle('selected');
            const checkbox = label.querySelector('input[type="checkbox"]');
            if(checkbox) checkbox.checked = !checkbox.checked;
          });
        });
      });
      
      // Mostrar overlay
      requestAnimationFrame(() => {
        overlay.classList.add('active');
      });
    }
    
    function hideZoomOverlay(){
      if(zoomOverlayEl){
        zoomOverlayEl.classList.remove('active');
        currentZoomDeleteCallback = null;
        // Limpar conte√∫do ap√≥s anima√ß√£o
        setTimeout(() => {
          if(zoomOverlayEl && !zoomOverlayEl.classList.contains('active')){
            zoomOverlayEl.innerHTML = '';
          }
        }, 200);
      }
    }
    
    // ===== FUN√á√ïES PARA METADADOS DE M√çDIAS =====
    
    // Fun√ß√£o para gerar um ID √∫nico para cada m√≠dia baseado na URL e contexto
    function gerarMidiaId(url, fileInfo = null) {
      // Criar um identificador √∫nico baseado em m√∫ltiplos fatores
      let baseString = url;
      
      // Se temos informa√ß√µes do arquivo, adicionar para tornar √∫nico
      if (fileInfo) {
        baseString = `${url}|${fileInfo.weekId || ''}|${fileInfo.blockId || ''}|${fileInfo.itemIdx ?? ''}|${fileInfo.name || ''}`;
      }
      
      // Criar hash simples mas √∫nico
      let hash = 0;
      for (let i = 0; i < baseString.length; i++) {
        const char = baseString.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32bit integer
      }
      
      // Converter para string hexadecimal e adicionar parte da URL para debug
      const urlPart = url.split('/').pop()?.split('?')[0]?.substring(0, 30) || 'media';
      const hashId = `${urlPart}_${Math.abs(hash).toString(16)}`;
      
      console.log('[MidiaId] Gerado ID:', hashId, 'para:', url.substring(0, 60) + '...');
      return hashId;
    }
    
    async function buscarMetadadosMidiaZoom(url, fileInfo = null) {
      try {
        const user = auth?.currentUser;
        if (!user || !db) return null;
        
        const uid = user.uid;
        const midiaId = gerarMidiaId(url, fileInfo);
        
        console.log('[Metadados] Buscando com ID:', midiaId);
        
        const metadadosRef = doc(db, 'usuarios', uid, 'midias_metadados', midiaId);
        const metadadosSnap = await getDoc(metadadosRef);
        
        if (metadadosSnap.exists()) {
          const data = metadadosSnap.data();
          console.log('[Metadados] Encontrado:', data);
          return data;
        }
        console.log('[Metadados] Nenhum metadado encontrado para esta m√≠dia');
        return null;
      } catch (error) {
        console.error('Erro ao buscar metadados:', error);
        return null;
      }
    }
    
    async function salvarMetadadosMidiaZoom(url, isVideo, fileInfo = null) {
      const descricaoEl = document.getElementById('zoomMidiaDescricao');
      const tagsContainer = document.getElementById('zoomTagsContainer');
      
      if (!descricaoEl || !tagsContainer) {
        console.error('Formul√°rio n√£o encontrado');
        return;
      }
      
      const descricao = descricaoEl.value.trim();
      const checkboxes = tagsContainer.querySelectorAll('input[type="checkbox"]:checked');
      const tags = Array.from(checkboxes).map(cb => cb.value);
      
      const user = auth?.currentUser;
      if (!user || !db) {
        alert('Erro: Usu√°rio n√£o autenticado');
        return;
      }
      
      const uid = user.uid;
      
      try {
        const metadados = {
          url,
          isVideo: isVideo || false,
          descricao,
          tags,
          fileInfo: fileInfo || null,
          updatedAt: new Date().toISOString(),
          updatedBy: user.email
        };
        
        // Usar ID √∫nico baseado na URL e contexto
        const midiaId = gerarMidiaId(url, fileInfo);
        console.log('[Metadados] Salvando com ID:', midiaId);
        
        const metadadosRef = doc(db, 'usuarios', uid, 'midias_metadados', midiaId);
        await setDoc(metadadosRef, metadados, { merge: true });
        
        console.log('‚úÖ Metadados salvos:', metadados);
        
        // Mostrar feedback
        if (typeof mgToast === 'function') {
          mgToast('‚úÖ M√≠dia vinculada aos entreg√°veis!');
        } else {
          alert('‚úÖ Salvo com sucesso!');
        }
        
        // Fechar modal
        hideZoomOverlay();
        
      } catch (error) {
        console.error('Erro ao salvar metadados:', error);
        alert('Erro ao salvar. Tente novamente.');
      }
    }
    // ===== FIM ZOOM OVERLAY =====

    function toggleBlock(weekId, blockId){
      const week = ESTRUTURACAO_DATA.find(w => w.id === weekId);
      const block = week?.blocks.find(b => b.id === blockId);
      if(!week || !block) return;
      
      if(!ESTRUTURACAO_STATE[weekId]) ESTRUTURACAO_STATE[weekId] = { blocks: {} };
      if(!ESTRUTURACAO_STATE[weekId].blocks[blockId]) ESTRUTURACAO_STATE[weekId].blocks[blockId] = { items: {}, notes: '' };
      
      const allCompleted = block.items.every((_, idx) => ESTRUTURACAO_STATE[weekId].blocks[blockId].items[idx]?.completed);
      
      block.items.forEach((_, idx) => {
        if(!ESTRUTURACAO_STATE[weekId].blocks[blockId].items[idx]) ESTRUTURACAO_STATE[weekId].blocks[blockId].items[idx] = { completed: false };
        ESTRUTURACAO_STATE[weekId].blocks[blockId].items[idx].completed = !allCompleted;
      });
      
      persistEstruturacao();
      renderEstruturacao();
    }

    function saveBlockNotes(weekId, blockId, notes){
      if(!ESTRUTURACAO_STATE[weekId]) ESTRUTURACAO_STATE[weekId] = { blocks: {} };
      if(!ESTRUTURACAO_STATE[weekId].blocks[blockId]) ESTRUTURACAO_STATE[weekId].blocks[blockId] = { items: {}, notes: '' };
      
      ESTRUTURACAO_STATE[weekId].blocks[blockId].notes = notes;
      
      persistEstruturacao();
    }

    function renderCustomChecklist(blockEl, weekId, blockId, blockState){
      const container = blockEl.querySelector('.estruturacao-custom-checklist');
      const countEl = blockEl.querySelector(`[data-custom-count="${weekId}-${blockId}"]`);
      if(!container) return;
      
      const customItems = blockState.customChecklist || [];
      container.innerHTML = '';
      
      if(countEl) countEl.textContent = customItems.length;
      
      if(customItems.length === 0){
        container.innerHTML = '<div class="estruturacao-file-empty">Nenhum item personalizado ainda</div>';
        return;
      }
      
      customItems.forEach((item, idx) => {
        const itemEl = document.createElement('div');
        itemEl.className = `estruturacao-custom-item ${item.completed ? 'completed' : ''}`;
        itemEl.innerHTML = `
          <div class="estruturacao-custom-item-checkbox ${item.completed ? 'checked' : ''}"></div>
          <input type="text" class="estruturacao-custom-item-input" value="${item.text || ''}" placeholder="Digite o item...">
          <button class="estruturacao-custom-item-delete" title="Remover">‚úï</button>
        `;
        
        const checkbox = itemEl.querySelector('.estruturacao-custom-item-checkbox');
        const input = itemEl.querySelector('.estruturacao-custom-item-input');
        const deleteBtn = itemEl.querySelector('.estruturacao-custom-item-delete');
        
        checkbox.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleCustomItem(weekId, blockId, idx);
        });
        
        let inputTimeout;
        input.addEventListener('input', (e) => {
          e.stopPropagation();
          clearTimeout(inputTimeout);
          inputTimeout = setTimeout(() => {
            updateCustomItemText(weekId, blockId, idx, input.value);
          }, 500);
        });
        input.addEventListener('click', (e) => e.stopPropagation());
        input.addEventListener('focus', (e) => e.stopPropagation());
        
        deleteBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          deleteCustomItem(weekId, blockId, idx);
        });
        
        container.appendChild(itemEl);
      });
    }

    function renderBlockFiles(blockEl, weekId, blockId, blockState){
      const container = blockEl.querySelector('.estruturacao-files-list');
      const countEl = blockEl.querySelector(`[data-files-count="${weekId}-${blockId}"]`);
      if(!container) return;
      
      const files = blockState.files || [];
      container.innerHTML = '';
      
      if(countEl) countEl.textContent = files.length;
      
      if(files.length === 0){
        container.innerHTML = '<div class="estruturacao-file-empty">Nenhum arquivo anexado ainda</div>';
        return;
      }
      
      files.forEach((file, idx) => {
        const fileEl = document.createElement('div');
        fileEl.className = 'estruturacao-file-item';
        
        const icon = getFileIcon(file.name);
        const size = formatFileSize(file.size);
        
        fileEl.innerHTML = `
          <div class="estruturacao-file-icon">${icon}</div>
          <div class="estruturacao-file-info">
            <p class="estruturacao-file-name">${file.name}</p>
            <p class="estruturacao-file-meta">${size} ‚Ä¢ ${new Date(file.uploadedAt).toLocaleDateString('pt-BR')}</p>
          </div>
          <div class="estruturacao-file-actions">
            <button class="download-file" title="Download">‚¨áÔ∏è</button>
            <button class="delete-file" title="Remover">üóëÔ∏è</button>
          </div>
        `;
        
        const downloadBtn = fileEl.querySelector('.download-file');
        const deleteBtn = fileEl.querySelector('.delete-file');
        
        downloadBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          downloadBlockFile(file);
        });
        
        deleteBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          deleteBlockFile(weekId, blockId, idx);
        });
        
        container.appendChild(fileEl);
      });
    }

    function addCustomChecklistItem(weekId, blockId){
      if(!ESTRUTURACAO_STATE[weekId]) ESTRUTURACAO_STATE[weekId] = { blocks: {} };
      if(!ESTRUTURACAO_STATE[weekId].blocks[blockId]) ESTRUTURACAO_STATE[weekId].blocks[blockId] = { items: {}, notes: '', customChecklist: [] };
      if(!ESTRUTURACAO_STATE[weekId].blocks[blockId].customChecklist) ESTRUTURACAO_STATE[weekId].blocks[blockId].customChecklist = [];
      
      ESTRUTURACAO_STATE[weekId].blocks[blockId].customChecklist.push({
        text: '',
        completed: false
      });
      
      persistEstruturacao();
      renderEstruturacao();
    }

    function toggleCustomItem(weekId, blockId, itemIdx){
      if(!ESTRUTURACAO_STATE[weekId]?.blocks[blockId]?.customChecklist?.[itemIdx]) return;
      
      ESTRUTURACAO_STATE[weekId].blocks[blockId].customChecklist[itemIdx].completed = 
        !ESTRUTURACAO_STATE[weekId].blocks[blockId].customChecklist[itemIdx].completed;
      
      persistEstruturacao();
      renderEstruturacao();
    }

    function updateCustomItemText(weekId, blockId, itemIdx, text){
      if(!ESTRUTURACAO_STATE[weekId]?.blocks[blockId]?.customChecklist?.[itemIdx]) return;
      
      ESTRUTURACAO_STATE[weekId].blocks[blockId].customChecklist[itemIdx].text = text;
      
      persistEstruturacao();
    }

    function deleteCustomItem(weekId, blockId, itemIdx){
      if(!ESTRUTURACAO_STATE[weekId]?.blocks[blockId]?.customChecklist) return;
      
      if(confirm('Remover este item da checklist?')){
        ESTRUTURACAO_STATE[weekId].blocks[blockId].customChecklist.splice(itemIdx, 1);
        persistEstruturacao();
        renderEstruturacao();
      }
    }

    function promptFileUpload(weekId, blockId){
      const input = document.createElement('input');
      input.type = 'file';
      input.multiple = false;
      input.style.display = 'none';
      document.body.appendChild(input);
      
      input.addEventListener('change', async () => {
        const file = input.files?.[0];
        if(file){
          await uploadBlockFile(weekId, blockId, file);
        }
        document.body.removeChild(input);
      });
      
      input.click();
    }

    async function uploadBlockFile(weekId, blockId, file){
      try{
        // VERIFICA√á√ÉO DE SEGURAN√áA: Verificar se auth est√° definido e usu√°rio logado
        if(typeof auth === 'undefined' || !auth){
          console.error('Firebase Auth n√£o inicializado');
          alert('Sistema de autentica√ß√£o n√£o dispon√≠vel. Recarregue a p√°gina.');
          return;
        }
        
        const uid = auth.currentUser?.uid;
        if(!uid){
          alert('Fa√ßa login para enviar arquivos.');
          return;
        }
        
        const safeTenant = (typeof TENANT!=="undefined" && TENANT) ? TENANT : null;
        if(!safeTenant || safeTenant === 'no-client'){
          alert('Cliente n√£o definido na URL.');
          return;
        }
        
        // VERIFICA√á√ÉO DE SEGURAN√áA: Verificar se Storage est√° dispon√≠vel
        if(!STORAGE){
          try{ 
            if(typeof getStorage === 'undefined'){
              throw new Error('getStorage n√£o dispon√≠vel');
            }
            STORAGE = getStorage(app); 
          }
          catch(err){ 
            console.error('Storage init error:', err); 
            alert('Storage n√£o inicializado. Recarregue a p√°gina.'); 
            return; 
          }
        }
        
        if(typeof mgToast === 'function') mgToast('Enviando arquivo...');
        
        const safeName = (file.name||'file').replace(/[^a-zA-Z0-9._-]/g,'_');
        const path = `users/${uid}/tenant-${safeTenant}/estruturacao/${weekId}/${blockId}/${Date.now()}_${safeName}`;
        const ref = sRef(STORAGE, path);
        
        await uploadBytes(ref, file);
        const url = await getDownloadURL(ref);
        
        if(!ESTRUTURACAO_STATE[weekId]) ESTRUTURACAO_STATE[weekId] = { blocks: {} };
        if(!ESTRUTURACAO_STATE[weekId].blocks[blockId]) ESTRUTURACAO_STATE[weekId].blocks[blockId] = { items: {}, notes: '', files: [] };
        if(!ESTRUTURACAO_STATE[weekId].blocks[blockId].files) ESTRUTURACAO_STATE[weekId].blocks[blockId].files = [];
        
        ESTRUTURACAO_STATE[weekId].blocks[blockId].files.push({
          name: file.name,
          size: file.size,
          type: file.type,
          url: url,
          path: path,
          uploadedAt: Date.now()
        });
        
        persistEstruturacao();
        renderEstruturacao();
        
        if(typeof mgToast === 'function') mgToast('Arquivo enviado com sucesso!');
      }catch(err){
        console.error('uploadBlockFile error:', err);
        alert('Erro ao enviar arquivo: ' + (err?.message || String(err)));
      }
    }

    function downloadBlockFile(file){
      if(file.url){
        window.open(file.url, '_blank');
      }
    }

    async function deleteBlockFile(weekId, blockId, fileIdx){
      if(!ESTRUTURACAO_STATE[weekId]?.blocks[blockId]?.files?.[fileIdx]) return;
      
      if(!confirm('Remover este arquivo?')) return;
      
      const file = ESTRUTURACAO_STATE[weekId].blocks[blockId].files[fileIdx];
      
      try{
        // VERIFICA√á√ÉO DE SEGURAN√áA: Apenas tenta deletar se Storage estiver dispon√≠vel
        if(file.path && STORAGE && typeof deleteObject !== 'undefined'){
          const ref = sRef(STORAGE, file.path);
          await deleteObject(ref);
        }
      }catch(err){
        console.warn('Erro ao deletar arquivo do storage:', err);
      }
      
      ESTRUTURACAO_STATE[weekId].blocks[blockId].files.splice(fileIdx, 1);
      persistEstruturacao();
      renderEstruturacao();
      
      if(typeof mgToast === 'function') mgToast('Arquivo removido!');
    }

    // ===== WEEK-LEVEL FUNCTIONS (Texto, Arquivos, Checklist por semana) =====
    
    function ensureWeekDataState(weekId){
      if(!ESTRUTURACAO_STATE[weekId]) ESTRUTURACAO_STATE[weekId] = { blocks: {}, weekData: {} };
      if(!ESTRUTURACAO_STATE[weekId].weekData) ESTRUTURACAO_STATE[weekId].weekData = {};
      const weekData = ESTRUTURACAO_STATE[weekId].weekData;
      if(!weekData.note) weekData.note = '';
      if(!weekData.files) weekData.files = [];
      if(!weekData.checklist) weekData.checklist = [];
      return weekData;
    }
    
    function setupWeekExtrasListeners(weekEl, weekId, weekDataState){
      // Action buttons
      const actionBtns = weekEl.querySelectorAll('.estruturacao-week-action-btn');
      actionBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const action = btn.dataset.action;
          const expandArea = weekEl.querySelector('.estruturacao-week-expand');
          expandArea.classList.remove('hidden');
          
          if(action === 'toggle-week-note'){
            const noteSection = weekEl.querySelector('.estruturacao-week-note-section');
            const isVisible = noteSection.style.display !== 'none';
            noteSection.style.display = isVisible ? 'none' : '';
            if(!isVisible) noteSection.querySelector('[contenteditable]').focus();
          }
          if(action === 'toggle-week-files'){
            const filesSection = weekEl.querySelector('.estruturacao-week-files-section');
            filesSection.style.display = filesSection.style.display === 'none' ? '' : 'none';
          }
          if(action === 'toggle-week-checklist'){
            const checklistSection = weekEl.querySelector('.estruturacao-week-checklist-section');
            checklistSection.style.display = checklistSection.style.display === 'none' ? '' : 'none';
          }
        });
      });
      
      // Contenteditable note handler
      const noteTextarea = weekEl.querySelector('.estruturacao-week-note');
      const noteRaw = weekEl.querySelector('.estruturacao-week-note-raw');
      if(noteTextarea){
        let noteSaveTimeout;
        
        // Handler para colar com Markdown
        noteTextarea.addEventListener('paste', (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          const text = (e.clipboardData || window.clipboardData).getData('text/plain');
          if(!text) return;
          
          // Converter Markdown para HTML
          const html = renderMarkdownText(text);
          
          // Se o contenteditable est√° vazio ou seleciona tudo, substituir tudo
          const selection = window.getSelection();
          const range = selection.rangeCount > 0 ? selection.getRangeAt(0) : null;
          
          // Verificar se est√° selecionando todo o conte√∫do ou se est√° vazio
          const isEmptyOrAllSelected = !noteTextarea.textContent.trim() || 
            (range && range.toString().trim() === noteTextarea.textContent.trim());
          
          if(isEmptyOrAllSelected){
            // Substituir todo o conte√∫do
            noteTextarea.innerHTML = html;
            if(noteRaw) noteRaw.value = text;
          } else {
            // Inserir no cursor
            document.execCommand('insertHTML', false, html);
            // Atualizar raw combinando
            const fullMarkdown = htmlToMarkdown(noteTextarea.innerHTML);
            if(noteRaw) noteRaw.value = fullMarkdown;
          }
          
          // Mover cursor para o final
          const newRange = document.createRange();
          newRange.selectNodeContents(noteTextarea);
          newRange.collapse(false);
          selection.removeAllRanges();
          selection.addRange(newRange);
          
          clearTimeout(noteSaveTimeout);
          noteSaveTimeout = setTimeout(() => {
            const rawMarkdown = noteRaw ? noteRaw.value : htmlToMarkdown(noteTextarea.innerHTML);
            saveWeekNote(weekId, rawMarkdown);
          }, 800);
        });
        
        noteTextarea.addEventListener('input', (e) => {
          e.stopPropagation();
          clearTimeout(noteSaveTimeout);
          noteSaveTimeout = setTimeout(() => {
            const rawMarkdown = htmlToMarkdown(noteTextarea.innerHTML);
            if(noteRaw) noteRaw.value = rawMarkdown;
            saveWeekNote(weekId, rawMarkdown);
          }, 800);
        });
        noteTextarea.addEventListener('click', (e) => e.stopPropagation());
        noteTextarea.addEventListener('focus', (e) => e.stopPropagation());
        
        // Salvar imediatamente ao sair do campo
        let lastSavedNote = weekDataState.note || '';
        noteTextarea.addEventListener('blur', (e) => {
          e.stopPropagation();
          clearTimeout(noteSaveTimeout);
          const currentNote = htmlToMarkdown(noteTextarea.innerHTML);
          if(currentNote !== lastSavedNote){
            saveWeekNote(weekId, currentNote);
            lastSavedNote = currentNote;
            console.log('[Estrutura√ß√£o] Nota da semana salva no blur:', weekId);
          }
        });
        
        // Atalhos de teclado para formata√ß√£o
        noteTextarea.addEventListener('keydown', (e) => {
          if(e.ctrlKey || e.metaKey){
            let action = null;
            switch(e.key.toLowerCase()){
              case 'b': action = 'bold'; break;
              case 'i': action = 'italic'; break;
            }
            if(action){
              e.preventDefault();
              applyMarkdownFormatting(noteTextarea, action);
            }
          }
        });
      }
      
      // Markdown toolbar handlers for week note
      const weekMdToolbar = weekEl.querySelector('.estruturacao-week-markdown-toolbar');
      
      if(weekMdToolbar && noteTextarea){
        weekMdToolbar.addEventListener('click', (e) => {
          e.stopPropagation();
          const btn = e.target.closest('[data-md-action]');
          if(!btn) return;
          
          const action = btn.dataset.mdAction;
          applyMarkdownFormatting(noteTextarea, action);
        });
      }
      
      // Upload button handler
      const uploadBtn = weekEl.querySelector('.estruturacao-week-upload-btn');
      if(uploadBtn){
        uploadBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          promptWeekFileUpload(weekId);
        });
      }
      
      // Paste zone handlers
      const pasteZone = weekEl.querySelector('.estruturacao-week-paste-zone');
      if(pasteZone){
        pasteZone.addEventListener('click', (e) => {
          e.stopPropagation();
          promptWeekFileUpload(weekId);
        });
        pasteZone.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.stopPropagation();
          pasteZone.classList.add('dragover');
        });
        pasteZone.addEventListener('dragleave', (e) => {
          e.stopPropagation();
          pasteZone.classList.remove('dragover');
        });
        pasteZone.addEventListener('drop', (e) => {
          e.preventDefault();
          e.stopPropagation();
          pasteZone.classList.remove('dragover');
          const files = e.dataTransfer.files;
          if(files.length > 0){
            handleWeekFileUpload(weekId, files[0]);
          }
        });
        pasteZone.addEventListener('paste', (e) => {
          e.stopPropagation();
          const items = e.clipboardData?.items;
          if(items){
            for(let i=0;i<items.length;i++){
              if(items[i].type.indexOf('image') !== -1){
                const blob = items[i].getAsFile();
                if(blob) handleWeekFileUpload(weekId, blob);
                break;
              }
            }
          }
        });
        pasteZone.setAttribute('tabindex', '0');
      }
      
      // Add checklist item button
      const addChecklistBtn = weekEl.querySelector('.estruturacao-week-checklist-add');
      if(addChecklistBtn){
        addChecklistBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          addWeekChecklistEntry(weekId);
        });
      }
      
      // Render existing files and checklist
      renderWeekFiles(weekEl, weekId, weekDataState);
      renderWeekChecklist(weekEl, weekId, weekDataState);
    }
    
    function saveWeekNote(weekId, note){
      console.log('[ESTRUTURACAO] saveWeekNote chamado:', weekId, 'tamanho da nota:', note?.length || 0);
      const weekData = ensureWeekDataState(weekId);
      weekData.note = note;
      weekData.noteUpdatedAt = new Date().toISOString();
      console.log('[ESTRUTURACAO] Nota salva no estado local, chamando persistEstruturacao');
      persistEstruturacao();
    }
    
    function promptWeekFileUpload(weekId){
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*,application/pdf,.doc,.docx,.txt,.xls,.xlsx';
      input.multiple = false;
      input.style.display = 'none';
      document.body.appendChild(input);
      
      input.addEventListener('change', () => {
        const file = input.files?.[0];
        if(file){
          handleWeekFileUpload(weekId, file);
        }
        document.body.removeChild(input);
      });
      
      input.click();
    }
    
    async function handleWeekFileUpload(weekId, file){
      try{
        if(typeof auth === 'undefined' || !auth){
          console.error('Firebase Auth n√£o inicializado');
          alert('Sistema de autentica√ß√£o n√£o dispon√≠vel. Recarregue a p√°gina.');
          return;
        }
        
        const uid = auth.currentUser?.uid;
        if(!uid){
          alert('Fa√ßa login para enviar arquivos.');
          return;
        }
        
        const safeTenant = (typeof TENANT!=="undefined" && TENANT) ? TENANT : null;
        if(!safeTenant || safeTenant === 'no-client'){
          alert('Cliente n√£o definido na URL.');
          return;
        }
        
        if(!STORAGE){
          try{ 
            if(typeof getStorage === 'undefined'){
              throw new Error('getStorage n√£o dispon√≠vel');
            }
            STORAGE = getStorage(app); 
          }
          catch(err){ 
            console.error('Storage init error:', err); 
            alert('Storage n√£o inicializado. Recarregue a p√°gina.'); 
            return; 
          }
        }
        
        if(typeof mgToast === 'function') mgToast('Enviando arquivo...');
        
        const safeName = (file.name||'file').replace(/[^a-zA-Z0-9._-]/g,'_');
        const path = `users/${uid}/tenant-${safeTenant}/estruturacao/${weekId}/weekFiles/${Date.now()}_${safeName}`;
        const ref = sRef(STORAGE, path);
        
        await uploadBytes(ref, file);
        const url = await getDownloadURL(ref);
        
        const weekData = ensureWeekDataState(weekId);
        weekData.files.push({
          name: file.name || 'imagem.png',
          size: file.size,
          type: file.type,
          url: url,
          path: path,
          uploadedAt: Date.now()
        });
        
        persistEstruturacao();
        renderEstruturacao();
        
        if(typeof mgToast === 'function') mgToast('Arquivo enviado com sucesso!');
      }catch(err){
        console.error('handleWeekFileUpload error:', err);
        alert('Erro ao enviar arquivo: ' + (err?.message || String(err)));
      }
    }
    
    async function deleteWeekFile(weekId, fileIdx){
      const weekData = ESTRUTURACAO_STATE[weekId]?.weekData;
      if(!weekData?.files?.[fileIdx]) return;
      
      if(!confirm('Remover este arquivo?')) return;
      
      const file = weekData.files[fileIdx];
      
      try{
        if(file.path && STORAGE && typeof deleteObject !== 'undefined'){
          const ref = sRef(STORAGE, file.path);
          await deleteObject(ref);
        }
      }catch(err){
        console.warn('Erro ao deletar arquivo do storage:', err);
      }
      
      weekData.files.splice(fileIdx, 1);
      persistEstruturacao();
      renderEstruturacao();
      
      if(typeof mgToast === 'function') mgToast('Arquivo removido!');
    }
    
    function renderWeekFiles(weekEl, weekId, weekDataState){
      const container = weekEl.querySelector(`.estruturacao-week-files-list[data-week-id="${weekId}"]`);
      if(!container) return;
      
      const files = weekDataState.files || [];
      container.innerHTML = '';
      
      if(files.length === 0) return;
      
      files.forEach((file, fIdx) => {
        const fileEl = document.createElement('div');
        fileEl.className = 'estruturacao-week-file';
        
        const isImage = file.type?.startsWith('image/');
        
        if(isImage){
          fileEl.innerHTML = `
            <img src="${file.url}" alt="${file.name}">
            <div class="estruturacao-week-file-overlay">
              <button class="view" title="Ver">üëÅÔ∏è</button>
              <button class="delete" title="Remover">üóëÔ∏è</button>
            </div>
          `;
        }else{
          const icon = getFileIcon(file.name);
          fileEl.innerHTML = `
            <div class="estruturacao-week-file-doc">
              ${icon}
              <span>${file.name}</span>
            </div>
            <div class="estruturacao-week-file-overlay">
              <button class="view" title="Baixar">‚¨áÔ∏è</button>
              <button class="delete" title="Remover">üóëÔ∏è</button>
            </div>
          `;
        }
        
        const viewBtn = fileEl.querySelector('.view');
        const deleteBtn = fileEl.querySelector('.delete');
        
        viewBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          // Para imagens abre zoom, para outros abre link
          if(isImage){
            // Criar fileInfo com contexto completo para ID √∫nico
            const fileInfo = {
              url: file.url,
              name: file.name,
              weekId: weekId,
              blockId: null,
              itemIdx: null,
              fileIdx: fIdx
            };
            showZoomOverlay(file.url, false, () => {
              deleteWeekFile(weekId, fIdx);
            }, fileInfo);
          }else{
            window.open(file.url, '_blank');
          }
        });
        
        deleteBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          deleteWeekFile(weekId, fIdx);
        });
        
        container.appendChild(fileEl);
      });
    }
    
    function addWeekChecklistEntry(weekId){
      const weekData = ensureWeekDataState(weekId);
      weekData.checklist.push({ text: '', completed: false, createdAt: new Date().toISOString() });
      console.log('[Estrutura√ß√£o] Novo item de checklist adicionado:', weekId);
      persistEstruturacao();
      renderEstruturacao();
    }
    
    function toggleWeekCheckEntry(weekId, checkIdx){
      const weekData = ESTRUTURACAO_STATE[weekId]?.weekData;
      if(!weekData?.checklist?.[checkIdx]) return;
      
      const newState = !weekData.checklist[checkIdx].completed;
      weekData.checklist[checkIdx].completed = newState;
      weekData.checklist[checkIdx].completedAt = newState ? new Date().toISOString() : null;
      console.log('[Estrutura√ß√£o] Toggle checklist:', weekId, 'idx', checkIdx, '- novo estado:', newState);
      persistEstruturacao();
      renderEstruturacao();
    }
    
    function updateWeekCheckText(weekId, checkIdx, text){
      const weekData = ESTRUTURACAO_STATE[weekId]?.weekData;
      if(!weekData?.checklist?.[checkIdx]) return;
      
      weekData.checklist[checkIdx].text = text;
      weekData.checklist[checkIdx].updatedAt = new Date().toISOString();
      console.log('[Estrutura√ß√£o] Texto checklist atualizado:', weekId, 'idx', checkIdx, '- tamanho:', text?.length || 0);
      persistEstruturacao();
    }
    
    function deleteWeekCheckEntry(weekId, checkIdx){
      const weekData = ESTRUTURACAO_STATE[weekId]?.weekData;
      if(!weekData?.checklist?.[checkIdx]) return;
      
      if(confirm('Remover este item da checklist?')){
        weekData.checklist.splice(checkIdx, 1);
        console.log('[Estrutura√ß√£o] Checklist item removido:', weekId, 'idx', checkIdx);
        persistEstruturacao();
        renderEstruturacao();
      }
    }
    
    function renderWeekChecklist(weekEl, weekId, weekDataState){
      const container = weekEl.querySelector(`.estruturacao-week-checklist-items[data-week-id="${weekId}"]`);
      if(!container) return;
      
      const checklist = weekDataState.checklist || [];
      container.innerHTML = '';
      
      if(checklist.length === 0){
        container.innerHTML = '<div class="estruturacao-week-checklist-empty">Nenhum item ainda</div>';
        return;
      }
      
      checklist.forEach((check, cIdx) => {
        const checkEl = document.createElement('div');
        checkEl.className = `estruturacao-week-check ${check.completed ? 'completed' : ''}`;
        checkEl.innerHTML = `
          <div class="estruturacao-week-check-box ${check.completed ? 'checked' : ''}"></div>
          <input type="text" class="estruturacao-week-check-input" value="${check.text || ''}" placeholder="Digite o item...">
          <button class="estruturacao-week-check-delete" title="Remover">‚úï</button>
        `;
        
        const checkbox = checkEl.querySelector('.estruturacao-week-check-box');
        const input = checkEl.querySelector('.estruturacao-week-check-input');
        const deleteBtn = checkEl.querySelector('.estruturacao-week-check-delete');
        
        checkbox.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleWeekCheckEntry(weekId, cIdx);
        });
        
        let inputTimeout;
        let lastSavedValue = check.text || '';
        
        input.addEventListener('input', (e) => {
          e.stopPropagation();
          clearTimeout(inputTimeout);
          inputTimeout = setTimeout(() => {
            updateWeekCheckText(weekId, cIdx, input.value);
            lastSavedValue = input.value;
          }, 500);
        });
        
        // Salvar imediatamente ao sair do campo
        input.addEventListener('blur', (e) => {
          e.stopPropagation();
          clearTimeout(inputTimeout);
          if(input.value !== lastSavedValue){
            updateWeekCheckText(weekId, cIdx, input.value);
            lastSavedValue = input.value;
            console.log('[Estrutura√ß√£o] Checklist salvo no blur:', weekId, cIdx);
          }
        });
        
        input.addEventListener('click', (e) => e.stopPropagation());
        input.addEventListener('focus', (e) => e.stopPropagation());
        
        deleteBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          deleteWeekCheckEntry(weekId, cIdx);
        });
        
        // Prevenir que cliques dentro do check propaguem para o week header
        checkEl.addEventListener('click', (e) => {
          e.stopPropagation();
        });
        
        container.appendChild(checkEl);
      });
    }
    
    // ===== PESQUISA NA ESTRUTURA√á√ÉO =====
    function initEstruturacaoSearch(){
      const searchInput = document.getElementById('estruturacaoSearchInput');
      const searchClear = document.getElementById('estruturacaoSearchClear');
      const searchResults = document.getElementById('estruturacaoSearchResults');
      
      if(!searchInput) return;
      
      let searchTimeout;
      
      searchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          performEstruturacaoSearch(e.target.value);
        }, 200);
      });
      
      searchInput.addEventListener('keydown', (e) => {
        if(e.key === 'Escape'){
          searchInput.value = '';
          performEstruturacaoSearch('');
          searchInput.blur();
        }
      });
      
      if(searchClear){
        searchClear.addEventListener('click', () => {
          searchInput.value = '';
          performEstruturacaoSearch('');
          searchInput.focus();
        });
      }
    }
    
    function performEstruturacaoSearch(query, options = {}){
      const { skipScroll = false } = options;
      const searchResults = document.getElementById('estruturacaoSearchResults');
      const weeksContainer = document.getElementById('estruturacaoWeeks');
      if(!weeksContainer) return;
      
      const q = query.trim().toLowerCase();
      
      // Limpar classes de busca anteriores
      weeksContainer.querySelectorAll('.search-hidden').forEach(el => {
        el.classList.remove('search-hidden');
      });
      weeksContainer.querySelectorAll('.search-highlight').forEach(el => {
        el.outerHTML = el.textContent;
      });
      
      // Se n√£o h√° query, mostrar tudo normalmente
      if(!q){
        if(searchResults){
          searchResults.classList.remove('active');
          searchResults.innerHTML = '';
        }
        return;
      }
      
      let matchCount = 0;
      let firstMatch = null;
      
      // Percorrer todas as semanas
      const weeks = weeksContainer.querySelectorAll('.estruturacao-week');
      weeks.forEach(weekEl => {
        let weekHasMatch = false;
        let weekTitleMatch = false;
        
        // Verificar t√≠tulo da semana
        const weekTitle = weekEl.querySelector('.estruturacao-week-title');
        const weekDesc = weekEl.querySelector('.estruturacao-week-desc');
        if(weekTitle && weekTitle.textContent.toLowerCase().includes(q)){
          weekTitleMatch = true;
          weekHasMatch = true;
          highlightText(weekTitle, q);
        }
        if(weekDesc && weekDesc.textContent.toLowerCase().includes(q)){
          weekTitleMatch = true;
          weekHasMatch = true;
        }
        
        // Percorrer blocos
        const blocks = weekEl.querySelectorAll('.estruturacao-block');
        blocks.forEach(blockEl => {
          let blockHasMatch = false;
          let blockTitleMatch = false;
          
          // Verificar t√≠tulo do bloco
          const blockTitle = blockEl.querySelector('.estruturacao-block-title');
          if(blockTitle && blockTitle.textContent.toLowerCase().includes(q)){
            blockTitleMatch = true;
            blockHasMatch = true;
            highlightText(blockTitle, q);
          }
          
          // Verificar preview do bloco
          const blockPreview = blockEl.querySelector('.estruturacao-block-summary-preview');
          if(blockPreview && blockPreview.textContent.toLowerCase().includes(q)){
            blockTitleMatch = true;
            blockHasMatch = true;
          }
          
          // Percorrer itens
          const items = blockEl.querySelectorAll('.estruturacao-item');
          items.forEach(itemEl => {
            let itemHasMatch = false;
            
            // Se o t√≠tulo do bloco tem match, mostrar todos os itens
            if(blockTitleMatch){
              itemHasMatch = true;
            }
            
            // Verificar texto do item
            const itemText = itemEl.querySelector('.estruturacao-item-text');
            if(itemText && itemText.textContent.toLowerCase().includes(q)){
              itemHasMatch = true;
              highlightText(itemText, q);
            }
            
            // Verificar preview do item
            const itemPreview = itemEl.querySelector('.estruturacao-item-preview');
            if(itemPreview && itemPreview.textContent.toLowerCase().includes(q)){
              itemHasMatch = true;
            }
            
            // Verificar nota do item (raw)
            const noteRaw = itemEl.querySelector('.estruturacao-item-note-raw');
            if(noteRaw && noteRaw.value && noteRaw.value.toLowerCase().includes(q)){
              itemHasMatch = true;
            }
            
            // Verificar nota renderizada
            const noteRendered = itemEl.querySelector('.estruturacao-item-note');
            if(noteRendered && noteRendered.textContent.toLowerCase().includes(q)){
              itemHasMatch = true;
            }
            
            if(itemHasMatch){
              matchCount++;
              blockHasMatch = true;
              if(!firstMatch) firstMatch = {item: itemEl, block: blockEl, week: weekEl};
            } else {
              // Esconder item que n√£o tem match
              itemEl.classList.add('search-hidden');
            }
          });
          
          // Se o t√≠tulo da semana tem match, mostrar todos os blocos
          if(weekTitleMatch){
            blockHasMatch = true;
          }
          
          if(blockHasMatch){
            weekHasMatch = true;
            // Expandir bloco para mostrar itens
            blockEl.classList.add('open');
          } else {
            // Esconder bloco que n√£o tem match
            blockEl.classList.add('search-hidden');
          }
        });
        
        if(weekHasMatch){
          // Expandir semana para mostrar blocos
          weekEl.classList.add('open');
        } else {
          // Esconder semana que n√£o tem match
          weekEl.classList.add('search-hidden');
        }
      });
      
      // Scroll para o primeiro resultado (apenas se n√£o for restaura√ß√£o)
      if(firstMatch && !skipScroll){
        setTimeout(() => {
          firstMatch.item.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
      }
      
      // Mostrar resultados
      if(searchResults){
        if(matchCount > 0){
          searchResults.classList.add('active');
          searchResults.innerHTML = `<span class="highlight">${matchCount}</span> resultado${matchCount > 1 ? 's' : ''} encontrado${matchCount > 1 ? 's' : ''} para "<strong>${escapeHtml(query)}</strong>" - <em>clique para expandir e editar</em>`;
        } else {
          searchResults.classList.add('active');
          searchResults.innerHTML = `Nenhum resultado para "<strong>${escapeHtml(query)}</strong>"`;
        }
      }
    }
    
    function highlightText(element, query){
      const text = element.textContent;
      const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      const highlighted = text.replace(regex, '<span class="search-highlight">$1</span>');
      element.innerHTML = highlighted;
    }
    
    // Inicializar busca quando a estrutura√ß√£o for carregada
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(initEstruturacaoSearch, 500);
      setTimeout(initMediaGalleryEvents, 500);
      setTimeout(updateMediaFilterCounts, 600);
    });
    
    // Handler global para cliques em links dentro das notas de estrutura√ß√£o
    // NOTA: Definido fora do DOMContentLoaded para garantir prioridade m√°xima
    (function(){
      let pendingLinkHref = null;
      
      function openLinkInNewTab(href) {
        // Tentativa 1: window.open
        try {
          const w = window.open(href, '_blank', 'noopener,noreferrer');
          if(w) {
            w.opener = null;
            return true;
          }
        } catch(e) {
          console.warn('window.open blocked', e);
        }
        
        // Tentativa 2: criar link e clicar
        try {
          const a = document.createElement('a');
          a.href = href;
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
          a.style.display = 'none';
          document.body.appendChild(a);
          a.click();
          setTimeout(() => a.remove(), 100);
          return true;
        } catch(e) {
          console.warn('link click failed', e);
        }
        
        return false;
      }
      
      function isNoteLink(target) {
        if(!target || !target.tagName) return null;
        let link = target;
        if(link.tagName !== 'A') {
          link = target.closest ? target.closest('a[href]') : null;
        }
        if(link && link.tagName === 'A' && 
           (link.closest('.estruturacao-item-note') || link.closest('.estruturacao-week-notes'))){
          const href = link.getAttribute('href');
          if(href && /^https?:\/\//i.test(href)){
            return href;
          }
        }
        return null;
      }
      
      // Marcar inten√ß√£o no mousedown (para evitar que o contenteditable capture)
      document.addEventListener('mousedown', (e) => {
        const href = isNoteLink(e.target);
        if(href){
          pendingLinkHref = href;
          // N√£o previne o default aqui para permitir sele√ß√£o de texto se arrastar
        }
      }, true);
      
      // Limpar se o mouse sair
      document.addEventListener('mouseout', () => {
        pendingLinkHref = null;
      });
      
      // Abrir no click
      document.addEventListener('click', (e) => {
        const href = isNoteLink(e.target);
        if(href){
          e.preventDefault();
          e.stopPropagation();
          if(e.stopImmediatePropagation) e.stopImmediatePropagation();
          openLinkInNewTab(href);
          pendingLinkHref = null;
          return false;
        }
      }, true);
    })();
    
    // ===== FIM PESQUISA NA ESTRUTURA√á√ÉO =====
    
    // ===== FIM WEEK-LEVEL FUNCTIONS =====
    
    // ===== FIM ITEM-LEVEL FUNCTIONS =====

    // formatFileSize j√° definida globalmente - usar a existente

    async function renderAccesses(){
      console.log('üîê [ACESSOS] renderAccesses chamada');
      
      // Se ACCESSES est√° vazio, tentar carregar da async
      if(ACCESSES.length === 0){
        await loadAccessesFromUserDataAsync();
      } else {
        loadAccessesFromUserData();
      }
      
      console.log('üîê [ACESSOS] Ap√≥s load, ACCESSES:', ACCESSES.length, 'itens');
      const list = $("accessList");
      const search = ($("accessSearch").value||"").toLowerCase().trim();
      let items = [...ACCESSES];
      console.log('üîê [ACESSOS] Items para renderizar:', items.length);
      if(search){
        items = items.filter(a => [a.name,a.url,a.user,(a.tags||"")].join(" ").toLowerCase().includes(search));
      }
      list.innerHTML = "";
      if(items.length===0){
        const d=document.createElement("div"); d.className="access-empty"; d.textContent="Nenhum acesso cadastrado."; list.appendChild(d); return;
      }
      items.forEach(a=>{
        const row=document.createElement("div"); row.className="access-row";
        row.innerHTML=`
          <div class="cell"><strong>${a.name||"-"}</strong></div>
          <div class="cell"><a href="${a.url||'#'}" target="_blank" rel="noopener">${a.url||"-"}</a></div>
          <div class="cell">${a.user||"-"}</div>
          <div class="cell">
            <span class="pw" data-pw="${a.pass||""}">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
            <button class="btn small ghost btn-eye" title="Mostrar/ocultar">üëÅ</button>
            <button class="btn small ghost btn-copy-pass" title="Copiar senha">üìã</button>
          </div>
          <div class="cell hide-sm">${(a.tags||"").split(",").filter(Boolean).map(t=>`<span class="pill">${t.trim()}</span>`).join(" ")||"-"}</div>
          <div class="actions">
            <button class="btn small" data-act="edit">Editar</button>
            <button class="btn small secondary" data-act="open">Abrir</button>
            <button class="btn small secondary" data-act="copy-user">Copiar usu√°rio</button>
            <button class="btn small secondary" data-act="del">Excluir</button>
          </div>
        `;
        row.querySelector(".btn-eye").onclick=()=>{
          const span=row.querySelector(".pw"); const cur=span.textContent;
          if(cur.startsWith("‚Ä¢")) span.textContent = span.dataset.pw || "";
          else span.textContent = "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
        };
        row.querySelector(".btn-copy-pass").onclick=async()=> {
          const copiado = await mgCopyToClipboard(row.querySelector(".pw").dataset.pw||"");
          if(copiado && typeof mgToast === 'function') mgToast('Senha copiada!');
        };
        row.querySelector('[data-act="copy-user"]').onclick=async()=> {
          const copiado = await mgCopyToClipboard(a.user||"");
          if(copiado && typeof mgToast === 'function') mgToast('Usu√°rio copiado!');
        };
        row.querySelector('[data-act="open"]').onclick=()=> { if(a.url) window.open(a.url,"_blank","noopener"); };
        row.querySelector('[data-act="edit"]').onclick=()=> openAccessForm(a);
        row.querySelector('[data-act="del"]').onclick=async()=>{
          if(!confirm("Excluir este acesso?")) return;
          ACCESSES = ACCESSES.filter(x=>x.id!==a.id);
          await persistAccesses(); renderAccesses();
        };
        list.appendChild(row);
      });
    }
    function openAccessForm(item=null){
      accessForm.style.display="grid";
      editingId = item?.id || null;
      $("fName").value = item?.name || "";
      $("fUrl").value  = item?.url  || "";
      $("fUser").value = item?.user || "";
      $("fPass").value = item?.pass || "";
      $("fTags").value = item?.tags || "";
      $("fName").focus();
    }
    $("accessAdd").onclick = ()=> openAccessForm(null);
    $("fCancel").onclick = ()=> { accessForm.style.display="none"; editingId=null; };
    $("fSave").onclick = async ()=>{
      const name=$("fName").value.trim();
      const url =($("fUrl").value||"").trim();
      const user=($("fUser").value||"").trim();
      const pass=($("fPass").value||"").trim();
      const tags=($("fTags").value||"").trim();
      if(!name){ alert("Informe um nome (ex: Instagram, Site, Google My Business)"); $("fName").focus(); return; }
      if(editingId){
        const idx=ACCESSES.findIndex(x=>x.id===editingId);
        if(idx>=0) ACCESSES[idx]={...ACCESSES[idx],name,url,user,pass,tags};
      }else{
        ACCESSES.push({id:uuid(),name,url,user,pass,tags});
      }
      await persistAccesses();
      accessForm.style.display="none"; editingId=null;
      renderAccesses();
    };
    $("accessSearch").addEventListener("input", ()=> renderAccesses());
    $("accessExport").onclick = ()=>{
      const rows = [["Nome","URL","Usu√°rio","Senha","Tags"]];
      ACCESSES.forEach(a=> rows.push([a.name||"",a.url||"",a.user||"",a.pass||"",a.tags||""]));
      const csv = rows.map(r=> r.map(v=> `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
      const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
      const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="acessos.csv"; document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();
    };

    /* ========= CAC DATA ========= */
    let CAC_DATA = { currency:'BRL', expenses:{}, sales:{}, revenue:{}, salesAds:{}, revenueAds:{} };
    function loadCACFromUserData(){
      const data = USER_DATA.cac;
      if(data && typeof data === 'object'){
        CAC_DATA = {
          currency: data.currency || 'BRL',
          expenses: data.expenses || {},
          sales: data.sales || {},
          revenue: data.revenue || {},
          salesAds: data.salesAds || {},
          revenueAds: data.revenueAds || {}
        };
      } else {
        CAC_DATA = { currency:'BRL', expenses:{}, sales:{}, revenue:{}, salesAds:{}, revenueAds:{} };
      }
      try{ refreshMacroInsights(); }catch(_){ }
    }
    async function persistCAC(){
      const uid = auth.currentUser?.uid;
      if(!uid) return;
      USER_DATA.cac = CAC_DATA;
      const result = await safeWriteUserDoc({ cac: CAC_DATA });
      if(!result.success) {
        console.error('‚ùå Falha ao salvar CAC:', result.error);
        mgToast('‚ö†Ô∏è Erro ao salvar dados CAC', 'error', 3000);
        return;
      }
      if(result.autoCleanup || result.emergencyCleanup) {
        console.log('üßπ Limpeza autom√°tica executada ao salvar CAC');
      }
      try{ refreshMacroInsights(); }catch(_){ }
    }

    /* ========= metas ========= */
    let METAS = [];
    let CURRENT_METAS_YEAR = new Date().getFullYear(); // Ano atual selecionado
    let META_PANELS = Array(6).fill(null);
    const META_MONTHS = ['jan','fev','mar','abr','mai','jun','jul','ago','set','out','nov','dez'];
    const META_MONTH_LABELS = { jan:'Janeiro', fev:'Fevereiro', mar:'Mar√ßo', abr:'Abril', mai:'Maio', jun:'Junho', jul:'Julho', ago:'Agosto', set:'Setembro', out:'Outubro', nov:'Novembro', dez:'Dezembro' };
    const METAS_LS_KEY = 'mg_metas_cache';
    let metasFormUnsub = null;
    let metasFormAppliedVersions = {};
    const META_TAG_OPTIONS = ['investimento_publicidade','faturamento_trafego','roas_publicidade','taxa_mql','leads_aquecidos','cac','seguidores_tracao','comentarios_gbp','negocios_fechados','valor_contratos_mes','orcamentos_recorrentes','negocios_fechados_recorrentes','taxa_conversao_recorrentes','leads_novos','orcamentos_leads_novos','negocios_fechados_leads_novos','taxa_conversao_leads_novos','valor_orcamentos_perdidos','leads_gerados'];

    function createEmptyMonths(){
      const o = {};
      META_MONTHS.forEach(m => o[m] = { p:'', r:'' });
      return o;
    }

    function createMeta(){
      return {
        id: uuid(),
        pos: 0,
        setor: 'comercial',
        descricao: '',
        tag: '',
        unidade: '%',
        direcao: 'aumentar',
        modo: 'total',
        ativo: true,
        meses: createEmptyMonths()
      };
    }

    function nextMetaPos(){
      return METAS.reduce((max,m)=>Math.max(max, m.pos||0),0) + 1;
    }

    function createDefaultMetas(){
      const defs = [
        {setor:'marketing', descricao:'Investimento em publicidade', unidade:'BRL', direcao:'aumentar', tag:'investimento_publicidade'},
        {setor:'marketing', descricao:'Faturamento com origem no tr√°fego', unidade:'BRL', direcao:'aumentar', tag:'faturamento_trafego'},
        {setor:'marketing', descricao:'N√∫mero de leads gerados', unidade:'BRL', direcao:'aumentar', tag:'faturamento_trafego'},
        {setor:'marketing', descricao:'ROAS (Retorno do Investimento em Publicidade)', unidade:'%', direcao:'aumentar', tag:'roas_publicidade'},
        {setor:'marketing', descricao:'Taxa de leads qualificados (MQL)', unidade:'%', direcao:'aumentar', tag:'taxa_mql'},
        {setor:'marketing', descricao:'CPL (Custo por Lead)', unidade:'BRL', direcao:'diminuir'},
        {setor:'marketing', descricao:'CAC (Custo de Aquisi√ß√£o de Cliente)', unidade:'BRL', direcao:'diminuir', tag:'cac'},
        {setor:'marketing', descricao:'N¬∫ de leads aquecidos (nutri√ß√£o)', unidade:'numero', direcao:'aumentar', tag:'leads_aquecidos'},
        {setor:'marketing', descricao:'N¬∫ de seguidores (canais de tra√ß√£o)', unidade:'numero', direcao:'aumentar', tag:'seguidores_tracao'},
        {setor:'marketing', descricao:'Coment√°rios positivos no GBP', unidade:'numero', direcao:'aumentar', tag:'comentarios_gbp'},
        {setor:'comercial', descricao:'Faturamento total das Vendas', unidade:'BRL', direcao:'aumentar'},
        {setor:'comercial', descricao:'Neg√≥cios fechados de clientes recorrentes', unidade:'numero', direcao:'aumentar'},
        {setor:'comercial', descricao:'Taxa de convers√£o clientes recorrentes', unidade:'%', direcao:'aumentar'},
        {setor:'comercial', descricao:'Leads novos', unidade:'numero', direcao:'aumentar'},
        {setor:'comercial', descricao:'Or√ßamentos leads novos', unidade:'numero', direcao:'aumentar'},
        {setor:'comercial', descricao:'Neg√≥cios fechados leads novos', unidade:'numero', direcao:'aumentar'},
        {setor:'comercial', descricao:'N√∫mero de neg√≥cios fechados', unidade:'numero', direcao:'aumentar', fixed:true},
        {setor:'comercial', descricao:'Taxa de convers√£o leads novos', unidade:'%', direcao:'aumentar'},
        {setor:'comercial', descricao:'Valor de or√ßamentos perdidos', unidade:'BRL', direcao:'diminuir'}
      ];
      return defs.map((d,i) => ({...createMeta(), pos:i+1, ...d}));
    }

    function calcRoasMeta(){
      const active = Array.isArray(METAS) ? METAS.filter(m => m && m.ativo !== false) : [];
      const inv = active.find(m => m.tag === 'investimento_publicidade');
      const fat = active.find(m => m.tag === 'faturamento_trafego');
      const roas = active.find(m => m.tag === 'roas_publicidade');
      if(!inv || !fat || !roas) return;
      roas.unidade = '%';
      META_MONTHS.forEach(m => {
        const invR = parseFloat(inv.meses?.[m]?.r) || 0;
        const fatR = parseFloat(fat.meses?.[m]?.r) || 0;
        if(invR){
          const ratio = fatR / invR;
          roas.meses[m].r = parseFloat(ratio.toFixed(2));
        } else {
          roas.meses[m].r = 0;
        }
      });
    }

    function loadMetasFromUserData(){
      // Carregar metas do ano selecionado
      const yearKey = `metas_${CURRENT_METAS_YEAR}`;
      
      if(!USER_DATA[yearKey] || !Array.isArray(USER_DATA[yearKey])){
        try{
          const cached = JSON.parse(localStorage.getItem(`${METAS_LS_KEY}_${CURRENT_METAS_YEAR}`) || '[]');
          if(Array.isArray(cached) && cached.length){
            USER_DATA[yearKey] = cached;
          }
        }catch(_){ /* ignore */ }
      }
      
      METAS = Array.isArray(USER_DATA[yearKey]) ? USER_DATA[yearKey] : [];
      let changed = false;
      let maxPos = METAS.reduce((max,m)=>Math.max(max, m.pos||0),0);
      METAS = METAS.map(m => {
        const meta = { ...createMeta(), ...m, meses: { ...createEmptyMonths(), ...(m.meses||{}) } };
        if(meta.ativo === undefined){ meta.ativo = true; }
        if(!meta.pos || meta.pos <= 0){ meta.pos = ++maxPos; changed = true; }
        return meta;
      });
      const norm = s => (s||'').toLowerCase().normalize('NFD').replace(/[ÃÄ-ÕØ]/g,'').trim();
      if(METAS.length === 0){
        METAS = createDefaultMetas();
        changed = true;
      }
      METAS = METAS.map(m => {
        // Remove qualquer bloqueio autom√°tico - todas as metas s√£o edit√°veis
        if(m.fixed){ 
          m.fixed = false; 
          changed = true; 
        }
        return m;
      });
      calcRoasMeta();
      try{ localStorage.setItem(`${METAS_LS_KEY}_${CURRENT_METAS_YEAR}`, JSON.stringify(METAS)); }catch(_){ }
      if(changed){
        persistMetas();
      }
      try{ refreshMacroInsights(); }catch(_){ }
    }

    async function persistMetas(){
      calcRoasMeta();
      const yearKey = `metas_${CURRENT_METAS_YEAR}`;
      USER_DATA[yearKey] = METAS;
      try{ localStorage.setItem(`${METAS_LS_KEY}_${CURRENT_METAS_YEAR}`, JSON.stringify(METAS)); }catch(_){ }
      const uid = auth.currentUser?.uid;
      if(uid){
        // Calcular tamanho dos dados antes de salvar
        const dataToSave = { [yearKey]: METAS };
        const dataStr = JSON.stringify(dataToSave);
        const dataSize = new Blob([dataStr]).size;
        
        console.log(`üìä [persistMetas] Salvando metas do ano ${CURRENT_METAS_YEAR}`);
        console.log(`üì¶ [persistMetas] Tamanho dos dados: ${(dataSize / 1024).toFixed(2)} KB`);
        console.log(`üìà [persistMetas] Total de metas: ${METAS.length}`);
        
        // Usar fun√ß√£o de salvamento protegido
        console.log('üíæ [persistMetas] Salvando com prote√ß√£o contra 1MB...');
        const result = await safeWriteUserDoc(dataToSave);
        
        if(!result.success) {
          console.error('‚ùå [persistMetas] Falha ao salvar metas:', result.error);
          
          if(result.needsCleanup) {
            mgToast('üö® Documento muito grande! Limpeza autom√°tica em andamento...', 'warning', 5000);
          }
          
          if(result.criticalFailure) {
            console.error('üÜò [persistMetas] FALHA CR√çTICA! Sistema n√£o conseguiu limpar automaticamente.');
            mgToast('üÜò Erro cr√≠tico ao salvar metas! Execute: await reduzirDocumentoUsuario()', 'error', 10000);
          }
          
          throw new Error(result.error || 'Falha ao salvar metas');
        }
        
        if(result.autoCleanup || result.emergencyCleanup) {
          console.log('üßπ [persistMetas] Limpeza autom√°tica foi executada durante o salvamento');
          mgToast('üßπ Limpeza autom√°tica realizada ao salvar metas', 'info', 3000);
        }
        
        console.log(`‚úÖ [persistMetas] Metas salvas com sucesso`);
      }
      if (typeof renderCAC === 'function' && renderCAC.refresh) {
        try {
          renderCAC.refresh();
        } catch (e) { /* noop */ }
      }
      try{ refreshMacroInsights(); }catch(_){ }
    }

    function loadMetaPanelsFromUserData(){
      META_PANELS = Array.isArray(USER_DATA.metaPanels) ? USER_DATA.metaPanels.slice(0,6) : [];
      while(META_PANELS.length < 6) META_PANELS.push(null);
    }

    async function persistMetaPanels(){
      const uid = auth.currentUser?.uid;
      if(!uid) return;
      await setDoc(doc(db,'usuarios',uid), { metaPanels: META_PANELS }, { merge:true });
    }

    function normalizeClientKey(key){
      return (key || '').toString().replace(/[^\w-]/g,'_');
    }

    function getSafeClientKey(){
      if(Array.isArray(clientDocPathParts) && clientDocPathParts.length >= 4){
        return clientDocPathParts[3];
      }
      const raw = getClientKey();
      if(!raw) return null;
      return normalizeClientKey(raw);
    }

    function buildMetasFormUrl(token, safeKey, rawClientKey){
      const base = new URL(location.href);
      base.search = '';
      base.hash = '';
      if(!base.pathname.endsWith('/')){
        const idx = base.pathname.lastIndexOf('/');
        base.pathname = idx >= 0 ? base.pathname.slice(0, idx + 1) : '/';
      }
      const target = new URL('metas-form.html', base);
      target.searchParams.set('token', token);
      const clientParam = safeKey || rawClientKey || '';
      if(clientParam){
        target.searchParams.set('client', clientParam);
      }
      return target.toString();
    }

    function buildApprovalLink(token, safeKey, rawClientKey){
      const base = new URL(location.href);
      base.search = '';
      base.hash = '';
      if(!base.pathname.endsWith('/')){
        const idx = base.pathname.lastIndexOf('/');
        base.pathname = idx >= 0 ? base.pathname.slice(0, idx + 1) : '/';
      }
      const target = new URL('approval.html', base);
      target.searchParams.set('token', token);
      const clientParam = safeKey || rawClientKey || '';
      if(clientParam){
        target.searchParams.set('client', clientParam);
      }
      return target.toString();
    }

    function buildCalendarShareLink(token, safeKey, rawClientKey, monthKey){
      const base = new URL(location.href);
      base.search = '';
      base.hash = '';
      if(!base.pathname.endsWith('/')){
        const idx = base.pathname.lastIndexOf('/');
        base.pathname = idx >= 0 ? base.pathname.slice(0, idx + 1) : '/';
      }
      const target = new URL('calendario-publico.html', base);
      target.searchParams.set('token', token);
      const clientParam = safeKey || rawClientKey || '';
      if(clientParam){
        target.searchParams.set('client', clientParam);
      }
      if(monthKey){
        target.searchParams.set('month', monthKey);
      }
      return target.toString();
    }

    function buildPlanningShareLink(token, safeKey, rawClientKey, monthKey){
      const base = new URL(location.href);
      base.search = '';
      base.hash = '';
      if(!base.pathname.endsWith('/')){
        const idx = base.pathname.lastIndexOf('/');
        base.pathname = idx >= 0 ? base.pathname.slice(0, idx + 1) : '/';
      }
      const target = new URL('planejamento-publico.html', base);
      target.searchParams.set('token', token);
      const clientParam = safeKey || rawClientKey || '';
      if(clientParam){
        target.searchParams.set('client', clientParam);
      }
      if(monthKey){
        target.searchParams.set('month', monthKey);
      }
      return target.toString();
    }

    function sanitizeMetaFormNumber(value){
      if(value === '' || value === null || value === undefined) return null;
      if(typeof value === 'number'){ return Number.isFinite(value) ? value : null; }
      const parsed = typeof value === 'string' ? parseFloat(value.replace(',', '.')) : Number(value);
      return Number.isFinite(parsed) ? parsed : null;
    }

    function applyMetasFormResponses(responses, monthKey, projectionMonths){
      if(!responses || typeof responses !== 'object') return false;
      const validMonth = META_MONTHS.includes(monthKey) ? monthKey : META_MONTHS[new Date().getMonth()];
      let months = Array.isArray(projectionMonths) && projectionMonths.length
        ? projectionMonths.filter(m => META_MONTHS.includes(m))
        : META_MONTHS.slice(Math.max(0, META_MONTHS.indexOf(validMonth)));
      if(!months.length){
        months = META_MONTHS.slice();
      }
      let changed = false;
      Object.entries(responses).forEach(([metaId, payload]) => {
        if(!payload || typeof payload !== 'object') return;
        const meta = METAS.find(m => m && m.id === metaId);
        if(!meta || meta.ativo === false) return;
        if(!meta.meses){ meta.meses = createEmptyMonths(); }
        if(!meta.meses[validMonth]){ meta.meses[validMonth] = { p:'', r:'' }; }

        if(Object.prototype.hasOwnProperty.call(payload, 'current')){
          const num = sanitizeMetaFormNumber(payload.current);
          if(num === null){
            if(meta.meses[validMonth].r !== ''){
              meta.meses[validMonth].r = '';
              changed = true;
            }
          } else {
            const prev = sanitizeMetaFormNumber(meta.meses[validMonth].r);
            if(prev === null || Math.abs(prev - num) > 0.000001){
              meta.meses[validMonth].r = num;
              changed = true;
            }
          }
        }

        if(payload.projections && typeof payload.projections === 'object'){
          months.forEach(month => {
            if(!meta.meses[month]){ meta.meses[month] = { p:'', r:'' }; }
            if(Object.prototype.hasOwnProperty.call(payload.projections, month)){
              const val = sanitizeMetaFormNumber(payload.projections[month]);
              if(val === null){
                if(meta.meses[month].p !== ''){
                  meta.meses[month].p = '';
                  changed = true;
                }
              } else {
                const prev = sanitizeMetaFormNumber(meta.meses[month].p);
                if(prev === null || Math.abs(prev - val) > 0.000001){
                  meta.meses[month].p = val;
                  changed = true;
                }
              }
            }
          });
        }
      });
      return changed;
    }

    function processMetasFormDoc(docSnap){
      const data = docSnap.data();
      if(!data) return;
      const version = data.version || 0;
      if(!version) return;
      if(data.appliedVersion && data.appliedVersion === version) return;
      if(metasFormAppliedVersions[docSnap.id] === version) return;
      const responses = data.responses;
      if(!responses || typeof responses !== 'object' || !Object.keys(responses).length) return;
      const monthKey = data.monthKey || META_MONTHS[new Date().getMonth()];
      const projectionMonths = Array.isArray(data.projectionMonths) ? data.projectionMonths : [];
      const changed = applyMetasFormResponses(responses, monthKey, projectionMonths);
      metasFormAppliedVersions[docSnap.id] = version;
      setDoc(docSnap.ref, { appliedVersion: version, appliedAt: serverTimestamp() }, { merge: true })
        .catch(err => console.warn('metasForms applied mark', err));
      if(changed){
        persistMetas();
        renderMetas();
        renderMetaSummary();
        if(typeof mgToast === 'function'){
          mgToast('Metas atualizadas com respostas do cliente.');
        }
      }
    }

    function refreshMetasFormSubscription(){
      if(metasFormUnsub){
        try{ metasFormUnsub(); }catch(_e){}
        metasFormUnsub = null;
      }
      metasFormAppliedVersions = {};
      const uid = auth.currentUser?.uid;
      if(!uid){
        return;
      }
      const safeKey = getSafeClientKey();
      if(!safeKey){
        return;
      }
      try{
        const col = collection(db, 'metasForms');
        const qy = query(col, where('uid','==', uid), where('clientKeyNormalized','==', safeKey));
        metasFormUnsub = onSnapshot(qy, snap => {
          snap.forEach(docSnap => processMetasFormDoc(docSnap));
        }, err => console.warn('metasForms snapshot', err));
      }catch(err){
        console.warn('refreshMetasFormSubscription', err);
      }
    }

    async function handleSendMetasLink(){
      const btn = $('sendMetasLink');
      const originalText = btn ? btn.textContent : '';
      if(btn){
        btn.disabled = true;
        btn.textContent = 'Gerando link...';
      }
      try{
        if(!auth?.currentUser){
          throw new Error('Fa√ßa login para gerar o link.');
        }
        const clientKey = getClientKey();
        if(!clientKey){
          throw new Error('Cliente n√£o identificado.');
        }
        const safeKey = getSafeClientKey();
        const activeMetas = Array.isArray(METAS) ? METAS.filter(meta => meta && meta.ativo !== false) : [];
        if(!activeMetas.length){
          throw new Error('Cadastre ao menos uma meta ativa antes de enviar o link.');
        }
        const now = new Date();
        const monthKey = META_MONTHS[now.getMonth()];
        const monthLabel = metaMonthLabel(monthKey);
        const projectionMonths = META_MONTHS.slice(META_MONTHS.indexOf(monthKey));
        const metasPayload = activeMetas
          .map(meta => {
            const proj = {};
            projectionMonths.forEach(m => {
              const raw = meta.meses?.[m]?.p;
              const num = sanitizeMetaFormNumber(raw);
              proj[m] = num !== null ? num : null;
            });
            return {
              id: meta.id,
              descricao: meta.descricao || '',
              unidade: meta.unidade || 'numero',
              pos: meta.pos || 0,
              currentValue: sanitizeMetaFormNumber(meta.meses?.[monthKey]?.r),
              projections: proj
            };
          })
          .sort((a,b) => {
            const posDiff = (a.pos||0) - (b.pos||0);
            if(posDiff !== 0) return posDiff;
            return (a.descricao||'').localeCompare(b.descricao||'', 'pt-BR', { sensitivity:'base' });
          });

        const token = (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : uuid();
        const version = Date.now();
        const docData = {
          token,
          uid: auth.currentUser.uid,
          clientKey,
          clientKeyNormalized: safeKey || normalizeClientKey(clientKey),
          clientLabel: formatClientDisplayName(clientKey) || clientKey,
          monthKey,
          monthLabel,
          projectionMonths,
          metas: metasPayload,
          responses: {},
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          version
        };
        await setDoc(doc(db, 'metasForms', token), docData);
        const shareUrl = buildMetasFormUrl(token, docData.clientKeyNormalized, clientKey);
        
        // Copiar com fallback robusto para iframes
        const copied = await mgCopyToClipboard(shareUrl);
        
        if(copied){
          if(typeof mgToast === 'function'){
            mgToast('Link copiado! Envie ao cliente para preencher as metas.');
          }
        } else {
          prompt('Link gerado. Copie e envie ao cliente:', shareUrl);
        }
      }catch(err){
        console.error('handleSendMetasLink', err);
        alert(err?.message || 'N√£o foi poss√≠vel gerar o link.');
      }finally{
        if(btn){
          btn.disabled = false;
          btn.textContent = originalText || 'Enviar link para cliente';
        }
      }
    }

    function colorClass(p){
      if(p >= 100) return 'concl-azul';
      if(p >= 80)  return 'concl-verde';
      if(p >= 50)  return 'concl-amarelo';
      if(p >= 20)  return 'concl-laranja';
      return 'concl-vermelho';
    }

    function formatMetaNumber(val, unidade){
      if(!isFinite(val)) val = 0;
      if(unidade === 'BRL' || unidade === 'USD'){
        return val.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
      }
      return val.toFixed(2);
    }

    function formatMetaDisplay(val, unidade){
      const num = formatMetaNumber(val, unidade);
      if(unidade === 'BRL') return 'R$ ' + num;
      if(unidade === 'USD') return 'US$ ' + num;
      if(unidade === '%') return num + '%';
      return num;
    }

    function formatMetaInput(val, unidade){
      if(val === '' || val === null || val === undefined) return '';
      if(unidade === 'BRL' || unidade === 'USD' || unidade === '%'){
        const num = parseFloat(val) || 0;
        return formatMetaNumber(num, unidade);
      }
      return val;
    }

    function parseMetaInput(str, unidade){
      if(unidade === 'BRL' || unidade === 'USD'){
        return parseFloat(str.replace(/\./g,'').replace(',','.')) || 0;
      }
      return parseFloat(str) || 0;
    }

    function metaMonthLabel(key){
      return META_MONTH_LABELS[key] || key.toUpperCase();
    }

    function metaValueKindLabel(kind){
      return kind === 'planned' ? 'planejado' : 'realizado';
    }

    let metaInputTimer;
    let metaPersistTimer;
    function scheduleMetaRerender(metaId, month, cls){
      clearTimeout(metaInputTimer);
      metaInputTimer = setTimeout(()=>{
        renderMetas();
        const sel = document.querySelector(`input.${cls}[data-meta-id="${metaId}"][data-month="${month}"]`);
        if(sel) sel.focus();
      }, 300);
    }

    function scheduleMetaPersist(){
      clearTimeout(metaPersistTimer);
      metaPersistTimer = setTimeout(()=>{
        metaPersistTimer = null;
        persistMetas();
      }, 500);
    }

    function flushMetaPersist(){
      if(metaPersistTimer){
        clearTimeout(metaPersistTimer);
        metaPersistTimer = null;
      }
      persistMetas();
    }

    let metaBulkMenu = null;
    let metaBulkMenuData = null;

    function ensureMetaBulkMenu(){
      if(metaBulkMenu) return metaBulkMenu;
      metaBulkMenu = document.createElement('div');
      metaBulkMenu.id = 'metaBulkMenu';
      metaBulkMenu.className = 'meta-bulk-menu';
      metaBulkMenu.innerHTML = '<div class="meta-bulk-header"></div>' +
        '<div class="meta-bulk-quick">' +
          '<button type="button" class="meta-bulk-quick-future">Meses seguintes</button>' +
          '<button type="button" class="meta-bulk-quick-all">Todos</button>' +
          '<button type="button" class="meta-bulk-quick-clear">Limpar</button>' +
        '</div>' +
        '<div class="meta-bulk-list"></div>' +
        '<div class="meta-bulk-footer">' +
          '<button type="button" class="cancel">Cancelar</button>' +
          '<button type="button" class="apply">Aplicar</button>' +
        '</div>';
      document.body.appendChild(metaBulkMenu);
      metaBulkMenu.querySelector('.cancel').addEventListener('click', hideMetaBulkMenu);
      metaBulkMenu.querySelector('.apply').addEventListener('click', applyMetaBulkSelection);
      metaBulkMenu.querySelector('.meta-bulk-quick-all').addEventListener('click', selectMetaBulkAll);
      metaBulkMenu.querySelector('.meta-bulk-quick-clear').addEventListener('click', clearMetaBulkSelection);
      metaBulkMenu.querySelector('.meta-bulk-quick-future').addEventListener('click', selectMetaBulkFuture);
      document.addEventListener('mousedown', handleMetaBulkOutside);
      document.addEventListener('touchstart', handleMetaBulkOutside);
      window.addEventListener('resize', hideMetaBulkMenu);
      window.addEventListener('scroll', hideMetaBulkMenu, true);
      document.addEventListener('keydown', handleMetaBulkEsc);
      return metaBulkMenu;
    }

    function handleMetaBulkEsc(ev){
      if(ev.key === 'Escape') hideMetaBulkMenu();
    }

    function handleMetaBulkOutside(ev){
      if(!metaBulkMenu || !metaBulkMenu.classList.contains('show')) return;
      if(metaBulkMenu.contains(ev.target)) return;
      if(ev.target.closest && ev.target.closest('.meta-bulk-btn')) return;
      hideMetaBulkMenu();
    }

    function hideMetaBulkMenu(){
      if(!metaBulkMenu) return;
      metaBulkMenu.classList.remove('show');
      metaBulkMenu.style.left = '-9999px';
      metaBulkMenu.style.top = '-9999px';
      metaBulkMenuData = null;
    }

    function setMetaBulkSelection(predicate){
      const menu = ensureMetaBulkMenu();
      const boxes = menu.querySelectorAll('.meta-bulk-list input[type="checkbox"]');
      boxes.forEach(cb => {
        cb.checked = !!predicate(cb);
      });
    }

    function selectMetaBulkAll(){
      setMetaBulkSelection(() => true);
    }

    function clearMetaBulkSelection(){
      setMetaBulkSelection(() => false);
    }

    function selectMetaBulkFuture(){
      if(!metaBulkMenuData) return;
      const limit = metaBulkMenuData.index;
      setMetaBulkSelection(cb => {
        const idx = parseInt(cb.dataset.index, 10);
        return idx > limit;
      });
    }

    function applyMetaBulkSelection(){
      if(!metaBulkMenuData) return;
      const menu = ensureMetaBulkMenu();
      const selected = Array.from(menu.querySelectorAll('.meta-bulk-list input[type="checkbox"]:checked')).map(cb => cb.value);
      if(!selected.length){
        if(typeof mgToast === 'function') mgToast('Selecione ao menos um m√™s.');
        return;
      }
      const { metaId, month, kind } = metaBulkMenuData;
      const typeLabel = metaValueKindLabel(kind);
      applyMetaBulk(metaId, month, kind, selected);
      hideMetaBulkMenu();
      if(typeof mgToast === 'function'){
        const plural = selected.length > 1 ? 'meses' : 'm√™s';
        mgToast(`Valor ${typeLabel} aplicado em ${selected.length} ${plural}.`);
      }
    }

    function applyMetaBulk(metaId, sourceMonth, kind, targetMonths){
      if(!Array.isArray(targetMonths) || !targetMonths.length) return;
      const meta = METAS.find(m => m.id === metaId);
      if(!meta) return;
      const key = kind === 'realized' ? 'r' : 'p';
      const sourceVal = meta.meses?.[sourceMonth]?.[key];
      targetMonths.forEach(month => {
        if(!meta.meses[month]) meta.meses[month] = { p:'', r:'' };
        meta.meses[month][key] = sourceVal;
      });
      scheduleMetaPersist();
      scheduleMetaRerender(metaId, sourceMonth, kind === 'realized' ? 'realized' : 'planned');
    }

    function showMetaBulkMenu(trigger, metaId, month, kind){
      const meta = METAS.find(m => m.id === metaId);
      if(!meta) return;
      const menu = ensureMetaBulkMenu();
      if(metaBulkMenuData && metaBulkMenuData.metaId === metaId && metaBulkMenuData.month === month && metaBulkMenuData.kind === kind && menu.classList.contains('show')){
        hideMetaBulkMenu();
        return;
      }
      const monthIndex = Math.max(0, META_MONTHS.indexOf(month));
      metaBulkMenuData = { metaId, month, kind, index: monthIndex };
      const header = menu.querySelector('.meta-bulk-header');
      header.textContent = `Aplicar valor ${metaValueKindLabel(kind)} de ${metaMonthLabel(month)} para:`;
      const list = menu.querySelector('.meta-bulk-list');
      list.innerHTML = '';
      META_MONTHS.forEach((m, idx) => {
        if(m === month) return;
        const label = document.createElement('label');
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.value = m;
        cb.dataset.index = idx;
        label.appendChild(cb);
        const span = document.createElement('span');
        span.textContent = metaMonthLabel(m);
        label.appendChild(span);
        list.appendChild(label);
      });
      const futureBtn = menu.querySelector('.meta-bulk-quick-future');
      futureBtn.disabled = metaBulkMenuData.index >= META_MONTHS.length - 1;
      selectMetaBulkFuture();
      if(!list.querySelector('input[type="checkbox"]:checked')){
        selectMetaBulkAll();
      }
      menu.classList.add('show');
      menu.style.visibility = 'hidden';
      menu.style.left = '0px';
      menu.style.top = '0px';
      requestAnimationFrame(() => {
        const rect = trigger.getBoundingClientRect();
        const menuRect = menu.getBoundingClientRect();
        let left = rect.left + window.scrollX;
        let top = rect.bottom + window.scrollY + 6;
        const maxLeft = window.scrollX + window.innerWidth - menuRect.width - 8;
        const maxTop = window.scrollY + window.innerHeight - menuRect.height - 8;
        if(left > maxLeft) left = Math.max(window.scrollX + 8, maxLeft);
        if(top > maxTop) top = rect.top + window.scrollY - menuRect.height - 6;
        if(top < window.scrollY + 8) top = window.scrollY + 8;
        if(left < window.scrollX + 8) left = window.scrollX + 8;
        menu.style.left = left + 'px';
        menu.style.top = top + 'px';
        menu.style.visibility = 'visible';
      });
    }

    function clearAllMetas(){
      if(!METAS.length){
        if(typeof mgToast === 'function'){ mgToast('Nenhuma meta cadastrada para limpar.'); }
        return;
      }
      if(!confirm('Limpar todos os valores planejados e realizados das metas deste ano?')){
        return;
      }
      if(metaPersistTimer){
        clearTimeout(metaPersistTimer);
        metaPersistTimer = null;
      }
      METAS = METAS.map(meta => ({ ...meta, meses: createEmptyMonths() }));
      persistMetas();
      renderMetas();
      if(typeof mgToast === 'function'){ mgToast('Metas limpas com sucesso.'); }
    }

    function resetMetasToDefault(){
      if(!confirm('Resetar todas as metas para o padr√£o inicial? Isso remover√° metas atuais personalizadas.')){
        return;
      }
      if(metaPersistTimer){
        clearTimeout(metaPersistTimer);
        metaPersistTimer = null;
      }
      METAS = createDefaultMetas();
      META_PANELS = Array(6).fill(null);
      USER_DATA.metaPanels = META_PANELS;
      persistMetaPanels();
      persistMetas();
      renderMetas();
      if(typeof mgToast === 'function'){ mgToast('Metas redefinidas com sucesso para o padr√£o inicial.'); }
    }

    function initMetasYearSelector(){
      const select = $('metasYearSelect');
      if(!select) return;
      
      // Limpar op√ß√µes existentes
      select.innerHTML = '';
      
      // Ano atual
      const currentYear = new Date().getFullYear();
      
      // Gerar anos: 2 anos atr√°s at√© 3 anos √† frente
      const years = [];
      for(let i = -2; i <= 3; i++){
        years.push(currentYear + i);
      }
      
      // Adicionar op√ß√µes
      years.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        if(year === CURRENT_METAS_YEAR){
          option.selected = true;
        }
        select.appendChild(option);
      });
      
      // Adicionar evento de mudan√ßa
      select.onchange = async () => {
        const newYear = parseInt(select.value);
        if(newYear === CURRENT_METAS_YEAR) return;
        
        // Salvar ano anterior antes de trocar
        await persistMetas();
        
        // Trocar ano
        CURRENT_METAS_YEAR = newYear;
        
        // Carregar metas do novo ano
        loadMetasFromUserData();
        
        // Re-renderizar
        renderMetas();
        
        if(typeof mgToast === 'function'){ 
          mgToast(`üìÖ Ano alterado para ${CURRENT_METAS_YEAR}`); 
        }
      };
    }

    function renderMetas(){
      const container = $('metasContainer');
      if(!container) return;
      
      // Inicializar seletor de ano (se ainda n√£o foi)
      initMetasYearSelector();
      
      hideMetaBulkMenu();
      renderMetaSummary();
      container.innerHTML = '';
      const mobile = window.matchMedia('(max-width:600px)').matches;
      const months = META_MONTHS;

      ['marketing','comercial'].forEach(setor => {
        const metas = METAS.filter(m => (m.setor || 'comercial') === setor);
        const wrap = document.createElement('div');
        wrap.className = 'meta-setor ' + setor;

        const title = document.createElement('h3');
        title.textContent = setor.charAt(0).toUpperCase() + setor.slice(1);
        wrap.appendChild(title);

        const table = document.createElement('table');
        table.className = 'metas-table';
        
        const colgroup = document.createElement('colgroup');
        if(!mobile){
          const colInfo = document.createElement('col');
          colInfo.className = 'meta-col-info';
          colgroup.appendChild(colInfo);
        }
        months.forEach(() => {
          const col = document.createElement('col');
          col.className = 'meta-col-month';
          colgroup.appendChild(col);
        });
        const colTotal = document.createElement('col');
        colTotal.className = 'meta-col-total';
        colgroup.appendChild(colTotal);
        table.appendChild(colgroup);

        const thead = document.createElement('thead');
        thead.innerHTML = mobile
          ? '<tr>' + months.map(m => '<th>' + m.substring(0,3).toUpperCase() + '</th>').join('') + '<th>Total</th></tr>'
          : '<tr><th class="meta-name">Meta</th>' + months.map(m => '<th>' + m.substring(0,3).toUpperCase() + '</th>').join('') + '<th>Total</th></tr>';
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        metas.forEach(meta => tbody.appendChild(createMetaRows(meta, mobile)));
        table.appendChild(tbody);
        wrap.appendChild(table);
        container.appendChild(wrap);
      });

      const addBtn = $('addMeta');
      if(addBtn){
        addBtn.onclick = () => {
          const m = createMeta();
          m.pos = nextMetaPos();
          METAS.push(m);
          persistMetas();
          renderMetas();
        };
      }

      const shareBtn = $('sendMetasLink');
      if(shareBtn){
        shareBtn.onclick = handleSendMetasLink;
      }

      const clearBtn = $('clearMetas');
      if(clearBtn){
        clearBtn.onclick = clearAllMetas;
      }

      const resetBtn = $('resetMetas');
      if(resetBtn){
        resetBtn.onclick = resetMetasToDefault;
      }
    }

    function openColarMetasModal(metaId){
      const modal = $('colarMetasModal');
      const textarea = $('colarMetasTextarea');
      const countSpan = $('colarMetasCount');
      const metaNameSpan = $('colarMetasMetaName');
      
      if(!modal || !textarea || !countSpan || !metaNameSpan) return;
      
      // Encontrar a meta
      const meta = METAS.find(m => m.id === metaId);
      if(!meta) return;
      
      // Exibir nome da meta
      const metaTitle = (meta.pos ? meta.pos + ' - ' : '') + (meta.descricao || 'Meta sem descri√ß√£o');
      metaNameSpan.textContent = metaTitle;
      
      // Limpar textarea
      textarea.value = '';
      countSpan.textContent = '0';
      
      // Reset imagem
      const imageInput = $('colarMetasImageInput');
      const imagePreview = $('colarMetasImagePreview');
      const imagePlaceholder = $('colarMetasImagePlaceholder');
      const imageStatus = $('colarMetasImageStatus');
      const extractBtn = $('colarMetasImageExtract');
      const extractedDiv = $('colarMetasExtractedNumbers');
      const extractedTextarea = $('colarMetasExtractedTextarea');
      const pasteArea = $('colarMetasImagePasteArea');
      const previewImg = $('colarMetasImagePreviewImg');
      const imageName = $('colarMetasImageName');
      const removeBtn = $('colarMetasImageRemove');
      let currentImageFile = null;
      
      if(imageInput) imageInput.value = '';
      if(imagePreview) imagePreview.style.display = 'none';
      if(imagePlaceholder) imagePlaceholder.style.display = 'block';
      if(imageStatus) imageStatus.style.display = 'none';
      if(extractedDiv) extractedDiv.style.display = 'none';
      if(extractedTextarea) extractedTextarea.value = '';
      
      // Resetar para aba de texto
      const tabText = $('colarMetasTabText');
      const tabImage = $('colarMetasTabImage');
      const textContent = $('colarMetasTextContent');
      const imageContent = $('colarMetasImageContent');
      
      if(tabText) {
        tabText.classList.add('active');
        tabText.style.color = '#60a5fa';
        tabText.style.borderBottomColor = '#60a5fa';
      }
      if(tabImage) {
        tabImage.classList.remove('active');
        tabImage.style.color = '#94a3b8';
        tabImage.style.borderBottomColor = 'transparent';
      }
      if(textContent) textContent.style.display = 'flex';
      if(imageContent) imageContent.style.display = 'none';
      
      // Mostrar modal
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden', 'false');
      setTimeout(() => textarea.focus(), 100);
      
      // Fun√ß√£o para atualizar contador
      const updateCount = (text) => {
        // Fun√ß√£o para limpar e extrair apenas o n√∫mero
        const cleanNumber = (str) => {
          if(!str) return null;
          
          // Verificar se tem formato de moeda com centavos (,00 ou .00 no final)
          const hasCentavos = /[,\.]\d{2}$/.test(str.trim());
          
          // Remove todos os caracteres exceto d√≠gitos
          let cleaned = str.replace(/[^\d]/g, '');
          if(!cleaned) return null;
          
          // Se tinha formato de centavos, remove os √∫ltimos 2 d√≠gitos
          if(hasCentavos && cleaned.length > 2){
            cleaned = cleaned.slice(0, -2);
          }
          
          const num = parseInt(cleaned, 10);
          return isNaN(num) ? null : num;
        };
        
        // Substituir v√≠rgulas por quebra de linha para contar corretamente
        const normalizedText = text.replace(/,/g, '\n');
        const lines = normalizedText.split('\n').filter(line => {
          const trimmed = line.trim();
          return trimmed && cleanNumber(trimmed) !== null;
        });
        countSpan.textContent = lines.length;
      };
      
      // Atualizar contador enquanto digita
      textarea.oninput = () => updateCount(textarea.value);
      
      // === CONTROLE DE ABAS ===
      if(tabText){
        tabText.onclick = () => {
          tabText.classList.add('active');
          tabText.style.color = '#60a5fa';
          tabText.style.borderBottomColor = '#60a5fa';
          tabImage.classList.remove('active');
          tabImage.style.color = '#94a3b8';
          tabImage.style.borderBottomColor = 'transparent';
          if(textContent) textContent.style.display = 'flex';
          if(imageContent) imageContent.style.display = 'none';
        };
      }
      
      if(tabImage){
        tabImage.onclick = () => {
          tabImage.classList.add('active');
          tabImage.style.color = '#60a5fa';
          tabImage.style.borderBottomColor = '#60a5fa';
          tabText.classList.remove('active');
          tabText.style.color = '#94a3b8';
          tabText.style.borderBottomColor = 'transparent';
          if(textContent) textContent.style.display = 'none';
          if(imageContent) imageContent.style.display = 'flex';
          
          // Dar foco na √°rea de paste para facilitar Ctrl+V
          const pasteArea = $('colarMetasImagePasteArea');
          if(pasteArea){
            setTimeout(() => pasteArea.focus(), 100);
          }
        };
      }
      
      // === COLAR IMAGEM (PASTE) ===
      // Adicionar estilos de foco na √°rea de paste
      if(pasteArea){
        pasteArea.onfocus = () => {
          pasteArea.style.borderColor = '#60a5fa';
          pasteArea.style.backgroundColor = 'rgba(59, 130, 246, 0.05)';
        };
        
        pasteArea.onblur = () => {
          pasteArea.style.borderColor = '#334155';
          pasteArea.style.backgroundColor = '#111827';
        };
        
        // Evento de colar (Ctrl+V ou Cmd+V)
        pasteArea.addEventListener('paste', async (e) => {
          e.preventDefault();
          console.log('üñºÔ∏è Evento de paste detectado');
          
          const items = e.clipboardData?.items;
          console.log('üìã Items no clipboard:', items?.length || 0);
          
          if(!items || items.length === 0){
            alert('Nenhum conte√∫do detectado na √°rea de transfer√™ncia.');
            return;
          }
          
          // Procurar por imagem nos itens colados
          let imageItem = null;
          for(let i = 0; i < items.length; i++){
            console.log(`  Item ${i}: ${items[i].type}`);
            if(items[i].type.startsWith('image/')){
              imageItem = items[i];
              console.log('‚úÖ Imagem encontrada:', items[i].type);
              break;
            }
          }
          
          if(!imageItem){
            console.warn('‚ùå Nenhuma imagem encontrada no clipboard');
            alert('Por favor, cole uma imagem. Use Print Screen ou copie uma imagem antes de colar.');
            return;
          }
          
          // Obter arquivo da imagem
          const file = imageItem.getAsFile();
          console.log('üìÅ Arquivo obtido:', file);
          
          if(!file){
            alert('Erro ao obter imagem da √°rea de transfer√™ncia.');
            return;
          }
          
          // Validar tamanho (10MB)
          console.log('üìä Tamanho do arquivo:', (file.size / 1024 / 1024).toFixed(2) + ' MB');
          if(file.size > 10 * 1024 * 1024){
            alert('A imagem √© muito grande. Tamanho m√°ximo: 10MB');
            return;
          }
          
          currentImageFile = file;
          console.log('üíæ Imagem salva em currentImageFile');
          
          // Mostrar preview
          const reader = new FileReader();
          reader.onload = (e) => {
            console.log('‚úÖ Preview carregado');
            if(previewImg) previewImg.src = e.target.result;
            if(imageName) imageName.textContent = file.name || 'Imagem colada';
            if(imagePlaceholder) imagePlaceholder.style.display = 'none';
            if(imagePreview) imagePreview.style.display = 'block';
            if(extractedDiv) extractedDiv.style.display = 'none';
            if(extractedTextarea) extractedTextarea.value = '';
            if(imageStatus) imageStatus.style.display = 'none';
          };
          reader.readAsDataURL(file);
        });
      }
      
      // Remover imagem
      if(removeBtn){
        removeBtn.onclick = (e) => {
          e.stopPropagation();
          currentImageFile = null;
          if(imagePlaceholder) imagePlaceholder.style.display = 'block';
          if(imagePreview) imagePreview.style.display = 'none';
          if(imageStatus) imageStatus.style.display = 'none';
          if(extractedDiv) extractedDiv.style.display = 'none';
          if(extractedTextarea) extractedTextarea.value = '';
          updateCount('');
          
          // Voltar foco para √°rea de paste
          if(pasteArea) pasteArea.focus();
        };
      }
      
      // === EXTRAIR TEXTO COM OCR ===
      if(extractBtn){
        extractBtn.onclick = async () => {
          if(!currentImageFile) return;
          
          const statusText = $('colarMetasImageStatusText');
          
          try {
            // Mostrar status de processamento
            if(imageStatus){
              imageStatus.style.display = 'block';
              imageStatus.style.background = 'rgba(59, 130, 246, 0.15)';
              imageStatus.style.border = '1px solid rgba(59, 130, 246, 0.3)';
            }
            if(statusText){
              statusText.style.color = '#60a5fa';
              statusText.innerHTML = 'üîÑ Processando imagem com OCR...<br><small style="color: #94a3b8;">Isso pode levar alguns segundos</small>';
            }
            
            // Desabilitar bot√£o
            extractBtn.disabled = true;
            extractBtn.style.opacity = '0.5';
            extractBtn.style.cursor = 'not-allowed';
            
            // Processar com Tesseract.js
            const { data: { text } } = await Tesseract.recognize(
              currentImageFile,
              'por', // Portugu√™s
              {
                logger: m => {
                  if(m.status === 'recognizing text'){
                    const progress = Math.round(m.progress * 100);
                    if(statusText){
                      statusText.innerHTML = `üîÑ Reconhecendo texto: ${progress}%<br><small style="color: #94a3b8;">Aguarde...</small>`;
                    }
                  }
                }
              }
            );
            
            // Extrair apenas n√∫meros do texto
            // Fun√ß√£o para limpar e extrair apenas o n√∫mero
            const cleanNumber = (str) => {
              if(!str) return null;
              
              // Verificar se tem formato de moeda com centavos (,00 ou .00 no final)
              // Ex: 3.600,00 ou 3,600.00 ou R$ 3.600,00
              const hasCentavos = /[,\.]\d{2}$/.test(str.trim());
              
              // Remove todos os caracteres exceto d√≠gitos
              let cleaned = str.replace(/[^\d]/g, '');
              if(!cleaned) return null;
              
              // Se tinha formato de centavos (,00 ou .00), remove os √∫ltimos 2 d√≠gitos
              if(hasCentavos && cleaned.length > 2){
                cleaned = cleaned.slice(0, -2);
              }
              
              const num = parseInt(cleaned, 10);
              return isNaN(num) ? null : num;
            };
            
            // Quebrar texto em linhas e processar cada linha separadamente
            // Isso evita juntar n√∫meros que est√£o em linhas diferentes
            const lines = text.split(/[\n\r]+/);
            const cleanNumbers = [];
            
            lines.forEach(line => {
              // Para cada linha, procurar padr√µes de n√∫meros
              // Aceita: 1000, 1.000, 1,000, R$ 1000, $ 1000, etc.
              const matches = line.match(/[R$]*\s*[\d,\.]+/g) || [];
              matches.forEach(match => {
                const num = cleanNumber(match);
                if(num !== null && num > 0){
                  cleanNumbers.push(num);
                }
              });
            });
            
            if(cleanNumbers.length === 0){
              throw new Error('Nenhum n√∫mero encontrado na imagem');
            }
            
            // Mostrar n√∫meros extra√≠dos
            if(extractedTextarea){
              extractedTextarea.value = cleanNumbers.join('\n');
              updateCount(extractedTextarea.value);
            }
            if(extractedDiv) extractedDiv.style.display = 'block';
            
            // Atualizar status - sucesso
            if(imageStatus){
              imageStatus.style.background = 'rgba(34, 197, 94, 0.15)';
              imageStatus.style.border = '1px solid rgba(34, 197, 94, 0.3)';
            }
            if(statusText){
              statusText.style.color = '#4ade80';
              statusText.innerHTML = `‚úÖ ${cleanNumbers.length} n√∫mero(s) extra√≠do(s) com sucesso!`;
            }
            
            // Atualizar contador ao editar n√∫meros extra√≠dos
            if(extractedTextarea){
              extractedTextarea.oninput = () => updateCount(extractedTextarea.value);
            }
            
          } catch (error) {
            console.error('Erro no OCR:', error);
            
            // Mostrar erro
            if(imageStatus){
              imageStatus.style.display = 'block';
              imageStatus.style.background = 'rgba(239, 68, 68, 0.15)';
              imageStatus.style.border = '1px solid rgba(239, 68, 68, 0.3)';
            }
            if(statusText){
              statusText.style.color = '#f87171';
              statusText.innerHTML = `‚ùå Erro ao processar imagem: ${error.message}<br><small style="color: #94a3b8;">Tente com outra imagem ou use o m√©todo de colar texto</small>`;
            }
          } finally {
            // Reabilitar bot√£o
            if(extractBtn){
              extractBtn.disabled = false;
              extractBtn.style.opacity = '1';
              extractBtn.style.cursor = 'pointer';
            }
          }
        };
      }
      
      // Bot√µes do modal
      const closeBtn = $('colarMetasClose');
      const cancelBtn = $('colarMetasCancel');
      const applyBtn = $('colarMetasApply');
      
      const closeModal = () => {
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden', 'true');
        textarea.value = '';
        textarea.oninput = null;
        if(extractedTextarea) extractedTextarea.oninput = null;
      };
      
      if(closeBtn) closeBtn.onclick = closeModal;
      if(cancelBtn) cancelBtn.onclick = closeModal;
      
      if(applyBtn){
        applyBtn.onclick = () => {
          // Verificar qual fonte de n√∫meros usar
          let sourceText = '';
          const activeTab = tabText?.classList.contains('active');
          
          if(activeTab){
            // Usar textarea principal
            sourceText = textarea.value;
          } else {
            // Usar n√∫meros extra√≠dos
            sourceText = extractedTextarea?.value || '';
          }
          
          // Substituir v√≠rgulas por quebra de linha para unificar processamento
          // Isso permite: "100, 200, 300" ou "100\n200\n300" ou at√© "100, 200\n300, 400"
          const normalizedText = sourceText.replace(/,/g, '\n');
          const lines = normalizedText.split('\n');
          const numbers = [];
          
          // Fun√ß√£o para limpar e extrair apenas o n√∫mero
          const cleanNumber = (str) => {
            if(!str) return null;
            
            // Verificar se tem formato de moeda com centavos (,00 ou .00 no final)
            // Ex: 3.600,00 ou 3,600.00 ou R$ 3.600,00
            const hasCentavos = /[,\.]\d{2}$/.test(str.trim());
            
            // Remove todos os caracteres exceto d√≠gitos
            // Aceita formatos: 2.000,00 | 2,000.00 | R$ 2.000 | $2,000 | 2000
            let cleaned = str.replace(/[^\d]/g, '');
            if(!cleaned) return null;
            
            // Se tinha formato de centavos (,00 ou .00), remove os √∫ltimos 2 d√≠gitos
            if(hasCentavos && cleaned.length > 2){
              cleaned = cleaned.slice(0, -2);
            }
            
            const num = parseInt(cleaned, 10);
            return isNaN(num) ? null : num;
          };
          
          // Extrair n√∫meros v√°lidos de cada linha
          lines.forEach(line => {
            const trimmed = line.trim();
            if(trimmed){
              const num = cleanNumber(trimmed);
              if(num !== null){
                numbers.push(num);
              }
            }
          });
          
          if(numbers.length === 0){
            alert('Nenhum n√∫mero v√°lido encontrado. Cole os valores mensais separados por v√≠rgula ou quebra de linha, ou extraia de uma imagem primeiro.');
            return;
          }
          
          // Aplicar n√∫meros nos 12 meses da meta
          if(!meta.meses) meta.meses = createEmptyMonths();
          
          let aplicados = 0;
          META_MONTHS.forEach((month, index) => {
            if(index < numbers.length){
              if(!meta.meses[month]) meta.meses[month] = { p: '', r: '' };
              meta.meses[month].p = numbers[index].toString();
              aplicados++;
            }
          });
          
          // Salvar e atualizar
          persistMetas();
          renderMetas();
          closeModal();
          
          const mensagem = aplicados === 12 
            ? `‚úÖ 12 valores mensais aplicados com sucesso em "${meta.descricao}"!`
            : `‚úÖ ${aplicados} valor(es) aplicado(s) em "${meta.descricao}". ${12 - aplicados} m√™s(es) restante(s) ficaram vazios.`;
          
          if(typeof mgToast === 'function'){
            mgToast(mensagem);
          } else {
            alert(mensagem);
          }
        };
      }
    }

    /**
     * ü§ñ PREENCHIMENTO AUTOM√ÅTICO DE META COM DADOS DA AN√ÅLISE
     * Extrai valores mensais da an√°lise de Direcionamento Estrat√©gico e preenche automaticamente
     */
    async function autoFillMetaFromAnalysis(meta){
      console.log('ü§ñ [autoFillMetaFromAnalysis] Iniciando preenchimento autom√°tico para meta:', meta.descricao);
      
      try {
        let analiseContent = null;
        
        // Buscar an√°lise (mesmo c√≥digo do showMetaAnalysisModal)
        if(window.USER_DATA && window.USER_DATA.analises){
          const possibleKeys = [
            'direcionamento_metas',
            'direcionamento',
            'Direcionamento Estrat√©gico e Metas',
            'üìä An√°lise: Direcionamento Estrat√©gico e Metas',
            'direcionamento_estrategico',
            'metas'
          ];
          
          for(const key of possibleKeys){
            if(window.USER_DATA.analises[key]){
              analiseContent = window.USER_DATA.analises[key];
              break;
            }
          }
          
          if(!analiseContent){
            for(const key of Object.keys(window.USER_DATA.analises)){
              const lowerKey = key.toLowerCase();
              if(lowerKey.includes('direcionamento') || lowerKey.includes('metas') || lowerKey.includes('estrateg')){
                analiseContent = window.USER_DATA.analises[key];
                break;
              }
            }
          }
        }
        
        // Se n√£o encontrou em mem√≥ria, tentar do Firebase
        if(!analiseContent){
          const user = auth.currentUser;
          if(user){
            const possibleKeys = [
              'direcionamento_metas',
              'direcionamento',
              'Direcionamento Estrat√©gico e Metas',
              'üìä An√°lise: Direcionamento Estrat√©gico e Metas',
              'direcionamento_estrategico',
              'metas'
            ];
            
            for(const key of possibleKeys){
              try {
                const analiseDocRef = doc(db, 'usuarios', user.uid, 'analises', key);
                const analiseSnap = await getDoc(analiseDocRef);
                
                if(analiseSnap.exists()){
                  const data = analiseSnap.data();
                  if(!window.USER_DATA.analises) window.USER_DATA.analises = {};
                  window.USER_DATA.analises[key] = data;
                  analiseContent = data;
                  break;
                }
              } catch (e) {}
            }
          }
        }
        
        if(!analiseContent){
          if(typeof mgToast === 'function'){
            mgToast('‚ö†Ô∏è An√°lise de Direcionamento Estrat√©gico n√£o foi gerada ainda. Gere a an√°lise na aba Estrutura√ß√£o primeiro.', 'warning', 5000);
          } else {
            alert('An√°lise n√£o encontrada. Gere a an√°lise na aba Estrutura√ß√£o primeiro.');
          }
          return;
        }
        
        console.log('üìä An√°lise encontrada, extraindo valores...');
        console.log('üìä Estrutura da an√°lise:', Object.keys(analiseContent));
        console.log('üìä Conte√∫do completo da an√°lise:', analiseContent);
        
        // Extrair valores da an√°lise - testar TODOS os campos poss√≠veis
        let analiseText = analiseContent.insightHTML || 
                         analiseContent.insight || 
                         analiseContent.content || 
                         analiseContent.html || 
                         analiseContent.texto ||
                         analiseContent.resultado ||
                         analiseContent.analise ||
                         '';
        
        // Se ainda est√° vazio, tentar converter o objeto inteiro para string
        if(!analiseText && typeof analiseContent === 'object'){
          analiseText = JSON.stringify(analiseContent);
        }
        
        console.log('üìù Tamanho do texto da an√°lise:', analiseText.length);
        console.log('üìù Primeiros 500 caracteres:', analiseText.substring(0, 500));

        // Se ainda est√° vazio, n√£o conseguimos extrair nada
        if(!analiseText || analiseText.length === 0){
          console.error('‚ùå ERRO: An√°lise encontrada mas o conte√∫do est√° vazio!');
          console.error('üìã Campos dispon√≠veis na an√°lise:', Object.keys(analiseContent));
          if(typeof mgToast === 'function'){
            mgToast('‚ö†Ô∏è A an√°lise foi encontrada mas est√° vazia. Tente gerar a an√°lise novamente na aba Estrutura√ß√£o.', 'error', 6000);
          } else {
            alert('An√°lise encontrada mas est√° vazia. Gere a an√°lise novamente.');
          }
          return;
        }
        
        // Fun√ß√£o para normalizar nome de meta (remover acentos, pontua√ß√£o, etc)
        const normalizeName = (str) => {
          if(!str) return '';
          return str.toLowerCase()
            .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Remove acentos
            .replace(/[^\w\s]/g, ' ') // Remove pontua√ß√£o mas mant√©m espa√ßos
            .replace(/\s+/g, ' ') // Remove espa√ßos duplos
            .trim();
        };
        
        const metaNameNormalized = normalizeName(meta.descricao);
        console.log('üîç Procurando por meta:', meta.descricao);
        console.log('üîç Meta normalizada:', metaNameNormalized);
        
        // Dicion√°rio de mapeamento: termos da an√°lise -> poss√≠veis nomes de meta
        // IMPORTANTE: Cada alias deve ter uma palavra-chave √öNICA para evitar confus√£o
        const metaAliases = {
          // Investimento - palavras √∫nicas: invest, midia, publicidade, trafego pago
          'inv. trafego': {
            keywords: ['investimento em publicidade', 'investimento midia', 'invest trafego', 'inv trafego', 'publicidade'],
            columnNames: ['inv. trafego', 'inv trafego', 'investimento trafego', 'investimento'],
            excludeIfContains: ['faturamento', 'receita', 'vendas'] // N√ÉO √© faturamento
          },
          
          // Faturamento - palavras √∫nicas: faturamento, receita, origem
          'faturamento': {
            keywords: ['faturamento com origem', 'faturamento trafego', 'receita trafego', 'fat trafego', 'origem no trafego'],
            columnNames: ['faturamento', 'fat trafego', 'receita'],
            excludeIfContains: ['investimento', 'invest', 'custo'] // N√ÉO √© investimento
          },
          
          // Leads totais
          'leads': {
            keywords: ['leads totais', 'numero de leads', 'leads gerados', 'total de leads', 'qtd leads'],
            columnNames: ['leads', 'leads totais', 'total leads'],
            excludeIfContains: ['mql', 'qualificados', 'nutridos']
          },
          
          // ROAS
          'roas': {
            keywords: ['roas', 'retorno sobre investimento publicitario', 'roi anuncios'],
            columnNames: ['roas', 'roi'],
            excludeIfContains: []
          },
          
          // MQL %
          'mql%': {
            keywords: ['taxa mql', 'mql %', 'mql percentual', 'taxa de leads qualificados', 'percentual mql'],
            columnNames: ['mql%', 'mql %', 'taxa mql'],
            excludeIfContains: ['mqls', 'numero', 'quantidade']
          },
          
          // CPL
          'cpl': {
            keywords: ['cpl', 'custo por lead', 'custo de lead'],
            columnNames: ['cpl', 'custo por lead'],
            excludeIfContains: ['cac', 'cliente']
          },
          
          // CAC
          'cac': {
            keywords: ['cac', 'custo de aquisicao de cliente', 'custo por cliente'],
            columnNames: ['cac', 'custo de aquisicao'],
            excludeIfContains: ['cpl', 'lead']
          },
          
          // MQLs (n√∫mero)
          'mqls': {
            keywords: ['mqls', 'leads aquecidos', 'leads nutridos', 'nutricao', 'quantidade mql', 'numero mql'],
            columnNames: ['mqls', 'mql', 'nutridos', 'leads qualificados'],
            excludeIfContains: ['%', 'taxa', 'percentual']
          },
          
          // Faturamento Total
          'vendas totais': {
            keywords: ['faturamento total', 'vendas totais', 'receita total', 'fat total'],
            columnNames: ['vendas totais', 'faturamento total', 'fat total'],
            excludeIfContains: ['marketing', 'trafego', 'origem']
          },
          
          // Vendas do Marketing
          'vendas marketing': {
            keywords: ['vendas marketing', 'faturamento marketing', 'receita marketing', 'vendas atribuidas'],
            columnNames: ['vendas marketing', 'fat marketing'],
            excludeIfContains: []
          }
        };
        
        // Encontrar aliases que batem com a meta atual
        let matchedAlias = null;
        let bestMatchScore = 0;
        
        for(const [aliasKey, aliasData] of Object.entries(metaAliases)){
          let score = 0;
          
          // Verificar se alguma keyword bate com a meta
          for(const keyword of aliasData.keywords){
            const normalizedKeyword = normalizeName(keyword);
            if(metaNameNormalized.includes(normalizedKeyword)){
              score += 10; // Match completo na meta
            } else if(normalizedKeyword.includes(metaNameNormalized)){
              score += 5; // Meta contida na keyword
            } else {
              // Match parcial por palavras
              const keywordWords = normalizedKeyword.split(' ');
              const matchingWords = keywordWords.filter(w => metaNameNormalized.includes(w) && w.length > 2);
              score += matchingWords.length;
            }
          }
          
          // Se teve algum match, verificar exclus√µes
          if(score > 0){
            for(const exclude of aliasData.excludeIfContains){
              if(metaNameNormalized.includes(normalizeName(exclude))){
                console.log(`‚ùå Excluindo alias "${aliasKey}" - meta cont√©m palavra proibida: "${exclude}"`);
                score = 0;
                break;
              }
            }
          }
          
          if(score > bestMatchScore){
            bestMatchScore = score;
            matchedAlias = { key: aliasKey, data: aliasData };
          }
        }
        
        if(matchedAlias){
          console.log('üéØ Alias encontrado:', matchedAlias.key);
          console.log('   Keywords:', matchedAlias.data.keywords);
          console.log('   Column names:', matchedAlias.data.columnNames);
          console.log('   Score:', bestMatchScore);
        } else {
          console.log('‚ö†Ô∏è Nenhum alias encontrado - usando matching gen√©rico');
        }
        
        // Criar varia√ß√µes do nome para busca mais flex√≠vel
        const metaKeywords = metaNameNormalized.split(' ').filter(w => w.length > 2); // Palavras com mais de 2 letras
        
        // Se encontrou alias, usar as column names como palavras-chave priorit√°rias
        let priorityColumnNames = [];
        if(matchedAlias){
          priorityColumnNames = matchedAlias.data.columnNames.map(n => normalizeName(n));
          console.log('üîë Column names priorit√°rios:', priorityColumnNames);
        }
        
        console.log('üîë Palavras-chave gerais:', metaKeywords);
        
        // Procurar tabela ou lista de valores na an√°lise
        // Padr√µes comuns: "CPL: Jan: 100, Fev: 120..." ou tabela HTML
        const monthsValues = {};
        const monthNames = ['janeiro', 'fevereiro', 'mar√ßo', 'abril', 'maio', 'junho', 
                           'julho', 'agosto', 'setembro', 'outubro', 'novembro', 'dezembro',
                           'jan', 'fev', 'mar', 'abr', 'mai', 'jun', 
                           'jul', 'ago', 'set', 'out', 'nov', 'dez'];
        
        // Tentar extrair de tabelas HTML
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = analiseText;
        const tables = tempDiv.querySelectorAll('table');
        
        console.log(`üìä Total de tabelas encontradas na an√°lise: ${tables.length}`);
        let found = false;
        
        for(const table of tables){
          const rows = table.querySelectorAll('tr');
          console.log('üìã Analisando tabela com', rows.length, 'linhas');
          
          // PASSO 1: Identificar o cabe√ßalho e qual coluna cont√©m nossa meta
          let headerRow = null;
          let targetColumnIndex = -1;
          
          // Procurar linha de cabe√ßalho (primeira linha com TH ou primeira TR)
          for(let i = 0; i < rows.length; i++){
            const row = rows[i];
            const cells = row.querySelectorAll('th, td');
            if(cells.length === 0) continue;
            
            const isHeaderRow = row.querySelector('th') !== null || i === 0;
            if(isHeaderRow){
              headerRow = row;
              
              // Verificar qual coluna do cabe√ßalho bate com nossa meta
              for(let colIdx = 0; colIdx < cells.length; colIdx++){
                const headerText = cells[colIdx].textContent.trim();
                const headerNormalized = normalizeName(headerText);
                
                console.log(`  üìë Coluna ${colIdx}: "${headerText}" (normalizado: "${headerNormalized}")`);
                
                // Match com column names priorit√°rios
                if(matchedAlias && priorityColumnNames.length > 0){
                  for(const colName of priorityColumnNames){
                    if(headerNormalized === colName || 
                       headerNormalized.includes(colName) || 
                       colName.includes(headerNormalized)){
                      
                      // Verificar exclus√µes
                      let hasExclusion = false;
                      for(const exclude of matchedAlias.data.excludeIfContains){
                        if(headerNormalized.includes(normalizeName(exclude))){
                          console.log(`    ‚ö†Ô∏è Ignorando coluna - cont√©m exclus√£o: "${exclude}"`);
                          hasExclusion = true;
                          break;
                        }
                      }
                      
                      if(!hasExclusion){
                        targetColumnIndex = colIdx;
                        console.log(`  ‚úÖ COLUNA ENCONTRADA! √çndice: ${colIdx} - Match: "${colName}" ‚âà "${headerText}"`);
                        break;
                      }
                    }
                  }
                }
                
                // Match com nome da meta
                if(targetColumnIndex === -1){
                  if(headerNormalized === metaNameNormalized || 
                     headerNormalized.includes(metaNameNormalized) || 
                     metaNameNormalized.includes(headerNormalized)){
                    targetColumnIndex = colIdx;
                    console.log(`  ‚úÖ COLUNA ENCONTRADA! √çndice: ${colIdx} - Match direto com meta`);
                  }
                }
                
                if(targetColumnIndex !== -1) break;
              }
              
              break; // S√≥ processar primeira linha de cabe√ßalho
            }
          }
          
          if(targetColumnIndex === -1){
            console.log('  ‚ö†Ô∏è Nenhuma coluna correspondente encontrada nesta tabela');
            continue; // Pr√≥xima tabela
          }
          
          // PASSO 2: Extrair valores das linhas de meses
          console.log(`\nüéØ Extraindo valores da coluna ${targetColumnIndex}...`);
          
          for(const row of rows){
            const cells = row.querySelectorAll('th, td');
            if(cells.length === 0) continue;
            if(cells.length <= targetColumnIndex) continue; // N√£o tem c√©lulas suficientes
            
            // Verificar se √© linha de cabe√ßalho
            const isHeaderRow = row.querySelector('th') !== null || row === headerRow;
            if(isHeaderRow){
              console.log('  ‚è≠Ô∏è Pulando cabe√ßalho');
              continue;
            }
            
            // Primeira c√©lula (deve ser o nome do m√™s)
            const firstCellText = cells[0].textContent.trim();
            const firstCellNormalized = normalizeName(firstCellText);
            
            // FILTRO 1: Ignorar linhas de TOTAL/SOMA/M√âDIA
            if(firstCellNormalized.includes('total') || 
               firstCellNormalized.includes('soma') || 
               firstCellNormalized.includes('media') ||
               firstCellNormalized.includes('average') ||
               firstCellNormalized === '' ||
               firstCellNormalized === '#'){
              console.log(`  ‚è≠Ô∏è Ignorando linha de totais/vazia: "${firstCellText}"`);
              continue;
            }
            
            // FILTRO 2: Verificar se √© uma linha de m√™s (Jan, Fev, Mar, etc)
            let monthKey = null;
            for(const month of META_MONTHS){
              const monthNormalized = normalizeName(month);
              if(firstCellNormalized === monthNormalized || 
                 firstCellNormalized.includes(monthNormalized) ||
                 monthNormalized.includes(firstCellNormalized)){
                monthKey = month;
                break;
              }
            }
            
            if(!monthKey){
              console.log(`  ‚è≠Ô∏è N√£o √© linha de m√™s: "${firstCellText}"`);
              continue;
            }
            
            // EXTRAIR VALOR da coluna target
            const valueCell = cells[targetColumnIndex];
            const valueCellText = valueCell.textContent.trim();
            const cleanValue = valueCellText.replace(/[^\d]/g, '');
            
            if(cleanValue && cleanValue !== '0'){
              monthsValues[monthKey] = parseInt(cleanValue, 10);
              console.log(`  ‚úÖ ${monthKey}: ${cleanValue} (coluna ${targetColumnIndex}: "${valueCellText}")`);
              found = true;
            } else {
              console.log(`  ‚ö†Ô∏è ${monthKey}: valor vazio ou zero na coluna ${targetColumnIndex}`);
            }
          }
          
          if(found) break; // Encontrou dados, parar de procurar em outras tabelas
        }
        
        // Se n√£o encontrou em tabelas, tentar regex no texto
        if(!found){
          console.log('üîç Tentando extrair valores por regex no texto...');
          
          // Procurar padr√£o: "nome_meta ... Jan: 100 Fev: 200 ..."
          const lines = analiseText.split(/\n|\r\n/);
          for(const line of lines){
            const lineNormalized = normalizeName(line);
            
            // Match flex√≠vel por palavras-chave
            let lineMatches = false;
            
            // 1. Match direto
            if(lineNormalized.includes(metaNameNormalized)){
              lineMatches = true;
              console.log('  ‚úì Match direto com meta');
            }
            
            // 2. Match com alias
            if(!lineMatches && matchedAliasKey){
              const aliasNormalized = normalizeName(matchedAliasKey);
              if(lineNormalized.includes(aliasNormalized)){
                lineMatches = true;
                console.log('  ‚úì Match por ALIAS:', matchedAliasKey);
              }
            }
            
            // 3. Match por palavras-chave (40% ou mais - mais flex√≠vel)
            if(!lineMatches && metaKeywords.length > 0){
              const matchingKeywords = metaKeywords.filter(kw => lineNormalized.includes(kw));
              lineMatches = (matchingKeywords.length / metaKeywords.length) >= 0.4;
              if(lineMatches){
                console.log('  ‚úì Match por keywords:', matchingKeywords);
              }
            }
            
            if(lineMatches){
              console.log('‚úÖ LINHA ENCONTRADA no texto:', line.substring(0, 150));
              
              // Extrair n√∫meros ap√≥s nomes de meses
              for(let i = 0; i < monthNames.length; i++){
                const monthName = monthNames[i];
                const regex = new RegExp(monthName + '[^\\d]*(\\d[\\d\\.,]*)', 'gi');
                const match = regex.exec(line);
                
                if(match){
                  const value = match[1].replace(/[^\d]/g, '');
                  if(value){
                    const monthIndex = i % 12;
                    if(!monthsValues[META_MONTHS[monthIndex]]){
                      monthsValues[META_MONTHS[monthIndex]] = parseInt(value, 10);
                      console.log(`  üìÖ ${META_MONTHS[monthIndex]}: ${value}`);
                    }
                  }
                }
              }
              
              found = true;
              break;
            }
          }
        }
        
        console.log('üìä Valores extra√≠dos:', monthsValues);
        console.log('üìä Total de meses preenchidos:', Object.keys(monthsValues).length);
        
        if(Object.keys(monthsValues).length === 0){
          console.warn('‚ùå Nenhum valor encontrado para a meta:', meta.descricao);
          console.warn('üí° Dica: Verifique se na an√°lise existe uma tabela com o nome da meta e os valores dos 12 meses.');
          
          if(typeof mgToast === 'function'){
            mgToast(`‚ö†Ô∏è N√£o foram encontrados valores para "${meta.descricao}" na an√°lise.\n\nVerifique se:\n‚Ä¢ A an√°lise tem uma tabela de proje√ß√£o anual\n‚Ä¢ O nome da meta na an√°lise √© parecido com "${meta.descricao}"\n‚Ä¢ A tabela tem 12 colunas com valores num√©ricos`, 'warning', 8000);
          } else {
            alert(`N√£o foram encontrados valores para "${meta.descricao}" na an√°lise.\n\nVerifique se a an√°lise cont√©m uma tabela com essa meta e valores mensais.`);
          }
          return;
        }
        
        // Preencher a meta com os valores encontrados
        if(!meta.meses) meta.meses = createEmptyMonths();
        
        let filled = 0;
        META_MONTHS.forEach(month => {
          if(monthsValues[month]){
            if(!meta.meses[month]) meta.meses[month] = { p: '', r: '' };
            meta.meses[month].p = monthsValues[month].toString();
            filled++;
          }
        });
        
        // Salvar e atualizar
        persistMetas();
        renderMetas();
        
        if(typeof mgToast === 'function'){
          mgToast(`‚úÖ ${filled} valor(es) preenchido(s) automaticamente em "${meta.descricao}"!`, 'success', 3000);
        } else {
          alert(`${filled} valor(es) preenchido(s) automaticamente!`);
        }
        
      } catch (error) {
        console.error('‚ùå Erro ao preencher meta automaticamente:', error);
        if(typeof mgToast === 'function'){
          mgToast('‚ùå Erro ao extrair dados da an√°lise. Veja o console para mais detalhes.', 'error', 5000);
        } else {
          alert('Erro ao extrair dados da an√°lise.');
        }
      }
    }

    /**
     * üìä MODAL DE AN√ÅLISE DE DIRECIONAMENTO ESTRAT√âGICO
     * Exibe a an√°lise de direcionamento de metas para facilitar o preenchimento
     */
    async function showMetaAnalysisModal(meta){
      console.log('üìä [showMetaAnalysisModal] Abrindo modal para meta:', meta.descricao);
      
      let analiseContent = null;
      
      // Tentar encontrar a an√°lise em v√°rias localiza√ß√µes poss√≠veis
      if(window.USER_DATA && window.USER_DATA.analises){
        console.log('üîç Buscando an√°lise... Chaves dispon√≠veis:', Object.keys(window.USER_DATA.analises));
        
        // Tentar todas as poss√≠veis chaves
        const possibleKeys = [
          'direcionamento_metas',
          'direcionamento',
          'Direcionamento Estrat√©gico e Metas',
          'üìä An√°lise: Direcionamento Estrat√©gico e Metas',
          'direcionamento_estrategico',
          'metas'
        ];
        
        for(const key of possibleKeys){
          if(window.USER_DATA.analises[key]){
            console.log('‚úÖ An√°lise encontrada com chave:', key);
            analiseContent = window.USER_DATA.analises[key];
            break;
          }
        }
        
        // Se n√£o encontrou com chaves exatas, tentar busca parcial
        if(!analiseContent){
          console.log('üîç Tentando busca parcial nas chaves...');
          for(const key of Object.keys(window.USER_DATA.analises)){
            const lowerKey = key.toLowerCase();
            if(lowerKey.includes('direcionamento') || lowerKey.includes('metas') || lowerKey.includes('estrateg')){
              console.log('‚úÖ An√°lise encontrada por busca parcial:', key);
              analiseContent = window.USER_DATA.analises[key];
              break;
            }
          }
        }
      }
      
      // Se n√£o encontrou, tentar carregar da subcole√ß√£o Firebase
      if(!analiseContent){
        console.log('‚ö†Ô∏è An√°lise n√£o encontrada em USER_DATA, tentando carregar do Firebase...');
        
        try {
          const user = auth.currentUser;
          if(user){
            // Tentar carregar de todas as poss√≠veis chaves (mesmas da busca em mem√≥ria)
            const possibleKeys = [
              'direcionamento_metas',
              'direcionamento',
              'Direcionamento Estrat√©gico e Metas',
              'üìä An√°lise: Direcionamento Estrat√©gico e Metas',
              'direcionamento_estrategico',
              'metas'
            ];
            
            console.log('üîç Tentando carregar do Firebase com', possibleKeys.length, 'chaves...');
            
            for(const key of possibleKeys){
              try {
                const analiseDocRef = doc(db, 'usuarios', user.uid, 'analises', key);
                const analiseSnap = await getDoc(analiseDocRef);
                
                if(analiseSnap.exists()){
                  const data = analiseSnap.data();
                  if(!window.USER_DATA.analises) window.USER_DATA.analises = {};
                  window.USER_DATA.analises[key] = data;
                  analiseContent = data;
                  console.log('‚úÖ An√°lise carregada da subcole√ß√£o Firebase com chave:', key);
                  console.log('üì¶ Estrutura do documento:', Object.keys(data));
                  break;
                }
              } catch (e) {
                console.log('   Chave "' + key + '" n√£o encontrada no Firebase, tentando pr√≥xima...');
              }
            }
            
            // Se n√£o encontrou com chaves exatas, tentar buscar todos os documentos da subcole√ß√£o
            if(!analiseContent){
              console.log('üîç Tentando listar todas as an√°lises no Firebase...');
              const analisesRef = collection(db, 'usuarios', user.uid, 'analises');
              const querySnapshot = await getDocs(analisesRef);
              
              console.log('üìö Total de an√°lises no Firebase:', querySnapshot.size);
              
              if(!querySnapshot.empty){
                querySnapshot.forEach((doc) => {
                  console.log('   - ID:', doc.id);
                });
                
                // Busca parcial nos IDs
                for(const docSnap of querySnapshot.docs){
                  const docId = docSnap.id.toLowerCase();
                  if(docId.includes('direcionamento') || docId.includes('metas') || docId.includes('estrateg')){
                    console.log('‚úÖ An√°lise encontrada por busca parcial no Firebase:', docSnap.id);
                    const data = docSnap.data();
                    if(!window.USER_DATA.analises) window.USER_DATA.analises = {};
                    window.USER_DATA.analises[docSnap.id] = data;
                    analiseContent = data;
                    console.log('üì¶ Estrutura do documento:', Object.keys(data));
                    break;
                  }
                }
              }
            }
          }
        } catch (error) {
          console.error('‚ùå Erro ao carregar an√°lise do Firebase:', error);
        }
      }
      
      // Se ainda n√£o encontrou, mostrar erro
      if(!analiseContent){
        console.error('‚ùå An√°lise n√£o encontrada em nenhuma localiza√ß√£o');
        if(typeof mgToast === 'function'){
          mgToast('‚ö†Ô∏è An√°lise de Direcionamento Estrat√©gico n√£o foi gerada ainda. V√° para a aba Estrutura√ß√£o e gere a an√°lise.', 'warning', 5000);
        } else {
          alert('An√°lise de Direcionamento Estrat√©gico n√£o foi gerada ainda. V√° para a aba Estrutura√ß√£o e gere a an√°lise primeiro.');
        }
        return;
      }
      
      // Extrair conte√∫do da an√°lise
      console.log('üîç Estrutura da an√°lise encontrada:', analiseContent);
      console.log('üîç Propriedades dispon√≠veis:', Object.keys(analiseContent));
      
      // Tentar m√∫ltiplas propriedades para extrair o conte√∫do
      let content = '';
      if(typeof analiseContent === 'string'){
        content = analiseContent;
        console.log('‚úÖ An√°lise √© string direta');
      } else {
        // Tentar v√°rias propriedades poss√≠veis (insightHtml √© a propriedade usada na Estrutura√ß√£o)
        content = analiseContent.insightHtml ||    // ‚≠ê Propriedade correta da aba Estrutura√ß√£o
                  analiseContent.content || 
                  analiseContent.response || 
                  analiseContent.text || 
                  analiseContent.data ||
                  analiseContent.resultado ||
                  analiseContent.analise ||
                  '';
        
        // Descobrir qual propriedade foi usada
        let usedProperty = 'N√ÉO encontrada';
        if(content){
          if(analiseContent.insightHtml) usedProperty = 'insightHtml';
          else if(analiseContent.content) usedProperty = 'content';
          else if(analiseContent.response) usedProperty = 'response';
          else if(analiseContent.text) usedProperty = 'text';
          else if(analiseContent.data) usedProperty = 'data';
          else if(analiseContent.resultado) usedProperty = 'resultado';
          else if(analiseContent.analise) usedProperty = 'analise';
        }
        console.log('üîç Propriedade usada para conte√∫do:', usedProperty);
      }
      
      console.log('üìù Tamanho do conte√∫do extra√≠do:', content.length, 'caracteres');
      
      if(!content || content.length < 10){
        console.warn('‚ö†Ô∏è Conte√∫do da an√°lise est√° vazio ou muito curto');
        console.warn('üì¶ Dump completo da an√°lise:', JSON.stringify(analiseContent, null, 2));
        if(typeof mgToast === 'function'){
          mgToast('‚ö†Ô∏è An√°lise de Direcionamento est√° vazia. Gere a an√°lise na aba Estrutura√ß√£o.', 'warning', 5000);
        }
        return;
      }
      
      console.log('‚úÖ An√°lise encontrada, exibindo modal. Tamanho:', content.length, 'caracteres');
      
      // Criar modal dinamicamente se n√£o existir
      let modal = document.getElementById('metaAnalysisModal');
      if(!modal){
        modal = document.createElement('div');
        modal.id = 'metaAnalysisModal';
        modal.className = 'modal';
        modal.innerHTML = `
          <div class="modal-card" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-head">
              <h2 style="margin: 0; display: flex; align-items: center; gap: 8px; font-size: 18px;">
                <span style="font-size: 24px;">üìä</span>
                <span>Direcionamento Estrat√©gico e Metas</span>
              </h2>
              <button class="close-modal-btn" style="font-size: 28px; background: none; border: none; color: #94a3b8; cursor: pointer; padding: 0; width: 32px; height: 32px; transition: color 0.2s;">&times;</button>
            </div>
            <div class="modal-body" style="display: block; padding: 24px;">
              <div style="background: rgba(96, 165, 250, 0.1); border-left: 4px solid #60a5fa; padding: 16px; margin-bottom: 20px; border-radius: 4px;">
                <p style="margin: 0; color: #e2e8f0; font-size: 14px;">
                  <strong style="color: #60a5fa;">üí° Dica:</strong> Use esta an√°lise estrat√©gica para preencher os valores planejados das suas metas com base no direcionamento recomendado pela I.A.
                </p>
              </div>
              <div style="background: #1e293b; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                <p style="margin: 0 0 8px 0; font-weight: 600; color: #60a5fa;">Meta Atual:</p>
                <p id="metaAnalysisMetaName" style="margin: 0; color: #e2e8f0; font-size: 16px;"></p>
              </div>
              <div id="metaAnalysisContent" style="color: #cbd5e1; line-height: 1.8; font-size: 15px;">
                <!-- Conte√∫do da an√°lise aqui -->
              </div>
            </div>
            <div class="modal-foot" style="padding: 16px 24px; background: #0f172a; border-top: 1px solid #334155; display: flex; justify-content: flex-end; gap: 12px;">
              <button class="close-modal-btn btn secondary" style="padding: 10px 20px;">Fechar</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        
        // Event listener para fechar modal clicando no backdrop
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            modal.classList.remove('show');
            modal.setAttribute('aria-hidden', 'true');
            console.log('üö™ Modal fechado (clique no backdrop)');
          }
        });
        
        // Event listeners para bot√µes de fechar
        const closeBtns = modal.querySelectorAll('.close-modal-btn');
        closeBtns.forEach(btn => {
          btn.addEventListener('click', function() {
            modal.classList.remove('show');
            modal.setAttribute('aria-hidden', 'true');
            console.log('üö™ Modal fechado (bot√£o)');
          });
        });
        
        console.log('‚úÖ Modal criado com backdrop e eventos de fechar');
      }
      
      // Atualizar conte√∫do
      const metaNameEl = document.getElementById('metaAnalysisMetaName');
      const contentEl = document.getElementById('metaAnalysisContent');
      
      if(metaNameEl){
        const metaTitle = (meta.pos ? meta.pos + ' - ' : '') + (meta.descricao || 'Meta sem descri√ß√£o');
        metaNameEl.textContent = metaTitle;
      }
      
      if(contentEl){
        let processedContent = content;
        
        // Se o conte√∫do j√° est√° em HTML (cont√©m tags), usar diretamente
        const isHTML = /<\/?[a-z][\s\S]*>/i.test(content);
        
        if(isHTML){
          console.log('‚úÖ Conte√∫do j√° est√° em HTML, usando diretamente');
          processedContent = content;
        } else {
          console.log('üîÑ Processando markdown...');
          // Processar markdown b√°sico apenas se n√£o for HTML
          processedContent = content
            .replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>')
            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.+?)\*/g, '<em>$1</em>')
            .replace(/^### (.+)$/gm, '<h3 style="color: #60a5fa; margin-top: 24px; margin-bottom: 12px; font-size: 18px;">$1</h3>')
            .replace(/^## (.+)$/gm, '<h2 style="color: #60a5fa; margin-top: 28px; margin-bottom: 14px; font-size: 20px;">$1</h2>')
            .replace(/^# (.+)$/gm, '<h1 style="color: #60a5fa; margin-top: 32px; margin-bottom: 16px; font-size: 24px;">$1</h1>')
            .replace(/^- (.+)$/gm, '<li style="margin-left: 20px; margin-bottom: 8px;">$1</li>')
            .replace(/^\d+\. (.+)$/gm, '<li style="margin-left: 20px; margin-bottom: 8px; list-style-type: decimal;">$1</li>')
            .replace(/\n\n/g, '</p><p style="margin-bottom: 16px;">')
            .replace(/\n/g, '<br>');
          
          // Wrap em par√°grafos se n√£o come√ßar com tag
          if(!processedContent.startsWith('<h') && !processedContent.startsWith('<p')){
            processedContent = '<p style="margin-bottom: 16px;">' + processedContent + '</p>';
          }
        }
        
        contentEl.innerHTML = processedContent;
      }
      
      // Mostrar modal com backdrop
      modal.classList.add('show');
      modal.setAttribute('aria-hidden', 'false');
      
      console.log('‚úÖ Modal de an√°lise exibido com backdrop');
    }

    function renderMetaSummary(){
      const wrap = $('metasSummary');
      if(!wrap) return;
      const monthKey = META_MONTHS[new Date().getMonth()];
      wrap.innerHTML = '';
      for(let i=0;i<6;i++){
        const panel = document.createElement('div');
        panel.className = 'meta-panel';
        const sel = document.createElement('select');
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'Selecione';
        sel.appendChild(opt);
        METAS.forEach(m=>{
          const o=document.createElement('option');
          o.value=m.id;
          const active = m.ativo !== false;
          o.textContent=(m.pos? m.pos + ' - ' : '') + (m.descricao||'') + (active ? '' : ' (inativa)');
          sel.appendChild(o);
        });
        sel.value = META_PANELS[i] || '';
        sel.onchange = ()=>{
          META_PANELS[i] = sel.value || null;
          persistMetaPanels();
          renderMetaSummary();
        };
        panel.appendChild(sel);
        const stats = document.createElement('div');
        stats.className = 'stats';
        const addStat = (label, value) => {
          const line = document.createElement('div');
          line.className = 'stat-line';
          const lab = document.createElement('span');
          lab.className = 'stat-label';
          lab.textContent = label;
          const val = document.createElement('span');
          val.className = 'stat-value';
          val.textContent = value;
          line.appendChild(lab);
          line.appendChild(val);
          stats.appendChild(line);
        };
        const meta = METAS.find(m=>m.id===META_PANELS[i]);
        if(meta && meta.ativo !== false){
          const mes = meta.meses?.[monthKey] || {};
          const mesP = parseFloat(mes.p) || 0;
          const mesR = parseFloat(mes.r) || 0;
          const anoP = META_MONTHS.reduce((s,m)=>s+(parseFloat(meta.meses?.[m]?.p)||0),0);
          const anoR = META_MONTHS.reduce((s,m)=>s+(parseFloat(meta.meses?.[m]?.r)||0),0);
          addStat('M√™s', `${formatMetaDisplay(mesR, meta.unidade)} / ${formatMetaDisplay(mesP, meta.unidade)}`);
          addStat('Ano', `${formatMetaDisplay(anoR, meta.unidade)} / ${formatMetaDisplay(anoP, meta.unidade)}`);
        } else if(meta){
          addStat('Status', 'Meta desativada');
          addStat('M√™s', '-');
          addStat('Ano', '-');
        } else {
          addStat('M√™s', '-');
          addStat('Ano', '-');
        }
        panel.appendChild(stats);
        wrap.appendChild(panel);
      }
    }

    window.addEventListener('resize', () => {
      if (currentSection === 'metas') renderMetas();
    });

    function createMetaRows(meta, mobile=false){
      const months = META_MONTHS;
      const frag = document.createDocumentFragment();
      const rows = [];
      const computeTitle = () => (meta.pos ? meta.pos + ' - ' : '') + (meta.descricao || '');
      const applyRowState = () => {
        const active = meta.ativo !== false;
        rows.forEach(row => {
          if(row){
            row.classList.toggle('meta-inactive', !active);
          }
        });
      };
      const applyToggleVisual = btn => {
        if(!btn) return;
        const active = meta.ativo !== false;
        btn.classList.toggle('on', active);
        btn.classList.toggle('off', !active);
        btn.textContent = active ? 'ON' : 'OFF';
        btn.setAttribute('aria-pressed', active ? 'true' : 'false');
        btn.setAttribute('aria-label', active ? 'Desativar meta' : 'Ativar meta');
      };
      const setupToggle = btn => {
        if(!btn) return;
        applyToggleVisual(btn);
        btn.addEventListener('click', ev => {
          ev.preventDefault();
          ev.stopPropagation();
          meta.ativo = meta.ativo === false ? true : false;
          applyToggleVisual(btn);
          applyRowState();
          persistMetas();
          renderMetas();
        });
      };

      const trTitle = document.createElement('tr');
      trTitle.className = 'meta-title-row';
      rows.push(trTitle);
      if(!mobile){
        const tdSpacer = document.createElement('td');
        tdSpacer.className = 'meta-title-spacer';
        trTitle.appendChild(tdSpacer);
      }
      const tdTitle = document.createElement('td');
      tdTitle.className = 'meta-title-cell';
      tdTitle.colSpan = months.length + 1;
      const titleWrap = document.createElement('div');
      titleWrap.className = 'meta-title-content';
      const titleTextEl = document.createElement('span');
      titleTextEl.className = 'meta-title-text';
      titleTextEl.textContent = computeTitle();
      titleWrap.appendChild(titleTextEl);
      const updateTitleText = () => { titleTextEl.textContent = computeTitle(); };
      if(mobile){
        const toggleWrap = document.createElement('div');
        toggleWrap.className = 'meta-activation';
        const toggleBtn = document.createElement('button');
        toggleBtn.type = 'button';
        toggleBtn.className = 'meta-toggle';
        toggleWrap.appendChild(toggleBtn);
        titleWrap.appendChild(toggleWrap);
        setupToggle(toggleBtn);
      }
      tdTitle.appendChild(titleWrap);
      trTitle.appendChild(tdTitle);
      frag.appendChild(trTitle);

      const trMonths = document.createElement('tr');
      trMonths.className = 'meta-months-row';
      rows.push(trMonths);
      if(!mobile){
        const tdSpacer = document.createElement('td');
        tdSpacer.className = 'meta-title-spacer';
        trMonths.appendChild(tdSpacer);
      }
      months.forEach(m => {
        const td = document.createElement('td');
        td.textContent = m.substring(0,3).toUpperCase();
        trMonths.appendChild(td);
      });
      const tdTotLabel = document.createElement('td');
      tdTotLabel.textContent = 'Total';
      trMonths.appendChild(tdTotLabel);
      frag.appendChild(trMonths);

      const trP = document.createElement('tr');
      trP.className = 'projetado';
      rows.push(trP);

      let info;
      if(!mobile){
        info = document.createElement('td');
        info.className = 'meta-info';
        info.rowSpan = 4;
        const actionsHtml = meta.fixed
          ? '<div class="actions"><button class="auto-fill" title="Preencher automaticamente com dados da an√°lise">ü§ñ Add Auto</button><button class="view-analysis" title="Ver an√°lise de direcionamento estrat√©gico">üìä Ver An√°lise</button><button class="up">‚Üë</button><button class="down">‚Üì</button><button class="paste-values">üìã Colar</button><button class="del">Excluir</button></div>'
          : '<div class="actions"><button class="auto-fill" title="Preencher automaticamente com dados da an√°lise">ü§ñ Add Auto</button><button class="view-analysis" title="Ver an√°lise de direcionamento estrat√©gico">üìä Ver An√°lise</button><button class="up">‚Üë</button><button class="down">‚Üì</button><button class="dup">Duplicar</button><button class="paste-values">üìã Colar</button><button class="del">Excluir</button></div>';
        const tagOpts = '<option value=""></option>' + META_TAG_OPTIONS.map(t=>'<option value="'+t+'"'+(meta.tag===t?' selected':'')+'>'+t+'</option>').join('');
        info.innerHTML = `
          <div class="meta-activation"><button type="button" class="meta-toggle"></button></div>
          <input type="number" class="meta-pos" placeholder="N¬∫" min="1" style="width:50px">
          <input type="text" class="meta-desc" placeholder="Descri√ß√£o">
          <select class="meta-tag">${tagOpts}</select>
          <select class="meta-setor"><option value="comercial">Comercial</option><option value="marketing">Marketing</option></select>
          <select class="meta-unidade"><option value="%">%</option><option value="BRL">R$</option><option value="USD">US$</option><option value="numero">N√∫mero</option></select>
          <select class="meta-direcao"><option value="aumentar">Aumentar</option><option value="diminuir">Diminuir</option></select>
          <div class="meta-modo">
            <label><input type="radio" name="modo_${meta.id}" value="total"> Valor total</label>
            <label><input type="radio" name="modo_${meta.id}" value="media"> Valor m√©dio</label>
          </div>
          ${actionsHtml}`;
        trP.appendChild(info);
        setupToggle(info.querySelector('.meta-toggle'));
      }

      months.forEach(m => {
        const td = document.createElement('td');
        const cell = document.createElement('div');
        cell.className = 'meta-cell';
        const inp = document.createElement('input');
        inp.type = 'text';
        inp.inputMode = 'decimal';
        inp.className = 'planned';
        inp.dataset.metaId = meta.id;
        inp.dataset.month = m;
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'meta-bulk-btn';
        btn.title = 'Aplicar valor em outros meses';
        btn.setAttribute('aria-label', 'Aplicar valor planejado em outros meses');
        btn.textContent = '‚áÜ';
        btn.addEventListener('click', ev => {
          ev.preventDefault();
          ev.stopPropagation();
          showMetaBulkMenu(btn, meta.id, m, 'planned');
        });
        cell.appendChild(inp);
        cell.appendChild(btn);
        td.appendChild(cell);
        trP.appendChild(td);
      });
      const tdTotP = document.createElement('td');
      trP.appendChild(tdTotP);

      const trR = document.createElement('tr');
      trR.className = 'realizado';
      rows.push(trR);
      months.forEach(m => {
        const td = document.createElement('td');
        const cell = document.createElement('div');
        cell.className = 'meta-cell';
        const inp = document.createElement('input');
        inp.type = 'text';
        inp.inputMode = 'decimal';
        inp.className = 'realized';
        inp.dataset.metaId = meta.id;
        inp.dataset.month = m;
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'meta-bulk-btn';
        btn.title = 'Aplicar valor em outros meses';
        btn.setAttribute('aria-label', 'Aplicar valor realizado em outros meses');
        btn.textContent = '‚áÜ';
        btn.addEventListener('click', ev => {
          ev.preventDefault();
          ev.stopPropagation();
          showMetaBulkMenu(btn, meta.id, m, 'realized');
        });
        cell.appendChild(inp);
        cell.appendChild(btn);
        td.appendChild(cell);
        trR.appendChild(td);
      });
      const tdTotR = document.createElement('td');
      trR.appendChild(tdTotR);

      const trC = document.createElement('tr');
      trC.className = 'conclusao';
      rows.push(trC);
      const conclMonthCells = [];
      months.forEach(() => {
        const td = document.createElement('td');
        conclMonthCells.push(td);
        trC.appendChild(td);
      });
      const tdTotC = document.createElement('td');
      trC.appendChild(tdTotC);

      const trE = document.createElement('tr');
      trE.className = 'evolucao';
      rows.push(trE);
      const evolMonthCells = [];
      months.forEach(() => {
        const td = document.createElement('td');
        evolMonthCells.push(td);
        trE.appendChild(td);
      });
      const tdTotE = document.createElement('td');
      trE.appendChild(tdTotE);

      const updateMetaCalculations = () => {
        let sumP = 0, sumR = 0;
        let prev = null, eSum = 0, eCount = 0;
        months.forEach((m, idx) => {
          const monthData = meta.meses?.[m] || {};
          const p = parseFloat(monthData.p) || 0;
          const r = parseFloat(monthData.r) || 0;
          sumP += p;
          sumR += r;
          const pct = p ? (r / p * 100) : 0;
          const conclCell = conclMonthCells[idx];
          if(conclCell){
            conclCell.textContent = p ? pct.toFixed(2) + '%' : '-';
            conclCell.className = colorClass(pct);
          }
          let evoText = '-';
          if(prev !== null && prev !== 0){
            const e = ((r - prev) / prev) * 100;
            evoText = e.toFixed(2) + '%';
            eSum += e;
            eCount++;
          }
          const evolCell = evolMonthCells[idx];
          if(evolCell){
            evolCell.textContent = evoText;
          }
          prev = r;
        });
        const divisor = meta.modo === 'media' ? months.length : 1;
        tdTotP.textContent = formatMetaNumber(sumP / divisor, meta.unidade);
        tdTotR.textContent = formatMetaNumber(sumR / divisor, meta.unidade);
        const totalPct = sumP ? (sumR / sumP * 100) : 0;
        tdTotC.textContent = sumP ? totalPct.toFixed(2) + '%' : '-';
        tdTotC.className = colorClass(totalPct);
        tdTotE.textContent = eCount ? (eSum / eCount).toFixed(2) + '%' : '-';
      };

      updateMetaCalculations();

      if(info){
        const desc = info.querySelector('.meta-desc');
        const posInp = info.querySelector('.meta-pos');
        desc.value = meta.descricao;
        posInp.value = meta.pos || '';
        const syncTitle = () => { updateTitleText(); };
        syncTitle();
        if(meta.fixed){ desc.disabled = true; }
        desc.addEventListener('input', () => { meta.descricao = desc.value; syncTitle(); });
        desc.addEventListener('blur', () => { meta.descricao = desc.value; syncTitle(); persistMetas(); });
        posInp.onchange = () => { meta.pos = parseInt(posInp.value,10) || 0; syncTitle(); persistMetas(); renderMetaSummary(); };

        const setorSel = info.querySelector('.meta-setor');
        setorSel.value = meta.setor;
        if(meta.fixed){ setorSel.disabled = true; }
        setorSel.onchange = () => { meta.setor = setorSel.value; persistMetas(); renderMetas(); };

        const unSel = info.querySelector('.meta-unidade');
        unSel.value = meta.unidade;
        if(meta.fixed){ unSel.disabled = true; }
        unSel.onchange = () => { meta.unidade = unSel.value; persistMetas(); renderMetas(); };

        const dirSel = info.querySelector('.meta-direcao');
        dirSel.value = meta.direcao;
        if(meta.fixed){ dirSel.disabled = true; }
        dirSel.onchange = () => { meta.direcao = dirSel.value; persistMetas(); };

        const tagSel = info.querySelector('.meta-tag');
        tagSel.value = meta.tag || '';
        if(meta.fixed){ tagSel.disabled = true; }
        tagSel.onchange = () => { meta.tag = tagSel.value; persistMetas(); };

        info.querySelectorAll('input[name="modo_'+meta.id+'"]').forEach(r => {
          r.checked = meta.modo === r.value;
          if(meta.fixed){ r.disabled = true; }
          r.onchange = () => {
            if(r.checked){
              meta.modo = r.value;
              persistMetas();
              renderMetas();
            }
          };
        });

        const dupBtn = info.querySelector('.dup');
        if(dupBtn){
          dupBtn.onclick = () => {
            const copy = JSON.parse(JSON.stringify(meta));
            copy.id = uuid();
            copy.pos = nextMetaPos();
            METAS.push(copy);
            persistMetas();
            renderMetas();
          };
        }

        const delBtn = info.querySelector('.del');
        if(delBtn){
          delBtn.onclick = () => {
            if(confirm('Excluir meta?')){
              METAS = METAS.filter(x => x.id !== meta.id);
              persistMetas();
              renderMetas();
            }
          };
        }

        const pasteBtn = info.querySelector('.paste-values');
        if(pasteBtn){
          pasteBtn.onclick = () => {
            openColarMetasModal(meta.id);
          };
        }

        const autoFillBtn = info.querySelector('.auto-fill');
        if(autoFillBtn){
          autoFillBtn.onclick = async () => {
            await autoFillMetaFromAnalysis(meta);
          };
        }

        const viewAnalysisBtn = info.querySelector('.view-analysis');
        if(viewAnalysisBtn){
          viewAnalysisBtn.onclick = async () => {
            await showMetaAnalysisModal(meta);
          };
        }

        const move = (dir)=>{
          const same = METAS.filter(m=> (m.setor||'comercial')===meta.setor);
          const idx = same.findIndex(m=>m.id===meta.id);
          const target = dir==='up'? same[idx-1] : same[idx+1];
          if(target){
            const i1 = METAS.findIndex(m=>m.id===meta.id);
            const i2 = METAS.findIndex(m=>m.id===target.id);
            [METAS[i1], METAS[i2]] = [METAS[i2], METAS[i1]];
            persistMetas();
            renderMetas();
          }
        };
        info.querySelector('.up').onclick = ()=>move('up');
        info.querySelector('.down').onclick = ()=>move('down');
      } else {
        updateTitleText();
      }

      trP.querySelectorAll('input.planned').forEach(inp => {
        const m = inp.dataset.month;
        inp.value = formatMetaInput(meta.meses[m].p, meta.unidade);
        inp.addEventListener('input', () => {
          meta.meses[m].p = parseMetaInput(inp.value, meta.unidade);
          scheduleMetaPersist();
          updateMetaCalculations();
        });
        inp.addEventListener('blur', () => {
          meta.meses[m].p = parseMetaInput(inp.value, meta.unidade);
          flushMetaPersist();
          updateMetaCalculations();
          if (currentSection === 'metas') {
            renderMetaSummary();
          }
        });
      });

      trR.querySelectorAll('input.realized').forEach(inp => {
        const m = inp.dataset.month;
        inp.value = formatMetaInput(meta.meses[m].r, meta.unidade);
        inp.addEventListener('input', () => {
          meta.meses[m].r = parseMetaInput(inp.value, meta.unidade);
          scheduleMetaPersist();
          updateMetaCalculations();
        });
        inp.addEventListener('blur', () => {
          meta.meses[m].r = parseMetaInput(inp.value, meta.unidade);
          flushMetaPersist();
          updateMetaCalculations();
          if (currentSection === 'metas') {
            renderMetaSummary();
          }
        });
      });

      frag.appendChild(trP);
      frag.appendChild(trR);
      frag.appendChild(trC);
      frag.appendChild(trE);
      const trGap = document.createElement('tr');
      trGap.className = 'meta-gap';
      const tdGap = document.createElement('td');
      tdGap.colSpan = months.length + (mobile ? 1 : 2);
      trGap.appendChild(tdGap);
      frag.appendChild(trGap);
      rows.push(trGap);
      applyRowState();
      return frag;
    }

    /* ========= demandas ========= */
    let DEMANDAS = [];
    let DEMANDA_MONTH_PLANS = {};
    let lastDemandasSignature = '';
    let lastDemandaPlansSignature = '';
    let lastRemoteDemandasSignature = '';
    let lastRemoteDemandaPlansSignature = '';
    const DEMANDAS_SAVE_DEBOUNCE_MS = 650;
    let demandasSaveTimer = null;
    let demandasSavePending = false;
    let demandasSaveInFlight = false;
    let demandasSaveQueued = false;
    let pendingDemandasSnapshot = null;
    const DEMANDA_MONTH_STORAGE_KEY = 'mg_demandas_month';
    const DEMANDA_MONTHS = [
      { month:1, label:'Jan' },
      { month:2, label:'Fev' },
      { month:3, label:'Mar' },
      { month:4, label:'Abr' },
      { month:5, label:'Mai' },
      { month:6, label:'Jun' },
      { month:7, label:'Jul' },
      { month:8, label:'Ago' },
      { month:9, label:'Set' },
      { month:10, label:'Out' },
      { month:11, label:'Nov' },
      { month:12, label:'Dez' }
    ];
    const demandaToday = new Date();
    function buildMonthKey(year, month){
      return `${year}-${String(month).padStart(2,'0')}`;
    }
    function getMonthKeyFromValue(value){
      if(!value) return '';
      const dt = new Date(value);
      if(Number.isNaN(dt.getTime())) return '';
      return buildMonthKey(dt.getFullYear(), dt.getMonth()+1);
    }
    function loadStoredDemandaMonth(){
      try{
        const stored = localStorage.getItem(DEMANDA_MONTH_STORAGE_KEY);
        if(stored && /^\d{4}-\d{2}$/.test(stored)){
          return stored;
        }
      }catch(_err){ }
      return buildMonthKey(demandaToday.getFullYear(), demandaToday.getMonth()+1);
    }
    let selectedDemandaMonth = loadStoredDemandaMonth();
    let demandaMonthYear = parseInt(selectedDemandaMonth.slice(0,4),10) || demandaToday.getFullYear();
    // STATUS_OPTIONS, TAG_OPTIONS e RESP_OPTIONS agora definidos globalmente ap√≥s Firebase init
    const PLAN_TYPES = [
      { key:'estrategico', label:'Plano estrat√©gico' },
      { key:'tatico', label:'Plano t√°tico' },
      { key:'operacional', label:'Plano operacional' }
    ];
    const PLAN_PROMPT_HINTS = {
      estrategico: 'Produza direcionamentos de marketing de alto n√≠vel, defini√ß√µes de posicionamento, KPIs norteadores e conex√µes com as metas mensais.',
      tatico: 'Desdobre campanhas, canais, propostas de conte√∫do, segmenta√ß√µes, investimentos e respons√°veis semanais.',
      operacional: 'Liste rotinas, tarefas detalhadas, respons√°veis, prazos e checklists para a execu√ß√£o di√°ria e semanal.'
    };
    function getDemandaDateKey(prazo){
      if(typeof prazo !== 'string') return '';
      const trimmed = prazo.trim();
      if(!trimmed) return '';
      if(trimmed.length >= 10){
        const part = trimmed.slice(0,10);
        if(/^\d{4}-\d{2}-\d{2}$/.test(part)) return part;
      }
      const dt = new Date(trimmed);
      if(Number.isNaN(dt.getTime())) return '';
      const year = dt.getFullYear();
      const month = String(dt.getMonth()+1).padStart(2,'0');
      const day = String(dt.getDate()).padStart(2,'0');
      return `${year}-${month}-${day}`;
    }

    function parseDemandaDate(value){
      if(!value) return null;
      const dt = new Date(value);
      return Number.isNaN(dt.getTime()) ? null : dt;
    }

    function parseFilterDate(value, endOfDay = false){
      if(typeof value !== 'string' || !value) return null;
      const parts = value.split('-').map(Number);
      if(parts.length !== 3 || parts.some(num=>Number.isNaN(num))) return null;
      const [year, month, day] = parts;
      if(endOfDay){
        return new Date(year, month - 1, day, 23, 59, 59, 999);
      }
      return new Date(year, month - 1, day, 0, 0, 0, 0);
    }

    function getDemandaStartDate(d){
      if(!d) return null;
      const start = parseDemandaDate(d.prazo);
      return start ? new Date(start) : null;
    }

    function getDemandaEndDate(d){
      if(!d) return null;
      const start = getDemandaStartDate(d);
      const end = parseDemandaDate(d.prazoFim);
      
      console.log('üìÖ [getDemandaEndDate]', {
        demanda: d.demanda,
        prazoInicio: d.prazo,
        prazoFim: d.prazoFim,
        startDate: start ? start.toISOString() : null,
        endDate: end ? end.toISOString() : null
      });
      
      if(end && start && end.getTime() < start.getTime()){
        console.log('‚ö†Ô∏è [getDemandaEndDate] Data final anterior √† inicial, usando data inicial');
        return new Date(start);
      }
      if(end) return new Date(end);
      return start ? new Date(start) : null;
    }

    function getDemandaDueDate(d){
      return getDemandaEndDate(d);
    }

    function getDemandaSortMeta(d){
      const start = getDemandaStartDate(d);
      const end = getDemandaEndDate(d);
      const startMs = start ? start.getTime() : (end ? end.getTime() : Number.MAX_SAFE_INTEGER);
      const endMs = end ? end.getTime() : startMs;
      return { startMs, endMs };
    }

    function getDemandMonthKeys(d){
      const start = getDemandaStartDate(d) || parseDemandaDate(d?.prazoFim);
      if(!start) return [];
      const end = getDemandaEndDate(d) || start;
      const keys = [];
      const cursor = new Date(start.getFullYear(), start.getMonth(), 1);
      const limit = new Date(end.getFullYear(), end.getMonth(), 1);
      while(cursor.getTime() <= limit.getTime()){
        keys.push(buildMonthKey(cursor.getFullYear(), cursor.getMonth()+1));
        cursor.setMonth(cursor.getMonth()+1, 1);
      }
      return keys;
    }

    function getDemandaCalendarEntries(d){
      if(!d) return [];
      const entries = [];
      const startKey = getDemandaDateKey(d.prazo);
      const endKey = getDemandaDateKey(d.prazoFim);
      if(startKey){
        entries.push({ demanda: d, part: endKey ? 'start' : 'single', dateKey: startKey });
      }
      if(endKey){
        entries.push({ demanda: d, part: startKey ? 'end' : 'single', dateKey: endKey });
      }
      return entries;
    }

    function getDemandaEntryTime(entry){
      if(!entry || !entry.demanda) return 0;
      if(entry.part === 'end'){
        const end = parseDemandaDate(entry.demanda.prazoFim);
        if(end) return end.getTime();
      }
      const base = parseDemandaDate(entry.demanda.prazo);
      if(base) return base.getTime();
      const fallback = parseDemandaDate(entry.demanda.prazoFim);
      return fallback ? fallback.getTime() : 0;
    }

    function formatDemandaSchedule(entry){
      if(!entry || !entry.demanda) return '';
      const d = entry.demanda;
      const joinParts = parts => parts.filter(Boolean).join(' ');
      const startParts = getDemandaCalendarParts(d.prazo);
      const endParts = getDemandaCalendarParts(d.prazoFim);
      const startText = joinParts([startParts.dateLabel, startParts.timeLabel]);
      const endText = joinParts([endParts.dateLabel, endParts.timeLabel]);
      if(entry.part === 'start'){
        const startLabel = startText || endText;
        if(endText){
          const fimLabel = endText;
          if(startLabel){
            return `In√≠cio: ${startLabel} ‚Ä¢ Fim: ${fimLabel}`;
          }
          return `Fim: ${fimLabel}`;
        }
        return startLabel ? `In√≠cio: ${startLabel}` : '';
      }
      if(entry.part === 'end'){
        const label = endText || startText;
        return label ? `Fim: ${label}` : '';
      }
      if(startText && endText && endText !== startText){
        return `${startText} - ${endText}`;
      }
      if(!startText && endText){
        return `Fim: ${endText}`;
      }
      return startText || endText || '';
    }

    function getDemandaCalendarParts(prazo){
      if(!prazo) return { dateLabel:'', timeLabel:'' };
      const dt = new Date(prazo);
      if(Number.isNaN(dt.getTime())) return { dateLabel:'', timeLabel:'' };
      const dateLabel = dt.toLocaleDateString('pt-BR', { day:'2-digit', month:'2-digit' });
      const timeLabel = dt.toLocaleTimeString('pt-BR', { hour:'2-digit', minute:'2-digit', hour12:false });
      return { dateLabel, timeLabel };
    }

    function renderCalendarDemandaItems(entries, esc, textFilter){
      if(!Array.isArray(entries) || !entries.length) return '';
      const filter = (textFilter||'').trim().toLowerCase();
      const filtered = filter ? entries.filter(entry=>{
        const d = entry?.demanda || {};
        const statusLabel = STATUS_OPTIONS.find(o=>o.value===d.status)?.label || '';
        const schedule = formatDemandaSchedule(entry);
        const search = `${d?.demanda||''} ${statusLabel} ${d?.responsavel||''} ${schedule}`.toLowerCase();
        return search.includes(filter);
      }) : entries;
      if(!filtered.length) return '';
      const itemsHtml = filtered.map(entry=>{
        const d = entry.demanda || {};
        const statusInfo = STATUS_OPTIONS.find(o=>o.value===d.status) || {};
        const color = statusInfo.color || '#64748b';
        const statusLabel = statusInfo.label || '';
        const schedule = formatDemandaSchedule(entry);
        const metaParts = [];
        if(schedule) metaParts.push(schedule);
        if(statusLabel) metaParts.push(statusLabel);
        if(d?.responsavel) metaParts.push(d.responsavel);
        const meta = metaParts.join(' ‚Ä¢ ');
        const title = (d?.demanda || '').trim() || '(Sem t√≠tulo)';
        return `<div class="cal-demand" style="--status-color:${color}"><span class="cal-demand-dot" aria-hidden="true"></span><div class="cal-demand-text"><div class="cal-demand-title">${esc(title)}</div>${meta?`<div class="cal-demand-meta">${esc(meta)}</div>`:''}</div></div>`;
      }).join('');
      return itemsHtml ? `<div class="cal-demands">${itemsHtml}</div>` : '';
    }

    function renderCalendarMobileDemandas(demandaMap, esc, textFilter, monthKey){
      if(!calendarDemandasMobile) return;
      const items = [];
      if(demandaMap && typeof demandaMap.forEach === 'function'){
        demandaMap.forEach((list, iso)=>{
          if(!iso || (typeof monthKey === 'string' && !iso.startsWith(monthKey))) return;
          const html = renderCalendarDemandaItems(list, esc, textFilter);
          if(html){
            items.push({ iso, html });
          }
        });
      }
      if(!items.length){
        calendarDemandasMobile.innerHTML = '<h3 class="calendar-demandas-mobile-title">Planejamento &amp; Demandas</h3><div class="calendar-demandas-mobile-empty">Sem demandas planejadas para este m√™s.</div>';
        return;
      }
      items.sort((a,b)=> a.iso.localeCompare(b.iso));
      const formatDate = (iso)=>{
        try{
          const dt = new Date(`${iso}T00:00:00`);
          if(Number.isNaN(dt.getTime())) return iso;
          return dt.toLocaleDateString('pt-BR', { day:'2-digit', month:'2-digit' });
        }catch(_err){
          return iso;
        }
      };
      const content = items.map(({iso, html})=>`
        <div class="calendar-demandas-mobile-day">
          <div class="calendar-demandas-mobile-date">${formatDate(iso)}</div>
          ${html}
        </div>
      `).join('');
      calendarDemandasMobile.innerHTML = `
        <h3 class="calendar-demandas-mobile-title">Planejamento &amp; Demandas</h3>
        <div class="calendar-demandas-mobile-list">${content}</div>
      `;
    }

    const NOTIFICATION_THRESHOLD_DAYS = [30, 15, 7, 5, 4, 2, 1];
    const NOTIFICATION_CATEGORY_ICONS = { demand:'‚è∞', meta:'üéØ', posts:'üóìÔ∏è', leads:'üéØ', item:'üÜï' };
    const NOTIFICATION_SEEN_KEY = 'mg_notifications_seen_v2';
    const NOTIFICATION_COUNTERS_KEY = 'mg_notification_counters_v1';
    const NOTIFICATION_CREATED_KEY = 'mg_notification_created_v1';

    function getNotificationStorageKey(base){
      let tenant = '';
      try{
        if(typeof TENANT === 'string' && TENANT){ tenant = TENANT; }
        else if(document && document.body){
          const attr = document.body.getAttribute('data-client-id');
          if(attr) tenant = attr;
        }
      }catch(_err){ tenant = ''; }
      const safe = tenant ? tenant.replace(/[^\w-]/g, '_') : 'default';
      return `${base}_${safe}`;
    }

    let notificationWidgetEl = null;
    let notificationButtonEl = null;
    let notificationBadgeEl = null;
    let notificationPanelEl = null;
    let notificationListEl = null;
    let notificationEmptyEl = null;
    let notificationItems = [];
    // Expor notificationItems globalmente para o SendGrid Integration
    window.getNotificationItems = function() {
      console.log('üîî getNotificationItems chamado, items:', notificationItems.length);
      return notificationItems;
    };
    let notificationSeenMap = loadNotificationSeen();
    let notificationCreatedMap = loadNotificationCreated();
    let notificationAckCounters = loadNotificationCounters();
    let notificationLatestSnapshot = {};
    let notificationUpdateTimer = null;
    let notificationInitialized = false;

    function loadNotificationSeen(){
      try{
        const raw = localStorage.getItem(getNotificationStorageKey(NOTIFICATION_SEEN_KEY));
        if(raw){
          const parsed = JSON.parse(raw);
          if(parsed && typeof parsed === 'object') return parsed;
        }
      }catch(_err){ }
      return {};
    }

    function saveNotificationSeen(){
      try{ localStorage.setItem(getNotificationStorageKey(NOTIFICATION_SEEN_KEY), JSON.stringify(notificationSeenMap)); }
      catch(_err){ }
    }

    function loadNotificationCounters(){
      try{
        const raw = localStorage.getItem(getNotificationStorageKey(NOTIFICATION_COUNTERS_KEY));
        if(raw){
          const parsed = JSON.parse(raw);
          if(parsed && typeof parsed === 'object') return parsed;
        }
      }catch(_err){ }
      return {};
    }

    function saveNotificationCounters(){
      try{ localStorage.setItem(getNotificationStorageKey(NOTIFICATION_COUNTERS_KEY), JSON.stringify(notificationAckCounters)); }
      catch(_err){ }
    }

    function loadNotificationCreated(){
      try{
        const raw = localStorage.getItem(getNotificationStorageKey(NOTIFICATION_CREATED_KEY));
        if(raw){
          const parsed = JSON.parse(raw);
          if(parsed && typeof parsed === 'object') return parsed;
        }
      }catch(_err){ }
      return {};
    }

    function saveNotificationCreated(){
      try{ localStorage.setItem(getNotificationStorageKey(NOTIFICATION_CREATED_KEY), JSON.stringify(notificationCreatedMap)); }
      catch(_err){ }
    }

    function getNotificationCountersSnapshot(){
      const snapshot = {};
      try{
        snapshot.links = USER_DATA && Array.isArray(USER_DATA.links) ? USER_DATA.links.length : 0;
      }catch(_err){ snapshot.links = 0; }
      try{
        const values = SOCIAL_LINKS && typeof SOCIAL_LINKS === 'object' ? Object.values(SOCIAL_LINKS) : [];
        snapshot.social = values.filter(link=> (link||'').toString().trim().length > 0).length;
      }catch(_err){ snapshot.social = 0; }
      try{
        snapshot.references = Array.isArray(REF_SOCIAL) ? REF_SOCIAL.length : 0;
      }catch(_err){ snapshot.references = 0; }
      try{
        snapshot.competitors = Array.isArray(COMPETITORS) ? COMPETITORS.length : 0;
      }catch(_err){ snapshot.competitors = 0; }
      try{
        if(Array.isArray(ACCESSES)) snapshot.accesses = ACCESSES.length;
        else if(USER_DATA && Array.isArray(USER_DATA.accesses)) snapshot.accesses = USER_DATA.accesses.length;
        else snapshot.accesses = 0;
      }catch(_err){ snapshot.accesses = 0; }
      try{
        snapshot.files = Array.isArray(recentFilesCache) ? recentFilesCache.length : 0;
      }catch(_err){ snapshot.files = 0; }
      return snapshot;
    }

    function formatNotificationNumber(value){
      const num = Number(value) || 0;
      return num.toLocaleString('pt-BR');
    }

    function formatNotificationTimestamp(ms){
      const value = Number(ms);
      if(!Number.isFinite(value)) return '';
      const dt = new Date(value);
      if(Number.isNaN(dt.getTime())) return '';
      const day = String(dt.getDate()).padStart(2, '0');
      const month = String(dt.getMonth() + 1).padStart(2, '0');
      const year = dt.getFullYear();
      const hours = String(dt.getHours()).padStart(2, '0');
      const minutes = String(dt.getMinutes()).padStart(2, '0');
      return `${day}/${month}/${year} - ${hours}:${minutes}`;
    }

    function getPostDateForNotifications(post){
      if(!post) return null;
      let dt = safeDate(post.dateISO);
      if(!dt || Number.isNaN(dt.getTime())){
        if(post.createdAt){
          const created = safeDate(post.createdAt);
          if(created && Number.isFinite(created.getTime())) dt = created;
        }
        if((!dt || Number.isNaN(dt.getTime())) && post.updatedAt){
          const updated = safeDate(post.updatedAt);
          if(updated && Number.isFinite(updated.getTime())) dt = updated;
        }
      }
      return dt && Number.isFinite(dt.getTime()) ? dt : null;
    }

    function buildNotificationItems(){
      const items = [];
      const now = new Date();
      const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const msPerDay = 24 * 60 * 60 * 1000;

      console.log('üîî [NOTIFICATIONS] Iniciando buildNotificationItems');
      console.log('üîî [NOTIFICATIONS] Data atual:', now.toISOString());
      console.log('üîî [NOTIFICATIONS] Total de demandas:', DEMANDAS?.length || 0);

      const demandasList = Array.isArray(DEMANDAS) ? DEMANDAS : [];
      demandasList.forEach((d, index)=>{
        if(!d) return;
        
        // üîç LOG: Mostrar status RAW e prazo RAW antes de processar
        console.log(`üîç [DEMANDA ${index + 1}] DADOS RAW:`, {
          status: d.status,
          statusTipo: typeof d.status,
          prazo: d.prazo,
          prazoTipo: typeof d.prazo,
          prazoFim: d.prazoFim,
          prazoFimTipo: typeof d.prazoFim
        });
        
        const status = (d.status || '').toLowerCase();
        const done = status === 'concluido' || status === 'concluido-grupo';
        const due = getDemandaDueDate(d);
        
        console.log(`üîî [DEMANDA ${index + 1}] T√≠tulo: "${d.demanda}"`, {
          status: status,
          done: done,
          prazo: d.prazo,
          dueDate: due ? due.toISOString() : 'null',
          hasDate: !!due
        });
        
        if(!due) {
          console.log(`‚ö†Ô∏è [DEMANDA ${index + 1}] IGNORADA: Sem data de prazo v√°lida`);
          return;
        }
        
        // ‚è∞ CORRE√á√ÉO: Usar 'now' (momento atual) em vez de 'todayStart' (meia-noite)
        // E usar Math.floor() em vez de Math.ceil() para que -0.4 dias = -1 (atrasado)
        // Math.ceil(-0.4) = 0 ‚ùå | Math.floor(-0.4) = -1 ‚úÖ
        const diffDays = Math.floor((due.getTime() - now.getTime()) / msPerDay);
        const title = (d.demanda || '').trim() || 'Demanda sem t√≠tulo';
        const responsavel = (d.responsavel || '').trim();
        const dueLabel = due.toLocaleDateString('pt-BR', { day:'2-digit', month:'2-digit' });
        const metaText = responsavel ? `Prazo: ${dueLabel} ‚Ä¢ Respons√°vel: ${responsavel}` : `Prazo: ${dueLabel}`;
        
        console.log(`üìÖ [DEMANDA ${index + 1}] Diferen√ßa de dias: ${diffDays}`, {
          atrasada: diffDays < 0,
          concluida: done,
          mostrarComoAtrasada: diffDays < 0 && !done,
          horaAtual: now.toLocaleTimeString('pt-BR'),
          horaPrazo: due.toLocaleTimeString('pt-BR')
        });
        
        // üö® LOG ESPECIAL: Se estiver atrasada mas n√£o aparecer, mostrar motivo
        if(diffDays < 0) {
          if(done) {
            console.log(`‚ùå [DEMANDA ${index + 1}] N√ÉO MOSTRAR√Å: Atrasada mas marcada como conclu√≠da`);
            console.log(`   ‚îî‚îÄ Status encontrado: "${status}"`);
          } else {
            console.log(`‚úÖ [DEMANDA ${index + 1}] DEVE MOSTRAR: Atrasada e N√ÉO conclu√≠da`);
          }
        }
        
        // Captura a data de cria√ß√£o da demanda
        const demandaCreated = d.created || Date.now();
        
        if(diffDays < 0 && !done){
          const overdueDays = Math.abs(diffDays);
          const overdueLabel = overdueDays === 1 ? '1 dia' : `${overdueDays} dias`;
          console.log(`üö® [DEMANDA ${index + 1}] ATRASADA! Adicionando notifica√ß√£o cr√≠tica`, {
            titulo: title,
            diasAtrasado: overdueDays
          });
          items.push({
            id: `demanda-${d.id || title}-overdue`,
            category: 'demand',
            severity: 'critical',
            icon: 'üö®',
            title: 'üö® URGENTE: Demanda Atrasada üö®',
            message: `‚ö†Ô∏è ${title} est√° atrasada h√° ${overdueLabel}. A√á√ÉO NECESS√ÅRIA!`,
            meta: metaText,
            action: { label: 'Ver demanda', section: 'demandas', demandaId: d.id || '' },
            demandaCreated: demandaCreated
          });
          return;
        }
        if(done) {
          console.log(`‚úÖ [DEMANDA ${index + 1}] IGNORADA: J√° est√° conclu√≠da`);
          return;
        }
        if(NOTIFICATION_THRESHOLD_DAYS.includes(diffDays)){
          const label = diffDays === 30 ? '1 m√™s'
            : diffDays === 15 ? '15 dias'
            : diffDays === 7 ? '1 semana'
            : diffDays === 5 ? '5 dias'
            : diffDays === 4 ? '4 dias'
            : diffDays === 2 ? '2 dias'
            : '1 dia';
          items.push({
            id: `demanda-${d.id || title}-${diffDays}`,
            category: 'demand',
            severity: 'warn',
            icon: NOTIFICATION_CATEGORY_ICONS.demand,
            title: 'Prazo de demanda',
            message: `${title} vence em ${label}.`,
            meta: metaText,
            action: { label: 'Ver demanda', section: 'demandas', demandaId: d.id || '' },
            demandaCreated: demandaCreated
          });
        } else if(diffDays === 0){
          items.push({
            id: `demanda-${d.id || title}-hoje`,
            category: 'demand',
            severity: 'warn',
            icon: NOTIFICATION_CATEGORY_ICONS.demand,
            title: 'Prazo de demanda',
            message: `${title} vence hoje.`,
            meta: metaText,
            action: { label: 'Ver demanda', section: 'demandas', demandaId: d.id || '' },
            demandaCreated: demandaCreated
          });
        }
      });

      const metasList = Array.isArray(METAS) ? METAS.filter(meta=> meta && meta.ativo !== false) : [];
      const monthKey = Array.isArray(META_MONTHS) ? META_MONTHS[now.getMonth()] : null;
      const totalDays = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate() || 30;
      const dayRatio = totalDays ? now.getDate() / totalDays : 1;
      const metasAtRisk = [];
      metasList.forEach(meta=>{
        if(!meta || !monthKey) return;
        const meses = meta.meses || {};
        const current = meses[monthKey] || {};
        const planned = normalizeMetaNumber(current.p ?? current.P);
        const realized = normalizeMetaNumber(current.r ?? current.R);
        if(planned <= 0) return;
        const status = evaluateMetaGoal(planned, realized, meta.direcao);
        if(status === 'achieved') return;
        const progressRatio = planned ? realized / planned : 0;
        if(dayRatio < 0.5 && progressRatio >= 0.5) return;
        const plannedLabel = formatMetaDisplay(planned, meta.unidade);
        const realizedLabel = formatMetaDisplay(realized, meta.unidade);
        metasAtRisk.push({
          descricao: (meta.descricao || 'Meta sem t√≠tulo').trim() || 'Meta sem t√≠tulo',
          plannedLabel,
          realizedLabel
        });
      });
      if(metasAtRisk.length){
        const detail = metasAtRisk.slice(0,3).map(meta=>`${meta.descricao}: ${meta.realizedLabel}/${meta.plannedLabel}`).join(' ‚Ä¢ ');
        const extra = metasAtRisk.length > 3 ? ` ‚Ä¢ +${metasAtRisk.length - 3} meta(s)` : '';
        items.push({
          id: `meta-risk-${monthKey}`, // ID est√°vel por m√™s
          category: 'meta',
          severity: 'warn',
          icon: NOTIFICATION_CATEGORY_ICONS.meta,
          title: metasAtRisk.length === 1 ? 'Meta em risco' : 'Metas em risco',
          message: detail + extra,
          meta: 'Revise as metas cadastradas para este m√™s.',
          action: { label: 'Ver metas', section: 'metas' }
        });
      }

      const postMetrics = computePostMetrics(Array.isArray(POSTS) ? POSTS : [], now);
      const monthPosts = [];
      const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
      const nextMonthStart = new Date(now.getFullYear(), now.getMonth() + 1, 1);
      (Array.isArray(POSTS) ? POSTS : []).forEach(post=>{
        const dt = getPostDateForNotifications(post);
        if(!dt) return;
        const ts = dt.getTime();
        if(ts < monthStart.getTime() || ts >= nextMonthStart.getTime()) return;
        monthPosts.push(post);
      });
      const statusCounts = { aprovado:0, revisar:0, publicado:0 };
      monthPosts.forEach(post=>{
        const status = (post.status || '').toLowerCase();
        if(Object.prototype.hasOwnProperty.call(statusCounts, status)){
          statusCounts[status] += 1;
        }
      });
      if(monthPosts.length){
        const parts = [];
        if(statusCounts.aprovado) parts.push(`${formatNotificationNumber(statusCounts.aprovado)} aprovado(s)`);
        if(statusCounts.revisar) parts.push(`${formatNotificationNumber(statusCounts.revisar)} aguardando revis√£o`);
        if(statusCounts.publicado) parts.push(`${formatNotificationNumber(statusCounts.publicado)} publicado(s)`);
        const label = parts.join(' ‚Ä¢ ') || 'Nenhum post cadastrado para este m√™s.';
        items.push({
          id: `posts-status-${monthKey}`, // ID est√°vel por m√™s
          category: 'posts',
          severity: statusCounts.revisar > 0 ? 'warn' : 'info',
          icon: NOTIFICATION_CATEGORY_ICONS.posts,
          title: 'Status dos posts do m√™s',
          message: label,
          meta: postMetrics && postMetrics.monthLabel ? postMetrics.monthLabel : '',
          action: { label: 'Ver posts', section: 'calendar' }
        });
      }
      if(postMetrics && postMetrics.target > 0 && postMetrics.remaining > 0){
        items.push({
          id: `posts-remaining-${monthKey}`, // ID est√°vel por m√™s
          category: 'posts',
          severity: 'warn',
          icon: 'üìù',
          title: 'Meta de posts pendente',
          message: `Faltam ${formatNotificationNumber(postMetrics.remaining)} post(s) aprovados para atingir a meta de ${postMetrics.monthLabel || 'posts'}.`,
          meta: postMetrics.target ? `Meta: ${formatNotificationNumber(postMetrics.target)} ‚Ä¢ Aprovados: ${formatNotificationNumber(postMetrics.approved)}` : '',
          action: { label: 'Ver posts', section: 'calendar' }
        });
      }

      const countersSnapshot = getNotificationCountersSnapshot();
      const counterLabels = {
        links: { title:'Novos links', message: diff=>`${formatNotificationNumber(diff)} link(s) cadastrados recentemente.`, section:'widgets', icon:'üîó' },
        social: { title:'Novas redes conectadas', message: diff=>`${formatNotificationNumber(diff)} rede(s) social(is) conectada(s).`, section:'widgets', icon:'üåê' },
        references: { title:'Novas refer√™ncias', message: diff=>`${formatNotificationNumber(diff)} refer√™ncia(s) adicionada(s).`, section:'refSocial', icon:'üìö' },
        competitors: { title:'Novos concorrentes', message: diff=>`${formatNotificationNumber(diff)} concorrente(s) registrado(s).`, section:'concorrentes', icon:'üèÅ' },
        accesses: { title:'Novos acessos', message: diff=>`${formatNotificationNumber(diff)} acesso(s) cadastrado(s).`, section:'access', icon:'üîê' },
        files: { title:'Novos arquivos', message: diff=>`${formatNotificationNumber(diff)} arquivo(s) enviado(s) para a plataforma.`, section:'arquivos', icon:'üóÇÔ∏è' }
      };
      Object.keys(counterLabels).forEach(key=>{
        const current = Number(countersSnapshot[key]) || 0;
        const ack = Number(notificationAckCounters[key]) || 0;
        if(current > ack){
          const diff = current - ack;
          const meta = counterLabels[key];
          items.push({
            id: `new-${key}-${current}`,
            category: 'item',
            severity: 'info',
            icon: meta.icon || NOTIFICATION_CATEGORY_ICONS.item,
            title: meta.title,
            message: meta.message(diff),
            meta: `Total: ${formatNotificationNumber(current)}`,
            action: { label: 'Ver se√ß√£o', section: meta.section }
          });
        }
      });

      // ====== POSTS: Notifica√ß√£o de posts pendentes de aprova√ß√£o ======
      const postsAguardandoAprovacao = monthPosts.filter(post=> (post.status || '').toLowerCase() === 'revisar');
      if(postsAguardandoAprovacao.length > 0){
        // Usa a data do post mais antigo pendente como refer√™ncia
        const oldestPostDate = postsAguardandoAprovacao.reduce((oldest, post) => {
          const postDate = getPostDateForNotifications(post);
          if(!postDate) return oldest;
          const postTime = postDate.getTime();
          return postTime < oldest ? postTime : oldest;
        }, Date.now());
        
        items.push({
          id: `posts-pending-approval-${monthKey}`,
          category: 'posts',
          severity: 'alert',
          icon: 'üìù',
          title: postsAguardandoAprovacao.length === 1 ? 'Post pendente de aprova√ß√£o' : `${postsAguardandoAprovacao.length} posts pendentes de aprova√ß√£o`,
          message: `${formatNotificationNumber(postsAguardandoAprovacao.length)} post(s) aguardando revis√£o no m√™s atual.`,
          meta: 'Aguardando aprova√ß√£o para publica√ß√£o',
          action: { label: 'Ver posts', section: 'calendar' },
          postCreated: oldestPostDate
        });
      }

      // ====== LEADS: Notifica√ß√µes de novos leads (hoje, m√™s atual e m√™s passado) ======
      const leadsList = Array.isArray(LEADS) ? LEADS : [];
      const todayLeads = [];
      const thisMonthLeads = [];
      const lastMonthLeads = [];
      
      leadsList.forEach(lead=>{
        if(!lead || !lead.createdAt) return;
        let leadDate = null;
        if(typeof lead.createdAt.toDate === 'function'){
          leadDate = lead.createdAt.toDate();
        } else if(lead.createdAt.seconds){
          leadDate = new Date(lead.createdAt.seconds * 1000);
        } else if(lead.createdAt instanceof Date){
          leadDate = lead.createdAt;
        }
        if(!leadDate) return;
        
        const diffDays = Math.ceil((leadDate.getTime() - todayStart.getTime()) / msPerDay);
        
        // Leads de hoje
        if(diffDays === 0){
          todayLeads.push(lead);
        }
        
        // Leads do m√™s atual
        if(leadDate >= monthStart && leadDate < nextMonthStart){
          thisMonthLeads.push(lead);
        }
        
        // Leads do m√™s passado
        const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 1);
        if(leadDate >= lastMonthStart && leadDate < lastMonthEnd){
          lastMonthLeads.push(lead);
        }
      });
      
      // Notifica√ß√£o: Leads de hoje (prioridade alta)
      if(todayLeads.length > 0){
        const leadNames = todayLeads.slice(0, 3).map(l=> (l.name || 'Lead sem nome').trim()).join(', ');
        const extra = todayLeads.length > 3 ? ` + ${todayLeads.length - 3} mais` : '';
        const leadSources = [...new Set(todayLeads.map(l=> l.source || l.plataforma || 'origem desconhecida').filter(Boolean))];
        const sourceLabel = leadSources.length > 0 ? ` ‚Ä¢ Fontes: ${leadSources.slice(0,2).join(', ')}${leadSources.length > 2 ? '...' : ''}` : '';
        
        // Usa o primeiro lead como refer√™ncia de data de cria√ß√£o
        const firstLeadCreated = todayLeads[0].createdAt ? 
          (typeof todayLeads[0].createdAt.toDate === 'function' ? todayLeads[0].createdAt.toDate().getTime() :
           todayLeads[0].createdAt.seconds ? todayLeads[0].createdAt.seconds * 1000 :
           todayLeads[0].createdAt instanceof Date ? todayLeads[0].createdAt.getTime() : Date.now()) 
          : Date.now();
        
        items.push({
          id: `new-leads-today-${now.toISOString().split('T')[0]}`,
          category: 'leads',
          severity: 'info',
          icon: 'üéØ',
          title: todayLeads.length === 1 ? 'Novo lead hoje' : `${todayLeads.length} novos leads hoje`,
          message: `${leadNames}${extra}`,
          meta: sourceLabel,
          action: { label: 'Ver leads', section: 'leads' },
          leadCreated: firstLeadCreated
        });
      }
      
      // Notifica√ß√£o: Leads do m√™s atual
      if(thisMonthLeads.length > 0){
        // Usa o primeiro lead do m√™s como refer√™ncia
        const firstMonthLeadCreated = thisMonthLeads[0].createdAt ? 
          (typeof thisMonthLeads[0].createdAt.toDate === 'function' ? thisMonthLeads[0].createdAt.toDate().getTime() :
           thisMonthLeads[0].createdAt.seconds ? thisMonthLeads[0].createdAt.seconds * 1000 :
           thisMonthLeads[0].createdAt instanceof Date ? thisMonthLeads[0].createdAt.getTime() : monthStart.getTime()) 
          : monthStart.getTime();
        
        items.push({
          id: `new-leads-month-${monthKey}`,
          category: 'leads',
          severity: 'info',
          icon: 'üìä',
          title: `${formatNotificationNumber(thisMonthLeads.length)} lead(s) no m√™s atual`,
          message: `Total de leads recebidos em ${monthKey || 'este m√™s'}.`,
          meta: `Acompanhe o desempenho do m√™s`,
          action: { label: 'Ver leads', section: 'leads' },
          leadCreated: firstMonthLeadCreated
        });
      }
      
      // Notifica√ß√£o: Leads do m√™s passado (para refer√™ncia)
      if(lastMonthLeads.length > 0){
        const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        const lastMonthKey = `${lastMonth.getFullYear()}-${String(lastMonth.getMonth() + 1).padStart(2, '0')}`;
        
        // Usa o primeiro lead do m√™s passado como refer√™ncia
        const firstLastMonthLeadCreated = lastMonthLeads[0].createdAt ? 
          (typeof lastMonthLeads[0].createdAt.toDate === 'function' ? lastMonthLeads[0].createdAt.toDate().getTime() :
           lastMonthLeads[0].createdAt.seconds ? lastMonthLeads[0].createdAt.seconds * 1000 :
           lastMonthLeads[0].createdAt instanceof Date ? lastMonthLeads[0].createdAt.getTime() : lastMonth.getTime()) 
          : lastMonth.getTime();
        
        items.push({
          id: `new-leads-last-month-${lastMonthKey}`,
          category: 'leads',
          severity: 'info',
          icon: 'üìÖ',
          title: `${formatNotificationNumber(lastMonthLeads.length)} lead(s) no m√™s passado`,
          message: `Total de leads recebidos em ${lastMonthKey || 'm√™s anterior'}.`,
          meta: `Para compara√ß√£o com o m√™s atual`,
          action: { label: 'Ver leads', section: 'leads' },
          leadCreated: firstLastMonthLeadCreated
        });
      }

      const order = { demand:0, meta:1, posts:2, leads:3, item:4 };
      items.sort((a,b)=> (order[a.category] ?? 99) - (order[b.category] ?? 99));
      return { items, countersSnapshot };
    }

    function ensureNotificationElements(){
      if(notificationInitialized){
        if(!notificationWidgetEl){
          notificationWidgetEl = document.getElementById('notificationWidget');
        }
        return;
      }
      notificationWidgetEl = document.getElementById('notificationWidget');
      notificationButtonEl = document.getElementById('notificationButton');
      notificationBadgeEl = document.getElementById('notificationBadge');
      notificationPanelEl = document.getElementById('notificationPanel');
      notificationListEl = document.getElementById('notificationList');
      notificationEmptyEl = document.getElementById('notificationEmpty');
      if(!notificationWidgetEl || !notificationButtonEl || !notificationPanelEl) return;
      notificationInitialized = true;
      notificationButtonEl.addEventListener('click', ()=> {
        // Ao clicar no bot√£o, SEMPRE marca tudo como visto (comportamento "visto tudo")
        markNotificationsSeen();
        updateNotificationBadge();
        toggleNotificationPanel();
      });
      document.addEventListener('click', handleNotificationOutside, true);
      document.addEventListener('keydown', handleNotificationKeydown);
    }

    function renderNotifications(){
      ensureNotificationElements();
      if(!notificationListEl || !notificationEmptyEl) return;
      notificationListEl.innerHTML = '';
      if(!notificationItems.length){
        notificationEmptyEl.hidden = false;
        updateNotificationSummaryCounts(0, 0, 0); // Zerar contadores
        return;
      }
      notificationEmptyEl.hidden = true;
      
      // Contar notifica√ß√µes por severidade
      const criticalCount = notificationItems.filter(i => i.severity === 'critical').length;
      const warnCount = notificationItems.filter(i => i.severity === 'warn' || i.severity === 'alert').length;
      const infoCount = notificationItems.filter(i => i.severity === 'info').length;
      updateNotificationSummaryCounts(criticalCount, warnCount, infoCount);
      
      const frag = document.createDocumentFragment();
      notificationItems.forEach(item=>{
        const wrapper = document.createElement('div');
        wrapper.className = 'notification-item';
        if(item.severity) wrapper.classList.add(item.severity);
        
        // Marca como 'unseen' apenas se n√£o foi vista
        if(!notificationSeenMap[item.id]) wrapper.classList.add('unseen');
        
        const iconWrap = document.createElement('div');
        iconWrap.className = 'notification-icon-wrap';
        iconWrap.textContent = item.icon || NOTIFICATION_CATEGORY_ICONS[item.category] || 'üîî';
        wrapper.appendChild(iconWrap);
        const content = document.createElement('div');
        content.className = 'notification-content';
        const titleEl = document.createElement('div');
        titleEl.className = 'notification-item-title';
        titleEl.textContent = item.title || 'Notifica√ß√£o';
        content.appendChild(titleEl);
        const messageEl = document.createElement('div');
        messageEl.textContent = item.message || '';
        content.appendChild(messageEl);
        if(item.meta){
          const metaEl = document.createElement('div');
          metaEl.className = 'notification-item-meta';
          metaEl.textContent = item.meta;
          content.appendChild(metaEl);
        }
        const timeLabel = formatNotificationTimestamp(item.createdAt);
        if(timeLabel){
          const timeEl = document.createElement('div');
          timeEl.className = 'notification-item-meta notification-item-time';
          timeEl.textContent = `Registrado em ${timeLabel}`;
          content.appendChild(timeEl);
        }
        if(item.action){
          const actionsWrap = document.createElement('div');
          actionsWrap.className = 'notification-actions';
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'notification-action';
          btn.textContent = item.action.label || 'Abrir';
          btn.addEventListener('click', ()=> handleNotificationAction(item.action));
          actionsWrap.appendChild(btn);
          content.appendChild(actionsWrap);
        }
        wrapper.appendChild(content);
        frag.appendChild(wrapper);
      });
      notificationListEl.appendChild(frag);
    }

    function updateNotificationSummaryCounts(critical, warn, info){
      const criticalCard = document.getElementById('notifCountCritical');
      const warnCard = document.getElementById('notifCountWarn');
      const infoCard = document.getElementById('notifCountInfo');
      
      if(criticalCard){
        const num = criticalCard.querySelector('div:first-child');
        if(num) num.textContent = String(critical);
      }
      if(warnCard){
        const num = warnCard.querySelector('div:first-child');
        if(num) num.textContent = String(warn);
      }
      if(infoCard){
        const num = infoCard.querySelector('div:first-child');
        if(num) num.textContent = String(info);
      }
    }

    function updateNotificationBadge(){
      ensureNotificationElements();
      if(!notificationBadgeEl) return;
      
      // Conta apenas notifica√ß√µes que n√£o foram marcadas como vistas
      const unseen = notificationItems.reduce((acc, item)=> {
        return acc + (notificationSeenMap[item.id] ? 0 : 1);
      }, 0);
      
      if(unseen > 0){
        notificationBadgeEl.textContent = unseen > 99 ? '99+' : String(unseen);
        notificationBadgeEl.hidden = false;
      }else{
        notificationBadgeEl.hidden = true;
      }
    }

    function attachNotificationTimestamps(items){
      if(!Array.isArray(items)) return [];
      const now = Date.now();
      const activeIds = new Set();
      let changed = false;
      items.forEach(item=>{
        if(!item || !item.id) return;
        const id = String(item.id);
        activeIds.add(id);
        
        // Se j√° existe no mapa, usa o timestamp existente
        if(Object.prototype.hasOwnProperty.call(notificationCreatedMap, id)){
          item.createdAt = notificationCreatedMap[id];
        } else {
          // Nova notifica√ß√£o: tenta usar a data real do item
          let timestamp = now;
          
          // Para demandas, usa o campo 'created' se dispon√≠vel
          if(item.category === 'demand' && item.demandaCreated){
            timestamp = item.demandaCreated;
          }
          // Para leads, usa o campo 'leadCreated' se dispon√≠vel
          else if(item.category === 'leads' && item.leadCreated){
            timestamp = item.leadCreated;
          }
          // Para posts, usa o campo 'postCreated' se dispon√≠vel
          else if(item.category === 'posts' && item.postCreated){
            timestamp = item.postCreated;
          }
          
          notificationCreatedMap[id] = timestamp;
          item.createdAt = timestamp;
          changed = true;
        }
      });
      Object.keys(notificationCreatedMap).forEach(id=>{
        if(!activeIds.has(id)){
          delete notificationCreatedMap[id];
          changed = true;
        }
      });
      if(changed) saveNotificationCreated();
      
      console.log('üîî [NOTIFICATIONS] RESUMO FINAL:', {
        totalNotificacoes: items.length,
        criticas: items.filter(i => i.severity === 'critical').length,
        alertas: items.filter(i => i.severity === 'alert').length,
        avisos: items.filter(i => i.severity === 'warn').length,
        info: items.filter(i => i.severity === 'info').length,
        notificacoes: items.map(i => ({ 
          titulo: i.title, 
          mensagem: i.message, 
          severidade: i.severity 
        }))
      });
      
      return items;
    }

    function applyNotificationData(data){
      console.log('üì• [applyNotificationData] Recebendo dados:', data);
      
      if(!data || !Array.isArray(data.items)) {
        console.warn('‚ö†Ô∏è [applyNotificationData] Dados inv√°lidos:', data);
        return;
      }
      
      console.log('üì• [applyNotificationData] Items antes de anexar timestamps:', data.items.length);
      notificationItems = attachNotificationTimestamps(data.items);
      console.log('üì• [applyNotificationData] Items ap√≥s anexar timestamps:', notificationItems.length);
      
      notificationLatestSnapshot = data.countersSnapshot || notificationLatestSnapshot || {};
      renderNotifications();
      updateNotificationBadge();
      
      // ============================================
      // SINCRONIZAR COM SERVICE WORKER
      // ============================================
      const clientKey = getClientKey();
      if(clientKey && notificationItems.length > 0) {
        syncNotificationsWithServiceWorker(clientKey).catch(err => {
          console.warn('‚ö†Ô∏è Erro ao sincronizar notifica√ß√µes com Service Worker:', err);
        });
      }
    }

    function markNotificationsSeen(){
      // Marca todas as notifica√ß√µes atuais como vistas individualmente
      let changed = false;
      notificationItems.forEach(item=>{
        if(!notificationSeenMap[item.id]){
          notificationSeenMap[item.id] = Date.now();
          changed = true;
        }
      });
      if(changed) saveNotificationSeen();
      if(notificationLatestSnapshot && typeof notificationLatestSnapshot === 'object'){
        notificationAckCounters = { ...notificationAckCounters, ...notificationLatestSnapshot };
        saveNotificationCounters();
      }
    }

    function toggleNotificationPanel(force){
      ensureNotificationElements();
      if(!notificationWidgetEl || !notificationPanelEl || !notificationButtonEl) return;
      const shouldOpen = typeof force === 'boolean' ? force : !notificationWidgetEl.classList.contains('open');
      notificationWidgetEl.classList.toggle('open', shouldOpen);
      notificationButtonEl.setAttribute('aria-expanded', shouldOpen ? 'true' : 'false');
      if(shouldOpen){
        // Apenas renderiza, n√£o marca como visto (isso j√° foi feito no click do bot√£o)
        renderNotifications();
      }
    }

    function handleNotificationOutside(ev){
      if(!notificationWidgetEl || !notificationWidgetEl.classList.contains('open')) return;
      if(notificationWidgetEl.contains(ev.target)) return;
      toggleNotificationPanel(false);
    }

    function handleNotificationKeydown(ev){
      if(ev.key === 'Escape' && notificationWidgetEl && notificationWidgetEl.classList.contains('open')){
        toggleNotificationPanel(false);
      }
    }

    function handleNotificationAction(action){
      if(!action || typeof action !== 'object') return;
      if(action.section){
        try{ setActiveTab(action.section); }
        catch(_err){ }
      }
      toggleNotificationPanel(false);
      if(action.section === 'demandas' && action.demandaId){
        requestAnimationFrame(()=>{
          const selector = `#demandasBody tr[data-id="${action.demandaId}"]`;
          const row = document.querySelector(selector);
          if(row){
            row.scrollIntoView({ behavior:'smooth', block:'center' });
          }
        });
      }
    }

    function scheduleNotificationRefresh(options = {}){
      const immediate = !!options.immediate;
      if(immediate){
        if(notificationUpdateTimer){
          clearTimeout(notificationUpdateTimer);
          notificationUpdateTimer = null;
        }
        try{ applyNotificationData(buildNotificationItems()); }
        catch(err){ console.warn('notifications:update', err); }
        return;
      }
      if(notificationUpdateTimer){
        clearTimeout(notificationUpdateTimer);
      }
      notificationUpdateTimer = setTimeout(()=>{
        notificationUpdateTimer = null;
        try{ applyNotificationData(buildNotificationItems()); }
        catch(err){ console.warn('notifications:update', err); }
      }, 250);
    }

    function initNotificationWidget(){
      console.log('üöÄ [WIDGET] Inicializando notification widget');
      ensureNotificationElements();
      // Gerar notifica√ß√µes ao inicializar
      try{ 
        console.log('üöÄ [WIDGET] Chamando buildNotificationItems...');
        const items = buildNotificationItems();
        console.log('üöÄ [WIDGET] Items gerados:', items.length);
        applyNotificationData(items); 
      } catch(err){ 
        console.error('‚ùå [WIDGET] Erro ao inicializar notifica√ß√µes:', err); 
      }
      renderNotifications();
      updateNotificationBadge();
      console.log('üöÄ [WIDGET] Inicializa√ß√£o conclu√≠da');
    }
    document.addEventListener('DOMContentLoaded', initNotificationWidget);

    function formatDate(ms){ return ms? new Date(ms).toLocaleString('pt-BR',{hour12:false}) : ''; }
    
    function applyStatusColor(tr, status, demanda) {
      // Aplicar cor de status
      const c = STATUS_OPTIONS.find(o => o.value === status)?.color || '';
      tr.style.background = c;
      
      // Verificar se est√° atrasada
      const isOverdue = checkIfOverdue(demanda);
      
      if (isOverdue) {
        // Adicionar borda vermelha/laranja brilhante para demandas atrasadas
        tr.style.border = '3px solid #ff4444';
        tr.style.boxShadow = '0 0 10px rgba(255, 68, 68, 0.5), inset 0 0 10px rgba(255, 68, 68, 0.2)';
        tr.style.position = 'relative';
        tr.classList.add('demanda-atrasada');
      } else {
        // Remover destaque se n√£o estiver mais atrasada
        tr.style.border = '';
        tr.style.boxShadow = '';
        tr.classList.remove('demanda-atrasada');
      }
    }
    
    function checkIfOverdue(demanda) {
      // N√£o marcar como atrasada se j√° est√° conclu√≠da
      // Verificar m√∫ltiplas varia√ß√µes do status "conclu√≠do"
      const status = (demanda.status || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      const concluidos = ['concluida', 'finalizada', 'completa', 'concluido', 'done', 'completed', 'finished'];
      if (concluidos.some(c => status.includes(c))) {
        return false;
      }
      
      const now = new Date();
      
      // Se tem INTERVALO (prazoFim existe), s√≥ verifica o prazo final
      if (demanda.prazoFim) {
        const prazoFimDate = new Date(demanda.prazoFim);
        
        if (prazoFimDate < now) {
          console.log('‚ö†Ô∏è Demanda com intervalo atrasada:', demanda.demanda, 'Prazo fim:', demanda.prazoFim);
          return true;
        }
        
        // Ainda est√° dentro do intervalo, n√£o est√° atrasada
        return false;
      }
      
      // Se N√ÉO tem intervalo, verifica apenas o prazo inicial
      if (demanda.prazo) {
        const prazoDate = new Date(demanda.prazo);
        
        if (prazoDate < now) {
          console.log('‚ö†Ô∏è Demanda sem intervalo atrasada:', demanda.demanda, 'Prazo:', demanda.prazo);
          return true;
        }
      }
      
      return false;
    }
    
    function getAllDemandaMonthKeys(){
      const set = new Set();
      (Array.isArray(DEMANDAS)?DEMANDAS:[]).forEach(d=>{
        const months = getDemandMonthKeys(d);
        months.forEach(key=>{ if(key) set.add(key); });
      });
      Object.keys(DEMANDA_MONTH_PLANS||{}).forEach(key=>{
        if(typeof key==='string' && key){
          const plan = DEMANDA_MONTH_PLANS[key];
          const hasContent = PLAN_TYPES.some(({key:k})=> (plan?.[k]||'').trim());
          if(hasContent){
            set.add(key);
          }
        }
      });
      return set;
    }
    function renderDemandaMonthButtons(){
      const container=$('demandaMonthButtons');
      const monthSelect=$('demandaMonthSelect');
      const yearLabel=$('demandaYearLabel');
      const prevBtn=$('demandaYearPrev');
      const nextBtn=$('demandaYearNext');
      if(yearLabel){ yearLabel.textContent=demandaMonthYear; }
      if(prevBtn){ prevBtn.onclick=()=>changeDemandaYear(-1); }
      if(nextBtn){ nextBtn.onclick=()=>changeDemandaYear(1); }
      if(!container && !monthSelect) return;
      const availableKeys=getAllDemandaMonthKeys();
      if(container){
        container.innerHTML='';
        DEMANDA_MONTHS.forEach(({month,label})=>{
          const key=buildMonthKey(demandaMonthYear,month);
          const btn=document.createElement('button');
          btn.type='button';
          btn.className='demanda-month-button'+(selectedDemandaMonth===key?' active':'')+(availableKeys.has(key)?' has-data':'');
          btn.textContent=label;
          btn.addEventListener('click',()=>{ setSelectedDemandaMonth(key); });
          container.appendChild(btn);
        });
      }
      if(monthSelect){
        // Gera op√ß√µes com o m√™s selecionado primeiro
        const selMonthPart = (selectedDemandaMonth||'').slice(5);
        const selMonthNum = parseInt(selMonthPart||'',10) || (demandaToday.getMonth()+1);
        const idx = Math.max(0, DEMANDA_MONTHS.findIndex(m=>m.month===selMonthNum));
        const rotated = idx>0 ? [...DEMANDA_MONTHS.slice(idx), ...DEMANDA_MONTHS.slice(0, idx)] : [...DEMANDA_MONTHS];
        monthSelect.innerHTML='';
        rotated.forEach(({month,label})=>{
          const key=buildMonthKey(demandaMonthYear,month);
          const opt=document.createElement('option');
          opt.value=key;
          opt.textContent=label;
          if(key===selectedDemandaMonth) opt.selected=true;
          monthSelect.appendChild(opt);
        });
        if(!monthSelect._bound){
          monthSelect.addEventListener('change',()=>{
            const key = monthSelect.value;
            setSelectedDemandaMonth(key);
          });
          monthSelect._bound = true;
        }
      }
    }
    function setSelectedDemandaMonth(monthKey,{persist=true,triggerRender=true}={}){
      if(typeof monthKey!=='string' || !/^\d{4}-\d{2}$/.test(monthKey)) return;
      selectedDemandaMonth=monthKey;
      const parsedYear=parseInt(monthKey.slice(0,4),10);
      if(!Number.isNaN(parsedYear)) demandaMonthYear=parsedYear;
      if(persist){
        try{ localStorage.setItem(DEMANDA_MONTH_STORAGE_KEY, monthKey); }
        catch(_err){ }
      }
      if(triggerRender){ renderDemandas(); }
    }
    function changeDemandaYear(delta){
      if(!Number.isInteger(delta) || delta===0) return;
      const monthPart=selectedDemandaMonth?.slice(5) || String(demandaToday.getMonth()+1).padStart(2,'0');
      const monthNum=parseInt(monthPart,10);
      if(Number.isNaN(monthNum)) return;
      const newYear=demandaMonthYear+delta;
      setSelectedDemandaMonth(buildMonthKey(newYear, monthNum));
    }
    function normalizeDemanda(d){
      if(!d) return d;
      if(!d.planos || typeof d.planos!=='object'){
        d.planos = {};
      }
      PLAN_TYPES.forEach(({key})=>{
        if(typeof d.planos[key] !== 'string') d.planos[key] = '';
      });
      if(typeof d.prazo !== 'string'){
        d.prazo = d.prazo ? String(d.prazo) : '';
      }
      if(typeof d.prazoFim !== 'string'){
        d.prazoFim = '';
      }
      if(typeof d.plano !== 'string'){
        d.plano = '';
      }
      return d;
    }
    function normalizeMonthPlan(monthKey){
      if(typeof monthKey !== 'string' || !monthKey) return null;
      if(!DEMANDA_MONTH_PLANS || typeof DEMANDA_MONTH_PLANS !== 'object'){
        DEMANDA_MONTH_PLANS = {};
      }
      if(!DEMANDA_MONTH_PLANS[monthKey] || typeof DEMANDA_MONTH_PLANS[monthKey] !== 'object'){
        DEMANDA_MONTH_PLANS[monthKey] = {};
      }
      const plan = DEMANDA_MONTH_PLANS[monthKey];
      PLAN_TYPES.forEach(({key})=>{
        if(typeof plan[key] !== 'string') plan[key] = '';
      });
      if(!plan.objectiveNotes || typeof plan.objectiveNotes !== 'object'){
        plan.objectiveNotes = {};
      }else{
        Object.keys(plan.objectiveNotes).forEach(objKey=>{
          if(typeof plan.objectiveNotes[objKey] !== 'string'){
            plan.objectiveNotes[objKey] = '';
          }
        });
      }
      return plan;
    }
    function cloneMonthPlans(data){
      const out = {};
      if(!data || typeof data !== 'object') return out;
      Object.keys(data).forEach(monthKey=>{
        const src = data[monthKey];
        if(!src || typeof src !== 'object') return;
        const target = {};
        PLAN_TYPES.forEach(({key})=>{
          const val = src[key];
          target[key] = typeof val === 'string' ? val : '';
        });
        const notesSrc = src.objectiveNotes && typeof src.objectiveNotes === 'object' ? src.objectiveNotes : {};
        const notesTarget = {};
        Object.keys(notesSrc).forEach(noteKey=>{
          const noteVal = notesSrc[noteKey];
          notesTarget[noteKey] = typeof noteVal === 'string' ? noteVal : '';
        });
        target.objectiveNotes = notesTarget;
        out[monthKey] = target;
      });
      return out;
    }
    function normalizeDemandasForComparison(list){
      if(!Array.isArray(list)) return [];
      return list.map(item=>{
        const copy = { ...(item || {}) };
        copy.planos = item?.planos && typeof item.planos === 'object' ? { ...item.planos } : {};
        return normalizeDemanda(copy);
      });
    }
    function buildDemandasSignature(list){
      if(!Array.isArray(list)) return '[]';
      const normalized = list.map(item=>({
        id: item?.id ? String(item.id) : '',
        status: item?.status ? String(item.status) : '',
        responsavel: item?.responsavel ? String(item.responsavel) : '',
        tag: item?.tag ? String(item.tag) : '',
        prazo: item?.prazo ? String(item.prazo) : '',
        prazoFim: item?.prazoFim ? String(item.prazoFim) : '',
        edited: Number(item?.edited) || 0
      }));
      normalized.sort((a,b)=>{
        const idDiff = (a.id || '').localeCompare(b.id || '');
        if(idDiff !== 0) return idDiff;
        return a.edited - b.edited;
      });
      return JSON.stringify(normalized);
    }
    function buildMonthPlansSignature(plans){
      if(!plans || typeof plans !== 'object') return '{}';
      const normalized = {};
      Object.keys(plans).sort().forEach(monthKey=>{
        const entry = plans[monthKey] && typeof plans[monthKey] === 'object' ? plans[monthKey] : {};
        normalized[monthKey] = {};
        PLAN_TYPES.forEach(({key})=>{
          const val = entry[key];
          normalized[monthKey][key] = typeof val === 'string' ? val : '';
        });
        const notes = entry.objectiveNotes && typeof entry.objectiveNotes === 'object' ? entry.objectiveNotes : {};
        const normalizedNotes = {};
        Object.keys(notes).sort().forEach(noteKey=>{
          const noteVal = notes[noteKey];
          normalizedNotes[noteKey] = typeof noteVal === 'string' ? noteVal : '';
        });
        normalized[monthKey].objectiveNotes = normalizedNotes;
      });
      return JSON.stringify(normalized);
    }
    function computeDemandSnapshotSignatures(rawDemandas, rawPlans){
      return {
        demandas: buildDemandasSignature(normalizeDemandasForComparison(rawDemandas)),
        plans: buildMonthPlansSignature(cloneMonthPlans(rawPlans))
      };
    }
    function syncDemandasSignatures(){
      lastDemandasSignature = buildDemandasSignature(Array.isArray(DEMANDAS) ? DEMANDAS : []);
      lastDemandaPlansSignature = buildMonthPlansSignature(DEMANDA_MONTH_PLANS);
    }
    function migrateDemandPlansToMonthPlans(){
      if(!Array.isArray(DEMANDAS) || DEMANDAS.length===0) return;
      const buckets = {};
      DEMANDAS.forEach(d=>{
        normalizeDemanda(d);
        const months = getDemandMonthKeys(d);
        if(!months.length) return;
        months.forEach(key=>{
          if(!buckets[key]) buckets[key] = [];
          buckets[key].push(d);
        });
      });
      let changed = false;
      Object.keys(buckets).forEach(monthKey=>{
        const monthPlan = normalizeMonthPlan(monthKey);
        if(!monthPlan) return;
        PLAN_TYPES.forEach(({key})=>{
          if(typeof monthPlan[key] === 'string' && monthPlan[key].trim()) return;
          const values = buckets[monthKey]
            .map(item => (item.planos?.[key] || '').trim())
            .filter(Boolean);
          if(!values.length) return;
          const unique = [...new Set(values)];
          const joined = unique.join('\n\n');
          if(joined){
            monthPlan[key] = joined;
            changed = true;
          }
        });
      });
      if(changed){
        setTimeout(()=>{ try{ scheduleDemandasPersist({ immediate:true }); }catch(_e){} }, 0);
      }
    }
    function createDemanda(){ const now=Date.now(); return normalizeDemanda({id:uuid(),status:'',tag:'',demanda:'',responsavel:'',prazo:'',plano:'',edited:now,created:now}); }
    async function loadDemandasFromSubcollection(uid){
      try{
        console.log('üì• [LOAD] Carregando demandas da subcole√ß√£o...');
        const chunksSnapshot = await getDocs(collection(db, 'usuarios', uid, 'demandas_chunks'));
        const chunks = [];
        
        chunksSnapshot.forEach(doc => {
          const data = doc.data();
          if(data.demandas && Array.isArray(data.demandas)){
            chunks.push({
              index: data.chunkIndex || 0,
              demandas: data.demandas
            });
          }
        });
        
        // Ordenar chunks por √≠ndice
        chunks.sort((a, b) => a.index - b.index);
        
        // Combinar todas as demandas
        const allDemandas = [];
        chunks.forEach(chunk => {
          allDemandas.push(...chunk.demandas);
        });
        
        console.log(`‚úÖ [LOAD] ${allDemandas.length} demandas carregadas de ${chunks.length} chunks`);
        return allDemandas;
      }catch(err){
        console.error('‚ùå [LOAD] Erro ao carregar subcole√ß√£o:', err);
        return [];
      }
    }
    
    async function loadDemandasFromUserData(){
      const uid = auth.currentUser?.uid;
      
      // DEBUG: Verificar estado do USER_DATA
      console.log('üìã [DEMANDAS] loadDemandasFromUserData chamada');
      console.log('üìã [DEMANDAS] UID:', uid);
      console.log('üìã [DEMANDAS] USER_DATA.demandas:', USER_DATA.demandas?.length || 0, 'itens');
      console.log('üìã [DEMANDAS] USER_DATA.demandaMonthPlans keys:', Object.keys(USER_DATA.demandaMonthPlans || {}).length);
      console.log('üìã [DEMANDAS] USER_DATA.usesSubcollection:', USER_DATA.usesSubcollection);
      
      // Verificar se usa subcole√ß√£o
      if(uid && USER_DATA.usesSubcollection === true){
        console.log('üîÑ [LOAD] Detectado uso de subcole√ß√£o (flag ativa)');
        const subcolDemandas = await loadDemandasFromSubcollection(uid);
        DEMANDAS = subcolDemandas.length > 0 ? subcolDemandas.map(normalizeDemanda) : [];
      } else {
        DEMANDAS = Array.isArray(USER_DATA.demandas) ? USER_DATA.demandas.map(normalizeDemanda) : [];
      }
      
      // FALLBACK: Se demandas vazias e uid dispon√≠vel, tentar subcole√ß√£o
      if(uid && DEMANDAS.length === 0){
        console.log('üîÑ [FALLBACK] Demandas vazias, tentando carregar da subcole√ß√£o...');
        try {
          const subcolDemandas = await loadDemandasFromSubcollection(uid);
          if(subcolDemandas.length > 0){
            DEMANDAS = subcolDemandas.map(normalizeDemanda);
            console.log('‚úÖ [FALLBACK] Demandas carregadas da subcole√ß√£o:', DEMANDAS.length, 'itens');
          } else {
            console.log('üìã [FALLBACK] Nenhuma demanda encontrada na subcole√ß√£o');
          }
        } catch(fallbackErr) {
          console.error('‚ùå [FALLBACK] Erro ao carregar subcole√ß√£o:', fallbackErr);
        }
      }
      
      console.log('üìã [DEMANDAS] DEMANDAS ap√≥s load:', DEMANDAS.length, 'itens');
      
      DEMANDA_MONTH_PLANS = cloneMonthPlans(USER_DATA.demandaMonthPlans);
      console.log('üìã [DEMANDAS] DEMANDA_MONTH_PLANS ap√≥s clone:', Object.keys(DEMANDA_MONTH_PLANS || {}).length, 'meses');
      
      Object.keys(DEMANDA_MONTH_PLANS || {}).forEach(monthKey=> normalizeMonthPlan(monthKey));
      if(DEMANDAS.length===0){ DEMANDAS.push(createDemanda()); }
      migrateDemandPlansToMonthPlans();
      normalizeMonthPlan(selectedDemandaMonth);
      syncDemandasSignatures();
      if(typeof renderCalendarDays === 'function'){
        try{ renderCalendarDays(); }catch(_err){}
      }
      try{ refreshMacroInsights(); }catch(_){ }
      // Atualizar notifica√ß√µes ap√≥s carregar demandas
      try{ scheduleNotificationRefresh({ immediate: true }); }catch(_err){}
    }
    async function persistDemandas(){
      const uid=auth.currentUser?.uid;
      if(!uid){
        try{ refreshMacroInsights(); }catch(_){ }
        return;
      }
      const monthPlansPayload = {};
      if(DEMANDA_MONTH_PLANS && typeof DEMANDA_MONTH_PLANS === 'object'){
        Object.keys(DEMANDA_MONTH_PLANS).forEach(monthKey=>{
          const plan = normalizeMonthPlan(monthKey);
          if(!plan) return;
          monthPlansPayload[monthKey] = {};
          PLAN_TYPES.forEach(({key})=>{
            monthPlansPayload[monthKey][key] = typeof plan[key] === 'string' ? plan[key] : '';
          });
          const notes = plan.objectiveNotes && typeof plan.objectiveNotes === 'object' ? plan.objectiveNotes : {};
          const payloadNotes = {};
          Object.keys(notes).forEach(noteKey=>{
            const noteVal = notes[noteKey];
            if(typeof noteVal === 'string' && noteVal.trim()){
              payloadNotes[noteKey] = noteVal;
            }
          });
          monthPlansPayload[monthKey].objectiveNotes = payloadNotes;
        });
      }
      syncDemandasSignatures();
      try{ refreshMacroInsights(); }catch(_){ }
      
      // Estrat√©gia de salvamento com subcole√ß√µes para evitar limite de 1MB
      const MAX_DEMANDAS_PER_CHUNK = 50; // Limite seguro por documento
      const CHUNK_SIZE_BYTES_ESTIMATE = 800000; // ~800KB (deixa margem do limite de 1MB)
      
      try{
        // Calcular tamanho estimado dos dados
        const estimatedSize = JSON.stringify({ demandas: DEMANDAS, demandaMonthPlans: monthPlansPayload }).length;
        console.log(`üìä [PERSIST] Tamanho estimado dos dados: ${(estimatedSize/1024).toFixed(2)} KB`);
        
        // Se menor que 700KB, salvar normalmente
        if(estimatedSize < 700000){
          console.log('‚úÖ [PERSIST] Salvando no documento principal (< 700KB)');
          await setDoc(doc(db,'usuarios',uid), { 
            demandas: DEMANDAS, 
            demandaMonthPlans: monthPlansPayload,
            usesSubcollection: false 
          }, { merge:true });
        } else {
          console.log('‚ö†Ô∏è [PERSIST] Dados grandes detectados! Usando subcole√ß√£o...');
          
          // Dividir demandas em chunks
          const chunks = [];
          for(let i = 0; i < DEMANDAS.length; i += MAX_DEMANDAS_PER_CHUNK){
            chunks.push(DEMANDAS.slice(i, i + MAX_DEMANDAS_PER_CHUNK));
          }
          
          console.log(`üì¶ [PERSIST] Dividindo em ${chunks.length} chunks`);
          
          // Salvar metadata no documento principal
          await setDoc(doc(db,'usuarios',uid), { 
            usesSubcollection: true,
            demandasCount: DEMANDAS.length,
            demandaMonthPlans: monthPlansPayload,
            lastUpdated: Date.now()
          }, { merge:true });
          
          // Salvar chunks na subcole√ß√£o
          const batch = writeBatch(db);
          chunks.forEach((chunk, idx) => {
            const chunkRef = doc(db, 'usuarios', uid, 'demandas_chunks', `chunk_${idx}`);
            batch.set(chunkRef, { 
              demandas: chunk,
              chunkIndex: idx,
              timestamp: Date.now()
            });
          });
          
          // Limpar chunks antigos se necess√°rio
          const totalChunksNeeded = chunks.length;
          for(let i = totalChunksNeeded; i < totalChunksNeeded + 10; i++){
            const oldChunkRef = doc(db, 'usuarios', uid, 'demandas_chunks', `chunk_${i}`);
            batch.delete(oldChunkRef);
          }
          
          await batch.commit();
          console.log('‚úÖ [PERSIST] Salvamento em subcole√ß√£o conclu√≠do!');
        }
      }catch(err){
        console.error('‚ùå [PERSIST] Erro ao salvar:', err);
        throw err;
      }finally{
        try{ refreshMacroInsights(); }catch(_){ }
      }
    }
    function hasPendingDemandasSave(){
      return demandasSavePending || demandasSaveInFlight || !!demandasSaveTimer;
    }
    function scheduleDemandasPersist({ immediate=false }={}){
      demandasSavePending = true;
      if(demandasSaveTimer){
        clearTimeout(demandasSaveTimer);
        demandasSaveTimer = null;
      }
      if(immediate){
        flushDemandasPersist();
        return;
      }
      demandasSaveTimer = setTimeout(()=>{ flushDemandasPersist(); }, DEMANDAS_SAVE_DEBOUNCE_MS);
    }
    async function flushDemandasPersist(){
      if(demandasSaveTimer){
        clearTimeout(demandasSaveTimer);
        demandasSaveTimer = null;
      }
      if(demandasSaveInFlight){
        demandasSaveQueued = true;
        return;
      }
      if(!demandasSavePending){
        await maybeApplyPendingDemandasSnapshot();
        return;
      }
      demandasSavePending = false;
      demandasSaveInFlight = true;
      try{
        await persistDemandas();
        console.log('‚úÖ [PERSIST] Demandas salvas com sucesso!');
      }catch(err){
        console.error('‚ùå [PERSIST] Erro ao salvar demandas:', err);
        
        // Detectar erro de limite de tamanho
        if(err.code === 'invalid-argument' || err.message?.includes('maximum size') || err.message?.includes('too large') || err.message?.includes('exceeds the maximum')){
          console.warn('üîÑ [PERSIST] Documento muito grande! Tentando migra√ß√£o para subcole√ß√£o...');
          try{
            // For√ßar uso de subcole√ß√£o
            const uid = auth.currentUser?.uid;
            if(uid){
              // Calcular planos mensais separadamente (para salvar na subcole√ß√£o se necess√°rio)
              const monthPlansPayload = {};
              if(DEMANDA_MONTH_PLANS && typeof DEMANDA_MONTH_PLANS === 'object'){
                Object.keys(DEMANDA_MONTH_PLANS).forEach(monthKey=>{
                  const plan = normalizeMonthPlan(monthKey);
                  if(!plan) return;
                  monthPlansPayload[monthKey] = {};
                  PLAN_TYPES.forEach(({key})=>{
                    monthPlansPayload[monthKey][key] = typeof plan[key] === 'string' ? plan[key] : '';
                  });
                  const notes = plan.objectiveNotes && typeof plan.objectiveNotes === 'object' ? plan.objectiveNotes : {};
                  const payloadNotes = {};
                  Object.keys(notes).forEach(noteKey=>{
                    const noteVal = notes[noteKey];
                    if(typeof noteVal === 'string' && noteVal.trim()){
                      payloadNotes[noteKey] = noteVal;
                    }
                  });
                  monthPlansPayload[monthKey].objectiveNotes = payloadNotes;
                });
              }
              
              // Dividir em chunks menores
              const MAX_CHUNK = 50;
              const chunks = [];
              for(let i = 0; i < DEMANDAS.length; i += MAX_CHUNK){
                chunks.push(DEMANDAS.slice(i, i + MAX_CHUNK));
              }
              
              console.log(`üîÑ [PERSIST] Migrando ${DEMANDAS.length} demandas em ${chunks.length} chunks`);
              
              // Primeiro: Limpar dados antigos do documento principal usando updateDoc
              await updateDoc(doc(db,'usuarios',uid), { 
                demandas: deleteField(), // Remove array de demandas
                usesSubcollection: true,
                demandasCount: DEMANDAS.length,
                demandaMonthPlans: monthPlansPayload, // Mant√©m planos (geralmente pequeno)
                lastUpdated: Date.now()
              });
              
              console.log('‚úÖ [PERSIST] Documento principal limpo');
              
              // Segundo: Salvar chunks na subcole√ß√£o
              const batch = writeBatch(db);
              chunks.forEach((chunk, idx) => {
                const chunkRef = doc(db, 'usuarios', uid, 'demandas_chunks', `chunk_${idx}`);
                batch.set(chunkRef, { 
                  demandas: chunk,
                  chunkIndex: idx,
                  timestamp: Date.now()
                });
              });
              
              // Limpar chunks antigos se necess√°rio
              const totalChunksNeeded = chunks.length;
              for(let i = totalChunksNeeded; i < totalChunksNeeded + 10; i++){
                const oldChunkRef = doc(db, 'usuarios', uid, 'demandas_chunks', `chunk_${i}`);
                batch.delete(oldChunkRef);
              }
              
              await batch.commit();
              console.log('‚úÖ [PERSIST] Migra√ß√£o para subcole√ß√£o conclu√≠da com sucesso!');
            }
          }catch(migrationErr){
            console.error('‚ùå [PERSIST] Erro na migra√ß√£o:', migrationErr);
            throw migrationErr;
          }
        } else {
          throw err;
        }
      }finally{
        demandasSaveInFlight = false;
        if(demandasSaveQueued){
          demandasSaveQueued = false;
          scheduleDemandasPersist({ immediate:true });
          return;
        }
        await maybeApplyPendingDemandasSnapshot();
      }
    }
    function shouldDeferDemandasSnapshot(){
      return hasPendingDemandasSave() || isDemandasEditing();
    }
    function queuePendingDemandasSnapshot(payload){
      if(!payload || !payload.signatures){
        pendingDemandasSnapshot = null;
        return;
      }
      pendingDemandasSnapshot = {
        data: payload.data || null,
        signatures: payload.signatures,
        matchesLocalState: !!payload.matchesLocalState
      };
    }
    async function maybeApplyPendingDemandasSnapshot(){
      if(!pendingDemandasSnapshot) return;
      if(shouldDeferDemandasSnapshot()) return;
      const { data, signatures, matchesLocalState } = pendingDemandasSnapshot;
      pendingDemandasSnapshot = null;
      if(data){
        USER_DATA = data;
      }
      lastRemoteDemandasSignature = signatures.demandas;
      lastRemoteDemandaPlansSignature = signatures.plans;
      if(matchesLocalState){
        lastDemandasSignature = signatures.demandas;
        lastDemandaPlansSignature = signatures.plans;
        return;
      }
      await loadDemandasFromUserData();
      requestRenderDemandas();
    }
    function updatePrazoAlert(){
      const el=$('prazoAlert');
      if(!el) return;
      const now=Date.now();
      const overdue = DEMANDAS.filter(d=>{
        const dueDate=getDemandaDueDate(d);
        if(!dueDate) return false;
        const due=dueDate.getTime();
        // Verificar m√∫ltiplas varia√ß√µes do status "conclu√≠do"
        const status = (d.status || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        const concluidos = ['concluida', 'finalizada', 'completa', 'concluido', 'done', 'completed', 'finished', 'concluido-grupo'];
        const done = concluidos.some(c => status.includes(c));
        return !done && due<now;
      });
      if(overdue.length){
        const names = overdue.map(d=>d.demanda||'(sem t√≠tulo)').join(', ');
        el.textContent = `Demandas atrasadas: ${names}`;
        el.style.display='block';
      } else {
        el.style.display='none';
      }
    }
    function markDemandaEdited(d, row){
      if(!d) return;
      d.edited=Date.now();
      const targetRow = row || document.querySelector(`#demandasBody tr[data-id="${d.id}"]`);
      const editedCell = targetRow?.querySelector('.col-edit');
      if(editedCell){
        editedCell.textContent = formatDate(d.edited);
      }
    }
    function formatPrazoLabel(input, maybeEnd){
      let start = null;
      let end = null;
      if(input && typeof input === 'object' && !Array.isArray(input)){
        start = getDemandaStartDate(input) || getDemandaEndDate(input);
        end = getDemandaEndDate(input);
      }else{
        const startCandidate = parseDemandaDate(input) || parseDemandaDate(maybeEnd);
        if(startCandidate) start = new Date(startCandidate);
        const endCandidate = parseDemandaDate(maybeEnd);
        if(endCandidate){
          if(start && endCandidate.getTime() < start.getTime()){
            end = new Date(start);
          }else{
            end = new Date(endCandidate);
          }
        }else if(start){
          end = new Date(start);
        }
      }
      if(!start) return '';
      if(!end) end = new Date(start);
      const format = dt => dt.toLocaleString('pt-BR',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit',hour12:false});
      if(end.getTime() !== start.getTime()){
        return `${format(start)} ‚Äî ${format(end)}`;
      }
      return format(start);
    }
    function getEditableSelection(root){
      const selection = window.getSelection();
      if(!selection || selection.rangeCount === 0) return null;
      const range = selection.getRangeAt(0);
      if(!root.contains(range.startContainer) || !root.contains(range.endContainer)) return null;
      const preRange = range.cloneRange();
      preRange.selectNodeContents(root);
      preRange.setEnd(range.startContainer, range.startOffset);
      const start = preRange.toString().length;
      const length = range.toString().length;
      return { start, end: start + length };
    }
    function findTextPosition(root, targetOffset){
      const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null);
      let node = walker.nextNode();
      let offset = targetOffset;
      while(node){
        const length = node.nodeValue.length;
        if(offset <= length){
          return { node, offset: Math.max(0, offset) };
        }
        offset -= length;
        node = walker.nextNode();
      }
      return { node: root, offset: root.childNodes.length };
    }
    function restoreEditableSelection(root, saved){
      if(!saved) return;
      const selection = window.getSelection();
      if(!selection) return;
      const totalLength = root.textContent?.length || 0;
      const start = Math.min(saved.start, totalLength);
      const end = Math.min(saved.end, totalLength);
      const range = document.createRange();
      const startPos = findTextPosition(root, start);
      const endPos = findTextPosition(root, end);
      try{
        range.setStart(startPos.node, startPos.offset);
        range.setEnd(endPos.node, endPos.offset);
      }catch(_err){
        range.selectNodeContents(root);
        range.collapse(false);
      }
      selection.removeAllRanges();
      selection.addRange(range);
    }
    function sanitizeMarkdownHtml(html){
      const raw = typeof html === 'string' ? html : '';
      if(!raw) return '';
      const purifier = window.DOMPurify;
      let sanitized = '';
      if(purifier && typeof purifier.sanitize === 'function'){
        try{
          sanitized = purifier.sanitize(raw, { 
            USE_PROFILES: { html: true },
            ADD_ATTR: ['style'],
            ALLOWED_ATTR: ['style', 'class', 'src', 'alt', 'href', 'target', 'rel', 'controls', 'crossorigin', 'contenteditable']
          });
        }catch(err){
          console.warn('DOMPurify sanitize error', err);
        }
      }
      if(!sanitized){
        const template = document.createElement('template');
        template.innerHTML = raw;
        const blocked = ['script','style','iframe','object','embed','link','meta'];
        blocked.forEach(tag=>{ template.content.querySelectorAll(tag).forEach(el=> el.remove()); });
        template.content.querySelectorAll('*').forEach(node=>{
          const isMediaResizable = node.classList && node.classList.contains('media-resizable');
          Array.from(node.attributes).forEach(attr=>{
            const name = attr.name.toLowerCase();
            if(name.startsWith('on')){
              node.removeAttribute(attr.name);
              return;
            }
            if(name === 'style' && !isMediaResizable){
              node.removeAttribute(attr.name);
              return;
            }
            if(name === 'href' || name === 'src'){
              const value = (node.getAttribute(attr.name) || '').trim();
              if(!/^(https?:|mailto:|tel:|#|\/)/i.test(value)){
                node.removeAttribute(attr.name);
              }
            }
          });
        });
        sanitized = template.innerHTML || '';
      }
      
      // Adicionar target="_blank" e rel="noopener noreferrer" a todos os links externos
      if(sanitized){
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = sanitized;
        tempDiv.querySelectorAll('a[href]').forEach(link => {
          const href = link.getAttribute('href') || '';
          // Links externos (http/https) abrem em nova aba
          if(/^https?:\/\//i.test(href)){
            link.setAttribute('target', '_blank');
            link.setAttribute('rel', 'noopener noreferrer');
          }
        });
        sanitized = tempDiv.innerHTML;
      }
      
      return sanitized;
    }
    function trimInlineMarkdown(text){
      return typeof text === 'string' ? text.replace(/^\s+|\s+$/g, '') : '';
    }
    function htmlToMarkdown(html){
      if(!html) return '';
      const template = document.createElement('template');
      template.innerHTML = html;
      const ELEMENT_NODE = typeof Node !== 'undefined' ? Node.ELEMENT_NODE : 1;
      const TEXT_NODE = typeof Node !== 'undefined' ? Node.TEXT_NODE : 3;
      const convertChildren = (parent, context) => Array.from(parent.childNodes).map(child => convertNode(child, context)).join('');
      const wrapInline = (content, wrapper) => {
        const trimmed = trimInlineMarkdown(content);
        return trimmed ? `${wrapper}${trimmed}${wrapper}` : '';
      };
      const listItemToMarkdown = (node, ctx) => {
        const baseIndent = Math.max(ctx.indent || 0, 0);
        const marker = ctx.type === 'ol' ? `${ctx.index}. ` : '- ';
        const childContext = { indent: baseIndent + 1, parentList: ctx.type };
        const body = convertChildren(node, childContext).replace(/\n+$/, '');
        const lines = body.split(/\n/);
        const firstLine = lines.shift() || '';
        let result = `${'  '.repeat(baseIndent)}${marker}${firstLine.trim()}`;
        if(lines.length){
          const continuation = lines.map(line => {
            const trimmed = line.trim();
            return trimmed ? `${'  '.repeat(baseIndent + 1)}${trimmed}` : '';
          }).filter(Boolean).join('\n');
          if(continuation) result += `\n${continuation}`;
        }
        return `${result}\n`;
      };
      const listToMarkdown = (node, type, context) => {
        const baseIndent = Math.max(context.indent || 0, 0);
        let index = 1;
        const parts = [];
        node.childNodes.forEach(child => {
          if(child.nodeType === ELEMENT_NODE && child.tagName.toLowerCase() === 'li'){
            parts.push(listItemToMarkdown(child, { indent: baseIndent, type, index }));
            index++;
          }
        });
        return `\n${parts.join('')}\n`;
      };
      const blockquoteToMarkdown = (node, context) => {
        const content = convertChildren(node, context).split(/\n/).map(line => line ? `> ${line}` : '>').join('\n');
        return `\n${content}\n\n`;
      };
      const convertNode = (node, context = { indent: 0 }) => {
        if(node.nodeType === TEXT_NODE){
          return (node.nodeValue || '').replace(/\u00a0/g, ' ');
        }
        if(node.nodeType !== ELEMENT_NODE){
          return '';
        }
        const tag = node.tagName.toLowerCase();
        switch(tag){
          case 'br':
            return '\n';
          case 'strong':
          case 'b':
            return wrapInline(convertChildren(node, context), '**');
          case 'em':
          case 'i':
            return wrapInline(convertChildren(node, context), '_');
          case 'u':
            return wrapInline(convertChildren(node, context), '__');
          case 'code': {
            const parent = node.parentElement;
            const isBlock = parent && parent.tagName && parent.tagName.toLowerCase() === 'pre';
            const text = (node.textContent || '').replace(/\u00a0/g, ' ');
            return isBlock ? text : `\`${trimInlineMarkdown(text)}\``;
          }
          case 'pre': {
            const text = (node.textContent || '').replace(/\u00a0/g, ' ');
            const cleaned = text.replace(/^\n+|\n+$/g, '');
            return '\n\n```\n' + cleaned + '\n```\n\n';
          }
          case 'h1':
            return `\n# ${trimInlineMarkdown(convertChildren(node, context))}\n\n`;
          case 'h2':
            return `\n## ${trimInlineMarkdown(convertChildren(node, context))}\n\n`;
          case 'h3':
            return `\n### ${trimInlineMarkdown(convertChildren(node, context))}\n\n`;
          case 'h4':
            return `\n#### ${trimInlineMarkdown(convertChildren(node, context))}\n\n`;
          case 'h5':
            return `\n##### ${trimInlineMarkdown(convertChildren(node, context))}\n\n`;
          case 'h6':
            return `\n###### ${trimInlineMarkdown(convertChildren(node, context))}\n\n`;
          case 'p':
          case 'div': {
            const inner = convertChildren(node, context);
            return inner.trim() ? `\n${inner}\n\n` : '\n';
          }
          case 'ul':
            return listToMarkdown(node, 'ul', context);
          case 'ol':
            return listToMarkdown(node, 'ol', context);
          case 'li': {
            const type = context.parentList === 'ol' ? 'ol' : 'ul';
            const index = typeof context.index === 'number' ? context.index : 1;
            return listItemToMarkdown(node, { indent: context.indent || 0, type, index });
          }
          case 'a': {
            const href = (node.getAttribute('href') || '').trim();
            const label = trimInlineMarkdown(convertChildren(node, context)) || href;
            return href ? `[${label}](${href})` : label;
          }
          case 'img': {
            const src = (node.getAttribute('src') || '').trim();
            const alt = (node.getAttribute('alt') || '').trim();
            return src ? `![${alt}](${src})` : '';
          }
          case 'blockquote':
            return blockquoteToMarkdown(node, context);
          case 'hr':
            return '\n---\n\n';
          case 'span': {
            // Preserve media-resizable wrapper with width
            if(node.classList && node.classList.contains('media-resizable')){
              const width = node.style.width || '420px';
              const img = node.querySelector('img');
              const video = node.querySelector('video');
              if(img){
                const src = (img.getAttribute('src') || '').trim();
                const alt = (img.getAttribute('alt') || '').trim();
                if(src){
                  return `<span class="media-resizable" contenteditable="false" style="width:${width}"><img alt="${alt}" src="${src}" crossorigin="anonymous"></span>`;
                }
              }
              if(video){
                const src = (video.getAttribute('src') || '').trim();
                if(src){
                  return `<span class="media-resizable" contenteditable="false" style="width:${width}"><video controls src="${src}" crossorigin="anonymous"></video></span>`;
                }
              }
            }
            return convertChildren(node, context);
          }
          case 'section':
          case 'article':
          case 'header':
          case 'footer':
          case 'aside':
            return convertChildren(node, context);
          default:
            return convertChildren(node, context);
        }
      };
      const markdown = convertChildren(template.content, { indent: 0 });
      return markdown;
    }
    
    /**
     * ‚ö†Ô∏è FUN√á√ÉO CR√çTICA: P√≥s-processa HTML para garantir que negrito/it√°lico sempre funcione
     * Converte **texto** que n√£o foi processado em <strong>texto</strong>
     * Converte *texto* que n√£o foi processado em <em>texto</em>
     */
    function postProcessMarkdownFormatting(html) {
      if (!html || typeof html !== 'string') return html;
      
      let processed = html;
      
      // ‚ö†Ô∏è CR√çTICO: Converter **negrito** para <strong>negrito</strong>
      // Padr√£o: **texto** onde texto n√£o cont√©m ** 
      // Usar regex simples sem lookbehind para compatibilidade
      processed = processed.replace(/\*\*([^*<>\n]+?)\*\*/g, '<strong>$1</strong>');
      
      // ‚ö†Ô∏è CR√çTICO: Converter __negrito__ para <strong>negrito</strong>
      processed = processed.replace(/__([^_<>\n]+?)__/g, '<strong>$1</strong>');
      
      // ‚ö†Ô∏è CR√çTICO: Converter *it√°lico* para <em>it√°lico</em>
      // Apenas * √∫nico (n√£o seguido por outro *)
      // Primeiro substituir ** temporariamente para n√£o confundir
      const tempBoldMarker = '___BOLD_TEMP___';
      processed = processed.replace(/\*\*([^*<>\n]+?)\*\*/g, tempBoldMarker + '$1' + tempBoldMarker);
      processed = processed.replace(/\*([^*<>\n]+?)\*/g, '<em>$1</em>');
      processed = processed.replace(new RegExp(tempBoldMarker, 'g'), '**');
      
      // ‚ö†Ô∏è CR√çTICO: Converter _it√°lico_ para <em>it√°lico</em> (apenas _ √∫nico)
      const tempUnderscoreBoldMarker = '___UNDERSCORE_BOLD_TEMP___';
      processed = processed.replace(/__([^_<>\n]+?)__/g, tempUnderscoreBoldMarker + '$1' + tempUnderscoreBoldMarker);
      processed = processed.replace(/_([^_<>\n]+?)_/g, '<em>$1</em>');
      processed = processed.replace(new RegExp(tempUnderscoreBoldMarker, 'g'), '__');
      
      return processed;
    }
    
    function parseMarkdownToHtml(input){
      const raw = typeof input === 'string' ? input : '';
      if(!raw.trim()) return '';
      
      // ‚ö†Ô∏è CR√çTICO: Pr√©-processar tabelas markdown ANTES de passar para marked
      // Isso garante 100% de convers√£o, mesmo quando marked falha
      let processedInput = preprocessMarkdownTables(raw);
      
      const markedLib = window.marked;
      if(markedLib){
        try{
          // Configurar marked para preservar quebras de linha E PROCESSAR NEGRITO
          if(typeof markedLib.setOptions === 'function'){
            markedLib.setOptions({
              breaks: true,        // Converter \n em <br>
              gfm: true,           // GitHub Flavored Markdown
              headerIds: false,    // Sem IDs nos headers
              mangle: false,       // N√£o embaralhar emails
              tables: true,        // ‚ö†Ô∏è CR√çTICO: Ativar suporte a tabelas
              pedantic: false,     // N√£o usar modo pedante (permite negrito/it√°lico)
              smartLists: true,    // Listas inteligentes
              smartypants: false   // N√£o converter aspas autom√°tico
            });
          }
          const parser = typeof markedLib.parse === 'function' ? markedLib.parse : markedLib;
          const html = parser.call(markedLib, processedInput);
          if(typeof html === 'string' && html.trim()){
            // ‚ö†Ô∏è CR√çTICO: P√≥s-processar para garantir negrito/it√°lico sempre funcione
            const htmlWithFormatting = postProcessMarkdownFormatting(html);
            const safe = sanitizeMarkdownHtml(htmlWithFormatting);
            if(safe) return safe;
          }
        }catch(err){
          console.warn('Markdown render error', err);
        }
      }
      
      // Fallback: converter manualmente se marked falhou
      const fallbackHtml = convertMarkdownTablesManually(escapeHtml(processedInput).replace(/\r?\n/g,'<br>'));
      const fallbackWithFormatting = postProcessMarkdownFormatting(fallbackHtml);
      return sanitizeMarkdownHtml(fallbackWithFormatting);
    }
    
    /**
     * ‚ö†Ô∏è FUN√á√ÉO CR√çTICA: Pr√©-processa tabelas markdown para garantir formata√ß√£o correta
     * Isso resolve 100% dos casos onde tabelas aparecem como texto puro
     */
    function preprocessMarkdownTables(text) {
      if (!text || typeof text !== 'string') return text;
      
      // Encontrar todas as tabelas markdown (formato: | col1 | col2 | col3 |)
      const lines = text.split('\n');
      const processedLines = [];
      let inTable = false;
      let tableBuffer = [];
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        const nextLine = i < lines.length - 1 ? lines[i + 1].trim() : '';
        
        // Detectar in√≠cio de tabela (linha com | e pr√≥xima linha √© separador |---|---|)
        const isTableRow = line.startsWith('|') && line.endsWith('|') && line.includes('|');
        const isSeparator = /^\|[\s\-:|]+\|$/.test(nextLine);
        
        if (isTableRow && isSeparator && !inTable) {
          // In√≠cio de tabela detectado
          inTable = true;
          tableBuffer = [line];
        } else if (inTable) {
          if (isTableRow) {
            // Linha da tabela
            tableBuffer.push(line);
          } else {
            // Fim da tabela
            inTable = false;
            // Converter tabela acumulada
            const tableHtml = convertMarkdownTableToHtml(tableBuffer);
            processedLines.push(tableHtml);
            tableBuffer = [];
            processedLines.push(line); // Adicionar a linha atual (n√£o √© parte da tabela)
          }
        } else {
          processedLines.push(line);
        }
      }
      
      // Se ainda h√° tabela no buffer (tabela no final do texto)
      if (tableBuffer.length > 0) {
        const tableHtml = convertMarkdownTableToHtml(tableBuffer);
        processedLines.push(tableHtml);
      }
      
      return processedLines.join('\n');
    }
    
    /**
     * ‚ö†Ô∏è FUN√á√ÉO CR√çTICA: Converte tabela markdown para HTML
     * Garante que TODAS as tabelas sejam renderizadas corretamente
     */
    function convertMarkdownTableToHtml(tableLines) {
      if (!tableLines || tableLines.length < 2) return tableLines.join('\n');
      
      // Separar header e rows
      const headerLine = tableLines[0];
      const separatorLine = tableLines[1];
      const bodyLines = tableLines.slice(2);
      
      // Extrair c√©lulas do header
      const headerCells = headerLine.split('|')
        .map(cell => cell.trim())
        .filter(cell => cell !== '');
      
      // Extrair alinhamentos do separador
      const alignments = separatorLine.split('|')
        .map(cell => cell.trim())
        .filter(cell => cell !== '')
        .map(cell => {
          if (cell.startsWith(':') && cell.endsWith(':')) return 'center';
          if (cell.endsWith(':')) return 'right';
          return 'left';
        });
      
      // Construir HTML
      let html = '<table>\n<thead>\n<tr>\n';
      
      // Header
      headerCells.forEach((cell, idx) => {
        const align = alignments[idx] || 'left';
        html += `<th style="text-align:${align}">${cell}</th>\n`;
      });
      html += '</tr>\n</thead>\n<tbody>\n';
      
      // Body rows
      bodyLines.forEach(line => {
        const cells = line.split('|')
          .map(cell => cell.trim())
          .filter(cell => cell !== '');
        
        if (cells.length > 0) {
          html += '<tr>\n';
          cells.forEach((cell, idx) => {
            const align = alignments[idx] || 'left';
            html += `<td style="text-align:${align}">${cell}</td>\n`;
          });
          html += '</tr>\n';
        }
      });
      
      html += '</tbody>\n</table>';
      
      return html;
    }
    
    /**
     * ‚ö†Ô∏è FALLBACK: Converte tabelas markdown manualmente se tudo mais falhar
     */
    function convertMarkdownTablesManually(html) {
      if (!html || typeof html !== 'string') return html;
      
      // Procurar por padr√µes de tabela markdown que escaparam a convers√£o
      // Padr√£o: texto com m√∫ltiplos | seguidos de <br>
      const tablePattern = /(\|[^<]*\|<br>)+/g;
      
      return html.replace(tablePattern, (match) => {
        // Encontrou texto que parece tabela markdown
        const lines = match.split('<br>').filter(l => l.trim());
        
        if (lines.length < 2) return match; // N√£o √© tabela v√°lida
        
        // Verificar se segunda linha √© separador
        const secondLine = lines[1].trim();
        if (!/^\|[\s\-:|]+\|$/.test(secondLine)) return match; // N√£o √© tabela v√°lida
        
        // Converter para tabela HTML
        const tableLines = lines.map(l => l.replace(/<br>/g, '').trim());
        return convertMarkdownTableToHtml(tableLines);
      });
    }
    function renderMarkdownText(input){
      const html = parseMarkdownToHtml(input);
      if(html) return html;
      const raw = typeof input === 'string' ? input : '';
      if(!raw.trim()) return '';
      return sanitizeMarkdownHtml(escapeHtml(raw).replace(/\r?\n/g,'<br>'));
    }
    function applyMarkdownFormatting(editable, action){
      if(!editable) return;
      editable.focus();
      const commandMap = {
        bold: () => document.execCommand('bold'),
        italic: () => document.execCommand('italic'),
        h1: () => document.execCommand('formatBlock', false, 'H1'),
        h2: () => document.execCommand('formatBlock', false, 'H2'),
        h3: () => document.execCommand('formatBlock', false, 'H3')
      };
      const handler = commandMap[action];
      if(typeof handler === 'function'){
        handler();
        editable.dispatchEvent(new Event('input', { bubbles:true }));
      }
    }
    
    // Fun√ß√£o para aplicar formata√ß√£o Markdown em textareas
    function applyMarkdownToTextarea(textarea, action){
      if(!textarea) return;
      
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const text = textarea.value;
      const selectedText = text.substring(start, end);
      const beforeText = text.substring(0, start);
      const afterText = text.substring(end);
      
      // Verificar se estamos no in√≠cio de uma linha
      const lineStart = beforeText.lastIndexOf('\n') + 1;
      const currentLineStart = beforeText.substring(lineStart);
      const isAtLineStart = currentLineStart.trim() === '' || start === lineStart;
      
      let insertion = '';
      let newCursorStart = start;
      let newCursorEnd = end;
      
      switch(action){
        case 'h1':
          if(selectedText){
            insertion = `# ${selectedText}`;
          } else {
            insertion = isAtLineStart ? '# T√≠tulo Principal\n' : '\n# T√≠tulo Principal\n';
          }
          newCursorStart = start + 2;
          newCursorEnd = newCursorStart + (selectedText ? selectedText.length : 16);
          break;
          
        case 'h2':
          if(selectedText){
            insertion = `## ${selectedText}`;
          } else {
            insertion = isAtLineStart ? '## Se√ß√£o\n' : '\n## Se√ß√£o\n';
          }
          newCursorStart = start + 3;
          newCursorEnd = newCursorStart + (selectedText ? selectedText.length : 5);
          break;
          
        case 'h3':
          if(selectedText){
            insertion = `### ${selectedText}`;
          } else {
            insertion = isAtLineStart ? '### Sub-se√ß√£o\n' : '\n### Sub-se√ß√£o\n';
          }
          newCursorStart = start + 4;
          newCursorEnd = newCursorStart + (selectedText ? selectedText.length : 9);
          break;
          
        case 'bold':
          if(selectedText){
            insertion = `**${selectedText}**`;
            newCursorStart = start + 2;
            newCursorEnd = end + 2;
          } else {
            insertion = '**texto**';
            newCursorStart = start + 2;
            newCursorEnd = start + 7;
          }
          break;
          
        case 'italic':
          if(selectedText){
            insertion = `*${selectedText}*`;
            newCursorStart = start + 1;
            newCursorEnd = end + 1;
          } else {
            insertion = '*texto*';
            newCursorStart = start + 1;
            newCursorEnd = start + 6;
          }
          break;
          
        case 'ul':
          if(selectedText){
            // Converter cada linha em item de lista
            const lines = selectedText.split('\n');
            insertion = lines.map(line => `- ${line}`).join('\n');
            newCursorEnd = start + insertion.length;
          } else {
            insertion = isAtLineStart ? '- Item\n' : '\n- Item\n';
            newCursorStart = start + (isAtLineStart ? 2 : 3);
            newCursorEnd = newCursorStart + 4;
          }
          break;
          
        case 'ol':
          if(selectedText){
            // Converter cada linha em item numerado
            const lines = selectedText.split('\n');
            insertion = lines.map((line, idx) => `${idx + 1}. ${line}`).join('\n');
            newCursorEnd = start + insertion.length;
          } else {
            insertion = isAtLineStart ? '1. Item\n' : '\n1. Item\n';
            newCursorStart = start + (isAtLineStart ? 3 : 4);
            newCursorEnd = newCursorStart + 4;
          }
          break;
          
        case 'quote':
          if(selectedText){
            // Converter cada linha em cita√ß√£o
            const lines = selectedText.split('\n');
            insertion = lines.map(line => `> ${line}`).join('\n');
            newCursorEnd = start + insertion.length;
          } else {
            insertion = isAtLineStart ? '> Cita√ß√£o\n' : '\n> Cita√ß√£o\n';
            newCursorStart = start + (isAtLineStart ? 2 : 3);
            newCursorEnd = newCursorStart + 7;
          }
          break;
          
        case 'hr':
          insertion = '\n\n---\n\n';
          newCursorStart = start + insertion.length;
          newCursorEnd = newCursorStart;
          break;
          
        case 'link':
          if(selectedText){
            insertion = `[${selectedText}](url)`;
            newCursorStart = end + 3; // Posicionar no "url"
            newCursorEnd = newCursorStart + 3;
          } else {
            insertion = '[texto do link](url)';
            newCursorStart = start + 1;
            newCursorEnd = start + 14;
          }
          break;
          
        default:
          return;
      }
      
      textarea.value = beforeText + insertion + afterText;
      textarea.focus();
      textarea.setSelectionRange(newCursorStart, newCursorEnd);
    }
    
    function sortDemandasForMonth(list){
      return (Array.isArray(list)?list:[]).slice().sort((a,b)=>{
        const aDate=getDemandaStartDate(a) || getDemandaEndDate(a);
        const bDate=getDemandaStartDate(b) || getDemandaEndDate(b);
        const aTime=aDate?aDate.getTime():Number.NaN;
        const bTime=bDate?bDate.getTime():Number.NaN;
        if(Number.isNaN(aTime) && Number.isNaN(bTime)){
          return (a?.demanda||'').localeCompare(b?.demanda||'');
        }
        if(Number.isNaN(aTime)) return 1;
        if(Number.isNaN(bTime)) return -1;
        if(aTime!==bTime) return aTime-bTime;
        return (a?.demanda||'').localeCompare(b?.demanda||'');
      });
    }
    function buildMonthDemandsSummary(demands){
      if(!Array.isArray(demands) || !demands.length){
        return 'Nenhuma demanda com per√≠odo definido para este m√™s. Informe se h√° demandas pendentes para registrar o planejamento.';
      }
      return demands.map((d,idx)=>{
        normalizeDemanda(d);
        const title=d.demanda?.trim()?d.demanda.trim():'(Sem t√≠tulo)';
        const statusLabel=STATUS_OPTIONS.find(o=>o.value===d.status)?.label;
        const dueLabel=formatPrazoLabel(d);
        const parts=[`${idx+1}. ${title}`];
        if(statusLabel) parts.push(`Status: ${statusLabel}`);
        if(d.responsavel) parts.push(`Respons√°vel: ${d.responsavel}`);
        if(dueLabel) parts.push(`Per√≠odo: ${dueLabel}`);
        if(d.planos && typeof d.planos==='object'){
          PLAN_TYPES.forEach(({key,label})=>{
            const note=(d.planos?.[key]||'').trim();
            if(note) parts.push(`${label}: ${note.replace(/\s+/g,' ').trim()}`);
          });
        }
        return parts.join(' ‚Ä¢ ');
      }).join('\n');
    }
    function buildPlanIAPrompt({monthLabel, monthKey, planLabel, planKey, monthDemands, existingText}){
      const demandsText=buildMonthDemandsSummary(monthDemands);
      const existingSection=(existingText||'').trim();
      const hint=PLAN_PROMPT_HINTS[planKey] || '';
      const objectiveLine='Priorize os objetivos do m√™s registrados na aba Planejamento e conecte cada entrega √†s demandas listadas.';
      const sections=`Estruture a resposta em: \n1. Objetivo central do m√™s\n2. Principais dados e aprendizados do contexto atual\n3. Recomenda√ß√µes ${planLabel.toLowerCase()} (com rela√ß√£o direta √†s demandas)\n4. Cronograma resumido por semana\n5. Indicadores de sucesso e monitoramento\n6. Alertas ou lacunas de informa√ß√£o.`;
      const existingBlock=existingSection?`\nPlanejamento atual registrado (utilize como refer√™ncia e atualize quando fizer sentido):\n${existingSection}`:'';
      return `Voc√™ √© o planejador de marketing da Mediagrowth. Gere um planejamento ${planLabel.toLowerCase()} para o m√™s ${monthLabel} (${monthKey}).\nUtilize todas as informa√ß√µes dispon√≠veis na plataforma do cliente: trechos do c√≥digo da plataforma, descri√ß√£o textual, snapshot do Firebase, estados da plataforma, guia autom√°tico das abas e demandas cadastradas. ${objectiveLine}\nTipo de planejamento: ${planLabel}. ${hint}\nDemandas do m√™s:\n${demandsText}${existingBlock}\n${sections}\nConclua com uma se√ß√£o "Pr√≥ximos passos imediatos" com at√© cinco bullets claros.`;
    }
    function handlePlanIAGeneration({monthLabel, monthKey, planLabel, planKey, editable, monthDemands}){
      const existingText=(editable?.innerText||'').trim();
      const promptText=buildPlanIAPrompt({monthLabel, monthKey, planLabel, planKey, monthDemands, existingText});
      openIAWithPrompt(promptText);
    }
    function buildObjectivePlanIAPrompt({monthLabel, monthKey, monthDemands, monthPlan}){
      if(!Array.isArray(monthDemands) || !monthDemands.length) return '';
      const plan = monthPlan && typeof monthPlan === 'object' ? monthPlan : normalizeMonthPlan(monthKey);
      const demandBlocks = monthDemands.map((d,idx)=>{
        normalizeDemanda(d);
        const title = d.demanda?.trim() ? d.demanda.trim() : '(Sem t√≠tulo)';
        const statusLabel = STATUS_OPTIONS.find(o=>o.value===d.status)?.label || 'Sem status informado';
        const prazoLabel = formatPrazoLabel(d);
        const partes = [
          `${idx+1}. ID: ${d.id || ''}`.trim(),
          `Objetivo: ${title}`,
          `Status: ${statusLabel}`
        ];
        if(d.responsavel) partes.push(`Respons√°vel: ${d.responsavel}`);
        if(prazoLabel) partes.push(`Per√≠odo: ${prazoLabel}`);
        PLAN_TYPES.forEach(({key,label})=>{
          const val = (d.planos?.[key]||'').trim();
          if(val) partes.push(`${label} registrado: ${val.replace(/\s+/g,' ').trim()}`);
        });
        const existingNote = plan?.objectiveNotes?.[d.id];
        if(existingNote){
          partes.push(`Plano atual salvo: ${htmlStringToText(existingNote)}`);
        }
        return partes.join('\n');
      }).join('\n\n');
      const planSections = PLAN_TYPES.map(({key,label})=>{
        const text = plan?.[key] ? htmlStringToText(plan[key]) : '';
        return text ? `${label}: ${text}` : `${label}: (sem registro)`;
      }).join('\n');
      return [
        `Cliente Mediagrowth ‚Äì Planejamento mensal ${monthLabel} (${monthKey}).`,
        'Utilize todas as fontes dispon√≠veis na plataforma: c√≥digo da plataforma, descri√ß√£o textual, snapshot do Firebase, estados locais, guia autom√°tico das abas, demandas cadastradas e base da IA.',
        'Crie um checklist operacional de 3 a 7 passos para cada objetivo listado, garantindo foco pr√°tico em execu√ß√£o semanal.',
        'Dados dos objetivos com contexto atual:',
        demandBlocks,
        'Planos mensais j√° registrados:',
        planSections,
        'Responda apenas com JSON v√°lido no formato:',
        '{"objetivos":[{"id":"ID_DA_DEMANDA","passos":[{"tarefa":"A√ß√£o pr√°tica e objetiva","responsavel":"Nome completo ou √°rea","prazo":"Data, semana ou per√≠odo","metrica":"Indicador de sucesso mensur√°vel"}],"observacoes":"(opcional)"}],"planejamento_estrategico_mensal_markdown":"resumo executivo com foco em execu√ß√£o","plano_tatico_markdown":"(opcional)","plano_operacional_markdown":"(opcional)"}',
        'Utilize de 3 a 7 passos por objetivo, com descri√ß√µes objetivas, respons√°veis, prazos e m√©tricas em cada passo. Caso algum campo n√£o se aplique, utilize string vazia.',
        'Ao preencher cada passo, forne√ßa um objeto com os campos tarefa, responsavel, prazo e metrica. O checklist final deve ser apresentado em Markdown com checkboxes (- [ ] ...).',
        'N√£o substitua planejamentos anteriores: acrescente somente atualiza√ß√µes √∫teis, evitando repetir exatamente os mesmos passos.',
        'Conclua preenchendo o campo planejamento_estrategico_mensal_markdown com o plano estrat√©gico consolidado do m√™s. Se n√£o tiver conte√∫do para os campos t√°tico ou operacional, deixe-os como string vazia.'
      ].filter(Boolean).join('\n\n');
    }
    function extractJsonBlock(text){
      if(typeof text !== 'string') return null;
      const match = text.match(/```(?:json)?\s*([\s\S]*?)```/i);
      const candidate = match ? match[1] : text;
      const trimmed = candidate.trim();
      if(!trimmed) return null;
      try{
        return JSON.parse(trimmed);
      }catch(err){
        const first = trimmed.indexOf('{');
        const last = trimmed.lastIndexOf('}');
        if(first !== -1 && last !== -1 && last > first){
          const sliced = trimmed.slice(first, last+1);
          try{ return JSON.parse(sliced); }
          catch(_err){ return null; }
        }
        return null;
      }
    }
    function convertMarkdownToHtmlContent(markdown){
      const raw = typeof markdown === 'string' ? markdown.trim() : '';
      if(!raw) return '';
      const parsed = parseMarkdownToHtml(raw);
      if(parsed) return sanitizeMarkdownHtml(parsed);
      return sanitizeMarkdownHtml(escapeHtml(raw).replace(/\r?\n/g,'<br>'));
    }
    function formatAIUpdateTimestamp(){
      const now = new Date();
      try{
        return now.toLocaleString('pt-BR',{ day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
      }catch(_err){
        const iso = now.toISOString();
        return `${iso.slice(0,10)} ${iso.slice(11,16)}`;
      }
    }
    function appendSanitizedHtml(existingHtml, newHtml){
      const existing = typeof existingHtml === 'string' ? existingHtml.trim() : '';
      const fresh = typeof newHtml === 'string' ? newHtml.trim() : '';
      if(!fresh) return existing;
      if(!existing) return fresh;
      if(existing.includes(fresh)) return existing;
      const combined = `${existing}<hr data-ai-plan="true">${fresh}`;
      return sanitizeMarkdownHtml(combined);
    }
    function normalizePlanStep(step, index){
      if(step==null) return '';
      if(typeof step === 'string'){
        const trimmed = step.trim();
        return trimmed ? `- [ ] ${trimmed}` : '';
      }
      if(typeof step !== 'object') return '';
      const descriptionKeys=['descricao','descri√ß√£o','passo','atividade','tarefa','acao','a√ß√£o','texto','resumo','etapa','titulo','t√≠tulo','title','headline'];
      let description='';
      for(const key of descriptionKeys){
        const value = step[key];
        if(typeof value === 'string' && value.trim()){
          description = value.trim();
          break;
        }
      }
      if(!description && Array.isArray(step.descricao)){ description = step.descricao.map(v=>String(v||'').trim()).filter(Boolean).join(' '); }
      if(!description) return '';
      const responsavelKeys=['responsavel','respons√°vel','owner','responsavel_principal','responsavelGeral','accountable'];
      let responsavel='';
      for(const key of responsavelKeys){
        const value = step[key];
        if(typeof value === 'string' && value.trim()){
          responsavel = value.trim();
          break;
        }
        if(Array.isArray(value)){
          const joined = value.map(v=>String(v||'').trim()).filter(Boolean).join(', ');
          if(joined){ responsavel = joined; break; }
        }
      }
      if(!responsavel && Array.isArray(step.responsaveis)){
        responsavel = step.responsaveis.map(v=>String(v||'').trim()).filter(Boolean).join(', ');
      }
      const prazoKeys=['prazo','deadline','data','quando','entrega','periodo','per√≠odo'];
      let prazo='';
      for(const key of prazoKeys){
        const value = step[key];
        if(typeof value === 'string' && value.trim()){
          prazo = value.trim();
          break;
        }
      }
      const metricaKeys=['metrica','m√©trica','indicador','kpi','kpis','metricas','indicadores'];
      let metrica='';
      for(const key of metricaKeys){
        const value = step[key];
        if(typeof value === 'string' && value.trim()){
          metrica = value.trim();
          break;
        }
        if(Array.isArray(value)){
          const joined = value.map(v=>String(v||'').trim()).filter(Boolean).join(', ');
          if(joined){ metrica = joined; break; }
        }
      }
      const metaParts=[];
      if(responsavel) metaParts.push(`Respons√°vel: ${responsavel}`);
      if(prazo) metaParts.push(`Prazo: ${prazo}`);
      if(metrica) metaParts.push(`M√©trica: ${metrica}`);
      const info = metaParts.length ? ` ‚Äî ${metaParts.join(' ‚Ä¢ ')}` : '';
      return `- [ ] ${description}${info}`;
    }
    function buildObjectivePlanEntryMarkdown(item){
      if(!item || typeof item !== 'object') return '';
      const timestampLabel = formatAIUpdateTimestamp();
      const sections=[];
      sections.push(`#### Checklist Operacional ‚Äì ${timestampLabel}`);
      let rawSteps=item.passos;
      if(rawSteps && typeof rawSteps==='object' && !Array.isArray(rawSteps)){
        rawSteps=Object.values(rawSteps);
      }
      if(!Array.isArray(rawSteps)){ rawSteps=[]; }
      const normalizedSteps=rawSteps.slice(0,7).map((step,index)=> normalizePlanStep(step,index)).filter(Boolean);
      if(!normalizedSteps.length){
        const fallbackMarkdown = typeof item.markdown==='string'?item.markdown.trim():'';
        if(fallbackMarkdown){
          sections.push(fallbackMarkdown);
        }
      }else{
        sections.push(normalizedSteps.join('\n'));
      }
      const observacaoKeys=['observacoes','observa√ß√£o','observacao','comentarios','coment√°rio','comentario','resumo'];
      for(const key of observacaoKeys){
        const value=item[key];
        if(typeof value==='string' && value.trim()){
          sections.push(`**Observa√ß√µes:** ${value.trim()}`);
          break;
        }
      }
      const metricExtras=item.metricas_chave||item.metricasExtras||item.metricas_adicionais||item.metricasComplementares;
      if(Array.isArray(metricExtras)){
        const lines=metricExtras.map(v=>String(v||'').trim()).filter(Boolean);
        if(lines.length){
          sections.push(`**M√©tricas complementares:**\n${lines.map(line=>`- ${line}`).join('\n')}`);
        }
      }else if(typeof metricExtras==='string' && metricExtras.trim()){
        sections.push(`**M√©tricas complementares:** ${metricExtras.trim()}`);
      }
      const filtered=sections.filter(Boolean);
      if(filtered.length<=1) return '';
      return filtered.join('\n\n');
    }
    function applyObjectivePlanAIResult({ result, monthKey, monthDemands }){
      if(!result || typeof result !== 'object') return false;
      const monthPlan = normalizeMonthPlan(monthKey);
      if(!monthPlan) return false;
      if(!monthPlan.objectiveNotes || typeof monthPlan.objectiveNotes !== 'object'){
        monthPlan.objectiveNotes = {};
      }
      const demandList = Array.isArray(monthDemands) ? monthDemands : [];
      const demandById = new Map();
      demandList.forEach(d=>{ if(d?.id) demandById.set(String(d.id), d); });
      let changed = false;
      if(Array.isArray(result.objetivos)){
        result.objetivos.forEach(item=>{
          if(!item || typeof item !== 'object') return;
          let demand = null;
          const id = item.id ? String(item.id).trim() : '';
          if(id && demandById.has(id)){
            demand = demandById.get(id);
          }else if(item.objetivo){
            const targetTitle = String(item.objetivo).trim().toLowerCase();
            if(targetTitle){
              demand = demandList.find(d=> (d?.demanda||'').trim().toLowerCase() === targetTitle);
            }
          }
          if(!demand || !demand.id) return;
          let markdown = buildObjectivePlanEntryMarkdown(item);
          if(!markdown){
            if(typeof item.markdown === 'string' && item.markdown.trim()){
              const timestampLabel = formatAIUpdateTimestamp();
              markdown = [`#### Checklist Operacional ‚Äì ${timestampLabel}`, item.markdown.trim()].join('\n\n');
            }else if(Array.isArray(item.passos)){
              const normalizedFallback=item.passos.slice(0,7).map((step,index)=> normalizePlanStep(step,index)).filter(Boolean);
              if(normalizedFallback.length){
                const timestampLabel = formatAIUpdateTimestamp();
                markdown = [`#### Checklist Operacional ‚Äì ${timestampLabel}`, normalizedFallback.join('\n')].join('\n\n');
              }else{
                markdown = item.passos.map(step=>`- [ ] ${String(step||'').trim()}`).join('\n');
              }
            }else if(typeof item.plano === 'string' && item.plano.trim()){
              const timestampLabel = formatAIUpdateTimestamp();
              markdown = [`#### Checklist Operacional ‚Äì ${timestampLabel}`, item.plano.trim()].join('\n\n');
            }
          }
          const html = convertMarkdownToHtmlContent(markdown);
          if(!html) return;
          const existingHtml = typeof monthPlan.objectiveNotes[demand.id] === 'string' ? monthPlan.objectiveNotes[demand.id] : '';
          const combinedHtml = appendSanitizedHtml(existingHtml, html);
          const finalHtml = combinedHtml || html;
          if(finalHtml && finalHtml !== existingHtml){
            monthPlan.objectiveNotes[demand.id] = finalHtml;
            changed = true;
          }
        });
      }
      const planKeyMap = {
        estrategico: ['plano_estrategico_markdown','plano_estrategico','planejamento_estrategico_markdown','planejamento_estrategico_mensal_markdown'],
        tatico: ['plano_tatico_markdown','plano_tatico'],
        operacional: ['plano_operacional_markdown','plano_operacional']
      };
      Object.entries(planKeyMap).forEach(([planKey, keys])=>{
        keys.forEach(name=>{
          const value = result && typeof result === 'object' ? result[name] : '';
          if(typeof value === 'string' && value.trim()){
            const markdownValue = value.trim();
            const timestampLabel = formatAIUpdateTimestamp();
            const wrappedMarkdown = `### Planejamento Estrat√©gico ‚Äì ${timestampLabel}\n\n${markdownValue}`;
            const html = convertMarkdownToHtmlContent(wrappedMarkdown);
            if(!html) return;
            const existingHtml = typeof monthPlan[planKey] === 'string' ? monthPlan[planKey] : '';
            const combinedHtml = appendSanitizedHtml(existingHtml, html);
            const finalHtml = combinedHtml || html;
            if(finalHtml && finalHtml !== existingHtml){
              monthPlan[planKey] = finalHtml;
              changed = true;
            }
          }
        });
      });
      return changed;
    }
    async function generateObjectivePlansWithAI(button){
      if(button){ button.disabled = true; }
      const originalText = button?.textContent;
      if(button){ button.textContent = 'Gerando...'; }
      try{
        if(!auth?.currentUser){
          throw new Error('Fa√ßa login para gerar o planejamento automaticamente.');
        }
        // üîí Verificar se o proxy de IA est√° dispon√≠vel (API key agora est√° no backend)
        if(typeof window.callAIProxy !== 'function'){
          throw new Error('Servi√ßo de IA n√£o dispon√≠vel. Recarregue a p√°gina.');
        }
        const monthKey = typeof selectedDemandaMonth === 'string' ? selectedDemandaMonth : '';
        if(!monthKey){
          throw new Error('Selecione um m√™s v√°lido na planilha de planejamento.');
        }
        const monthDate = new Date(`${monthKey}-01T00:00:00`);
        if(Number.isNaN(monthDate.getTime())){
          throw new Error('N√£o foi poss√≠vel interpretar o m√™s selecionado.');
        }
        const monthLabelRaw = monthDate.toLocaleDateString('pt-BR',{ month:'long', year:'numeric' });
        const monthLabel = monthLabelRaw.charAt(0).toUpperCase()+monthLabelRaw.slice(1);
        const monthPlan = normalizeMonthPlan(monthKey);
        const monthDemands = (Array.isArray(DEMANDAS)?DEMANDAS:[]).filter(d=>{
          const keys = getDemandMonthKeys(d);
          return keys.includes(monthKey);
        });
        if(!monthDemands.length){
          throw new Error('Cadastre objetivos com per√≠odo neste m√™s para gerar o planejamento.');
        }
        const prompt = buildObjectivePlanIAPrompt({ monthLabel, monthKey, monthDemands, monthPlan });
        if(!prompt.trim()){
          throw new Error('N√£o foi poss√≠vel preparar a solicita√ß√£o autom√°tica.');
        }
        // üîí Usando proxy seguro (API key no backend)
        const messagesObjective = [
          { role: 'system', content: 'Voc√™ √© o planejador de marketing da Mediagrowth. Respeite fielmente o formato JSON solicitado.' },
          { role: 'user', content: prompt }
        ];
        
        const data = await window.callAIProxy('gpt-4o-mini', messagesObjective, auth.currentUser?.uid);
        
        if(!data || data.error){
          throw new Error(data?.error || 'Erro na resposta da API');
        }
        const content = data?.choices?.[0]?.message?.content || '';
        const parsed = extractJsonBlock(content);
        if(!parsed){
          throw new Error('A resposta gerada n√£o p√¥de ser interpretada.');
        }
        const updated = applyObjectivePlanAIResult({ result: parsed, monthKey, monthDemands });
        if(!updated){
          throw new Error('A resposta gerada n√£o trouxe dados utiliz√°veis.');
        }
        scheduleDemandasPersist();
        renderDemandas({ force:true });
        if(typeof mgToast === 'function'){
          mgToast('Planejamento mensal atualizado.');
        }
      }catch(err){
        console.error('generateObjectivePlansWithAI', err);
        alert(err?.message || String(err));
      }finally{
        if(button){
          button.disabled = false;
          if(typeof originalText === 'string'){ button.textContent = originalText; }
        }
      }
    }
    function renderDemandaPlans(){
      // DEPRECATED: Fun√ß√£o obsoleta ap√≥s refatora√ß√£o para modal minimalista
      // A se√ß√£o .demanda-plans foi removida, planos agora s√£o editados via modal
      const container=$('demandaPlans');
      if(!container) return; // Container n√£o existe mais, retorna silenciosamente
      // C√≥digo original comentado para evitar processamento desnecess√°rio
    }

    const DEMANDAS_TYPING_GRACE_MS = 1200;
    const DEMANDAS_MAX_BLOCK_MS = 8000;
    let demandasRenderTimer = null;
    let performDemandasRenderRequested = false;
    let lastDemandaInputTs = 0;
    let lastDemandaFocusTs = 0;
    let lastDemandaFocusTarget = null;

    // Fun√ß√£o para registrar foco em campos de demanda (usada no visibilitychange)
    function noteDemandaFocus(target) {
      if (target) {
        lastDemandaFocusTarget = target;
        lastDemandaFocusTs = Date.now();
      } else {
        lastDemandaFocusTarget = null;
      }
    }

    function isDemandasEditing(){
      const active = document.activeElement;
      if(!active || !active.closest || !active.closest('#demandasBody')) return false;
      const isTextField = !!(active.matches && active.matches('input[type="text"], input[type="search"], textarea'));
      const isEditable = !!active.isContentEditable;
      if(!isTextField && !isEditable) return false;
      const now = Date.now();
      if(active === lastDemandaFocusTarget){
        if(now - lastDemandaInputTs <= DEMANDAS_TYPING_GRACE_MS) return true;
        if(now - lastDemandaFocusTs <= DEMANDAS_MAX_BLOCK_MS) return true;
      }
      if(isEditable || isTextField){
        return now - lastDemandaInputTs <= DEMANDAS_TYPING_GRACE_MS;
      }
      return false;
    }

    function requestRenderDemandas({ immediate=false, force=false }={}){
      if(demandasRenderTimer){
        clearTimeout(demandasRenderTimer);
        demandasRenderTimer = null;
      }
      if(immediate){
        performDemandasRender();
      }else{
        performDemandasRenderRequested = true;
        demandasRenderTimer = setTimeout(()=>{
          demandasRenderTimer = null;
          if(performDemandasRenderRequested){
            performDemandasRenderRequested = false;
            performDemandasRender();
          }
        }, 300);
      }
    }

    function performDemandasRender(){
      const tbody=$('demandasBody');
      if(!tbody) return;
      renderDemandaMonthButtons();
      const search=($('demandaSearch').value||'').toLowerCase();
      const statusFilterEl=$('demandaStatusColumnFilter');
      const objetivoFilterEl=$('demandaObjetivoFilter');
      const responsavelFilterEl=$('demandaResponsavelFilter');
      const periodoInicioEl=$('demandaPeriodoInicioFilter');
      const periodoFimEl=$('demandaPeriodoFimFilter');
      const fStatus=statusFilterEl?statusFilterEl.value||'':'';
      const fObjetivo=objetivoFilterEl?(objetivoFilterEl.value||'').toLowerCase().trim():'';
      const fResponsavel=responsavelFilterEl?responsavelFilterEl.value||'':'';
      const fPeriodoInicio=periodoInicioEl?parseFilterDate(periodoInicioEl.value,false):null;
      const fPeriodoFim=periodoFimEl?parseFilterDate(periodoFimEl.value,true):null;
      const fMonth=selectedDemandaMonth;
      tbody.innerHTML='';
      const source=Array.isArray(DEMANDAS)?DEMANDAS:[];
      const filtered=source.filter(d=>{
        const sMatch=!search||(d.demanda||'').toLowerCase().includes(search);
        const stMatch=!fStatus||d.status===fStatus;
        const objetivoMatch=!fObjetivo||(d.demanda||'').toLowerCase().includes(fObjetivo);
        const respMatch=!fResponsavel||(d.responsavel||'')===fResponsavel;
        const demandMonths=getDemandMonthKeys(d);
        const mMatch=!fMonth || !demandMonths.length || demandMonths.includes(fMonth);
        let periodoMatch=true;
        if(fPeriodoInicio||fPeriodoFim){
          const rangeStart=getDemandaStartDate(d)||getDemandaEndDate(d);
          const rangeEnd=getDemandaEndDate(d)||rangeStart;
          if(!rangeStart||!rangeEnd){
            periodoMatch=false;
          }else{
            if(fPeriodoInicio&&rangeEnd.getTime()<fPeriodoInicio.getTime()) periodoMatch=false;
            if(fPeriodoFim&&rangeStart.getTime()>fPeriodoFim.getTime()) periodoMatch=false;
          }
        }
        return sMatch&&stMatch&&objetivoMatch&&respMatch&&mMatch&&periodoMatch;
      });
      const sorted=filtered.slice().sort((a,b)=>{
        const aMeta=getDemandaSortMeta(a);
        const bMeta=getDemandaSortMeta(b);
        if(aMeta.startMs!==bMeta.startMs) return aMeta.startMs-bMeta.startMs;
        if(aMeta.endMs!==bMeta.endMs) return aMeta.endMs-bMeta.endMs;
        return (a.demanda||'').localeCompare(b.demanda||'', 'pt-BR');
      });
      sorted.forEach(d=>{
        normalizeDemanda(d);
        tbody.appendChild(createDemandaRow(d));
      });
      updatePrazoAlert();
      renderDemandaPlans();
      if(typeof renderCalendarDays === 'function'){
        try{ renderCalendarDays(); }catch(_err){}
      }
      // Atualizar resumo para WhatsApp
      if(typeof updateDemandasSummary === 'function'){
        try{ updateDemandasSummary(); }catch(_err){}
      }
      // Atualizar dropdown de usu√°rios
      if(typeof updateDemandasUserDropdown === 'function'){
        try{ updateDemandasUserDropdown(); }catch(_err){}
      }
    }

    function renderDemandas(eventOrOptions){
      const options = (eventOrOptions instanceof Event || eventOrOptions === undefined) ? {} : eventOrOptions || {};
      if(options.force){
        performDemandasRender();
        return;
      }
      if(isDemandasEditing()){
        requestRenderDemandas({ immediate:true });
        return;
      }
      performDemandasRender();
    }
    
    function createDemandaRow(d){ normalizeDemanda(d); const tr=document.createElement('tr'); tr.dataset.id=d.id; tr.innerHTML=`
        <td class="col-checkbox" data-label="Selecionar"><input type="checkbox" class="demanda-select-checkbox" data-id="${d.id}"></td>
        <td class="col-status" data-label="Status"><select><option value=""></option>${STATUS_OPTIONS.map(o=>`<option value="${o.value}" ${d.status===o.value?"selected":""}>${o.label}</option>`).join('')}</select></td>
        <td class="col-demanda" data-label="Demanda"><input type="text" value="${d.demanda||''}"></td>
        <td class="col-resp" data-label="Respons√°vel"><select><option value=""></option>${RESP_OPTIONS.map(r=>`<option value="${r}" ${d.responsavel===r?"selected":""}>${r}</option>`).join('')}</select></td>
        <td class="col-prazo" data-label="Per√≠odo">
          <div class="periodo-field${d.prazoFim?' range-active':''}">
            <input type="datetime-local" class="periodo-inicio" value="${d.prazo||''}">
            <span class="periodo-sep">at√©</span>
            <input type="datetime-local" class="periodo-fim" value="${d.prazoFim||''}">
            <button type="button" class="periodo-toggle">${d.prazoFim?'Remover intervalo':'Adicionar intervalo'}</button>
          </div>
        </td>
        <td class="col-plano" data-label="Plano"><button class="plan-btn${d.plano?' has-plan':''}" data-id="${d.id}">üìù Ver Plano</button></td>
        <td class="del-cell" data-label="Remover"><button>‚úï</button></td>`;
      const checkboxEl=tr.children[0].querySelector('input[type="checkbox"]');
      const statusSel=tr.children[1].querySelector('select');
      const demandaInput=tr.children[2].querySelector('input');
      const respSel=tr.children[3].querySelector('select');
      const periodoWrap=tr.children[4].querySelector('.periodo-field');
      const planBtn=tr.children[5].querySelector('.plan-btn');
      const inicioInput=periodoWrap.querySelector('.periodo-inicio');
      const fimInput=periodoWrap.querySelector('.periodo-fim');
      const toggleBtn=periodoWrap.querySelector('.periodo-toggle');
      const sepEl=periodoWrap.querySelector('.periodo-sep');
      let rangeEnabled=periodoWrap.classList.contains('range-active');
      const rangeActive=()=>rangeEnabled;
      const syncRangeUI=()=>{
        periodoWrap.classList.toggle('range-active',rangeEnabled);
        toggleBtn.textContent=rangeEnabled?'Remover intervalo':'Adicionar intervalo';
        fimInput.style.display=rangeEnabled?'':'none';
        sepEl.style.display=rangeEnabled?'':'none';
      };
      syncRangeUI();
      function update(field,val){
        d[field]=val;
        if(field==='prazoFim' && val && !rangeEnabled){
          rangeEnabled=true;
        }
        if(field==='prazoFim'){
          syncRangeUI();
        }
        markDemandaEdited(d,tr);
        try{ refreshMacroInsights(); }catch(_){ }
        scheduleDemandasPersist();
        updatePrazoAlert();
        renderDemandaPlans();
        renderDemandaMonthButtons();
        
        // Reaplicar destaque de atraso quando prazo ou status mudar
        if(['prazo', 'prazoFim', 'status'].includes(field)){
          applyStatusColor(tr, d.status, d);
        }
        
        if(['demanda','responsavel','prazo','prazoFim','status'].includes(field)){
          if(typeof renderCalendarDays === 'function'){
            try{ renderCalendarDays(); }catch(_err){}
          }
        }
      }
      statusSel.onchange=()=>{
        update('status',statusSel.value); applyStatusColor(tr, d.status, d);
        sendWebhook('demandas', { demandas: [d] });
      };
      demandaInput.addEventListener('input', ()=>{ update('demanda',demandaInput.value); });
      demandaInput.addEventListener('blur', ()=>{ flushDemandasPersist(); });
      respSel.onchange=()=>update('responsavel',respSel.value);
      inicioInput.onchange=()=>{
        update('prazo',inicioInput.value);
      };
      fimInput.onchange=()=>{
        update('prazoFim',fimInput.value);
      };
      toggleBtn.onclick=()=>{
        if(rangeActive()){
          fimInput.value='';
          update('prazoFim','');
          rangeEnabled=false;
        }else{
          rangeEnabled=true;
          update('prazoFim',fimInput.value);
        }
        syncRangeUI();
      };
      planBtn.onclick=()=>{ openDemandaPlanModal(d); };
      tr.querySelector('.del-cell button').onclick=()=>{ if(confirm('Remover linha?')){ DEMANDAS=DEMANDAS.filter(x=>x.id!==d.id); scheduleDemandasPersist({ immediate:true }); renderDemandas(); } };
      applyStatusColor(tr, d.status, d);
      return tr; }

    document.addEventListener('focusin',event=>{
      const target=event?.target;
      if(target && typeof target.closest==='function' && target.closest('#demandasBody')){
        noteDemandaFocus(target);
      }
    },true);
    document.addEventListener('focusout',event=>{
      const target=event?.target;
      if(!target || typeof target.closest!=='function') return;
      if(!target.closest('#demandasBody')) return;
      const related=event.relatedTarget;
      if(related && typeof related.closest==='function' && related.closest('#demandasBody')){
        return;
      }
      noteDemandaFocus(null);
      if(demandasRenderPending){
        requestRenderDemandas({ immediate:true, force:true });
      }
    },true);
    document.addEventListener('input',event=>{
      const target=event?.target;
      if(target && typeof target.closest==='function' && target.closest('#demandasBody')){
        noteDemandaActivity(target);
      }
    },true);
    document.addEventListener('keydown',event=>{
      const target=event?.target;
      if(target && typeof target.closest==='function' && target.closest('#demandasBody')){
        noteDemandaActivity(target);
        if(event.key==='Enter' && !event.shiftKey){
          const isTextInput = typeof target.matches==='function' && target.matches('input[type="text"], input[type="search"], textarea');
          const isEditable = !!target.isContentEditable;
          if(isTextInput && !isEditable){
            scheduleDemandasPersist({ immediate:true });
          }
        }
      }
    },true);
    document.addEventListener('visibilitychange',()=>{
      if(document.visibilityState==='hidden'){
        noteDemandaFocus(null);
        flushDemandasPersist();
        // flushImpedimentsPersist(); // TODO: Fun√ß√£o n√£o implementada
      }
    });

    const demandaSearchEl=$('demandaSearch');
    if(demandaSearchEl){ demandaSearchEl.addEventListener('input', renderDemandas); }
    const demandaStatusColumnEl=$('demandaStatusColumnFilter');
    if(demandaStatusColumnEl){ demandaStatusColumnEl.addEventListener('change', renderDemandas); }
    const demandaObjetivoFilterEl=$('demandaObjetivoFilter');
    if(demandaObjetivoFilterEl){ demandaObjetivoFilterEl.addEventListener('input', renderDemandas); }
    const demandaResponsavelFilterEl=$('demandaResponsavelFilter');
    if(demandaResponsavelFilterEl){ demandaResponsavelFilterEl.addEventListener('change', renderDemandas); }
    const demandaPeriodoInicioFilterEl=$('demandaPeriodoInicioFilter');
    if(demandaPeriodoInicioFilterEl){ demandaPeriodoInicioFilterEl.addEventListener('change', renderDemandas); }
    const demandaPeriodoFimFilterEl=$('demandaPeriodoFimFilter');
    if(demandaPeriodoFimFilterEl){ demandaPeriodoFimFilterEl.addEventListener('change', renderDemandas); }
    const demandaFilterClearBtn=$('demandaFilterClear');
    if(demandaFilterClearBtn){
      demandaFilterClearBtn.addEventListener('click', ()=>{
        if(demandaStatusColumnEl) demandaStatusColumnEl.value='';
        if(demandaTagColumnEl) demandaTagColumnEl.value='';
        if(demandaObjetivoFilterEl) demandaObjetivoFilterEl.value='';
        if(demandaResponsavelFilterEl) demandaResponsavelFilterEl.value='';
        if(demandaPeriodoInicioFilterEl) demandaPeriodoInicioFilterEl.value='';
        if(demandaPeriodoFimFilterEl) demandaPeriodoFimFilterEl.value='';
        renderDemandas();
      });
    }
    const demandaObjectiveAIButton=$('demandaObjectiveAIButton');
    if(demandaObjectiveAIButton){
      demandaObjectiveAIButton.addEventListener('click', ()=>{ generateObjectivePlansWithAI(demandaObjectiveAIButton); });
    }
    const addDemandaBtn=$('addDemanda');
    if(addDemandaBtn){
      addDemandaBtn.addEventListener('click', ()=>{ DEMANDAS.push(createDemanda()); scheduleDemandasPersist({ immediate:true }); renderDemandas(); });
    }
    
    /* ========= SELE√á√ÉO M√öLTIPLA E EDI√á√ÉO EM MASSA ========= */
    const demandaSelectAllEl = $('demandaSelectAll');
    const demandaBulkActionsEl = $('demandaBulkActions');
    const bulkSelectedCountEl = $('bulkSelectedCount');
    const btnBulkEditDateEl = $('btnBulkEditDate');
    const btnBulkClearSelectionEl = $('btnBulkClearSelection');
    const bulkEditModalEl = $('bulkEditModal');
    const bulkEditDateTypeEl = $('bulkEditDateType');
    const bulkEditInicioEl = $('bulkEditInicio');
    const bulkEditFimEl = $('bulkEditFim');
    const bulkEditInicioGroupEl = $('bulkEditInicioGroup');
    const bulkEditFimGroupEl = $('bulkEditFimGroup');
    const btnBulkEditCancelEl = $('btnBulkEditCancel');
    const btnBulkEditSaveEl = $('btnBulkEditSave');
    
    let selectedDemandas = new Set();
    
    // Fun√ß√£o para atualizar contador e visibilidade da barra de a√ß√µes
    function updateBulkActionsUI(){
      const count = selectedDemandas.size;
      if(bulkSelectedCountEl) bulkSelectedCountEl.textContent = count;
      if(demandaBulkActionsEl){
        if(count > 0){
          demandaBulkActionsEl.classList.add('active');
        } else {
          demandaBulkActionsEl.classList.remove('active');
        }
      }
      
      // Atualizar estado do checkbox "selecionar todas"
      if(demandaSelectAllEl){
        const visibleCheckboxes = document.querySelectorAll('.demanda-select-checkbox');
        const checkedCount = Array.from(visibleCheckboxes).filter(cb => cb.checked).length;
        demandaSelectAllEl.checked = visibleCheckboxes.length > 0 && checkedCount === visibleCheckboxes.length;
        demandaSelectAllEl.indeterminate = checkedCount > 0 && checkedCount < visibleCheckboxes.length;
      }
    }
    
    // Selecionar/Desselecionar todas
    if(demandaSelectAllEl){
      demandaSelectAllEl.addEventListener('change', (e) => {
        const checked = e.target.checked;
        const checkboxes = document.querySelectorAll('.demanda-select-checkbox');
        checkboxes.forEach(cb => {
          cb.checked = checked;
          const demandaId = cb.dataset.id;
          if(checked){
            selectedDemandas.add(demandaId);
          } else {
            selectedDemandas.delete(demandaId);
          }
        });
        updateBulkActionsUI();
      });
    }
    
    // Delega√ß√£o de eventos para checkboxes de linha
    document.addEventListener('change', (e) => {
      if(e.target && e.target.classList.contains('demanda-select-checkbox')){
        const demandaId = e.target.dataset.id;
        if(e.target.checked){
          selectedDemandas.add(demandaId);
        } else {
          selectedDemandas.delete(demandaId);
        }
        updateBulkActionsUI();
      }
    });
    
    // Bot√£o para desselecionar todas
    if(btnBulkClearSelectionEl){
      btnBulkClearSelectionEl.addEventListener('click', () => {
        selectedDemandas.clear();
        document.querySelectorAll('.demanda-select-checkbox').forEach(cb => cb.checked = false);
        if(demandaSelectAllEl) demandaSelectAllEl.checked = false;
        updateBulkActionsUI();
      });
    }
    
    // Bot√£o para abrir modal de edi√ß√£o de data
    if(btnBulkEditDateEl){
      btnBulkEditDateEl.addEventListener('click', () => {
        if(selectedDemandas.size === 0){
          showToast('Selecione pelo menos uma demanda para editar', 'warning');
          return;
        }
        
        // Resetar campos
        if(bulkEditDateTypeEl) bulkEditDateTypeEl.value = 'inicio';
        if(bulkEditInicioEl) bulkEditInicioEl.value = '';
        if(bulkEditFimEl) bulkEditFimEl.value = '';
        if(bulkEditInicioGroupEl) bulkEditInicioGroupEl.style.display = 'block';
        if(bulkEditFimGroupEl) bulkEditFimGroupEl.style.display = 'none';
        
        // Abrir modal
        if(bulkEditModalEl) bulkEditModalEl.classList.add('active');
      });
    }
    
    // Controlar visibilidade dos campos de data baseado no tipo selecionado
    if(bulkEditDateTypeEl){
      bulkEditDateTypeEl.addEventListener('change', (e) => {
        const tipo = e.target.value;
        if(bulkEditInicioGroupEl && bulkEditFimGroupEl){
          if(tipo === 'inicio'){
            bulkEditInicioGroupEl.style.display = 'block';
            bulkEditFimGroupEl.style.display = 'none';
          } else if(tipo === 'fim'){
            bulkEditInicioGroupEl.style.display = 'none';
            bulkEditFimGroupEl.style.display = 'block';
          } else if(tipo === 'ambas'){
            bulkEditInicioGroupEl.style.display = 'block';
            bulkEditFimGroupEl.style.display = 'block';
          }
        }
      });
    }
    
    // Cancelar edi√ß√£o
    if(btnBulkEditCancelEl){
      btnBulkEditCancelEl.addEventListener('click', () => {
        if(bulkEditModalEl) bulkEditModalEl.classList.remove('active');
      });
    }
    
    // Salvar edi√ß√£o em massa
    if(btnBulkEditSaveEl){
      btnBulkEditSaveEl.addEventListener('click', () => {
        const tipo = bulkEditDateTypeEl ? bulkEditDateTypeEl.value : 'inicio';
        const dataInicio = bulkEditInicioEl ? bulkEditInicioEl.value : '';
        const dataFim = bulkEditFimEl ? bulkEditFimEl.value : '';
        
        // Validar campos
        if(tipo === 'inicio' && !dataInicio){
          showToast('Informe a data de in√≠cio', 'warning');
          return;
        }
        if(tipo === 'fim' && !dataFim){
          showToast('Informe a data de fim', 'warning');
          return;
        }
        if(tipo === 'ambas' && (!dataInicio || !dataFim)){
          showToast('Informe ambas as datas (in√≠cio e fim)', 'warning');
          return;
        }
        
        // Aplicar altera√ß√µes
        let updatedCount = 0;
        selectedDemandas.forEach(demandaId => {
          const demanda = DEMANDAS.find(d => d.id === demandaId);
          if(demanda){
            if(tipo === 'inicio' || tipo === 'ambas'){
              demanda.prazo = dataInicio;
            }
            if(tipo === 'fim' || tipo === 'ambas'){
              demanda.prazoFim = dataFim;
            }
            updatedCount++;
          }
        });
        
        // Salvar e renderizar
        if(updatedCount > 0){
          scheduleDemandasPersist({ immediate: true });
          renderDemandas({ force: true });
          showToast(`${updatedCount} demanda(s) atualizada(s) com sucesso!`, 'success');
          
          // Limpar sele√ß√£o
          selectedDemandas.clear();
          document.querySelectorAll('.demanda-select-checkbox').forEach(cb => cb.checked = false);
          if(demandaSelectAllEl) demandaSelectAllEl.checked = false;
          updateBulkActionsUI();
        }
        
        // Fechar modal
        if(bulkEditModalEl) bulkEditModalEl.classList.remove('active');
      });
    }
    
    // Fechar modal clicando fora
    if(bulkEditModalEl){
      bulkEditModalEl.addEventListener('click', (e) => {
        if(e.target === bulkEditModalEl){
          bulkEditModalEl.classList.remove('active');
        }
      });
    }
    
    /* ========= EDI√á√ÉO EM MASSA - STATUS ========= */
    const btnBulkEditStatusEl = $('btnBulkEditStatus');
    const bulkEditStatusModalEl = $('bulkEditStatusModal');
    const bulkEditStatusEl = $('bulkEditStatus');
    const btnBulkEditStatusCancelEl = $('btnBulkEditStatusCancel');
    const btnBulkEditStatusSaveEl = $('btnBulkEditStatusSave');
    
    // Abrir modal de status
    if(btnBulkEditStatusEl){
      btnBulkEditStatusEl.addEventListener('click', () => {
        if(selectedDemandas.size === 0){
          showToast('Selecione pelo menos uma demanda para editar', 'warning');
          return;
        }
        
        // Resetar campo
        if(bulkEditStatusEl) bulkEditStatusEl.value = '';
        
        // Abrir modal
        if(bulkEditStatusModalEl) bulkEditStatusModalEl.classList.add('active');
      });
    }
    
    // Cancelar edi√ß√£o de status
    if(btnBulkEditStatusCancelEl){
      btnBulkEditStatusCancelEl.addEventListener('click', () => {
        if(bulkEditStatusModalEl) bulkEditStatusModalEl.classList.remove('active');
      });
    }
    
    // Salvar status em massa
    if(btnBulkEditStatusSaveEl){
      btnBulkEditStatusSaveEl.addEventListener('click', () => {
        const novoStatus = bulkEditStatusEl ? bulkEditStatusEl.value : '';
        
        // Validar campo
        if(!novoStatus){
          showToast('Selecione um status', 'warning');
          return;
        }
        
        // Aplicar altera√ß√µes
        let updatedCount = 0;
        selectedDemandas.forEach(demandaId => {
          const demanda = DEMANDAS.find(d => d.id === demandaId);
          if(demanda){
            demanda.status = novoStatus;
            updatedCount++;
          }
        });
        
        // Salvar e renderizar
        if(updatedCount > 0){
          scheduleDemandasPersist({ immediate: true });
          renderDemandas({ force: true });
          showToast(`Status alterado em ${updatedCount} demanda(s)!`, 'success');
          
          // Limpar sele√ß√£o
          selectedDemandas.clear();
          document.querySelectorAll('.demanda-select-checkbox').forEach(cb => cb.checked = false);
          if(demandaSelectAllEl) demandaSelectAllEl.checked = false;
          updateBulkActionsUI();
        }
        
        // Fechar modal
        if(bulkEditStatusModalEl) bulkEditStatusModalEl.classList.remove('active');
      });
    }
    
    // Fechar modal de status clicando fora
    if(bulkEditStatusModalEl){
      bulkEditStatusModalEl.addEventListener('click', (e) => {
        if(e.target === bulkEditStatusModalEl){
          bulkEditStatusModalEl.classList.remove('active');
        }
      });
    }
    
    /* ========= EDI√á√ÉO EM MASSA - RESPONS√ÅVEL ========= */
    const btnBulkEditResponsavelEl = $('btnBulkEditResponsavel');
    const bulkEditResponsavelModalEl = $('bulkEditResponsavelModal');
    const bulkEditResponsavelEl = $('bulkEditResponsavel');
    const btnBulkEditResponsavelCancelEl = $('btnBulkEditResponsavelCancel');
    const btnBulkEditResponsavelSaveEl = $('btnBulkEditResponsavelSave');
    
    // Abrir modal de respons√°vel
    if(btnBulkEditResponsavelEl){
      btnBulkEditResponsavelEl.addEventListener('click', () => {
        if(selectedDemandas.size === 0){
          showToast('Selecione pelo menos uma demanda para editar', 'warning');
          return;
        }
        
        // Resetar campo
        if(bulkEditResponsavelEl) bulkEditResponsavelEl.value = '';
        
        // Abrir modal
        if(bulkEditResponsavelModalEl) bulkEditResponsavelModalEl.classList.add('active');
      });
    }
    
    // Cancelar edi√ß√£o de respons√°vel
    if(btnBulkEditResponsavelCancelEl){
      btnBulkEditResponsavelCancelEl.addEventListener('click', () => {
        if(bulkEditResponsavelModalEl) bulkEditResponsavelModalEl.classList.remove('active');
      });
    }
    
    // Salvar respons√°vel em massa
    if(btnBulkEditResponsavelSaveEl){
      btnBulkEditResponsavelSaveEl.addEventListener('click', () => {
        const novoResponsavel = bulkEditResponsavelEl ? bulkEditResponsavelEl.value : '';
        
        // Validar campo
        if(!novoResponsavel){
          showToast('Selecione um respons√°vel', 'warning');
          return;
        }
        
        // Aplicar altera√ß√µes
        let updatedCount = 0;
        selectedDemandas.forEach(demandaId => {
          const demanda = DEMANDAS.find(d => d.id === demandaId);
          if(demanda){
            demanda.responsavel = novoResponsavel;
            updatedCount++;
          }
        });
        
        // Salvar e renderizar
        if(updatedCount > 0){
          scheduleDemandasPersist({ immediate: true });
          renderDemandas({ force: true });
          showToast(`Respons√°vel alterado em ${updatedCount} demanda(s)!`, 'success');
          
          // Limpar sele√ß√£o
          selectedDemandas.clear();
          document.querySelectorAll('.demanda-select-checkbox').forEach(cb => cb.checked = false);
          if(demandaSelectAllEl) demandaSelectAllEl.checked = false;
          updateBulkActionsUI();
        }
        
        // Fechar modal
        if(bulkEditResponsavelModalEl) bulkEditResponsavelModalEl.classList.remove('active');
      });
    }
    
    // Fechar modal de respons√°vel clicando fora
    if(bulkEditResponsavelModalEl){
      bulkEditResponsavelModalEl.addEventListener('click', (e) => {
        if(e.target === bulkEditResponsavelModalEl){
          bulkEditResponsavelModalEl.classList.remove('active');
        }
      });
    }
    
    /* ========= PLANO DA DEMANDA - MODAL ========= */
    const demandaPlanModalEl = $('demandaPlanModal');
    const demandaPlanTitleEl = $('demandaPlanTitle');
    const demandaPlanTextEl = $('demandaPlanText');
    const btnCloseDemandaPlanEl = $('btnCloseDemandaPlan');
    const btnCancelDemandaPlanEl = $('btnCancelDemandaPlan');
    const btnSaveDemandaPlanEl = $('btnSaveDemandaPlan');
    
    let currentPlanDemanda = null;
    
    // Fun√ß√£o para abrir modal de plano
    function openDemandaPlanModal(demanda){
      if(!demandaPlanModalEl) return;
      
      currentPlanDemanda = demanda;
      
      // Preencher campos
      if(demandaPlanTitleEl) demandaPlanTitleEl.value = demanda.demanda || '';
      if(demandaPlanTextEl) demandaPlanTextEl.value = demanda.plano || '';
      
      // Abrir modal
      demandaPlanModalEl.classList.add('active');
      
      // Focar no textarea
      if(demandaPlanTextEl) demandaPlanTextEl.focus();
    }
    
    // Fun√ß√£o para fechar modal
    function closeDemandaPlanModal(){
      if(demandaPlanModalEl) demandaPlanModalEl.classList.remove('active');
      currentPlanDemanda = null;
    }
    
    // Bot√£o fechar (X)
    if(btnCloseDemandaPlanEl){
      btnCloseDemandaPlanEl.addEventListener('click', closeDemandaPlanModal);
    }
    
    // Bot√£o cancelar
    if(btnCancelDemandaPlanEl){
      btnCancelDemandaPlanEl.addEventListener('click', closeDemandaPlanModal);
    }
    
    // Bot√£o salvar plano
    if(btnSaveDemandaPlanEl){
      btnSaveDemandaPlanEl.addEventListener('click', () => {
        if(!currentPlanDemanda) return;
        
        const planoTexto = demandaPlanTextEl ? demandaPlanTextEl.value.trim() : '';
        
        // Atualizar demanda
        currentPlanDemanda.plano = planoTexto;
        
        // Salvar e renderizar
        scheduleDemandasPersist({ immediate: true });
        renderDemandas({ force: true });
        
        // Mensagem de sucesso
        const msg = planoTexto ? 'Plano salvo com sucesso!' : 'Plano removido com sucesso!';
        showToast(msg, 'success');
        
        // Fechar modal
        closeDemandaPlanModal();
      });
    }
    
    // Bot√£o gerar plano com IA
    const btnGenerateAIPlanEl = $('btnGenerateAIPlan');
    if(btnGenerateAIPlanEl){
      btnGenerateAIPlanEl.addEventListener('click', async () => {
        if(!currentPlanDemanda) return;
        
        // üîí Verificar se o proxy de IA est√° dispon√≠vel (API key agora est√° no backend)
        if(typeof window.callAIProxy !== 'function'){
          showToast('‚ö†Ô∏è Servi√ßo de IA n√£o dispon√≠vel. Recarregue a p√°gina.', 'error', 5000);
          return;
        }
        
        // Desabilitar bot√£o e mostrar loading
        btnGenerateAIPlanEl.disabled = true;
        btnGenerateAIPlanEl.textContent = '‚è≥ Gerando plano...';
        
        try {
          // Coletar todo o contexto necess√°rio
          const contexto = await coletarContextoParaPlanoIA(currentPlanDemanda);
          
          // Gerar prompt focado no objetivo
          const prompt = gerarPromptParaPlanoIA(currentPlanDemanda, contexto);
          
          // Chamar API OpenRouter
          const planoGerado = await gerarPlanoComIA(prompt);
          
          // Preencher textarea com o plano gerado
          const textareaEl = $('demandaPlanText');
          if(textareaEl && planoGerado){
            textareaEl.value = planoGerado;
            console.log('‚úÖ Plano inserido no textarea:', planoGerado.substring(0, 100) + '...');
            showToast('‚ú® Plano gerado com sucesso! Revise e salve.', 'success', 5000);
          } else {
            console.warn('‚ö†Ô∏è Textarea n√£o encontrado ou plano vazio', {textareaEl, planoGerado: !!planoGerado});
          }
          
        } catch(error) {
          console.error('‚ùå Erro ao gerar plano com IA:', error);
          showToast(`‚ùå Erro ao gerar plano: ${error.message}`, 'error', 5000);
        } finally {
          // Reabilitar bot√£o
          btnGenerateAIPlanEl.disabled = false;
          btnGenerateAIPlanEl.textContent = 'ü§ñ Gerar Plano com IA';
        }
      });
    }
    
    // Fun√ß√£o para coletar contexto completo da plataforma
    async function coletarContextoParaPlanoIA(demanda){
      console.log('üîç Coletando contexto completo para gerar plano...');
      
      // Fun√ß√£o auxiliar para pegar metas ativas
      const getMetasAtivas = () => {
        try {
          if(typeof METAS !== 'undefined' && Array.isArray(METAS)){
            return METAS.filter(m => !m.concluida);
          }
          return [];
        } catch(e) {
          console.warn('Erro ao buscar metas:', e);
          return [];
        }
      };
      
      // Verificar qual vari√°vel de estrutura√ß√£o est√° dispon√≠vel
      const estructuracionState = window.ESTRUCTURACION_STATE || window.ESTRUCTURACAO_STATE || {};
      
      const contexto = {
        // Informa√ß√µes do neg√≥cio
        negocio: estructuracionState?.businessInfo || {},
        
        // Metas anuais e mensais
        metas: {
          anuais: estructuracionState?.goals || [],
          mensais: getMetasAtivas()
        },
        
        // Planejamento (todas as demandas)
        planejamento: (typeof DEMANDAS !== 'undefined' && Array.isArray(DEMANDAS)) ? DEMANDAS : [],
        
        // Estrutura√ß√£o (anota√ß√µes das semanas)
        estruturacao: estructuracionState,
        
        // Posts do calend√°rio
        posts: (typeof POSTS !== 'undefined' && Array.isArray(POSTS)) ? POSTS : [],
        
        // Macro (vis√£o geral)
        macro: {
          metas: window.METAS_PLANILHA || [],
          anuncios: window.ANUNCIOS_PLANILHA || []
        },
        
        // Calend√°rio (resumo)
        calendario: getCalendarioResumo(),
        
        // Leads
        leads: (typeof LEADS !== 'undefined' && Array.isArray(LEADS)) ? LEADS : [],
        
        // Notas do time
        notasTime: getNotasTimeResumo(),
        
        // Contexto espec√≠fico da demanda
        demanda: {
          objetivo: demanda.demanda || '',
          status: demanda.status || '',
          responsavel: demanda.responsavel || '',
          prazo: demanda.prazo || '',
          prazoFim: demanda.prazoFim || '',
          planoAtual: demanda.plano || ''
        }
      };
      
      console.log('‚úÖ Contexto coletado:', {
        negocio: !!contexto.negocio.name,
        metas: contexto.metas.mensais.length,
        planejamento: contexto.planejamento.length,
        posts: contexto.posts.length,
        leads: contexto.leads.length
      });
      
      return contexto;
    }
    
    // Fun√ß√£o auxiliar para pegar resumo do calend√°rio
    function getCalendarioResumo(){
      try {
        if(typeof POSTS === 'undefined' || !Array.isArray(POSTS)) {
          return { total: 0, aprovados: 0, pendentes: 0 };
        }
        
        const aprovados = POSTS.filter(p => p.aprovacao === 'aprovado').length;
        const pendentes = POSTS.filter(p => p.aprovacao === 'aguardando').length;
        
        return {
          total: POSTS.length,
          aprovados,
          pendentes
        };
      } catch(e) {
        console.warn('Erro ao buscar resumo do calend√°rio:', e);
        return { total: 0, aprovados: 0, pendentes: 0 };
      }
    }
    
    // Fun√ß√£o auxiliar para pegar resumo das notas do time
    function getNotasTimeResumo(){
      try {
        if(typeof TEAM_MEMBERS === 'undefined' || !Array.isArray(TEAM_MEMBERS)) {
          return [];
        }
        
        return TEAM_MEMBERS.map(m => ({
          nome: m.name || '',
          tarefas: m.tasks?.length || 0,
          notas: m.notes || ''
        }));
      } catch(e) {
        console.warn('Erro ao buscar notas do time:', e);
        return [];
      }
    }
    
    // Fun√ß√£o para gerar prompt completo com TODO o contexto
    function gerarPromptParaPlanoIA(demanda, contexto){
      const objetivo = demanda.demanda || 'objetivo n√£o especificado';
      
      let prompt = `Voc√™ √© um especialista em marketing digital e gest√£o de projetos.

OBJETIVO DA DEMANDA: ${objetivo}

=== CONTEXTO COMPLETO DO NEG√ìCIO ===

`;

      // 1. INFORMA√á√ïES DO NEG√ìCIO
      if(contexto.negocio.name){
        prompt += `NEG√ìCIO:
Nome: ${contexto.negocio.name}
Nicho: ${contexto.negocio.niche || 'N√£o informado'}
Ticket M√©dio: ${contexto.negocio.ticket || 'N√£o informado'}
Or√ßamento Mensal: ${contexto.negocio.budget || 'N√£o informado'}
Observa√ß√µes: ${contexto.negocio.observations || 'Nenhuma'}

`;
      }
      
      // 2. METAS ANUAIS E MENSAIS
      if(contexto.metas.anuais.length > 0 || contexto.metas.mensais.length > 0){
        prompt += `METAS:
`;
        if(contexto.metas.anuais.length > 0){
          prompt += `Metas Anuais:\n`;
          contexto.metas.anuais.forEach(meta => {
            prompt += `- ${meta.name}: ${meta.target}\n`;
          });
        }
        if(contexto.metas.mensais.length > 0){
          prompt += `Metas do M√™s:\n`;
          contexto.metas.mensais.forEach(meta => {
            prompt += `- ${meta.nome}: ${meta.valor} (${meta.progresso || 0}% conclu√≠do)\n`;
          });
        }
        prompt += '\n';
      }
      
      // 3. PLANEJAMENTO (outras demandas)
      if(contexto.planejamento.length > 1){
        prompt += `PLANEJAMENTO ATUAL (outras demandas):\n`;
        contexto.planejamento.filter(d => d.id !== demanda.id).forEach((d, i) => {
          prompt += `${i+1}. ${d.demanda} - Status: ${d.status}, Respons√°vel: ${d.responsavel || 'N√£o definido'}, Prazo: ${d.prazo || 'Sem prazo'}\n`;
        });
        prompt += '\n';
      }
      
      // 4. ESTRUTURA√á√ÉO (notas das semanas)
      if(contexto.estruturacao.deliverables){
        prompt += `ESTRUTURA√á√ÉO (anota√ß√µes das semanas):\n`;
        const deliverables = contexto.estruturacao.deliverables;
        Object.keys(deliverables).forEach(key => {
          const del = deliverables[key];
          if(del.notes && del.notes.length > 0){
            prompt += `${del.title || key}:\n`;
            del.notes.forEach(note => {
              const texto = typeof note === 'string' ? note : (note.text || '');
              if(texto) prompt += `- ${texto}\n`;
            });
          }
        });
        prompt += '\n';
      }
      
      // 5. CALEND√ÅRIO DE POSTS
      if(contexto.posts.length > 0){
        prompt += `POSTS NO CALEND√ÅRIO:\n`;
        contexto.posts.slice(0, 10).forEach((post, i) => {
          prompt += `${i+1}. ${post.titulo || 'Post'} - Data: ${post.data || 'N√£o definida'}, Status: ${post.aprovacao || 'pendente'}\n`;
        });
        prompt += `Total de posts: ${contexto.calendario.total}, Aprovados: ${contexto.calendario.aprovados}, Pendentes: ${contexto.calendario.pendentes}\n\n`;
      }
      
      // 6. MACRO (vis√£o estrat√©gica)
      if(contexto.macro.metas && contexto.macro.metas.length > 0){
        prompt += `MACRO - VIS√ÉO ESTRAT√âGICA:\n`;
        contexto.macro.metas.forEach((meta, i) => {
          prompt += `${i+1}. ${meta.meta || 'Meta'}: ${meta.valor || ''} - Per√≠odo: ${meta.periodo || ''}\n`;
        });
        prompt += '\n';
      }
      
      if(contexto.macro.anuncios && contexto.macro.anuncios.length > 0){
        prompt += `AN√öNCIOS PLANEJADOS:\n`;
        contexto.macro.anuncios.forEach((anuncio, i) => {
          prompt += `${i+1}. ${anuncio.nome || 'An√∫ncio'}: Budget ${anuncio.budget || ''}, Objetivo: ${anuncio.objetivo || ''}\n`;
        });
        prompt += '\n';
      }
      
      // 7. LEADS
      if(contexto.leads.length > 0){
        prompt += `LEADS CADASTRADOS:\n`;
        contexto.leads.slice(0, 10).forEach((lead, i) => {
          prompt += `${i+1}. ${lead.name || 'Lead'} - Email: ${lead.email || ''}, Telefone: ${lead.phone || ''}, Status: ${lead.status || 'novo'}\n`;
        });
        prompt += `Total de leads: ${contexto.leads.length}\n\n`;
      }
      
      // 8. NOTAS DO TIME
      if(contexto.notasTime.length > 0){
        prompt += `NOTAS DO TIME:\n`;
        contexto.notasTime.forEach(nota => {
          if(nota.notas){
            prompt += `${nota.nome}: ${nota.notas}\n`;
          }
        });
        prompt += '\n';
      }
      
      // 9. PLANO ATUAL (se existir)
      if(contexto.demanda.planoAtual){
        prompt += `PLANO EXISTENTE (para refer√™ncia ou melhoria):\n${contexto.demanda.planoAtual}\n\n`;
      }
      
      // INSTRU√á√ïES FINAIS
      prompt += `=== SUA TAREFA ===

Crie um plano de a√ß√£o PERSONALIZADO e PR√ÅTICO para executar APENAS este objetivo: "${objetivo}"

IMPORTANTE:
- Use o contexto acima APENAS como refer√™ncia para entender o neg√≥cio e personalizar suas sugest√µes
- N√ÉO mencione outras demandas ou objetivos do planejamento
- N√ÉO fale sobre metas que n√£o estejam diretamente relacionadas a este objetivo
- FOQUE 100% em como executar ESTE objetivo espec√≠fico

FORMATO DA RESPOSTA (texto simples, SEM markdown, SEM asteriscos, SEM hashtags):
Escreva um plano com 3 a 7 passos pr√°ticos SOMENTE para este objetivo. Para cada passo:
- O que fazer (seja espec√≠fico)
- Como executar (detalhes pr√°ticos baseados no contexto do neg√≥cio)
- O que considerar ou recursos necess√°rios

Escreva em texto corrido, direto e acion√°vel. Foque em a√ß√µes concretas para executar APENAS este objetivo.`;

      return prompt;
    }
    
    // Fun√ß√£o para chamar a IA e gerar o plano
    async function gerarPlanoComIA(prompt){
      console.log('ü§ñ Gerando plano com IA...');
      console.log('üìè Tamanho do prompt:', prompt.length, 'caracteres');
      
      // üîí Usando proxy seguro (API key no backend)
      const messagesPlano = [
        {
          role: 'system',
          content: 'Voc√™ √© um consultor estrat√©gico especialista em planejamento e execu√ß√£o de projetos de marketing digital. Sua miss√£o √© criar planos de a√ß√£o detalhados, pr√°ticos e execut√°veis baseados no contexto fornecido. Seja espec√≠fico, acion√°vel e focado em resultados.'
        },
        {
          role: 'user',
          content: prompt
        }
      ];
      
      const data = await window.callAIProxy(window.IA_CONFIG.model, messagesPlano, auth.currentUser?.uid, 4000, 0.7);
      
      if(!data || data.error){
        throw new Error(data?.error || 'Erro na resposta da API');
      }
      
      const planoGerado = data.choices?.[0]?.message?.content || '';
      
      // Log de custo
      if(data.usage){
        const inputTokens = data.usage.prompt_tokens || 0;
        const outputTokens = data.usage.completion_tokens || 0;
        const pricing = window.IA_CONFIG.pricing;
        const cost = (inputTokens / 1000000) * pricing.input + (outputTokens / 1000000) * pricing.output;
        
        console.log('üí∞ Custo da gera√ß√£o do plano:');
        console.log(`   üì• Input: ${inputTokens} tokens`);
        console.log(`   üì§ Output: ${outputTokens} tokens`);
        console.log(`   üíµ Custo total: $${cost.toFixed(6)}`);
      }
      
      console.log('‚úÖ Plano gerado com sucesso!');
      return planoGerado;
    }
    
    // Fechar modal clicando fora
    if(demandaPlanModalEl){
      demandaPlanModalEl.addEventListener('click', (e) => {
        if(e.target === demandaPlanModalEl){
          closeDemandaPlanModal();
        }
      });
    }
    
    /* ========= RESUMO DE DEMANDAS PARA WHATSAPP ========= */
    const demandasSummaryTextEl = $('demandasSummaryText');
    const btnCopyDemandasSummaryEl = $('btnCopyDemandasSummary');
    const btnRefreshDemandasSummaryEl = $('btnRefreshDemandasSummary');
    const selectDemandasUserEl = $('selectDemandasUser');
    const btnCopyDemandasByUserEl = $('btnCopyDemandasByUser');
    
    // Fun√ß√£o para atualizar dropdown de usu√°rios das demandas
    function updateDemandasUserDropdown(){
      if(!selectDemandasUserEl) return;
      
      // Coletar todos os respons√°veis √∫nicos das demandas
      const responsaveis = new Set();
      if(Array.isArray(DEMANDAS)){
        DEMANDAS.forEach(d => {
          if(d.responsavel && d.responsavel.trim()){
            responsaveis.add(d.responsavel.trim());
          }
        });
      }
      
      // Limpar e preencher dropdown
      selectDemandasUserEl.innerHTML = '<option value="">üë§ Por usu√°rio...</option>';
      Array.from(responsaveis).sort().forEach(resp => {
        const opt = document.createElement('option');
        opt.value = resp;
        opt.textContent = resp;
        selectDemandasUserEl.appendChild(opt);
      });
    }
    
    // Habilitar/desabilitar bot√£o de copiar por usu√°rio
    if(selectDemandasUserEl){
      selectDemandasUserEl.addEventListener('change', () => {
        if(btnCopyDemandasByUserEl){
          btnCopyDemandasByUserEl.disabled = !selectDemandasUserEl.value;
        }
      });
    }
    
    // Fun√ß√£o para formatar data de forma leg√≠vel
    function formatDateReadable(dateStr){
      if(!dateStr) return '';
      try{
        const d = new Date(dateStr);
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = d.getFullYear();
        return `${day}/${month}/${year}`;
      }catch(_){
        return dateStr;
      }
    }
    
    // Fun√ß√£o para gerar link compartilh√°vel do plano (P√öBLICO - sem login)
    // Usa Firebase para armazenar dados e gerar link curto
    async function generatePlanLinkAsync(demanda) {
      try {
        if (!auth?.currentUser) return '';
        
        const user = auth.currentUser;
        
        // Gerar token curto √∫nico
        const token = Math.random().toString(36).substring(2, 10);
        
        // Dados do plano para salvar no Firebase
        const planData = {
          token,
          demanda: demanda.demanda || '',
          status: demanda.status || 'nao-iniciado',
          responsavel: demanda.responsavel || '',
          prazo: demanda.prazo || '',
          prazoFim: demanda.prazoFim || '',
          plano: demanda.plano || '',
          createdBy: user.uid,
          createdAt: serverTimestamp()
        };
        
        // Salvar no Firebase (collection p√∫blica)
        const docRef = doc(db, 'planShares', token);
        await setDoc(docRef, planData);
        
        // Retornar link curto - usar raiz do site (plano.html est√° na raiz)
        const baseUrl = window.location.origin + '/';
        return `${baseUrl}plano.html?t=${token}`;
      } catch (e) {
        console.error('Erro ao gerar link:', e);
        return '';
      }
    }
    
    // Vers√£o s√≠ncrona que retorna link com dados codificados (fallback - N√ÉO USAR)
    function generatePlanLinkSync(demanda) {
      try {
        // Criar objeto com dados m√≠nimos
        const data = {
          d: demanda.demanda || '',
          s: demanda.status || 'nao-iniciado',
          r: demanda.responsavel || '',
          p: demanda.prazo || '',
          pf: demanda.prazoFim || '',
          pl: demanda.plano || ''
        };
        
        // Codificar em base64
        const jsonStr = JSON.stringify(data);
        const encoded = btoa(unescape(encodeURIComponent(jsonStr)));
        
        // Retornar link com dados na query string
        const baseUrl = window.location.origin + window.location.pathname.replace(/index\.html?$/i, '');
        return `${baseUrl}plano.html?d=${encoded}`;
      } catch (e) {
        console.error('Erro ao gerar link:', e);
        return '';
      }
    }
    
    // Fun√ß√£o para gerar resumo formatado para WhatsApp (ASS√çNCRONA)
    // filterUser: se fornecido, filtra apenas demandas desse respons√°vel
    async function generateDemandasSummary(filterUser = null){
      if(!Array.isArray(DEMANDAS) || DEMANDAS.length === 0){
        return '_Nenhuma demanda cadastrada no momento._';
      }
      
      // Obter nome da conta da URL (pathname) ou do usu√°rio
      let contaNome = 'Cliente';
      try {
        // Tentar pegar do pathname primeiro (ex: /wolfcarpenters/)
        const pathSegment = window.location.pathname.split('/').filter(Boolean)[0];
        if (pathSegment && pathSegment !== 'index.html') {
          contaNome = pathSegment;
        } else if (typeof CLIENT_DATA !== 'undefined' && CLIENT_DATA?.nome) {
          // Fallback para nome do cliente
          contaNome = CLIENT_DATA.nome;
        } else if (auth?.currentUser?.email) {
          // Fallback para email do usu√°rio
          contaNome = auth.currentUser.email.split('@')[0];
        }
      } catch (e) {
        contaNome = 'Cliente';
      }
      
      // Filtrar demandas conforme exibido na tabela (usando os mesmos filtros)
      const search = ($('demandaSearch')?.value || '').toLowerCase();
      const statusFilterEl = $('demandaStatusColumnFilter');
      const objetivoFilterEl = $('demandaObjetivoFilter');
      const responsavelFilterEl = $('demandaResponsavelFilter');
      const periodoInicioEl = $('demandaPeriodoInicioFilter');
      const periodoFimEl = $('demandaPeriodoFimFilter');
      
      const fStatus = statusFilterEl ? statusFilterEl.value || '' : '';
      const fObjetivo = objetivoFilterEl ? (objetivoFilterEl.value || '').toLowerCase().trim() : '';
      const fResponsavel = responsavelFilterEl ? responsavelFilterEl.value || '' : '';
      const fPeriodoInicio = periodoInicioEl ? parseFilterDate(periodoInicioEl.value, false) : null;
      const fPeriodoFim = periodoFimEl ? parseFilterDate(periodoFimEl.value, true) : null;
      const fMonth = selectedDemandaMonth;
      
      const filtered = DEMANDAS.filter(d => {
        // Filtro por usu√°rio espec√≠fico (para copiar por usu√°rio)
        if(filterUser && (d.responsavel || '') !== filterUser) return false;
        
        // Excluir demandas conclu√≠das do resumo de WhatsApp
        if(d.status === 'concluido' || d.status === 'concluido-grupo') return false;
        
        const sMatch = !search || (d.demanda || '').toLowerCase().includes(search);
        const stMatch = !fStatus || d.status === fStatus;
        const objetivoMatch = !fObjetivo || (d.demanda || '').toLowerCase().includes(fObjetivo);
        const respMatch = !fResponsavel || (d.responsavel || '') === fResponsavel;
        const demandMonths = getDemandMonthKeys(d);
        const mMatch = !fMonth || !demandMonths.length || demandMonths.includes(fMonth);
        
        let periodoMatch = true;
        if(fPeriodoInicio || fPeriodoFim){
          const rangeStart = getDemandaStartDate(d) || getDemandaEndDate(d);
          const rangeEnd = getDemandaEndDate(d) || rangeStart;
          if(!rangeStart || !rangeEnd){
            periodoMatch = false;
          }else{
            if(fPeriodoInicio && rangeEnd.getTime() < fPeriodoInicio.getTime()) periodoMatch = false;
            if(fPeriodoFim && rangeStart.getTime() > fPeriodoFim.getTime()) periodoMatch = false;
          }
        }
        return sMatch && stMatch && objetivoMatch && respMatch && mMatch && periodoMatch;
      });
      
      if(filtered.length === 0){
        return filterUser 
          ? `_Nenhuma demanda encontrada para ${filterUser}._`
          : '_Nenhuma demanda encontrada com os filtros aplicados._';
      }
      
      // Ordenar demandas (mesma l√≥gica da tabela)
      const sorted = filtered.slice().sort((a, b) => {
        const aMeta = getDemandaSortMeta(a);
        const bMeta = getDemandaSortMeta(b);
        if(aMeta.startMs !== bMeta.startMs) return aMeta.startMs - bMeta.startMs;
        if(aMeta.endMs !== bMeta.endMs) return aMeta.endMs - bMeta.endMs;
        return (a.demanda || '').localeCompare(b.demanda || '', 'pt-BR');
      });
      
      // Agrupar por respons√°vel
      const porResponsavel = {};
      sorted.forEach(d => {
        const resp = d.responsavel || 'N√£o definido';
        if(!porResponsavel[resp]) porResponsavel[resp] = [];
        porResponsavel[resp].push(d);
      });
      
      // Gerar resumo formatado (minimalista)
      let summary = `*${contaNome.toUpperCase()}*\n`;
      summary += '*üìã PLANEJAMENTO*\n\n';
      
      const responsaveis = Object.keys(porResponsavel).sort();
      
      for (let respIndex = 0; respIndex < responsaveis.length; respIndex++) {
        const responsavel = responsaveis[respIndex];
        const demandas = porResponsavel[responsavel];
        
        // Cabe√ßalho do respons√°vel
        summary += `*üë§ ${responsavel}*\n`;
        summary += `_${demandas.length} demanda(s)_\n\n`;
        
        for (let index = 0; index < demandas.length; index++) {
          const d = demandas[index];
          // Status emoji
          let statusEmoji = '‚ö™';
          if(d.status === 'em-andamento') statusEmoji = 'üîµ';
          else if(d.status === 'bloqueado') statusEmoji = 'üî¥';
          else if(d.status === 'concluido') statusEmoji = '‚úÖ';
          else if(d.status === 'prioridade') statusEmoji = 'üî•';
          else if(d.status === 'prioridade-grupo') statusEmoji = 'üî•üë•';
          else if(d.status === 'concluido-grupo') statusEmoji = '‚úÖüë•';
          
          // Demanda (objetivo)
          const objetivo = (d.demanda || 'Sem t√≠tulo').trim();
          
          // Prazo (formato curto)
          let prazoStr = '';
          if(d.prazo && d.prazoFim){
            prazoStr = `${formatDateReadable(d.prazo)} - ${formatDateReadable(d.prazoFim)}`;
          }else if(d.prazo){
            prazoStr = formatDateReadable(d.prazo);
          }else{
            prazoStr = 'Sem prazo';
          }
          
          // Bloqueio
          const bloqueadoInfo = d.status === 'bloqueado' ? ' _(bloqueada)_' : '';
          
          // Verificar se est√° ATRASADA (prazo fim j√° passou e n√£o est√° conclu√≠da)
          let atrasadoInfo = '';
          if(d.status !== 'concluido' && d.status !== 'concluido-grupo'){
            const prazoFimDate = d.prazoFim ? new Date(d.prazoFim) : (d.prazo ? new Date(d.prazo) : null);
            if(prazoFimDate){
              const hoje = new Date();
              hoje.setHours(0, 0, 0, 0);
              prazoFimDate.setHours(23, 59, 59, 999);
              if(prazoFimDate < hoje){
                atrasadoInfo = ' ‚ö†Ô∏èüî¥ *ATRASADA*';
              }
            }
          }
          
          // Link do plano (se houver plano) - vers√£o CURTA (Firebase)
          let planoLink = '';
          if(d.plano && d.plano.trim()){
            const link = await generatePlanLinkAsync(d);
            if(link) planoLink = `\n   üìù ${link}`;
          }
          
          // Montar linha (minimalista com nome do membro)
          summary += `${index + 1}. ${statusEmoji} *${objetivo}*${bloqueadoInfo}${atrasadoInfo}\n`;
          summary += `   üë§ ${responsavel} | üìÖ ${prazoStr}${planoLink}\n\n`;
        }
        
        // Separador entre respons√°veis (exceto no √∫ltimo)
        if(respIndex < responsaveis.length - 1){
          summary += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n';
        }
      }
      
      summary += `\n_Total: ${sorted.length} demanda(s)_`;
      
      return summary;
    }
    
    // Fun√ß√£o para gerar demanda individual (para c√≥pia)
    async function generateIndividualDemanda(demanda){
      if(!demanda) return '';
      
      // Obter nome da conta
      let contaNome = 'Cliente';
      try {
        const pathSegment = window.location.pathname.split('/').filter(Boolean)[0];
        if (pathSegment && pathSegment !== 'index.html') {
          contaNome = pathSegment;
        } else if (typeof CLIENT_DATA !== 'undefined' && CLIENT_DATA?.nome) {
          contaNome = CLIENT_DATA.nome;
        } else if (auth?.currentUser?.email) {
          contaNome = auth.currentUser.email.split('@')[0];
        }
      } catch (e) {
        contaNome = 'Cliente';
      }
      
      // Status emoji
      let statusEmoji = '‚ö™';
      if(demanda.status === 'em-andamento') statusEmoji = 'üîµ';
      else if(demanda.status === 'bloqueado') statusEmoji = 'üî¥';
      else if(demanda.status === 'concluido') statusEmoji = '‚úÖ';
      else if(demanda.status === 'prioridade') statusEmoji = 'üî•';
      else if(demanda.status === 'prioridade-grupo') statusEmoji = 'üî•üë•';
      else if(demanda.status === 'concluido-grupo') statusEmoji = '‚úÖüë•';
      
      // Objetivo
      const objetivo = (demanda.demanda || 'Sem t√≠tulo').trim();
      
      // Prazo
      let prazoStr = '';
      if(demanda.prazo && demanda.prazoFim){
        prazoStr = `${formatDateReadable(demanda.prazo)} - ${formatDateReadable(demanda.prazoFim)}`;
      }else if(demanda.prazo){
        prazoStr = formatDateReadable(demanda.prazo);
      }else{
        prazoStr = 'Sem prazo';
      }
      
      // Bloqueio
      const bloqueadoInfo = demanda.status === 'bloqueado' ? ' _(bloqueada)_' : '';
      
      // Atrasada
      let atrasadoInfo = '';
      if(demanda.status !== 'concluido' && demanda.status !== 'concluido-grupo'){
        const prazoFimDate = demanda.prazoFim ? new Date(demanda.prazoFim) : (demanda.prazo ? new Date(demanda.prazo) : null);
        if(prazoFimDate){
          const hoje = new Date();
          hoje.setHours(0, 0, 0, 0);
          prazoFimDate.setHours(23, 59, 59, 999);
          if(prazoFimDate < hoje){
            atrasadoInfo = ' ‚ö†Ô∏èüî¥ *ATRASADA*';
          }
        }
      }
      
      // Link do plano
      let planoLink = '';
      if(demanda.plano && demanda.plano.trim()){
        const link = await generatePlanLinkAsync(demanda);
        if(link) planoLink = `\nüìù ${link}`;
      }
      
      // Respons√°vel
      const responsavel = demanda.responsavel || 'N√£o definido';
      
      // Montar texto individual
      let texto = `*${contaNome.toUpperCase()}*\n`;
      texto += `*üìã PLANEJAMENTO*\n\n`;
      texto += `${statusEmoji} *${objetivo}*${bloqueadoInfo}${atrasadoInfo}\n`;
      texto += `üë§ ${responsavel} | üìÖ ${prazoStr}${planoLink}`;
      
      return texto;
    }
    
    // Fun√ß√£o para formatar texto com estilos do WhatsApp para visualiza√ß√£o
    function formatWhatsAppPreview(text){
      if(!text) return '';
      
      // Escapar HTML
      let html = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
      
      // Formatar *negrito*
      html = html.replace(/\*([^*\n]+)\*/g, '<span class="wa-bold">$1</span>');
      
      // Formatar _it√°lico_
      html = html.replace(/_([^_\n]+)_/g, '<span class="wa-italic">$1</span>');
      
      // Formatar ~riscado~
      html = html.replace(/~([^~\n]+)~/g, '<span class="wa-strike">$1</span>');
      
      // Destacar texto ATRASADA
      html = html.replace(/(‚ö†Ô∏èüî¥\s*<span class="wa-bold">ATRASADA<\/span>)/g, '<span class="wa-atrasada">$1</span>');
      
      // Formatar links
      html = html.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" class="wa-link">$1</a>');
      
      // Formatar separadores
      html = html.replace(/(‚îÅ{5,})/g, '<span class="wa-separator">$1</span>');
      
      return html;
    }
    
    // Atualizar preview do resumo com bot√µes individuais inline
    async function updateDemandasPreview(text, demandasData = null){
      const previewEl = $('demandasSummaryPreview');
      if(!previewEl) return;
      
      if(!text || text.trim() === ''){
        previewEl.innerHTML = '<span style="color:#8696a0">O resumo das demandas aparecer√° aqui...</span>';
        return;
      }
      
      // Criar visualiza√ß√£o com texto formatado + bot√µes inline
      let html = '<div class="demandas-preview-with-buttons">';
      html += '<div class="demandas-preview-text">' + formatWhatsAppPreview(text) + '</div>';
      
      // Se temos dados das demandas, adicionar bot√µes de c√≥pia individual agrupados por respons√°vel
      if(demandasData && Array.isArray(demandasData) && demandasData.length > 0){
        // Agrupar demandas por respons√°vel
        const porResponsavel = {};
        demandasData.forEach((d, idx) => {
          const resp = d.responsavel || 'N√£o definido';
          if(!porResponsavel[resp]) porResponsavel[resp] = [];
          porResponsavel[resp].push({demanda: d, index: idx});
        });
        
        html += '<div class="demandas-copy-buttons">';
        html += '<div class="demandas-copy-buttons-header">üìã Copiar demanda individual:</div>';
        html += '<div class="demandas-copy-buttons-list">';
        
        // Ordenar respons√°veis alfabeticamente
        const responsaveis = Object.keys(porResponsavel).sort();
        
        for(let respIndex = 0; respIndex < responsaveis.length; respIndex++){
          const responsavel = responsaveis[respIndex];
          const demandasResp = porResponsavel[responsavel];
          
          // Cabe√ßalho do respons√°vel
          html += `<div class="demandas-copy-group-header">üë§ ${responsavel}</div>`;
          
          // Bot√µes das demandas desse respons√°vel
          for(let j = 0; j < demandasResp.length; j++){
            const item = demandasResp[j];
            const d = item.demanda;
            const i = item.index;
            
            const objetivo = (d.demanda || 'Sem t√≠tulo').substring(0, 55);
            const truncated = (d.demanda || '').length > 55 ? '...' : '';
            
            // Status emoji
            let statusEmoji = '‚ö™';
            if(d.status === 'em-andamento') statusEmoji = 'üîµ';
            else if(d.status === 'bloqueado') statusEmoji = 'üî¥';
            else if(d.status === 'prioridade') statusEmoji = 'üî•';
            else if(d.status === 'prioridade-grupo') statusEmoji = 'üî•üë•';
            
            html += `<button class="btn-copy-individual-inline" data-demanda-index="${i}" title="Copiar: ${d.demanda || 'Sem t√≠tulo'}">
              <span class="btn-copy-status">${statusEmoji}</span>
              <span class="btn-copy-text">${objetivo}${truncated}</span>
              <span class="btn-copy-icon">üìã</span>
            </button>`;
          }
          
          // Separador entre respons√°veis (exceto no √∫ltimo)
          if(respIndex < responsaveis.length - 1){
            html += '<div class="demandas-copy-separator"></div>';
          }
        }
        
        html += '</div></div>';
        
        // Adicionar eventos depois de inserir HTML
        setTimeout(() => {
          const btnsCopy = previewEl.querySelectorAll('.btn-copy-individual-inline');
          btnsCopy.forEach(btn => {
            btn.addEventListener('click', async (e) => {
              e.preventDefault();
              e.stopPropagation();
              
              const index = parseInt(btn.getAttribute('data-demanda-index'));
              const demanda = demandasData[index];
              if(!demanda) return;
              
              const iconSpan = btn.querySelector('.btn-copy-icon');
              const originalIcon = iconSpan ? iconSpan.innerHTML : '';
              
              try {
                const textoIndividual = await generateIndividualDemanda(demanda);
                
                // Usar fun√ß√£o robusta de clipboard com fallback para iframes
                const copiado = await mgCopyToClipboard(textoIndividual);
                
                if (copiado) {
                  // Feedback visual de sucesso
                  if(iconSpan) iconSpan.innerHTML = '‚úÖ';
                  btn.style.background = '#25d366';
                  btn.style.borderColor = '#25d366';
                  btn.style.color = '#fff';
                  
                  setTimeout(() => {
                    if(iconSpan) iconSpan.innerHTML = originalIcon;
                    btn.style.background = '';
                    btn.style.borderColor = '';
                    btn.style.color = '';
                  }, 2000);
                  
                  showToast('Demanda copiada!', 'success');
                } else {
                  throw new Error('N√£o foi poss√≠vel copiar');
                }
                
              } catch (e) {
                console.error('Erro ao copiar demanda:', e);
                
                // Feedback visual de erro
                if(iconSpan) iconSpan.innerHTML = '‚ùå';
                btn.style.background = '#ef4444';
                btn.style.borderColor = '#ef4444';
                
                setTimeout(() => {
                  if(iconSpan) iconSpan.innerHTML = originalIcon;
                  btn.style.background = '';
                  btn.style.borderColor = '';
                }, 2000);
                
                showToast('Erro ao copiar. Tente selecionar e copiar manualmente.', 'error');
              }
            });
          });
        }, 0);
      }
      
      html += '</div>';
      previewEl.innerHTML = html;
    }
    
    // Atualizar resumo sempre que demandas mudarem (ASS√çNCRONO)
    async function updateDemandasSummary(){
      if(!demandasSummaryTextEl) return;
      
      // Mostrar loading
      demandasSummaryTextEl.value = '‚è≥ Gerando resumo...';
      const previewEl = $('demandasSummaryPreview');
      if(previewEl) previewEl.innerHTML = '<span style="color:#8696a0">‚è≥ Gerando resumo...</span>';
      
      try {
        const summary = await generateDemandasSummary();
        demandasSummaryTextEl.value = summary;
        
        // Obter demandas filtradas para criar preview com bot√µes
        const filtered = DEMANDAS.filter(d => {
          // Excluir conclu√≠das
          if(d.status === 'concluido' || d.status === 'concluido-grupo') return false;
          
          // Aplicar mesmos filtros
          const search = ($('demandaSearch')?.value || '').toLowerCase();
          const statusFilterEl = $('demandaStatusColumnFilter');
          const objetivoFilterEl = $('demandaObjetivoFilter');
          const responsavelFilterEl = $('demandaResponsavelFilter');
          const periodoInicioEl = $('demandaPeriodoInicioFilter');
          const periodoFimEl = $('demandaPeriodoFimFilter');
          
          const fStatus = statusFilterEl ? statusFilterEl.value || '' : '';
          const fObjetivo = objetivoFilterEl ? (objetivoFilterEl.value || '').toLowerCase().trim() : '';
          const fResponsavel = responsavelFilterEl ? responsavelFilterEl.value || '' : '';
          const fPeriodoInicio = periodoInicioEl ? parseFilterDate(periodoInicioEl.value, false) : null;
          const fPeriodoFim = periodoFimEl ? parseFilterDate(periodoFimEl.value, true) : null;
          const fMonth = selectedDemandaMonth;
          
          const sMatch = !search || (d.demanda || '').toLowerCase().includes(search);
          const stMatch = !fStatus || d.status === fStatus;
          const objetivoMatch = !fObjetivo || (d.demanda || '').toLowerCase().includes(fObjetivo);
          const respMatch = !fResponsavel || (d.responsavel || '') === fResponsavel;
          const demandMonths = getDemandMonthKeys(d);
          const mMatch = !fMonth || !demandMonths.length || demandMonths.includes(fMonth);
          
          let periodoMatch = true;
          if(fPeriodoInicio || fPeriodoFim){
            const rangeStart = getDemandaStartDate(d) || getDemandaEndDate(d);
            const rangeEnd = getDemandaEndDate(d) || rangeStart;
            if(!rangeStart || !rangeEnd){
              periodoMatch = false;
            }else{
              if(fPeriodoInicio && rangeEnd.getTime() < fPeriodoInicio.getTime()) periodoMatch = false;
              if(fPeriodoFim && rangeStart.getTime() > fPeriodoFim.getTime()) periodoMatch = false;
            }
          }
          return sMatch && stMatch && objetivoMatch && respMatch && mMatch && periodoMatch;
        });
        
        // Ordenar demandas
        const sorted = filtered.slice().sort((a, b) => {
          const aMeta = getDemandaSortMeta(a);
          const bMeta = getDemandaSortMeta(b);
          if(aMeta.startMs !== bMeta.startMs) return aMeta.startMs - bMeta.startMs;
          if(aMeta.endMs !== bMeta.endMs) return aMeta.endMs - bMeta.endMs;
          return (a.demanda || '').localeCompare(b.demanda || '', 'pt-BR');
        });
        
        await updateDemandasPreview(summary, sorted);
      } catch (e) {
        console.error('Erro ao gerar resumo:', e);
        demandasSummaryTextEl.value = '‚ùå Erro ao gerar resumo. Tente novamente.';
        if(previewEl) previewEl.innerHTML = '<span style="color:#ff6b6b">‚ùå Erro ao gerar resumo. Tente novamente.</span>';
      }
    }
    
    // Copiar resumo para clipboard (com fallback para iframes)
    if(btnCopyDemandasSummaryEl){
      btnCopyDemandasSummaryEl.addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        if(!demandasSummaryTextEl) return;
        
        const summary = demandasSummaryTextEl.value;
        if(!summary || summary.trim() === ''){
          showToast('Nenhum resumo para copiar', 'error');
          return;
        }
        
        try{
          // Usar fun√ß√£o robusta de clipboard com fallback para iframes
          const copiado = await mgCopyToClipboard(summary);
          
          if (copiado) {
            showToast('‚úÖ Resumo copiado! Cole no WhatsApp', 'success');
          } else {
            throw new Error('N√£o foi poss√≠vel copiar');
          }
        }catch(err){
          console.error('Erro ao copiar:', err);
          // √öltimo recurso: selecionar o textarea vis√≠vel
          demandasSummaryTextEl.select();
          showToast('‚ö†Ô∏è Copie manualmente (Ctrl+C ou Cmd+C)', 'warning');
        }
      });
    }
    
    // Bot√£o de atualizar resumo
    if(btnRefreshDemandasSummaryEl){
      btnRefreshDemandasSummaryEl.addEventListener('click', async () => {
        btnRefreshDemandasSummaryEl.disabled = true;
        btnRefreshDemandasSummaryEl.innerHTML = '<span>‚è≥</span><span>Atualizando...</span>';
        
        try {
          await updateDemandasSummary();
          updateDemandasUserDropdown(); // Atualizar dropdown de usu√°rios tamb√©m
          showToast('‚úÖ Resumo atualizado!', 'success');
        } catch (e) {
          console.error('Erro ao atualizar resumo:', e);
          showToast('‚ùå Erro ao atualizar resumo', 'error');
        } finally {
          btnRefreshDemandasSummaryEl.disabled = false;
          btnRefreshDemandasSummaryEl.innerHTML = '<span>üîÑ</span><span>Atualizar</span>';
        }
      });
    }
    
    // Bot√£o de copiar resumo POR USU√ÅRIO (com fallback para iframes)
    if(btnCopyDemandasByUserEl){
      btnCopyDemandasByUserEl.addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        const selectedUser = selectDemandasUserEl?.value;
        if(!selectedUser){
          showToast('Selecione um usu√°rio primeiro', 'error');
          return;
        }
        
        btnCopyDemandasByUserEl.disabled = true;
        btnCopyDemandasByUserEl.innerHTML = '<span>‚è≥</span>';
        
        try {
          // Gerar resumo filtrado pelo usu√°rio selecionado
          const summary = await generateDemandasSummary(selectedUser);
          
          // Usar fun√ß√£o robusta de clipboard com fallback para iframes
          const copiado = await mgCopyToClipboard(summary);
          
          if (copiado) {
            showToast(`‚úÖ Demandas de ${selectedUser} copiadas!`, 'success');
          } else {
            throw new Error('N√£o foi poss√≠vel copiar');
          }
        } catch (e) {
          console.error('Erro ao copiar por usu√°rio:', e);
          showToast('‚ùå Erro ao copiar. Tente novamente.', 'error');
        } finally {
          btnCopyDemandasByUserEl.disabled = !selectDemandasUserEl?.value;
          btnCopyDemandasByUserEl.innerHTML = '<span>üìã</span><span>Copiar</span>';
        }
      });
    }
    
    /* ========= auth & boot ========= */
    function clearAuthTraces(){
      try{
        const keys=[];
        for(let i=0;i<localStorage.length;i++){
          const k=localStorage.key(i);
          if(k && k.startsWith("mg_")) keys.push(k);
        }
        keys.forEach(k=> localStorage.removeItem(k));
      }catch(_){ }
    }
    function showLoading(){ const el=document.getElementById('loadingScreen'); if(el) el.style.display='flex'; }
    function hideLoading(){ const el=document.getElementById('loadingScreen'); if(el) el.style.display='none'; }
    $("loginGoogle").onclick = async ()=>{
      await signOut(auth).catch(()=>{});
      clearAuthTraces();
      showLoading();
      try{
        statusBox.textContent="";
        await signInWithPopup(auth, provider);
      }catch(e){
        statusBox.textContent=e.message;
      }
      hideLoading();
    };
    $("loginEmail").onclick  = async ()=>{
      console.log('üîê Login button clicked!');
      console.log('Email:', $("email").value);
      console.log('Auth object:', auth);
      await signOut(auth).catch(()=>{});
      clearAuthTraces();
      showLoading();
      try{
        statusBox.textContent="";
        console.log('üîÑ Attempting sign in...');
        await signInWithEmailAndPassword(auth, $("email").value.trim(), $("password").value.trim());
        console.log('‚úÖ Sign in successful!');
      }catch(e){
        console.error('‚ùå Login error:', e);
        statusBox.textContent=e.message;
      }
      hideLoading();
    };
    $("signupEmail").onclick = async ()=>{
      await signOut(auth).catch(()=>{});
      clearAuthTraces();
      showLoading();
      try{
        statusBox.textContent="";
        await createUserWithEmailAndPassword(auth, $("email").value.trim(), $("password").value.trim());
      }catch(e){
        statusBox.textContent=e.message;
      }
      hideLoading();
    };
    $("forgotPassword").onclick = ()=> sendPasswordResetEmail(auth, $("email").value.trim()).then(()=> statusBox.textContent="E-mail de redefini√ß√£o enviado!").catch(e=> statusBox.textContent=e.message);
    const togglePassword=$("togglePassword"), pwd=$("password"); const setVisible=(v)=>{ pwd.type=v?"text":"password"; togglePassword.textContent=v?"üôà":"üëÅ"; };
    togglePassword.addEventListener("click",()=>setVisible(pwd.type==="password"));
    // === LOGOUT ===
    $("logoutBtn").onclick = async () => {
      const btn = $("logoutBtn");
      try{
        btn.textContent = "Saindo...";
        btn.disabled = true;
        await signOut(auth);
        clearAuthTraces();
        statusBox.textContent = "Voc√™ saiu da conta.";
        // Redireciona para a raiz sem pathname para evitar conflito de TENANT
        window.location.href = window.location.origin + '/';
      }catch(e){
        alert(e.message||String(e));
        btn.textContent = "Sair";
        btn.disabled = false;
      }
    };

      onAuthStateChanged(auth, async (user)=>{
        // Verifica se √© acesso admin pelos par√¢metros da URL
        const urlParams = new URLSearchParams(window.location.search);
        const isAdminAccess = urlParams.get('admin') === 'true';
        const clientUid = urlParams.get('uid');
        
        if(user){
          const tenantFromEmail = (user.email||'').split('@')[0].toLowerCase();
          if(tenantFromEmail){
            // Verifica se a URL atual tem um pathname diferente do tenant do usu√°rio
            const currentPathTenant = window.getTenantFromHostOrPath();
            if(currentPathTenant && currentPathTenant !== tenantFromEmail){
              // Redireciona para a URL correta com o tenant do usu√°rio
              console.log(`Redirecionando de /${currentPathTenant} para /${tenantFromEmail}`);
              window.location.href = window.location.origin + '/' + tenantFromEmail;
              return; // Interrompe a execu√ß√£o
            }
            
            TENANT = tenantFromEmail;
            window.TENANT = tenantFromEmail;
            try{ document.documentElement.dataset.tenant = tenantFromEmail; document.body.setAttribute('data-client-id', tenantFromEmail); }catch(_){}
          }
          resetStorageUsageState({ loading: true });
          authArea.style.display="none"; authArea.setAttribute("aria-hidden","true");
          userArea.style.display="block"; userArea.setAttribute("aria-hidden","false");
          if(refreshBtn) refreshBtn.style.display = "block";
          if(notificationWidgetWrap) notificationWidgetWrap.style.display = "flex";
          if(noteWidget) noteWidget.style.display = "flex";
          notificationSeenMap = loadNotificationSeen();
          notificationAckCounters = loadNotificationCounters();
          try{ scheduleNotificationRefresh({ immediate: true }); }
          catch(_err){ }
          $("userInfo").textContent=`Logado como: ${user.displayName||user.email} ‚Ä¢ Cliente: ${TENANT}`;
          const ref = doc(db,"usuarios",user.uid);
          const snap=await getDoc(ref); USER_DATA=snap.exists()?snap.data():{}; window.USER_DATA = USER_DATA; 
          
          // DEBUG: Verificar o que veio do Firebase
          console.log('üî• [FIREBASE] USER_DATA carregado do Firebase');
          console.log('üî• [FIREBASE] Documento existe:', snap.exists());
          console.log('üî• [FIREBASE] USER_DATA.accesses existe:', !!USER_DATA.accesses);
          console.log('üî• [FIREBASE] USER_DATA.accesses:', USER_DATA.accesses);
          console.log('üî• [FIREBASE] Todas as keys do documento:', Object.keys(USER_DATA));
          
          syncStorageLimitFromProfile(); loadBriefFromUserData();
          await loadClientProfile();
          startClientAccountsListener();
          // Carrega membros do time para sincronizar com RESP_OPTIONS
          await loadTeamMembersSilently();
          if(!postsUnsub){
            try{ subscribePosts(); }
            catch(err){ console.error('subscribePosts', err); }
          }
          if(!STORAGE && !storageInitTried){ try{ STORAGE=getStorage(app); }catch(_){ } storageInitTried=true; }
          renderDashboard(USER_DATA); buildTabs(); initTabKeyNav();
          loadNotesFromUserData();
          loadNoteTemplatesFromUserData();
          await loadAccessesFromUserDataAsync();
          loadCACFromUserData();
          await loadDemandasFromUserData();
          loadTrafficMetricsFromUserData();
          loadTrafficOptimizationsFromUserData();
          loadTrafficOptimizationHistoryFromUserData();
          loadTrafficCampaignIdeasFromUserData();
          loadMetasFromUserData();
          loadMetaPanelsFromUserData();
          loadSocialLinksFromUserData();
          loadImpedimentsFromUserData();
          loadIAChatsFromUserData();
          await loadIADocs();
          await loadRefSocial();
          renderRefSocial();
          await refreshStorageUsage();
          // Carregar an√°lises da subcole√ß√£o SEMPRE
          await carregarTodasAnalisesFirebase(user.uid);
          renderDemandas();
          renderImpediments();
          renderMetas();
          renderSocialIcons();
          renderIAChatList();
          renderIADocsList();
          updateIADocsStatus();
          rerenderBySection();
          triggerMacroAutoOpen();
          invalidateIAContextCache();
          try{
            await fetchClientDataSnapshot(true);
          }catch(err){
            console.warn('IA context preload', err);
          }
          if(userDocUnsub) userDocUnsub();
          userDocUnsub = onSnapshot(ref, async snap=>{
            const data = snap.data() || {};
            const signatures = computeDemandSnapshotSignatures(data.demandas, data.demandaMonthPlans);
            const remoteChanged = signatures.demandas !== lastRemoteDemandasSignature || signatures.plans !== lastRemoteDemandaPlansSignature;
            const matchesLocalState = signatures.demandas === lastDemandasSignature && signatures.plans === lastDemandaPlansSignature;
            USER_DATA = data;
            syncStorageLimitFromProfile();
            loadNoteTemplatesFromUserData();
            if(remoteChanged){
              if(matchesLocalState){
                pendingDemandasSnapshot = null;
                lastDemandasSignature = signatures.demandas;
                lastDemandaPlansSignature = signatures.plans;
                lastRemoteDemandasSignature = signatures.demandas;
                lastRemoteDemandaPlansSignature = signatures.plans;
              }else if(shouldDeferDemandasSnapshot()){
                queuePendingDemandasSnapshot({ data, signatures, matchesLocalState });
              }else{
                pendingDemandasSnapshot = null;
                await loadDemandasFromUserData();
                requestRenderDemandas();
                lastRemoteDemandasSignature = signatures.demandas;
                lastRemoteDemandaPlansSignature = signatures.plans;
              }
            }
            const remoteImpediments = Array.isArray(data?.impediments) ? data.impediments : [];
            const remoteImpedimentsSignature = computeImpedimentsSignature(remoteImpediments);
            if(remoteImpedimentsSignature !== lastRemoteImpedimentsSignature){
              if(remoteImpedimentsSignature === lastImpedimentsSignature){
                lastRemoteImpedimentsSignature = remoteImpedimentsSignature;
              }else{
                applyImpedimentsFromSource(remoteImpediments, { fromRemote:true });
                renderImpediments();
              }
            }
            loadMetasFromUserData();
            loadMetaPanelsFromUserData();
            handleRemoteTrafficOptimizations(data?.trafegoOptimizations);
            handleRemoteTrafficOptimizationHistory(data?.trafegoOptimizationHistory);
            handleRemoteTrafficCampaignIdeas(data?.trafegoCampaignIdeas);
            handleRemoteTrafficMetrics(data?.trafegoMetrics);
            loadCACFromUserData();
            renderMetas();
            if(renderCAC.refresh) renderCAC.refresh();
            invalidateIAContextCache();
            triggerMacroAutoOpen();
          });
        }else{
          // Verifica se √© acesso admin sem estar logado
          const urlParams = new URLSearchParams(window.location.search);
          const isAdminAccess = urlParams.get('admin') === 'true';
          const clientUid = urlParams.get('uid');
          const adminEmail = urlParams.get('adminEmail');
          
          if(isAdminAccess && clientUid){
            // Admin acessando conta de cliente - cria sess√£o simulada
            console.log('üîê Acesso Admin detectado - criando sess√£o simulada');
            
            // Carrega dados do cliente do Firestore
            const ref = doc(db,"usuarios",clientUid);
            const snap = await getDoc(ref);
            
            if (!snap.exists()) {
              console.error('‚ùå Usu√°rio n√£o encontrado no Firestore:', clientUid);
              mgToast('‚ùå Usu√°rio n√£o encontrado. A conta pode ter sido deletada.');
              authArea.style.display="flex"; 
              authArea.setAttribute("aria-hidden","false");
              return;
            }
            
            const userData = snap.data();
            USER_DATA = userData;
            window.USER_DATA = USER_DATA; // Sincronizar com window para acesso global
            
            // Cria um objeto "user fake" que simula o usu√°rio estar logado
            const fakeUser = {
              uid: clientUid,
              email: userData.email || urlParams.get('client')?.replace(/_/g, '@') || 'usuario@example.com',
              displayName: userData.displayName || userData.email?.split('@')[0] || 'Usu√°rio',
              photoURL: userData.photoURL || null,
              emailVerified: true,
              isAnonymous: false,
              metadata: {
                creationTime: userData.createdAt || new Date().toISOString(),
                lastSignInTime: new Date().toISOString()
              },
              providerData: [{
                providerId: 'admin-session',
                uid: clientUid,
                displayName: userData.displayName || userData.email?.split('@')[0],
                email: userData.email,
                photoURL: userData.photoURL || null
              }],
              // Flag especial para identificar sess√£o admin
              _isAdminSession: true,
              _adminEmail: adminEmail || 'admin'
            };
            
            // Armazena o fakeUser globalmente
            window._adminFakeUser = fakeUser;
            
            console.log('‚úÖ Sess√£o admin criada para:', fakeUser.email);
            
            // Define TENANT baseado no email do usu√°rio
            const tenantFromEmail = (fakeUser.email||'').split('@')[0].toLowerCase();
            TENANT = tenantFromEmail || clientUid;
            window.TENANT = TENANT;
            try{ 
              document.documentElement.dataset.tenant = TENANT; 
              document.body.setAttribute('data-client-id', TENANT); 
            }catch(_){}
            
            // Oculta √°rea de autentica√ß√£o e mostra painel
            authArea.style.display="none"; authArea.setAttribute("aria-hidden","true");
            userArea.style.display="block"; userArea.setAttribute("aria-hidden","false");
            if(refreshBtn) refreshBtn.style.display = "block";
            if(notificationWidgetWrap) notificationWidgetWrap.style.display = "flex";
            if(noteWidget) noteWidget.style.display = "flex";
            
            // Atualiza informa√ß√µes do usu√°rio no header
            const adminBadge = `<span style="background:#7c4dff;color:#fff;padding:2px 8px;border-radius:999px;font-size:0.75rem;margin-left:8px;">ADMIN: ${adminEmail || 'Admin'}</span>`;
            $("userInfo").innerHTML = `Visualizando como: ${fakeUser.displayName || fakeUser.email} ${adminBadge}`;
            
            // Exibe bot√£o para voltar ao painel admin
            const adminPanelBtn = $("adminPanelBtn");
            if(adminPanelBtn) {
              adminPanelBtn.style.display = "inline-block";
              adminPanelBtn.onclick = () => {
                // Limpa a sess√£o fake
                window._adminFakeUser = null;
                sessionStorage.removeItem('adminSession');
                // Redireciona para o painel admin
                window.location.href = '/admin-selector.html';
              };
            }
            
            resetStorageUsageState({ loading: true });
            notificationSeenMap = loadNotificationSeen();
            notificationAckCounters = loadNotificationCounters();
            
            try{ scheduleNotificationRefresh({ immediate: true }); }
            catch(_err){ }
            
            syncStorageLimitFromProfile();
            loadBriefFromUserData();
            await loadClientProfile();
            startClientAccountsListener();
            
            if(!postsUnsub){
              try{ subscribePosts(); }
              catch(err){ console.error('subscribePosts', err); }
            }
            
            if(!STORAGE && !storageInitTried){ 
              try{ STORAGE=getStorage(app); }
              catch(_){ } 
              storageInitTried=true; 
            }
            
            renderDashboard(USER_DATA); 
            buildTabs(); 
            initTabKeyNav();
            loadNotesFromUserData();
            loadNoteTemplatesFromUserData();
            await loadAccessesFromUserDataAsync();
            loadCACFromUserData();
            await loadDemandasFromUserData();
            loadTrafficMetricsFromUserData();
            loadTrafficOptimizationsFromUserData();
            loadTrafficOptimizationHistoryFromUserData();
            loadTrafficCampaignIdeasFromUserData();
            loadMetasFromUserData();
            loadMetaPanelsFromUserData();
            loadSocialLinksFromUserData();
            loadImpedimentsFromUserData();
            loadIAChatsFromUserData();
            await loadIADocs();
            await loadRefSocial();
            renderRefSocial();
            await refreshStorageUsage();
            // Carregar an√°lises da subcole√ß√£o SEMPRE - Admin
            await carregarTodasAnalisesFirebase(clientUid);
            renderDemandas();
            renderImpediments();
            renderMetas();
            renderSocialIcons();
            renderIAChatList();
            renderIADocsList();
            updateIADocsStatus();
            rerenderBySection();
            triggerMacroAutoOpen();
            invalidateIAContextCache();
            
            try{
              await fetchClientDataSnapshot(true);
            }catch(err){
              console.warn('IA context preload', err);
            }
            
            // Listener para mudan√ßas no documento do cliente
            if(userDocUnsub) userDocUnsub();
            userDocUnsub = onSnapshot(ref, async snap=>{
              const data = snap.data() || {};
              const signatures = computeDemandSnapshotSignatures(data.demandas, data.demandaMonthPlans);
              const remoteChanged = signatures.demandas !== lastRemoteDemandasSignature || signatures.plans !== lastRemoteDemandaPlansSignature;
              const matchesLocalState = signatures.demandas === lastDemandasSignature && signatures.plans === lastDemandaPlansSignature;
              USER_DATA = data;
              syncStorageLimitFromProfile();
              loadNoteTemplatesFromUserData();
              
              if(remoteChanged){
                if(matchesLocalState){
                  pendingDemandasSnapshot = null;
                  lastDemandasSignature = signatures.demandas;
                  lastDemandaPlansSignature = signatures.plans;
                  lastRemoteDemandasSignature = signatures.demandas;
                  lastRemoteDemandaPlansSignature = signatures.plans;
                }else if(shouldDeferDemandasSnapshot()){
                  queuePendingDemandasSnapshot({ data, signatures, matchesLocalState });
                }else{
                  pendingDemandasSnapshot = null;
                  await loadDemandasFromUserData();
                  requestRenderDemandas();
                  lastRemoteDemandasSignature = signatures.demandas;
                  lastRemoteDemandaPlansSignature = signatures.plans;
                }
              }
              
              const remoteImpediments = Array.isArray(data?.impediments) ? data.impediments : [];
              const remoteImpedimentsSignature = computeImpedimentsSignature(remoteImpediments);
              if(remoteImpedimentsSignature !== lastRemoteImpedimentsSignature){
                if(remoteImpedimentsSignature === lastImpedimentsSignature){
                  lastRemoteImpedimentsSignature = remoteImpedimentsSignature;
                }else{
                  applyImpedimentsFromSource(remoteImpediments, { fromRemote:true });
                  renderImpediments();
                }
              }
              
              loadMetasFromUserData();
              renderMetas();
              await loadAccessesFromUserDataAsync();
              handleRemoteTrafficMetrics(data?.trafegoMetrics);
              loadCACFromUserData();
              if(renderCAC.refresh) renderCAC.refresh();
              invalidateIAContextCache();
              triggerMacroAutoOpen();
            });
            
            return; // Interrompe o fluxo normal de logout
          }
          
          // Fluxo normal de logout
          stopClientAccountsListener();
          if(userDocUnsub){ userDocUnsub(); userDocUnsub=null; }
          if(clientDocUnsub){ try{ clientDocUnsub(); }catch(_e){} clientDocUnsub=null; }
          if(metasFormUnsub){ try{ metasFormUnsub(); }catch(_e){} metasFormUnsub=null; }
          metasFormAppliedVersions = {};
          try{ if(postsUnsub){ postsUnsub(); } }
          catch(_e){}
          postsUnsub = null;
          POSTS = [];
          try{ refreshMacroInsights({ immediate: true }); }
          catch(_e){}
          authArea.style.display="flex"; authArea.setAttribute("aria-hidden","false");
          userArea.style.display="none"; userArea.setAttribute("aria-hidden","true");
          if(refreshBtn) refreshBtn.style.display = "none";
          if(notificationWidgetWrap) notificationWidgetWrap.style.display = "none";
          if(noteWidget){
            noteWidget.style.display = "none";
            const noteTab = document.getElementById('noteTab');
            noteTab?.classList.remove('show');
          }
          notificationSeenMap = loadNotificationSeen();
          notificationAckCounters = loadNotificationCounters();
          applyNotificationData({ items: [], countersSnapshot: {} });
          NOTE_TEMPLATES = [];
          refreshNoteTemplateOptions();
          DEMANDAS = [];
          DEMANDA_MONTH_PLANS = {};
          lastDemandasSignature = '';
          lastDemandaPlansSignature = '';
          lastRemoteDemandasSignature = '';
          lastRemoteDemandaPlansSignature = '';
          TRAFEGO_CAMPAIGN_IDEAS = [];
          TRAFEGO_OPTIMIZATIONS = [];
          TRAFEGO_OPTIMIZATIONS_LAST_SAVED = [];
          TRAFEGO_OPTIMIZATION_HISTORY = [];
          TRAFEGO_METRICS = [];
          trafficCampaignLocalSignature = '';
          trafficCampaignSavedSignature = '';
          trafficCampaignRemoteSignature = '';
          trafficOptimizationLocalSignature = '';
          trafficOptimizationSavedSignature = '';
          trafficOptimizationRemoteSignature = '';
          trafficHistoryLocalSignature = '';
          trafficHistorySavedSignature = '';
          trafficHistoryRemoteSignature = '';
          trafficMetricsLocalSignature = '';
          trafficMetricsSavedSignature = '';
          trafficMetricsRemoteSignature = '';
          pendingTrafficCampaignSnapshot = null;
          pendingTrafficOptimizationSnapshot = null;
          pendingTrafficOptimizationHistorySnapshot = null;
          pendingTrafficMetricsSnapshot = null;
          if(trafegoOptimizationSaveTimer){
            clearTimeout(trafegoOptimizationSaveTimer);
            trafegoOptimizationSaveTimer = null;
          }
          trafegoOptimizationSavePending = false;
          trafegoOptimizationSaveInFlight = false;
          trafegoOptimizationSaveQueued = false;
          if(trafegoHistorySaveTimer){
            clearTimeout(trafegoHistorySaveTimer);
            trafegoHistorySaveTimer = null;
          }
          trafegoHistorySavePending = false;
          trafegoHistorySaveInFlight = false;
          trafegoHistorySaveQueued = false;
          if(trafegoMetricsSaveTimer){
            clearTimeout(trafegoMetricsSaveTimer);
            trafegoMetricsSaveTimer = null;
          }
          trafegoMetricsSavePending = false;
          trafegoMetricsSaveInFlight = false;
          trafegoMetricsSaveQueued = false;
          if(trafegoCampaignStatusFilter) trafegoCampaignStatusFilter.value = 'all';
          if(trafegoCampaignSearch) trafegoCampaignSearch.value = '';
          if(trafegoOptimizationPlatformFilter) trafegoOptimizationPlatformFilter.value = 'all';
          if(trafegoOptimizationRecurrenceFilter) trafegoOptimizationRecurrenceFilter.value = 'all';
          const trafegoOptimizationStatusFilter = document.getElementById('trafegoOptimizationStatusFilter');
          if(trafegoOptimizationStatusFilter) trafegoOptimizationStatusFilter.value = 'all';
          if(trafegoOptimizationSearch) trafegoOptimizationSearch.value = '';
          if(trafegoHistoryPlatformFilter) trafegoHistoryPlatformFilter.value = 'all';
          if(trafegoHistorySearch) trafegoHistorySearch.value = '';
          renderTrafficOptimizations();
          renderTrafficOptimizationHistory();
          renderTrafficCampaignIdeas();
          renderTrafficMetrics();
          applyImpedimentsFromSource([], { fromRemote:true });
          renderImpediments();
          updateImpedimentsSignature();
          SOCIAL_LINKS = {};
          renderSocialIcons();
          CLIENT_PROFILE = {};
          clientDocPathParts = null;
          profileLogoUploading = false;
          updateProfileAvatar();
          resetStorageUsageState({ loading: false });
          IA_CHATS = []; CURRENT_CHAT = null;
          IA_DOCS = [];
          IA_DOCS_PENDING = [];
          renderIAChatList();
          renderIAHistory();
          renderIADocsList();
          updateIADocsStatus();
          invalidateIAContextCache();
          macroAutoOpenPending = true;
          clearMacroTabBadge();
        }
      });


    /* ========= CALEND√ÅRIO / POSTS (Firestore + Storage) ========= */
    const calWeekdays = $("calWeekdays"), calDays = $("calDays"), calTitle = $("calTitle");
    const googleCalendarConnectBtn = $("googleCalendarConnect"), googleCalendarDisconnectBtn = $("googleCalendarDisconnect"), googleCalendarStatus = $("googleCalendarStatus");
    if(window.googleCalendarIntegration){
      window.googleCalendarIntegration.setDomRefs({
        connectBtn: googleCalendarConnectBtn,
        disconnectBtn: googleCalendarDisconnectBtn,
        statusEl: googleCalendarStatus
      });
      if(typeof window.googleCalendarIntegration.ensureConnected === 'function'){
        window.googleCalendarIntegration.ensureConnected();
      }
    }
    const calPrev = $("calPrev"), calNext = $("calNext"), calUpload = $("calUpload"), btnShareCalendar = $("btnShareCalendar");
    const calDate = $("calDate"), calDesc = $("calDesc"), calFiles = $("calFiles"), calTarget = $("calTarget"), calFilterStatus = $("calFilterStatus"), calFilterCountry = $("calFilterCountry"), calFilterText = $("calFilterText");
      const feedGrid = $("feedGrid"), storiesGrid = $("storiesGrid"), storiesPrev = $("storiesPrev"), storiesNext = $("storiesNext");
    const postModal = $("postModal"), modalClose = $("modalClose"), modalTitle = $("modalTitle"), modalPreview = $("modalPreview"), modalDate = $("modalDate"), modalStatus = $("modalStatus"), modalDesc = $("modalDesc"), modalTarget = $("modalTarget");
      const btnApprove = $("btnApprove"), btnApproveInternal = $("btnApproveInternal"), btnReview = $("btnReview"), btnCopyApprovalLink = $("btnCopyApprovalLink"), btnSave = $("btnSave"), btnDelete = $("btnDelete");

      if(storiesPrev && storiesGrid) storiesPrev.onclick = () => storiesGrid.scrollBy({left:-100, behavior:'smooth'});
      if(storiesNext && storiesGrid) storiesNext.onclick = () => storiesGrid.scrollBy({left:100, behavior:'smooth'});

      let STORAGE = null;
    let POSTS = []; // {id,dateISO,desc,mediaUrls:[...],thumbUrl,type,status,target,createdAt}
    let coverInput = null;
    let coverUploading = false;

    function ensureCoverInput(){
      if(coverInput) return coverInput;
      coverInput = document.createElement('input');
      coverInput.type = 'file';
      coverInput.accept = 'image/*';
      coverInput.style.display = 'none';
      coverInput.id = 'coverUploadInput';
      document.body.appendChild(coverInput);
      coverInput.addEventListener('change', ()=>{
        const file = coverInput.files?.[0] || null;
        const postId = coverInput.getAttribute('data-post-id');
        coverInput.value = '';
        coverInput.removeAttribute('data-post-id');
        if(file && postId){ uploadCoverImage(postId, file); }
      });
      return coverInput;
    }

    function promptCoverUpload(postId){
      if(!postId) return;
      const input = ensureCoverInput();
      input.setAttribute('data-post-id', postId);
      input.click();
    }

    async function uploadCoverImage(postId, file){
      if(!file) return;
      if(coverUploading) return;
      try{
        if(!(file.type||'').toLowerCase().startsWith('image/')){
          alert('Selecione uma imagem para a capa.');
          return;
        }
        const uid = auth.currentUser?.uid;
        if(!uid){
          alert('Fa√ßa login para enviar a capa.');
          return;
        }
        const post = POSTS.find(p=>p.id===postId);
        if(!post){
          alert('Post n√£o encontrado.');
          return;
        }
        const safeTenant = (typeof TENANT!=="undefined" && TENANT) ? TENANT : null;
        if(!safeTenant || safeTenant === 'no-client'){
          alert('Cliente n√£o definido na URL.');
          return;
        }
        if(!STORAGE){
          try{ STORAGE = getStorage(app); }
          catch(err){ console.error(err); alert('Storage n√£o inicializado.'); return; }
        }
        coverUploading = true;
        const safeName = (file.name||'cover').replace(/[^a-zA-Z0-9._-]/g,'_');
        const path = `users/${uid}/tenant-${safeTenant}/posts/${postId}/cover_${Date.now()}_${safeName}`;
        const ref = sRef(STORAGE, path);
        await uploadBytes(ref, file);
        const url = await getDownloadURL(ref);
        const coverSize = Number(file?.size);
        const coverMeta = {
          path,
          size: Number.isFinite(coverSize) && coverSize > 0 ? coverSize : null,
          contentType: file?.type || ''
        };
        await updateDoc(doc(db, 'usuarios', uid, 'posts', postId), {
          thumbUrl: url,
          coverMeta,
          updatedAt: serverTimestamp()
        });
        post.thumbUrl = url;
        post.coverMeta = coverMeta;
        if(selectedPost && selectedPost.id===postId){
          selectedPost.thumbUrl = url;
          selectedPost.coverMeta = coverMeta;
        }
        if(typeof mgToast === 'function'){
          mgToast('Capa atualizada!');
        }
        renderCalendarDays();
        renderPlanilha();
        await refreshStorageUsage();
      }catch(err){
        console.error('uploadCoverImage', err);
        alert('Falha ao enviar capa: ' + (err?.message || String(err)));
      }finally{
        coverUploading = false;
      }
    }
    let postsUnsub = null;
    let currentMonth = (()=>{ const d=new Date(); return new Date(d.getFullYear(), d.getMonth(), 1); })();
    let selectedPost = null;
    const COMMEMORATIVE_DATES_BR = window.COMMEMORATIVE_DATES_BR || {};
    const COMMEMORATIVE_DATES_US = window.COMMEMORATIVE_DATES_US || {};
    let CAL_NOTES = {};
    let calNotesUnsub = null;
// === Estado do carrossel (aprova√ß√£o slide a slide) ===
let SLIDE_IDX = 0;
let SLIDES = []; // array de URLs da m√≠dia do post
let APPROVED_CLIENT_SET = new Set(); // √≠ndices aprovados pelo cliente
let APPROVED_INTERNAL_SET = new Set(); // √≠ndices aprovados pelo time interno
let REVIEWED_SET = new Set();  // √≠ndices revisados (carregados de Firestore)

    function normalizeRole(value){
      const v = (value||"").toString().toLowerCase();
      return v === 'cliente' || v === 'interno' ? v : '';
    }
    function guessOriginFromEmail(email){
      const lower = (email||'').toLowerCase();
      if(lower.includes('mediagrowth')) return 'interno';
      return lower ? 'cliente' : '';
    }
    function getPortalRoleFromContext(){
      const attrRole = normalizeRole(document.body?.getAttribute('data-portal-role'));
      if(attrRole) return attrRole;
      if(typeof window.MG_PORTAL_ROLE === 'string'){
        const fromGlobal = normalizeRole(window.MG_PORTAL_ROLE);
        if(fromGlobal) return fromGlobal;
      }
      try{
        const qs = new URLSearchParams(location.search||'');
        const qsRole = normalizeRole(qs.get('portalRole') || qs.get('role'));
        if(qsRole) return qsRole;
      }catch(_){ /* ignore */ }
      const host = (location.hostname||'').toLowerCase();
      if(host.includes('cliente') || host.includes('client')) return 'cliente';
      return '';
    }
    function getCurrentReviewOrigin(){
      const contextual = getPortalRoleFromContext();
      if(contextual) return contextual;
      const emailOrigin = guessOriginFromEmail(auth?.currentUser?.email || '');
      return emailOrigin || 'interno';
    }
    function resolveReviewOrigin(note){
      if(note && typeof note.origin === 'string'){
        const normalized = normalizeRole(note.origin);
        if(normalized) return normalized;
      }
      const fromEmail = guessOriginFromEmail(note?.by || '');
      return fromEmail || 'cliente';
    }


    function ensureCalendar(){
      if(!STORAGE){ try{ STORAGE = getStorage(app); }catch(_){ /* ignore */ } }
      if(!postsUnsub){ subscribePosts(); }
      if(!calNotesUnsub){ subscribeCalNotes(); }
      renderCalendarStatic();
      renderCalendarDays();
      renderPlanilha();
    }

    function monthLabel(d){
      const names = ["janeiro","fevereiro","mar√ßo","abril","maio","junho","julho","agosto","setembro","outubro","novembro","dezembro"];
      return `${names[d.getMonth()].slice(0,1).toUpperCase()}${names[d.getMonth()].slice(1)} ${d.getFullYear()}`;
    }
    function localDateISO(d){
      const z = new Date(d.getTime() - d.getTimezoneOffset()*60000);
      return z.toISOString().slice(0,10);
    }
    function daysInMonth(year, month){ return new Date(year, month+1, 0).getDate(); }

    function renderCalendarStatic(){
      if(!calWeekdays) return;
      calWeekdays.innerHTML = ["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"].map((w, idx)=>`<div class="cal-weekday${(idx===0||idx===6)?' weekend':''}">${w}</div>`).join("");
      calPrev.onclick = ()=>{ currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()-1, 1); renderCalendarDays(); };
      calNext.onclick = ()=>{ currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()+1, 1); renderCalendarDays(); };
      calFilterStatus.onchange = ()=>{ renderCalendarDays(); renderPlanilha(); };
      calFilterCountry.onchange = ()=>{ renderCalendarDays(); };
      calFilterText.oninput = ()=>{ renderCalendarDays(); };
    // === Fun√ß√µes de gera√ß√£o de thumbnail de v√≠deo (se√ß√£o 2) ===
    // Fun√ß√µes duplicadas aqui porque o c√≥digo est√° em duas se√ß√µes
    if(typeof VIDEO_THUMBNAILS_CACHE === "undefined") var VIDEO_THUMBNAILS_CACHE = new Map();
    if(typeof generateVideoThumbnail === "undefined") {
      window.generateVideoThumbnail = async function(videoUrl, postId) {
        // URL inv√°lida? n√£o processa
        if(!videoUrl || typeof videoUrl !== 'string' || videoUrl.trim() === ''){
          return null;
        }
        if (VIDEO_THUMBNAILS_CACHE.has(videoUrl)) { return VIDEO_THUMBNAILS_CACHE.get(videoUrl); }
        const releaseVideo = (video) => {
          try{ video.onerror = null; video.onseeked = null; video.onloadedmetadata = null; }catch(_){}
          try{ video.pause?.(); }catch(_){ }
          try{ video.removeAttribute('src'); video.load?.(); }catch(_){ }
        };
        return new Promise((resolve) => {
          const video = document.createElement("video");
          video.crossOrigin = "anonymous";
          video.preload = "metadata";
          video.muted = true;
          video.playsInline = true;
          const timeout = setTimeout(() => { releaseVideo(video); resolve(null); }, 10000);
          video.onloadedmetadata = () => {
            try{
              const dur = Number(video.duration) || 0;
              const seekTime = Math.min(0.5, Math.max(0, dur) * 0.1);
              video.currentTime = seekTime;
            }catch(_){ clearTimeout(timeout); releaseVideo(video); resolve(null); }
          };
          video.onseeked = () => {
            try{
              clearTimeout(timeout);
              const canvas = document.createElement("canvas");
              canvas.width = video.videoWidth || 640;
              canvas.height = video.videoHeight || 360;
              const ctx = canvas.getContext("2d");
              ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
              const thumbnailDataUrl = canvas.toDataURL("image/jpeg", 0.7);
              VIDEO_THUMBNAILS_CACHE.set(videoUrl, thumbnailDataUrl);
              releaseVideo(video);
              resolve(thumbnailDataUrl);
            }catch(_){ clearTimeout(timeout); releaseVideo(video); resolve(null); }
          };
          video.onerror = () => { clearTimeout(timeout); releaseVideo(video); resolve(null); };
          try{ video.src = videoUrl; }catch(_){ clearTimeout(timeout); releaseVideo(video); resolve(null); }
        });
      };
    }
    if(typeof applyVideoThumbnails === "undefined") {
      window.applyVideoThumbnails = function() {
        const videoContainers = document.querySelectorAll(".cal-thumb[data-video-url], .feed-item[data-video-url], .story-item[data-video-url], .relatorio-story-item[data-video-url]");
        videoContainers.forEach(async (container) => {
          const videoUrl = container.getAttribute("data-video-url"); const postId = container.getAttribute("data-id");
          if (!videoUrl || typeof videoUrl !== 'string' || videoUrl.trim() === '') { return; }
          if (container.querySelector("img")) { return; }
          const thumbnailUrl = await window.generateVideoThumbnail(videoUrl, postId);
          if (!thumbnailUrl) { return; }
          if (container.getAttribute("data-video-url") === videoUrl) {
            const img = document.createElement("img");
            img.src = thumbnailUrl;
            img.alt = "Video preview";
            img.crossOrigin = "anonymous";
            img.style.width = "100%";
            img.style.height = "100%";
            img.style.objectFit = "cover";
            const span = container.querySelector("span"); if (span) span.remove();
            container.appendChild(img);
          }
        });
      };
    }

    }

    function postsByDateMap(){
      const map = new Map();
      const filt = (calFilterStatus?.value||"").trim();
      POSTS.forEach(p=>{
        if(filt && p.status !== filt) return;
        const list = map.get(p.dateISO) || [];
        list.push(p); map.set(p.dateISO, list);
      });
      return map;
    }

    function renderCalendarDays(){
      console.log("[Calendar] renderCalendarDays() chamado");
      if(!calDays) return;
      calTitle.textContent = monthLabel(currentMonth);
      const y = currentMonth.getFullYear(), m = currentMonth.getMonth();
      const monthKey = buildMonthKey(y, m+1);
      const todayISO = localDateISO(new Date());
      const firstDay = new Date(y, m, 1);
      const startWeekday = (firstDay.getDay() + 7) % 7; // 0=Sun
      const totalDays = daysInMonth(y,m);
      const prevPad = startWeekday;
      const totalCells = Math.ceil((prevPad + totalDays) / 7) * 7;

      const map = postsByDateMap();
      const demandaMap = new Map();
      if(Array.isArray(DEMANDAS)){
        DEMANDAS.forEach(d=>{
          normalizeDemanda(d);
          const entries = getDemandaCalendarEntries(d);
          entries.forEach(entry=>{
            if(!entry?.dateKey) return;
            const list = demandaMap.get(entry.dateKey) || [];
            list.push(entry);
            demandaMap.set(entry.dateKey, list);
          });
        });
        demandaMap.forEach(list=>{
          list.sort((a,b)=>{
            const diff = getDemandaEntryTime(a) - getDemandaEntryTime(b);
            if(diff !== 0) return diff;
            const nameA = (a?.demanda?.demanda || '').toLowerCase();
            const nameB = (b?.demanda?.demanda || '').toLowerCase();
            return nameA.localeCompare(nameB);
          });
        });
      }
      const esc = s => s.replace(/[&<>]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
      const cells = [];
      const country = (calFilterCountry?.value||"").trim();
      const textFilter = (calFilterText?.value||"").trim().toLowerCase();
      for(let i=0;i<totalCells;i++){
        const dayNum = i - prevPad + 1;
        const inMonth = dayNum>=1 && dayNum<=totalDays;
        const weekday = i % 7;
        const isWeekend = weekday === 0 || weekday === 6;
        const date = inMonth ? new Date(y,m,dayNum) : null;
        const iso = inMonth ? localDateISO(date) : "";
        const isToday = iso === todayISO;
        const items = inMonth ? (map.get(iso) || []) : [];
        const demandas = inMonth ? (demandaMap.get(iso) || []) : [];
        let holidays = [];
        if(inMonth && country){
          if(country === 'BR') holidays = COMMEMORATIVE_DATES_BR[iso] || [];
          else if(country === 'US') holidays = COMMEMORATIVE_DATES_US[iso] || [];
          if(textFilter) holidays = holidays.filter(h=>h.toLowerCase().includes(textFilter));
        }
        const cellClasses = ['cal-cell'];
        if(isWeekend) cellClasses.push('weekend');
        if(inMonth){
          if(isToday) cellClasses.push('today');
        }else{
          cellClasses.push('out');
        }
        const holidayHtml = holidays.map(h=>`<div>${esc(h)}</div>`).join("");
        const thumbs = items.map(post => {
          let cls = "cal-thumb";
          if(post.status === "aprovado"){
            cls += post.approvedBy === 'interno' ? " aprovado-interno" : " aprovado";
          }else if(post.status === "revisar"){
            cls += " revisar";
          }
          const first = (post.thumbUrl || post.mediaUrls?.[0] || "");
          const ext = first.split("?")[0].split(".").pop().toLowerCase();
          const isVideo = ["mp4","mov","webm","m4v","avi"].includes(ext);
          const label = post.type==="carousel" ? "C" : (isVideo ? "V" : "");
          if(first){
            if(isVideo){
              // Se j√° tem thumbUrl personalizada (capa), usa ela
              if(post.thumbUrl && !post.thumbUrl.includes('.mp4') && !post.thumbUrl.includes('.mov') && !post.thumbUrl.includes('.webm')) {
                return `<div class="${cls}" data-id="${post.id}" title="${(post.desc||'').replace(/"/g,'&quot;')}"><img src="${post.thumbUrl}" alt="" crossorigin="anonymous"></div>`;
              }
              // Sen√£o, renderiza com data-video-url para gerar thumbnail autom√°tica
              return `<div class="${cls}" data-id="${post.id}" data-video-url="${first}" title="${(post.desc||'').replace(/"/g,'&quot;')}"><span>${label||"V"}</span></div>`;
            }else{
              return `<div class="${cls}" data-id="${post.id}" title="${(post.desc||'').replace(/"/g,'&quot;')}"><img src="${first}" alt="" crossorigin="anonymous"></div>`;
            }
          }else{
            return `<div class="${cls}" data-id="${post.id}" title="${(post.desc||'').replace(/"/g,'&quot;')}"><span>${label||"+"}</span></div>`;
          }
        }).join("");

        const demandasHtml = inMonth ? renderCalendarDemandaItems(demandas, esc, textFilter) : '';
        const note = inMonth ? esc(CAL_NOTES[iso] || '') : '';
        cells.push(`
          <div class="${cellClasses.join(' ')}" data-iso="${iso}">
            ${inMonth?`<div class="daynum">${dayNum}</div>`:''}
            ${holidayHtml?`<div class="cal-holidays">${holidayHtml}</div>`:''}
            <div class="cal-items">${thumbs}</div>
            ${demandasHtml}
            ${inMonth?`<textarea class="cal-note">${note}</textarea>`:''}
          </div>`);
      }
      calDays.innerHTML = cells.join("");
      renderCalendarMobileDemandas(demandaMap, esc, textFilter, monthKey);
      calDays.querySelectorAll('.cal-note').forEach(el=>{
        const iso = el.closest('.cal-cell')?.getAttribute('data-iso');
        el.value = CAL_NOTES[iso] || '';
        const h = ()=> saveCalNote(el);
        el.addEventListener('change', h);
        el.addEventListener('blur', h);
      });

      // Bind clicks
      calDays.querySelectorAll(".cal-thumb").forEach(el=>{
        el.addEventListener("click",()=>{
          const id = el.getAttribute("data-id");
          const post = POSTS.find(p=>p.id===id);
          if(post) openPostModal(post);
        });
      });

      // Gera thumbnails autom√°ticas para v√≠deos
      console.log('[Calendar] Agendando applyVideoThumbnails em 100ms');
      setTimeout(() => {
        console.log("[Calendar] Executando applyVideoThumbnails agora");
        try { if (typeof applyVideoThumbnails !== "undefined") applyVideoThumbnails(); else if (typeof window.applyVideoThumbnails !== "undefined") window.applyVideoThumbnails(); } catch(_e) {}
      }, 100);
    }

    function renderPlanilha(){
      if(!feedGrid && !storiesGrid) return;
      let items = [...POSTS];
      const filt = (calFilterStatus?.value||"").trim();
      if(filt){ items = items.filter(p=>p.status===filt); }
      items.sort((a,b)=> (a.dateISO<b.dateISO?1:a.dateISO>b.dateISO?-1: (b.updatedAt||0)-(a.updatedAt||0)));

      const feedItems = items.filter(p=> (p.target||"feed") !== "stories");
      if(feedGrid){
        feedGrid.innerHTML = feedItems.map(p=>{
          const first = p.thumbUrl || p.mediaUrls?.[0] || "";
          const ext = first.split("?")[0].split(".").pop().toLowerCase();
          const isVideo = ["mp4","mov","webm","m4v","avi"].includes(ext);
          const label = p.type==="carousel" ? "C" : (isVideo ? "V" : "");
          const showCoverBtn = (p.type === 'video');
          const coverBtn = showCoverBtn ? `<button class="cover-upload-btn" type="button" data-id="${p.id}">üì∑ Capa</button>` : "";
          let cls = "feed-item";
          if(p.status === "aprovado"){
            cls += p.approvedBy === 'interno' ? " aprovado-interno" : " aprovado";
          }else if(p.status === "revisar"){
            cls += " revisar";
          }else{
            cls += " pendente";
          }
          if(first){
            if(isVideo){
              // Se j√° tem thumbUrl personalizada (capa), usa ela
              if(p.thumbUrl && !p.thumbUrl.includes('.mp4') && !p.thumbUrl.includes('.mov') && !p.thumbUrl.includes('.webm')) {
                return `<div class="${cls}" data-id="${p.id}">${coverBtn}<img src="${p.thumbUrl}" alt="" crossorigin="anonymous"></div>`;
              }
              // Sen√£o, renderiza com data-video-url para gerar thumbnail autom√°tica
              return `<div class="${cls}" data-id="${p.id}" data-video-url="${first}">${coverBtn}<span>${label||"V"}</span></div>`;
            }else{
              return `<div class="${cls}" data-id="${p.id}">${coverBtn}<img src="${first}" alt="" crossorigin="anonymous"></div>`;
            }
          }else{
            return `<div class="${cls}" data-id="${p.id}">${coverBtn}<span>${label||"+"}</span></div>`;
          }
        }).join("");
        feedGrid.querySelectorAll(".feed-item").forEach(el=>{
          el.addEventListener("click",()=>{
            const id = el.getAttribute("data-id");
            const post = POSTS.find(p=>p.id===id);
            if(post) openPostModal(post);
          });
        });
        feedGrid.querySelectorAll('.cover-upload-btn').forEach(btn=>{
          if(btn.dataset.coverBound === '1') return;
          btn.dataset.coverBound = '1';
          btn.addEventListener('click', ev=>{
            ev.stopPropagation();
            const id = btn.getAttribute('data-id');
            if(id) promptCoverUpload(id);
          });
        });
      }

      if(storiesGrid){
        const storyItems = items.filter(p=> (p.target||"feed") === "stories");
        storiesGrid.innerHTML = storyItems.map(p=>{
          const first = p.thumbUrl || p.mediaUrls?.[0] || "";
          const ext = first.split("?")[0].split(".").pop().toLowerCase();
          const isVideo = ["mp4","mov","webm","m4v","avi"].includes(ext);
          const label = p.type==="carousel" ? "C" : (isVideo ? "V" : "");
          const showCoverBtn = (p.type === 'video');
          const coverBtn = showCoverBtn ? `<button class="cover-upload-btn" type="button" data-id="${p.id}">üì∑ Capa</button>` : "";
          let cls = "story-item";
          if(p.status === "aprovado"){
            cls += p.approvedBy === 'interno' ? " aprovado-interno" : " aprovado";
          }else if(p.status === "revisar"){
            cls += " revisar";
          }else{
            cls += " pendente";
          }
          const [y,m,d] = (p.dateISO||'').split('-');
          const dateLabel = d && m ? `${d}/${m}` : '';
          if(first){
            if(isVideo){
              // Se j√° tem thumbUrl personalizada (capa), usa ela
              if(p.thumbUrl && !p.thumbUrl.includes('.mp4') && !p.thumbUrl.includes('.mov') && !p.thumbUrl.includes('.webm')) {
                return `<div class="${cls}" data-id="${p.id}">${coverBtn}<img src="${p.thumbUrl}" alt="" crossorigin="anonymous"><div class="story-date">${dateLabel}</div></div>`;
              }
              // Sen√£o, renderiza com data-video-url para gerar thumbnail autom√°tica
              return `<div class="${cls}" data-id="${p.id}" data-video-url="${first}">${coverBtn}<span>${label||"V"}</span><div class="story-date">${dateLabel}</div></div>`;
            }else{
              return `<div class="${cls}" data-id="${p.id}">${coverBtn}<img src="${first}" alt="" crossorigin="anonymous"><div class="story-date">${dateLabel}</div></div>`;
            }
          }else{
            return `<div class="${cls}" data-id="${p.id}">${coverBtn}<span>${label||"+"}</span><div class="story-date">${dateLabel}</div></div>`;
          }
        }).join("");
        storiesGrid.querySelectorAll(".story-item").forEach(el=>{
          el.addEventListener("click",()=>{
            const id = el.getAttribute("data-id");
            const post = POSTS.find(p=>p.id===id);
            if(post) openPostModal(post);
          });
        });
        storiesGrid.querySelectorAll('.cover-upload-btn').forEach(btn=>{
          if(btn.dataset.coverBound === '1') return;
          btn.dataset.coverBound = '1';
          btn.addEventListener('click', ev=>{
            ev.stopPropagation();
            const id = btn.getAttribute('data-id');
            if(id) promptCoverUpload(id);
          });
        });
      }
    }

      // Gera thumbnails autom√°ticas para v√≠deos no feed e stories
      setTimeout(() => { if(typeof applyVideoThumbnails !== "undefined") applyVideoThumbnails(); else if(typeof window.applyVideoThumbnails !== "undefined") window.applyVideoThumbnails(); }, 150);

    async function saveCalNote(el){
      const iso = el.closest('.cal-cell')?.getAttribute('data-iso');
      const uid = auth.currentUser?.uid;
      if(!iso || !uid) return;
      const clientKey = (typeof window.TENANT === 'string' && window.TENANT)
        || document.body.getAttribute('data-client-id');
      if (!clientKey || clientKey === 'no-client') {
        console.warn('Cliente n√£o definido na URL.');
        return;
      }
      const note = el.value.trim();
      const ref = doc(db, 'usuarios', uid, 'clients', clientKey, 'calendarNotes', iso);
      try{
        if(note){
          await setDoc(ref, { note, updatedAt: Date.now() }, { merge:true });
        }else{
          await deleteDoc(ref);
        }
      }catch(err){ console.error('saveCalNote', err); }
    }

    function subscribeCalNotes(){
      const uid = auth.currentUser?.uid;
      if(!uid) return;
      const clientKey = (typeof window.TENANT === 'string' && window.TENANT)
        || document.body.getAttribute('data-client-id');
      if (!clientKey || clientKey === 'no-client') {
        console.warn('Cliente n√£o definido na URL.');
        return;
      }
      try{ calNotesUnsub && calNotesUnsub(); }catch(_){ }
      const col = collection(db, 'usuarios', uid, 'clients', clientKey, 'calendarNotes');
      calNotesUnsub = onSnapshot(col, snap=>{
        CAL_NOTES = {};
        snap.forEach(docSnap=>{
          const d = docSnap.data() || {};
          if(d.note) CAL_NOTES[docSnap.id] = d.note;
        });
        renderCalendarDays();
        refreshStorageUsage();
      }, err=> console.error('onSnapshot calNotes', err));
    }

    function subscribePosts(){
      const uid = auth.currentUser?.uid; if(!uid) return;
      try{ postsUnsub && postsUnsub(); }catch(_){}
      const col = collection(db, "usuarios", uid, "posts");
      const qy = query(col, orderBy("dateISO","asc")); // sem √≠ndice composto
      postsUnsub = onSnapshot(qy, snap=>{
        POSTS = [];
        snap.forEach(docSnap => {
          const d = docSnap.data() || {};
          POSTS.push({
            id: docSnap.id,
            dateISO: d.dateISO||"",
            desc: d.desc||"",
            mediaUrls: d.mediaUrls||[],
            thumbUrl: d.thumbUrl||"",
            type: d.type||"",
            status: d.status||"pendente",
            target: d.target||"feed",
            reviewNotes: d.reviewNotes||[],
            approvedSlides: d.approvedSlides||[],
            internalApprovedSlides: d.internalApprovedSlides||[],
            approvedBy: d.approvedBy||"",
            createdAt: d.createdAt?.toMillis?.()||0,
            updatedAt: d.updatedAt?.toMillis?.()||0,
            mediaMeta: Array.isArray(d.mediaMeta) ? d.mediaMeta : [],
            coverMeta: d.coverMeta && typeof d.coverMeta === 'object' ? d.coverMeta : null,
            tenant: d.tenant || '',
            googleEventId: d.googleEventId || ''
          });
        });
        renderCalendarDays();
        renderPlanilha();
        refreshStorageUsage();
        try{ refreshMacroInsights(); }catch(_){ }
        if(window.googleCalendarIntegration){
          window.googleCalendarIntegration.notifyPostsLoaded(POSTS);
        }
        try{ scheduleNotificationRefresh({ immediate: true }); }catch(_err){}
      }, err=> console.error("onSnapshot posts", err));
    }

    async function handleUpload(){
      const btn = calUpload;
      try{
        const uid = auth.currentUser?.uid; if(!uid) return alert("Fa√ßa login.");
        const dateISO = (calDate.value||"").trim() || localDateISO(new Date());
        const desc = (calDesc.value||"").trim();
        const target = (calTarget.value||"feed");
        const files = calFiles.files;
        if(!files || files.length===0) return alert("Selecione ao menos 1 m√≠dia.");

        // whitelist de formatos
        const okExt = ["jpg","jpeg","png","mp4","mov"];
        for(let i=0;i<files.length;i++){
          const f = files[i];
          const ext = (f.name.split(".").pop()||"").toLowerCase();
          const mime = (f.type||"").toLowerCase();
          const isImage = mime.startsWith("image/");
          const isVideo = mime.startsWith("video/");
          if(!okExt.includes(ext) || (!isImage && !isVideo)){
            return alert("Formato n√£o suportado. Use JPG, JPEG, PNG, MP4 ou MOV.");
          }
        }

        if(!db) return alert("Banco de dados n√£o inicializado.");
        if(!STORAGE){ try{ STORAGE = getStorage(app); }catch(e){ console.error(e); return alert("Storage n√£o inicializado."); } }

        btn && (btn.disabled=true, btn.textContent="Enviando...");
        const safeTenant = (typeof TENANT!=="undefined" && TENANT) ? TENANT : null;
        if (!safeTenant || safeTenant === 'no-client') {
          console.warn('Cliente n√£o definido na URL.');
          btn && (btn.disabled=false, btn.textContent='Enviar');
          return;
        }
        const col = collection(db, "usuarios", uid, "posts");
        const newRef = await addDoc(col, { dateISO, desc, mediaUrls: [], thumbUrl: "", type: files.length>1 ? "carousel" : guessType(files[0]?.name||""), status: "pendente", target, createdAt: serverTimestamp(), updatedAt: serverTimestamp(), tenant: safeTenant });

        const urls = [];
        const mediaMeta = [];
        let thumb = "";
        for(let i=0;i<files.length;i++){
          const f = files[i];
          const safe = (f.name||'file').replace(/[^a-zA-Z0-9._-]/g,'_');
          const path = `users/${uid}/tenant-${safeTenant}/posts/${newRef.id}/${Date.now()}_${safe}`;
          const r = sRef(STORAGE, path);
          await uploadBytes(r, f);
          const url = await getDownloadURL(r);
          urls.push(url);
          const sizeValue = Number(f?.size);
          mediaMeta.push({
            path,
            size: Number.isFinite(sizeValue) && sizeValue > 0 ? sizeValue : null,
            contentType: f?.type || ''
          });
          if(!thumb) thumb = url;
        }
        await updateDoc(newRef, { mediaUrls: urls, thumbUrl: thumb, mediaMeta, updatedAt: serverTimestamp() });
        if(window.googleCalendarIntegration){
          const newPost = {
            id: newRef.id,
            dateISO,
            desc,
            target,
            status: 'pendente',
            googleEventId: '',
            tenant: safeTenant
          };
          try{ await window.googleCalendarIntegration.handlePostCreated(newPost); }
          catch(err){ console.warn('googleCalendarIntegration.handlePostCreated', err); }
        }
        sendWebhook('calendar', { action:'upload', id: newRef.id, dateISO, desc, target, mediaUrls: urls, thumbUrl: thumb });
        calFiles.value=""; calDesc.value=""; if(calTarget) calTarget.value="feed";
        alert("Post cadastrado!");
        await refreshStorageUsage();
      }catch(e){
        console.error("upload error", e);
        const msg = (e && (e.message||e.code)) ? (e.message||e.code) : String(e);
        alert("Falha no upload: "+ msg);
      }finally{
        btn && (btn.disabled=false, btn.textContent="Enviar");
      }
    }
    function guessType(name){
      const ext = (name.split(".").pop()||"").toLowerCase();
      if(["mp4","mov","webm","m4v","avi"].includes(ext)) return "video";
      return "image";
    }

    function openPostModal(post){
      selectedPost = post;
      SLIDES = Array.isArray(post.mediaUrls) && post.mediaUrls.length ? post.mediaUrls.slice() : [post.thumbUrl || (post.mediaUrls?.[0]||"")];
      SLIDE_IDX = 0;
      APPROVED_CLIENT_SET = new Set(Array.isArray(post.approvedSlides)? post.approvedSlides : []);
      APPROVED_INTERNAL_SET = new Set(Array.isArray(post.internalApprovedSlides)? post.internalApprovedSlides : []);
      REVIEWED_SET = new Set(Array.isArray(post.reviewedSlides)? post.reviewedSlides : (Array.isArray(post.reviewNotes)? post.reviewNotes.map(n=> Number.isInteger(n.slide)? n.slide : null).filter(n=> Number.isInteger(n)) : []));
      selectedPost.approvedSlides = Array.from(APPROVED_CLIENT_SET);
      selectedPost.internalApprovedSlides = Array.from(APPROVED_INTERNAL_SET);

      modalTitle.textContent = post.desc ? (post.desc.slice(0,60)+(post.desc.length>60?"‚Ä¶":"")) : "Post";
      modalDate.textContent = post.dateISO || "";
      modalDesc.value = post.desc || "";
      setModalStatus(post.status||"pendente");

      function renderSlide(){
        const url = SLIDES[SLIDE_IDX] || "";
        const ext = (url.split("?")[0].split(".").pop()||"").toLowerCase();
        const isVideo = ["mp4","mov","webm","m4v","avi"].includes(ext);
        const hasMany = SLIDES.length > 1;
        let arrows = hasMany ? `<div class="pv-arrow left" id="pvLeft">‚Äπ</div><div class="pv-arrow right" id="pvRight">‚Ä∫</div>` : "";
        const approvals = [];
        if(APPROVED_CLIENT_SET.has(SLIDE_IDX)) approvals.push('cliente');
        if(APPROVED_INTERNAL_SET.has(SLIDE_IDX)) approvals.push('time interno');
        const approvalInfo = approvals.length ? `‚úîÔ∏è aprovado (${approvals.join(' + ')})` : '';
        modalPreview.innerHTML = `<div class="pv-stage"><div class="pv-media">${isVideo?`<video src="${url}" controls playsinline crossorigin="anonymous"></video>`:`<img src="${url}" alt="" crossorigin="anonymous">`}</div>${arrows}</div><div class=\"muted\" style=\"margin-top:6px;display:flex;justify-content:space-between\"><span>Item ${SLIDE_IDX+1}/${SLIDES.length}</span><span>${approvalInfo}</span></div>`;
        modalPreview.classList.toggle('pv-has-many', hasMany);
        // render historic only on first slide
        const cn = document.getElementById('clientNotesList');
        if(cn){ if(SLIDE_IDX===0){ cn.style.display='block'; renderClientNotesInCard(selectedPost); } else { cn.style.display='none'; } }
        // bind arrows
        const L = document.getElementById("pvLeft"), R = document.getElementById("pvRight");
        if(L) L.onclick = ()=>{ SLIDE_IDX = (SLIDE_IDX>0? SLIDE_IDX-1 : 0); renderSlide(); syncApproveButtons(); };
        if(R) R.onclick = ()=>{ SLIDE_IDX = (SLIDE_IDX<SLIDES.length-1? SLIDE_IDX+1 : SLIDE_IDX); renderSlide(); syncApproveButtons(); };
        syncApproveButtons();
      }

      function syncApproveButtons(){
        const total = SLIDES.length;
        if(btnApprove){
          const aprovados = APPROVED_CLIENT_SET.size;
          if(APPROVED_CLIENT_SET.has(SLIDE_IDX)){
            btnApprove.textContent = `Cliente aprovou (${aprovados}/${total})`;
            btnApprove.disabled = true;
          }else{
            const nextCount = aprovados + 1;
            const lastPending = (nextCount===total);
            btnApprove.textContent = lastPending? `Cliente aprovar e finalizar (${nextCount}/${total})` : `Cliente aprovar (${nextCount}/${total})`;
            btnApprove.disabled = false;
          }
        }
        if(btnApproveInternal){
          const aprovadosInternos = APPROVED_INTERNAL_SET.size;
          const internalComplete = ((aprovadosInternos >= total) && total>0) || selectedPost?.approvedBy === 'interno';
          if(APPROVED_INTERNAL_SET.has(SLIDE_IDX)){
            btnApproveInternal.textContent = `Time interno aprovou (${aprovadosInternos}/${total})`;
            btnApproveInternal.disabled = true;
          }else{
            const nextInternal = aprovadosInternos + 1;
            const lastInternal = (nextInternal===total);
            btnApproveInternal.textContent = lastInternal? `Aprova√ß√£o interna e finalizar (${nextInternal}/${total})` : `Aprova√ß√£o interna (${nextInternal}/${total})`;
            btnApproveInternal.disabled = false;
          }
          btnApproveInternal.classList.toggle('btn-interno-concluido', internalComplete);
        }
      }

      // exp√µe helpers dentro do escopo
      openPostModal._renderSlide = renderSlide;
      openPostModal._syncApproveButtons = syncApproveButtons;

      renderSlide();
      postModal.classList.add("show"); postModal.setAttribute("aria-hidden","false");
      renderReviewNotes(post);
      renderClientNotesPanel(post);
    }
    function closePostModal(){ postModal.classList.remove("show"); postModal.setAttribute("aria-hidden","true"); selectedPost=null; }
    modalClose.onclick = closePostModal;
    postModal.addEventListener("click",(e)=>{ if(e.target===postModal) closePostModal(); });

    function setModalStatus(s){
      modalStatus.textContent = s;
      const approvedBy = selectedPost?.approvedBy || "";
      const statusClass = s === "aprovado"
        ? (approvedBy === "interno" ? "status-aprovado-interno" : "status-aprovado")
        : (s === "revisar" ? "status-revisar" : "status-pendente");
      modalStatus.className = "status-pill " + statusClass;
    }

    async function updatePostStatus(post, status){
      try{
        const uid = auth.currentUser?.uid; if(!uid) return;
        const ref = doc(db, "usuarios", uid, "posts", post.id);
        await updateDoc(ref, { status, updatedAt: serverTimestamp() });
        if(status === 'aprovado' || status === 'revisar'){
          const payload = { action:'status', id: post.id, status };
          if(status === 'revisar'){
            payload.dateISO = post.dateISO || '';
            payload.postName = post.desc || '';
            payload.postDesc = post.desc || '';
            payload.reviewNotes = Array.isArray(post.reviewNotes) ? post.reviewNotes.map(n => n.text) : [];
          }
          sendWebhook('calendar', payload);
        }
        post.status = status;
        if(selectedPost && selectedPost.id===post.id){ setModalStatus(status); }
        if(window.googleCalendarIntegration){
          try{ await window.googleCalendarIntegration.handlePostUpdated(post); }
          catch(err){ console.warn('googleCalendarIntegration.handlePostUpdated', err); }
        }
      }catch(e){ console.error(e); alert("Falha ao atualizar status: "+(e.message||String(e))); }
    }
    async function savePostMeta(post, desc, target){
      try{
        const uid = auth.currentUser?.uid; if(!uid) return;
        const ref = doc(db, "usuarios", uid, "posts", post.id);
        await updateDoc(ref, { desc: desc||"", target: target||"feed", updatedAt: serverTimestamp() });
        post.desc = desc||"";
        post.target = target||"feed";
        if(window.googleCalendarIntegration){
          try{ await window.googleCalendarIntegration.handlePostUpdated(post); }
          catch(err){ console.warn('googleCalendarIntegration.handlePostUpdated', err); }
        }
      }catch(e){ console.error(e); alert("Falha ao salvar: "+(e.message||String(e))); }
    }
    async function deletePost(post){
      if(!confirm("Excluir este post?")) return;
      try{
        const uid = auth.currentUser?.uid; if(!uid) return;
        const ref = doc(db, "usuarios", uid, "posts", post.id);
        if(window.googleCalendarIntegration){
          try{ await window.googleCalendarIntegration.handlePostDeleted(post); }
          catch(err){ console.warn('googleCalendarIntegration.handlePostDeleted', err); }
        }
        await deleteDoc(ref);
        if(selectedPost?.id===post.id) closePostModal();
      }catch(e){ console.error(e); alert("Falha ao excluir: "+(e.message||String(e))); }
    }

    async function approveSlide(kind){
      if(!selectedPost) return;
      try{
        const uid = auth.currentUser?.uid; if(!uid) return;
        const ref = doc(db, "usuarios", uid, "posts", selectedPost.id);
        const payload = { updatedAt: serverTimestamp() };
        const isInternal = kind === 'interno';
        if(isInternal){
          payload.internalApprovedSlides = arrayUnion(SLIDE_IDX);
        }else{
          payload.approvedSlides = arrayUnion(SLIDE_IDX);
        }
        await updateDoc(ref, payload);

        const targetSet = isInternal ? APPROVED_INTERNAL_SET : APPROVED_CLIENT_SET;
        targetSet.add(SLIDE_IDX);
        if(isInternal){
          selectedPost.internalApprovedSlides = Array.from(targetSet);
        }else{
          selectedPost.approvedSlides = Array.from(targetSet);
        }

        const totalSlides = SLIDES.length;
        const fullyApproved = (APPROVED_CLIENT_SET.size >= totalSlides) || (APPROVED_INTERNAL_SET.size >= totalSlides);
        if(fullyApproved){
          await updateDoc(ref, { status: "aprovado", updatedAt: serverTimestamp(), approvedBy: isInternal ? 'interno' : 'cliente' });
          selectedPost.status = "aprovado";
          selectedPost.approvedBy = isInternal ? 'interno' : 'cliente';
          sendWebhook('calendar', { action:'status', id: selectedPost.id, status: 'aprovado', approvedBy: isInternal ? 'interno' : 'cliente' });
          setModalStatus("aprovado");
          if(window.googleCalendarIntegration){
            try{ await window.googleCalendarIntegration.handlePostUpdated(selectedPost); }
            catch(err){ console.warn('googleCalendarIntegration.handlePostUpdated', err); }
          }
          if(typeof mgToast === 'function'){
            mgToast(isInternal ? 'Post aprovado pelo time interno.' : 'Post aprovado pelo cliente.');
          }
        }else{
          // avan√ßa para o pr√≥ximo slide n√£o aprovado dentro do contexto atual
          let next = SLIDE_IDX;
          for(let i=0;i<SLIDES.length;i++){
            const j = (SLIDE_IDX + 1 + i) % SLIDES.length;
            if(!targetSet.has(j)){ next = j; break; }
          }
          SLIDE_IDX = next;
        }
        if(typeof openPostModal._renderSlide === "function"){ openPostModal._renderSlide(); }
        if(typeof openPostModal._syncApproveButtons === "function"){ openPostModal._syncApproveButtons(); }
      }catch(e){
        console.error(e);
        alert("Falha ao aprovar: " + (e.message||String(e)));
      }
    }
    if(btnApprove) btnApprove.onclick = ()=> approveSlide('cliente');
    if(btnApproveInternal) btnApproveInternal.onclick = ()=> approveSlide('interno');

    async function generateCalendarShare(){
      const btn = btnShareCalendar;
      if(!db){
        alert('Banco de dados n√£o inicializado.');
        return;
      }
      if(btn){
        btn.disabled = true;
        btn.textContent = 'Gerando link...';
      }
      try {
        if(!auth?.currentUser){
          throw new Error('Fa√ßa login para compartilhar o calend√°rio.');
        }
        const user = auth.currentUser;
        const clientKey = getClientKey();
        if(!clientKey || clientKey === 'no-client'){
          throw new Error('Cliente n√£o identificado. Abra a plataforma usando o link do cliente.');
        }
        const safeKey = getSafeClientKey() || normalizeClientKey(clientKey);
        if(!safeKey){
          throw new Error('N√£o foi poss√≠vel determinar o identificador do cliente.');
        }
        const monthRef = (currentMonth instanceof Date) ? new Date(currentMonth.getTime()) : new Date();
        const year = monthRef.getFullYear();
        const monthIndex = monthRef.getMonth();
        const monthKey = buildMonthKey(year, monthIndex + 1);
        const safeTenantLower = safeKey.toLowerCase();
        const postsInMonth = Array.isArray(POSTS) ? POSTS.filter(p => {
          if(!p || !p.dateISO) return false;
          if(p.dateISO.slice(0,7) !== monthKey) return false;
          const tenant = (p.tenant || '').toLowerCase();
          return !tenant || tenant === safeTenantLower;
        }) : [];
        if(postsInMonth.length === 0){
          const proceed = confirm('Nenhum post cadastrado neste m√™s. Deseja mesmo gerar o link do calend√°rio?');
          if(!proceed){
            return;
          }
        }
        const token = (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : uuid();
        const timestamp = serverTimestamp();
        const postsCollectionPath = ['usuarios', user.uid, 'posts'];
        const postSummaries = postsInMonth.map(post => {
          const media = Array.isArray(post.mediaUrls) ? post.mediaUrls.filter(Boolean) : [];
          return {
            id: post.id,
            dateISO: post.dateISO || '',
            desc: post.desc || '',
            target: post.target || 'feed',
            status: post.status || 'pendente',
            approvedBy: post.approvedBy || '',
            type: post.type || '',
            thumbUrl: post.thumbUrl || '',
            mediaUrls: media.slice(0, 12),
            approvedSlides: Array.isArray(post.approvedSlides) ? post.approvedSlides : [],
            tenant: post.tenant || '',
            postDocPath: ['usuarios', user.uid, 'posts', post.id]
          };
        });
        const docRef = doc(db, 'calendarShares', token);
        const docData = {
          token,
          uid: user.uid,
          userEmail: user.email || '',
          clientKey,
          clientKeyNormalized: safeKey,
          clientLabel: formatClientDisplayName(clientKey) || clientKey,
          tenant: safeKey,
          monthKey,
          monthLabel: monthLabel(monthRef),
          monthYear: year,
          monthNumber: monthIndex + 1,
          monthStartISO: localDateISO(new Date(year, monthIndex, 1)),
          postsCollectionPath,
          postIds: postSummaries.map(p => p.id),
          postsCount: postSummaries.length,
          postSummaries,
          createdAt: timestamp,
          updatedAt: timestamp,
          lastAction: 'share-created',
          lastActionAt: timestamp
        };
        await setDoc(docRef, docData);
        const shareUrl = buildCalendarShareLink(token, safeKey, clientKey, monthKey);
        
        // Copiar com fallback robusto para iframes
        const copied = await mgCopyToClipboard(shareUrl);
        
        if(copied){
          if(typeof mgToast === 'function'){
            mgToast('Link do calend√°rio copiado! Compartilhe com o cliente.');
          }else{
            alert('Link copiado! Compartilhe com o cliente.');
          }
        }else{
          prompt('Link do calend√°rio gerado. Copie para enviar ao cliente:', shareUrl);
        }
        sendWebhook('calendar', {
          action: 'share-link',
          token,
          monthKey,
          postsCount: postSummaries.length
        });
      }catch(err){
        console.error('generateCalendarShare', err);
        alert(err?.message || 'N√£o foi poss√≠vel gerar o link do calend√°rio.');
      }finally{
        if(btn){
          btn.disabled = false;
          btn.textContent = 'Compartilhar calend√°rio';
        }
      }
    }

    async function generatePlanningShare(){
      const btn = btnCopyPlanningLink;
      if(!db){
        alert('Banco de dados n√£o inicializado.');
        return;
      }
      if(btn){
        btn.disabled = true;
        btn.textContent = 'Gerando link...';
      }
      try {
        if(!auth?.currentUser){
          throw new Error('Fa√ßa login para compartilhar o planejamento.');
        }
        const user = auth.currentUser;
        const clientKey = getClientKey();
        if(!clientKey || clientKey === 'no-client'){
          throw new Error('Cliente n√£o identificado. Abra a plataforma usando o link do cliente.');
        }
        const safeKey = getSafeClientKey() || normalizeClientKey(clientKey);
        if(!safeKey){
          throw new Error('N√£o foi poss√≠vel determinar o identificador do cliente.');
        }
        const today = new Date();
        const year = today.getFullYear();
        const monthIndex = today.getMonth();
        const monthKey = buildMonthKey(year, monthIndex + 1);
        const monthDate = new Date(`${monthKey}-01T00:00:00`);
        const monthLabelText = monthLabel(monthDate);
        const monthStart = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
        const monthEnd = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0);
        const metaMonthKey = META_MONTHS[monthDate.getMonth()] || META_MONTHS[monthIndex];
        const plan = normalizeMonthPlan(monthKey) || {};
        const objectiveNotes = plan.objectiveNotes && typeof plan.objectiveNotes === 'object' ? plan.objectiveNotes : {};
        const statusMap = new Map(STATUS_OPTIONS.map(opt => [opt.value, opt]));
        const rawDemandas = Array.isArray(DEMANDAS) ? DEMANDAS.filter(d => getDemandMonthKeys(d).includes(monthKey)) : [];
        const monthDemandas = sortDemandasForMonth(rawDemandas);
        const toDisplayText = value => typeof value === 'string' ? htmlStringToText(value).trim() : '';
        const objectives = monthDemandas.map((d, idx) => {
          normalizeDemanda(d);
          const statusInfo = statusMap.get(d.status) || {};
          const startDate = getDemandaStartDate(d);
          const endDate = getDemandaEndDate(d);
          const startISO = startDate ? localDateISO(startDate) : '';
          const endISO = endDate ? localDateISO(endDate) : (startISO || '');
          const periodoTexto = formatPrazoLabel(d) || 'Prazo n√£o definido';
          const planDetails = [];
          PLAN_TYPES.forEach(({key, label}) => {
            const planRaw = d.planos?.[key];
            const text = planRaw ? toDisplayText(planRaw) : '';
            if(text){
              planDetails.push({ key, label, text });
            }
          });
          const noteHtml = objectiveNotes[d.id];
          const noteText = noteHtml ? toDisplayText(noteHtml) : '';
          return {
            id: d.id || `obj-${idx}`,
            order: idx + 1,
            title: (d.demanda || '').trim() || 'Objetivo sem t√≠tulo',
            responsavel: d.responsavel || 'N√£o definido',
            status: d.status || '',
            statusLabel: statusInfo.label || 'Sem status',
            statusColor: statusInfo.color || '',
            periodo: {
              inicioISO: startISO,
              fimISO: endISO,
              texto: periodoTexto
            },
            planDetails,
            note: noteText
          };
        });
        const counts = {
          total: objectives.length,
          completed: 0,
          inProgress: 0,
          blocked: 0,
          priority: 0,
          notStarted: 0
        };
        objectives.forEach(obj => {
          switch(obj.status){
            case 'concluido':
            case 'concluido-grupo':
              counts.completed += 1;
              break;
            case 'em-andamento':
              counts.inProgress += 1;
              break;
            case 'bloqueado':
              counts.blocked += 1;
              break;
            case 'prioridade':
            case 'prioridade-grupo':
              counts.priority += 1;
              break;
            case 'nao-iniciado':
              counts.notStarted += 1;
              break;
            default:
              break;
          }
        });
        const timeline = [];
        const addTimelineEntry = (demanda, kind, date) => {
          if(!date) return;
          const dateISO = localDateISO(date);
          const statusInfo = statusMap.get(demanda.status) || {};
          timeline.push({
            id: `${demanda.id || demanda.demanda || dateISO}-${kind}`,
            objectiveId: demanda.id || '',
            objectiveTitle: (demanda.demanda || '').trim() || 'Objetivo sem t√≠tulo',
            kind,
            label: kind === 'start' ? 'In√≠cio' : 'Entrega',
            dateISO,
            status: demanda.status || '',
            statusLabel: statusInfo.label || '',
            responsavel: demanda.responsavel || '',
            periodo: formatPrazoLabel(demanda) || ''
          });
        };
        monthDemandas.forEach(d => {
          const start = getDemandaStartDate(d);
          const end = getDemandaEndDate(d);
          if(start){
            addTimelineEntry(d, 'start', start);
          }
          if(end && (!start || end.getTime() !== start.getTime())){
            addTimelineEntry(d, 'end', end);
          }
        });
        timeline.sort((a, b) => {
          if(a.dateISO && b.dateISO){
            const diff = a.dateISO.localeCompare(b.dateISO);
            if(diff !== 0) return diff;
          } else if(a.dateISO){
            return -1;
          } else if(b.dateISO){
            return 1;
          }
          return a.objectiveTitle.localeCompare(b.objectiveTitle);
        });
        const activeMetas = Array.isArray(METAS) ? METAS.filter(meta => meta && meta.ativo !== false) : [];
        const findMetaByTag = tag => activeMetas.find(meta => (meta.tag || '') === tag);
        const parseMetaNumber = (meta, field) => {
          if(!meta || !meta.meses) return null;
          const raw = meta.meses?.[metaMonthKey]?.[field];
          if(raw === '' || raw === undefined || raw === null) return null;
          const num = Number(raw);
          return Number.isFinite(num) ? num : null;
        };
        const currencyCode = (CAC_DATA?.currency || 'BRL').toUpperCase();
        const formatCurrencyValue = value => {
          if(!Number.isFinite(value)) return '';
          const locale = currencyCode === 'USD' ? 'en-US' : 'pt-BR';
          return new Intl.NumberFormat(locale, {
            style: 'currency',
            currency: currencyCode,
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          }).format(value);
        };
        const investmentMeta = findMetaByTag('investimento_publicidade');
        let plannedBudget = parseMetaNumber(investmentMeta, 'p');
        let actualBudget = parseMetaNumber(investmentMeta, 'r');
        let budgetSource = 'meta';
        if(!Number.isFinite(plannedBudget) && !Number.isFinite(actualBudget)){
          const expenses = CAC_DATA?.expenses?.[monthKey];
          if(Array.isArray(expenses)){
            const trafficRow = expenses.find(row => typeof row?.desc === 'string' && row.desc.toLowerCase().includes('tr√°f'));
            if(trafficRow){
              const val = Number(trafficRow.val);
              if(Number.isFinite(val)){
                plannedBudget = val;
                actualBudget = val;
                budgetSource = 'cac';
              }
            }
          }
        }
        const plannedBudgetDisplay = formatCurrencyValue(plannedBudget);
        const actualBudgetDisplay = formatCurrencyValue(actualBudget);
        const kpis = [];
        const pushMetaKpi = meta => {
          if(!meta) return;
          const targetVal = parseMetaNumber(meta, 'p');
          const currentVal = parseMetaNumber(meta, 'r');
          if(!Number.isFinite(targetVal) && !Number.isFinite(currentVal)) return;
          const unit = (meta.unidade || '').toLowerCase();
          const formatValue = value => {
            if(!Number.isFinite(value)) return '';
            if(unit === 'brl'){
              return formatCurrencyValue(value);
            }
            if(unit === '%'){
              return `${value.toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 2 })}%`;
            }
            return value.toLocaleString('pt-BR', { maximumFractionDigits: 2 });
          };
          kpis.push({
            label: meta.descricao || 'Indicador',
            unit: meta.unidade || '',
            targetValue: Number.isFinite(targetVal) ? targetVal : null,
            targetDisplay: formatValue(targetVal),
            currentValue: Number.isFinite(currentVal) ? currentVal : null,
            currentDisplay: formatValue(currentVal)
          });
        };
        pushMetaKpi(findMetaByTag('roas_publicidade'));
        pushMetaKpi(findMetaByTag('leads_gerados') || findMetaByTag('leads_novos'));
        pushMetaKpi(findMetaByTag('taxa_mql'));
        const planSections = {};
        PLAN_TYPES.forEach(({key, label}) => {
          const raw = plan?.[key];
          const text = raw ? toDisplayText(raw) : '';
          planSections[key] = { label, text };
        });
        const firstStrategicLine = planSections.estrategico?.text
          ? planSections.estrategico.text.split(/\n+/).map(line => line.trim()).find(Boolean)
          : '';
        let adsObjective = firstStrategicLine || 'Gerar demanda qualificada com campanhas de m√≠dia.';
        if(adsObjective && adsObjective.length){
          adsObjective = adsObjective.replace(/\s+/g, ' ');
        }
        const firstTimelineEntry = timeline.find(item => item.dateISO);
        const lastTimelineEntry = [...timeline].reverse().find(item => item.dateISO);
        const formatDayMonth = iso => {
          if(!iso) return '';
          const dt = new Date(`${iso}T00:00:00`);
          if(Number.isNaN(dt.getTime())) return '';
          return dt.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        };
        let scheduleText = '';
        if(firstTimelineEntry && lastTimelineEntry){
          const startLabel = formatDayMonth(firstTimelineEntry.dateISO);
          const endLabel = formatDayMonth(lastTimelineEntry.dateISO);
          if(startLabel && endLabel){
            scheduleText = startLabel === endLabel
              ? `Ativa√ß√µes concentradas em ${startLabel}.`
              : `Execu√ß√£o prevista de ${startLabel} at√© ${endLabel}.`;
          }
        }
        if(!scheduleText){
          scheduleText = 'Cronograma distribu√≠do ao longo do m√™s para manter ritmo de entregas e aprendizado cont√≠nuo.';
        }
        const googleAdsPlan = {
          objective: adsObjective,
          budget: {
            currency: currencyCode,
            plannedValue: Number.isFinite(plannedBudget) ? plannedBudget : null,
            actualValue: Number.isFinite(actualBudget) ? actualBudget : null,
            plannedDisplay: plannedBudgetDisplay,
            actualDisplay: actualBudgetDisplay,
            source: budgetSource
          },
          kpis,
          schedule: scheduleText
        };
        const buildPlanningSummary = () => {
          const parts = [];
          const total = counts.total || 0;
          if(total > 0){
            parts.push(`O planejamento de ${monthLabelText} organiza ${total} objetivo${total > 1 ? 's' : ''} priorit√°rio${total > 1 ? 's' : ''} para o m√™s.`);
          }else{
            parts.push(`Ainda n√£o h√° objetivos registrados para ${monthLabelText}. Utilize este plano para alinhar prioridades e demandas com o cliente.`);
          }
          if(counts.completed){
            parts.push(`${counts.completed} conclu√≠do${counts.completed > 1 ? 's' : ''} at√© o momento.`);
          }
          if(counts.inProgress){
            parts.push(`${counts.inProgress} em andamento com acompanhamento semanal.`);
          }
          if(counts.priority){
            parts.push(`${counts.priority} demanda${counts.priority > 1 ? 's' : ''} marcada${counts.priority > 1 ? 's' : ''} como prioridade da equipe.`);
          }
          if(counts.blocked){
            parts.push(`Aten√ß√£o a ${counts.blocked} item${counts.blocked > 1 ? 's' : ''} com bloqueios pendentes.`);
          }
          if(googleAdsPlan.objective){
            parts.push(`No Google Ads, foco em ${googleAdsPlan.objective.toLowerCase()}.`);
          }
          return parts.join(' ');
        };
        const summary = buildPlanningSummary();
        const token = (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : uuid();
        const timestamp = serverTimestamp();
        const docRef = doc(db, 'planningShares', token);
        const docData = {
          token,
          uid: user.uid,
          userEmail: user.email || '',
          clientKey,
          clientKeyNormalized: safeKey,
          clientLabel: formatClientDisplayName(clientKey) || clientKey,
          tenant: safeKey,
          monthKey,
          monthLabel: monthLabelText,
          monthYear: year,
          monthNumber: monthIndex + 1,
          monthStartISO: localDateISO(monthStart),
          monthEndISO: localDateISO(monthEnd),
          objectives,
          objectivesSummary: counts,
          timeline,
          planSections,
          summary,
          googleAdsPlan,
          createdAt: timestamp,
          updatedAt: timestamp,
          lastAction: 'planning-share-created',
          lastActionAt: timestamp
        };
        await setDoc(docRef, docData);
        const shareUrl = buildPlanningShareLink(token, safeKey, clientKey, monthKey);
        
        // Copiar com fallback robusto para iframes
        const copied = await mgCopyToClipboard(shareUrl);
        
        if(copied){
          if(typeof mgToast === 'function'){
            mgToast('Link do planejamento copiado! Compartilhe com o cliente.');
          }else{
            alert('Link copiado! Compartilhe com o cliente.');
          }
        }else{
          prompt('Link do planejamento gerado. Copie para enviar ao cliente:', shareUrl);
        }
        sendWebhook('demandas', {
          action: 'planning-share',
          token,
          monthKey,
          objectives: counts.total
        });
      }catch(err){
        console.error('generatePlanningShare', err);
        alert(err?.message || 'N√£o foi poss√≠vel gerar o link do planejamento.');
      }finally{
        if(btn){
          btn.disabled = false;
          btn.textContent = 'Copiar link do planejamento';
        }
      }
    }

    async function copyApprovalLinkForPost(){
      const btn = btnCopyApprovalLink;
      if(!selectedPost){
        alert('Abra um post para gerar o link de aprova√ß√£o.');
        return;
      }
      if(!auth?.currentUser){
        alert('Fa√ßa login para gerar o link de aprova√ß√£o.');
        return;
      }
      const originalLabel = btn ? btn.textContent : '';
      if(btn){
        btn.disabled = true;
        btn.textContent = 'Gerando link...';
      }
      try {
        const user = auth.currentUser;
        const clientKey = getClientKey();
        if(!clientKey || clientKey === 'no-client'){
          throw new Error('Cliente n√£o identificado. Abra a plataforma usando o link do cliente.');
        }
        const safeKey = getSafeClientKey() || normalizeClientKey(clientKey);
        const token = (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : uuid();
        const mediaList = Array.isArray(selectedPost.mediaUrls) && selectedPost.mediaUrls.length
          ? selectedPost.mediaUrls.filter(Boolean)
          : (Array.isArray(SLIDES) ? SLIDES.filter(Boolean) : []);
        const descFromModal = (modalDesc?.value || '').trim();
        const targetFromModal = (modalTarget?.value || selectedPost.target || 'feed');
        const thumbUrl = selectedPost.thumbUrl || mediaList[0] || '';
        const timestamp = serverTimestamp();
        const docData = {
          token,
          uid: user.uid,
          userEmail: user.email || '',
          clientKey,
          clientKeyNormalized: safeKey,
          clientLabel: formatClientDisplayName(clientKey) || clientKey,
          postId: selectedPost.id,
          postDocPath: ['usuarios', user.uid, 'posts', selectedPost.id],
          postDesc: descFromModal || selectedPost.desc || '',
          postTarget: targetFromModal,
          postDateISO: selectedPost.dateISO || '',
          postStatus: selectedPost.status || 'pendente',
          postApprovedBy: selectedPost.approvedBy || '',
          mediaUrls: mediaList,
          thumbUrl,
          postType: selectedPost.type || '',
          postTenant: selectedPost.tenant || safeKey || '',
          postApprovedSlides: Array.isArray(selectedPost.approvedSlides) ? selectedPost.approvedSlides : [],
          postInternalApprovedSlides: Array.isArray(selectedPost.internalApprovedSlides) ? selectedPost.internalApprovedSlides : [],
          generatedBy: {
            uid: user.uid,
            email: user.email || '',
            name: user.displayName || ''
          },
          createdAt: timestamp,
          updatedAt: timestamp,
          lastAction: 'link-created',
          lastActionAt: timestamp
        };
        if(Number.isFinite(selectedPost.createdAt)){
          docData.postCreatedAt = selectedPost.createdAt;
        }
        if(Number.isFinite(selectedPost.updatedAt)){
          docData.postUpdatedAt = selectedPost.updatedAt;
        }
        if(Array.isArray(selectedPost.reviewNotes)){
          docData.postReviewNotesCount = selectedPost.reviewNotes.length;
        }
        const docRef = doc(db, 'postApprovals', token);
        await setDoc(docRef, docData);
        const approvalUrl = buildApprovalLink(token, safeKey, clientKey);
        
        // Copiar com fallback robusto para iframes
        const copied = await mgCopyToClipboard(approvalUrl);
        
        if(copied){
          if(typeof mgToast === 'function'){
            mgToast('Link copiado! Envie ao cliente para aprovar o post.');
          }
        }else{
          prompt('Link de aprova√ß√£o gerado. Copie e envie ao cliente:', approvalUrl);
        }
        sendWebhook('calendar', {
          action: 'approval-link',
          id: selectedPost.id,
          token,
          dateISO: selectedPost.dateISO || '',
          desc: descFromModal || selectedPost.desc || ''
        });
      }catch(err){
        console.error('copyApprovalLinkForPost', err);
        alert(err?.message || 'N√£o foi poss√≠vel gerar o link de aprova√ß√£o.');
      }finally{
        if(btn){
          btn.disabled = false;
          btn.textContent = originalLabel || 'Copiar link de aprova√ß√£o';
        }
      }
    }

    if(btnReview)  btnReview.onclick  = ()=>{ if(selectedPost) openReviewPrompt(selectedPost); };
    if(btnCopyApprovalLink) btnCopyApprovalLink.onclick = ()=>{ copyApprovalLinkForPost(); };
    if(btnSave)    btnSave.onclick    = ()=>{ if(selectedPost) savePostMeta(selectedPost, modalDesc.value||"", modalTarget.value||"feed"); };
    if(btnDelete)  btnDelete.onclick  = ()=>{ if(selectedPost) deletePost(selectedPost); };

    if(calUpload) calUpload.onclick = handleUpload;
    if(btnShareCalendar) btnShareCalendar.onclick = ()=> generateCalendarShare();


    /* ======= Revis√£o: observa√ß√µes do cliente ======= */
    const reviewModal = $("reviewModal"), reviewText = $("reviewText"), reviewSend = $("reviewSend"), reviewCancel = $("reviewCancel");
    function fmtDateTime(d){
      try{
        const pad=n=>String(n).padStart(2,"0");
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }catch(_){ return ""; }
    }
    function renderClientNotesPanel(post){
      const panel = document.getElementById("clientNotesPanel");
      if(!panel) return;
      const notes = Array.isArray(post.reviewNotes)? post.reviewNotes : [];
      if(notes.length===0){
        panel.innerHTML = `<div class="muted">Sem observa√ß√µes.</div>`;
        return;
      }
      panel.innerHTML = notes.map(n=>{
        const when = n.at ? (typeof n.at==='number'? n.at : (n.at.toMillis? n.at.toMillis() : Date.parse(n.at)||Date.now())) : Date.now();
        const dt = new Date(when);
        const pad = x => String(x).padStart(2,'0');
        const dstr = `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())} ${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
        const who = (n.by||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const text = renderMarkdownText(n.text||'');
        const slide = Number.isInteger(n.slide)? ` ‚Ä¢ Slide ${n.slide+1}` : '';
        return `<div class="note-item"><div class="note-head"><span>${who||"cliente"}</span><span>‚Ä¢</span><span>${dstr}${slide}</span></div><div class="note-body markdown-view">${text}</div></div>`;
      }).join("");
    }

    function renderClientNotesInCard(post){
  const box = document.getElementById("clientNotesList");
  if(!box) return;
  const notes = Array.isArray(post.reviewNotes)? post.reviewNotes : [];
  if(notes.length===0){ box.innerHTML = `<div class="muted">Sem observa√ß√µes.</div>`; return; }
  const rows = notes.map(n=>{
    const dt = n.at?.toMillis ? new Date(n.at.toMillis()) : (typeof n.at==="number"? new Date(n.at) : (n.at? new Date(n.at): new Date()));
    const pad = x=> String(x).padStart(2,"0");
    const when = `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())} ${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
    const who = (n.by||"").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    const text = renderMarkdownText(n.text||"");
    return `<div class="client-note"><div class="dot"></div><div class="txt markdown-view">${text}<div class="meta">${who||"cliente"} ‚Ä¢ ${when}</div></div></div>`;
  }).join("");
  box.innerHTML = rows;
}

function renderReviewNotes(post){
      const box = $("notesList"); if(!box) return;
      const notes = Array.isArray(post.reviewNotes)? post.reviewNotes : [];
      if(notes.length===0){ box.innerHTML = `<div class="muted">Sem observa√ß√µes.</div>`; return; }
      box.innerHTML = notes.map(n=>{
        const when = n.at?.toMillis ? fmtDateTime(new Date(n.at.toMillis())) : (typeof n.at==="number" ? fmtDateTime(new Date(n.at)) : (n.at ? fmtDateTime(new Date(n.at)):""));
        const who = (n.by||"").replace(/</g,"&lt;").replace(/>/g,"&gt;");
        const origin = resolveReviewOrigin(n);
        const originLabel = origin === 'interno' ? 'Time interno' : 'Cliente';
        const text = renderMarkdownText(n.text||"");
        return `<div class="note-item"><div class="note-head"><span>${who||originLabel.toLowerCase()}</span><span>‚Ä¢</span><span>${when}</span><span class="origin-pill origin-${origin}">${originLabel}</span></div><div class="note-body markdown-view">${text}</div></div>`;
      }).join("");
    }
    function openReviewPrompt(post){
      selectedPost = post;
      if(reviewText) reviewText.value = "";
      if(reviewModal){ reviewModal.classList.add("show"); reviewModal.setAttribute("aria-hidden","false"); setTimeout(()=>reviewText?.focus(), 50); }
    }
    function closeReviewPrompt(){
      if(reviewModal){ reviewModal.classList.remove("show"); reviewModal.setAttribute("aria-hidden","true"); }
    }
    if(reviewCancel) reviewCancel.onclick = closeReviewPrompt;
    async function addReviewNote(post, text){
      const uid = auth.currentUser?.uid; if(!uid) return alert("Fa√ßa login.");
      const email = auth.currentUser?.email || "";
      try{
        const ref = doc(db, "usuarios", uid, "posts", post.id);
        const note = { text, by: email, uid, at: Date.now(), slide: SLIDE_IDX, origin: getCurrentReviewOrigin() };
        await updateDoc(ref, {
          status: "revisar",
          updatedAt: serverTimestamp(),
          reviewNotes: arrayUnion(note),
          lastReviewAt: serverTimestamp()
        });
        // local state
        if(!Array.isArray(post.reviewNotes)) post.reviewNotes=[];
        post.reviewNotes.push(note);
        const before = REVIEWED_SET.size;
        REVIEWED_SET.add(SLIDE_IDX);
        // close only the review modal, keep post modal open and move to next media
        closeReviewPrompt();
        // advance to next slide if exists
        if(typeof SLIDE_IDX === 'number' && Array.isArray(SLIDES)){
          if(SLIDE_IDX < SLIDES.length - 1){
            SLIDE_IDX = SLIDE_IDX + 1;
          }
        }
        // re-render media and (if on first slide) the card notes
        if(typeof openPostModal._renderSlide === "function"){ openPostModal._renderSlide(); }
        renderClientNotesInCard(post); renderReviewNotes(post);
        if(REVIEWED_SET.size === SLIDES.length && before !== SLIDES.length){
          sendWebhook('calendar', {
            action:'status',
            id: post.id,
            status: 'revisar',
            dateISO: post.dateISO || '',
            postName: post.desc || '',
            postDesc: post.desc || '',
            reviewNotes: Array.isArray(post.reviewNotes) ? post.reviewNotes.map(n => n.text) : []
          });
        }
        if(window.googleCalendarIntegration){
          try{ await window.googleCalendarIntegration.handlePostUpdated(post); }
          catch(err){ console.warn('googleCalendarIntegration.handlePostUpdated', err); }
        }
        mgToast('Observa√ß√£o salva. Avance para o pr√≥ximo item do carrossel.');
      }catch(e){ console.error(e); alert("Falha ao enviar observa√ß√£o: "+(e.message||String(e))); }
    }
    if(reviewSend) reviewSend.onclick = ()=>{
      if(!selectedPost) return;
      const text = (reviewText?.value||"").trim();
      if(!text) return alert("Descreva o que precisa ser ajustado.");
      addReviewNote(selectedPost, text);
    };

    /* scroll hint */
    let hideTimer=null;
    function hasMoreToScroll(){ const el=document.documentElement; return el.scrollHeight - (el.scrollTop + window.innerHeight) > 16; }
    function showScrollHint(){ if(!scrollHint) return; if(hasMoreToScroll()) scrollHint.classList.add("show"); }
    function hideScrollHint(){ if(!scrollHint) return; scrollHint.classList.remove("show"); }
    function showScrollHintTemporario(){ if(!scrollHint) return; showScrollHint(); clearTimeout(hideTimer); hideTimer=setTimeout(()=>scrollHint.classList.remove("show"),2000); }
    function updateScrollHint(){ if(!scrollHint) return; if(hasMoreToScroll()) showScrollHint(); else hideScrollHint(); }
    if(scrollHint){
      window.addEventListener("scroll",()=>{ hideScrollHint(); clearTimeout(hideTimer); hideTimer=setTimeout(updateScrollHint,500); });
      window.addEventListener("resize",updateScrollHint);
      document.addEventListener("DOMContentLoaded",updateScrollHint);
    }
  </script>
<!-- Modal: Pedir Revis√£o (coleta observa√ß√µes) -->
<div aria-hidden="true" class="modal" id="reviewModal">
<div aria-modal="true" class="modal-card small" role="dialog">
<div class="modal-head">
<strong>Pedir revis√£o</strong>
<button class="btn small secondary" id="reviewCancel">Fechar</button>
</div>
<div class="modal-body" style="grid-template-columns: 1fr">
<div class="info">
<label class="muted" style="display:block; margin:6px 0">Descreva o que precisa ser ajustado</label>
<textarea id="reviewText" placeholder="Ex.: trocar a m√∫sica, cortar os 3s iniciais, corrigir texto..."></textarea>
</div>
</div>
<div class="modal-foot">
<button class="btn small" id="reviewSend">Enviar observa√ß√£o</button>
</div>
</div>
    <!-- Bloco de notas simples (Objetivos do m√™s) -->
    <div class="notes-block" id="relatorioGoalsSimpleNotesWrap">
      <div class="relatorio-header" style="margin-top:10px">
        <h3>üìù Anota√ß√µes do objetivo do m√™s</h3>
      </div>
      <textarea id="relatorioGoalsNotesSimple" rows="4" placeholder="Escreva suas anota√ß√µes do objetivo do m√™s..."
        style="width:100%;background:#0f0f0f;border:1px solid #2a2a2a;color:#fff;border-radius:8px;padding:10px;resize:vertical;text-align:center;"></textarea>
      <div id="relatorioGoalsNotesSimpleStatus" style="margin-top:6px;font-size:.8rem;color:#9ca3af;text-align:right;"></div>
    </div>
</div>
<script>
  (function(){
    function fixPreviewMedia(){
      var wrap = document.getElementById('modalPreview'); if(!wrap) return;
      var vid = wrap.querySelector('video');
      if(vid){
        vid.setAttribute('playsinline','');
        vid.setAttribute('controls','');
        vid.setAttribute('webkit-playsinline','');
        vid.style.maxHeight = '56vh';
        vid.style.width = '100%';
        vid.style.height = 'auto';
      }
      var img = wrap.querySelector('img');
      if(img){
        img.style.maxHeight = '56vh';
        img.style.width = '100%';
        img.style.height = 'auto';
        img.style.objectFit = 'contain';
        img.decoding = 'async';
      }
    }
    // Run after modal content swaps
    const pm = document.getElementById('postModal');
    if(pm){
      const obs = new MutationObserver(fixPreviewMedia);
      obs.observe(pm, { childList:true, subtree:true });
    }
    // Also run on load
    document.addEventListener('DOMContentLoaded', fixPreviewMedia);
  })();
</script>
<script>
  (function(){
    var postModal = document.getElementById('postModal');
    if(!postModal) return;
    function toggleBodyLock(){
      if(postModal.classList.contains('show')){
        document.documentElement.style.overflow = 'hidden';
        document.body.style.overflow = 'hidden';
      } else {
        document.documentElement.style.overflow = '';
        document.body.style.overflow = '';
      }
    }
    var mo = new MutationObserver(toggleBodyLock);
    mo.observe(postModal, { attributes: true, attributeFilter: ['class'] });
    toggleBodyLock();
  })();
</script>
<script>
(function(){
  // fechar ao tocar fora do cart√£o
  var modals = document.querySelectorAll('.modal');
  modals.forEach(function(m){
    m.addEventListener('click', function(e){
      if(e.target === m){ m.classList.remove('show'); } // backdrop
    }, {passive:true});
  });
  // swipe down para fechar reviewModal
  var rm = document.getElementById('reviewModal');
  if(rm){
    var startY=0, delta=0;
    rm.addEventListener('touchstart', function(ev){ startY = ev.touches[0].clientY; delta=0; }, {passive:true});
    rm.addEventListener('touchmove', function(ev){ delta = ev.touches[0].clientY - startY; }, {passive:true});
    rm.addEventListener('touchend', function(){ if(delta > 80){ rm.classList.remove('show'); } }, {passive:true});
  }
})();
</script>
<script>
(function(){
  function setupReelsOverlay(){
    var pv = document.getElementById('modalPreview');
    if(!pv) return;
    // ensure container is relative
    pv.classList.add('preview');
    // find media
    var v = pv.querySelector('video');
    // If no video, remove play overlay if exists
    var existingPlay = document.getElementById('reelsPlayOverlay');
    var existingClose = document.getElementById('reelsCloseOverlay');
    if(!v){
      if(existingPlay) existingPlay.remove();
      if(existingClose) existingClose.remove();
      return;
    }
    // attributes to behave inline
    v.setAttribute('playsinline','');
    v.setAttribute('webkit-playsinline','');
    v.setAttribute('controls','');
    v.style.objectFit = 'contain';
    v.style.background = '#000';
    v.style.maxHeight = '62dvh';

    // create overlays if missing
    var play = existingPlay;
    if(!play){
      play = document.createElement('div');
      play.id = 'reelsPlayOverlay';
      pv.appendChild(play);
    }
    var closeX = existingClose;
    if(!closeX){
      closeX = document.createElement('button');
      closeX.id = 'reelsCloseOverlay';
      closeX.type = 'button';
      closeX.textContent = '√ó';
      pv.appendChild(closeX);
      closeX.addEventListener('click', function(e){
        e.stopPropagation();
        try{ document.getElementById('postModal').classList.remove('show'); }catch(_){};
      }, {passive:true});
    }

    // show play overlay when paused, hide when playing
    function syncOverlay(){
      if(v.paused){ play.style.display = 'flex'; } else { play.style.display = 'none'; }
    }
    v.addEventListener('play', syncOverlay, {passive:true});
    v.addEventListener('pause', syncOverlay, {passive:true});
    v.addEventListener('ended', syncOverlay, {passive:true});
    syncOverlay();

    // tap to toggle play/pause when tapping on overlay
    play.addEventListener('click', function(e){
      e.stopPropagation();
      try{ v.play(); }catch(_){};
    }, {passive:true});
  }

  // Run on DOM ready and whenever modal content changes
  document.addEventListener('DOMContentLoaded', setupReelsOverlay);
  var pm = document.getElementById('postModal');
  if(pm){
    var mo = new MutationObserver(function(){ setupReelsOverlay(); });
    mo.observe(pm, { childList:true, subtree:true });
  }
})();
</script>
<script>
(function(){
  // singleton fullscreen close button
  var fsBtn = document.getElementById('fsCloseOverlay');
  if(!fsBtn){
    fsBtn = document.createElement('button');
    fsBtn.id = 'fsCloseOverlay';
    fsBtn.type = 'button';
    fsBtn.textContent = '√ó';
    document.body.appendChild(fsBtn);
  }
  function isFullscreen(){
    return !!(document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement);
  }
  function exitFS(){
    if(document.exitFullscreen){ document.exitFullscreen().catch(()=>{}); }
    else if(document.webkitExitFullscreen){ document.webkitExitFullscreen(); }
    // iOS video API
    var vf = document.querySelector('video');
    if(vf && typeof vf.webkitExitFullscreen === 'function'){
      try{ vf.webkitExitFullscreen(); }catch(_){}
    }
  }
  function enterFSForVideo(v){
    // Try vendor-prefixed first for iOS Safari
    if(typeof v.webkitEnterFullscreen === 'function'){
      try{ v.webkitEnterFullscreen(); return true; }catch(_){}
    }
    // Generic Fullscreen API
    if(v.requestFullscreen){ v.requestFullscreen().catch(()=>{}); return true; }
    if(v.webkitRequestFullscreen){ v.webkitRequestFullscreen(); return true; }
    return false;
  }
  function onFSChange(){
    // toggle global close 'X' in fullscreen
    fsBtn.style.display = isFullscreen() ? 'block' : 'none';
    if(!isFullscreen()){
      // when leaving fullscreen, pause and show play overlay again
      var pv = document.getElementById('modalPreview');
      var v = pv && pv.querySelector('video');
      if(v){ try{ v.pause(); }catch(_){ } }
      var play = document.getElementById('reelsPlayOverlay');
      if(play){ play.style.display = 'flex'; }
    }
  }
  ['fullscreenchange','webkitfullscreenchange','msfullscreenchange'].forEach(function(evt){
    document.addEventListener(evt, onFSChange);
  });
  fsBtn.addEventListener('click', function(ev){
    ev.preventDefault(); ev.stopPropagation();
    exitFS();
  }, {passive:false});

  function hookupPlayToFullscreen(){
    var pv = document.getElementById('modalPreview'); if(!pv) return;
    var v = pv.querySelector('video'); if(!v) return;
    var play = document.getElementById('reelsPlayOverlay'); if(!play) return;
    // Center play tap -> enter fullscreen and play
    play.addEventListener('click', function(e){
      e.preventDefault(); e.stopPropagation();
      // Ensure we start at currentTime (no reset)
      if(enterFSForVideo(v)){ setTimeout(function(){ try{ v.play(); }catch(_){} }, 150); }
      else { try{ v.play(); }catch(_){} }
    }, {passive:false});
  }

  document.addEventListener('DOMContentLoaded', hookupPlayToFullscreen);
  var pm = document.getElementById('postModal');
  if(pm){
    var mo = new MutationObserver(function(){ hookupPlayToFullscreen(); });
    mo.observe(pm, {childList:true, subtree:true});
  }
})();
</script>
<script>
(function(){
  function fmtDate(ts){
    try{
      if(!ts) return '';
      if(typeof ts === 'number'){ var d = new Date(ts); }
      else if(ts && ts.seconds){ var d = new Date(ts.seconds*1000); }
      else if(typeof ts === 'string'){ var d = new Date(ts); }
      else { return ''; }
      const pad=n=>String(n).padStart(2,'0');
      return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+' '+pad(d.getHours())+':'+pad(d.getMinutes());
    }catch(_){ return ''; }
  }
  function esc(s){ return (s||'').replace(/[&<>]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m])); }

  function ensureNotesContainer(){
    const modal = document.getElementById('postModal');
    if(!modal) return null;
    // Find the label "Observa√ß√µes do cliente"
    const labels = modal.querySelectorAll('label, .label, .field-label, h4, h5');
    let anchor = null;
    labels.forEach(el => {
      const t = (el.textContent||'').trim().toLowerCase();
      if(!anchor && (t === 'observa√ß√µes do cliente' || t === 'observacoes do cliente')) anchor = el;
    });
    if(!anchor){
      // try to find by placeholder on input
      const input = modal.querySelector('input[placeholder*="observa"], textarea[placeholder*="observa"]');
      if(input) anchor = input.closest('.field') || input.parentElement;
    }
    if(!anchor) return null;

    // Insert container after the field block
    // Find block wrapper (field group)
    let block = anchor.closest('.field, .row, div');
    if(!block) block = anchor.parentElement;
    // place after this block
    // If already exists, return it
    let list = modal.querySelector('#clientNotesList');
    if(list) return list;
    list = document.createElement('div');
    list.id = 'clientNotesList';
    // Insert after block
    if(block.nextSibling){
      block.parentNode.insertBefore(list, block.nextSibling);
    }else{
      block.parentNode.appendChild(list);
    }
    return list;
  }

  function renderClientNotes(post){
    try{
      const list = ensureNotesContainer();
      if(!list) return;
      const notes = Array.isArray(post && post.reviewNotes) ? post.reviewNotes : [];
      if(notes.length === 0){
        list.innerHTML = '<div class="client-note"><div class="txt" style="color:var(--muted,#bbb)">Sem observa√ß√µes do cliente ainda.</div></div>';
        return;
      }
      const html = notes.map(n => {
        const author = (n.by||'').split('@')[0] || 'cliente';
        const when = fmtDate(n.at);
        const textHtml = renderMarkdownText(n.text||'');
        return '<div class="client-note">'
          + '<div class="dot"></div>'
          + '<div class="txt markdown-view">' + textHtml + '<div class="meta">por ' + esc(author) + (when? ' ‚Ä¢ ' + esc(when) : '') + '</div></div>'
          + '</div>';
      }).join('');
      list.innerHTML = html;
    }catch(e){ /* noop */ }
  }

  // Hook into modal updates: expect a global CURRENT_POST or read from DOM attributes if used
  function getCurrentPost(){
    try{
      if(window.CURRENT_POST) return window.CURRENT_POST;
      // fallback: if your app stores post id on modal
      const pm = document.getElementById('postModal');
      const id = pm && pm.getAttribute('data-post-id');
      if(id && window.POSTS && Array.isArray(window.POSTS)){
        return window.POSTS.find(p=>p.id===id);
      }
    }catch(_){}
    return null;
  }

  function update(){
    const p = getCurrentPost();
    if(p) renderClientNotes(p);
  }

  document.addEventListener('DOMContentLoaded', update);
  const pm = document.getElementById('postModal');
  if(pm){
    const mo = new MutationObserver(function(){ update(); });
    mo.observe(pm, { childList:true, subtree:true, attributes:true });
  }
  // Also refresh after any Firestore change if app exposes POSTS globally
  if(Array.isArray(window.POSTS)){
    setInterval(update, 1200);
  }
})();
</script>
<script>
(function(){
  function toast(msg){
    var el=document.createElement('div');
    el.textContent=msg;
    el.style.cssText='position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:rgba(0,0,0,.85);color:#fff;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.2);z-index:100000;font-weight:800';
    document.body.appendChild(el);
    setTimeout(function(){ el.remove(); }, 3000);
  }
  function patchApproveButton(btn){
    if(btn && !btn.__patched){
      btn.__patched = true;
      btn.style.background = '#2e7d32';
      btn.style.borderColor = '#2e7d32';
      var orig = btn.onclick;
      btn.onclick = function(ev){
        if(typeof orig === 'function'){ orig.call(btn, ev); }
        var msg = btn.id === 'btnApproveInternal' ? 'Aprova√ß√£o interna registrada!' : 'Obrigado! J√° vamos agendar este post!';
        toast(msg);
        setTimeout(function(){
          var modal=document.getElementById('postModal');
          if(modal) modal.classList.remove('show');
        }, 3000);
      };
    }
  }
  patchApproveButton(document.getElementById('btnApprove'));
  patchApproveButton(document.getElementById('btnApproveInternal'));

  // Fullscreen image viewer
  function setupImageFS(){
    var pv=document.getElementById('modalPreview'); if(!pv) return;
    var img=pv.querySelector('img'); if(!img || img.__fsBound) return;
    img.__fsBound=true;
    var backdrop=document.getElementById('imgFsBackdrop');
    if(!backdrop){
      backdrop=document.createElement('div');
      backdrop.id='imgFsBackdrop';
      backdrop.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.95);display:none;align-items:center;justify-content:center;z-index:100000';
      backdrop.innerHTML='<img id="imgFsContent" style="max-width:100%;max-height:100%;object-fit:contain"><button id="imgFsClose" style="position:fixed;top:12px;right:12px;padding:8px 12px;border-radius:12px;background:rgba(0,0,0,.6);color:#fff;font-weight:800;border:1px solid rgba(255,255,255,.25)">√ó</button>';
      document.body.appendChild(backdrop);
      backdrop.querySelector('#imgFsClose').onclick=function(){ backdrop.style.display='none'; };
    }
    var fsImg=document.getElementById('imgFsContent');
    img.style.cursor='zoom-in';
    img.addEventListener('click',function(){
      fsImg.src=img.currentSrc||img.src;
      backdrop.style.display='flex';
    });
  }
  document.addEventListener('DOMContentLoaded', setupImageFS);
  var pm=document.getElementById('postModal');
  if(pm){
    var mo=new MutationObserver(setupImageFS);
    mo.observe(pm,{childList:true,subtree:true});
  }
})();
</script>
<script>
(function(){
  function getCurrentPost(){
    try{
      if(window.selectedPost) return window.selectedPost;
      if(window.CURRENT_POST) return window.CURRENT_POST;
      var pm = document.getElementById('postModal');
      var id = pm && pm.getAttribute('data-post-id');
      if(id && Array.isArray(window.POSTS)){
        return window.POSTS.find(p=>p.id===id);
      }
    }catch(e){}
    return null;
  }
  function guessVideo(u){
    if(!u) return false;
    var clean = (u.split('?')[0]||'').toLowerCase();
    return /\.(mp4|mov|webm|m4v|avi)$/.test(clean);
  }
  function buildCarousel(){
    var pm = document.getElementById('postModal');
    var pv = document.getElementById('modalPreview');
    if(!pm || !pv || !pm.classList.contains('show')) return;
    var post = getCurrentPost();
    if(!post) return;

    var urls = Array.isArray(post.mediaUrls) && post.mediaUrls.length ? post.mediaUrls.slice() : [];
    if(!urls.length && post.thumbUrl) urls = [post.thumbUrl];

    if(urls.length <= 1){
      // Single media: ensure stage exists but no arrows
      var u = urls[0];
      var markup = '<div class="pv-stage"><div class="pv-media">'
                 + (guessVideo(u)? '<video src="'+u+'" controls playsinline webkit-playsinline></video>'
                                 : '<img src="'+(u||'')+'" alt="">')
                 + '</div></div>';
      pv.innerHTML = markup;
      pv.classList.remove('pv-has-many','pv-hint','pv-hint-end');
      return;
    }

    var idx = 0;
    pv.classList.add('pv-has-many','pv-hint');
    pv.innerHTML = '<div class="pv-stage">'
                 + '  <div class="pv-media" id="pvMedia"></div>'
                 + '  <button type="button" class="pv-arrow left" aria-label="Anterior">‚Äπ</button>'
                 + '  <button type="button" class="pv-arrow right" aria-label="Pr√≥ximo">‚Ä∫</button>'
                 + '</div>';
    var mediaBox = pv.querySelector('#pvMedia');
    var prev = pv.querySelector('.pv-arrow.left');
    var next = pv.querySelector('.pv-arrow.right');

    function render(){
      var u = urls[idx];
      mediaBox.innerHTML = guessVideo(u)
        ? '<video src="'+u+'" controls playsinline webkit-playsinline></video>'
        : '<img src="'+u+'" alt="m√≠dia '+(idx+1)+'">';
    }
    function go(d){ idx = (idx + d + urls.length) % urls.length; render(); stopHint(); }

    prev.onclick = function(e){ e.stopPropagation(); go(-1); };
    next.onclick = function(e){ e.stopPropagation(); go(+1); };

    // Swipe (mobile)
    var sx=0, sy=0, dx=0, dy=0, moved=false;
    mediaBox.addEventListener('touchstart', function(ev){
      var t=ev.touches[0]; sx=t.clientX; sy=t.clientY; dx=dy=0; moved=false;
    }, {passive:true});
    mediaBox.addEventListener('touchmove', function(ev){
      var t=ev.touches[0]; dx=t.clientX - sx; dy=t.clientY - sy;
      if(Math.abs(dx) > 18 && Math.abs(dx) > Math.abs(dy)){ moved = true; ev.preventDefault(); }
    }, {passive:false});
    mediaBox.addEventListener('touchend', function(){
      if(moved){
        if(dx < -30) go(+1);
        if(dx >  30) go(-1);
      }
    }, {passive:true});

    // Keyboard (desktop)
    function onKey(e){
      if(!pm.classList.contains('show')) return;
      if(e.key==='ArrowLeft') go(-1);
      if(e.key==='ArrowRight') go(+1);
    }
    document.addEventListener('keydown', onKey);

    function stopHint(){
      pv.classList.remove('pv-hint'); pv.classList.add('pv-hint-end');
    }
    prev.addEventListener('click', stopHint, {passive:true});
    next.addEventListener('click', stopHint, {passive:true});
    mediaBox.addEventListener('click', stopHint, {passive:true});

    // Clean up when modal closes
    var mo = new MutationObserver(function(){
      if(!pm.classList.contains('show')){
        document.removeEventListener('keydown', onKey);
        mo.disconnect();
      }
    });
    mo.observe(pm, {attributes:true, attributeFilter:['class']});

    render();
  }

  // Rebuild on modal open/content changes
  document.addEventListener('DOMContentLoaded', function(){
    var pm = document.getElementById('postModal');
    if(!pm) return;
    var obs = new MutationObserver(function(){
      if(pm.classList.contains('show')){
        setTimeout(buildCarousel, 30);
      }
    });
    obs.observe(pm, {attributes:true, attributeFilter:['class'], childList:true, subtree:true});
  });
})();
</script>
<!-- PATCH Macro: remover apenas as barras (widget-input) do PRIMEIRO card da aba Macro -->
<script>
(function(){
  "use strict";
  function isMacroActive(){
    var btn = document.querySelector('.tabs [role="tab"].active, .tab-btn.active');
    var txt = btn ? (btn.textContent||"").toLowerCase() : "";
    return txt.indexOf("macro") !== -1;
  }
  function getMacroGrid(){
    return document.querySelector('#widgetsGrid-macro, [data-section="macro"].widgets-grid')
        || document.querySelector('#widgetsGrid')
        || document.querySelector('.widgets-grid');
  }
  function removeMacroBars(){
    if (!isMacroActive()) return;
    var grid = getMacroGrid();
    if (!grid) return;
    var first = grid.querySelector('.widget-card');
    if (!first) return;
    var input = first.querySelector('.widget-input');
    if (input) input.remove();
  }
  document.addEventListener('DOMContentLoaded', function(){
    // aplica em loop curto para cobrir re-render inicial
    var tries = 0;
    var iv = setInterval(function(){
      tries++;
      removeMacroBars();
      if (tries > 30) clearInterval(iv);
    }, 100);
  });
  // observa mudan√ßas (re-renderiza√ß√µes)
  var mo = new MutationObserver(function(){ try{ removeMacroBars(); }catch(e){} });
  mo.observe(document.documentElement, { childList: true, subtree: true });
})();
</script>


<!-- PATCH Macro v4: remover header + barras (widget-input) + iframe do PRIMEIRO card da aba Macro -->
<script>
(function(){
  "use strict";
  function isMacroActive(){
    var btn = document.querySelector('.tabs [role="tab"].active, .tab-btn.active');
    var txt = btn ? (btn.textContent||"").toLowerCase() : "";
    return txt.indexOf("macro") !== -1;
  }
  function getMacroGrid(){
    return document.querySelector('#widgetsGrid-macro, [data-section="macro"].widgets-grid')
        || document.querySelector('#widgetsGrid')
        || document.querySelector('.widgets-grid');
  }
  function nukeFirstMacroCardBits(){
    if (!isMacroActive()) return;
    var grid = getMacroGrid();
    if (!grid) return;
    var first = grid.querySelector('.widget-card');
    if (!first) return;

    // 1) header
    var head = first.querySelector('.widget-head');
    if (head) head.remove();

    // 2) barras (inputs)
    var input = first.querySelector('.widget-input');
    if (input) input.remove();

    // 3) iframe e container
    var shell = first.querySelector('.frame-shell');
    if (shell) shell.remove();
    var ifr = first.querySelector('iframe');
    if (ifr) ifr.remove();
  }

  // roda v√°rias vezes no in√≠cio para cobrir re-render inicial
  document.addEventListener('DOMContentLoaded', function(){
    var tries = 0;
    var iv = setInterval(function(){
      tries++;
      nukeFirstMacroCardBits();
      if (tries > 40) clearInterval(iv); // ~4s
    }, 100);
  });

  // observa mudan√ßas e reaplica
  var mo = new MutationObserver(function(){ try{ nukeFirstMacroCardBits(); }catch(e){} });
  mo.observe(document.documentElement, { childList: true, subtree: true });

  // utilit√°rio manual
  window.__nukeFirstMacroCardBits = nukeFirstMacroCardBits;
})();
</script>

<!-- Modal: Preview de Documento Gerado -->
<div class="doc-preview-modal" id="docPreviewModal">
  <div class="doc-preview-container">
    <div class="doc-preview-header">
      <h3 class="doc-preview-title">
        <span class="icon">üìÑ</span>
        <span id="docPreviewTitleText">Documento Gerado</span>
      </h3>
      <div class="doc-preview-actions">
        <button class="doc-preview-btn" id="docPreviewCopyBtn" title="Copiar conte√∫do">
          üìã Copiar
        </button>
        <button class="doc-preview-btn primary" id="docPreviewDownloadBtn" title="Baixar como arquivo">
          ‚¨áÔ∏è Baixar
        </button>
        <button class="doc-preview-btn close-btn" id="docPreviewCloseBtn" title="Fechar">
          ‚úï Fechar
        </button>
      </div>
    </div>
    <div class="doc-preview-body">
      <div class="doc-preview-content" id="docPreviewContent">
        <div class="doc-preview-loading">
          <div class="spinner-large"></div>
          <span>Gerando documento com IA...</span>
        </div>
      </div>
      <div class="doc-preview-source" id="docPreviewSource" style="display:none">
        <div class="doc-preview-source-title">üìö Fontes utilizadas:</div>
        <div class="doc-preview-source-list" id="docPreviewSourceList"></div>
      </div>
    </div>
  </div>
</div>

<!-- Modal: An√°lise com Gr√°ficos -->
<div class="analise-modal" id="analiseModal">
  <div class="analise-container">
    <div class="analise-header">
      <h3 class="analise-title">
        <span class="icon">üìä</span>
        <span id="analiseTitleText">An√°lise do Entreg√°vel</span>
      </h3>
      <div class="analise-header-actions">
        <span class="analise-saved-badge" id="analiseSavedBadge" style="display:none">
          <span class="badge-icon">‚úì</span> Salvo em <span id="analiseSavedDate">--</span>
        </span>
        <button class="analise-refresh-btn" id="analiseRefreshBtn" title="Atualizar do Firebase" onclick="window.forceRefreshAnalise && window.forceRefreshAnalise()" style="display:inline-flex; align-items:center; gap:6px; padding:8px 16px; background:#4CAF50; color:white; border:none; border-radius:6px; cursor:pointer; font-size:0.9rem; font-weight:500; transition:all 0.2s;">
          ‚Üª Atualizar
        </button>
        <button class="analise-regenerate-btn" id="analiseRegenerateBtn" title="Gerar nova an√°lise" onclick="window.regenerarAnalise && window.regenerarAnalise()">
          üîÑ Gerar Novamente
        </button>
        <button class="analise-close-btn" id="analiseCloseBtn" title="Fechar">‚úï</button>
      </div>
    </div>
    <!-- Barra de Status da An√°lise -->
    <div class="analise-actions" id="analiseActions" style="display:none">
      <div class="analise-status" id="analiseStatus">
        <span class="status-badge new">Gerando...</span>
      </div>
    </div>
    <div class="analise-body">
      <div class="analise-loading" id="analiseLoading">
        <div class="spinner-large"></div>
        <div class="analise-loading-text">Gerando an√°lise inteligente...</div>
        <div class="analise-loading-sub">Processando dados e criando gr√°ficos</div>
      </div>
      <div class="analise-grid" id="analiseContent" style="display:none">
        <!-- M√©tricas Resumo -->
        <div class="analise-metrics-row">
          <div class="analise-metric-card">
            <div class="analise-metric-value" id="metricProgresso">0%</div>
            <div class="analise-metric-label">Progresso Geral</div>
          </div>
          <div class="analise-metric-card">
            <div class="analise-metric-value" id="metricConcluidas">0</div>
            <div class="analise-metric-label">Tarefas Conclu√≠das</div>
          </div>
          <div class="analise-metric-card">
            <div class="analise-metric-value" id="metricPendentes">0</div>
            <div class="analise-metric-label">Pendentes</div>
          </div>
          <div class="analise-metric-card">
            <div class="analise-metric-value" id="metricAnotacoes">0</div>
            <div class="analise-metric-label">Anota√ß√µes</div>
          </div>
        </div>
        
        <!-- Container Din√¢mico de Gr√°ficos -->
        <div id="analiseChartsContainer" class="analise-charts-dynamic">
          <!-- Gr√°fico Principal (Primary) -->
          <div class="analise-chart-card chart-primary" id="chartCardPrimary">
            <h4 class="analise-chart-title">
              <span class="chart-icon" id="chartIconPrimary">üìä</span>
              <span id="chartTitlePrimary">Gr√°fico Principal</span>
            </h4>
            <div class="analise-chart-wrap">
              <canvas id="chartPrimary"></canvas>
            </div>
            <p class="analise-chart-description" id="chartDescPrimary">Descri√ß√£o do gr√°fico principal.</p>
          </div>
          
          <!-- Gr√°fico Secund√°rio -->
          <div class="analise-chart-card chart-secondary" id="chartCardSecondary">
            <h4 class="analise-chart-title">
              <span class="chart-icon" id="chartIconSecondary">üìà</span>
              <span id="chartTitleSecondary">Gr√°fico Secund√°rio</span>
            </h4>
            <div class="analise-chart-wrap">
              <canvas id="chartSecondary"></canvas>
            </div>
            <p class="analise-chart-description" id="chartDescSecondary">Descri√ß√£o do gr√°fico secund√°rio.</p>
          </div>
          
          <!-- Gr√°fico Terci√°rio -->
          <div class="analise-chart-card chart-tertiary" id="chartCardTertiary">
            <h4 class="analise-chart-title">
              <span class="chart-icon" id="chartIconTertiary">üéØ</span>
              <span id="chartTitleTertiary">Gr√°fico Terci√°rio</span>
            </h4>
            <div class="analise-chart-wrap">
              <canvas id="chartTertiary"></canvas>
            </div>
            <p class="analise-chart-description" id="chartDescTertiary">Descri√ß√£o do gr√°fico terci√°rio.</p>
          </div>
          
          <!-- Gr√°fico Radar - Dimens√µes Espec√≠ficas do Entreg√°vel -->
          <div class="analise-chart-card chart-radar" id="chartCardRadar">
            <h4 class="analise-chart-title">
              <span class="chart-icon">üéØ</span>
              <span id="chartTitleRadar">Radar de Maturidade</span>
            </h4>
            <div class="analise-chart-wrap">
              <canvas id="chartRadarDimensoes"></canvas>
            </div>
            <p class="analise-chart-description" id="chartDescRadar">Vis√£o multidimensional das compet√™ncias avaliadas neste entreg√°vel.</p>
          </div>
          
          <!-- NOVO: Gr√°fico Funil de Marketing e Vendas Detalhado -->
          <div class="analise-chart-card chart-funil-detalhado" id="chartCardFunilDetalhado" style="display:none; grid-column: 1 / -1;">
            <h4 class="analise-chart-title">
              <span class="chart-icon">üîª</span>
              <span>Funil de Marketing e Vendas (Diagn√≥stico de Convers√£o)</span>
            </h4>
            <div class="funil-visual-container">
              <div id="funilVisualDiagnostico" class="funil-visual-wrapper"></div>
            </div>
            <p class="analise-chart-description">Visualiza√ß√£o completa do funil de convers√£o com taxas de perda entre cada etapa e diagn√≥stico de gargalos.</p>
          </div>
          
          <!-- NOVO: Mapa de Diferencia√ß√£o Competitiva (Oceano Vermelho √ó Azul) -->
          <div class="analise-chart-card chart-mapa-diferenciacao" id="chartCardMapaDiferenciacao" style="display:none; grid-column: 1 / -1;">
            <h4 class="analise-chart-title">
              <span class="chart-icon">üåä</span>
              <span>Mapa de Diferencia√ß√£o Competitiva (Oceano Vermelho √ó Azul)</span>
            </h4>
            <div class="mapa-diferenciacao-container">
              <div id="mapaDiferenciacaoVisual" class="mapa-diferenciacao-wrapper"></div>
            </div>
            <p class="analise-chart-description">Posicionamento estrat√©gico comparado aos concorrentes: identifique onde voc√™ est√° no mercado e oportunidades de diferencia√ß√£o.</p>
          </div>
          
          <!-- NOVO: Gr√°fico de Sazonalidade e Previsibilidade -->
          <div class="analise-chart-card chart-sazonalidade" id="chartCardSazonalidade" style="display:none; grid-column: 1 / -1;">
            <h4 class="analise-chart-title">
              <span class="chart-icon">üìÖ</span>
              <span>Sazonalidade e Previsibilidade de Vendas</span>
            </h4>
            <div class="analise-chart-wrap" style="height: 320px;">
              <canvas id="chartSazonalidade"></canvas>
            </div>
            <div id="sazonalidadeLegenda" class="sazonalidade-legenda"></div>
            <p class="analise-chart-description">An√°lise dos picos e vales de vendas ao longo do ano para planejamento estrat√©gico de campanhas.</p>
          </div>
          
          <!-- NOVO: Gr√°fico de Clareza de Marca (Antes √ó Depois) -->
          <div class="analise-chart-card chart-clareza-marca" id="chartCardClarezaMarca" style="display:none; grid-column: 1 / -1;">
            <h4 class="analise-chart-title">
              <span class="chart-icon">‚ú®</span>
              <span>Clareza de Marca (Antes √ó Proje√ß√£o)</span>
            </h4>
            <div class="clareza-marca-container">
              <div id="clarezaMarcaVisual" class="clareza-marca-wrapper"></div>
            </div>
            <p class="analise-chart-description">Comparativo visual de como a marca √© percebida atualmente vs. potencial ap√≥s implementa√ß√£o das estrat√©gias.</p>
          </div>
        </div>
        
        <!-- Insights da IA -->
        <div class="analise-insight-section">
          <h4 class="analise-insight-title">
            <span>ü§ñ</span> An√°lise Estrat√©gica Profunda
            <div class="analise-insight-actions">
              <button class="analise-pdf-btn" id="analisePdfBtn" title="Baixar relat√≥rio em PDF">
                üìÑ PDF
              </button>
              <button class="analise-edit-btn" id="analiseEditBtn" title="Editar an√°lise">
                ‚úèÔ∏è Editar
              </button>
              <button class="analise-save-btn" id="analiseSaveBtn" style="display:none;" title="Salvar altera√ß√µes">
                üíæ Salvar
              </button>
              <button class="analise-cancel-btn" id="analiseCancelBtn" style="display:none;" title="Cancelar edi√ß√£o">
                ‚úï Cancelar
              </button>
            </div>
          </h4>
          <div class="analise-insight-content" id="analiseInsightContent">
            Carregando an√°lise...
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Relat√≥rio Completo Unificado -->
<div class="relatorio-modal" id="relatorioModal">
  <div class="relatorio-modal-content">
    <div class="relatorio-modal-header">
      <h3>üìã Relat√≥rio Completo de An√°lises</h3>
      <div class="relatorio-modal-actions">
        <button class="btn-relatorio-completo btn-relatorio-link" id="btnCopiarLinkRelatorio" onclick="copiarLinkRelatorioCompleto(this)" style="padding:8px 16px;font-size:.8rem;background:#6c63ff;">
          üîó Copiar Link
        </button>
        <button class="btn-relatorio-completo btn-relatorio-pdf" onclick="baixarRelatorioPDF()" style="padding:8px 16px;font-size:.8rem;">
          üì• PDF
        </button>
        <button class="relatorio-modal-close" onclick="fecharRelatorioModal()">‚úï</button>
      </div>
    </div>
    <div class="relatorio-modal-body" id="relatorioModalBody">
      <!-- Conte√∫do din√¢mico -->
    </div>
  </div>
</div>

<!-- Modal: Instru√ß√µes para Regenerar An√°lise -->
<div class="analise-modal-overlay" id="regenerateInstructionsModal" style="display:none;">
  <div class="regenerate-instructions-container">
    <div class="regenerate-instructions-header">
      <h3>üéØ Instru√ß√µes Adicionais para a IA</h3>
      <button class="regenerate-close-btn" id="regenerateCloseBtn" onclick="document.getElementById('regenerateInstructionsModal').style.display='none'">‚úï</button>
    </div>
    <div class="regenerate-instructions-body">
      <p class="regenerate-description">
        Adicione instru√ß√µes espec√≠ficas para melhorar a an√°lise. A IA usar√° estas orienta√ß√µes junto com as informa√ß√µes j√° coletadas.
      </p>
      <div class="regenerate-examples">
        <span class="example-label">üí° Exemplos de instru√ß√µes:</span>
        <ul>
          <li>"Foque mais nas dores emocionais do cliente"</li>
          <li>"Inclua exemplos pr√°ticos de comunica√ß√£o"</li>
          <li>"Aprofunde na an√°lise de concorrentes"</li>
          <li>"Seja mais espec√≠fico sobre o p√∫blico de 25-35 anos"</li>
          <li>"Adicione mais gatilhos mentais de urg√™ncia"</li>
        </ul>
      </div>
      <textarea 
        id="regenerateInstructionsInput" 
        class="regenerate-instructions-textarea" 
        placeholder="Digite suas instru√ß√µes aqui... (opcional)&#10;&#10;Ex: Quero que a an√°lise foque mais em estrat√©gias de diferencia√ß√£o e inclua exemplos de copy para Instagram."
        rows="5"
      ></textarea>
    </div>
    <div class="regenerate-instructions-footer">
      <button class="regenerate-cancel-btn" id="regenerateCancelBtn" onclick="document.getElementById('regenerateInstructionsModal').style.display='none'">Cancelar</button>
      <button class="regenerate-confirm-btn" id="regenerateConfirmBtn" onclick="window.executarRegeneracao && window.executarRegeneracao()">
        üöÄ Gerar Nova An√°lise
      </button>
    </div>
  </div>
</div>

<!-- Modal: Regenerar Bloco Espec√≠fico da An√°lise -->
<div class="bloco-regen-modal-overlay" id="blocoRegenModal">
  <div class="bloco-regen-container">
    <div class="bloco-regen-header">
      <h3>‚ú® Ajustar Se√ß√£o com IA</h3>
      <button class="bloco-regen-close-btn" onclick="window.fecharModalBlocoRegen()">‚úï</button>
    </div>
    <div class="bloco-regen-body">
      <div class="bloco-regen-section-title">üìå Se√ß√£o selecionada:</div>
      <div class="bloco-regen-section-preview" id="blocoRegenPreview">...</div>
      
      <div class="bloco-regen-section-title">üí° O que voc√™ gostaria de ajustar?</div>
      <textarea 
        id="blocoRegenInput" 
        class="bloco-regen-textarea" 
        placeholder="Descreva como quer que esta se√ß√£o seja melhorada...&#10;&#10;Ex: 'Seja mais espec√≠fico sobre as dores do cliente'&#10;Ex: 'Adicione exemplos pr√°ticos de copy'&#10;Ex: 'Foque mais em resultados num√©ricos'"
        rows="4"
      ></textarea>
      
      <div class="bloco-regen-section-title">üîÑ Modo de edi√ß√£o:</div>
      <div class="bloco-regen-mode-options" id="blocoRegenModeOptions">
        <label class="bloco-regen-mode-option selected" onclick="document.querySelectorAll('.bloco-regen-mode-option').forEach(el=>el.classList.remove('selected')); this.classList.add('selected');">
          <input type="radio" name="blocoRegenMode" value="refazer" checked>
          <span class="bloco-regen-mode-icon">üîÑ</span>
          <span class="bloco-regen-mode-label">Refazer</span>
          <span class="bloco-regen-mode-desc">Reescreve toda a se√ß√£o</span>
        </label>
        <label class="bloco-regen-mode-option" onclick="document.querySelectorAll('.bloco-regen-mode-option').forEach(el=>el.classList.remove('selected')); this.classList.add('selected');">
          <input type="radio" name="blocoRegenMode" value="adicionar">
          <span class="bloco-regen-mode-icon">‚ûï</span>
          <span class="bloco-regen-mode-label">Adicionar</span>
          <span class="bloco-regen-mode-desc">Mant√©m o texto e adiciona mais</span>
        </label>
      </div>
      
      <div class="bloco-regen-section-title">üìè Tamanho do texto:</div>
      <div class="bloco-regen-size-options" id="blocoRegenSizeOptions">
        <label class="bloco-regen-size-option" onclick="document.querySelectorAll('.bloco-regen-size-option').forEach(el=>el.classList.remove('selected')); this.classList.add('selected');">
          <input type="radio" name="blocoRegenSize" value="pequeno">
          <span class="bloco-regen-size-label">üìù Curto</span>
          <span class="bloco-regen-size-desc">Resumido e direto</span>
        </label>
        <label class="bloco-regen-size-option selected" onclick="document.querySelectorAll('.bloco-regen-size-option').forEach(el=>el.classList.remove('selected')); this.classList.add('selected');">
          <input type="radio" name="blocoRegenSize" value="medio" checked>
          <span class="bloco-regen-size-label">üìÑ M√©dio</span>
          <span class="bloco-regen-size-desc">Balanceado</span>
        </label>
        <label class="bloco-regen-size-option" onclick="document.querySelectorAll('.bloco-regen-size-option').forEach(el=>el.classList.remove('selected')); this.classList.add('selected');">
          <input type="radio" name="blocoRegenSize" value="grande">
          <span class="bloco-regen-size-label">üìö Extenso</span>
          <span class="bloco-regen-size-desc">Detalhado e completo</span>
        </label>
      </div>
      
      <div class="bloco-regen-section-title">üìä Formato de sa√≠da:</div>
      <div class="bloco-regen-format-options" id="blocoRegenFormatOptions">
        <label class="bloco-regen-format-option selected" onclick="document.querySelectorAll('.bloco-regen-format-option').forEach(el=>el.classList.remove('selected')); this.classList.add('selected');">
          <input type="radio" name="blocoRegenFormat" value="auto" checked>
          <span class="bloco-regen-format-icon">üîÑ</span>
          <span class="bloco-regen-format-label">Auto</span>
          <span class="bloco-regen-format-desc">Mant√©m formato atual</span>
        </label>
        <label class="bloco-regen-format-option" onclick="document.querySelectorAll('.bloco-regen-format-option').forEach(el=>el.classList.remove('selected')); this.classList.add('selected');">
          <input type="radio" name="blocoRegenFormat" value="texto">
          <span class="bloco-regen-format-icon">üìù</span>
          <span class="bloco-regen-format-label">Texto</span>
          <span class="bloco-regen-format-desc">Par√°grafos e listas</span>
        </label>
        <label class="bloco-regen-format-option" onclick="document.querySelectorAll('.bloco-regen-format-option').forEach(el=>el.classList.remove('selected')); this.classList.add('selected');">
          <input type="radio" name="blocoRegenFormat" value="planilha">
          <span class="bloco-regen-format-icon">üìä</span>
          <span class="bloco-regen-format-label">Planilha</span>
          <span class="bloco-regen-format-desc">Tabela organizada</span>
        </label>
      </div>
    </div>
    <div class="bloco-regen-footer">
      <button class="bloco-regen-cancel-btn" onclick="window.fecharModalBlocoRegen()">Cancelar</button>
      <button class="bloco-regen-confirm-btn" id="blocoRegenConfirmBtn" onclick="window.executarRegeneracaoBloco()">
        ‚ú® Gerar com IA
      </button>
    </div>
  </div>
</div>

<!-- Modal: Informa√ß√µes para Landing Pages/Website -->
<div class="analise-modal-overlay" id="landingPagesInfoModal" style="display:none;">
  <div class="landing-info-container">
    <div class="landing-info-header">
      <h3 id="landingInfoTitle">üéØ Informa√ß√µes para Landing Pages</h3>
      <button class="landing-info-close-btn" onclick="fecharModalLandingInfo()">‚úï</button>
    </div>
    <div class="landing-info-body">
      <p class="landing-info-intro" id="landingInfoIntro">
        Para criar landing pages estrat√©gicas e personalizadas, precisamos de algumas informa√ß√µes sobre seus produtos/servi√ßos e objetivos.
      </p>
      
      <div class="landing-info-field">
        <label>üõçÔ∏è Produtos/Servi√ßos <span class="required">*</span></label>
        <textarea 
          id="landingInfoProdutos" 
          placeholder="Liste os principais produtos ou servi√ßos que deseja vender/promover nas p√°ginas.&#10;&#10;Ex: Curso de Marketing Digital, Consultoria de Vendas, Pacote de Social Media..."
          rows="3"
        ></textarea>
        <p class="landing-info-hint">Pode listar v√°rios, separados por v√≠rgula ou linha</p>
      </div>
      
      <div class="landing-info-field">
        <label>üéØ Objetivo Principal <span class="required">*</span></label>
        <select id="landingInfoObjetivo">
          <option value="">Selecione o objetivo...</option>
          <option value="captura_leads">Captura de Leads (formul√°rio)</option>
          <option value="vendas_diretas">Vendas Diretas (checkout)</option>
          <option value="whatsapp">Convers√£o via WhatsApp</option>
          <option value="agendamento">Agendamento de Reuni√£o/Consultoria</option>
          <option value="download">Download de Material (isca digital)</option>
          <option value="inscricao_evento">Inscri√ß√£o em Evento/Webinar</option>
          <option value="orcamento">Solicita√ß√£o de Or√ßamento</option>
          <option value="misto">Misto (m√∫ltiplos objetivos)</option>
        </select>
      </div>
      
      <div class="landing-info-field">
        <label>üí∞ Faixa de Pre√ßo (se aplic√°vel)</label>
        <input 
          type="text" 
          id="landingInfoPreco" 
          placeholder="Ex: R$ 497, Entre R$ 1.000 e R$ 3.000, Sob consulta..."
        />
        <p class="landing-info-hint">Deixe em branco se n√£o quiser exibir pre√ßo</p>
      </div>
      
      <div class="landing-info-field">
        <label>üì¢ Canal de Tr√°fego Principal</label>
        <select id="landingInfoCanal">
          <option value="">Selecione...</option>
          <option value="google_ads">Google Ads (pesquisa/display)</option>
          <option value="meta_ads">Meta Ads (Facebook/Instagram)</option>
          <option value="tiktok_ads">TikTok Ads</option>
          <option value="youtube_ads">YouTube Ads</option>
          <option value="organico">Tr√°fego Org√¢nico (SEO/Social)</option>
          <option value="email">E-mail Marketing</option>
          <option value="multiplos">M√∫ltiplos canais</option>
        </select>
      </div>
      
      <div class="landing-info-field">
        <label>‚ú® Diferenciais/Garantias</label>
        <textarea 
          id="landingInfoDiferenciais" 
          placeholder="O que torna seu produto/servi√ßo √∫nico? H√° garantias?&#10;&#10;Ex: Garantia de 7 dias, Suporte vital√≠cio, M√©todo exclusivo, Cases de sucesso..."
          rows="2"
        ></textarea>
      </div>
      
      <div class="landing-info-field">
        <label>üìù Observa√ß√µes Adicionais</label>
        <textarea 
          id="landingInfoObservacoes" 
          placeholder="Algum detalhe espec√≠fico que a IA deve considerar?&#10;&#10;Ex: Quero um tom mais formal, foco em B2B, incluir urg√™ncia/escassez..."
          rows="2"
        ></textarea>
      </div>
    </div>
    <div class="landing-info-footer">
      <button class="landing-info-cancel-btn" onclick="fecharModalLandingInfo()">Cancelar</button>
      <button class="landing-info-confirm-btn" id="landingInfoConfirmBtn" onclick="confirmarLandingInfo()">
        üöÄ Gerar An√°lise
      </button>
    </div>
  </div>
</div>

<!-- üìä MODAL: M√©tricas do Primeiro M√™s (Direcionamento Estrat√©gico e Metas) -->
<div class="analise-modal-overlay" id="metricasPrimeiroMesModal" style="display:none;">
  <div class="landing-info-container" style="max-width: 900px;">
    <div class="landing-info-header">
      <h3 id="metricasModalTitulo">üìä M√©tricas do Primeiro M√™s de Atua√ß√£o</h3>
      <button class="landing-info-close-btn" onclick="fecharModalMetricasMes()">‚úï</button>
    </div>
    
    <div class="landing-info-body" style="max-height: 75vh; overflow-y: auto;">
      
      <!-- AVISO DE REGENERA√á√ÉO (aparece apenas quando for regenera√ß√£o) -->
      <div id="metricasAvisoRegeneracao" style="display: none; background: rgba(251,191,36,0.15); border: 1px solid rgba(251,191,36,0.4); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
        <p style="margin: 0; color: #fbbf24; font-size: 0.9rem; font-weight: 600;">
          üîÑ Voc√™ est√° regenerando a an√°lise
        </p>
        <p style="margin: 8px 0 0; color: rgba(255,255,255,0.8); font-size: 0.85rem; line-height: 1.5;">
          Os campos abaixo j√° est√£o preenchidos com as m√©tricas anteriores. Voc√™ pode ajust√°-las e gerar uma nova an√°lise atualizada.
        </p>
      </div>
      
      <!-- üè¢ CONTEXTO DO NEG√ìCIO -->
      <div style="background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
        <h4 style="margin: 0 0 16px; color: #10b981; font-size: 1rem;">
          üè¢ Contexto do Seu Neg√≥cio
        </h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; color: rgba(255,255,255,0.9); font-size: 0.9rem;">
          <div>
            <strong style="color: #10b981;">Nicho:</strong>
            <p id="metricasContextoNicho" style="margin: 4px 0 0;">-</p>
          </div>
          <div>
            <strong style="color: #10b981;">Ticket M√©dio:</strong>
            <p id="metricasContextoTicket" style="margin: 4px 0 0;">-</p>
          </div>
          <div>
            <strong style="color: #10b981;">Or√ßamento Inicial:</strong>
            <p id="metricasContextoOrcamento" style="margin: 4px 0 0;">-</p>
          </div>
          <div>
            <strong style="color: #10b981;">Meta Anual:</strong>
            <p id="metricasContextoMetaAnual" style="margin: 4px 0 0;">-</p>
          </div>
        </div>
        <div style="margin-top: 12px;">
          <strong style="color: #10b981;">Situa√ß√£o Atual:</strong>
          <p id="metricasContextoSituacao" style="margin: 4px 0 0; line-height: 1.6;">-</p>
        </div>
      </div>

      <!-- M√äS ATUAL -->
      <div style="text-align: center; margin-bottom: 20px;">
        <div style="display: inline-block; background: rgba(99,102,241,0.2); border: 1px solid rgba(99,102,241,0.4); border-radius: 10px; padding: 12px 24px;">
          <p style="margin: 0; color: rgba(255,255,255,0.7); font-size: 0.85rem;">Primeiro m√™s de atua√ß√£o</p>
          <p id="metricasMesAtual" style="margin: 4px 0 0; color: #fff; font-size: 1.3rem; font-weight: 700;">Janeiro 2026</p>
        </div>
      </div>

      <!-- üí° ESTIMATIVAS SUGERIDAS -->
      <div style="background: rgba(99,102,241,0.1); border: 1px solid rgba(99,102,241,0.3); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
        <h4 style="margin: 0 0 12px; color: #6366f1; font-size: 1rem;">
          üí° Estimativas Sugeridas (pela IA)
        </h4>
        <p style="margin: 0 0 16px; color: rgba(255,255,255,0.7); font-size: 0.85rem;">
          Com base no contexto do seu neg√≥cio, sugerimos estas m√©tricas realistas para o primeiro m√™s:
        </p>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px;">
          <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; text-align: center;">
            <p style="margin: 0; font-size: 0.75rem; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 0.05em;">Invest. M√≠dia</p>
            <p id="sugInvestimento" style="margin: 4px 0 0; font-size: 1.3rem; font-weight: 700; color: #10b981;">R$ 0</p>
          </div>
          <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; text-align: center;">
            <p style="margin: 0; font-size: 0.75rem; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 0.05em;">Leads Org.</p>
            <p id="sugLeadsOrg" style="margin: 4px 0 0; font-size: 1.3rem; font-weight: 700; color: #10b981;">0</p>
          </div>
          <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; text-align: center;">
            <p style="margin: 0; font-size: 0.75rem; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 0.05em;">Leads Pago</p>
            <p id="sugLeadsPago" style="margin: 4px 0 0; font-size: 1.3rem; font-weight: 700; color: #10b981;">0</p>
          </div>
          <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; text-align: center;">
            <p style="margin: 0; font-size: 0.75rem; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 0.05em;">Conv. Pago</p>
            <p id="sugConvPago" style="margin: 4px 0 0; font-size: 1.3rem; font-weight: 700; color: #10b981;">0%</p>
          </div>
          <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; text-align: center;">
            <p style="margin: 0; font-size: 0.75rem; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 0.05em;">Conv. Org.</p>
            <p id="sugConvOrg" style="margin: 4px 0 0; font-size: 1.3rem; font-weight: 700; color: #10b981;">0%</p>
          </div>
          <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; text-align: center;">
            <p style="margin: 0; font-size: 0.75rem; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 0.05em;">Vendas Total</p>
            <p id="sugVendas" style="margin: 4px 0 0; font-size: 1.3rem; font-weight: 700; color: #10b981;">0</p>
          </div>
        </div>
        
        <button 
          onclick="usarEstimativasSugeridas()" 
          style="margin-top: 16px; width: 100%; background: rgba(99,102,241,0.2); border: 1px solid rgba(99,102,241,0.4); color: #a5b4fc; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.2s;"
          onmouseover="this.style.background='rgba(99,102,241,0.3)'"
          onmouseout="this.style.background='rgba(99,102,241,0.2)'"
        >
          ‚ú® Usar Estas Estimativas
        </button>
      </div>

      <!-- ‚úçÔ∏è AJUSTE MANUAL -->
      <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px;">
        <h4 style="margin: 0 0 12px; color: #fff; font-size: 1rem;">
          ‚úçÔ∏è Ajustar M√©tricas Manualmente
        </h4>
        <p style="margin: 0 0 20px; color: rgba(255,255,255,0.7); font-size: 0.85rem;">
          Ajuste os valores conforme sua realidade e expectativa para o primeiro m√™s:
        </p>
        
        <div style="display: grid; gap: 16px;">
          
          <div class="landing-info-field" style="margin: 0;">
            <label style="color: #fff; font-weight: 600;">üí∞ Investimento em M√≠dia Paga</label>
            <input 
              type="text" 
              id="metricasInvestimento" 
              placeholder="Ex: R$ 1000 ou $ 500"
              style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 12px; border-radius: 8px; width: 100%; font-size: 0.95rem;"
            />
            <p style="margin: 6px 0 0; color: rgba(255,255,255,0.5); font-size: 0.8rem;">
              Quanto voc√™ planeja investir em an√∫ncios no primeiro m√™s?
            </p>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="landing-info-field" style="margin: 0;">
              <label style="color: #fff; font-weight: 600;">üå± Leads Org√¢nicos</label>
              <input 
                type="number" 
                id="metricasLeadsOrg" 
                placeholder="Ex: 20"
                min="0"
                style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 12px; border-radius: 8px; width: 100%; font-size: 0.95rem;"
              />
              <p style="margin: 6px 0 0; color: rgba(255,255,255,0.5); font-size: 0.75rem;">
                SEO, GMB, redes, indica√ß√µes
              </p>
            </div>

            <div class="landing-info-field" style="margin: 0;">
              <label style="color: #fff; font-weight: 600;">üí∞ Leads Pagos</label>
              <input 
                type="number" 
                id="metricasLeadsPago" 
                placeholder="Ex: 30"
                min="0"
                style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 12px; border-radius: 8px; width: 100%; font-size: 0.95rem;"
              />
              <p style="margin: 6px 0 0; color: rgba(255,255,255,0.5); font-size: 0.75rem;">
                Google Ads, Meta Ads
              </p>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div class="landing-info-field" style="margin: 0;">
              <label style="color: #fff; font-weight: 600;">üìà Conv. Leads Pagos</label>
              <input 
                type="number" 
                id="metricasConvPago" 
                placeholder="Ex: 5"
                min="0"
                max="100"
                step="0.5"
                style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 12px; border-radius: 8px; width: 100%; font-size: 0.95rem;"
              />
              <p style="margin: 6px 0 0; color: rgba(255,255,255,0.5); font-size: 0.75rem;">
                % de convers√£o (ex: 5%)
              </p>
            </div>

            <div class="landing-info-field" style="margin: 0;">
              <label style="color: #fff; font-weight: 600;">üìà Conv. Leads Org√¢nicos</label>
              <input 
                type="number" 
                id="metricasConvOrg" 
                placeholder="Ex: 12"
                min="0"
                max="100"
                step="0.5"
                style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 12px; border-radius: 8px; width: 100%; font-size: 0.95rem;"
              />
              <p style="margin: 6px 0 0; color: rgba(255,255,255,0.5); font-size: 0.75rem;">
                % de convers√£o (ex: 12%)
              </p>
            </div>
          </div>

        </div>
      </div>
      
      <!-- üìä PR√âVIA DA PROJE√á√ÉO ANUAL (calculada automaticamente) -->
      <div id="metricasPrevisaoAnual" style="display: none; background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.3); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
        <h4 style="margin: 0 0 12px; color: #3b82f6; font-size: 1rem; display: flex; align-items: center; gap: 8px;">
          üìä Pr√©via dos Pr√≥ximos 6 Meses
          <span style="font-size: 0.75rem; background: rgba(59,130,246,0.2); padding: 4px 8px; border-radius: 6px; font-weight: 500;">Baseado nos seus dados</span>
        </h4>
        <p style="margin: 0 0 16px; color: rgba(255,255,255,0.7); font-size: 0.85rem;">
          Proje√ß√£o simples: <strong>Valores mensais √ó 6 meses</strong> (sem crescimento fict√≠cio)
        </p>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 16px;">
          <div style="background: rgba(255,255,255,0.05); padding: 14px; border-radius: 10px; border-left: 3px solid #3b82f6;">
            <p style="margin: 0; font-size: 0.75rem; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 0.05em;">Investimento Total</p>
            <p id="prevInvestimentoTotal" style="margin: 4px 0 0; font-size: 1.4rem; font-weight: 700; color: #3b82f6;">-</p>
          </div>
          <div style="background: rgba(255,255,255,0.05); padding: 14px; border-radius: 10px; border-left: 3px solid #10b981;">
            <p style="margin: 0; font-size: 0.75rem; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 0.05em;">Leads Totais</p>
            <p id="prevLeadsTotal" style="margin: 4px 0 0; font-size: 1.4rem; font-weight: 700; color: #10b981;">-</p>
          </div>
          <div style="background: rgba(255,255,255,0.05); padding: 14px; border-radius: 10px; border-left: 3px solid #f59e0b;">
            <p style="margin: 0; font-size: 0.75rem; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 0.05em;">Vendas Totais</p>
            <p id="prevVendasTotal" style="margin: 4px 0 0; font-size: 1.4rem; font-weight: 700; color: #f59e0b;">-</p>
          </div>
          <div style="background: rgba(255,255,255,0.05); padding: 14px; border-radius: 10px; border-left: 3px solid #8b5cf6;">
            <p style="margin: 0; font-size: 0.75rem; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 0.05em;">Faturamento Total</p>
            <p id="prevFaturamentoTotal" style="margin: 4px 0 0; font-size: 1.4rem; font-weight: 700; color: #8b5cf6;">-</p>
          </div>
        </div>
        
        <div style="background: rgba(255,255,255,0.03); padding: 12px 14px; border-radius: 8px; border: 1px solid rgba(59,130,246,0.2);">
          <p style="margin: 0; font-size: 0.8rem; color: rgba(255,255,255,0.7); line-height: 1.6;">
            <strong style="color: #3b82f6;">üí° Nota:</strong> Esta √© uma proje√ß√£o matem√°tica simples dos pr√≥ximos 6 meses baseada nos valores que voc√™ forneceu. A IA usar√° essas bases + o contexto do neg√≥cio para criar estrat√©gias e proje√ß√µes mais detalhadas para os 12 meses.
          </p>
        </div>
      </div>
      
      <!-- ‚úçÔ∏è OBSERVA√á√ïES PARA A IA -->
      <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
        <h4 style="margin: 0 0 12px; color: #fff; font-size: 1rem;">
          ‚úçÔ∏è Observa√ß√µes Adicionais (Opcional)
        </h4>
        <p style="margin: 0 0 12px; color: rgba(255,255,255,0.7); font-size: 0.85rem;">
          Adicione contexto ou instru√ß√µes espec√≠ficas para ajudar a IA a gerar uma an√°lise mais personalizada:
        </p>
        <textarea 
          id="metricasObservacoes" 
          placeholder="Exemplos:&#10;‚Ä¢ Nosso nicho tem sazonalidade forte no segundo semestre&#10;‚Ä¢ Estamos lan√ßando um produto novo em mar√ßo&#10;‚Ä¢ Queremos focar mais em leads org√¢nicos a partir do 3¬∫ m√™s&#10;‚Ä¢ Temos limita√ß√£o de or√ßamento nos primeiros 2 meses&#10;‚Ä¢ Considerar Black Friday em novembro..."
          rows="5"
          style="width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; padding: 14px; color: #fff; font-size: 0.9rem; line-height: 1.6; resize: vertical; font-family: inherit;"
        ></textarea>
        <p style="margin: 10px 0 0; color: rgba(255,255,255,0.5); font-size: 0.75rem;">
          üí° A IA levar√° estas observa√ß√µes em considera√ß√£o ao projetar os 12 meses e criar estrat√©gias adaptadas ao seu contexto.
        </p>
      </div>
      
      <!-- üì± METAS DE REDES SOCIAIS -->
      <div style="background: rgba(139,92,246,0.1); border: 1px solid rgba(139,92,246,0.3); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
        <h4 style="margin: 0 0 8px; color: #8b5cf6; font-size: 1rem; display: flex; align-items: center; gap: 8px;">
          üì± Metas de Redes Sociais
          <span style="font-size: 0.7rem; background: rgba(139,92,246,0.2); padding: 3px 8px; border-radius: 6px; font-weight: 500; color: rgba(255,255,255,0.8);">Opcional</span>
        </h4>
        <p style="margin: 0 0 16px; color: rgba(255,255,255,0.7); font-size: 0.85rem;">
          Informe suas bases atuais e metas para as redes sociais. Se n√£o tiver conta, deixe em branco.
        </p>
        
        <!-- Instagram -->
        <div style="margin-bottom: 16px; padding: 14px; background: rgba(255,255,255,0.03); border-radius: 10px; border-left: 3px solid #E1306C;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
            <span style="font-size: 1.2rem;">üì∏</span>
            <strong style="color: #fff; font-size: 0.95rem;">Instagram</strong>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px;">
            <div>
              <label style="color: rgba(255,255,255,0.6); font-size: 0.75rem; display: block; margin-bottom: 4px;">Seguidores Atuais</label>
              <input 
                type="number" 
                id="metricasInstagramAtual" 
                placeholder="Ex: 500"
                min="0"
                style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 8px; border-radius: 6px; width: 100%; font-size: 0.85rem;"
              />
            </div>
            <div>
              <label style="color: rgba(255,255,255,0.6); font-size: 0.75rem; display: block; margin-bottom: 4px;">Meta M√™s 3</label>
              <input 
                type="number" 
                id="metricasInstagramMes3" 
                placeholder="Ex: 1000"
                min="0"
                style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 8px; border-radius: 6px; width: 100%; font-size: 0.85rem;"
              />
            </div>
            <div>
              <label style="color: rgba(255,255,255,0.6); font-size: 0.75rem; display: block; margin-bottom: 4px;">Meta M√™s 6</label>
              <input 
                type="number" 
                id="metricasInstagramMes6" 
                placeholder="Ex: 2000"
                min="0"
                style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 8px; border-radius: 6px; width: 100%; font-size: 0.85rem;"
              />
            </div>
            <div>
              <label style="color: rgba(255,255,255,0.6); font-size: 0.75rem; display: block; margin-bottom: 4px;">Meta M√™s 12</label>
              <input 
                type="number" 
                id="metricasInstagramMes12" 
                placeholder="Ex: 5000"
                min="0"
                style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 8px; border-radius: 6px; width: 100%; font-size: 0.85rem;"
              />
            </div>
          </div>
        </div>
        
        <!-- Facebook -->
        <div style="margin-bottom: 16px; padding: 14px; background: rgba(255,255,255,0.03); border-radius: 10px; border-left: 3px solid #1877F2;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
            <span style="font-size: 1.2rem;">üìò</span>
            <strong style="color: #fff; font-size: 0.95rem;">Facebook</strong>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px;">
            <div>
              <label style="color: rgba(255,255,255,0.6); font-size: 0.75rem; display: block; margin-bottom: 4px;">Seguidores Atuais</label>
              <input 
                type="number" 
                id="metricasFacebookAtual" 
                placeholder="Ex: 300"
                min="0"
                style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 8px; border-radius: 6px; width: 100%; font-size: 0.85rem;"
              />
            </div>
            <div>
              <label style="color: rgba(255,255,255,0.6); font-size: 0.75rem; display: block; margin-bottom: 4px;">Meta M√™s 3</label>
              <input 
                type="number" 
                id="metricasFacebookMes3" 
                placeholder="Ex: 800"
                min="0"
                style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 8px; border-radius: 6px; width: 100%; font-size: 0.85rem;"
              />
            </div>
            <div>
              <label style="color: rgba(255,255,255,0.6); font-size: 0.75rem; display: block; margin-bottom: 4px;">Meta M√™s 6</label>
              <input 
                type="number" 
                id="metricasFacebookMes6" 
                placeholder="Ex: 1500"
                min="0"
                style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 8px; border-radius: 6px; width: 100%; font-size: 0.85rem;"
              />
            </div>
            <div>
              <label style="color: rgba(255,255,255,0.6); font-size: 0.75rem; display: block; margin-bottom: 4px;">Meta M√™s 12</label>
              <input 
                type="number" 
                id="metricasFacebookMes12" 
                placeholder="Ex: 3000"
                min="0"
                style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 8px; border-radius: 6px; width: 100%; font-size: 0.85rem;"
              />
            </div>
          </div>
        </div>
        
        <!-- LinkedIn -->
        <div style="margin-bottom: 16px; padding: 14px; background: rgba(255,255,255,0.03); border-radius: 10px; border-left: 3px solid #0A66C2;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
            <span style="font-size: 1.2rem;">üíº</span>
            <strong style="color: #fff; font-size: 0.95rem;">LinkedIn</strong>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px;">
            <div>
              <label style="color: rgba(255,255,255,0.6); font-size: 0.75rem; display: block; margin-bottom: 4px;">Seguidores Atuais</label>
              <input 
                type="number" 
                id="metricasLinkedinAtual" 
                placeholder="Ex: 200"
                min="0"
                style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 8px; border-radius: 6px; width: 100%; font-size: 0.85rem;"
              />
            </div>
            <div>
              <label style="color: rgba(255,255,255,0.6); font-size: 0.75rem; display: block; margin-bottom: 4px;">Meta M√™s 3</label>
              <input 
                type="number" 
                id="metricasLinkedinMes3" 
                placeholder="Ex: 500"
                min="0"
                style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 8px; border-radius: 6px; width: 100%; font-size: 0.85rem;"
              />
            </div>
            <div>
              <label style="color: rgba(255,255,255,0.6); font-size: 0.75rem; display: block; margin-bottom: 4px;">Meta M√™s 6</label>
              <input 
                type="number" 
                id="metricasLinkedinMes6" 
                placeholder="Ex: 1000"
                min="0"
                style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 8px; border-radius: 6px; width: 100%; font-size: 0.85rem;"
              />
            </div>
            <div>
              <label style="color: rgba(255,255,255,0.6); font-size: 0.75rem; display: block; margin-bottom: 4px;">Meta M√™s 12</label>
              <input 
                type="number" 
                id="metricasLinkedinMes12" 
                placeholder="Ex: 2500"
                min="0"
                style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 8px; border-radius: 6px; width: 100%; font-size: 0.85rem;"
              />
            </div>
          </div>
        </div>
        
        <!-- TikTok -->
        <div style="padding: 14px; background: rgba(255,255,255,0.03); border-radius: 10px; border-left: 3px solid #000000;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
            <span style="font-size: 1.2rem;">üéµ</span>
            <strong style="color: #fff; font-size: 0.95rem;">TikTok</strong>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px;">
            <div>
              <label style="color: rgba(255,255,255,0.6); font-size: 0.75rem; display: block; margin-bottom: 4px;">Seguidores Atuais</label>
              <input 
                type="number" 
                id="metricasTiktokAtual" 
                placeholder="Ex: 100"
                min="0"
                style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 8px; border-radius: 6px; width: 100%; font-size: 0.85rem;"
              />
            </div>
            <div>
              <label style="color: rgba(255,255,255,0.6); font-size: 0.75rem; display: block; margin-bottom: 4px;">Meta M√™s 3</label>
              <input 
                type="number" 
                id="metricasTiktokMes3" 
                placeholder="Ex: 500"
                min="0"
                style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 8px; border-radius: 6px; width: 100%; font-size: 0.85rem;"
              />
            </div>
            <div>
              <label style="color: rgba(255,255,255,0.6); font-size: 0.75rem; display: block; margin-bottom: 4px;">Meta M√™s 6</label>
              <input 
                type="number" 
                id="metricasTiktokMes6" 
                placeholder="Ex: 1500"
                min="0"
                style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 8px; border-radius: 6px; width: 100%; font-size: 0.85rem;"
              />
            </div>
            <div>
              <label style="color: rgba(255,255,255,0.6); font-size: 0.75rem; display: block; margin-bottom: 4px;">Meta M√™s 12</label>
              <input 
                type="number" 
                id="metricasTiktokMes12" 
                placeholder="Ex: 5000"
                min="0"
                style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 8px; border-radius: 6px; width: 100%; font-size: 0.85rem;"
              />
            </div>
          </div>
        </div>
        
        <p style="margin: 14px 0 0; color: rgba(255,255,255,0.5); font-size: 0.75rem;">
          üí° Deixe em branco se n√£o tiver alguma rede social ou se n√£o tiver metas definidas. A IA usar√° apenas os dados fornecidos.
        </p>
      </div>

    </div>
    
    <div class="landing-info-footer">
      <button class="landing-info-cancel-btn" onclick="fecharModalMetricasMes()">Cancelar</button>
      <button class="landing-info-confirm-btn" id="metricasConfirmBtn" onclick="confirmarMetricasMes()">
        üöÄ Gerar An√°lise Completa
      </button>
    </div>
  </div>
</div>

</body>
</html>
<!-- partial -->
<!-- Modal: Pedir Revis√£o (coleta observa√ß√µes) -->
<div aria-hidden="true" class="modal" id="reviewModal">
<div aria-modal="true" class="modal-card small" role="dialog">
<div class="modal-head">
<strong>Pedir revis√£o</strong>
<button class="btn small secondary" id="reviewCancel">Fechar</button>
</div>
<div class="modal-body" style="grid-template-columns: 1fr">
<div class="info">
<label class="muted" style="display:block; margin:6px 0">Descreva o que precisa ser ajustado</label>
<textarea id="reviewText" placeholder="Ex.: trocar a m√∫sica, cortar os 3s iniciais, corrigir texto..."></textarea>
</div>
</div>
<div class="modal-foot">
<button class="btn small" id="reviewSend">Enviar observa√ß√£o</button>
</div>
</div>
</div>
<script>
  (function(){
    function fixPreviewMedia(){
      var wrap = document.getElementById('modalPreview'); if(!wrap) return;
      var vid = wrap.querySelector('video');
      if(vid){
        vid.setAttribute('playsinline','');
        vid.setAttribute('controls','');
        vid.setAttribute('webkit-playsinline','');
        vid.style.maxHeight = '56vh';
        vid.style.width = '100%';
        vid.style.height = 'auto';
      }
      var img = wrap.querySelector('img');
      if(img){
        img.style.maxHeight = '56vh';
        img.style.width = '100%';
        img.style.height = 'auto';
        img.style.objectFit = 'contain';
        img.decoding = 'async';
      }
    }
    // Run after modal content swaps
    const pm = document.getElementById('postModal');
    if(pm){
      const obs = new MutationObserver(fixPreviewMedia);
      obs.observe(pm, { childList:true, subtree:true });
    }
    // Also run on load
    document.addEventListener('DOMContentLoaded', fixPreviewMedia);
  })();
</script>
<script>
  (function(){
    var postModal = document.getElementById('postModal');
    if(!postModal) return;
    function toggleBodyLock(){
      if(postModal.classList.contains('show')){
        document.documentElement.style.overflow = 'hidden';
        document.body.style.overflow = 'hidden';
      } else {
        document.documentElement.style.overflow = '';
        document.body.style.overflow = '';
      }
    }
    var mo = new MutationObserver(toggleBodyLock);
    mo.observe(postModal, { attributes: true, attributeFilter: ['class'] });
    toggleBodyLock();
  })();
</script>
<script>
(function(){
  // fechar ao tocar fora do cart√£o
  var modals = document.querySelectorAll('.modal');
  modals.forEach(function(m){
    m.addEventListener('click', function(e){
      if(e.target === m){ m.classList.remove('show'); } // backdrop
    }, {passive:true});
  });
  // swipe down para fechar reviewModal
  var rm = document.getElementById('reviewModal');
  if(rm){
    var startY=0, delta=0;
    rm.addEventListener('touchstart', function(ev){ startY = ev.touches[0].clientY; delta=0; }, {passive:true});
    rm.addEventListener('touchmove', function(ev){ delta = ev.touches[0].clientY - startY; }, {passive:true});
    rm.addEventListener('touchend', function(){ if(delta > 80){ rm.classList.remove('show'); } }, {passive:true});
  }
})();
</script>
<script>
(function(){
  function setupReelsOverlay(){
    var pv = document.getElementById('modalPreview');
    if(!pv) return;
    // ensure container is relative
    pv.classList.add('preview');
    // find media
    var v = pv.querySelector('video');
    // If no video, remove play overlay if exists
    var existingPlay = document.getElementById('reelsPlayOverlay');
    var existingClose = document.getElementById('reelsCloseOverlay');
    if(!v){
      if(existingPlay) existingPlay.remove();
      if(existingClose) existingClose.remove();
      return;
    }
    // attributes to behave inline
    v.setAttribute('playsinline','');
    v.setAttribute('webkit-playsinline','');
    v.setAttribute('controls','');
    v.style.objectFit = 'contain';
    v.style.background = '#000';
    v.style.maxHeight = '62dvh';

    // create overlays if missing
    var play = existingPlay;
    if(!play){
      play = document.createElement('div');
      play.id = 'reelsPlayOverlay';
      pv.appendChild(play);
    }
    var closeX = existingClose;
    if(!closeX){
      closeX = document.createElement('button');
      closeX.id = 'reelsCloseOverlay';
      closeX.type = 'button';
      closeX.textContent = '√ó';
      pv.appendChild(closeX);
      closeX.addEventListener('click', function(e){
        e.stopPropagation();
        try{ document.getElementById('postModal').classList.remove('show'); }catch(_){};
      }, {passive:true});
    }

    // show play overlay when paused, hide when playing
    function syncOverlay(){
      if(v.paused){ play.style.display = 'flex'; } else { play.style.display = 'none'; }
    }
    v.addEventListener('play', syncOverlay, {passive:true});
    v.addEventListener('pause', syncOverlay, {passive:true});
    v.addEventListener('ended', syncOverlay, {passive:true});
    syncOverlay();

    // tap to toggle play/pause when tapping on overlay
    play.addEventListener('click', function(e){
      e.stopPropagation();
      try{ v.play(); }catch(_){};
    }, {passive:true});
  }

  // Run on DOM ready and whenever modal content changes
  document.addEventListener('DOMContentLoaded', setupReelsOverlay);
  var pm = document.getElementById('postModal');
  if(pm){
    var mo = new MutationObserver(function(){ setupReelsOverlay(); });
    mo.observe(pm, { childList:true, subtree:true });
  }
})();
</script>
<script>
(function(){
  // singleton fullscreen close button
  var fsBtn = document.getElementById('fsCloseOverlay');
  if(!fsBtn){
    fsBtn = document.createElement('button');
    fsBtn.id = 'fsCloseOverlay';
    fsBtn.type = 'button';
    fsBtn.textContent = '√ó';
    document.body.appendChild(fsBtn);
  }
  function isFullscreen(){
    return !!(document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement);
  }
  function exitFS(){
    if(document.exitFullscreen){ document.exitFullscreen().catch(()=>{}); }
    else if(document.webkitExitFullscreen){ document.webkitExitFullscreen(); }
    // iOS video API
    var vf = document.querySelector('video');
    if(vf && typeof vf.webkitExitFullscreen === 'function'){
      try{ vf.webkitExitFullscreen(); }catch(_){}
    }
  }
  function enterFSForVideo(v){
    // Try vendor-prefixed first for iOS Safari
    if(typeof v.webkitEnterFullscreen === 'function'){
      try{ v.webkitEnterFullscreen(); return true; }catch(_){}
    }
    // Generic Fullscreen API
    if(v.requestFullscreen){ v.requestFullscreen().catch(()=>{}); return true; }
    if(v.webkitRequestFullscreen){ v.webkitRequestFullscreen(); return true; }
    return false;
  }
  function onFSChange(){
    // toggle global close 'X' in fullscreen
    fsBtn.style.display = isFullscreen() ? 'block' : 'none';
    if(!isFullscreen()){
      // when leaving fullscreen, pause and show play overlay again
      var pv = document.getElementById('modalPreview');
      var v = pv && pv.querySelector('video');
      if(v){ try{ v.pause(); }catch(_){ } }
      var play = document.getElementById('reelsPlayOverlay');
      if(play){ play.style.display = 'flex'; }
    }
  }
  ['fullscreenchange','webkitfullscreenchange','msfullscreenchange'].forEach(function(evt){
    document.addEventListener(evt, onFSChange);
  });
  fsBtn.addEventListener('click', function(ev){
    ev.preventDefault(); ev.stopPropagation();
    exitFS();
  }, {passive:false});

  function hookupPlayToFullscreen(){
    var pv = document.getElementById('modalPreview'); if(!pv) return;
    var v = pv.querySelector('video'); if(!v) return;
    var play = document.getElementById('reelsPlayOverlay'); if(!play) return;
    // Center play tap -> enter fullscreen and play
    play.addEventListener('click', function(e){
      e.preventDefault(); e.stopPropagation();
      // Ensure we start at currentTime (no reset)
      if(enterFSForVideo(v)){ setTimeout(function(){ try{ v.play(); }catch(_){} }, 150); }
      else { try{ v.play(); }catch(_){} }
    }, {passive:false});
  }

  document.addEventListener('DOMContentLoaded', hookupPlayToFullscreen);
  var pm = document.getElementById('postModal');
  if(pm){
    var mo = new MutationObserver(function(){ hookupPlayToFullscreen(); });
    mo.observe(pm, {childList:true, subtree:true});
  }
})();
</script>
<script>
(function(){
  function fmtDate(ts){
    try{
      if(!ts) return '';
      if(typeof ts === 'number'){ var d = new Date(ts); }
      else if(ts && ts.seconds){ var d = new Date(ts.seconds*1000); }
      else if(typeof ts === 'string'){ var d = new Date(ts); }
      else { return ''; }
      const pad=n=>String(n).padStart(2,'0');
      return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+' '+pad(d.getHours())+':'+pad(d.getMinutes());
    }catch(_){ return ''; }
  }
  function esc(s){ return (s||'').replace(/[&<>]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m])); }

  function ensureNotesContainer(){
    const modal = document.getElementById('postModal');
    if(!modal) return null;
    // Find the label "Observa√ß√µes do cliente"
    const labels = modal.querySelectorAll('label, .label, .field-label, h4, h5');
    let anchor = null;
    labels.forEach(el => {
      const t = (el.textContent||'').trim().toLowerCase();
      if(!anchor && (t === 'observa√ß√µes do cliente' || t === 'observacoes do cliente')) anchor = el;
    });
    if(!anchor){
      // try to find by placeholder on input
      const input = modal.querySelector('input[placeholder*="observa"], textarea[placeholder*="observa"]');
      if(input) anchor = input.closest('.field') || input.parentElement;
    }
    if(!anchor) return null;

    // Insert container after the field block
    // Find block wrapper (field group)
    let block = anchor.closest('.field, .row, div');
    if(!block) block = anchor.parentElement;
    // place after this block
    // If already exists, return it
    let list = modal.querySelector('#clientNotesList');
    if(list) return list;
    list = document.createElement('div');
    list.id = 'clientNotesList';
    // Insert after block
    if(block.nextSibling){
      block.parentNode.insertBefore(list, block.nextSibling);
    }else{
      block.parentNode.appendChild(list);
    }
    return list;
  }

  function renderClientNotes(post){
    try{
      const list = ensureNotesContainer();
      if(!list) return;
      const notes = Array.isArray(post && post.reviewNotes) ? post.reviewNotes : [];
      if(notes.length === 0){
        list.innerHTML = '<div class="client-note"><div class="txt" style="color:var(--muted,#bbb)">Sem observa√ß√µes do cliente ainda.</div></div>';
        return;
      }
      const html = notes.map(n => {
        const author = (n.by||'').split('@')[0] || 'cliente';
        const when = fmtDate(n.at);
        const textHtml = renderMarkdownText(n.text||'');
        return '<div class="client-note">'
          + '<div class="dot"></div>'
          + '<div class="txt markdown-view">' + textHtml + '<div class="meta">por ' + esc(author) + (when? ' ‚Ä¢ ' + esc(when) : '') + '</div></div>'
          + '</div>';
      }).join('');
      list.innerHTML = html;
    }catch(e){ /* noop */ }
  }

  // Hook into modal updates: expect a global CURRENT_POST or read from DOM attributes if used
  function getCurrentPost(){
    try{
      if(window.CURRENT_POST) return window.CURRENT_POST;
      // fallback: if your app stores post id on modal
      const pm = document.getElementById('postModal');
      const id = pm && pm.getAttribute('data-post-id');
      if(id && window.POSTS && Array.isArray(window.POSTS)){
        return window.POSTS.find(p=>p.id===id);
      }
    }catch(_){}
    return null;
  }

  function update(){
    const p = getCurrentPost();
    if(p) renderClientNotes(p);
  }

  document.addEventListener('DOMContentLoaded', update);
  const pm = document.getElementById('postModal');
  if(pm){
    const mo = new MutationObserver(function(){ update(); });
    mo.observe(pm, { childList:true, subtree:true, attributes:true });
  }
  // Also refresh after any Firestore change if app exposes POSTS globally
  if(Array.isArray(window.POSTS)){
    setInterval(update, 1200);
  }
})();
</script>
<script>
(function(){
  function toast(msg){
    var el=document.createElement('div');
    el.textContent=msg;
    el.style.cssText='position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:rgba(0,0,0,.85);color:#fff;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.2);z-index:100000;font-weight:800';
    document.body.appendChild(el);
    setTimeout(function(){ el.remove(); }, 3000);
  }
  function patchApproveButton(btn){
    if(btn && !btn.__patched){
      btn.__patched = true;
      btn.style.background = '#2e7d32';
      btn.style.borderColor = '#2e7d32';
      var orig = btn.onclick;
      btn.onclick = function(ev){
        if(typeof orig === 'function'){ orig.call(btn, ev); }
        var msg = btn.id === 'btnApproveInternal' ? 'Aprova√ß√£o interna registrada!' : 'Obrigado! J√° vamos agendar este post!';
        toast(msg);
        setTimeout(function(){
          var modal=document.getElementById('postModal');
          if(modal) modal.classList.remove('show');
        }, 3000);
      };
    }
  }
  patchApproveButton(document.getElementById('btnApprove'));
  patchApproveButton(document.getElementById('btnApproveInternal'));

  // Fullscreen image viewer
  function setupImageFS(){
    var pv=document.getElementById('modalPreview'); if(!pv) return;
    var img=pv.querySelector('img'); if(!img || img.__fsBound) return;
    img.__fsBound=true;
    var backdrop=document.getElementById('imgFsBackdrop');
    if(!backdrop){
      backdrop=document.createElement('div');
      backdrop.id='imgFsBackdrop';
      backdrop.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.95);display:none;align-items:center;justify-content:center;z-index:100000';
      backdrop.innerHTML='<img id="imgFsContent" style="max-width:100%;max-height:100%;object-fit:contain"><button id="imgFsClose" style="position:fixed;top:12px;right:12px;padding:8px 12px;border-radius:12px;background:rgba(0,0,0,.6);color:#fff;font-weight:800;border:1px solid rgba(255,255,255,.25)">√ó</button>';
      document.body.appendChild(backdrop);
      backdrop.querySelector('#imgFsClose').onclick=function(){ backdrop.style.display='none'; };
    }
    var fsImg=document.getElementById('imgFsContent');
    img.style.cursor='zoom-in';
    img.addEventListener('click',function(){
      fsImg.src=img.currentSrc||img.src;
      backdrop.style.display='flex';
    });
  }
  document.addEventListener('DOMContentLoaded', setupImageFS);
  var pm=document.getElementById('postModal');
  if(pm){
    var mo=new MutationObserver(setupImageFS);
    mo.observe(pm,{childList:true,subtree:true});
  }
})();
</script>
<script>
(function(){
  function getCurrentPost(){
    try{
      if(window.selectedPost) return window.selectedPost;
      if(window.CURRENT_POST) return window.CURRENT_POST;
      var pm = document.getElementById('postModal');
      var id = pm && pm.getAttribute('data-post-id');
      if(id && Array.isArray(window.POSTS)){
        return window.POSTS.find(p=>p.id===id);
      }
    }catch(e){}
    return null;
  }
  function guessVideo(u){
    if(!u) return false;
    var clean = (u.split('?')[0]||'').toLowerCase();
    return /\.(mp4|mov|webm|m4v|avi)$/.test(clean);
  }
  function buildCarousel(){
    var pm = document.getElementById('postModal');
    var pv = document.getElementById('modalPreview');
    if(!pm || !pv || !pm.classList.contains('show')) return;
    var post = getCurrentPost();
    if(!post) return;

    var urls = Array.isArray(post.mediaUrls) && post.mediaUrls.length ? post.mediaUrls.slice() : [];
    if(!urls.length && post.thumbUrl) urls = [post.thumbUrl];

    if(urls.length <= 1){
      // Single media: ensure stage exists but no arrows
      var u = urls[0];
      var markup = '<div class="pv-stage"><div class="pv-media">'
                 + (guessVideo(u)? '<video src="'+u+'" controls playsinline webkit-playsinline></video>'
                                 : '<img src="'+(u||'')+'" alt="">')
                 + '</div></div>';
      pv.innerHTML = markup;
      pv.classList.remove('pv-has-many','pv-hint','pv-hint-end');
      return;
    }

    var idx = 0;
    pv.classList.add('pv-has-many','pv-hint');
    pv.innerHTML = '<div class="pv-stage">'
                 + '  <div class="pv-media" id="pvMedia"></div>'
                 + '  <button type="button" class="pv-arrow left" aria-label="Anterior">‚Äπ</button>'
                 + '  <button type="button" class="pv-arrow right" aria-label="Pr√≥ximo">‚Ä∫</button>'
                 + '</div>';
    var mediaBox = pv.querySelector('#pvMedia');
    var prev = pv.querySelector('.pv-arrow.left');
    var next = pv.querySelector('.pv-arrow.right');

    function render(){
      var u = urls[idx];
      mediaBox.innerHTML = guessVideo(u)
        ? '<video src="'+u+'" controls playsinline webkit-playsinline></video>'
        : '<img src="'+u+'" alt="m√≠dia '+(idx+1)+'">';
    }
    function go(d){ idx = (idx + d + urls.length) % urls.length; render(); stopHint(); }

    prev.onclick = function(e){ e.stopPropagation(); go(-1); };
    next.onclick = function(e){ e.stopPropagation(); go(+1); };

    // Swipe (mobile)
    var sx=0, sy=0, dx=0, dy=0, moved=false;
    mediaBox.addEventListener('touchstart', function(ev){
      var t=ev.touches[0]; sx=t.clientX; sy=t.clientY; dx=dy=0; moved=false;
    }, {passive:true});
    mediaBox.addEventListener('touchmove', function(ev){
      var t=ev.touches[0]; dx=t.clientX - sx; dy=t.clientY - sy;
      if(Math.abs(dx) > 18 && Math.abs(dx) > Math.abs(dy)){ moved = true; ev.preventDefault(); }
    }, {passive:false});
    mediaBox.addEventListener('touchend', function(){
      if(moved){
        if(dx < -30) go(+1);
        if(dx >  30) go(-1);
      }
    }, {passive:true});

    // Keyboard (desktop)
    function onKey(e){
      if(!pm.classList.contains('show')) return;
      if(e.key==='ArrowLeft') go(-1);
      if(e.key==='ArrowRight') go(+1);
    }
    document.addEventListener('keydown', onKey);

    function stopHint(){
      pv.classList.remove('pv-hint'); pv.classList.add('pv-hint-end');
    }
    prev.addEventListener('click', stopHint, {passive:true});
    next.addEventListener('click', stopHint, {passive:true});
    mediaBox.addEventListener('click', stopHint, {passive:true});

    // Clean up when modal closes
    var mo = new MutationObserver(function(){
      if(!pm.classList.contains('show')){
        document.removeEventListener('keydown', onKey);
        mo.disconnect();
      }
    });
    mo.observe(pm, {attributes:true, attributeFilter:['class']});

    render();
  }

  // Rebuild on modal open/content changes
  document.addEventListener('DOMContentLoaded', function(){
    var pm = document.getElementById('postModal');
    if(!pm) return;
    var obs = new MutationObserver(function(){
      if(pm.classList.contains('show')){
        setTimeout(buildCarousel, 30);
      }
    });
    obs.observe(pm, {attributes:true, attributeFilter:['class'], childList:true, subtree:true});
  });
})();
</script>
<!-- ========== PATCH: iframes persistentes por TENANT (n√£o altera login) ========== -->
<script>
/**
 * MediaGrowth Dashboard ‚Äì Persist√™ncia de iFrames por TENANT (sem alterar login)
 * O que faz:
 *  - Salva/Carrega seus widgets/iframes com chave: TENANT + se√ß√£o (ex.: "ACME-ads-widgets")
 *  - Migra automaticamente os dados antigos (sem TENANT) para o novo formato
 *  - Mant√©m seu fluxo atual (drag, altura, etc). Login permanece igual.
 *
 * Pr√©-requisitos que seu projeto j√° tem:
 *  - window.TENANT (string), window.currentSection (string)
 *  - Firebase v9 globais: auth, db, setDoc, doc
 *  - USER_DATA (objeto cache), WIDGETS (array), uuid() (opcional; existe fallback)
 */
(function(){
  try {
    if (typeof window === 'undefined') return;
    const g = window;
    const hasFirebase = !!(g.auth && g.db && g.setDoc && g.doc);

    function nsKey(section, suffix){
      const base = (typeof g.TENANT === 'string' && g.TENANT) ? (g.TENANT + '-') : '';
      return base + section + '-' + suffix;
    }
    function legacyKey(section, suffix){
      return section + '-' + suffix;
    }
    async function writeUserDoc(fields){
      if (!hasFirebase) return;
      const uid = g.auth?.currentUser?.uid;
      if (!uid) return;
      await g.setDoc(g.doc(g.db, 'usuarios', uid), fields, { merge: true });
    }
    function ensureUUID(){
      if (typeof g.uuid === 'function') return g.uuid;
      return function uuidLite(){
        return 'u-' + Math.random().toString(36).slice(2) + Date.now().toString(36);
      };
    }
    const mkUUID = ensureUUID();

    // Deixa k(suffix) TENANT-aware (ou cria, se n√£o existir)
    if (typeof g.k === 'function' && !g.k.__patchedByTenant) {
      const oldK = g.k;
      g.k = function(suffix){
        try {
          const raw = oldK(suffix);
          const t = (typeof g.TENANT === 'string' && g.TENANT) ? g.TENANT : null;
          if (!t) return legacyKey(g.currentSection || 'default', suffix);
          return raw && raw.startsWith(t + '-') ? raw : nsKey(g.currentSection || 'default', suffix);
        } catch(e){
          return nsKey(g.currentSection || 'default', suffix);
        }
      };
      g.k.__patchedByTenant = true;
      g.k.__old = oldK;
      console.info('[iframes-persist] k() est√° TENANT-aware.');
    } else if (typeof g.k !== 'function') {
      g.k = function(suffix){
        const sec = (typeof g.currentSection === 'string' && g.currentSection) ? g.currentSection : 'default';
        return nsKey(sec, suffix);
      };
      g.k.__patchedByTenant = true;
      console.info('[iframes-persist] k() injetado (TENANT-aware).');
    }

    // Migra√ß√£o (uma vez): legacy -> TENANT
    async function migrateOnce(){
      try {
        const section = (typeof g.currentSection === 'string' && g.currentSection) ? g.currentSection : 'default';
        const newKey = nsKey(section, 'widgets');
        const oldKey = legacyKey(section, 'widgets');

        g.USER_DATA = g.USER_DATA || {};
        if (Array.isArray(g.USER_DATA[newKey])) return; // j√° migrado

        let legacy = Array.isArray(g.USER_DATA[oldKey]) ? g.USER_DATA[oldKey] : null;

        // Ultra-legacy (widget-0-title/url/...)
        if (!legacy) {
          const ultra = [];
          const keys = Object.keys(g.USER_DATA || {});
          const grouped = {};
          keys.forEach(key => {
            const m = key.match(/^widget-(\d+)-(title|url|embed|h|order|id)$/i);
            if (m) {
              const idx = m[1], prop = m[2];
              grouped[idx] = grouped[idx] || {};
              grouped[idx][prop] = g.USER_DATA[key];
            }
          });
          Object.keys(grouped).sort((a,b)=> (+a)-(+b)).forEach(idx => {
            const w = grouped[idx];
            if (w && (w.title || w.url || w.embed)) {
              ultra.push({
                id: w.id || mkUUID(),
                title: w.title || '',
                url: w.url || '',
                embed: w.embed || '',
                h: w.h,
                order: (typeof w.order === 'number') ? w.order : (+idx)||0
              });
            }
          });
          if (ultra.length) legacy = ultra;
        }

        if (Array.isArray(legacy) && legacy.length) {
          const normalized = legacy.map((w,i)=> ({
            id: w.id || mkUUID(),
            title: w.title || '',
            url: w.url || '',
            embed: w.embed || '',
            h: w.h,
            order: (typeof w.order === 'number') ? w.order : i
          }));
          g.USER_DATA[newKey] = normalized;
          g.USER_DATA[oldKey] = legacy; // compat
          const result = await safeWriteUserDoc({ [newKey]: normalized, [oldKey]: legacy });
          if(!result.success) {
            console.error('[iframes-persist] Falha ao salvar migra√ß√£o:', result.error);
            throw new Error(result.error);
          }
          console.info('[iframes-persist] Migrado para TENANT:', newKey);
        }
      } catch(e){
        console.warn('[iframes-persist] Migra√ß√£o ignorada:', e);
      }
    }

    async function defaultLoadWidgets(){
      const section = (typeof g.currentSection === 'string' && g.currentSection) ? g.currentSection : 'default';
      const key = nsKey(section, 'widgets');
      g.USER_DATA = g.USER_DATA || {};

      let arr = Array.isArray(g.USER_DATA[key]) ? g.USER_DATA[key] : null;
      if (!arr || !arr.length) {
        await migrateOnce();
        arr = Array.isArray(g.USER_DATA[key]) ? g.USER_DATA[key] : null;
      }
      if (!arr || !arr.length) {
        arr = [{ id: mkUUID(), title: 'Widget 1', url: '' }];
        g.USER_DATA[key] = arr;
        const result = await safeWriteUserDoc({ [key]: arr });
        if(!result.success) {
          console.error('[widgets] Falha ao salvar widgets iniciais:', result.error);
        }
      }
      arr = arr.map((w,i)=> ({
        id: w.id || mkUUID(),
        title: w.title || '',
        url: w.url || '',
        embed: w.embed || '',
        h: w.h,
        order: (typeof w.order === 'number') ? w.order : i
      })).sort((a,b)=> (a.order||0)-(b.order||0));

      g.WIDGETS = arr;
      return arr;
    }

    async function defaultPersistWidgets(){
      const uid = g.auth?.currentUser?.uid;
      if (!uid) return;
      const section = (typeof g.currentSection === 'string' && g.currentSection) ? g.currentSection : 'default';
      const key = nsKey(section, 'widgets');

      g.WIDGETS = Array.isArray(g.WIDGETS) ? g.WIDGETS : [];
      g.WIDGETS = g.WIDGETS.map((w,i)=> ({ ...w, id: w.id || mkUUID(), order: i }));
      g.USER_DATA = g.USER_DATA || {};
      g.USER_DATA[key] = g.WIDGETS;

      const result = await safeWriteUserDoc({ [key]: g.WIDGETS });
      if(!result.success) {
        console.error('[widgets] Falha ao persistir widgets:', result.error);
      }
    }

    // ‚ÄúEnvolve‚Äù fun√ß√µes existentes; se n√£o houver, fornece padr√£o
    let hookedLoad = false, hookedPersist = false;
    if (typeof g.loadWidgetsFromData === 'function' && !g.loadWidgetsFromData.__patchedByTenant) {
      const oldLoad = g.loadWidgetsFromData;
      g.loadWidgetsFromData = async function(){
        await migrateOnce();
        try { await oldLoad.apply(this, arguments); } catch(e){ /* continua */ }
        await defaultLoadWidgets(); // garante namespace/normaliza√ß√£o
        return g.WIDGETS;
      };
      g.loadWidgetsFromData.__patchedByTenant = true;
      g.loadWidgetsFromData.__old = oldLoad;
      hookedLoad = true;
      console.info('[iframes-persist] loadWidgetsFromData() hook aplicado.');
    }
    if (typeof g.persistWidgets === 'function' && !g.persistWidgets.__patchedByTenant) {
      const oldPersist = g.persistWidgets;
      g.persistWidgets = async function(){
        try { await oldPersist.apply(this, arguments); } catch(e){ /* continua */ }
        await defaultPersistWidgets(); // grava no namespace TENANT
      };
      g.persistWidgets.__patchedByTenant = true;
      g.persistWidgets.__old = oldPersist;
      hookedPersist = true;
      console.info('[iframes-persist] persistWidgets() hook aplicado.');
    }
    if (!hookedLoad)  g.loadWidgetsFromData  = defaultLoadWidgets;
    if (!hookedPersist) g.persistWidgets     = defaultPersistWidgets;

    // Aviso opcional quando o site bloqueia iframe (X-Frame-Options/CSP)
    try {
      const observer = new MutationObserver((mutations)=>{
        mutations.forEach(m=>{
          m.addedNodes && Array.from(m.addedNodes).forEach(node=>{
            if (node && node.tagName === 'IFRAME') {
              node.addEventListener('error', ()=>{
                const wrap = document.createElement('div');
                wrap.style.padding = '12px';
                wrap.style.border = '1px dashed #999';
                wrap.style.borderRadius = '8px';
                wrap.style.fontSize = '12px';
                wrap.style.marginTop = '6px';
                wrap.innerHTML = 'Este conte√∫do bloqueou o carregamento em iframe (X-Frame-Options/CSP). <a href="'+(node.src||'#')+'" target="_blank" rel="noopener">Abrir em nova aba</a>';
                node.parentNode && node.parentNode.insertBefore(wrap, node.nextSibling);
              }, { once:true });
            }
          });
        });
      });
      observer.observe(document.documentElement || document.body, { childList:true, subtree:true });
    } catch(e){ /* opcional */ }

    // Carrega assim que o usu√°rio estiver autenticado (login inalterado)
    if (hasFirebase) {
      if (g.auth?.currentUser) {
        defaultLoadWidgets();
      } else if (typeof g.auth?.onAuthStateChanged === 'function') {
        g.auth.onAuthStateChanged(function(u){
          if (u) defaultLoadWidgets();
        });
      }
    }
  } catch (err) {
    console.warn('[iframes-persist] Erro no patch:', err);
  }
})();
</script>
<!-- ========== /PATCH ========== -->
<!-- MG IFRAME PERSISTENCE PATCH v1.2 | Keeps iframe widgets permanently saved (Firestore + localStorage fallback) -->
<script>
(function(){
  if(window.__MG_IFRAME_PERSIST_PATCH__) return; // avoid double injection
  window.__MG_IFRAME_PERSIST_PATCH__ = true;

  const LS_KEY = "mg_iframes_backup_v2";
  const GRID_SELECTOR = ".widgets-grid";
  const CARD_SELECTOR = ".widget-card";
  const IFRAME_SELECTOR = "iframe.widget-iframe";
  const FRAME_SHELL_CLASS = "frame-shell";
  const META_ATTR_ID = "data-wid";

  function $(sel, root){ return (root||document).querySelector(sel); }
  function $all(sel, root){ return Array.from((root||document).querySelectorAll(sel)); }

  function log(){ try{ console.log("[MG-PERSIST]", ...arguments); }catch(_){ } }

  function uid(){ return (window.auth && window.auth.currentUser) ? window.auth.currentUser.uid : null; }
  function now(){ return Date.now(); }

  // ----- helpers to read/write Firestore if available -----
  async function saveToFirestore(snapshot){
    try{
      if(!(window.db && window.doc && window.setDoc && window.serverTimestamp && uid())) return false;
      const ref = window.doc(window.db, "usuarios", uid(), "settings", "iframes");
      await window.setDoc(ref, { widgets: snapshot, updatedAt: window.serverTimestamp() }, { merge: true });
      return true;
    }catch(e){ console.warn("Firestore save error", e); return false; }
  }
  async function loadFromFirestore(){
    try{
      if(!(window.db && window.doc && window.getDoc && uid())) return null;
      const ref = window.doc(window.db, "usuarios", uid(), "settings", "iframes");
      const snap = await window.getDoc(ref);
      if(snap && snap.exists && snap.exists()){ 
        const data = snap.data && snap.data() || {};
        return Array.isArray(data.widgets) ? data.widgets : null;
      }
      return null;
    }catch(e){ console.warn("Firestore load error", e); return null; }
  }

  function saveToLocal(snapshot){
    try{ localStorage.setItem(LS_KEY, JSON.stringify({t:now(), widgets:snapshot})); }catch(_){}
  }
  function loadFromLocal(){
    try{ const raw = localStorage.getItem(LS_KEY); if(!raw) return null;
      const obj = JSON.parse(raw); return Array.isArray(obj.widgets) ? obj.widgets : null;
    }catch(_){ return null; }
  }

  // build a serializable snapshot of current iframe widgets
  function takeSnapshot(){
    const grid = $(GRID_SELECTOR); if(!grid) return [];
    const out = [];
    $all(CARD_SELECTOR, grid).forEach((card, idx)=>{
      try{
        const iframe = $(IFRAME_SELECTOR, card);
        const shell = $("."+FRAME_SHELL_CLASS, card) || card;
        const titleEl = $(".widget-title", card);
        const title = titleEl ? titleEl.textContent.trim() : "";
        const src = iframe ? iframe.getAttribute("src") || "" : "";
        if(!src) return;
        const h = (shell && shell.style && shell.style.height) ? shell.style.height : "";
        const id = card.getAttribute(META_ATTR_ID) || ("w"+(idx+1));
        out.push({ id, title, src, height: h });
      }catch(_){}
    });
    return out;
  }

  function createCard(w){
    const id = w.id || ("w"+Math.random().toString(36).slice(2,7));
    const title = (w.title || "Widget");
    const src = w.src || "";
    const h = w.height || "720px";

    const card = document.createElement("div");
    card.className = "widget-card";
    card.setAttribute(META_ATTR_ID, id);

    const head = document.createElement("div");
    head.className = "widget-head";
    const titleSpan = document.createElement("div");
    titleSpan.className = "widget-title";
    titleSpan.textContent = title;
    const meta = document.createElement("div");
    meta.className = "widget-meta";
    meta.textContent = "iframe persistente";
    head.appendChild(titleSpan);
    head.appendChild(meta);

    const shell = document.createElement("div");
    shell.className = FRAME_SHELL_CLASS;
    shell.style.height = h;

    const iframe = document.createElement("iframe");
    iframe.className = "widget-iframe";
    iframe.setAttribute("src", src);
    iframe.setAttribute("loading", "lazy");
    iframe.setAttribute("referrerpolicy", "no-referrer-when-downgrade");
    iframe.setAttribute("allowfullscreen", "true");
    iframe.setAttribute("sandbox", "allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox");

    shell.appendChild(iframe);
    card.appendChild(head);
    card.appendChild(shell);
    return card;
  }

  function renderSnapshot(widgets){
    const grid = $(GRID_SELECTOR); if(!grid) return false;
    if(!Array.isArray(widgets) || widgets.length===0) return false;
    // If grid already has many iframes, don't duplicate ‚Äî only hydrate when empty
    const current = $all(IFRAME_SELECTOR, grid);
    if(current.length > 0) { log("Grid already has iframes, skip hydration."); return false; }
    const frag = document.createDocumentFragment();
    widgets.forEach(w => { frag.appendChild(createCard(w)); });
    grid.appendChild(frag);
    log("Hydrated", widgets.length, "iframes from persistence.");
    return true;
  }

  // Debounced auto-save on DOM mutations within widgets-grid
  let saveTimer = null;
  function scheduleSave(){
    clearTimeout(saveTimer);
    saveTimer = setTimeout(async ()=>{
      const snap = takeSnapshot();
      if(!snap.length) return;
      saveToLocal(snap);
      await saveToFirestore(snap);
      log("Snapshot saved", snap);
    }, 700);
  }

  function initMutationObserver(){
    const grid = $(GRID_SELECTOR); if(!grid) return;
    const mo = new MutationObserver((mutList)=>{
      let changed = false;
      for(const m of mutList){
        if(m.type === "childList"){
          changed = true; break;
        }
        if(m.type === "attributes" && (m.target.matches(IFRAME_SELECTOR) || m.target.classList.contains(FRAME_SHELL_CLASS))){
          changed = true; break;
        }
      }
      if(changed) scheduleSave();
    });
    mo.observe(grid, { childList: true, subtree: true, attributes: true, attributeFilter: ["src", "style"] });
    window.addEventListener("beforeunload", ()=>{
      const snap = takeSnapshot();
      if(snap.length){ saveToLocal(snap); }
    });
  }

  async function hydrate(){
    // Try Firestore (if logged), else localStorage
    let widgets = null;
    if(uid()){ widgets = await loadFromFirestore(); }
    if(!widgets || !widgets.length){ widgets = loadFromLocal(); }
    if(widgets && widgets.length){
      renderSnapshot(widgets);
    }
  }

  function onAuthChanged(){
    // whenever auth changes, attempt hydration and set up observer
    hydrate();
    initMutationObserver();
  }

  // If Firebase Auth is available, wait for state; else run immediately
  try{
    if(window.onAuthStateChanged && window.auth){
      window.onAuthStateChanged(window.auth, ()=>{ onAuthChanged(); });
    }else{
      // no auth: still persist locally
      onAuthChanged();
    }
  }catch(e){
    console.warn("Auth hook error", e);
    onAuthChanged();
  }
})();
</script>
<!-- === Demandas: resumo flutuante === -->
<div id="notificationWidget" class="notification-widget" aria-live="polite">
  <div id="notificationPanel" class="notification-panel" role="region" aria-label="Notifica√ß√µes">
    <div class="notification-header">
      <h3 class="notification-title">Notifica√ß√µes</h3>
    </div>
    
    <!-- CART√ïES DE RESUMO POR SEVERIDADE -->
    <div class="notification-summary" style="display: flex; gap: 8px; padding: 12px; margin-bottom: 8px;">
      <div id="notifCountCritical" class="notification-summary-card" style="flex: 1; background: linear-gradient(135deg, #fee2e2, #fecaca); padding: 12px; border-radius: 8px; text-align: center;">
        <div style="font-size: 24px; font-weight: bold; color: #dc2626;">0</div>
        <div style="color: #991b1b; font-weight: 500; font-size: 12px;">Cr√≠ticas</div>
      </div>
      <div id="notifCountWarn" class="notification-summary-card" style="flex: 1; background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 12px; border-radius: 8px; text-align: center;">
        <div style="font-size: 24px; font-weight: bold; color: #d97706;">0</div>
        <div style="color: #92400e; font-weight: 500; font-size: 12px;">Avisos</div>
      </div>
      <div id="notifCountInfo" class="notification-summary-card" style="flex: 1; background: linear-gradient(135deg, #dbeafe, #bfdbfe); padding: 12px; border-radius: 8px; text-align: center;">
        <div style="font-size: 24px; font-weight: bold; color: #2563eb;">0</div>
        <div style="color: #1e40af; font-weight: 500; font-size: 12px;">Informa√ß√µes</div>
      </div>
    </div>
    
    <div class="notification-list" id="notificationList"></div>
    <div class="notification-empty" id="notificationEmpty" hidden>Tudo em dia por aqui! Cadastre novas demandas, metas ou posts para receber alertas.</div>
  </div>
  <button id="notificationButton" class="notification-button" type="button" aria-haspopup="true" aria-expanded="false" aria-controls="notificationPanel" title="Abrir notifica√ß√µes">
    <span class="notification-icon" aria-hidden="true">üîî</span>
    <span id="notificationBadge" class="notification-badge" hidden>0</span>
  </button>
</div>
<div id="mg-iframe-container"></div>
<!-- === MediaGrowth: Firebase iFrames Persist (per user/email + per client) === -->
<!-- DESABILITADO: Este m√≥dulo usa credenciais placeholder. Usar o m√≥dulo abaixo com credenciais reais -->
<!--
<script type="module">
// Script de iframes desabilitado - usando credenciais do app principal
</script>
-->
<script>
// iFrames container - funcionalidade movida para app principal
(function(){
  const container = document.getElementById('mg-iframe-container');
  if(!container) return;
  
  const qs = new URLSearchParams(location.search);
  const pathClient = location.pathname.replace(/^\/+/, '').split('/')[0];
  let clientKey = (typeof window.TENANT === 'string' && window.TENANT)
    || document.body.getAttribute('data-client-id')
    || qs.get('client')
    || pathClient || 'no-client';
  
  const adminParam = (qs.get('iframeAdmin') === '1') || localStorage.getItem('mg_iframe_admin') === '1';
  
  function sanitizeSrc(raw){ try{ const u=new URL(raw.trim()); return u.toString(); }catch(e){ return (raw||'').trim(); } }
  
  function renderList(list){
    container.innerHTML='';
    list.forEach(item=>{
      const wrap=document.createElement('div');
      wrap.className='mg-iframe-wrap';
      wrap.style.position='relative'; wrap.style.margin='12px 0';
      if(item.title){
        const h=document.createElement('div'); h.textContent=item.title;
        h.style.margin='6px 0'; h.style.fontWeight='600'; h.style.color='#ddd'; wrap.appendChild(h);
      }
      const f=document.createElement('iframe'); f.src=item.src; f.width='100%'; f.height='640'; f.loading='lazy'; f.style.border='1px solid #333'; wrap.appendChild(f);
      container.appendChild(wrap);
    });
  }
  
  // Placeholder - iframes devem ser carregados pelo app principal
  window.mgCloud = window.mgCloud || {
    ctx: null,
    add: function(){ console.warn('mgCloud.add: use o sistema principal'); },
    importLocalStorage: function(){ console.warn('mgCloud.importLocalStorage: use o sistema principal'); }
  };
})();
</script>
<!-- === /MediaGrowth: Firebase iFrames Persist === -->

<!-- PATCH Macro: remover apenas as barras (widget-input) do PRIMEIRO card da aba Macro -->
<script>
(function(){
  "use strict";
  function isMacroActive(){
    var btn = document.querySelector('.tabs [role="tab"].active, .tab-btn.active');
    var txt = btn ? (btn.textContent||"").toLowerCase() : "";
    return txt.indexOf("macro") !== -1;
  }
  function getMacroGrid(){
    return document.querySelector('#widgetsGrid-macro, [data-section="macro"].widgets-grid')
        || document.querySelector('#widgetsGrid')
        || document.querySelector('.widgets-grid');
  }
  function removeMacroBars(){
    if (!isMacroActive()) return;
    var grid = getMacroGrid();
    if (!grid) return;
    var first = grid.querySelector('.widget-card');
    if (!first) return;
    var input = first.querySelector('.widget-input');
    if (input) input.remove();
  }
  document.addEventListener('DOMContentLoaded', function(){
    // aplica em loop curto para cobrir re-render inicial
    var tries = 0;
    var iv = setInterval(function(){
      tries++;
      removeMacroBars();
      if (tries > 30) clearInterval(iv);
    }, 100);
  });
  // observa mudan√ßas (re-renderiza√ß√µes)
  var mo = new MutationObserver(function(){ try{ removeMacroBars(); }catch(e){} });
  mo.observe(document.documentElement, { childList: true, subtree: true });
})();
</script>


<!-- PATCH Macro v4: remover header + barras (widget-input) + iframe do PRIMEIRO card da aba Macro -->
<script>
(function(){
  "use strict";
  function isMacroActive(){
    var btn = document.querySelector('.tabs [role="tab"].active, .tab-btn.active');
    var txt = btn ? (btn.textContent||"").toLowerCase() : "";
    return txt.indexOf("macro") !== -1;
  }
  function getMacroGrid(){
    return document.querySelector('#widgetsGrid-macro, [data-section="macro"].widgets-grid')
        || document.querySelector('#widgetsGrid')
        || document.querySelector('.widgets-grid');
  }
  function nukeFirstMacroCardBits(){
    if (!isMacroActive()) return;
    var grid = getMacroGrid();
    if (!grid) return;
    var first = grid.querySelector('.widget-card');
    if (!first) return;

    // 1) header
    var head = first.querySelector('.widget-head');
    if (head) head.remove();

    // 2) barras (inputs)
    var input = first.querySelector('.widget-input');
    if (input) input.remove();

    // 3) iframe e container
    var shell = first.querySelector('.frame-shell');
    if (shell) shell.remove();
    var ifr = first.querySelector('iframe');
    if (ifr) ifr.remove();
  }

  // roda v√°rias vezes no in√≠cio para cobrir re-render inicial
  document.addEventListener('DOMContentLoaded', function(){
    var tries = 0;
    var iv = setInterval(function(){
      tries++;
      nukeFirstMacroCardBits();
      if (tries > 40) clearInterval(iv); // ~4s
    }, 100);
  });

  // observa mudan√ßas e reaplica
  var mo = new MutationObserver(function(){ try{ nukeFirstMacroCardBits(); }catch(e){} });
  mo.observe(document.documentElement, { childList: true, subtree: true });

  // utilit√°rio manual
  window.__nukeFirstMacroCardBits = nukeFirstMacroCardBits;
})();
</script>




<!-- === Tenant slug routing (per-user URL like /empresa) === -->
<script type="module">
(async function(){
  if(window.__MG_SLUG_ROUTER_INSTALLED__) return;
  window.__MG_SLUG_ROUTER_INSTALLED__ = true;

  // Import Firebase modules dynamically
  const { initializeApp, getApps } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js");
  const { getAuth, onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js");
  const { getFirestore, doc, getDoc, setDoc } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");

  const firebaseConfig = {
    apiKey: "AIzaSyCVAGfImLTkVfk14-GoSvo_og4FFux7nHQ",
    authDomain: "mediagrowth-a5349.firebaseapp.com",
    projectId: "mediagrowth-a5349",
    storageBucket: "mediagrowth-a5349.firebasestorage.app",
    messagingSenderId: "1074237637946",
    appId: "1:1074237637946:web:cf5008b649bbb4d7d13c03"
  };

  const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  function slugifyEmail(email){
    if(!email) return '';
    const local = email.split('@')[0] || '';
    return local
      .normalize('NFD').replace(/[ÃÄ-ÕØ]/g,'')
      .toLowerCase()
      .replace(/[^a-z0-9]+/g,'-')
      .replace(/(^-|-$)/g,'');
  }

  async function getOrCreateUserSlug(uid, email){
    try{
      const ref = doc(db, 'usuarios', uid);
      const snap = await getDoc(ref);
      let slug = snap.exists() && snap.data()?.slug;
      if(!slug){
        slug = slugifyEmail(email) || ('user-' + (uid||'').slice(0,6));
        await setDoc(ref, { slug }, { merge: true });
      }
      return slug;
    }catch(e){
      console.error('slug profile error', e);
      return slugifyEmail(email) || ('user-' + (uid||'').slice(0,6));
    }
  }

  async function resolveTenantFromPathOrProfile(user){
    const pathSlug = (location.pathname || '/').replace(/^\/+/, '').split('/')[0] || '';
    const profileSlug = await getOrCreateUserSlug(user.uid, user.email || '');
    if(!pathSlug || pathSlug !== profileSlug){
      history.replaceState({}, '', '/' + profileSlug);
    }
    window.TENANT = profileSlug;
    document.documentElement.dataset.tenant = profileSlug;
    try { document.body.setAttribute('data-client-id', profileSlug); } catch(_) {}
    return profileSlug;
  }

  async function guardRouteForUser(user){
    try{
      const ref = doc(db, 'usuarios', user.uid);
      const snap = await getDoc(ref);
      const mySlug = (snap.exists() && snap.data()?.slug) || slugifyEmail(user.email||'');
      const pathSlug = (location.pathname||'/').replace(/^\/+/, '').split('/')[0] || '';
      if(pathSlug && pathSlug !== mySlug){
        history.replaceState({}, '', '/' + mySlug);
        if(typeof mgToast === 'function'){ mgToast('Sem acesso a /' + pathSlug + '. Redirecionado para seu painel.'); }
      }
      window.TENANT = mySlug;
      document.documentElement.dataset.tenant = mySlug;
      try { document.body.setAttribute('data-client-id', mySlug); } catch(_) {}
      if(typeof loadClientProfile === 'function'){
        try{ await loadClientProfile(); }
        catch(err){ console.warn('profile logo sync', err); }
      }
      return mySlug;
    }catch(e){
      console.error('guardRoute error', e);
    }
  }

  // Listen to auth changes without interfering with existing handlers
  if(!window.__MG_SLUG_ONAUTH_PATCHED__){
    window.__MG_SLUG_ONAUTH_PATCHED__ = true;
    try{
      onAuthStateChanged(auth, async (user) => {
        if(user){
          try{
            await resolveTenantFromPathOrProfile(user);
            await guardRouteForUser(user);
            if(typeof ensureCalendar === 'function'){ try{ ensureCalendar(); }catch(_e){} }
            // Rehydrate UI data now that TENANT is confirmed
            try{ if(typeof loadBriefFromUserData === 'function') loadBriefFromUserData(); }catch(_e){}
            try{ if(typeof renderDashboard === 'function') renderDashboard(window.USER_DATA); }catch(_e){}
            try{ if(typeof buildTabs === 'function') buildTabs(); }catch(_e){}
            try{ if(typeof loadNotesFromUserData === 'function') loadNotesFromUserData(); }catch(_e){}
            try{ if(typeof loadNoteTemplatesFromUserData === 'function') loadNoteTemplatesFromUserData(); }catch(_e){}
            try{ if(typeof loadAccessesFromUserData === 'function') loadAccessesFromUserData(); }catch(_e){}
            try{ if(typeof rerenderBySection === 'function') rerenderBySection(); }catch(_e){}
          }catch(err){ console.error('slug flow', err); }
        }else{
          history.replaceState({}, '', '/');
          window.TENANT = getTenantFromHostOrPath();
          document.documentElement.dataset.tenant = window.TENANT;
          try { document.body.setAttribute('data-client-id', window.TENANT); } catch(_) {}
        }
      });
    }catch(e){ console.warn('Could not attach onAuthStateChanged slug listener', e); }
  }

  // Keep TENANT synced when user uses back/forward navigation
  window.addEventListener('popstate', () => {
    const pathSlug = (location.pathname||'/').replace(/^\/+/, '').split('/')[0] || '';
    if(pathSlug){
      window.TENANT = pathSlug;
      document.documentElement.dataset.tenant = pathSlug;
      try { document.body.setAttribute('data-client-id', pathSlug); } catch(_) {}
      if(typeof loadClientProfile === 'function'){
        try{ loadClientProfile(); }
        catch(err){ console.warn('profile logo popstate', err); }
      }
    }
  });
})();
</script>
<!-- === end Tenant slug routing === -->
</body>
<script type="module">
/* ===== 1) Firebase config ‚Äì COLE OS SEUS DADOS ===== */
const firebaseConfig = {
  apiKey: "AIzaSyD4CbPQWrwOcfANX3ar0ibmGN20ffsRCqo",
  authDomain: "mediagrowth-a5349.firebaseapp.com",
  projectId: "mediagrowth-a5349",
  storageBucket: "mediagrowth-a5349.firebasestorage.app",
  messagingSenderId: "1074237637946",
  appId: "1:1074237637946:web:cf5008b649bbb4d7d13c03"
};

import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, onSnapshot, persistentLocalCache, initializeFirestore } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// Reutilizar app Firebase se j√° existir
const app  = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getApps().length > 0 ? getFirestore(app) : initializeFirestore(app, {
  localCache: persistentLocalCache({})
});
// tornar auth acess√≠vel globalmente (planilha Macro depende)
window.auth = auth;
window.onAuthStateChanged = onAuthStateChanged;/* ===== 2) Cliente (por URL ?client=... ou data-client-id no <body>) ===== */
const qs = new URLSearchParams(location.search);
const pathClient = location.pathname.replace(/^\/+/, '').split('/')[0];
let clientKey = (typeof window.TENANT === 'string' && window.TENANT)
  || document.body.getAttribute('data-client-id')
  || qs.get('client')
  || pathClient;
if (!clientKey) {
  console.warn('Cliente n√£o definido na URL; usando chave "no-client".');
  clientKey = 'no-client';
}
try { document.body.setAttribute('data-client-id', clientKey); } catch(_) {}

/* ===== 3) Utilidades ===== */
function $all(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }
function normalize(src){ try{ return new URL((src||'').trim()).toString(); } catch(e) { return (src||'').trim(); } }
function domPath(el){
  // caminho est√°vel para gerar ID do doc por campo
  const parts=[]; while(el && el.nodeType===1 && el!==document.body){
    const tag = el.tagName.toLowerCase(); let i=1, s=el;
    while((s=s.previousElementSibling)) if(s.tagName===el.tagName) i++;
    parts.unshift(`${tag}:${i}`); el = el.parentElement;
  } return parts.join('/');
}
function djb2(str){ let h=5381; for(let i=0;i<str.length;i++){ h=((h<<5)+h)+str.charCodeAt(i);} return (h>>>0).toString(36); }
function keyForInput(input){
  const wrap = input.closest('.widget-card'); // estrutura do seu projeto
  const base = [
    wrap ? ('wid:' + (wrap.getAttribute('data-widget-id')||'auto')) : '',
    input.name ? ('name:'+input.name) : '',
    input.id   ? ('id:'+input.id)     : '',
    input.getAttribute('placeholder') || '',
    domPath(input)
  ].join('|');
  return 'w_' + djb2(base);
}
function findOrCreateIframeFor(input){
  // tenta achar um iframe do pr√≥prio widget; se n√£o existir, cria logo abaixo
  const wrap = input.closest('.widget-card');
  let ifr = wrap?.querySelector('.frame-shell .widget-iframe');
  if(!ifr){
    const shell = wrap?.querySelector('.frame-shell');
    if(shell){
      ifr = document.createElement('iframe');
      ifr.className = 'widget-iframe';
      ifr.style.cssText = 'width:100%;height:100%;border:0;background:transparent';
      shell.innerHTML = ''; shell.appendChild(ifr);
    }else{
      // fallback: cria abaixo do input
      ifr = document.createElement('iframe');
      ifr.style.cssText = 'width:100%;height:560px;border:1px solid #333;background:#000;margin:6px 0';
      input.insertAdjacentElement('afterend', ifr);
    }
  }
  return ifr;
}

/* ===== 4) Bind em todos os campos de link =====
   Ele considera inputs cujo placeholder contenha ‚ÄúCole o link‚Äù ou ‚Äúhttps://‚Äù */
let ctx = { uid:null };
function bindInput(input){
  if(input.dataset.mgBound==='1') return;
  const ph = (input.getAttribute('placeholder')||'').toLowerCase();
  if(!ph.includes('cole o link') && !ph.includes('https://')) return;
  input.dataset.mgBound='1';

  const docId = keyForInput(input);
  input.dataset.docId = docId;

  function path(){ return ['usuarios', ctx.uid, 'clients', clientKey, 'iframes', docId]; }

  // 4.1 Restaurar do Firestore em tempo real
  function startSnapshot(){
    const ref = doc(db, ...path());
    onSnapshot(ref, snap=>{
      if(!snap.exists()) return;
      const src = snap.data().src || '';
      if(src && input.value.trim() !== src){ input.value = src; }
      const ifr = findOrCreateIframeFor(input);
      if(src && ifr.src !== src) ifr.src = src;
    });
  }

  // 4.2 Salvar (enter/blur/change)
  async function save(){
    if(!ctx.uid) return alert('Fa√ßa login para salvar os iFrames deste cliente.');
    const src = normalize(input.value);
    if(!src) return;
    const ref = doc(db, ...path());
    // tamb√©m escreve no localStorage (cache) para restaurar instant√¢neo
    const k = `mg_cache_${ctx.uid}_${clientKey}`;
    const cache = JSON.parse(localStorage.getItem(k) || '{}');
    cache[docId] = { src, updatedAt: Date.now() };
    localStorage.setItem(k, JSON.stringify(cache));
    // grava na nuvem
    await setDoc(ref, { src, updatedAt: Date.now() }, { merge: true });
    // mostra no iframe
    const ifr = findOrCreateIframeFor(input);
    ifr.src = src;
  }

  input.addEventListener('change', save);
  input.addEventListener('blur', save);
  input.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); save(); } });

  // 4.3 Restaura√ß√£o imediata do cache local (antes do snapshot)
  function restoreCache(){
    if(!ctx.uid) return;
    const k = `mg_cache_${ctx.uid}_${clientKey}`;
    const cache = JSON.parse(localStorage.getItem(k) || '{}');
    const hit = cache[docId];
    if(hit?.src){
      if(!input.value) input.value = hit.src;
      const ifr = findOrCreateIframeFor(input);
      if(!ifr.src) ifr.src = hit.src;
    }
  }

  if(ctx.uid){
    restoreCache();
    startSnapshot();
  }
}

/* ===== 5) Observar DOM e aplicar bind quando itens renderizam ===== */
function scan(){ $all('input,textarea').forEach(bindInput); }
const mo = new MutationObserver(scan);
mo.observe(document.documentElement, { childList:true, subtree:true });

/* ===== 6) Login ‚Üí ativa binds e snapshots ===== */
onAuthStateChanged(auth, user=>{
  ctx.uid = user ? user.uid : null;
  scan();
});
</script>

<!-- partial -->

<div id="noteWidget" style="display:none">
  <div id="noteIcon">üìù</div>
  <div id="noteTab">
    <textarea id="noteTextarea" placeholder="Escreva sua nota..."></textarea>
    <button id="noteClear">Apagar</button>
  </div>
</div>
<style>
  #noteWidget{position:fixed;bottom:10px;left:10px;display:flex;align-items:flex-end;z-index:100000;}
  #noteIcon{background:#000;color:#fff;border:1px solid #333;padding:8px 10px;border-radius:8px;cursor:pointer;}
  #noteTab{display:none;margin-left:8px;background:#000;padding:10px;border:1px solid #333;border-radius:10px;flex-direction:column;align-items:flex-end;}
  #noteTab.show{display:flex;}
  #noteTab textarea{width:300px;height:200px;background:#000;color:#fff;border:1px solid #666;border-radius:8px;padding:8px;}
  #noteTab button{margin-top:8px;background:#333;color:#fff;border:1px solid #555;border-radius:6px;padding:6px 12px;cursor:pointer;}

  .tabs,
  .widget-head,
  .frame-shell,
  [class$="-wrap"],
  [class$="Wrap"]{
    margin-left:var(--margin-left);
    margin-right:var(--margin-right);
    max-width:100%;
  }
</style>
<script>
  (function(){
    const icon=document.getElementById('noteIcon');
    const tab=document.getElementById('noteTab');
    const textarea=document.getElementById('noteTextarea');
    const clearBtn=document.getElementById('noteClear');
    const KEY='mg_note';
    textarea.value=localStorage.getItem(KEY)||'';
    textarea.addEventListener('input',()=>localStorage.setItem(KEY,textarea.value));
    clearBtn.addEventListener('click',()=>{textarea.value='';localStorage.removeItem(KEY);});
    icon.addEventListener('click',()=>tab.classList.toggle('show'));
  })();
</script>
</body>
</html>

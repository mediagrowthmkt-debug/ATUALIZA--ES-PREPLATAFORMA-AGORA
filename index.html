<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>PAINEL MEDIAGROWTH HTML 4.5 (fix duplicar/fechar iframes)</title>
<link rel="icon" type="image/png" href="favicon.png"/>
<style id="calendar-css">
/* ===================== CALEND√ÅRIO / POSTS ===================== */
.calendar-wrap{ margin-left:var(--margin-left); margin-right:var(--margin-right); display:flex; flex-direction:column; gap:10px; }
.cal-toolbar{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; background:var(--title-bg,rgba(0,0,0,.35)); border:1px solid var(--shell-border,rgba(255,255,255,.14)); padding:8px; border-radius:10px; }
.cal-google-sync{ display:flex; align-items:center; flex-wrap:wrap; gap:8px; margin-left:auto; }
.cal-google-sync .status{ font-size:.82rem; color:#cbd5f5; }
.cal-google-sync .btn{ flex:0 0 auto; }
@media (max-width: 820px){
  .cal-google-sync{ width:100%; margin-left:0; }
  .cal-google-sync .status{ flex-basis:100%; }
}
.cal-toolbar input[type="text"], .cal-toolbar input[type="date"]{ background:#222; color:#fff; border:1px solid #333; border-radius:8px; padding:8px 10px; }
.cal-toolbar input[type="file"]{ background:#111; border:1px dashed #333; border-radius:10px; padding:8px; color:#bbb; }
.cal-legend{ display:flex; gap:10px; align-items:center; font-size:.9rem; color:#ddd; }
.cal-badge{ display:inline-block; width:10px; height:10px; border-radius:2px; margin-right:6px; }
.b-pendente{ background:#777; }
.b-aprovado{ background:#2e7d32; }
.b-aprovado-interno{ background:#7c4dff; }
.b-revisar{ background:#c8a600; }
.calendar{ background:transparent; border:1px solid var(--shell-border,rgba(255,255,255,.14)); border-radius:12px; overflow:hidden; }
.cal-head{ display:grid; grid-template-columns: 40px 1fr 40px; align-items:center; padding:8px 10px; background:rgba(255,255,255,.06); border-bottom:1px solid var(--shell-border,rgba(255,255,255,.14)); }
.cal-head .nav{ display:flex; align-items:center; justify-content:center; }
.cal-head button{ background:#222; border:1px solid #333; color:#fff; border-radius:8px; padding:6px 10px; cursor:pointer; font-weight:800; }
.cal-title{ text-align:center; font-weight:900; }
.cal-grid{ display:grid; grid-template-columns: repeat(7, 1fr); gap:0; }
.cal-weekday{ background:rgba(255,255,255,.06); padding:8px 10px; text-align:center; border-right:1px solid var(--shell-border,rgba(255,255,255,.14)); font-weight:800; font-size:.85rem; }
.cal-weekday:last-child{ border-right:0; }
.cal-weekday.weekend{ background:rgba(148,163,184,.16); color:#f8fafc; }
.cal-cell{ border-top:1px solid var(--shell-border,rgba(255,255,255,.14)); border-right:1px solid var(--shell-border,rgba(255,255,255,.14)); min-height:110px; padding:6px; position:relative; }
.cal-cell:nth-child(7n){ border-right:0; }
.cal-cell.weekend:not(.today){ background:rgba(148,163,184,.12); }
.cal-cell.weekend.out{ background:rgba(148,163,184,.06); }
.cal-cell.weekend .daynum{ color:#e2e8f0; font-weight:800; }
.cal-cell.today{ background:rgba(255,255,255,.08); box-shadow:0 0 0 2px var(--accent) inset; }
.cal-cell.today .daynum{ color:var(--accent); font-weight:900; }
.daynum{ position:absolute; top:6px; right:6px; font-size:.8rem; color:#bbb; }
.cal-holidays{ font-size:.7rem; line-height:1.2; margin-top:18px; display:flex; flex-direction:column; gap:2px; color:#ccc; }
.cal-items{ display:flex; flex-wrap:wrap; gap:4px; margin-top:4px; }
.cal-demands{ display:flex; flex-direction:column; gap:4px; margin-top:4px; }
.cal-demand{ display:flex; align-items:flex-start; gap:6px; background:rgba(15,23,42,.35); border:1px solid rgba(255,255,255,.08); border-left:3px solid var(--status-color,#64748b); border-radius:8px; padding:4px 6px; }
.cal-demand-dot{ width:8px; height:8px; border-radius:50%; background:var(--status-color,#64748b); flex:0 0 auto; margin-top:4px; }
.cal-demand-text{ display:flex; flex-direction:column; gap:2px; min-width:0; }
.cal-demand-title{ font-size:.72rem; font-weight:600; color:#f3f4f6; line-height:1.3; word-break:break-word; }
.cal-demand-meta{ font-size:.65rem; color:#cbd5f5; line-height:1.2; }
.calendar-demandas-mobile{ display:none; flex-direction:column; gap:10px; margin-top:12px; }
.calendar-demandas-mobile-title{ margin:0; font-size:1rem; font-weight:700; color:#fff; }
.calendar-demandas-mobile-list{ display:flex; flex-direction:column; gap:8px; }
.calendar-demandas-mobile-day{ background:rgba(15,23,42,.35); border:1px solid rgba(255,255,255,.08); border-radius:10px; padding:10px; display:flex; flex-direction:column; gap:6px; }
.calendar-demandas-mobile-date{ font-size:.78rem; font-weight:700; color:#cbd5f5; text-transform:uppercase; letter-spacing:.02em; }
.calendar-demandas-mobile-empty{ background:rgba(15,23,42,.2); border:1px dashed rgba(255,255,255,.14); border-radius:10px; padding:12px; color:#cbd5f5; font-size:.85rem; }
.cal-note{ width:100%; min-height:40px; margin-top:4px; background:transparent; border:1px dashed var(--shell-border,rgba(255,255,255,.14)); border-radius:6px; color:#fff; font-size:.75rem; padding:2px; resize:vertical; }
.cal-thumb{ width:38px; height:38px; border-radius:6px; overflow:hidden; border:2px solid #777; cursor:pointer; background:#111; display:flex; align-items:center; justify-content:center; font-size:.8rem; }
.cal-thumb.aprovado{ border-color:#2e7d32; }
.cal-thumb.aprovado-interno{ border-color:#7c4dff; }
.cal-thumb.revisar{ border-color:#c8a600; }
.cal-thumb img, .cal-thumb video{ width:100%; height:100%; object-fit:cover; display:block; }
.insta-preview{ display:flex; justify-content:center; margin-top:10px; }
.insta-phone{ width:360px; background:#fff; border:1px solid #ccc; border-radius:32px; overflow:hidden; }
.insta-feed{ display:grid; grid-template-columns:repeat(3,1fr); gap:1px; background:#fff; }
.feed-item{ position:relative; aspect-ratio:1/1; background:#000; display:flex; align-items:center; justify-content:center; cursor:pointer; }
.feed-item img, .feed-item video{ width:100%; height:100%; object-fit:cover; display:block; }
.feed-item span{ color:#fff; font-weight:800; }
.feed-item.aprovado::after{ content:""; position:absolute; inset:0; box-shadow:0 0 0 4px #2e7d32 inset; }
.feed-item.aprovado-interno::after{ content:""; position:absolute; inset:0; box-shadow:0 0 0 4px #7c4dff inset; }
.feed-item.revisar::after{ content:""; position:absolute; inset:0; box-shadow:0 0 0 4px #c8a600 inset; }
.feed-item.pendente::after{ content:""; position:absolute; inset:0; box-shadow:0 0 0 4px #777 inset; }
.cover-upload-btn{ position:absolute; z-index:5; background:rgba(0,0,0,.75); color:#fff; border:1px solid rgba(255,255,255,.35); border-radius:999px; font-size:.65rem; padding:2px 6px; display:flex; align-items:center; gap:4px; cursor:pointer; line-height:1; }
.cover-upload-btn:hover{ filter:brightness(1.1); }
.feed-item .cover-upload-btn{ bottom:6px; left:50%; transform:translateX(-50%); }
.insta-stories-wrapper{ position:relative; background:#fff; padding:4px; }
.insta-stories{ display:flex; gap:4px; overflow-x:auto; scroll-behavior:smooth; }
.stories-arrow{ position:absolute; top:50%; transform:translateY(-50%); width:24px; height:24px; border:0; border-radius:50%; background:rgba(0,0,0,.6); color:#fff; display:flex; align-items:center; justify-content:center; cursor:pointer; }
.stories-arrow.left{ left:4px; }
.stories-arrow.right{ right:4px; }
.story-date{ position:absolute; bottom:2px; right:2px; background:rgba(0,0,0,.6); color:#fff; font-size:.6rem; padding:1px 3px; border-radius:3px; }
@media (max-width: 820px){ .stories-arrow{ display:none; } }
.story-item{ position:relative; flex:0 0 90px; aspect-ratio:9/16; background:#000; display:flex; align-items:center; justify-content:center; cursor:pointer; border-radius:4px; }
.story-item img, .story-item video{ width:100%; height:100%; object-fit:cover; display:block; }
.story-item span{ color:#fff; font-weight:800; }
.story-item.aprovado::after{ content:""; position:absolute; inset:0; box-shadow:0 0 0 4px #2e7d32 inset; }
.story-item.aprovado-interno::after{ content:""; position:absolute; inset:0; box-shadow:0 0 0 4px #7c4dff inset; }
.story-item.revisar::after{ content:""; position:absolute; inset:0; box-shadow:0 0 0 4px #c8a600 inset; }
.story-item.pendente::after{ content:""; position:absolute; inset:0; box-shadow:0 0 0 4px #777 inset; }
.story-item .cover-upload-btn{ top:6px; left:6px; transform:none; }
.status-pill{ display:inline-block; padding:4px 8px; border-radius:999px; font-weight:800; font-size:.75rem; }
.status-aprovado{ background:#1b5e20; border:1px solid #2e7d32; }
.status-aprovado-interno{ background:#2d185b; border:1px solid #7c4dff; color:#e8ddff; }
.status-revisar{ background:#5f4d00; border:1px solid #c8a600; }
.status-pendente{ background:#333; border:1px solid #555; }
.actions-inline{ display:flex; gap:6px; flex-wrap:wrap; }
.cal-filters{ display:flex; gap:8px; align-items:center; }
/* Modal */
.modal{ position:fixed; inset:0; background:rgba(0,0,0,.65); display:none; align-items:center; justify-content:center; z-index:99999; }
.modal.show{ display:flex; }
.modal-card{ width:min(900px, 96vw); background:#111; border:1px solid var(--shell-border,rgba(255,255,255,.14)); border-radius:14px; overflow:hidden; max-height:92vh; display:flex; flex-direction:column; }
.modal-head{ display:flex; justify-content:space-between; align-items:center; padding:10px 12px; background:rgba(255,255,255,.06); border-bottom:1px solid var(--shell-border,rgba(255,255,255,.14)); flex-shrink:0; }
.modal-body{ padding:12px; display:grid; grid-template-columns: 1fr 1fr; gap:12px; flex:1 1 auto; overflow-y:auto; min-height:0; }
.modal-body .preview{ background:#000; border:1px solid var(--shell-border,rgba(255,255,255,.14)); border-radius:10px; padding:8px; min-height:260px; display:flex; align-items:center; justify-content:center; }
.modal-body .preview img, .modal-body .preview video{ max-width:100%; max-height:60vh; }
.modal-body .info textarea{ width:100%; min-height:140px; background:#1a1a1a; color:#fff; border:1px solid #333; border-radius:8px; padding:8px; }
.modal-foot{ display:flex; justify-content:flex-end; gap:8px; padding:10px 12px; border-top:1px solid var(--shell-border,rgba(255,255,255,.14)); flex-shrink:0; background:#111; }
@media (max-width: 820px){
  .modal-body{ grid-template-columns: 1fr; }
}
@media (max-width: 820px){
  .insta-preview{ flex-direction:column; align-items:center; }
  .calendar .cal-demands{ display:none; }
  .calendar-demandas-mobile{ display:flex; }
}
/* ===================== FIM CALEND√ÅRIO / POSTS ===================== */

html, body{ -webkit-text-size-adjust: 100%; }

/* mg-toast */
.mg-toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:rgba(0,0,0,.85);color:#fff;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.2);z-index:100000;font-weight:800}


/* ===== Evitar zoom ao digitar no mobile (iOS) ===== */
@media (max-width: 820px){
  input, textarea, select, .input, .btn, .btn.small {
    font-size: 16px !important; /* iOS n√£o d√° zoom se fonte >=16px */
  }
  /* Altura confort√°vel para toque */
  input, textarea, select {
    min-height: 44px;
  }
}

</style>
<style id="access-css">
  /* ===================== ACESSOS ===================== */
  .access-wrap {
    margin-left: var(--margin-left);
    margin-right: var(--margin-right);
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .access-header {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 12px;
  }

  .access-toolbar {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
    background: var(--title-bg, rgba(0, 0, 0, 0.35));
    border: 1px solid var(--shell-border, rgba(255, 255, 255, 0.14));
    padding: 8px 10px;
    border-radius: 10px;
  }

  .access-toolbar .access-search {
    flex: 1 1 260px;
    min-width: 220px;
    width: 100%;
  }

  .access-toolbar .access-search input[type="text"] {
    width: 100%;
    background: #222;
    color: #fff;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 8px 10px;
  }

  .access-toolbar .access-actions {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    flex: 0 0 auto;
  }

  .access-toolbar .access-actions .btn {
    white-space: nowrap;
  }

  .access-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 8px;
  }

  .access-row {
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid var(--shell-border);
    border-radius: 10px;
    display: grid;
    grid-template-columns: 180px 1fr 200px 200px 160px 210px;
    gap: 8px;
    padding: 8px 8px;
    align-items: center;
  }

  .access-row .cell {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .access-row .cell a {
    color: #ffd9bf;
    text-decoration: underline;
  }

  .pill {
    background: #222;
    border: 1px solid #333;
    border-radius: 999px;
    padding: 2px 8px;
    font-size: 0.75rem;
    margin-right: 4px;
    display: inline-block;
  }

  .pw {
    letter-spacing: 2px;
  }

  .actions {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    justify-content: flex-end;
  }

  .help-note {
    color: #bbb;
    font-size: 0.85rem;
  }

  .warn {
    color: #ffc266;
  }

  .form-inline {
    display: grid;
    grid-template-columns: 180px 1fr 200px 200px 160px 210px;
    gap: 8px;
  }

  .form-inline input {
    width: 100%;
    background: #222;
    border: 1px solid #333;
    border-radius: 8px;
    color: #fff;
    padding: 8px 10px;
  }

  .access-empty {
    color: #bbb;
    padding: 8px;
  }

  @media (max-width: 1100px) {
    .access-row,
    .form-inline {
      grid-template-columns: 160px 1fr 160px 170px 140px 200px;
    }
  }

  @media (max-width: 900px) {
    .access-row,
    .form-inline {
      grid-template-columns: 1fr 1fr;
    }

    .access-row .cell.hide-sm {
      display: none;
    }

    .form-inline .hide-sm {
      display: none;
    }
  }

  /* ===================== MOBILE OPTIMIZA√á√ïES v4.9.2 ===================== */
  @media (max-width: 820px) {
    :root {
      --iframe-h: 520px;
    }

    html,
    body {
      overscroll-behavior-y: contain;
    }

    body {
      padding-bottom: calc(env(safe-area-inset-bottom, 0) + 8px);
    }

    h1 {
      font-size: 1.05rem;
      margin: 10px 0;
    }

    .center-box {
      padding: 12px;
    }

    .auth-box {
      max-width: 420px;
      border-radius: 12px;
      padding: 16px;
    }

    .input {
      font-size: 0.95rem;
      padding: 12px;
    }

    .btn {
      font-size: 0.95rem;
    }

    .btn.small {
      font-size: 0.9rem;
      padding: 7px 10px;
    }

    .topbar {
      gap: 8px;
      grid-template-columns: 1fr;
    }

    .topbar-left {
      width: 100%;
      justify-content: space-between;
      gap: 8px;
    }

    .user-info {
      white-space: normal;
    }

    .right-tools {
      width: 100%;
      justify-content: space-between;
      gap: 8px;
    }

    .profile-area {
      flex: 1;
      justify-content: flex-start;
    }

    .profile-area .profile-meta {
      display: none;
    }

    .profile-avatar {
      width: 42px;
      height: 42px;
    }

    .settings-tab {
      width: 40px;
      height: 40px;
      font-size: 1.05rem;
      border-radius: 12px;
    }

    .mini-total {
      padding: 6px 10px;
      min-width: auto;
    }

    .total-score {
      font-size: 1.2rem;
    }

    .tabs {
      margin-top: 4px;
      justify-content: flex-start;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      padding: 0 8px;
      gap: 6px;
    }

    .tab-btn {
      flex: 0 0 auto;
      padding: 8px 10px;
      font-size: 0.9rem;
    }

    .dashboard {
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .macro-actions {
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }

    .macro-summary {
      flex-direction: column;
      align-items: flex-start;
      gap: 14px;
    }

    .macro-summary-score {
      font-size: 2.2rem;
    }

    .macro-progress-grid {
      grid-template-columns: 1fr;
    }

    .macro-sections {
      grid-template-columns: 1fr;
    }

    .macro-mini-dashboard {
      grid-template-columns: 1fr;
    }

    .macro-timeline-date {
      min-width: 78px;
    }

    .widgets-grid {
      gap: 10px;
    }

    .widget-head {
      margin-left: var(--margin-left);
      margin-right: var(--margin-right);
      padding: 8px;
    }

    .widget-input {
      grid-template-columns: 1fr;
      margin-left: var(--margin-left);
      margin-right: var(--margin-right);
    }

    .frame-shell {
      min-height: 360px;
      margin-left: var(--margin-left);
      margin-right: var(--margin-right);
    }

    .note-toolbar,
    .brief-toolbar,
    .access-toolbar {
      gap: 8px;
    }

    .access-toolbar {
      flex-direction: column;
      align-items: stretch;
    }

    .access-toolbar .access-actions {
      width: 100%;
      justify-content: flex-start;
    }

    .access-toolbar .access-actions .btn {
      width: 100%;
    }

    .access-toolbar .access-search {
      min-width: 0;
    }

    .note-toolbar label,
    .brief-toolbar input[type="text"] {
      width: 100%;
    }

    .notes-wrap,
    .access-wrap {
      margin-left: var(--margin-left);
      margin-right: var(--margin-right);
    }

    .note-editor {
      min-height: 160px;
    }

    #briefForm {
      grid-template-columns: 1fr;
    }

    #briefIframeUrl {
      min-width: 0;
      width: 100%;
    }

    .access-row,
    .form-inline {
      grid-template-columns: 1fr;
    }

    .actions {
      justify-content: flex-start;
    }
  }

  @media (max-width: 520px) {
    .dashboard {
      grid-template-columns: 1fr;
    }

    .card textarea,
    .card input[type="number"] {
      width: 100%;
    }
  }
  /* ===================== FIM MOBILE OPTIMIZA√á√ïES ===================== */
</style>
<style id="calendar-review-css">
/* ======= Observa√ß√µes & Review modal ======= */

/* ===== Ajuste modal revis√£o no mobile ===== */
@media (max-width: 820px){
  #reviewModal .modal-card{
    width: 100% !important;
    height: 70vh !important;
    max-height: 70vh !important;
    margin: auto 0 0 0; /* bottom sheet */
    border-radius: 14px 14px 0 0;
    display: flex;
    flex-direction: column;
  }
  #reviewModal .modal-body{
    flex: 1 1 auto;
    overflow-y: auto;
    padding: 12px;
  }
  #reviewModal textarea{
    min-height: 100px;
  }
  #reviewModal .modal-foot{
    position: sticky;
    bottom: 0;
    background: #111;
    padding: 12px;
    border-top: 1px solid #333;
  }
  #reviewSend{
    width: 100%;
    font-size: 1rem;
    min-height: 44px;
  }
}

.notes-block{ margin-top:12px; }
.notes-list{ display:flex; flex-direction:column; gap:8px; background:#121212; border:1px solid var(--shell-border,rgba(255,255,255,.14)); border-radius:8px; padding:10px; max-height:220px; overflow:auto; }
.note-item{ background:#0d0d0d; border:1px solid #2a2a2a; border-radius:8px; padding:8px; }
.note-item.active{ border-color:var(--accent,#7c4dff); box-shadow:0 0 0 1px var(--accent,#7c4dff); }
.note-item.active .note-title{ color:#fff; }
.note-head{ display:flex; gap:8px; font-size:.8rem; color:#bbb; margin-bottom:4px; }
.note-body{ white-space:normal; }
.markdown-view{ line-height:1.5; font-size:inherit; color:inherit; }
.markdown-view p{ margin:0 0 0.75em; }
.markdown-view p:last-child{ margin-bottom:0; }
.markdown-view ul,.markdown-view ol{ margin:0 0 0.75em 1.2em; padding-left:1.2em; }
.markdown-view li{ margin:0.25em 0; }
.markdown-view pre{ margin:0 0 0.75em; background:#111; border:1px solid rgba(255,255,255,.18); border-radius:8px; padding:8px; overflow:auto; }
.markdown-view code{ background:rgba(255,255,255,.08); border-radius:4px; padding:0 4px; font-family:Consolas,Monaco,'Courier New',monospace; }
.markdown-view pre code{ background:transparent; padding:0; }
.markdown-view blockquote{ margin:0 0 0.75em; padding-left:12px; border-left:3px solid rgba(255,255,255,.22); color:rgba(255,255,255,.8); }
.markdown-view a{ color:#60a5fa; }
.origin-pill{ margin-left:auto; padding:2px 8px; border-radius:999px; font-size:.7rem; font-weight:800; text-transform:uppercase; letter-spacing:.02em; background:#222; border:1px solid #444; color:#ddd; }
.origin-pill.origin-cliente{ background:rgba(255,102,0,.16); border-color:#ff6600; color:#ffb380; }
.origin-pill.origin-interno{ background:rgba(46,125,50,.18); border-color:#2e7d32; color:#b2f2bb; }
.modal-card.small{ width:min(560px, 96vw); }
</style>
<style>
/* Esconde observa√ß√µes dentro do pop-up do Post (hist√≥rico ficar√° na p√°gina) */
#postModal .notes-block{ display:none !important; }
</style>
<style>
#btnApprove{background:#2e7d32 !important;border-color:#2e7d32 !important;color:#fff;}
#btnApproveInternal{background:#7c4dff !important;border-color:#7c4dff !important;color:#fff;}
#btnApproveInternal:disabled{background:#b39ddb !important;border-color:#b39ddb !important;color:#4527a0 !important;}
#btnApproveInternal.btn-interno-concluido{background:#5e35b1 !important;border-color:#5e35b1 !important;color:#fff !important;}
#btnApprove:hover,#btnApproveInternal:hover{filter:brightness(1.1)}
</style>
<style>
/* === In-modal carousel arrows (reliable) === */
#modalPreview{ position:relative; }
#modalPreview .pv-stage{ position:relative; background:#000; border-radius:12px; overflow:hidden; }
#modalPreview .pv-media{ display:flex; align-items:center; justify-content:center; min-height:220px; }
#modalPreview .pv-media img,
#modalPreview .pv-media video{
  display:block; background:#000;
  max-width:100%; max-height:62vh; width:auto; height:auto; object-fit:contain;
}
#modalPreview .pv-arrow{
  position:absolute; top:50%; transform:translateY(-50%);
  width:42px; height:42px; border-radius:999px;
  display:none; align-items:center; justify-content:center;
  color:#fff; font-weight:900; font-size:22px;
  background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.25);
  cursor:pointer; z-index:10; user-select:none; -webkit-user-select:none;
  -webkit-tap-highlight-color:transparent;
}
#modalPreview.pv-has-many .pv-arrow{ display:flex; }
#modalPreview .pv-arrow.left{ left:10px; } 
#modalPreview .pv-arrow.right{ right:10px; }
@keyframes pvBlink {0%,100%{opacity:.45} 50%{opacity:1}}
#modalPreview.pv-hint .pv-arrow{ animation: pvBlink 1s ease-in-out infinite; }
#modalPreview.pv-hint-end .pv-arrow{ animation: none; }
</style>
<style>
/* Team Management Styles */
.team-manager {
  margin-top: 16px;
}
.team-form {
  margin-bottom: 24px;
}
.team-form-row {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
}
.team-form-row input,
.team-form-row select {
  flex: 1;
  padding: 8px 12px;
  border: 1px solid #475569;
  border-radius: 6px;
  background: #1e293b;
  color: #f8fafc;
  font-size: 14px;
}
.team-form-row input:focus,
.team-form-row select:focus {
  outline: none;
  border-color: #3b82f6;
}
.team-form-row button {
  padding: 8px 16px;
  background: #3b82f6;
  color: #fff;
  border: none;
  border-radius: 6px;
  font-weight: 500;
  cursor: pointer;
}
.team-form-row button:hover {
  background: #2563eb;
}
.team-list {
  background: #1e293b;
  border-radius: 8px;
  overflow: hidden;
}
.team-list-header,
.team-member {
  display: grid;
  grid-template-columns: 2fr 2fr 1fr 1fr;
  gap: 12px;
  padding: 12px;
  align-items: center;
}
.team-list-header {
  background: #0f172a;
  font-weight: 600;
  color: #94a3b8;
}
.team-member {
  border-bottom: 1px solid #334155;
}
.team-member:last-child {
  border-bottom: none;
}
.team-member-actions {
  display: flex;
  gap: 8px;
}
.team-member-actions button {
  padding: 4px 8px;
  border: none;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
}
.team-member-actions .edit-btn {
  background: #059669;
  color: white;
}
.team-member-actions .remove-btn {
  background: #dc2626;
  color: white;
}
.client-invite-form {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-top: 12px;
}
.client-invite-grid {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 12px;
}
.client-invite-grid label {
  display: flex;
  flex-direction: column;
  gap: 6px;
  font-size: 0.85rem;
  color: #cbd5f5;
}
.client-invite-grid input {
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid #334155;
  background: #1e293b;
  color: #f8fafc;
  font-size: 0.9rem;
}
.client-invite-grid input:focus {
  outline: none;
  border-color: #3b82f6;
}
.client-invite-actions {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}
.client-invite-actions .btn {
  min-width: 160px;
}
.client-invite-status {
  font-size: 0.85rem;
  min-height: 1.2em;
  color: #cbd5f5;
}
.client-invite-status.success {
  color: #86efac;
}
.client-invite-status.error {
  color: #fca5a5;
}
.client-role-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  align-items: center;
  margin-bottom: 12px;
}
.client-role-actions .btn {
  min-width: 220px;
}
.client-accounts-section {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-top: 16px;
}
.client-accounts-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.client-account-trigger {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 4px;
  padding: 12px 16px;
  border-radius: 10px;
  border: 1px solid rgba(148, 163, 184, 0.16);
  background: rgba(15, 23, 42, 0.6);
  color: inherit;
  text-align: left;
  cursor: pointer;
  transition: border-color 0.2s ease, background 0.2s ease;
}
.client-account-trigger:hover {
  border-color: rgba(96, 165, 250, 0.6);
  background: rgba(30, 41, 59, 0.7);
}
.client-account-trigger[disabled] {
  opacity: 0.6;
  cursor: wait;
}
.client-account-name {
  font-weight: 600;
  font-size: 0.95rem;
}
.client-account-meta {
  font-size: 0.8rem;
  color: #94a3b8;
}
.client-accounts-empty {
  font-size: 0.85rem;
  color: #cbd5f5;
}
@media (max-width: 820px) {
  .client-role-actions {
    flex-direction: column;
    align-items: stretch;
  }
  .client-role-actions .btn {
    width: 100%;
  }
}
@media (max-width: 820px) {
  .client-invite-grid {
    grid-template-columns: 1fr;
  }
  .client-invite-actions {
    flex-direction: column;
    align-items: stretch;
  }
  .client-invite-actions .btn {
    width: 100%;
  }
}
</style>
</head>
<body>
<!-- partial:index.partial.html -->
<!DOCTYPE html>

<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
<title>üìä Sa√∫de do Marketing ‚Äî v4.9.1 (isola√ß√£o de abas + IDs est√°veis)</title>
<style>
    :root{ --accent:#ff6600; --bg:#000; --panel:#111; --input:#1a1a1a; --border:#333; --muted:#bbb;
      --iframe-h: 720px; --margin-left: clamp(10px,4vw,24px); --margin-right: clamp(10px,4vw,24px);
      --shell-border: rgba(255,255,255,.14); --title-bg: rgba(0,0,0,.35); }

    @media (max-width: 900px){
      :root{
        --margin-left: 16px;
        --margin-right: 16px;
      }

      .auth-box{
        max-width:min(100%,520px);
      }
    }
    *{box-sizing:border-box}
    html,body{min-height=100%}
    html{background:linear-gradient(135deg,var(--bg),#1a1a1a 40%,var(--accent) 120%);background-attachment:fixed}
    body{margin:0;color:#fff;font-family:Arial,Helvetica,sans-serif;display:flex;flex-direction:column;min-height:100vh;width:100%;overflow-x:hidden}
    h1{margin:16px 0;text-align:center;font-size:1.35rem}
    h1.site-logo{display:flex;align-items:center;justify-content:center}
    h1.site-logo img{height:clamp(40px,8vw,50px);width:auto;max-width:100%}

    .center-box{flex:1;display:flex;align-items:center;justify-content:center;padding:16px}
    .auth-box{width:100%;max-width:380px;background:var(--panel);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.4);padding:20px}
    .field{margin:10px 0}
    .input{width:100%;background:var(--input);border:1px solid var(--border);color:#fff;border-radius:10px;padding:12px 14px;font-size:.95rem}
    .btn{display:inline-block;border:0;border-radius:12px;padding:10px 14px;font-weight:800;color:#fff;background:var(--accent);cursor:pointer}
    .btn.secondary{background:#333}
    .btn.danger{background:#991b1b;border:1px solid rgba(239,68,68,.6)}
    .btn.small{padding:6px 10px;border-radius:8px;font-weight:700}
    .btn.ghost{background:rgba(255,255,255,.07);border:1px solid var(--shell-border)}
    .link{color:#ffb366;text-decoration:underline;cursor:pointer;font-size:.9rem}
    .divider{height:2px;background:#ddd;opacity:.4;margin:8px 0 14px}

    #userArea{display:none;padding:16px}
    .topbar{display:grid;grid-template-columns:minmax(0,1fr) auto;align-items:stretch;gap:14px;margin-bottom:8px}
    .topbar-left{display:flex;align-items:center;gap:12px;flex-wrap:wrap;min-width:0}
    .user-info{font-weight:700;font-size:.85rem;color:#f5f5f5;line-height:1.4;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .user-btn{background:#333;border:0;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}

    .social-icons{display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin-left:0}
    .social-icon{width:24px;height:24px;border-radius:50%;overflow:hidden;display:inline-flex;align-items:center;justify-content:center;position:relative;cursor:pointer}
    .social-icon img{width:100%;height:100%;object-fit:cover}
    .social-icon:not(.has-link)::after{content:"+";position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:900;background:rgba(0,0,0,.5);color:#fff;opacity:0;transition:opacity .2s;border-radius:50%}
    .social-icon:not(.has-link):hover::after{opacity:1}

    .right-tools{display:flex;align-items:stretch;gap:12px;justify-content:flex-end;flex-wrap:wrap}
    .profile-area{display:none;align-items:center;gap:8px;position:relative}
    .profile-area.active{display:flex}
    .profile-avatar{width:46px;height:46px;border-radius:50%;border:2px solid var(--shell-border,rgba(255,255,255,.35));background:#0f172a;color:#94a3b8;display:flex;align-items:center;justify-content:center;overflow:hidden;cursor:pointer;position:relative;transition:border-color .2s ease,transform .2s ease;padding:0}
    .profile-avatar:hover{border-color:var(--accent,#0ea5e9);transform:scale(1.02)}
    .profile-avatar img{width:100%;height:100%;object-fit:cover;display:none}
    .profile-avatar.has-image img{display:block}
    .profile-avatar .avatar-placeholder{font-size:.8rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase}
    .profile-avatar.has-image .avatar-placeholder{display:none}
    .profile-avatar.uploading{cursor:progress;pointer-events:none}
    .profile-avatar.uploading::after{content:"";position:absolute;inset:0;background:rgba(0,0,0,.55)}
    .profile-avatar.uploading::before{content:"";position:absolute;width:18px;height:18px;border:2px solid rgba(255,255,255,.25);border-top-color:#fff;border-radius:50%;animation:spin .9s linear infinite}
    .profile-meta{display:flex;flex-direction:column;align-items:flex-start;line-height:1}
    .profile-meta strong{font-size:.78rem;color:#fff;text-transform:uppercase;letter-spacing:.08em}
    .profile-meta small{font-size:.65rem;color:#9ca3af}
    .settings-tab{width:46px;height:46px;border-radius:14px;border:1px solid var(--shell-border,rgba(255,255,255,.18));background:rgba(15,23,42,.6);color:var(--accent);display:none;align-items:center;justify-content:center;font-size:1.2rem;font-weight:700;cursor:pointer;transition:background .2s ease,border-color .2s ease,transform .2s ease;box-shadow:0 6px 18px rgba(8,15,40,.45)}
    .profile-area[aria-hidden="false"] + .settings-tab{display:flex}
    .settings-tab:hover,.settings-tab:focus-visible{outline:none;background:rgba(14,116,144,.25);border-color:var(--accent);transform:translateY(-1px)}
    .settings-tab:active{transform:scale(.96)}
    .settings-panel{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.8);backdrop-filter:blur(8px);padding:24px;z-index:10000}
    .settings-panel.open{display:flex}
    .settings-panel-inner{width:min(1080px,94vw);max-height:90vh;background:rgba(15,23,42,.92);border:1px solid var(--shell-border,rgba(255,255,255,.18));border-radius:18px;display:flex;overflow:hidden;box-shadow:0 30px 80px rgba(0,0,0,.65)}
    .settings-sidebar{width:240px;background:rgba(15,23,42,.88);border-right:1px solid var(--shell-border,rgba(255,255,255,.12));display:flex;flex-direction:column;gap:6px;padding:22px 18px;position:relative}
    .settings-sidebar::after{content:"";position:absolute;top:0;right:0;bottom:0;width:1px;background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,0));opacity:.6}
    .settings-sidebar-title{font-size:.78rem;letter-spacing:.12em;text-transform:uppercase;color:#94a3b8;font-weight:800;margin-bottom:12px}
    .settings-nav-btn{appearance:none;border:0;border-radius:12px;padding:10px 12px;background:transparent;color:#e2e8f0;font-size:.9rem;font-weight:700;text-align:left;cursor:pointer;transition:background .2s ease,color .2s ease,transform .2s ease}
    .settings-nav-btn:hover,.settings-nav-btn:focus-visible{outline:none;background:rgba(14,116,144,.18);color:#fff;transform:translateX(2px)}
    .settings-nav-btn.active{background:rgba(14,116,144,.28);color:#fff;box-shadow:inset 0 0 0 1px rgba(56,189,248,.35)}
    .settings-content{flex:1;display:flex;flex-direction:column;background:linear-gradient(135deg,rgba(13,23,42,.85),rgba(9,14,32,.95))}
    .settings-content-header{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:22px 24px;border-bottom:1px solid var(--shell-border,rgba(255,255,255,.12))}
    .settings-content-header h2{margin:0;font-size:1.35rem;font-weight:800;color:#f8fafc}
    .settings-subtitle{margin:4px 0 0;font-size:.9rem;color:#cbd5f5}
    .settings-close{background:rgba(15,23,42,.72);border:1px solid rgba(148,163,184,.24);color:#e2e8f0;border-radius:10px;width:40px;height:40px;font-size:1.4rem;font-weight:700;line-height:1;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .2s ease,border-color .2s ease,transform .2s ease}
    .settings-close:hover,.settings-close:focus-visible{outline:none;background:rgba(14,116,144,.25);border-color:var(--accent);transform:rotate(90deg)}
    .settings-body{flex:1;padding:24px;overflow-y:auto;display:flex;flex-direction:column;gap:18px}
    .settings-card{background:rgba(15,23,42,.75);border:1px solid var(--shell-border,rgba(255,255,255,.12));border-radius:14px;padding:18px;display:flex;flex-direction:column;gap:10px;box-shadow:0 18px 30px rgba(8,15,40,.45)}
    .settings-card h3{margin:0;font-size:1.05rem;font-weight:800;color:#f1f5f9}
    .settings-card p{margin:0;font-size:.92rem;color:#cbd5f5;line-height:1.6}
    .settings-card ul{margin:0;padding-left:18px;color:#cbd5f5;font-size:.9rem;display:flex;flex-direction:column;gap:4px}
    .settings-card ul li strong{color:#f8fafc}
    .settings-mobile-nav{display:none;align-items:center;gap:12px;padding:16px 24px;border-bottom:1px solid rgba(148,163,184,.18);background:rgba(15,23,42,.75)}
    .settings-mobile-nav label{font-size:.78rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#94a3b8}
    .settings-mobile-nav select{flex:1;background:#0f172a;border:1px solid rgba(148,163,184,.28);border-radius:10px;padding:8px 12px;color:#e2e8f0;font-size:.92rem}
    @media (max-width: 980px){
      .settings-panel{padding:16px}
      .settings-panel-inner{flex-direction:column;width:min(680px,96vw)}
      .settings-sidebar{display:none}
      .settings-mobile-nav{display:flex}
      .settings-content{background:rgba(15,23,42,.92)}
    }
    @media (max-width: 600px){
      .settings-panel{padding:12px}
      .settings-close{width:36px;height:36px}
      .settings-body{padding:18px}
    }
    .mini-total{background:var(--panel);border:1px solid #222;border-radius:12px;padding:8px 12px;display:flex;align-items:center;gap:8px;box-shadow:0 4px 12px rgba(0,0,0,.35);min-width:84px;justify-content:center;flex-wrap:wrap}
    .mini-total .dot{width:8px;height:8px;border-radius:50%;background:var(--accent)}
    .mini-total .total-level{font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#cbd5f5}
    .mini-total[data-level="excelente"] .dot{background:#22c55e}
    .mini-total[data-level="bom"] .dot{background:#38bdf8}
    .mini-total[data-level="atencao"] .dot{background:#f97316}
    .mini-total[data-level="critico"] .dot{background:#ef4444}
    .total-score{font-size:1.4rem;font-weight:900;line-height:1;color:var(--accent)}
    .total-sub{font-size:.8rem;color:var(--muted)}
    .mini-total[data-tip]{position:relative}
    .mini-total[data-tip]:hover::after{content:attr(data-tip);position:absolute;right:0;top:calc(100% + 8px);background:#000;color:#fff;border:1px solid #222;padding:8px 10px;border-radius:8px;font-size:.8rem;white-space:nowrap;box-shadow:0 6px 16px rgba(0,0,0,.45);z-index:5}

    .storage-usage{display:flex;flex-direction:column;gap:6px;background:var(--panel);border:1px solid var(--shell-border);border-radius:12px;padding:10px 12px;min-width:220px;flex:1 1 240px;max-width:320px;box-shadow:0 4px 12px rgba(0,0,0,.3)}
    .storage-usage.hidden{display:none}
    .storage-usage-header,.storage-usage-footer{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap}
    .storage-usage-title{font-size:.78rem;font-weight:700;color:var(--muted)}
    .storage-usage-percent{font-size:.9rem;font-weight:800;color:#fff}
    .storage-usage-bar{width:100%;height:8px;background:rgba(255,255,255,.14);border-radius:999px;overflow:hidden;position:relative}
    .storage-usage-fill{height:100%;width:0;background:var(--accent);transition:width .25s ease,background-color .25s ease}
    .storage-usage[data-level="warn"] .storage-usage-fill{background:#ffb74d}
    .storage-usage[data-level="alert"] .storage-usage-fill{background:#ef5350}
    .storage-usage[data-level="warn"] .storage-usage-percent{color:#ffb74d}
    .storage-usage[data-level="alert"] .storage-usage-percent{color:#ef9a9a}
    .storage-usage-footer{font-size:.75rem;color:var(--muted)}
    .storage-usage-summary{color:#fff;font-weight:600}
    .storage-usage-hint{margin-left:auto}

    .section-title{display:none}
    .header-calendar-bar{display:none}
    @media (min-width: 821px){
      .header-calendar-bar{
        display:flex;
        align-items:center;
        gap:12px;
        background:var(--title-bg,rgba(0,0,0,.35));
        border:1px solid var(--shell-border,rgba(255,255,255,.14));
        border-radius:12px;
        padding:10px 14px;
        margin:0 0 12px;
        box-shadow:0 8px 20px rgba(0,0,0,.25);
      }
      .header-calendar-month{
        font-weight:800;
        font-size:.95rem;
        text-transform:capitalize;
        white-space:nowrap;
      }
      .header-calendar-days{
        flex:1;
        display:flex;
        gap:4px;
        align-items:center;
      }
      .header-calendar-day{
        flex:1;
        min-width:0;
        display:flex;
        align-items:center;
        justify-content:center;
        font-size:.75rem;
        font-weight:700;
        color:#e5e5e5;
        background:rgba(255,255,255,.06);
        border-radius:8px;
        padding:6px 0;
        box-shadow:0 2px 6px rgba(0,0,0,.25) inset;
      }
      .header-calendar-day.today{
        background:var(--accent,#ff6600);
        color:#000;
        box-shadow:0 0 0 1px rgba(0,0,0,.35) inset,0 4px 10px rgba(255,102,0,.35);
      }
    }
    .dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:6px}
    .macro-actions{display:none;align-items:center;justify-content:space-between;gap:12px;margin:16px 0 0}
    .macro-insight-badges{display:flex;flex-wrap:wrap;gap:8px}
    .macro-insight-badge{display:flex;align-items:center;gap:6px;background:rgba(255,255,255,.08);border:1px solid var(--shell-border);border-radius:999px;padding:6px 12px;font-size:.8rem;font-weight:600;color:#e5e7eb;box-shadow:0 4px 12px rgba(0,0,0,.28)}
    .macro-insight-badge .dot{width:8px;height:8px;border-radius:50%}
    #historyControls{display:none;margin:20px 0;text-align:right}
    #historyControls select{background:var(--input);color:#fff;border:1px solid var(--border);border-radius:8px;padding:6px 10px}
    #historyLegend{display:none;flex-wrap:wrap;gap:8px;margin:8px 0;align-items:center}
    #historyLegend .legend-item{display:flex;align-items:center;gap:4px;font-size:.8rem;color:#ddd}
    #historyLegend .legend-line{width:16px;height:4px;border-radius:2px}
    #historyChart{display:none;width:100%;margin:20px 0;height:300px}
    .macro-intel{display:flex;flex-direction:column;gap:18px}
    .macro-summary{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:16px;background:var(--panel);border:1px solid var(--shell-border);border-radius:18px;padding:18px;box-shadow:0 14px 32px rgba(0,0,0,.38)}
    .macro-summary-left{display:flex;flex-direction:column;gap:6px;min-width:220px}
    .macro-summary-score{font-size:2.6rem;font-weight:800;line-height:1}
    .macro-summary-level{font-size:1.05rem;font-weight:800;text-transform:uppercase;letter-spacing:.08em}
    .macro-summary-detail{color:#cbd5f5;font-size:.86rem;max-width:540px}
    .macro-summary-meta{display:flex;flex-direction:column;gap:6px;color:#94a3b8;font-size:.8rem}
    .macro-progress-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:16px}
    .macro-progress-card{position:relative;border-radius:18px;padding:18px;color:#fff;overflow:hidden;box-shadow:0 14px 30px rgba(0,0,0,.38)}
    .macro-progress-card::after{content:"";position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,.12),rgba(0,0,0,.3));opacity:.35;pointer-events:none}
    .macro-progress-card strong{font-size:1.02rem;display:block}
    .macro-progress-card small{display:block;margin-top:4px;font-size:.8rem;color:rgba(255,255,255,.8)}
    .macro-progress-summary{margin-top:8px;font-size:.78rem;line-height:1.3;color:rgba(255,255,255,.85);display:none}
    .macro-progress-summary.is-visible{display:flex;flex-direction:column;gap:6px}
    .macro-progress-summary div+div{margin-top:4px}
    .macro-post-target-value{display:block;font-size:1.25rem;font-weight:800;color:#fff}
    .macro-progress-value{font-size:1.9rem;font-weight:800;margin:14px 0 10px;line-height:1}
    .macro-progress-bar{height:8px;background:rgba(255,255,255,.24);border-radius:999px;overflow:hidden}
    .macro-progress-fill{height:100%;background:rgba(255,255,255,.92);border-radius:999px}
    .macro-progress-meta{display:flex;align-items:center;justify-content:space-between;color:rgba(255,255,255,.82);font-size:.78rem;margin-top:10px}
    .macro-goals-detail{background:var(--panel);border:1px solid var(--shell-border);border-radius:18px;padding:18px;box-shadow:0 14px 30px rgba(0,0,0,.36);display:flex;flex-direction:column;gap:16px}
    .macro-goals-detail-title{margin:0;font-size:1.02rem;font-weight:800;color:#fff}
    .macro-goals-detail-content{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
    .macro-goals-card{background:rgba(15,23,42,.45);border:1px solid rgba(148,163,184,.28);border-radius:14px;padding:16px;display:flex;flex-direction:column;gap:10px}
    .macro-goals-card-title{margin:0;font-size:.92rem;font-weight:700;color:#e2e8f0}
    .macro-goals-row{display:flex;align-items:center;justify-content:space-between;font-size:.86rem;color:#e2e8f0}
    .macro-goals-label{color:#94a3b8;font-weight:600}
    .macro-goals-value{font-weight:700;color:#f8fafc}
    .macro-goals-empty{display:none;text-align:center;font-size:.85rem;color:#94a3b8;background:rgba(15,23,42,.45);border:1px dashed rgba(148,163,184,.35);border-radius:12px;padding:14px}
    .macro-sections{display:grid;grid-template-columns:2fr 1fr;gap:18px}
    .macro-timeline{background:var(--panel);border:1px solid var(--shell-border);border-radius:18px;padding:18px;box-shadow:0 14px 30px rgba(0,0,0,.36);display:flex;flex-direction:column;gap:12px}
    .macro-section-title{margin:0;font-size:1.02rem;font-weight:800;color:#fff}
    .macro-timeline-list{display:flex;flex-direction:column;gap:12px;max-height:320px;overflow:auto;padding-right:4px}
    .macro-timeline-item{display:flex;gap:12px;align-items:flex-start}
    .macro-timeline-date{min-width:92px;font-weight:700;font-size:.82rem;color:#cbd5f5;text-transform:uppercase;letter-spacing:.05em}
    .macro-timeline-content{flex:1}
    .macro-timeline-label{font-weight:700;font-size:.92rem;color:#e2e8f0}
    .macro-timeline-meta{font-size:.78rem;color:#94a3b8;margin-top:4px}
    .macro-tag{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:999px;font-size:.72rem;font-weight:700;background:rgba(148,163,184,.16);color:#e2e8f0;margin-top:6px}
    .macro-checklist{background:var(--panel);border:1px solid var(--shell-border);border-radius:18px;padding:18px;box-shadow:0 14px 30px rgba(0,0,0,.36);display:flex;flex-direction:column;gap:12px}
    .macro-check-item{display:flex;gap:12px;align-items:flex-start}
    .macro-check-icon{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1rem;font-weight:700}
    .macro-check-icon.done{background:#22c55e;color:#052e16}
    .macro-check-icon.pending{background:#f97316;color:#311508}
    .macro-check-text{flex:1}
    .macro-check-text strong{display:block;font-size:.92rem;color:#e2e8f0}
    .macro-check-text span{display:block;font-size:.78rem;color:#94a3b8;margin-top:2px}
    .macro-alerts{display:flex;flex-direction:column;gap:10px}
    .macro-alert{display:flex;gap:10px;align-items:flex-start;background:rgba(248,113,113,.12);border:1px solid rgba(248,113,113,.4);border-radius:14px;padding:12px 14px;color:#fecaca;font-size:.84rem;box-shadow:0 10px 24px rgba(0,0,0,.32)}
    .macro-alert.ok{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.35);color:#bbf7d0}
    .macro-mini-dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px}
    .macro-mini-card{background:var(--panel);border:1px solid var(--shell-border);border-radius:16px;padding:16px;box-shadow:0 10px 26px rgba(0,0,0,.34);display:flex;flex-direction:column;gap:8px}
    .macro-mini-card strong{font-size:1.1rem;color:#f8fafc}
    .macro-mini-card span{font-size:.8rem;color:#94a3b8}
    .macro-fill{background:var(--panel);border:1px solid var(--shell-border);border-radius:18px;padding:18px;box-shadow:0 14px 30px rgba(0,0,0,.36);display:flex;flex-direction:column;gap:14px}
    .macro-indicator{display:flex;flex-direction:column;gap:8px}
    .macro-indicator-head{display:flex;align-items:center;justify-content:space-between;font-weight:700;font-size:.9rem;color:#e2e8f0}
    .macro-indicator-bar{height:8px;background:rgba(148,163,184,.2);border-radius:999px;overflow:hidden}
    .macro-indicator-fill{height:100%;background:linear-gradient(90deg,#38bdf8,#0ea5e9)}
    .macro-indicator-desc{font-size:.78rem;color:#94a3b8}
    .macro-empty{background:rgba(15,23,42,.6);border:1px dashed rgba(148,163,184,.3);padding:14px;border-radius:12px;color:#94a3b8;font-size:.85rem;text-align:center}
    .macro-supplemental{display:flex;flex-direction:column;gap:16px}
    .macro-supplemental-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
    .macro-metric-card{background:var(--panel);border:1px solid var(--shell-border);border-radius:16px;padding:16px;box-shadow:0 12px 26px rgba(0,0,0,.32);display:flex;flex-direction:column;gap:10px}
    .macro-metric-title{margin:0;font-size:.95rem;font-weight:800;color:#f8fafc}
    .macro-metric-value{font-size:1.8rem;font-weight:800;color:#fff;line-height:1}
    .macro-metric-detail{font-size:.78rem;color:#94a3b8;min-height:1.2em}
    .macro-list-card{background:var(--panel);border:1px solid var(--shell-border);border-radius:16px;padding:16px;box-shadow:0 12px 26px rgba(0,0,0,.32);display:flex;flex-direction:column;gap:12px}
    .macro-list-title{margin:0;font-size:1rem;font-weight:800;color:#f8fafc}
    .macro-list-items{display:flex;flex-direction:column;gap:10px}
    .macro-list-item{display:flex;flex-direction:column;gap:2px}
    .macro-list-item strong{font-size:.9rem;color:#e2e8f0}
    .macro-list-item span{font-size:.75rem;color:#94a3b8}
    .macro-list-empty{display:none;font-size:.8rem;color:#94a3b8;background:rgba(15,23,42,.45);border:1px dashed rgba(148,163,184,.28);border-radius:10px;padding:12px;text-align:center}
    .macro-social-card{background:var(--panel);border:1px solid var(--shell-border);border-radius:20px;padding:22px;box-shadow:0 16px 34px rgba(0,0,0,.32);display:flex;flex-direction:column;gap:18px}
    .macro-social-title{margin:0;font-size:1.05rem;font-weight:800;color:#f8fafc;text-align:center}
    .macro-social-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px}
    .macro-social-item{display:flex;flex-direction:column;align-items:center;justify-content:flex-start;gap:14px;background:rgba(15,23,42,.52);border:1px solid rgba(148,163,184,.28);border-radius:18px;padding:18px 16px;text-align:center;box-shadow:0 10px 22px rgba(0,0,0,.26);min-height:220px;transition:transform .2s ease,box-shadow .2s ease}
    .macro-social-item:hover{transform:translateY(-2px);box-shadow:0 16px 28px rgba(0,0,0,.28)}
    .macro-social-icon{width:56px;height:56px;border-radius:16px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,.8);border:1px solid rgba(148,163,184,.38);color:#e2e8f0;flex:0 0 auto;padding:16px;font-size:24px;line-height:1}
    .macro-social-icon img{width:24px;height:24px;object-fit:contain;display:block}
    .macro-social-info{display:flex;flex-direction:column;gap:6px;align-items:center;justify-content:center;flex:1;min-width:0}
    .macro-social-label{font-size:.9rem;font-weight:700;color:#f1f5f9}
    .macro-social-status{display:inline-flex;align-items:center;justify-content:center;gap:6px;font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;padding:4px 12px;border-radius:999px;margin-top:2px}
    .macro-social-status.ok{background:rgba(34,197,94,.16);color:#bbf7d0;border:1px solid rgba(34,197,94,.45)}
    .macro-social-status.missing{background:rgba(248,113,113,.16);color:#fecaca;border:1px solid rgba(248,113,113,.45)}
    .macro-social-detail{font-size:.75rem;color:#94a3b8;line-height:1.4}
    .macro-social-actions{display:flex;justify-content:center;align-items:center;width:100%;margin-top:auto}
    .macro-social-open{background:rgba(148,163,184,.18);color:#f1f5f9;border:1px solid rgba(148,163,184,.4);border-radius:999px;padding:8px 18px;font-size:.75rem;font-weight:800;text-transform:uppercase;letter-spacing:.08em;cursor:pointer;transition:background .2s,color .2s,border-color .2s;min-width:140px}
    .macro-social-open:hover{background:rgba(148,163,184,.3);color:#fff}
    .macro-social-open:disabled{opacity:.55;cursor:not-allowed;background:rgba(148,163,184,.12);color:#94a3b8;border-color:rgba(148,163,184,.24)}
    .macro-social-summary{margin-top:4px;font-size:.82rem;color:#cbd5f5;font-weight:600;background:rgba(15,23,42,.52);border:1px dashed rgba(148,163,184,.32);border-radius:14px;padding:12px 16px;text-align:center}

    @media (max-width: 900px){
      .macro-summary{padding:16px}
      .macro-summary-score{font-size:2.2rem}
      .macro-progress-card{padding:16px}
      .macro-progress-value{font-size:1.6rem}
    }

    @media (max-width: 768px){
      .macro-actions{flex-direction:column;align-items:flex-start;gap:10px}
      .macro-intel{gap:14px}
      .macro-summary{flex-direction:column;align-items:flex-start;text-align:left;gap:12px}
      .macro-summary-left{min-width:0;width:100%;gap:4px}
      .macro-summary-score{font-size:2rem}
      .macro-summary-meta{font-size:.78rem}
      .macro-progress-grid{grid-template-columns:1fr}
      .macro-progress-card{padding:14px}
      .macro-progress-meta{flex-direction:column;align-items:flex-start;gap:6px;margin-top:8px}
      .macro-progress-summary{gap:6px}
      .macro-progress-summary.is-visible{display:flex;flex-direction:column;gap:6px}
      .macro-goals-detail{padding:16px}
      .macro-goals-detail-content{grid-template-columns:1fr}
      .macro-goals-row{flex-direction:column;align-items:flex-start;gap:4px}
      .macro-sections{grid-template-columns:1fr;gap:14px}
      .macro-timeline{padding:16px}
      .macro-timeline-list{max-height:none;padding-right:0}
      .macro-timeline-item{flex-direction:column;gap:6px}
      .macro-timeline-date{min-width:0;font-size:.78rem}
      .macro-checklist{padding:16px}
      .macro-check-item{flex-direction:column;gap:8px}
      .macro-alert{flex-direction:column;gap:8px}
      .macro-mini-dashboard{grid-template-columns:1fr}
      .macro-mini-card{padding:14px}
      .macro-fill{padding:16px;gap:12px}
      .macro-indicator-head{flex-direction:column;align-items:flex-start;gap:4px}
      .macro-supplemental{gap:14px}
      .macro-supplemental-grid{grid-template-columns:1fr}
      .macro-list-card{padding:14px}
      .macro-social-card{padding:16px}
      .macro-social-grid{grid-template-columns:1fr}
    }

    @media (max-width: 520px){
      .macro-summary{padding:14px}
      .macro-summary-score{font-size:1.8rem}
      .macro-summary-level{font-size:.95rem}
      .macro-summary-detail{font-size:.8rem}
      .macro-progress-card{padding:12px}
      .macro-progress-card strong{font-size:.95rem}
      .macro-progress-value{font-size:1.4rem;margin:12px 0 8px}
      .macro-progress-meta{font-size:.72rem}
      .macro-goals-card{padding:14px}
      .macro-timeline{padding:14px}
      .macro-timeline-date{font-size:.72rem}
      .macro-checklist{padding:14px}
      .macro-alert{padding:12px}
      .macro-mini-card{padding:12px}
      .macro-metric-card{padding:12px}
      .macro-list-card{padding:12px}
      .macro-social-card{padding:14px}
      .macro-social-item{min-height:auto;padding:16px 14px;gap:12px}
      .macro-social-open{min-width:0;width:100%}
      .macro-social-icon{width:52px;height:52px;padding:14px}
    }

    /* tabs */
    .tabs-container{width:100%;margin:14px auto 6px auto;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;gap:8px}
    .menu-toggle{display:none;align-items:center;justify-content:center;gap:8px;background:linear-gradient(135deg,#ff7a1a,#ff3b30);border:0;color:#fff;font-weight:800;border-radius:14px;padding:12px 18px;cursor:pointer;box-shadow:0 10px 22px rgba(255,82,40,.32),0 0 0 1px rgba(255,255,255,.08) inset;text-shadow:0 1px 3px rgba(0,0,0,.35);transition:transform .18s ease,box-shadow .18s ease,filter .18s ease}
    .menu-toggle:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
    .menu-toggle:hover,.menu-toggle:active{transform:scale(1.03);filter:brightness(1.05);box-shadow:0 14px 26px rgba(255,82,40,.38),0 0 0 1px rgba(255,255,255,.12) inset}
    .menu-toggle:active{transform:scale(1.02)}
    .tabs{margin:0;width:100%;display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap}
    .tab-btn{border:1px solid var(--shell-border);background:rgba(255,255,255,.06);color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:800;font-size:.92rem;transition:transform .06s ease,background .2s ease;display:inline-flex;align-items:center;gap:6px}
    .tab-btn:hover{transform:translateY(-1px)}
    .tab-btn.active{background:var(--accent);color:var(--black);border-color:transparent}
    .tab-btn .tab-badge{display:inline-flex;align-items:center;gap:4px;font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.04em;background:rgba(56,189,248,.18);color:#38bdf8;border:1px solid rgba(56,189,248,.45);border-radius:999px;padding:2px 6px}
    .tab-btn .tab-badge::before{content:"";width:6px;height:6px;border-radius:50%;background:currentColor;display:inline-block}
    .tab-btn .tab-badge[hidden]{display:none}

    @media (max-width: 820px){
      .tabs-container{align-items:stretch;gap:0}
      .menu-toggle{display:flex;width:min(260px,100%);margin:0 auto}
      .tabs{display:none;position:absolute;top:calc(100% + 8px);left:50%;transform:translateX(-50%);flex-direction:column;align-items:stretch;justify-content:flex-start;gap:8px;flex-wrap:nowrap;background:rgba(15,23,42,.95);border:1px solid var(--shell-border);border-radius:12px;padding:12px;max-width:min(340px,calc(100vw - 32px));box-shadow:0 18px 32px rgba(0,0,0,.45);z-index:999}
      .tabs-container.menu-open .tabs{display:flex}
      .tabs-container.menu-open .menu-toggle{background:linear-gradient(135deg,#ff8a2b,#ff613a);color:#fff;box-shadow:0 12px 24px rgba(255,82,40,.4),0 0 0 1px rgba(255,255,255,.12) inset}
      .tabs .tab-btn{width:100%;text-align:left}
    }

    /* iframes list */
    .widgets-grid{display:flex;flex-direction:column;gap:12px;margin-top:6px}
    .widget-card{background:transparent;border:0;border-radius:12px;padding:0;width:100%}
    .widget-head{display:flex;align-items:center;gap:8px;margin-left:var(--margin-left);margin-right:var(--margin-right);padding:6px 10px;border-top-left-radius:10px;border-top-right-radius:10px;background:var(--title-bg);backdrop-filter:blur(2px);border:1px solid var(--shell-border);border-bottom:0;cursor:grab}
    .widget-head:active{cursor:grabbing}
    .widget-title{font-weight:700;font-size:.95rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
    .widget-meta{font-size:.8rem;color:#ddd;opacity:.85;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:40%}
    .widget-actions{display:flex;gap:6px;margin-left:6px}
    .icon-btn{border:1px solid var(--shell-border);background:rgba(255,255,255,.06);color:#fff;border-radius:8px;padding:4px 8px;font-size:.85rem;cursor:pointer}
    .icon-btn.danger{background:#3a0000;border-color:#5a0000}
    .widget-input{position:relative;z-index:2;display:none;margin:6px var(--margin-right) 0 var(--margin-left);grid-template-columns:1fr 1fr;gap:8px}
    .widget-card.editing .widget-input{display:grid}
    .widget-input .input{background:var(--input);border:1px solid var(--border);border-radius:8px;padding:10px 12px}
    .frame-shell{height:var(--iframe-h);border:1px solid var(--shell-border);border-top:0;border-bottom-left-radius:10px;border-bottom-right-radius:10px;background:transparent;resize:vertical;overflow:auto;min-height:200px;max-height:3000px;margin-left:var(--margin-left);margin-right:var(--margin-right);box-shadow:0 6px 18px rgba(0,0,0,.35);overscroll-behavior:contain}
    .widget-iframe{width:100%;height:100%;border:0;display:block;background:transparent}
    .drag-placeholder{outline:2px dashed rgba(255,255,255,.35);border-radius:12px;margin-left:var(--margin-left);margin-right:var(--margin-right);height:24px}

    .muted{color:var(--muted);font-size:.85rem}
    @media (max-width: 820px){.brief-webhook-area{display:none!important}}

    /* notas */
    .notes-wrap{margin-left:var(--margin-left);margin-right:var(--margin-right);display:flex;flex-direction:column;gap:10px}
    .note-toolbar, .brief-toolbar{display:flex;flex-wrap:wrap;gap:6px;align-items:center;background:var(--title-bg);border:1px solid var(--shell-border);padding:8px;border-radius:10px}
    .note-toolbar .tool, .brief-toolbar .tool{background:#222;border:1px solid #333;color:#fff;border-radius:8px;padding:6px 10px;cursor:pointer;font-weight:700}
    .brief-toolbar-main{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .brief-webhook-controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .note-toolbar select, .note-toolbar input[type="date"], .note-toolbar input[type="text"],
    .note-toolbar input[type="color"],
    .brief-toolbar input[type="text"]{background:#222;color:#fff;border:1px solid #333;border-radius:8px;padding:6px 8px}
    .note-toolbar input[type="color"]{padding:0;width:36px;height:36px}
    .note-editor{min-height:180px;border:1px solid var(--shell-border);border-radius:10px;padding:10px;outline:none;white-space:pre-wrap;word-wrap:break-word}
    .note-editor, .note-editor *{color:#fff!important;background:transparent!important}
    .note-editor{background:rgba(0,0,0,.2)!important}
    .notes-list{display:flex;flex-direction:column;gap:10px;margin-top:4px}
    .note-template-actions{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    .note-template-actions select{min-width:160px}
    @media (max-width:640px){
      .note-template-actions{width:100%;justify-content:flex-start}
      .note-template-actions select{flex:1 1 160px}
      .note-template-actions .btn{flex:1 1 auto;min-width:140px}
    }
    .note-item{background:var(--panel);border:1px solid var(--shell-border);border-radius:12px;padding:10px;box-shadow:0 6px 18px rgba(0,0,0,.35)}
    .note-head{display:flex;justify-content:space-between;gap:8px;align-items:center}
    .note-title{font-weight:900}
    .note-meta{font-size:.85rem;color:#ddd}
    .tag{font-size:.75rem;font-weight:800;background:#333;padding:3px 8px;border-radius:999px}
    .media-resizable{display:inline-block;max-width:100%;border:1px dashed rgba(255,255,255,.25);border-radius:6px;overflow:auto;resize:both;padding:2px;margin:6px 2px;vertical-align:middle;background:rgba(255,255,255,.02)}
    .media-resizable img,.media-resizable video{display:block;max-width:100%;height:auto;pointer-events:none}
    .media-resizable.selected{border-color:var(--accent);box-shadow:0 0 0 2px rgba(255,102,0,.25) inset}

    /* ===== IA CHAT ===== */
    .ia-wrap{margin-left:var(--margin-left);margin-right:var(--margin-right);display:flex;flex-direction:column;gap:12px;min-height:0}
    .ia-shell{display:flex;gap:12px;min-height:0}
    .ia-sidebar{width:280px;background:var(--panel);border:1px solid var(--shell-border);border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:10px;box-shadow:0 8px 22px rgba(0,0,0,.35);overflow:hidden}
    .ia-sidebar-content{flex:1;min-height:0;display:flex;flex-direction:column;gap:10px;overflow:hidden}
    .ia-knowledge{border:1px solid rgba(255,255,255,.12);border-radius:12px;background:rgba(255,255,255,.03);overflow:hidden}
    .ia-knowledge summary{margin:0;padding:12px;font-size:.9rem;font-weight:800;list-style:none;display:flex;align-items:center;justify-content:space-between;cursor:pointer;gap:8px}
    .ia-knowledge summary:hover{background:rgba(255,255,255,.04)}
    .ia-knowledge summary::-webkit-details-marker{display:none}
    .ia-knowledge summary::after{content:'‚ñæ';font-size:.8rem;opacity:.8;transition:transform .2s ease}
    .ia-knowledge[open] summary::after{transform:rotate(180deg)}
    .ia-knowledge-content{padding:0 12px 12px;display:flex;flex-direction:column;gap:10px}
    .ia-knowledge p{margin:0;font-size:.8rem;color:rgba(255,255,255,.6);line-height:1.4}
    .ia-doc-count{font-size:.75rem;color:rgba(255,255,255,.65);background:rgba(255,255,255,.06);padding:2px 8px;border-radius:999px;font-weight:700}
    .ia-docs-actions{display:flex;gap:8px;flex-wrap:wrap}
    .ia-docs-actions .btn{flex:1}
    .ia-docs-status{font-size:.75rem;color:rgba(255,255,255,.55)}
    .ia-docs-list{display:flex;flex-direction:column;gap:8px;max-height:220px;overflow:auto;padding-right:4px}
    .ia-doc-item{border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px;background:rgba(0,0,0,.3);display:flex;flex-direction:column;gap:6px}
    .ia-doc-item h4{margin:0;font-size:.85rem;font-weight:800;color:#fff}
    .ia-doc-meta{font-size:.75rem;color:rgba(255,255,255,.55);display:flex;gap:10px;flex-wrap:wrap}
    .ia-doc-buttons{display:flex;gap:6px;flex-wrap:wrap}
    .ia-doc-buttons .btn.small{flex:1;min-width:120px}
    .ia-doc-empty{font-size:.8rem;color:rgba(255,255,255,.55);padding:10px;text-align:center;border:1px dashed rgba(255,255,255,.18);border-radius:10px}
    .ia-sidebar-header{display:flex;justify-content:space-between;align-items:center}
    .ia-sidebar-search .input{width:100%;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);color:#fff;border-radius:10px;padding:8px 12px}
    .ia-chat-list{flex:1;min-height:0;overflow:auto;display:flex;flex-direction:column;gap:6px;padding-right:4px}
    .ia-chat-item{border:1px solid transparent;background:rgba(255,255,255,.04);color:#fff;border-radius:10px;padding:10px;display:flex;flex-direction:column;gap:4px;text-align:left;cursor:pointer;transition:background .2s ease,border .2s ease}
    .ia-chat-item:hover{background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.12)}
    .ia-chat-item.active{background:var(--accent);color:#000;border-color:transparent;box-shadow:0 6px 16px rgba(255,102,0,.4)}
    .ia-chat-item.active .ia-chat-meta,.ia-chat-item.active .ia-chat-preview{color:#111}
    .ia-chat-title{font-weight:800;font-size:.95rem;line-height:1.2}
    .ia-chat-preview{font-size:.8rem;color:rgba(255,255,255,.75);line-height:1.3}
    .ia-chat-meta{font-size:.75rem;color:rgba(255,255,255,.55)}
    .ia-chat-empty{padding:20px;border:1px dashed rgba(255,255,255,.2);border-radius:12px;text-align:center;font-size:.85rem;color:rgba(255,255,255,.6)}
    .ia-main{flex:1;background:var(--panel);border:1px solid var(--shell-border);border-radius:16px;display:flex;flex-direction:column;position:relative;box-shadow:0 10px 26px rgba(0,0,0,.35);overflow:hidden;max-height:calc(100vh - 220px);min-height:0}
    .ia-main-head{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid rgba(255,255,255,.08);gap:10px}
    .ia-title{font-weight:900;font-size:1.05rem;flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .ia-main-actions{display:flex;gap:8px}
    .btn.ghost.danger{background:rgba(255,255,255,.04);border-color:#5a0000;color:#ff9a9a}
    .ia-history{flex:1;overflow-y:auto;padding:18px;display:flex;flex-direction:column;gap:16px;scroll-behavior:smooth;background:linear-gradient(180deg,rgba(255,255,255,.01),rgba(0,0,0,.08));min-height:0}
    .ia-msg{max-width:78%;display:flex;flex-direction:column;gap:6px}
    .ia-msg-user{margin-left:auto;align-items:flex-end}
    .ia-msg-assistant{margin-right:auto;align-items:flex-start}
    .ia-msg-bubble{padding:12px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.05);font-size:.95rem;line-height:1.5;box-shadow:0 8px 18px rgba(0,0,0,.25);display:flex;flex-direction:column;gap:10px}
    .ia-msg-user .ia-msg-bubble{background:linear-gradient(135deg,var(--accent),#ff944d);color:#000;border-color:rgba(0,0,0,.08);box-shadow:0 10px 22px rgba(255,102,0,.35)}
    .ia-msg-meta{font-size:.75rem;color:rgba(255,255,255,.55)}
    .ia-msg-user .ia-msg-meta{color:rgba(0,0,0,.6)}
    .ia-msg-content p{margin:0 0 8px 0}
    .ia-msg-content p:last-child{margin-bottom:0}
    .ia-msg-content ul,.ia-msg-content ol{margin:0 0 8px 18px}
    .ia-msg-content ul:last-child,.ia-msg-content ol:last-child{margin-bottom:0}
    .ia-msg-content li{margin-bottom:4px}
    .ia-msg-content pre{margin:0}
    .ia-code{background:#090909;border:1px solid #222;border-radius:10px;padding:12px;font-family:"Fira Code",monospace;font-size:.85rem;overflow:auto}
    .ia-msg-actions{display:flex;justify-content:flex-end;gap:8px}
    .ia-copy-btn{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);color:#fff;border-radius:8px;padding:4px 10px;font-size:.75rem;font-weight:700;cursor:pointer;transition:background .2s ease,transform .1s ease}
    .ia-copy-btn:hover{background:rgba(255,255,255,.16)}
    .ia-copy-btn:active{transform:scale(.97)}
    .ia-empty{position:absolute;inset:80px 18px 90px 18px;border:1px dashed rgba(255,255,255,.18);border-radius:16px;display:flex;align-items:center;justify-content:center;text-align:center;padding:20px;color:rgba(255,255,255,.6);font-size:.9rem;pointer-events:none}
    .ia-composer{position:sticky;bottom:0;display:flex;gap:10px;padding:14px 18px;background:rgba(0,0,0,.65);backdrop-filter:blur(8px);border-top:1px solid rgba(255,255,255,.08);flex-wrap:wrap;align-items:flex-end}
    .ia-input{flex:1;resize:none;min-height:48px;max-height:180px;padding:12px 14px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.12);border-radius:12px;color:#fff}
    .ia-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(255,102,0,.25)}
    .ia-source-note{margin:4px 0 0;width:100%;font-size:.72rem;color:rgba(255,255,255,.6);letter-spacing:.01em;opacity:.85}
    .ia-typing{display:inline-flex;gap:6px;align-items:center}
    .ia-typing span{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.85);animation:iaTyping 1s ease-in-out infinite}
    .ia-typing span:nth-child(2){animation-delay:.15s}
    .ia-typing span:nth-child(3){animation-delay:.3s}
    @keyframes iaTyping{0%,80%,100%{opacity:.4;transform:translateY(0)}40%{opacity:1;transform:translateY(-3px)}}
    @media (max-width:1024px){
      .ia-shell{flex-direction:column}
      .ia-sidebar{width:100%;flex-direction:column}
      .ia-main{max-height:calc(100vh - 260px)}
      .ia-msg{max-width:88%}
    }
    @media (max-width:640px){
      .ia-shell{min-height:420px}
      .ia-main{max-height:calc(100vh - 320px)}
      .ia-main-head{flex-direction:column;align-items:flex-start}
      .ia-main-actions{width:100%;justify-content:flex-end}
      .ia-composer{flex-direction:column}
      .ia-input{width:100%}
      #iaSend{width:100%}
    }


    /* ========= CALEND√ÅRIO / POSTS (Firestore + Storage) ========= */
    const calWeekdays = $("calWeekdays"), calDays = $("calDays"), calTitle = $("calTitle");
    const googleCalendarConnectBtn = $("googleCalendarConnect"), googleCalendarDisconnectBtn = $("googleCalendarDisconnect"), googleCalendarStatus = $("googleCalendarStatus");
    if(window.googleCalendarIntegration){
      window.googleCalendarIntegration.setDomRefs({
        connectBtn: googleCalendarConnectBtn,
        disconnectBtn: googleCalendarDisconnectBtn,
        statusEl: googleCalendarStatus
      });
      if(typeof window.googleCalendarIntegration.ensureConnected === 'function'){
        window.googleCalendarIntegration.ensureConnected();
      }
    }
    const calPrev = $("calPrev"), calNext = $("calNext"), calUpload = $("calUpload"), btnShareCalendar = $("btnShareCalendar");
    const btnCopyPlanningLink = $("btnCopyPlanningLink");
    const calDate = $("calDate"), calDesc = $("calDesc"), calFiles = $("calFiles"), calTarget = $("calTarget"), calFilterStatus = $("calFilterStatus"), calFilterCountry = $("calFilterCountry"), calFilterText = $("calFilterText");
    const feedGrid = $("feedGrid"), storiesGrid = $("storiesGrid"), storiesPrev = $("storiesPrev"), storiesNext = $("storiesNext"), calendarDemandasMobile = $("calendarDemandasMobile");
    const postModal = $("postModal"), modalClose = $("modalClose"), modalTitle = $("modalTitle"), modalPreview = $("modalPreview"), modalDate = $("modalDate"), modalStatus = $("modalStatus"), modalDesc = $("modalDesc"), modalTarget = $("modalTarget");
    const btnApprove = $("btnApprove"), btnApproveInternal = $("btnApproveInternal"), btnReview = $("btnReview"), btnCopyApprovalLink = $("btnCopyApprovalLink"), btnSave = $("btnSave"), btnDelete = $("btnDelete");

    if(storiesPrev && storiesGrid) storiesPrev.onclick = () => storiesGrid.scrollBy({left:-100, behavior:'smooth'});
    if(storiesNext && storiesGrid) storiesNext.onclick = () => storiesGrid.scrollBy({left:100, behavior:'smooth'});

    let STORAGE = null;
    let POSTS = []; // {id,dateISO,desc,mediaUrls:[...],thumbUrl,type,status,target,createdAt}
    let coverInput = null;
    let coverUploading = false;

    function ensureCoverInput(){
      if(coverInput) return coverInput;
      coverInput = document.createElement('input');
      coverInput.type = 'file';
      coverInput.accept = 'image/*';
      coverInput.style.display = 'none';
      coverInput.id = 'coverUploadInput';
      document.body.appendChild(coverInput);
      coverInput.addEventListener('change', ()=>{
        const file = coverInput.files?.[0] || null;
        const postId = coverInput.getAttribute('data-post-id');
        coverInput.value = '';
        coverInput.removeAttribute('data-post-id');
        if(file && postId){ uploadCoverImage(postId, file); }
      });
      return coverInput;
    }

    function promptCoverUpload(postId){
      if(!postId) return;
      const input = ensureCoverInput();
      input.setAttribute('data-post-id', postId);
      input.click();
    }

    async function uploadCoverImage(postId, file){
      if(!file) return;
      if(coverUploading) return;
      try{
        if(!(file.type||'').toLowerCase().startsWith('image/')){
          alert('Selecione uma imagem para a capa.');
          return;
        }
        const uid = auth.currentUser?.uid;
        if(!uid){
          alert('Fa√ßa login para enviar a capa.');
          return;
        }
        const post = POSTS.find(p=>p.id===postId);
        if(!post){
          alert('Post n√£o encontrado.');
          return;
        }
        const safeTenant = (typeof TENANT!=="undefined" && TENANT) ? TENANT : null;
        if(!safeTenant || safeTenant === 'no-client'){
          alert('Cliente n√£o definido na URL.');
          return;
        }
        if(!STORAGE){
          try{ STORAGE = getStorage(app); }
          catch(err){ console.error(err); alert('Storage n√£o inicializado.'); return; }
        }
        coverUploading = true;
        const safeName = (file.name||'cover').replace(/[^a-zA-Z0-9._-]/g,'_');
        const path = `users/${uid}/tenant-${safeTenant}/posts/${postId}/cover_${Date.now()}_${safeName}`;
        const ref = sRef(STORAGE, path);
        await uploadBytes(ref, file);
        const url = await getDownloadURL(ref);
        const coverSize = Number(file?.size);
        const coverMeta = {
          path,
          size: Number.isFinite(coverSize) && coverSize > 0 ? coverSize : null,
          contentType: file?.type || ''
        };
        await updateDoc(doc(db, 'usuarios', uid, 'posts', postId), {
          thumbUrl: url,
          coverMeta,
          updatedAt: serverTimestamp()
        });
        post.thumbUrl = url;
        post.coverMeta = coverMeta;
        if(selectedPost && selectedPost.id===postId){
          selectedPost.thumbUrl = url;
          selectedPost.coverMeta = coverMeta;
        }
        if(typeof mgToast === 'function'){
          mgToast('Capa atualizada!');
        }
        renderCalendarDays();
        renderPlanilha();
        await refreshStorageUsage();
      }catch(err){
        console.error('uploadCoverImage', err);
        alert('Falha ao enviar capa: ' + (err?.message || String(err)));
      }finally{
        coverUploading = false;
      }
    }
    let postsUnsub = null;

    // === Gera√ß√£o autom√°tica de thumbnails para v√≠deos ===
    const VIDEO_THUMBNAILS_CACHE = new Map(); // Cache de thumbnails geradas

    async function generateVideoThumbnail(videoUrl, postId) {
      console.log('[GenerateThumbnail] Iniciando para:', videoUrl);
      
      // Verifica se j√° tem no cache
      if (VIDEO_THUMBNAILS_CACHE.has(videoUrl)) {
        console.log('[GenerateThumbnail] Retornando do cache');
        return VIDEO_THUMBNAILS_CACHE.get(videoUrl);
      }

      return new Promise((resolve, reject) => {
        const video = document.createElement('video');
        video.crossOrigin = 'anonymous';
        video.preload = 'metadata';
        video.muted = true;
        video.playsInline = true;
        
        console.log('[GenerateThumbnail] Video element criado');
        
        // Timeout de seguran√ßa
        const timeout = setTimeout(() => {
          console.error('[GenerateThumbnail] Timeout ao carregar v√≠deo');
          video.src = '';
          reject(new Error('Timeout ao gerar thumbnail'));
        }, 10000);

        video.onloadedmetadata = () => {
          console.log('[GenerateThumbnail] Metadata carregada, dura√ß√£o:', video.duration);
          // Vai para 0.5 segundo ou 10% do v√≠deo
          const seekTime = Math.min(0.5, video.duration * 0.1);
          video.currentTime = seekTime;
          console.log('[GenerateThumbnail] Buscando frame em:', seekTime, 's');
        };
        
        video.onseeked = () => {
          console.log('[GenerateThumbnail] Frame encontrado, capturando...');
          try {
            clearTimeout(timeout);
            
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 360;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const thumbnailDataUrl = canvas.toDataURL('image/jpeg', 0.7);
            
            console.log('[GenerateThumbnail] Thumbnail gerada com sucesso, tamanho:', thumbnailDataUrl.length, 'bytes');
            
            // Adiciona ao cache
            VIDEO_THUMBNAILS_CACHE.set(videoUrl, thumbnailDataUrl);
            
            // Limpa o v√≠deo
            video.src = '';
            
            resolve(thumbnailDataUrl);
          } catch (err) {
            clearTimeout(timeout);
            console.error('[GenerateThumbnail] Erro ao capturar frame:', err);
            reject(err);
          }
        };
        
        video.onerror = (err) => {
          clearTimeout(timeout);
          console.error('[GenerateThumbnail] Erro ao carregar v√≠deo:', err, video.error);
          video.src = '';
          reject(err);
        };
        
        console.log('[GenerateThumbnail] Carregando URL:', videoUrl);
        video.src = videoUrl;
      });
    }

    // Fun√ß√£o para aplicar thumbnails em elementos de v√≠deo no DOM
    function applyVideoThumbnails() {
      const videoContainers = document.querySelectorAll('.cal-thumb[data-video-url], .feed-item[data-video-url], .story-item[data-video-url], .relatorio-story-item[data-video-url]');
      
      console.log('[Thumbnails] Encontrados', videoContainers.length, 'v√≠deos para processar');
      
      videoContainers.forEach(async (container) => {
        const videoUrl = container.getAttribute('data-video-url');
        const postId = container.getAttribute('data-id');
        
        if (!videoUrl) {
          console.log('[Thumbnails] Container sem videoUrl:', container);
          return;
        }
        
        if (container.querySelector('img')) {
          console.log('[Thumbnails] J√° tem thumbnail:', videoUrl);
          return; // J√° tem thumbnail
        }
        
        console.log('[Thumbnails] Gerando thumbnail para:', videoUrl);
        
        try {
          const thumbnailUrl = await generateVideoThumbnail(videoUrl, postId);
          
          console.log('[Thumbnails] Thumbnail gerada com sucesso:', thumbnailUrl.substring(0, 50) + '...');
          
          // Verifica se ainda est√° na p√°gina e n√£o foi substitu√≠do
          if (container.getAttribute('data-video-url') === videoUrl) {
            const img = document.createElement('img');
            img.src = thumbnailUrl;
            img.alt = 'Video preview';
            img.crossOrigin = 'anonymous';
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'cover';
            
            // Remove o span "V" e adiciona a imagem
            const span = container.querySelector('span');
            if (span) span.remove();
            container.appendChild(img);
            
            console.log('[Thumbnails] Thumbnail aplicada ao container');
          }
        } catch (err) {
          console.error('[Thumbnails] Falha ao gerar thumbnail para:', videoUrl, err);
          // Mant√©m o "V" como fallback
        }
      });
    }
    let currentMonth = (()=>{ const d=new Date(); return new Date(d.getFullYear(), d.getMonth(), 1); })();
    let selectedPost = null;
    const COMMEMORATIVE_DATES_BR = window.COMMEMORATIVE_DATES_BR || {};
    const COMMEMORATIVE_DATES_US = window.COMMEMORATIVE_DATES_US || {};
    let CAL_NOTES = {};
    let calNotesUnsub = null;
// === Estado do carrossel (aprova√ß√£o slide a slide) ===
let SLIDE_IDX = 0;
let SLIDES = []; // array de URLs da m√≠dia do post
let APPROVED_CLIENT_SET = new Set(); // √≠ndices aprovados pelo cliente
let APPROVED_INTERNAL_SET = new Set(); // √≠ndices aprovados pelo time interno
let REVIEWED_SET = new Set();  // √≠ndices revisados (carregados de Firestore)


    function ensureCalendar(){
      if(!STORAGE){ try{ STORAGE = getStorage(app); }catch(_){ /* ignore */ } }
      if(!postsUnsub){ subscribePosts(); }
      if(!calNotesUnsub){ subscribeCalNotes(); }
      renderCalendarStatic();
      renderCalendarDays();
      renderPlanilha();
    }

    function monthLabel(d){
      const names = ["janeiro","fevereiro","mar√ßo","abril","maio","junho","julho","agosto","setembro","outubro","novembro","dezembro"];
      return `${names[d.getMonth()].slice(0,1).toUpperCase()}${names[d.getMonth()].slice(1)} ${d.getFullYear()}`;
    }
    function localDateISO(d){
      const z = new Date(d.getTime() - d.getTimezoneOffset()*60000);
      return z.toISOString().slice(0,10);
    }
    function daysInMonth(year, month){ return new Date(year, month+1, 0).getDate(); }

    function renderCalendarStatic(){
      if(!calWeekdays) return;
      calWeekdays.innerHTML = ["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"].map((w, idx)=>`<div class="cal-weekday${(idx===0||idx===6)?' weekend':''}">${w}</div>`).join("");
      calPrev.onclick = ()=>{ currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()-1, 1); renderCalendarDays(); };
      calNext.onclick = ()=>{ currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()+1, 1); renderCalendarDays(); };
      calFilterStatus.onchange = ()=>{ renderCalendarDays(); renderPlanilha(); };
      calFilterCountry.onchange = ()=>{ renderCalendarDays(); };
      calFilterText.oninput = ()=>{ renderCalendarDays(); };
    }

    function postsByDateMap(){
      const map = new Map();
      const filt = (calFilterStatus?.value||"").trim();
      POSTS.forEach(p=>{
        if(filt && p.status !== filt) return;
        const list = map.get(p.dateISO) || [];
        list.push(p); map.set(p.dateISO, list);
      });
      return map;
    }

    function renderCalendarDays(){
      console.log("[Calendar] renderCalendarDays() chamado");
      if(!calDays) return;
      calTitle.textContent = monthLabel(currentMonth);
      const y = currentMonth.getFullYear(), m = currentMonth.getMonth();
      const monthKey = buildMonthKey(y, m+1);
      const todayISO = localDateISO(new Date());
      const firstDay = new Date(y, m, 1);
      const startWeekday = (firstDay.getDay() + 7) % 7; // 0=Sun
      const totalDays = daysInMonth(y,m);
      const prevPad = startWeekday;
      const totalCells = Math.ceil((prevPad + totalDays) / 7) * 7;

      const map = postsByDateMap();
      const demandaMap = new Map();
      if(Array.isArray(DEMANDAS)){
        DEMANDAS.forEach(d=>{
          normalizeDemanda(d);
          const entries = getDemandaCalendarEntries(d);
          entries.forEach(entry=>{
            if(!entry?.dateKey) return;
            const list = demandaMap.get(entry.dateKey) || [];
            list.push(entry);
            demandaMap.set(entry.dateKey, list);
          });
        });
        demandaMap.forEach(list=>{
          list.sort((a,b)=>{
            const diff = getDemandaEntryTime(a) - getDemandaEntryTime(b);
            if(diff !== 0) return diff;
            const nameA = (a?.demanda?.demanda || '').toLowerCase();
            const nameB = (b?.demanda?.demanda || '').toLowerCase();
            return nameA.localeCompare(nameB);
          });
        });
      }
      const esc = s => s.replace(/[&<>]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
      const cells = [];
      const country = (calFilterCountry?.value||"").trim();
      const textFilter = (calFilterText?.value||"").trim().toLowerCase();
      for(let i=0;i<totalCells;i++){
        const dayNum = i - prevPad + 1;
        const inMonth = dayNum>=1 && dayNum<=totalDays;
        const weekday = i % 7;
        const isWeekend = weekday === 0 || weekday === 6;
        const date = inMonth ? new Date(y,m,dayNum) : null;
        const iso = inMonth ? localDateISO(date) : "";
        const isToday = iso === todayISO;
        const items = inMonth ? (map.get(iso) || []) : [];
        const demandas = inMonth ? (demandaMap.get(iso) || []) : [];
        let holidays = [];
        if(inMonth && country){
          if(country === 'BR') holidays = COMMEMORATIVE_DATES_BR[iso] || [];
          else if(country === 'US') holidays = COMMEMORATIVE_DATES_US[iso] || [];
          if(textFilter) holidays = holidays.filter(h=>h.toLowerCase().includes(textFilter));
        }
        const cellClasses = ['cal-cell'];
        if(isWeekend) cellClasses.push('weekend');
        if(inMonth){
          if(isToday) cellClasses.push('today');
        }else{
          cellClasses.push('out');
        }
        const holidayHtml = holidays.map(h=>`<div>${esc(h)}</div>`).join("");
        const thumbs = items.map(post => {
          let cls = "cal-thumb";
          if(post.status === "aprovado"){
            cls += post.approvedBy === 'interno' ? " aprovado-interno" : " aprovado";
          }else if(post.status === "revisar"){
            cls += " revisar";
          }
          const first = (post.thumbUrl || post.mediaUrls?.[0] || "");
          const ext = first.split("?")[0].split(".").pop().toLowerCase();
          const isVideo = ["mp4","mov","webm","m4v","avi"].includes(ext);
          const label = post.type==="carousel" ? "C" : (isVideo ? "V" : "");
          if(first){
            if(isVideo){
              // Se j√° tem thumbUrl personalizada (capa), usa ela
              if(post.thumbUrl && !post.thumbUrl.includes('.mp4') && !post.thumbUrl.includes('.mov') && !post.thumbUrl.includes('.webm')) {
                return `<div class="${cls}" data-id="${post.id}" title="${(post.desc||'').replace(/"/g,'&quot;')}"><img src="${post.thumbUrl}" alt="" crossorigin="anonymous"></div>`;
              }
              // Sen√£o, renderiza com data-video-url para gerar thumbnail autom√°tica
              return `<div class="${cls}" data-id="${post.id}" data-video-url="${first}" title="${(post.desc||'').replace(/"/g,'&quot;')}"><span>${label||"V"}</span></div>`;
            }else{
              return `<div class="${cls}" data-id="${post.id}" title="${(post.desc||'').replace(/"/g,'&quot;')}"><img src="${first}" alt="" crossorigin="anonymous"></div>`;
            }
          }else{
            return `<div class="${cls}" data-id="${post.id}" title="${(post.desc||'').replace(/"/g,'&quot;')}"><span>${label||"+"}</span></div>`;
          }
        }).join("");

        const demandasHtml = inMonth ? renderCalendarDemandaItems(demandas, esc, textFilter) : '';
        const note = inMonth ? esc(CAL_NOTES[iso] || '') : '';
        cells.push(`
          <div class="${cellClasses.join(' ')}" data-iso="${iso}">
            ${inMonth?`<div class="daynum">${dayNum}</div>`:''}
            ${holidayHtml?`<div class="cal-holidays">${holidayHtml}</div>`:''}
            <div class="cal-items">${thumbs}</div>
            ${demandasHtml}
            ${inMonth?`<textarea class="cal-note">${note}</textarea>`:''}
          </div>`);
      }
      calDays.innerHTML = cells.join("");
      renderCalendarMobileDemandas(demandaMap, esc, textFilter, monthKey);
      calDays.querySelectorAll('.cal-note').forEach(el=>{
        const iso = el.closest('.cal-cell')?.getAttribute('data-iso');
        el.value = CAL_NOTES[iso] || '';
        const h = ()=> saveCalNote(el);
        el.addEventListener('change', h);
        el.addEventListener('blur', h);
      });

      // Bind clicks
      calDays.querySelectorAll(".cal-thumb").forEach(el=>{
        el.addEventListener("click",()=>{
          const id = el.getAttribute("data-id");
          const post = POSTS.find(p=>p.id===id);
          if(post) openPostModal(post);
        });
      });

      // Gera thumbnails autom√°ticas para v√≠deos
      console.log('[Calendar] Agendando applyVideoThumbnails em 100ms');
      setTimeout(() => {
        console.log('[Calendar] Executando applyVideoThumbnails agora');
        applyVideoThumbnails();
      }, 100);
    }

    function renderPlanilha(){
      if(!feedGrid && !storiesGrid) return;
      let items = [...POSTS];
      const filt = (calFilterStatus?.value||"").trim();
      if(filt){ items = items.filter(p=>p.status===filt); }
      items.sort((a,b)=> (a.dateISO<b.dateISO?1:a.dateISO>b.dateISO?-1: (b.updatedAt||0)-(a.updatedAt||0)));

      const feedItems = items.filter(p=> (p.target||"feed") !== "stories");
      if(feedGrid){
        feedGrid.innerHTML = feedItems.map(p=>{
          const first = p.thumbUrl || p.mediaUrls?.[0] || "";
          const ext = first.split("?")[0].split(".").pop().toLowerCase();
          const isVideo = ["mp4","mov","webm","m4v","avi"].includes(ext);
          const label = p.type==="carousel" ? "C" : (isVideo ? "V" : "");
          const showCoverBtn = (p.type === 'video');
          const coverBtn = showCoverBtn ? `<button class="cover-upload-btn" type="button" data-id="${p.id}">üì∑ Capa</button>` : "";
          let cls = "feed-item";
          if(p.status === "aprovado"){
            cls += p.approvedBy === 'interno' ? " aprovado-interno" : " aprovado";
          }else if(p.status === "revisar"){
            cls += " revisar";
          }else{
            cls += " pendente";
          }
          if(first){
            if(isVideo){
              // Se j√° tem thumbUrl personalizada (capa), usa ela
              if(p.thumbUrl && !p.thumbUrl.includes('.mp4') && !p.thumbUrl.includes('.mov') && !p.thumbUrl.includes('.webm')) {
                return `<div class="${cls}" data-id="${p.id}">${coverBtn}<img src="${p.thumbUrl}" alt="" crossorigin="anonymous"></div>`;
              }
              // Sen√£o, renderiza com data-video-url para gerar thumbnail autom√°tica
              return `<div class="${cls}" data-id="${p.id}" data-video-url="${first}">${coverBtn}<span>${label||"V"}</span></div>`;
            }else{
              return `<div class="${cls}" data-id="${p.id}">${coverBtn}<img src="${first}" alt="" crossorigin="anonymous"></div>`;
            }
          }else{
            return `<div class="${cls}" data-id="${p.id}">${coverBtn}<span>${label||"+"}</span></div>`;
          }
        }).join("");
        feedGrid.querySelectorAll(".feed-item").forEach(el=>{
          el.addEventListener("click",()=>{
            const id = el.getAttribute("data-id");
            const post = POSTS.find(p=>p.id===id);
            if(post) openPostModal(post);
          });
        });
        feedGrid.querySelectorAll('.cover-upload-btn').forEach(btn=>{
          if(btn.dataset.coverBound === '1') return;
          btn.dataset.coverBound = '1';
          btn.addEventListener('click', ev=>{
            ev.stopPropagation();
            const id = btn.getAttribute('data-id');
            if(id) promptCoverUpload(id);
          });
        });
      }

      if(storiesGrid){
        const storyItems = items.filter(p=> (p.target||"feed") === "stories");
        storiesGrid.innerHTML = storyItems.map(p=>{
          const first = p.thumbUrl || p.mediaUrls?.[0] || "";
          const ext = first.split("?")[0].split(".").pop().toLowerCase();
          const isVideo = ["mp4","mov","webm","m4v","avi"].includes(ext);
          const label = p.type==="carousel" ? "C" : (isVideo ? "V" : "");
          const showCoverBtn = (p.type === 'video');
          const coverBtn = showCoverBtn ? `<button class="cover-upload-btn" type="button" data-id="${p.id}">üì∑ Capa</button>` : "";
          let cls = "story-item";
          if(p.status === "aprovado"){
            cls += p.approvedBy === 'interno' ? " aprovado-interno" : " aprovado";
          }else if(p.status === "revisar"){
            cls += " revisar";
          }else{
            cls += " pendente";
          }
          const [y,m,d] = (p.dateISO||'').split('-');
          const dateLabel = d && m ? `${d}/${m}` : '';
          if(first){
            if(isVideo){
              // Se j√° tem thumbUrl personalizada (capa), usa ela
              if(p.thumbUrl && !p.thumbUrl.includes('.mp4') && !p.thumbUrl.includes('.mov') && !p.thumbUrl.includes('.webm')) {
                return `<div class="${cls}" data-id="${p.id}">${coverBtn}<img src="${p.thumbUrl}" alt="" crossorigin="anonymous"><div class="story-date">${dateLabel}</div></div>`;
              }
              // Sen√£o, renderiza com data-video-url para gerar thumbnail autom√°tica
              return `<div class="${cls}" data-id="${p.id}" data-video-url="${first}">${coverBtn}<span>${label||"V"}</span><div class="story-date">${dateLabel}</div></div>`;
            }else{
              return `<div class="${cls}" data-id="${p.id}">${coverBtn}<img src="${first}" alt="" crossorigin="anonymous"><div class="story-date">${dateLabel}</div></div>`;
            }
          }else{
            return `<div class="${cls}" data-id="${p.id}">${coverBtn}<span>${label||"+"}</span><div class="story-date">${dateLabel}</div></div>`;
          }
        }).join("");
        storiesGrid.querySelectorAll(".story-item").forEach(el=>{
          el.addEventListener("click",()=>{
            const id = el.getAttribute("data-id");
            const post = POSTS.find(p=>p.id===id);
            if(post) openPostModal(post);
          });
        });
        storiesGrid.querySelectorAll('.cover-upload-btn').forEach(btn=>{
          if(btn.dataset.coverBound === '1') return;
          btn.dataset.coverBound = '1';
          btn.addEventListener('click', ev=>{
            ev.stopPropagation();
            const id = btn.getAttribute('data-id');
            if(id) promptCoverUpload(id);
          });
        });

      // Gera thumbnails autom√°ticas para v√≠deos no feed e stories
      setTimeout(() => applyVideoThumbnails(), 150);
      }
    }

    async function saveCalNote(el){
      const iso = el.closest('.cal-cell')?.getAttribute('data-iso');
      const uid = auth.currentUser?.uid;
      if(!iso || !uid) return;
      const clientKey = (typeof window.TENANT === 'string' && window.TENANT)
        || document.body.getAttribute('data-client-id');
      if (!clientKey || clientKey === 'no-client') {
        console.warn('Cliente n√£o definido na URL.');
        return;
      }
      const note = el.value.trim();
      const ref = doc(db, 'usuarios', uid, 'clients', clientKey, 'calendarNotes', iso);
      try{
        if(note){
          await setDoc(ref, { note, updatedAt: Date.now() }, { merge:true });
        }else{
          await deleteDoc(ref);
        }
      }catch(err){ console.error('saveCalNote', err); }
    }

    function subscribeCalNotes(){
      const uid = auth.currentUser?.uid;
      if(!uid) return;
      const clientKey = (typeof window.TENANT === 'string' && window.TENANT)
        || document.body.getAttribute('data-client-id');
      if (!clientKey || clientKey === 'no-client') {
        console.warn('Cliente n√£o definido na URL.');
        return;
      }
      try{ calNotesUnsub && calNotesUnsub(); }catch(_){ }
      const col = collection(db, 'usuarios', uid, 'clients', clientKey, 'calendarNotes');
      calNotesUnsub = onSnapshot(col, snap=>{
        CAL_NOTES = {};
        snap.forEach(docSnap=>{
          const d = docSnap.data() || {};
          if(d.note) CAL_NOTES[docSnap.id] = d.note;
        });
        renderCalendarDays();
        refreshStorageUsage();
      }, err=> console.error('onSnapshot calNotes', err));
    }

    function subscribePosts(){
      const uid = auth.currentUser?.uid; if(!uid) return;
      try{ postsUnsub && postsUnsub(); }catch(_){}
      const col = collection(db, "usuarios", uid, "posts");
      const qy = query(col, orderBy("dateISO","asc")); // sem √≠ndice composto
      postsUnsub = onSnapshot(qy, snap=>{
        POSTS = [];
        snap.forEach(docSnap => {
          const d = docSnap.data() || {};
          POSTS.push({
            id: docSnap.id,
            dateISO: d.dateISO||"",
            desc: d.desc||"",
            mediaUrls: d.mediaUrls||[],
            thumbUrl: d.thumbUrl||"",
            type: d.type||"",
            status: d.status||"pendente",
            target: d.target||"feed",
            reviewNotes: d.reviewNotes||[],
            approvedSlides: d.approvedSlides||[],
            internalApprovedSlides: d.internalApprovedSlides||[],
            approvedBy: d.approvedBy||"",
            createdAt: d.createdAt?.toMillis?.()||0,
            updatedAt: d.updatedAt?.toMillis?.()||0,
            mediaMeta: Array.isArray(d.mediaMeta) ? d.mediaMeta : [],
            coverMeta: d.coverMeta && typeof d.coverMeta === 'object' ? d.coverMeta : null,
            tenant: d.tenant || '',
            googleEventId: d.googleEventId || ''
          });
        });
        renderCalendarDays();
        renderPlanilha();
        refreshStorageUsage();
        try{ refreshMacroInsights(); }catch(_){ }
        if(window.googleCalendarIntegration){
          window.googleCalendarIntegration.notifyPostsLoaded(POSTS);
        }
      }, err=> console.error("onSnapshot posts", err));
    }

    async function handleUpload(){
      const btn = calUpload;
      try{
        const uid = auth.currentUser?.uid; if(!uid) return alert("Fa√ßa login.");
        const dateISO = (calDate.value||"").trim() || localDateISO(new Date());
        const desc = (calDesc.value||"").trim();
        const target = (calTarget.value||"feed");
        const files = calFiles.files;
        if(!files || files.length===0) return alert("Selecione ao menos 1 m√≠dia.");

        // whitelist de formatos
        const okExt = ["jpg","jpeg","png","mp4","mov"];
        for(let i=0;i<files.length;i++){
          const f = files[i];
          const ext = (f.name.split(".").pop()||"").toLowerCase();
          const mime = (f.type||"").toLowerCase();
          const isImage = mime.startsWith("image/");
          const isVideo = mime.startsWith("video/");
          if(!okExt.includes(ext) || (!isImage && !isVideo)){
            return alert("Formato n√£o suportado. Use JPG, JPEG, PNG, MP4 ou MOV.");
          }
        }

        if(!db) return alert("Banco de dados n√£o inicializado.");
        if(!STORAGE){ try{ STORAGE = getStorage(app); }catch(e){ console.error(e); return alert("Storage n√£o inicializado."); } }

        btn && (btn.disabled=true, btn.textContent="Enviando...");
        const safeTenant = (typeof TENANT!=="undefined" && TENANT) ? TENANT : null;
        if (!safeTenant || safeTenant === 'no-client') {
          console.warn('Cliente n√£o definido na URL.');
          btn && (btn.disabled=false, btn.textContent='Enviar');
          return;
        }
        const col = collection(db, "usuarios", uid, "posts");
        const newRef = await addDoc(col, { dateISO, desc, mediaUrls: [], thumbUrl: "", type: files.length>1 ? "carousel" : guessType(files[0]?.name||""), status: "pendente", target, createdAt: serverTimestamp(), updatedAt: serverTimestamp(), tenant: safeTenant });

        const urls = [];
        const mediaMeta = [];
        let thumb = "";
        for(let i=0;i<files.length;i++){
          const f = files[i];
          const safe = (f.name||'file').replace(/[^a-zA-Z0-9._-]/g,'_');
          const path = `users/${uid}/tenant-${safeTenant}/posts/${newRef.id}/${Date.now()}_${safe}`;
          const r = sRef(STORAGE, path);
          await uploadBytes(r, f);
          const url = await getDownloadURL(r);
          urls.push(url);
          const sizeValue = Number(f?.size);
          mediaMeta.push({
            path,
            size: Number.isFinite(sizeValue) && sizeValue > 0 ? sizeValue : null,
            contentType: f?.type || ''
          });
          if(!thumb) thumb = url;
        }
        await updateDoc(newRef, { mediaUrls: urls, thumbUrl: thumb, mediaMeta, updatedAt: serverTimestamp() });
        if(window.googleCalendarIntegration){
          const newPost = {
            id: newRef.id,
            dateISO,
            desc,
            target,
            status: 'pendente',
            googleEventId: '',
            tenant: safeTenant
          };
          try{ await window.googleCalendarIntegration.handlePostCreated(newPost); }
          catch(err){ console.warn('googleCalendarIntegration.handlePostCreated', err); }
        }
        sendWebhook('calendar', { action:'upload', id: newRef.id, dateISO, desc, target, mediaUrls: urls, thumbUrl: thumb });
        calFiles.value=""; calDesc.value=""; if(calTarget) calTarget.value="feed";
        alert("Post cadastrado!");
        await refreshStorageUsage();
      }catch(e){
        console.error("upload error", e);
        const msg = (e && (e.message||e.code)) ? (e.message||e.code) : String(e);
        alert("Falha no upload: "+ msg);
      }finally{
        btn && (btn.disabled=false, btn.textContent="Enviar");
      }
    }
    function guessType(name){
      const ext = (name.split(".").pop()||"").toLowerCase();
      if(["mp4","mov","webm","m4v","avi"].includes(ext)) return "video";
      return "image";
    }

    function openPostModal(post){
      selectedPost = post;
      SLIDES = Array.isArray(post.mediaUrls) && post.mediaUrls.length ? post.mediaUrls.slice() : [post.thumbUrl || (post.mediaUrls?.[0]||"")];
      SLIDE_IDX = 0;
      APPROVED_CLIENT_SET = new Set(Array.isArray(post.approvedSlides)? post.approvedSlides : []);
      APPROVED_INTERNAL_SET = new Set(Array.isArray(post.internalApprovedSlides)? post.internalApprovedSlides : []);
      REVIEWED_SET = new Set(Array.isArray(post.reviewedSlides)? post.reviewedSlides : (Array.isArray(post.reviewNotes)? post.reviewNotes.map(n=> Number.isInteger(n.slide)? n.slide : null).filter(n=> Number.isInteger(n)) : []));
      selectedPost.approvedSlides = Array.from(APPROVED_CLIENT_SET);
      selectedPost.internalApprovedSlides = Array.from(APPROVED_INTERNAL_SET);

      modalTitle.textContent = post.desc ? (post.desc.slice(0,60)+(post.desc.length>60?"‚Ä¶":"")) : "Post";
      modalDate.textContent = post.dateISO || "";
      modalDesc.value = post.desc || "";
      if(modalTarget) modalTarget.value = post.target || "feed";
      if(modalTarget) modalTarget.value = post.target || "feed";
      setModalStatus(post.status||"pendente");

      function renderSlide(){
        const url = SLIDES[SLIDE_IDX] || "";
        const ext = (url.split("?")[0].split(".").pop()||"").toLowerCase();
        const isVideo = ["mp4","mov","webm","m4v","avi"].includes(ext);
        const hasMany = SLIDES.length > 1;
        let arrows = hasMany ? `<div class="pv-arrow left" id="pvLeft">‚Äπ</div><div class="pv-arrow right" id="pvRight">‚Ä∫</div>` : "";
        const approvals = [];
        if(APPROVED_CLIENT_SET.has(SLIDE_IDX)) approvals.push('cliente');
        if(APPROVED_INTERNAL_SET.has(SLIDE_IDX)) approvals.push('time interno');
        const approvalInfo = approvals.length ? `‚úîÔ∏è aprovado (${approvals.join(' + ')})` : '';
        modalPreview.innerHTML = `<div class="pv-stage"><div class="pv-media">${isVideo?`<video src="${url}" controls playsinline crossorigin="anonymous"></video>`:`<img src="${url}" alt="" crossorigin="anonymous">`}</div>${arrows}</div><div class=\"muted\" style=\"margin-top:6px;display:flex;justify-content:space-between\"><span>Item ${SLIDE_IDX+1}/${SLIDES.length}</span><span>${approvalInfo}</span></div>`;
        modalPreview.classList.toggle('pv-has-many', hasMany);
        // render historic only on first slide
        const cn = document.getElementById('clientNotesList');
        if(cn){ if(SLIDE_IDX===0){ cn.style.display='block'; renderClientNotesInCard(selectedPost); } else { cn.style.display='none'; } }
        // bind arrows
        const L = document.getElementById("pvLeft"), R = document.getElementById("pvRight");
        if(L) L.onclick = ()=>{ SLIDE_IDX = (SLIDE_IDX>0? SLIDE_IDX-1 : 0); renderSlide(); syncApproveButtons(); };
        if(R) R.onclick = ()=>{ SLIDE_IDX = (SLIDE_IDX<SLIDES.length-1? SLIDE_IDX+1 : SLIDE_IDX); renderSlide(); syncApproveButtons(); };
        syncApproveButtons();
      }

      function syncApproveButtons(){
        const total = SLIDES.length;
        if(btnApprove){
          const aprovados = APPROVED_CLIENT_SET.size;
          if(APPROVED_CLIENT_SET.has(SLIDE_IDX)){
            btnApprove.textContent = `Cliente aprovou (${aprovados}/${total})`;
            btnApprove.disabled = true;
          }else{
            const nextCount = aprovados + 1;
            const lastPending = (nextCount===total);
            btnApprove.textContent = lastPending? `Cliente aprovar e finalizar (${nextCount}/${total})` : `Cliente aprovar (${nextCount}/${total})`;
            btnApprove.disabled = false;
          }
        }
        if(btnApproveInternal){
          const aprovadosInternos = APPROVED_INTERNAL_SET.size;
          const internalComplete = ((aprovadosInternos >= total) && total>0) || selectedPost?.approvedBy === 'interno';
          if(APPROVED_INTERNAL_SET.has(SLIDE_IDX)){
            btnApproveInternal.textContent = `Time interno aprovou (${aprovadosInternos}/${total})`;
            btnApproveInternal.disabled = true;
          }else{
            const nextInternal = aprovadosInternos + 1;
            const lastInternal = (nextInternal===total);
            btnApproveInternal.textContent = lastInternal? `Aprova√ß√£o interna e finalizar (${nextInternal}/${total})` : `Aprova√ß√£o interna (${nextInternal}/${total})`;
            btnApproveInternal.disabled = false;
          }
          btnApproveInternal.classList.toggle('btn-interno-concluido', internalComplete);
        }
      }

      // exp√µe helpers dentro do escopo
      openPostModal._renderSlide = renderSlide;
      openPostModal._syncApproveButtons = syncApproveButtons;

      renderSlide();
      postModal.classList.add("show"); postModal.setAttribute("aria-hidden","false");
      renderReviewNotes(post);
      renderClientNotesPanel(post);
    }
    function closePostModal(){ postModal.classList.remove("show"); postModal.setAttribute("aria-hidden","true"); selectedPost=null; }
    modalClose.onclick = closePostModal;
    postModal.addEventListener("click",(e)=>{ if(e.target===postModal) closePostModal(); });

    function setModalStatus(s){
      modalStatus.textContent = s;
      const approvedBy = selectedPost?.approvedBy || "";
      const statusClass = s === "aprovado"
        ? (approvedBy === "interno" ? "status-aprovado-interno" : "status-aprovado")
        : (s === "revisar" ? "status-revisar" : "status-pendente");
      modalStatus.className = "status-pill " + statusClass;
    }

    async function updatePostStatus(post, status){
      try{
        const uid = auth.currentUser?.uid; if(!uid) return;
        const ref = doc(db, "usuarios", uid, "posts", post.id);
        await updateDoc(ref, { status, updatedAt: serverTimestamp() });
        if(status === 'aprovado' || status === 'revisar'){
          const payload = { action:'status', id: post.id, status };
          if(status === 'revisar'){
            payload.dateISO = post.dateISO || '';
            payload.postName = post.desc || '';
            payload.postDesc = post.desc || '';
            payload.reviewNotes = Array.isArray(post.reviewNotes) ? post.reviewNotes.map(n => n.text) : [];
          }
          sendWebhook('calendar', payload);
        }
        post.status = status;
        if(selectedPost && selectedPost.id===post.id){ setModalStatus(status); }
        if(window.googleCalendarIntegration){
          try{ await window.googleCalendarIntegration.handlePostUpdated(post); }
          catch(err){ console.warn('googleCalendarIntegration.handlePostUpdated', err); }
        }
      }catch(e){ console.error(e); alert("Falha ao atualizar status: "+(e.message||String(e))); }
    }
    async function savePostMeta(post, desc, target){
      try{
        const uid = auth.currentUser?.uid; if(!uid) return;
        const ref = doc(db, "usuarios", uid, "posts", post.id);
        await updateDoc(ref, { desc: desc||"", target: target||"feed", updatedAt: serverTimestamp() });
        post.desc = desc||"";
        post.target = target||"feed";
        if(window.googleCalendarIntegration){
          try{ await window.googleCalendarIntegration.handlePostUpdated(post); }
          catch(err){ console.warn('googleCalendarIntegration.handlePostUpdated', err); }
        }
      }catch(e){ console.error(e); alert("Falha ao salvar: "+(e.message||String(e))); }
    }
    async function deletePost(post){
      if(!confirm("Excluir este post?")) return;
      try{
        const uid = auth.currentUser?.uid; if(!uid) return;
        const ref = doc(db, "usuarios", uid, "posts", post.id);
        if(window.googleCalendarIntegration){
          try{ await window.googleCalendarIntegration.handlePostDeleted(post); }
          catch(err){ console.warn('googleCalendarIntegration.handlePostDeleted', err); }
        }
        await deleteDoc(ref);
        if(selectedPost?.id===post.id) closePostModal();
      }catch(e){ console.error(e); alert("Falha ao excluir: "+(e.message||String(e))); }
    }

    async function approveSlide(kind){
      if(!selectedPost) return;
      try{
        const uid = auth.currentUser?.uid; if(!uid) return;
        const ref = doc(db, "usuarios", uid, "posts", selectedPost.id);
        const payload = { updatedAt: serverTimestamp() };
        const isInternal = kind === 'interno';
        if(isInternal){
          payload.internalApprovedSlides = arrayUnion(SLIDE_IDX);
        }else{
          payload.approvedSlides = arrayUnion(SLIDE_IDX);
        }
        await updateDoc(ref, payload);

        const targetSet = isInternal ? APPROVED_INTERNAL_SET : APPROVED_CLIENT_SET;
        targetSet.add(SLIDE_IDX);
        if(isInternal){
          selectedPost.internalApprovedSlides = Array.from(targetSet);
        }else{
          selectedPost.approvedSlides = Array.from(targetSet);
        }

        const totalSlides = SLIDES.length;
        const fullyApproved = (APPROVED_CLIENT_SET.size >= totalSlides) || (APPROVED_INTERNAL_SET.size >= totalSlides);
        if(fullyApproved){
          await updateDoc(ref, { status: "aprovado", updatedAt: serverTimestamp(), approvedBy: isInternal ? 'interno' : 'cliente' });
          selectedPost.status = "aprovado";
          selectedPost.approvedBy = isInternal ? 'interno' : 'cliente';
          sendWebhook('calendar', { action:'status', id: selectedPost.id, status: 'aprovado', approvedBy: isInternal ? 'interno' : 'cliente' });
          setModalStatus("aprovado");
          if(window.googleCalendarIntegration){
            try{ await window.googleCalendarIntegration.handlePostUpdated(selectedPost); }
            catch(err){ console.warn('googleCalendarIntegration.handlePostUpdated', err); }
          }
          if(typeof mgToast === 'function'){
            mgToast(isInternal ? 'Post aprovado pelo time interno.' : 'Post aprovado pelo cliente.');
          }
        }else{
          let next = SLIDE_IDX;
          for(let i=0;i<SLIDES.length;i++){
            const j = (SLIDE_IDX + 1 + i) % SLIDES.length;
            if(!targetSet.has(j)){ next = j; break; }
          }
          SLIDE_IDX = next;
        }
        if(typeof openPostModal._renderSlide === "function"){ openPostModal._renderSlide(); }
        if(typeof openPostModal._syncApproveButtons === "function"){ openPostModal._syncApproveButtons(); }
      }catch(e){
        console.error(e);
        alert("Falha ao aprovar: " + (e.message||String(e)));
      }
    }
    if(btnApprove) btnApprove.onclick = ()=> approveSlide('cliente');
    if(btnApproveInternal) btnApproveInternal.onclick = ()=> approveSlide('interno');
    if(btnReview)  btnReview.onclick  = ()=>{ if(selectedPost) openReviewPrompt(selectedPost); };
    if(btnCopyApprovalLink) btnCopyApprovalLink.onclick = ()=>{ copyApprovalLinkForPost(); };
    if(btnSave)    btnSave.onclick    = ()=>{ if(selectedPost) savePostMeta(selectedPost, modalDesc.value||"", modalTarget.value||"feed"); };
    if(btnDelete)  btnDelete.onclick  = ()=>{ if(selectedPost) deletePost(selectedPost); };

    if(calUpload) calUpload.onclick = handleUpload;
    if(btnShareCalendar) btnShareCalendar.onclick = ()=> generateCalendarShare();
    if(btnCopyPlanningLink) btnCopyPlanningLink.onclick = ()=> generatePlanningShare();
    if(btnCopyPlanningLink) btnCopyPlanningLink.onclick = ()=> generatePlanningShare();


    /* ======= Revis√£o: observa√ß√µes do cliente ======= */
    const reviewModal = $("reviewModal"), reviewText = $("reviewText"), reviewSend = $("reviewSend"), reviewCancel = $("reviewCancel");
    function fmtDateTime(d){
      try{
        const pad=n=>String(n).padStart(2,"0");
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }catch(_){ return ""; }
    }
    function renderClientNotesPanel(post){
      const panel = document.getElementById("clientNotesPanel");
      if(!panel) return;
      const notes = Array.isArray(post.reviewNotes)? post.reviewNotes : [];
      if(notes.length===0){
        panel.innerHTML = `<div class="muted">Sem observa√ß√µes.</div>`;
        return;
      }
      panel.innerHTML = notes.map(n=>{
        const when = n.at ? (typeof n.at==='number'? n.at : (n.at.toMillis? n.at.toMillis() : Date.parse(n.at)||Date.now())) : Date.now();
        const dt = new Date(when);
        const pad = x => String(x).padStart(2,'0');
        const dstr = `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())} ${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
        const who = (n.by||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const text = renderMarkdownText(n.text||'');
        const slide = Number.isInteger(n.slide)? ` ‚Ä¢ Slide ${n.slide+1}` : '';
        return `<div class="note-item"><div class="note-head"><span>${who||"cliente"}</span><span>‚Ä¢</span><span>${dstr}${slide}</span></div><div class="note-body markdown-view">${text}</div></div>`;
      }).join("");
    }

    function renderClientNotesInCard(post){
  const box = document.getElementById("clientNotesList");
  if(!box) return;
  const notes = Array.isArray(post.reviewNotes)? post.reviewNotes : [];
  if(notes.length===0){ box.innerHTML = `<div class="muted">Sem observa√ß√µes.</div>`; return; }
  const rows = notes.map(n=>{
    const dt = n.at?.toMillis ? new Date(n.at.toMillis()) : (typeof n.at==="number"? new Date(n.at) : (n.at? new Date(n.at): new Date()));
    const pad = x=> String(x).padStart(2,"0");
    const when = `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())} ${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
    const who = (n.by||"").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    const text = renderMarkdownText(n.text||"");
    return `<div class="client-note"><div class="dot"></div><div class="txt markdown-view">${text}<div class="meta">${who||"cliente"} ‚Ä¢ ${when}</div></div></div>`;
  }).join("");
  box.innerHTML = rows;
}

function renderReviewNotes(post){
      const box = $("notesList"); if(!box) return;
      const notes = Array.isArray(post.reviewNotes)? post.reviewNotes : [];
      if(notes.length===0){ box.innerHTML = `<div class="muted">Sem observa√ß√µes.</div>`; return; }
      box.innerHTML = notes.map(n=>{
        const when = n.at?.toMillis ? fmtDateTime(new Date(n.at.toMillis())) : (typeof n.at==="number" ? fmtDateTime(new Date(n.at)) : (n.at ? fmtDateTime(new Date(n.at)):""));
        const who = (n.by||"").replace(/</g,"&lt;").replace(/>/g,"&gt;");
        const origin = resolveReviewOrigin(n);
        const originLabel = origin === 'interno' ? 'Time interno' : 'Cliente';
        const text = renderMarkdownText(n.text||"");
        return `<div class="note-item"><div class="note-head"><span>${who||originLabel.toLowerCase()}</span><span>‚Ä¢</span><span>${when}</span><span class="origin-pill origin-${origin}">${originLabel}</span></div><div class="note-body markdown-view">${text}</div></div>`;
      }).join("");
    }
    function openReviewPrompt(post){
      selectedPost = post;
      if(reviewText) reviewText.value = "";
      if(reviewModal){ reviewModal.classList.add("show"); reviewModal.setAttribute("aria-hidden","false"); setTimeout(()=>reviewText?.focus(), 50); }
    }
    function closeReviewPrompt(){
      if(reviewModal){ reviewModal.classList.remove("show"); reviewModal.setAttribute("aria-hidden","true"); }
    }
    if(reviewCancel) reviewCancel.onclick = closeReviewPrompt;
    async function addReviewNote(post, text){
      const uid = auth.currentUser?.uid; if(!uid) return alert("Fa√ßa login.");
      const email = auth.currentUser?.email || "";
      try{
        const ref = doc(db, "usuarios", uid, "posts", post.id);
        const note = { text, by: email, uid, at: Date.now(), slide: SLIDE_IDX, origin: getCurrentReviewOrigin() };
        await updateDoc(ref, {
          status: "revisar",
          updatedAt: serverTimestamp(),
          reviewNotes: arrayUnion(note),
          lastReviewAt: serverTimestamp()
        });
        // local state
        if(!Array.isArray(post.reviewNotes)) post.reviewNotes=[];
        post.reviewNotes.push(note);
        const before = REVIEWED_SET.size;
        REVIEWED_SET.add(SLIDE_IDX);
        // close only the review modal, keep post modal open and move to next media
        closeReviewPrompt();
        // advance to next slide if exists
        if(typeof SLIDE_IDX === 'number' && Array.isArray(SLIDES)){
          if(SLIDE_IDX < SLIDES.length - 1){
            SLIDE_IDX = SLIDE_IDX + 1;
          }
        }
        // re-render media and (if on first slide) the card notes
        if(typeof openPostModal._renderSlide === "function"){ openPostModal._renderSlide(); }
        renderClientNotesInCard(post); renderReviewNotes(post);
        if(REVIEWED_SET.size === SLIDES.length && before !== SLIDES.length){
          sendWebhook('calendar', {
            action:'status',
            id: post.id,
            status: 'revisar',
            dateISO: post.dateISO || '',
            postName: post.desc || '',
            postDesc: post.desc || '',
            reviewNotes: Array.isArray(post.reviewNotes) ? post.reviewNotes.map(n => n.text) : []
          });
        }
        if(window.googleCalendarIntegration){
          try{ await window.googleCalendarIntegration.handlePostUpdated(post); }
          catch(err){ console.warn('googleCalendarIntegration.handlePostUpdated', err); }
        }
        mgToast('Observa√ß√£o salva. Avance para o pr√≥ximo item do carrossel.');
      }catch(e){ console.error(e); alert("Falha ao enviar observa√ß√£o: "+(e.message||String(e))); }
    }
    if(reviewSend) reviewSend.onclick = ()=>{
      if(!selectedPost) return;
      const text = (reviewText?.value||"").trim();
      if(!text) return alert("Descreva o que precisa ser ajustado.");
      addReviewNote(selectedPost, text);
    };


<style id="calendar-review-css">
/* ======= Observa√ß√µes & Review modal ======= */

/* ===== Ajuste modal revis√£o no mobile ===== */
@media (max-width: 820px){
  #reviewModal .modal-card{
    width: 100% !important;
    height: 70vh !important;
    max-height: 70vh !important;
    margin: auto 0 0 0; /* bottom sheet */
    border-radius: 14px 14px 0 0;
    display: flex;
    flex-direction: column;
  }
  #reviewModal .modal-body{
    flex: 1 1 auto;
    overflow-y: auto;
    padding: 12px;
  }
  #reviewModal textarea{
    min-height: 100px;
  }
  #reviewModal .modal-foot{
    position: sticky;
    bottom: 0;
    background: #111;
    padding: 12px;
    border-top: 1px solid #333;
  }
  #reviewSend{
    width: 100%;
    font-size: 1rem;
    min-height: 44px;
  }
}

.notes-block{ margin-top:12px; }
.notes-list{ display:flex; flex-direction:column; gap:8px; background:#121212; border:1px solid var(--shell-border,rgba(255,255,255,.14)); border-radius:8px; padding:10px; max-height:220px; overflow:auto; }
.note-item{ background:#0d0d0d; border:1px solid #2a2a2a; border-radius:8px; padding:8px; }
.note-head{ display:flex; gap:8px; font-size:.8rem; color:#bbb; margin-bottom:4px; }
.note-body{ white-space:normal; }
.modal-card.small{ width:min(560px, 96vw); }

/* ===== MOBILE MODAL OPTIMIZA√á√ïES (fullscreen + v√≠deo responsivo) ===== */
@media (max-width: 820px){
  .modal-card{
    width: 100vw !important;
    max-width: 100vw !important;
    height: 100vh !important;
    max-height: 100vh !important;
    border-radius: 0 !important;
    display: flex;
    flex-direction: column;
  }
  .modal-head{
    position: sticky;
    top: 0;
    z-index: 2;
    background: rgba(0,0,0,.8);
    backdrop-filter: blur(6px);
  }
  .modal-body{
    flex: 1 1 auto;
    overflow: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 12px;
    grid-template-columns: 1fr !important;
  }
  .modal-foot{
    position: sticky;
    bottom: 0;
    z-index: 2;
    background: rgba(0,0,0,.85);
    backdrop-filter: blur(6px);
    padding-bottom: calc(env(safe-area-inset-bottom,0) + 10px) !important;
  }
  .modal-body .preview{
    min-height: 0 !important;
    height: auto !important;
    padding: 0 !important;
    border: 0 !important;
    background: #000;
  }
  .modal-body .preview video,
  .modal-body .preview img{
    width: 100% !important;
    height: auto !important;
    max-height: 56vh !important;
    object-fit: contain !important;
    display: block !important;
  }
  .modal-foot .btn{
    flex: 1 1 auto;
    min-height: 44px;
  }
  .modal-foot{
    display: grid !important;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }
  #btnDelete{ grid-column: span 2; }
}
/* When any modal opens, lock underlying scroll to avoid "zoom" issues */
.modal.show ~ *,
.modal.show body{ overscroll-behavior: contain; }

/* ===== POPUP MOBILE: sair f√°cil, bot√µes n√£o colam nas bordas, sem "mexer" laterais ===== */
@media (max-width: 820px){
  html, body{ overflow-x: hidden; }
  .modal{ padding: 0 !important; }
  .modal-card{
    width: 100% !important;              /* evita 100vw causar "vai-e-volta" lateral */
    height: 100dvh !important;           /* usa altura din√¢mica da viewport (iOS/Android) */
    max-height: 100dvh !important;
    border-radius: 0 !important;
    display: flex; flex-direction: column;
  }
  .modal-head{
    position: sticky; top: 0; z-index: 3;
    background: rgba(0,0,0,.9);
    backdrop-filter: blur(6px);
    padding-top: calc(env(safe-area-inset-top,0) + 8px) !important;
  }
  .modal-head .btn{ min-height: 40px; }
  .modal-body{
    flex: 1 1 auto; overflow: auto; -webkit-overflow-scrolling: touch;
    padding: 12px 14px 12px 14px;
    grid-template-columns: 1fr !important;
  }
  .modal-foot{
    position: sticky; bottom: 0; z-index: 3;
    background: rgba(0,0,0,.9);
    backdrop-filter: blur(6px);
    padding: 10px 12px calc(env(safe-area-inset-bottom,0) + 12px) 12px !important;
    box-shadow: 0 -6px 24px rgba(0,0,0,.5);
    display: grid !important; grid-template-columns: 1fr 1fr; gap: 10px;
  }
  .modal-foot .btn{ min-height: 48px; }
  #btnDelete{ grid-column: span 2; }
  /* Preview responsivo e sem saltos */
  .modal-body .preview{ background:#000; padding:0 !important; border:0 !important; }
  .modal-body .preview video, .modal-body .preview img{
    width: 100% !important; height: auto !important; max-height: 56vh; object-fit: contain;
  }
  /* Review modal em formato de bottom sheet com "handle" */
  #reviewModal .modal-card{
    height: 78dvh !important; max-height: 78dvh !important;
    border-radius: 16px 16px 0 0 !important;
    margin: auto 0 0 0 !important;
  }
  #reviewModal .modal-head:before{
    content: ""; display:block; width: 44px; height: 4px; border-radius: 999px;
    background: rgba(255,255,255,.25); margin: 6px auto 8px;
  }
  #reviewModal .modal-foot{ grid-template-columns: 1fr; } /* bot√£o largo quando revisando */
  #reviewSend{ width: 100%; }
}
/* Fechar ao tocar fora do cart√£o (backdrop) ‚Äì cursor vis√≠vel */
.modal{ cursor: default; }
.modal.show{ cursor: pointer; }
.modal .modal-card{ cursor: auto; }

/* ===== Reels preview: center, contain, overlays (mobile-friendly) ===== */
.modal-body .preview{
  position: relative;
  background: #000;
  border-radius: 12px;
  overflow: hidden;
}
.modal-body .preview video,
.modal-body .preview img{
  display: block;
  width: 100% !important;
  height: auto !important;
  max-height: 62dvh !important; /* usa viewport din√¢mica */
  object-fit: contain !important; /* n√£o corta o v√≠deo vertical (reels) */
  margin: 0 auto;
  background:#000;
}
/* Play overlay central */
#reelsPlayOverlay{
  position:absolute; left:50%; top:50%;
  transform: translate(-50%, -50%);
  width: 64px; height: 64px;
  border-radius: 50%;
  background: rgba(0,0,0,.55);
  border: 2px solid rgba(255,255,255,.25);
  display: none; /* aparece quando pausado */
  align-items:center; justify-content:center;
  z-index: 4;
}
#reelsPlayOverlay:after{
  content: "";
  border-style: solid;
  border-width: 12px 0 12px 18px;
  border-color: transparent transparent transparent #fff;
  margin-left: 4px;
  display:block;
}
/* Close X overlay no canto superior direito do preview */
#reelsCloseOverlay{
  position: absolute; right: 10px; top: 10px;
  padding: 6px 10px;
  border-radius: 10px;
  background: rgba(0,0,0,.55);
  border: 1px solid rgba(255,255,255,.25);
  color: #fff; font-weight: 800;
  z-index: 4;
  -webkit-tap-highlight-color: transparent;
}
@supports(padding: max(0px)){
  #reelsCloseOverlay{ right: max(10px, env(safe-area-inset-right)); top: max(10px, env(safe-area-inset-top)); }
}
#reelsCloseOverlay:active{ transform: scale(.98); }

/* ===== Fullscreen UX for Reels ===== */
#fsCloseOverlay{
  position: fixed;
  right: max(12px, env(safe-area-inset-right));
  top: max(12px, env(safe-area-inset-top));
  z-index: 999999;
  padding: 8px 12px;
  border-radius: 12px;
  background: rgba(0,0,0,.55);
  border: 1px solid rgba(255,255,255,.25);
  color:#fff;
  font-weight:800;
  display:none;
  -webkit-tap-highlight-color: transparent;
}
#fsCloseOverlay:active{ transform: scale(.98); }

/* ===== Imagens no preview: sem corte (contain), centralizadas, com letterbox ===== */
.modal-body .preview{
  position: relative;
  background:#000;
  border-radius: 12px;
  overflow: hidden;
}
.modal-body .preview img{
  display:block !important;
  width:100% !important;
  height:auto !important;
  max-height:62dvh !important;
  object-fit:contain !important;   /* nunca corta */
  object-position:center center !important;
  background:#000;
  margin:0 auto;
}

/* ===== Lista de observa√ß√µes do cliente no modal ===== */
#clientNotesList{
  margin-top: 8px;
  max-height: 28vh;
  overflow: auto;
  border: 1px solid var(--border, #333);
  border-radius: 10px;
  padding: 10px;
  background: rgba(255,255,255,.03);
}
.client-note{ display:flex; gap:10px; padding:8px 0; border-bottom:1px dashed rgba(255,255,255,.12); }
.client-note:last-child{ border-bottom:0; }
.client-note .dot{ width:8px; height:8px; border-radius:50%; background:#ff6600; margin-top:7px; flex:0 0 8px; }
.client-note .txt{ font-size:.95rem; line-height:1.25rem; }
.client-note .txt.markdown-view{ line-height:1.45; }
.client-note .txt.markdown-view > :last-child{ margin-bottom:0; }
.client-note .meta{ color:var(--muted,#bbb); font-size:.8rem; margin-top:2px; }
</style>
<style>
/* Esconde observa√ß√µes dentro do pop-up do Post (hist√≥rico ficar√° na p√°gina) */
#postModal .notes-block{ display:none !important; }
</style>
<style>
#btnApprove{background:#2e7d32 !important;border-color:#2e7d32 !important;color:#fff;}
#btnApproveInternal{background:#7c4dff !important;border-color:#7c4dff !important;color:#fff;}
#btnApproveInternal:disabled{background:#b39ddb !important;border-color:#b39ddb !important;color:#4527a0 !important;}
#btnApproveInternal.btn-interno-concluido{background:#5e35b1 !important;border-color:#5e35b1 !important;color:#fff !important;}
#btnApprove:hover,#btnApproveInternal:hover{filter:brightness(1.1)}
</style>
<style>
/* === In-modal carousel arrows (reliable) === */
#modalPreview{ position:relative; }
#modalPreview .pv-stage{ position:relative; background:#000; border-radius:12px; overflow:hidden; }
#modalPreview .pv-media{ display:flex; align-items:center; justify-content:center; min-height:220px; }
#modalPreview .pv-media img,
#modalPreview .pv-media video{
  display:block; background:#000;
  max-width:100%; max-height:62vh; width:auto; height:auto; object-fit:contain;
}
#modalPreview .pv-arrow{
  position:absolute; top:50%; transform:translateY(-50%);
  width:42px; height:42px; border-radius:999px;
  display:none; align-items:center; justify-content:center;
  color:#fff; font-weight:900; font-size:22px;
  background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.25);
  cursor:pointer; z-index:10; user-select:none; -webkit-user-select:none;
  -webkit-tap-highlight-color:transparent;
}
#modalPreview.pv-has-many .pv-arrow{ display:flex; }
#modalPreview .pv-arrow.left{ left:10px; } 
#modalPreview .pv-arrow.right{ right:10px; }
@keyframes pvBlink {0%,100%{opacity:.45} 50%{opacity:1}}
#modalPreview.pv-hint .pv-arrow{ animation: pvBlink 1s ease-in-out infinite; }
#modalPreview.pv-hint-end .pv-arrow{ animation: none; }
</style>
<style id="demandas-css">
  .demandas-wrap{margin-left:var(--margin-left);margin-right:var(--margin-right);display:flex;flex-direction:column;gap:8px}
  .demandas-filters{display:flex;flex-wrap:wrap;gap:6px;align-items:flex-start;background:var(--title-bg);border:1px solid var(--shell-border);padding:8px;border-radius:10px}
  .demandas-filters input[type="text"],.demandas-filters select{background:#222;color:#fff;border:1px solid #333;border-radius:8px;padding:6px 8px;flex:1 1 160px;min-width:140px}
  .demanda-month-filter{display:flex;flex-direction:column;gap:6px;flex:1 1 100%;min-width:260px}
  .demanda-year-controls{display:flex;align-items:center;gap:8px;font-weight:800;color:#fff}
  .demanda-year-label{min-width:64px;text-align:center;font-size:.9rem}
  .demanda-year-btn{background:#222;border:1px solid #333;border-radius:6px;color:#fff;padding:4px 8px;font-weight:700;cursor:pointer;transition:background .2s,border-color .2s,color .2s}
  .demanda-year-btn:hover{border-color:var(--accent)}
  .demanda-year-btn:disabled{opacity:.4;cursor:not-allowed}
  .demanda-month-buttons{display:flex;flex-wrap:wrap;gap:6px}
  .demanda-month-button{background:#222;border:1px solid #333;border-radius:999px;color:#fff;padding:6px 10px;font-size:.8rem;font-weight:700;cursor:pointer;transition:background .2s,border-color .2s,color .2s}
  .demanda-month-button:hover{border-color:var(--accent)}
  .demanda-month-button.active{background:var(--accent);color:#000;border-color:var(--accent)}
  .demanda-month-button.has-data{box-shadow:0 0 0 1px rgba(255,255,255,.12) inset}
  .prazo-alert{background:#7f1d1d;color:#fff;padding:6px 8px;border-radius:8px}
  .demandas-wrap,
  .demandas-wrap *{
    color:#fff!important;
    -webkit-text-fill-color:#fff!important;
  }
  .demandas-wrap ::placeholder{color:rgba(255,255,255,.65)!important}
  .demandas-table{width:100%;border-collapse:collapse;table-layout:fixed}
  .demandas-table th,.demandas-table td{border:1px solid var(--shell-border);padding:4px;font-size:.85rem}
  .demandas-table input,.demandas-table select,.demandas-table textarea{width:100%;background:#1a1a1a;color:#fff;border:1px solid #333;border-radius:4px;padding:4px;font-size:.85rem}
  .demandas-table .periodo-field{display:flex;gap:10px;align-items:center;flex-wrap:nowrap}
  .demandas-table .periodo-field input{flex:1 1 150px;min-width:140px}
  .demandas-table .periodo-field .periodo-sep{display:none;font-size:.8rem;color:#bbb;white-space:nowrap}
  .demandas-table .periodo-field .periodo-toggle{flex:0 0 auto;background:#222;border:1px solid #444;color:#fff;border-radius:4px;padding:4px 6px;cursor:pointer;font-size:.75rem;white-space:nowrap;position:relative;z-index:2}
  .demandas-table .periodo-field.range-active .periodo-sep,
  .demandas-table .periodo-field.range-active .periodo-fim{display:block}
  .demandas-table .periodo-field .periodo-fim{display:none;flex:1 1 150px;min-width:140px}
  .demandas-table .filter-row th{background:var(--title-bg);padding:6px}
  .demandas-table .filter-row select,
  .demandas-table .filter-row input{background:#111827;border:1px solid #374151;color:#e5e7eb;border-radius:6px;padding:4px 6px;font-size:.78rem}
  .demandas-table .filter-row input[type="date"]{min-width:0}
  .demandas-table .filter-row .demanda-period-filter{display:flex;align-items:center;gap:8px}
  .demandas-table .filter-row .demanda-period-filter span{font-size:.75rem;color:#9ca3af;white-space:nowrap}
  .demandas-table .filter-row .demanda-period-filter input[type="date"]{min-width:140px}
  .demandas-table .filter-row .demanda-period-filter button{margin-left:6px;position:relative;z-index:2}
  .demandas-table .filter-clear-btn{width:100%;background:#1f2937;border:1px solid #374151;color:#e5e7eb;border-radius:6px;padding:4px 6px;font-size:.75rem;cursor:pointer;transition:background .2s ease,border-color .2s ease}
  .demandas-table .filter-clear-btn:hover{background:#111827;border-color:#4b5563}
  .demandas-table th{background:var(--title-bg)}
  .demandas-table .col-status{width:8%}
  .demandas-table .col-tag{width:14%}
  .demandas-table .col-demanda{width:28%}
  .demandas-table .col-demanda input{min-width:200px}
  .demandas-table .col-resp{width:10%}
  .demandas-table .col-prazo{width:32%}
  .demandas-table .del-cell{width:52px;text-align:center;display:flex;align-items:center;justify-content:center;gap:10px}
  .demandas-table .del-cell button{background:#550000;border:1px solid #880000;color:#fff;border-radius:4px;padding:2px 6px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;margin:0 auto}
  .demanda-plans{margin-top:16px;display:flex;flex-direction:column;gap:16px}
  .demanda-ai-actions{margin-top:18px;display:flex;justify-content:flex-end;align-items:center;gap:12px}
  .demanda-plan-month{border:1px solid var(--shell-border);background:rgba(255,255,255,.04);border-radius:12px;padding:14px}
  .demanda-plan-month-title{margin:0 0 12px;font-size:1rem;font-weight:700;text-transform:capitalize;color:#fff}
  .demanda-plan-month-content{display:flex;flex-direction:column;gap:14px}
  .demanda-plan-month-plans{background:rgba(15,23,42,.55);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:12px}
  .demanda-plan-tabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
  .demanda-plan-tab{background:#1f2937;border:1px solid #374151;color:#fff;border-radius:999px;padding:6px 12px;cursor:pointer;font-size:.8rem;transition:background .2s,border-color .2s}
  .demanda-plan-tab.active{background:#2563eb;border-color:#2563eb}
  .demanda-plan-notes{position:relative}
  .demanda-plan-note{display:none}
  .demanda-plan-note.active{display:block}
  .demanda-plan-note-editor{display:flex;flex-direction:column;gap:8px}
  .demanda-plan-note-editor-area{width:100%;min-height:220px;background:rgba(15,23,42,.78);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:14px 16px;color:#f8fafc;overflow:auto;font-size:.95rem;line-height:1.65;outline:none;transition:border-color .2s,box-shadow .2s,background .2s;word-break:break-word}
  .demanda-plan-note-editor-area:focus{border-color:var(--accent,#7c4dff);box-shadow:0 0 0 2px rgba(124,77,255,.3),0 10px 24px rgba(0,0,0,.35);background:rgba(15,23,42,.88)}
  .demanda-plan-note-editor-area:empty::before{content:attr(data-placeholder);color:rgba(248,250,252,.45);font-weight:500}
  .demanda-plan-note-editor-area.markdown-view{display:block}
  .demanda-plan-note-editor-area.markdown-view > :first-child{margin-top:0}
  .demanda-plan-note-editor-area.markdown-view > :last-child{margin-bottom:0}
  .demanda-plan-note-editor-area.markdown-view h1,.demanda-plan-note-editor-area.markdown-view h2,.demanda-plan-note-editor-area.markdown-view h3,.demanda-plan-note-editor-area.markdown-view h4,.demanda-plan-note-editor-area.markdown-view h5,.demanda-plan-note-editor-area.markdown-view h6{color:#fff;margin:1.4em 0 .65em;font-weight:700;line-height:1.2}
  .demanda-plan-note-editor-area.markdown-view h1{font-size:1.55rem}
  .demanda-plan-note-editor-area.markdown-view h2{font-size:1.35rem}
  .demanda-plan-note-editor-area.markdown-view h3{font-size:1.2rem}
  .demanda-plan-note-editor-area.markdown-view h4{font-size:1.08rem}
  .demanda-plan-note-editor-area.markdown-view ul,.demanda-plan-note-editor-area.markdown-view ol{margin:0 0 .85em 1.4em;padding-left:1.1em}
  .demanda-plan-note-editor-area.markdown-view li{margin:.35em 0}
  .demanda-plan-note-editor-area.markdown-view blockquote{margin:0 0 1em;padding-left:14px;border-left:3px solid rgba(255,255,255,.24);color:rgba(226,232,240,.85)}
  .demanda-plan-note-editor-area.markdown-view code{background:rgba(148,163,184,.18);padding:0 4px;border-radius:4px;font-family:"Fira Code",monospace;font-size:.85em}
  .demanda-plan-note-editor-area.markdown-view pre{margin:0 0 1em;background:#0b1120;border:1px solid rgba(148,163,184,.25);border-radius:10px;padding:12px;overflow:auto;font-family:"Fira Code",monospace;font-size:.85rem}
  .demanda-plan-note-actions{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:4px 0}
  .impedimentos-section{margin-top:18px;display:flex;flex-direction:column;gap:12px;background:rgba(15,23,42,.55);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:16px}
  .impedimentos-head{display:flex;flex-wrap:wrap;gap:10px;align-items:flex-start;justify-content:space-between}
  .impedimentos-head h3{margin:0;font-size:1.05rem;font-weight:800;color:#fff}
  .impedimentos-head p{margin:0;color:rgba(226,232,240,.75);font-size:.82rem;max-width:520px;line-height:1.45}
  .impedimentos-table{width:100%;border-collapse:collapse;border:1px solid var(--shell-border);border-radius:12px;overflow:hidden}
  .impedimentos-table th,.impedimentos-table td{border:1px solid var(--shell-border);padding:8px;font-size:.85rem;background:rgba(15,23,42,.72)}
  .impedimentos-table .icon-col{width:56px}
  .impedimentos-table thead th{background:rgba(15,23,42,.88);text-transform:uppercase;font-size:.72rem;letter-spacing:.04em;font-weight:800;color:rgba(226,232,240,.85)}
  .impedimentos-table .icon-cell{width:56px;text-align:center;background:rgba(127,29,29,.18);vertical-align:middle}
  .impedimentos-table .icon-cell span{display:inline-flex;align-items:center;justify-content:center;font-size:1.35rem;color:#f87171;text-shadow:0 0 8px rgba(248,113,113,.45)}
  .impedimentos-table textarea{width:100%;min-height:64px;resize:vertical;background:rgba(15,23,42,.85);border:1px solid rgba(148,163,184,.35);border-radius:10px;padding:8px 10px;color:#fff;font-size:.85rem;line-height:1.4}
  .impedimentos-table textarea:focus{outline:none;border-color:rgba(248,113,113,.6);box-shadow:0 0 0 2px rgba(248,113,113,.18)}
  .impedimentos-status-wrap{display:flex;align-items:center;gap:8px;justify-content:flex-end}
  .impedimentos-table select{background:rgba(15,23,42,.85);border:1px solid rgba(148,163,184,.35);border-radius:8px;color:#fff;padding:6px 10px;font-size:.82rem;min-width:180px}
  .impedimentos-remove{background:rgba(127,29,29,.35);border:1px solid rgba(127,29,29,.65);color:#fecaca;border-radius:999px;padding:4px 10px;font-size:.75rem;font-weight:700;cursor:pointer;transition:background .2s ease,border-color .2s ease,color .2s ease}
  .impedimentos-remove:hover{background:rgba(153,27,27,.55);border-color:rgba(185,28,28,.8);color:#fff}
  .impedimentos-table tr[data-status="resolved"] .icon-cell{background:rgba(22,101,52,.24)}
  .impedimentos-table tr[data-status="resolved"] .icon-cell span{color:#34d399;text-shadow:0 0 8px rgba(52,211,153,.35)}
  .impedimentos-table tr[data-status="resolved"] textarea{border-color:rgba(52,211,153,.45);box-shadow:0 0 0 1px rgba(52,211,153,.18) inset}
  .impedimentos-empty{display:none;text-align:center;font-size:.8rem;color:rgba(226,232,240,.7);padding:12px;border:1px dashed rgba(148,163,184,.35);border-radius:10px;background:rgba(15,23,42,.55)}
  .impedimentos-section.empty .impedimentos-table{display:none}
  .impedimentos-section.empty .impedimentos-empty{display:block}
  .demanda-plan-note-actions .btn{white-space:normal}
  .markdown-toolbar{display:flex;flex-wrap:wrap;gap:6px}
  .markdown-toolbar button{background:#1f2937;border:1px solid #374151;border-radius:6px;color:#e5e7eb;padding:6px 10px;font-weight:700;font-size:.75rem;cursor:pointer;transition:background .2s,border-color .2s,color .2s}
  .markdown-toolbar button:hover{background:#2563eb;border-color:#2563eb;color:#0b1120}
  .demanda-plan-demand-list{display:flex;flex-direction:column;gap:12px}
  .demanda-plan-item{background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:12px}
  .demanda-plan-header{display:flex;flex-direction:column;gap:4px;margin-bottom:4px}
  .demanda-plan-title{font-weight:700;font-size:.95rem;color:#fff}
  .demanda-plan-date{font-size:.8rem;color:#cbd5f5}
  .demanda-plan-demand-meta{font-size:.78rem;color:#9ca3af}
  .demanda-plan-action{margin-top:10px;display:flex;flex-direction:column;gap:6px}
  .demanda-plan-action-label{font-size:.78rem;font-weight:700;color:#bfdbfe;text-transform:uppercase;letter-spacing:.04em}
  .demanda-plan-action-editor{min-height:90px;background:rgba(15,23,42,.65);border:1px dashed rgba(148,163,184,.35);border-radius:10px;padding:10px 12px;color:#f8fafc;font-size:.85rem;line-height:1.55;outline:none;transition:border-color .2s,box-shadow .2s,background .2s;word-break:break-word}
  .demanda-plan-action-editor:focus{border-color:var(--accent,#7c4dff);box-shadow:0 0 0 2px rgba(124,77,255,.28);background:rgba(15,23,42,.82)}
  .demanda-plan-action-editor:empty::before{content:attr(data-placeholder);color:rgba(148,163,184,.6);font-weight:500}
  .demanda-plan-empty-demands{font-size:.85rem;color:#cbd5f5;background:rgba(15,23,42,.35);border:1px dashed rgba(255,255,255,.12);border-radius:8px;padding:10px}
  .demanda-plan-empty{color:#ccc;font-size:.9rem}
  @media (max-width:820px){
    .demandas-table th:not(.col-status):not(.col-demanda),
    .demandas-table td:not(.col-status):not(.col-demanda){display:none}
    .demandas-table .col-status{width:25%}
    .demandas-table .col-demanda{width:75%}
  }
</style>
<style id="notifications-css">
  .notification-widget{position:fixed;bottom:16px;right:16px;z-index:9999;display:none;flex-direction:column;align-items:flex-end;gap:10px;font-family:inherit;pointer-events:none}
  .notification-widget.open .notification-panel{opacity:1;transform:translateY(0);pointer-events:auto}
  .notification-button{position:relative;width:54px;height:54px;border-radius:50%;border:none;background:#1d4ed8;color:#fff;display:flex;align-items:center;justify-content:center;font-size:26px;cursor:pointer;box-shadow:0 10px 24px rgba(0,0,0,.38);transition:transform .2s ease,box-shadow .2s ease;pointer-events:auto}
  .notification-button:focus-visible{outline:3px solid rgba(99,102,241,.6);outline-offset:2px}
  .notification-button:hover{transform:translateY(-2px);box-shadow:0 12px 28px rgba(0,0,0,.42)}
  .notification-icon{pointer-events:none}
  .notification-badge{position:absolute;top:6px;right:6px;min-width:22px;height:22px;padding:0 6px;border-radius:999px;background:#ef4444;color:#fff;font-weight:800;font-size:.75rem;display:flex;align-items:center;justify-content:center;box-shadow:0 0 0 2px rgba(12,17,34,.92)}
  .notification-panel{width:min(420px,92vw);max-height:60vh;overflow:auto;background:#0b1120;border:1px solid rgba(148,163,184,.25);border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:12px;box-shadow:0 18px 40px rgba(2,6,23,.65);opacity:0;transform:translateY(6px);pointer-events:none;transition:opacity .18s ease,transform .18s ease}
  .notification-header{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .notification-title{font-weight:800;font-size:1rem;color:#e2e8f0;margin:0}
  .notification-clear{background:transparent;border:1px solid rgba(148,163,184,.4);color:#cbd5f5;border-radius:999px;font-size:.7rem;padding:4px 8px;cursor:pointer;line-height:1;transition:background .2s ease,color .2s ease}
  .notification-clear:hover{background:rgba(148,163,184,.12);color:#fff}
  .notification-list{display:flex;flex-direction:column;gap:10px}
  .notification-item{display:flex;gap:10px;padding:10px;border-radius:10px;background:rgba(148,163,184,.08);border:1px solid rgba(148,163,184,.18);color:#cbd5f5;font-size:.85rem;line-height:1.35}
  .notification-item.unseen{border-color:rgba(96,165,250,.4);box-shadow:0 0 0 1px rgba(37,99,235,.45)}
  .notification-item.alert{background:rgba(127,29,29,.32);border-color:rgba(248,113,113,.65);color:#fee2e2}
  .notification-item.warn{background:rgba(120,53,15,.32);border-color:rgba(251,191,36,.55);color:#fef3c7}
  .notification-icon-wrap{flex:0 0 34px;height:34px;border-radius:50%;background:rgba(59,130,246,.18);display:flex;align-items:center;justify-content:center;font-size:18px}
  .notification-item.alert .notification-icon-wrap{background:rgba(248,113,113,.25)}
  .notification-item.warn .notification-icon-wrap{background:rgba(251,191,36,.25);color:#fde68a}
  .notification-content{flex:1;min-width:0;display:flex;flex-direction:column;gap:4px}
  .notification-item-title{font-weight:700;color:#f8fafc;font-size:.9rem}
  .notification-item-meta{font-size:.75rem;color:rgba(226,232,240,.7)}
  .notification-item-time{font-size:.72rem;color:rgba(148,163,184,.75);font-weight:600}
  .notification-actions{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .notification-action{background:#1d4ed8;border:1px solid rgba(59,130,246,.6);color:#fff;border-radius:999px;padding:4px 10px;font-weight:700;font-size:.75rem;cursor:pointer;transition:filter .2s ease}
  .notification-action:hover{filter:brightness(1.1)}
  .notification-empty{padding:20px;text-align:center;border-radius:12px;background:rgba(15,23,42,.6);border:1px dashed rgba(148,163,184,.35);color:#94a3b8;font-size:.9rem}
  @media (max-width:640px){
    .notification-panel{right:0;width:min(360px,92vw)}
  }
</style>
<style id="refsocial-css">
  .refsocial-wrap{margin-left:var(--margin-left);margin-right:var(--margin-right);display:flex;flex-direction:column;gap:8px}
  .refsocial-top{display:flex;flex-direction:column;gap:12px}
  .refsocial-form{display:flex;flex-direction:column;gap:10px;background:var(--title-bg);border:1px solid var(--shell-border);padding:10px;border-radius:12px}
  .refsocial-form[data-mode="link"] .refsocial-field-upload{display:none}
  .refsocial-form[data-mode="upload"] .refsocial-field-link{display:none}
  .refsocial-form[data-mode="upload"] #refSocialLinkPreview{display:none}
  .refsocial-mode{display:inline-flex;align-self:flex-start;background:#131313;border:1px solid rgba(255,255,255,.08);border-radius:999px;padding:4px;gap:4px}
  .refsocial-mode button{border:0;border-radius:999px;padding:6px 14px;background:transparent;color:#bbb;font-weight:700;cursor:pointer;transition:background .2s,color .2s}
  .refsocial-mode button.active{background:var(--accent,#2e7d32);color:#fff;box-shadow:0 0 0 1px rgba(0,0,0,.35)}
  .refsocial-grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .refsocial-field{display:flex;flex-direction:column;gap:4px}
  .refsocial-field span{font-size:.7rem;letter-spacing:.08em;color:#bbb;text-transform:uppercase}
  .refsocial-field input[type="url"],.refsocial-field input[type="file"],.refsocial-field select,.refsocial-field textarea{background:#222;color:#fff;border:1px solid #333;border-radius:8px;padding:8px}
  .refsocial-field input[type="file"]{padding:10px 8px}
  .refsocial-field textarea{min-height:90px;resize:vertical}
  .refsocial-submit{display:flex;justify-content:flex-end}
  .refsocial-link-preview{border:1px dashed rgba(255,255,255,.2);border-radius:10px;padding:10px;min-height:160px;display:flex;flex-direction:column;gap:10px;justify-content:center;align-items:center;text-align:center;background:#0d0d0d}
  .refsocial-link-preview[data-state="loading"]{opacity:.7}
  .refsocial-link-preview-media{width:100%;display:flex;justify-content:center}
  .refsocial-link-preview-media iframe,
  .refsocial-link-preview-media img{width:100%;border:0;border-radius:10px;background:#000;display:block}
  .refsocial-link-preview-media iframe{height:auto;min-height:610px}
  .refsocial-link-preview-meta{display:flex;flex-direction:column;gap:4px;font-size:.8rem;width:100%;text-align:left}
  .refsocial-link-preview-meta strong{font-size:.75rem;color:#ffd9bf;letter-spacing:.06em}
  .refsocial-link-preview-meta a{color:#8ecbff;text-decoration:underline;font-size:.75rem;align-self:flex-start}
  .refsocial-list{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
  .ref-item{position:relative;background:#0d0d0d;border:1px solid var(--shell-border);border-radius:8px;padding:6px;width:min(340px,100%);display:flex;flex-direction:column;gap:6px}
  .ref-item-media{position:relative;border-radius:6px;overflow:hidden;background:#000;display:flex;align-items:stretch;justify-content:center}
  .ref-item-media img,.ref-item-media video{width:100%;height:auto;display:block}
  .ref-item-media iframe{width:100%;border:0;background:#000;display:block;height:auto;min-height:610px}
  .ref-item-details{font-size:.75rem;display:flex;flex-direction:column;gap:4px}
  .ref-item-details strong{display:block;font-size:.8rem}
  .ref-item-details p{margin:0}
  .ref-item-details .markdown-view{font-size:.8rem}
  .ref-item-details .markdown-view > :last-child{margin-bottom:0}
  .ref-link-info{display:flex;flex-direction:column;gap:4px;font-size:.72rem}
  .ref-link-provider{font-weight:700;letter-spacing:.05em;color:#ffd9bf;font-size:.7rem}
  .ref-link-actions{display:flex;gap:8px;flex-wrap:wrap;font-size:.72rem}
  .ref-link-actions a{color:#8ecbff;text-decoration:underline}
  .ref-item-actions{margin-top:2px;display:flex;gap:6px;flex-wrap:wrap}
  .ref-item button.ref-edit{flex:1;background:#1f1f1f;color:#fff;border:1px solid #333;border-radius:6px;padding:4px 6px;cursor:pointer;font-size:.75rem;transition:background .2s ease}
  .ref-item button.ref-edit:hover{background:#2a2a2a}
  .ref-item textarea.ref-edit-input{width:100%;min-height:80px;background:#1a1a1a;color:#fff;border:1px solid #333;border-radius:6px;padding:6px;font-size:.75rem;resize:vertical;font-family:inherit}
  .ref-item button.ref-save{flex:1;background:#2e7d32;border:1px solid #1b5e20;color:#fff;border-radius:6px;padding:4px 6px;cursor:pointer;font-size:.75rem;transition:filter .2s ease}
  .ref-item button.ref-save:hover{filter:brightness(1.1)}
  .ref-item button.ref-cancel{flex:1;background:#333;border:1px solid #555;color:#fff;border-radius:6px;padding:4px 6px;cursor:pointer;font-size:.75rem;transition:background .2s ease}
  .ref-item button.ref-cancel:hover{background:#3d3d3d}
  .ref-item button.ref-remove{position:absolute;top:2px;right:2px;background:#c00;color:#fff;border:none;border-radius:50%;width:20px;height:20px;cursor:pointer;font-size:12px;line-height:20px;padding:0}
</style>
<style id="competitors-css">
  .competitors-wrap{margin-left:var(--margin-left);margin-right:var(--margin-right);display:flex;flex-direction:column;gap:8px}
  .competitors-controls{display:flex;flex-wrap:wrap;gap:6px;align-items:center;background:var(--title-bg);border:1px solid var(--shell-border);padding:8px;border-radius:10px}
  .competitors-controls input{background:#222;color:#fff;border:1px solid #333;border-radius:8px;padding:6px 8px}
  .competitors-table{width:100%;border-collapse:collapse}
  .competitors-table th,.competitors-table td{border:1px solid var(--shell-border);padding:4px;font-size:.85rem}
  .competitors-table th{background:var(--title-bg)}
  .competitors-table td a{color:var(--accent);text-decoration:none}
  .competitors-table td a:hover{text-decoration:underline}
  .competitors-table .del-cell button{background:#550000;border:1px solid #880000;color:#fff;border-radius:4px;padding:2px 6px;cursor:pointer}
</style>
<style id="files-css">
  .hidden{display:none!important}
  .files-wrap{margin-left:var(--margin-left);margin-right:var(--margin-right);display:flex;flex-direction:column;gap:16px}
  .files-layout{display:flex;gap:16px;align-items:stretch}
  .files-sidebar{width:240px;min-width:220px;display:flex;flex-direction:column;gap:12px;background:var(--title-bg);border:1px solid var(--shell-border);border-radius:12px;padding:12px}
  .files-sidebar-head{display:flex;justify-content:space-between;align-items:center}
  .folder-tree{display:flex;flex-direction:column;gap:4px}
  .folder-tree-item{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:8px;cursor:pointer;background:transparent;transition:background .2s,color .2s;position:relative;padding-left:calc(12px + var(--depth,0)*16px)}
  .folder-tree-item .tree-icon{opacity:.7;font-size:1rem}
  .folder-tree-item .tree-label{flex:1;min-width:0;text-overflow:ellipsis;overflow:hidden;white-space:nowrap;font-size:.85rem}
  .folder-tree-item:hover{background:rgba(255,255,255,.08)}
  .folder-tree-item.active{background:var(--accent);color:var(--black)}
  .folder-tree-item.active .tree-icon{opacity:1}
  .folder-actions{display:flex;align-items:center;gap:4px;opacity:0;transition:opacity .2s}
  .folder-tree-item:hover .folder-actions,.folder-tree-item.active .folder-actions{opacity:.85}
  .folder-action{background:none;border:0;color:inherit;cursor:pointer;font-size:.8rem;padding:0}
  .folder-tree-item.active .folder-action{color:var(--black)}
  .folder-tree-empty{font-size:.8rem;color:var(--muted);padding:8px 12px}
  .files-main{flex:1;display:flex;flex-direction:column;gap:16px;background:var(--title-bg);border:1px solid var(--shell-border);border-radius:12px;padding:16px}
  .files-breadcrumb{display:flex;flex-wrap:wrap;align-items:center;gap:6px;font-size:.85rem}
  .files-breadcrumb .crumb{cursor:pointer;color:var(--accent);font-weight:600}
  .files-breadcrumb .crumb.current{cursor:default;color:#fff}
  .files-breadcrumb .crumb-sep{opacity:.5}
  .files-actions{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  .files-actions .left-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .files-actions input[type="file"]{display:none}
  .files-actions .btn.active{background:var(--accent);color:var(--black);border-color:var(--accent)}
  .files-select-tools{display:flex;align-items:center;gap:6px;font-size:.8rem;color:var(--muted);flex-wrap:wrap}
  .files-select-tools .select-all-box{display:flex;align-items:center;gap:6px;cursor:pointer;font-weight:600}
  .files-select-tools input{width:18px;height:18px;cursor:pointer;accent-color:var(--accent)}
  .upload-progress{margin-left:auto;display:flex;align-items:center;gap:8px;font-size:.75rem;color:var(--muted)}
  .upload-progress.hidden{display:none}
  .upload-progress-text{max-width:180px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .upload-progress-track{width:160px;max-width:40vw;height:6px;background:rgba(255,255,255,.16);border-radius:999px;overflow:hidden;position:relative}
  .upload-progress-fill{height:100%;width:0;background:var(--accent);transition:width .2s ease}
  .upload-progress-percent{min-width:38px;text-align:right;font-variant-numeric:tabular-nums;color:#fff;font-weight:700}
    .storage-usage-hint{margin-left:auto}
  .files-view-toggle{display:inline-flex;border:1px solid var(--shell-border);border-radius:10px;overflow:hidden;background:#111}
  .files-view-toggle .view-btn{appearance:none;border:0;background:transparent;color:#fff;padding:6px 12px;display:flex;align-items:center;gap:6px;cursor:pointer;font-size:.8rem;font-weight:700;line-height:1}
  .files-view-toggle .view-btn:not(:last-child){border-right:1px solid var(--shell-border)}
  .files-view-toggle .view-btn.active{background:var(--accent);color:var(--black)}
  .files-empty{font-size:.85rem;color:var(--muted)}
  .subfolders-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}
  .subfolders-grid.hidden{display:none}
  .subfolder-card{background:#111;border:1px solid #333;border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:8px;cursor:pointer;transition:transform .2s,border-color .2s}
  .subfolder-card:hover{transform:translateY(-2px);border-color:var(--accent)}
  .subfolder-icon{font-size:24px}
  .subfolder-name{font-size:.85rem;font-weight:600;word-break:break-word}
  .files-list{display:flex;flex-direction:column;gap:12px}
  .files-list.hidden{display:none}
  .files-table{width:100%;border:1px solid var(--shell-border);border-radius:12px;overflow:hidden;background:rgba(0,0,0,.18)}
  .files-table-head{display:grid;grid-template-columns:40px minmax(220px,2fr) minmax(150px,1fr) minmax(120px,.8fr) minmax(150px,1fr);gap:12px;padding:10px 12px;font-size:.75rem;text-transform:uppercase;letter-spacing:.04em;color:var(--muted);background:rgba(255,255,255,.06)}
  .files-table-body{display:flex;flex-direction:column}
  .files-table-row{display:grid;grid-template-columns:40px minmax(220px,2fr) minmax(150px,1fr) minmax(120px,.8fr) minmax(150px,1fr);gap:12px;padding:10px 12px;align-items:center;border-top:1px solid rgba(255,255,255,.06);cursor:pointer;transition:background .2s}
  .files-table-row:hover{background:rgba(255,255,255,.04)}
  .file-info{display:flex;align-items:center;gap:10px;min-width:0}
  .file-thumb{width:48px;height:48px;border-radius:12px;background:#090909;border:1px solid rgba(255,255,255,.1);display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0}
  .file-thumb img,.file-thumb video{width:100%;height:100%;object-fit:cover;display:block}
  .file-thumb video{pointer-events:none}
  .file-icon{font-size:1.6rem}
  .file-text{display:flex;flex-direction:column;gap:4px;min-width:0}
  .file-name{font-size:.9rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .file-type{font-size:.75rem;color:var(--muted)}
  .file-meta{font-size:.8rem;color:var(--muted)}
  .file-meta strong{display:block;font-size:.7rem;text-transform:uppercase;letter-spacing:.04em;color:var(--muted)}
  .file-actions{justify-self:end;display:flex;justify-content:flex-end;align-items:center;gap:8px;flex-wrap:wrap}
  .file-action-buttons{display:flex;gap:6px;flex-wrap:wrap}
  .file-action-move{display:flex}
  .file-select-head{display:flex;justify-content:center;align-items:center}
  .file-select-col{display:flex;align-items:center;justify-content:center}
  .file-select-box{display:inline-flex;align-items:center;gap:6px;font-size:.75rem;font-weight:600;color:var(--muted);cursor:pointer}
  .file-select-box input{width:18px;height:18px;cursor:pointer;accent-color:var(--accent)}
  .file-select-box .file-select-label{pointer-events:none}
  .file-select-box.compact{gap:0;padding:6px;background:rgba(0,0,0,.55);border-radius:999px}
  .file-select-box.compact input{width:16px;height:16px}
  .file-select-box.compact .file-select-label{display:none}
  .file-checkbox:disabled{opacity:.4;cursor:not-allowed}
  .file-entry.selected{background:rgba(46,125,50,.12)}
  .files-table-row.selected{background:rgba(46,125,50,.12);border-color:rgba(46,125,50,.35)}
  .files-table-row.selected:hover{background:rgba(46,125,50,.18)}
  .file-card.selected{border-color:var(--accent);box-shadow:0 0 0 2px rgba(46,125,50,.35)}
  .file-card .file-select-box{position:absolute;top:12px;left:12px}
  .file-actions .move-select{background:#1f1f1f;color:#fff;border:1px solid #333;border-radius:8px;padding:6px;font-size:.75rem;cursor:pointer;min-width:150px}
  .file-actions .move-select:focus{outline:2px solid var(--accent)}
  .files-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:16px;align-items:start}
  .file-entry.uploading{opacity:.8}
  .file-status{margin-top:6px;display:flex;flex-direction:column;gap:4px;font-size:.7rem;color:var(--accent)}
  .file-status-bar{width:100%;height:4px;background:rgba(255,255,255,.15);border-radius:999px;overflow:hidden}
  .file-status-fill{height:100%;width:0;background:var(--accent);transition:width .2s ease}
  .file-card{background:#111;border:1px solid #333;border-radius:16px;padding:16px;display:flex;flex-direction:column;align-items:center;gap:12px;cursor:pointer;transition:border-color .2s,transform .2s;text-align:center;position:relative}
  .file-card:hover{border-color:var(--accent);transform:translateY(-2px)}
  .file-card .file-thumb{width:72px;height:72px;border-radius:16px;margin:0 auto}
  .file-card .file-name{font-size:.85rem;font-weight:600;width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .file-card .file-meta{font-size:.75rem}
  .file-card .file-actions{width:100%;flex-direction:column;align-items:stretch;gap:10px}
  .file-card .file-action-buttons{justify-content:center}
  .file-card .file-action-move{width:100%}
  .file-card .move-select{width:100%}
  .file-details{display:flex;flex-direction:column;gap:4px;font-size:.72rem;color:var(--muted);width:100%}
  .file-details span{display:block}
  .file-folder{font-size:.75rem;color:var(--muted);display:flex;align-items:center;gap:4px}
  .file-card .file-folder{justify-content:center}
  .file-preview-body{grid-template-columns:minmax(0,2fr) minmax(0,1fr)}
  .file-preview-info{display:flex;flex-direction:column;gap:10px;font-size:.85rem}
  .file-preview-info strong{display:block;font-size:.7rem;text-transform:uppercase;letter-spacing:.04em;color:var(--muted)}
  .file-preview-info .btn{align-self:flex-start}
  .file-preview-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .file-preview-placeholder{color:var(--muted);text-align:center;padding:24px;display:flex;align-items:center;justify-content:center;flex:1}
  .file-preview-placeholder a{color:var(--accent);font-weight:700}
  .files-bulk-bar{position:sticky;bottom:0;display:flex;justify-content:space-between;align-items:center;gap:16px;background:rgba(8,8,8,.95);border:1px solid var(--accent);border-radius:14px;padding:12px 16px;box-shadow:0 12px 30px rgba(0,0,0,.35);z-index:20}
  .files-bulk-info{display:flex;flex-direction:column;gap:2px;font-size:.8rem}
  .files-bulk-info strong{text-transform:uppercase;letter-spacing:.08em;font-size:.72rem;color:var(--accent)}
  .files-bulk-count{font-weight:700}
  .files-bulk-status{color:var(--muted);font-size:.75rem}
  .files-bulk-status.hidden{display:none}
  .files-bulk-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .files-bulk-actions .btn[disabled]{opacity:.6;cursor:not-allowed}
  .files-bulk-bar.hidden{display:none}
  @media (max-width:900px){
    .files-layout{flex-direction:column}
    .files-sidebar{width:100%}
    .files-table-head,.files-table-row{grid-template-columns:40px minmax(200px,2fr) minmax(120px,1fr) minmax(100px,.8fr) minmax(150px,1fr)}
    .file-actions{justify-content:flex-start}
    .file-preview-body{grid-template-columns:1fr}
  }
  @media (max-width:640px){
    .files-view-toggle{width:100%}
    .files-view-toggle .view-btn{flex:1;justify-content:center}
    .files-table{border-radius:10px}
    .files-table-head{grid-template-columns:minmax(0,1fr)}
    .files-table-head .file-select-head{display:none}
    .files-table-body{gap:10px;padding:6px}
    .files-table-row{grid-template-columns:minmax(0,1fr);border:1px solid rgba(255,255,255,.08);border-radius:10px}
    .file-select-col{justify-content:flex-start}
    .files-table-row > :not(.file-info){justify-self:flex-start}
    .files-table-row .file-actions{width:100%;justify-content:flex-start}
    .files-table-row .file-action-move{width:100%}
    .files-table-row .file-meta{font-size:.75rem}
    .file-card .file-thumb{height:120px}
    .files-bulk-bar{flex-direction:column;align-items:flex-start;gap:10px}
  }
  @media (max-width:540px){
    .files-actions{justify-content:flex-start}
    .upload-progress{width:100%;margin-left:0;flex-direction:column;align-items:flex-start;gap:4px}
    .upload-progress-track{width:100%;max-width:none}
    .upload-progress-percent{align-self:flex-end}
    .upload-progress-text{max-width:none}
    .storage-usage{flex:1 1 100%;max-width:none}
    .storage-usage-hint{margin-left:0}
    .storage-usage-footer{flex-direction:column;align-items:flex-start}
  }
</style>
<style id="metas-css">
  .metas-wrap{margin-left:var(--margin-left);margin-right:var(--margin-right);display:flex;flex-direction:column;gap:8px;overflow-x:auto;padding-bottom:16px}
  .metas-toolbar{display:flex;gap:6px;align-items:center;background:var(--title-bg);border:1px solid var(--shell-border);padding:8px;border-radius:10px}
  .metas-summary{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin-bottom:8px}
  .metas-summary .meta-panel{background:var(--title-bg);border:1px solid var(--shell-border);border-radius:8px;padding:12px;display:flex;flex-direction:column;gap:12px}
  .metas-summary .meta-panel select{margin-bottom:8px;font-size:.9rem}
  .metas-summary .meta-panel .stats{display:flex;flex-direction:column;gap:8px}
  .metas-summary .meta-panel .stat-line{display:flex;flex-direction:column}
  .metas-summary .meta-panel .stat-label{font-size:.75rem;color:var(--muted)}
  .metas-summary .meta-panel .stat-value{font-size:1.4rem;font-weight:700}
  .metas-table{width:100%;border-collapse:collapse;font-size:.75rem;table-layout:fixed}
  .metas-table col.meta-col-info{width:220px}
  .metas-table col.meta-col-month{width:80px}
  .metas-table col.meta-col-total{width:90px}
  .metas-table th,.metas-table td{border:1px solid var(--shell-border);padding:1px;text-align:center;white-space:nowrap;vertical-align:middle}
  .metas-table th.meta-name{background:#333;color:#fff;width:220px}
  .metas-table td.meta-info{background:#333;color:#fff;text-align:left;vertical-align:top;min-width:220px;width:220px;white-space:normal;font-weight:600}
  .metas-table th:not(.meta-name),.metas-table td:not(.meta-info){min-width:80px}
  .metas-table tr.projetado td{background:#d1d5db;color:#000}
  .metas-table tr.realizado td{background:#fff;color:#000}
  .metas-table tr.conclusao td{font-weight:700}
  .metas-table tr.evolucao td{background:#111;color:#fff}
  .metas-table td.meta-info input,.metas-table td.meta-info select{width:100%;margin-bottom:2px;background:#1a1a1a;color:#fff;border:1px solid #333;border-radius:4px;padding:2px}
  .metas-table td.meta-info .actions{display:flex;gap:2px;margin-top:2px}
  .metas-table td:not(.meta-info) input{width:100%;text-align:center}
  .metas-table tr.meta-inactive td,.metas-table tr.meta-inactive th{background:#374151!important;color:#cbd5f5!important}
  .metas-table tr.meta-inactive td.meta-info{background:#1f2937!important;color:#cbd5f5!important}
  .metas-table tr.meta-inactive td input,.metas-table tr.meta-inactive td select{background:#1f2937;color:#cbd5f5;border-color:#4b5563}
  .metas-table tr.meta-inactive td .meta-bulk-btn{background:#1f2937;color:#e2e8f0;border-color:#4b5563}
  .meta-cell{position:relative;display:flex;align-items:center;justify-content:center;padding-right:22px}
  .meta-cell input{flex:1 1 auto;width:100%;min-width:0;text-align:center;padding-right:26px}
  .meta-bulk-btn{background:rgba(255,255,255,.05);border:1px solid var(--shell-border);border-radius:4px;color:#f9fafb;cursor:pointer;font-size:.65rem;padding:2px 6px;line-height:1;opacity:.65;transition:opacity .2s ease;position:absolute;right:4px;top:50%;transform:translateY(-50%)}
  .meta-bulk-btn:hover,.meta-bulk-btn:focus{opacity:1}
  .meta-bulk-menu{position:absolute;z-index:10000;display:none;flex-direction:column;gap:8px;width:240px;background:#0f172a;border:1px solid var(--shell-border);border-radius:10px;padding:10px;box-shadow:0 12px 30px rgba(15,23,42,.6)}
  .meta-bulk-menu.show{display:flex}
  .meta-bulk-header{font-size:.75rem;font-weight:700;color:#f9fafb}
  .meta-bulk-quick{display:flex;flex-wrap:wrap;gap:6px}
  .meta-bulk-quick button{background:rgba(255,255,255,.08);border:1px solid var(--shell-border);border-radius:6px;color:#e2e8f0;cursor:pointer;font-size:.7rem;padding:4px 6px;line-height:1}
  .meta-bulk-quick button:hover,.meta-bulk-quick button:focus{filter:brightness(1.1)}
  .meta-bulk-quick button:disabled{opacity:.4;cursor:default;filter:none}
  .meta-bulk-list{display:grid;grid-template-columns:1fr;gap:4px;max-height:220px;overflow:auto;padding:2px}
  .meta-bulk-list label{display:flex;align-items:center;gap:6px;font-size:.75rem;color:#e2e8f0}
  .meta-bulk-footer{display:flex;justify-content:flex-end;gap:6px}
  .meta-bulk-footer button{background:#2563eb;border:1px solid #1d4ed8;border-radius:6px;color:#fff;cursor:pointer;font-size:.75rem;padding:5px 10px;line-height:1}
  .meta-bulk-footer .cancel{background:rgba(255,255,255,.08);border-color:var(--shell-border);color:#e2e8f0}
  .meta-title-content{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .meta-title-text{font-weight:700;flex:1}
  .meta-activation{display:flex;align-items:center;gap:6px;margin-bottom:4px}
  .meta-title-cell .meta-activation{margin-bottom:0;margin-left:auto}
  .meta-toggle{border:1px solid #4b5563;border-radius:999px;padding:4px 12px;font-weight:700;cursor:pointer;background:#1f2937;color:#e5e7eb;transition:background .2s ease,color .2s ease,border-color .2s ease}
  .meta-toggle.on{background:#166534;border-color:#16a34a;color:#f0fdf4}
  .meta-toggle.off{background:#374151;border-color:#4b5563;color:#cbd5f5}
  .metas-table tr.meta-inactive .meta-toggle{background:#4b5563;border-color:#6b7280;color:#e5e7eb}
  @media (max-width:820px){.meta-bulk-btn{opacity:1}}
  .metas-table thead{position:sticky;top:0;z-index:2}
  .metas-table thead th{background:#1f2937;color:#fff;z-index:2}
  @media (max-width:820px){
    .metas-table{font-size:.7rem;min-width:900px}
    .metas-table col.meta-col-month{width:72px}
    .metas-table col.meta-col-total{width:84px}
  }
  @media (max-width:600px){
    .metas-table{font-size:.6rem;min-width:600px}
    .metas-table col.meta-col-month{width:68px}
    .metas-table col.meta-col-total{width:80px}
    .metas-table th.meta-name,.metas-table td.meta-info{display:none}
    .metas-toolbar{flex-wrap:wrap}
    .metas-toolbar .btn{font-size:.75rem;padding:4px 8px}
  }
  .concl-azul{background:#1e40af;color:#fff}
  .concl-verde{background:#2e7d32;color:#fff}
  .concl-amarelo{background:#f6e05e;color:#000}
  .concl-laranja{background:#fb923c;color:#000}
  .concl-vermelho{background:#dc2626;color:#fff}
  .meta-setor{margin-bottom:8px}
  .meta-setor h3{margin:0 0 4px}
  .meta-setor.marketing h3{color:purple}
  .meta-setor.comercial h3{color:blue}
  .meta-setor.marketing .metas-table th.meta-name,
  .meta-setor.marketing .metas-table td.meta-info{background:purple;color:#fff}
  .meta-setor.comercial .metas-table th.meta-name,
  .meta-setor.comercial .metas-table td.meta-info{background:blue;color:#fff}
  .metas-table .meta-title-spacer{border:none;background:transparent;width:220px}
  .metas-table tr.meta-title-row td.meta-title-cell{background:#f59e0b;color:#000;font-weight:700;text-align:center}
  .metas-table tr.meta-months-row td{background:#1f2937;color:#fff;font-weight:700}
  .metas-table tr.meta-gap td{border:none;height:4px;padding:0;background:transparent}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.9/dist/purify.min.js"></script>
<script src="commemorative_dates_2025.js"></script>
<style>
  #refreshBtn {
    position: fixed;
    top: 10px;
    right: 10px;
    padding: 8px 12px;
    border: 0;
    border-radius: 8px;
    background: #333;
    color: #fff;
    cursor: pointer;
    z-index: 1000;
    display: none;
  }
</style>
<style>
  /* Futuristic loading overlay */
  #loadingScreen{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background:rgba(0,0,0,0.85);
    z-index:10000;
  }
  #loadingScreen .loader{
    width:80px;
    height:80px;
    border:4px solid rgba(255,255,255,0.1);
    border-top:4px solid #00ffff;
    border-radius:50%;
    animation:spin 1s linear infinite;
  }
  @keyframes spin{to{transform:rotate(360deg);}}
  </style>
<style id="mobile-optimizations">
  @media (max-width: 430px) {
    :root {
      --margin-left: 10px;
      --margin-right: 10px;
      --iframe-h: 420px;
    }

    body {
      width: 100%;
      overflow-x: hidden;
    }

    #userArea {
      padding: 10px;
    }

    [class$="-wrap"],
    [class$="Wrap"] {
      margin-left: var(--margin-left);
      margin-right: var(--margin-right);
    }

    .tabs {
      padding: 0;
      margin: 8px 0;
      gap: 6px;
      justify-content: flex-start;
      overflow-x: auto;
      width: 100%;
    }

    .tabs::-webkit-scrollbar {
      display: none;
    }

    .topbar,
    [class$="-toolbar"],
    [class$="-filters"],
    .macro-actions,
    .widget-actions,
    .ia-docs-actions,
    .ia-main-actions,
    .access-toolbar .access-actions,
    .files-actions {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      width: 100%;
      gap: 10px;
    }

    .topbar > *,
    [class$="-toolbar"] > *,
    [class$="-filters"] > *,
    .macro-actions > *,
    .widget-actions > *,
    .ia-docs-actions > *,
    .ia-main-actions > *,
    .access-toolbar .access-actions > *,
    .files-actions > * {
      width: 100%;
    }

    .right-tools,
    .profile-area,
    .actions-inline,
    .actions {
      width: 100%;
      justify-content: flex-start;
      gap: 8px;
    }

    input:not([type="checkbox"]):not([type="radio"]),
    select,
    textarea,
    .input,
    .btn,
    button {
      width: 100%;
      max-width: 100%;
    }

    .btn.small {
      padding: 10px;
    }

    .calendar,
    .frame-shell,
    iframe {
      width: 100%;
    }

    .dashboard,
    .widgets-grid {
      grid-template-columns: 1fr;
      width: 100%;
    }

    .modal {
      padding: 0;
    }

    .modal-card {
      width: 100dvw;
      height: 100dvh;
      max-width: none;
      max-height: none;
      border-radius: 0;
      display: flex;
      flex-direction: column;
    }

    .modal-body {
      display: flex;
      flex-direction: column;
      flex: 1;
      overflow: auto;
    }

    .modal-foot {
      flex-wrap: wrap;
      width: 100%;
      gap: 8px;
    }

    .access-row,
    .form-inline {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .access-row .cell,
    .form-inline > * {
      width: 100%;
    }

    .table-wrap {
      overflow: visible;
    }

    table {
      width: 100%;
      display: block;
      border-collapse: separate;
      border-spacing: 0;
    }

    table thead {
      display: none;
    }

    table tbody {
      display: block;
      width: 100%;
    }

    table tr {
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--shell-border, rgba(255, 255, 255, 0.14));
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 12px;
    }

    table td {
      width: 100%;
      display: block;
    }

    table td[data-label]::before {
      content: attr(data-label);
      display: block;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--muted, #bbb);
      margin-bottom: 4px;
      font-weight: 700;
    }

    table td:first-child:not([data-label]) {
      font-weight: 700;
    }
  }

  /* Aba Relat√≥rio */
  .relatorio-wrap{
    margin-left:var(--margin-left);
    margin-right:var(--margin-right);
    display:flex;
    flex-direction:column;
    gap:20px;
  }
  .relatorio-container{
    background:var(--panel);
    border:1px solid var(--shell-border);
    border-radius:16px;
    padding:24px;
    box-shadow:0 10px 28px rgba(0,0,0,.35);
  }
  .relatorio-header{
    margin-bottom:24px;
  }
  .relatorio-header h2{
    margin:0 0 8px;
    font-size:1.8rem;
    font-weight:900;
    background:linear-gradient(135deg,#ff6633,#ff944d);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text;
  }
  .relatorio-subtitle{
    margin:0;
    color:#94a3b8;
    font-size:.95rem;
  }
  .relatorio-desc{
    margin:14px auto 0;
    color:#e5ecff;
    font-size:1.06rem;
    line-height:1.6;
    text-align:center;
    font-weight:700;
    letter-spacing:.01em;
    max-width:980px;
  }
  .relatorio-filters{
    display:flex;
    flex-wrap:wrap;
    gap:16px;
    align-items:flex-end;
    padding:20px;
    background:rgba(255,255,255,.02);
    border:1px solid rgba(255,255,255,.08);
    border-radius:12px;
    margin-bottom:24px;
  }
  .relatorio-filter-group{
    display:flex;
    flex-direction:column;
    gap:8px;
    min-width:180px;
  }
  .relatorio-filter-group label{
    font-size:.85rem;
    font-weight:700;
    color:#cbd5f5;
    text-transform:uppercase;
    letter-spacing:.06em;
  }
  .relatorio-preview{
    min-height:400px;
    background:rgba(255,255,255,.02);
    border:1px solid rgba(255,255,255,.08);
    border-radius:12px;
    padding:32px;
  }
  .relatorio-preview.has-meta{
    min-height:auto;
    padding:12px;
  }
  .relatorio-preview-meta{
    display:flex;
    align-items:center;
    gap:10px;
    color:#cbd5f5;
    font-size:.95rem;
    background:rgba(255,255,255,.02);
    border:1px dashed rgba(255,255,255,.12);
    border-radius:10px;
    padding:10px 12px;
  }
  .relatorio-preview-meta .meta-item.ok{ color:#86efac; font-weight:800; }
  .relatorio-preview-meta .meta-sep{ opacity:.6 }
  @media (max-width:820px){
    .relatorio-preview-meta{ flex-wrap:wrap; justify-content:center; text-align:center; }
    .relatorio-preview-meta .meta-sep{ display:none }
  }
  .relatorio-empty{
    display:flex;
    align-items:center;
    justify-content:center;
    min-height:300px;
    text-align:center;
  }
  .relatorio-empty p{
    font-size:1.1rem;
    color:#94a3b8;
    margin:0;
  }
  .relatorio-content{
    display:flex;
    flex-direction:column;
    gap:24px;
  }
  .relatorio-section{
    background:rgba(0,0,0,.3);
    border:1px solid rgba(255,255,255,.12);
    border-radius:12px;
    padding:20px;
  }
  .relatorio-section h3{
    margin:0 0 16px;
    font-size:1.3rem;
    font-weight:800;
    color:#ff6633;
    border-bottom:2px solid #ff6633;
    padding-bottom:8px;
  }
  .relatorio-metric{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:12px 0;
    border-bottom:1px solid rgba(255,255,255,.08);
  }
  .relatorio-metric:last-child{
    border-bottom:none;
  }
  .relatorio-metric-label{
    font-weight:700;
    color:#cbd5f5;
  }
  .relatorio-metric-value{
    font-size:1.2rem;
    font-weight:800;
    color:#ff6633;
  }
  @media (max-width:768px){
    .relatorio-filters{
      flex-direction:column;
      align-items:stretch;
    }
    .relatorio-filter-group{
      width:100%;
    }
    .relatorio-filters .btn{
      width:100%;
    }
  }
  
  /* Carrossel de Stories do Relat√≥rio */
  .relatorio-stories-carousel{
    position:relative;
    display:flex;
    align-items:center;
    gap:12px;
  }
  .relatorio-stories-grid{
    flex:1;
    display:flex;
    gap:12px;
    overflow-x:auto;
    scroll-behavior:smooth;
    padding:12px 4px;
    -webkit-overflow-scrolling:touch;
  }
  .relatorio-stories-grid::-webkit-scrollbar{
    height:8px;
  }
  .relatorio-stories-grid::-webkit-scrollbar-track{
    background:rgba(255,255,255,.05);
    border-radius:4px;
  }
  .relatorio-stories-grid::-webkit-scrollbar-thumb{
    background:#ff6633;
    border-radius:4px;
  }
  .relatorio-stories-grid::-webkit-scrollbar-thumb:hover{
    background:#ff7744;
  }
  .relatorio-story-item{
    min-width:120px;
    width:120px;
    height:200px;
    border-radius:12px;
    overflow:hidden;
    position:relative;
    cursor:pointer;
    background:rgba(0,0,0,.4);
    border:2px solid rgba(255,255,255,.1);
    transition:all .3s ease;
    flex-shrink:0;
  }
  .relatorio-story-item:hover{
    transform:translateY(-4px);
    border-color:#ff6633;
    box-shadow:0 8px 24px rgba(255,102,51,.3);
  }
  .relatorio-story-item img{
    width:100%;
    height:100%;
    object-fit:cover;
  }
  .relatorio-story-item.video::before{
    content:"‚ñ∂";
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    font-size:2rem;
    color:#fff;
    text-shadow:0 2px 8px rgba(0,0,0,.8);
    z-index:2;
  }
  .relatorio-story-date{
    position:absolute;
    bottom:0;
    left:0;
    right:0;
    background:linear-gradient(to top,rgba(0,0,0,.9),transparent);
    color:#fff;
    font-size:.75rem;
    font-weight:700;
    padding:8px 6px 6px;
    text-align:center;
  }
  .relatorio-story-status{
    position:absolute;
    top:6px;
    right:6px;
    width:12px;
    height:12px;
    border-radius:50%;
    border:2px solid #fff;
    box-shadow:0 2px 4px rgba(0,0,0,.5);
  }
  .relatorio-story-item.aprovado .relatorio-story-status{
    background:#4ade80;
  }
  .relatorio-story-item.aprovado-interno .relatorio-story-status{
    background:#60a5fa;
  }
  .relatorio-story-item.revisar .relatorio-story-status{
    background:#fbbf24;
  }
  .relatorio-story-item.pendente .relatorio-story-status{
    background:#94a3b8;
  }
  .relatorio-stories-empty{
    width:100%;
    text-align:center;
    padding:40px 20px;
    color:#94a3b8;
  }
  .carousel-nav{
    background:rgba(255,102,51,.2);
    border:2px solid #ff6633;
    color:#ff6633;
    width:40px;
    height:40px;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:1.5rem;
    font-weight:700;
    cursor:pointer;
    transition:all .3s ease;
    flex-shrink:0;
  }
  .carousel-nav:hover{
    background:#ff6633;
    color:#fff;
    transform:scale(1.1);
  }
  .carousel-nav:active{
    transform:scale(.95);
  }
  @media (max-width:768px){
    .carousel-nav{
      width:32px;
      height:32px;
      font-size:1.2rem;
    }
    .relatorio-story-item{
      min-width:100px;
      width:100px;
      height:170px;
    }
  }
  
  /* Objetivos do m√™s (Planejamento) */
  .relatorio-goals-summary{
    display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin:10px 0 18px;
  }
  .goal-pill{ border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.05); color:#e2e8f0; padding:8px 12px; border-radius:999px; font-size:.9rem; }
  .goal-pill strong{ color:#fff; margin-left:4px; }
  .goal-done{ border-color:#14532d; background:rgba(20,83,45,.25); }
  .goal-progress{ border-color:#b45309; background:rgba(180,83,9,.22); }
  .goal-todo{ border-color:#1e3a8a; background:rgba(30,58,138,.22); }
  .goals-columns{ display:grid; grid-template-columns: repeat(3,1fr); gap:16px; }
  .goals-col{ border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:12px; }
  .goals-col[data-status="concluido"]{ background: rgba(22,163,74,.12); border-color: rgba(22,163,74,.35); }
  .goals-col[data-status="em-andamento"]{ background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.35); }
  .goals-col[data-status="nao-iniciado"]{ background: rgba(59,130,246,.12); border-color: rgba(59,130,246,.35); }
  .goals-col h3{ margin:0 0 10px; font-size:1rem; font-weight:800; color:#e2e8f0; border-bottom:2px solid rgba(255,255,255,.2); padding-bottom:8px; }
  .goals-list{ display:flex; flex-direction:column; gap:10px; }
  .goal-card{ border:1px solid rgba(255,255,255,.12); border-left:4px solid #64748b; background:rgba(255,255,255,.03); border-radius:10px; padding:10px 12px; cursor:pointer; transition:.2s ease; }
  .goal-card:hover{ transform:translateY(-2px); box-shadow:0 10px 24px rgba(0,0,0,.25); }
  .goal-title{ font-weight:800; color:#fff; margin:0 0 4px; font-size:.98rem; }
  .goal-meta{ font-size:.85rem; color:#cbd5f5; opacity:.9; display:flex; gap:8px; flex-wrap:wrap; }
  .goal-card.done{ border-left-color:#16a34a; }
  .goal-card.progress{ border-left-color:#f59e0b; }
  .goal-card.todo{ border-left-color:#3b82f6; }
  .goal-tag{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:.75rem; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); }
  @media(max-width:900px){ .goals-columns{ grid-template-columns:1fr; } }
</style>
</meta></head>
<body>
<div id="loadingScreen"><div class="loader"></div></div>
<button id="refreshBtn" title="Atualizar" onclick="location.reload()">‚ü≥</button>
<h1 class="site-logo"><img src="./logosite.svg" alt="Sa√∫de do Marketing" loading="lazy"/></h1>
<!-- LOGIN -->
<div aria-hidden="false" class="center-box" id="authArea">
<div class="auth-box">
<button class="btn" id="loginGoogle">Entrar com Google</button>
<div class="divider"></div>
<div class="field"><input autocomplete="username" class="input" id="email" placeholder="E-mail" type="email"/></div>
<div class="password-group" style="position:relative;margin:10px 0">
<input autocomplete="current-password" class="input" id="password" placeholder="Senha" style="padding-right:44px" type="password"/>
<span id="togglePassword" role="button" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;cursor:pointer;user-select:none;font-size:18px;line-height:1;color:var(--accent);" title="Mostrar/ocultar">üëÅ</span>
</div>
<button class="btn" id="loginEmail">Entrar com E-mail</button>
<button class="btn secondary" id="signupEmail">Criar Conta</button>
<p class="link" id="forgotPassword">Esqueci a senha</p>
<p id="status" style="font-size:.85rem;color:#bbb;margin:6px 0 0"></p>
</div>
</div>
<!-- √ÅREA LOGADA -->
<div aria-hidden="true" id="userArea">
  <div class="topbar">
    <div class="topbar-left">
      <div id="userInfo" class="user-info"></div>
      <div id="socialIcons" class="social-icons"></div>
    </div>
    <div class="right-tools">
      <div class="profile-area" id="profileArea" aria-hidden="true">
        <button type="button" class="profile-avatar" id="profileAvatar" aria-label="Adicionar logo do cliente" title="Adicionar logo do cliente">
          <img id="profileAvatarImg" alt="Logo do cliente" loading="lazy" />
          <span class="avatar-placeholder" id="profileAvatarPlaceholder">+</span>
        </button>
        <div class="profile-meta">
          <strong id="profileClientName"></strong>
          <small>Logo da marca</small>
        </div>
        <input type="file" id="profileAvatarInput" accept="image/*" hidden />
      </div>
      <button class="settings-tab" id="settingsToggle" type="button" aria-expanded="false" aria-controls="settingsPanel" title="Configura√ß√µes" aria-label="Abrir configura√ß√µes">‚öô</button>
      <div class="storage-usage hidden" id="storageUsage" role="status" aria-live="polite">
        <div class="storage-usage-header">
          <span class="storage-usage-title">Uso de armazenamento</span>
          <span class="storage-usage-percent" id="storageUsagePercent"></span>
        </div>
        <div aria-hidden="true" class="storage-usage-bar">
          <div class="storage-usage-fill" id="storageUsageFill"></div>
        </div>
        <div class="storage-usage-footer">
          <span class="storage-usage-summary" id="storageUsageSummary"></span>
          <span class="storage-usage-hint" id="storageUsageHint"></span>
        </div>
      </div>
      <div class="mini-total" data-tip="" id="totalCard">
        <span class="dot"></span><span class="total-score" id="totalScore">0</span><span class="total-sub">/100</span>
      </div>
      <button class="user-btn" id="logoutBtn">Sair</button>
    </div>
  </div>
  <div class="settings-panel" id="settingsPanel" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div class="settings-panel-inner">
      <aside class="settings-sidebar" id="settingsSidebar" aria-label="Se√ß√µes de configura√ß√µes">
        <div class="settings-sidebar-title">Configura√ß√µes</div>
        <button type="button" class="settings-nav-btn active" data-section="general">Geral</button>
        <button type="button" class="settings-nav-btn" data-section="clients">Gerenciar Clientes</button>
        <button type="button" class="settings-nav-btn" data-section="integrations">Integra√ß√µes</button>
  <button type="button" class="settings-nav-btn" data-section="users">Time</button>
        <button type="button" class="settings-nav-btn" data-section="plans">Planos</button>
        <button type="button" class="settings-nav-btn" data-section="preferences">Prefer√™ncias</button>
      </aside>
      <div class="settings-content">
        <header class="settings-content-header">
          <div>
            <h2 id="settingsTitle">Geral</h2>
            <p class="settings-subtitle" id="settingsSubtitle">Personalize as informa√ß√µes principais da sua conta.</p>
          </div>
          <button type="button" class="settings-close" id="settingsClose" aria-label="Fechar configura√ß√µes">√ó</button>
        </header>
        <div class="settings-mobile-nav" id="settingsMobileNav">
          <label for="settingsSectionSelect">Se√ß√£o</label>
          <select id="settingsSectionSelect" aria-label="Selecionar se√ß√£o de configura√ß√µes">
            <option value="general">Geral</option>
            <option value="clients">Gerenciar Clientes</option>
            <option value="integrations">Integra√ß√µes</option>
            <option value="users">Time</option>
            <option value="plans">Planos</option>
            <option value="preferences">Prefer√™ncias</option>
          </select>
        </div>
        <div class="settings-body" id="settingsBody"></div>
      </div>
    </div>
  </div>
  <div class="section-title">üß© Sa√∫de dos blocos</div>
  <div aria-hidden="true" class="header-calendar-bar" id="headerCalendarBar">
  <strong class="header-calendar-month" id="headerCalendarMonth"></strong>
  <div class="header-calendar-days" id="headerCalendarDays" role="list"></div>
</div>
<!-- ABAS -->
<div class="tabs-container" id="tabsContainer">
  <button class="menu-toggle" id="mainMenuToggle" type="button" aria-expanded="false" aria-haspopup="true" aria-controls="sectionTabs">‚ò∞ Menu</button>
  <div aria-label="Setores" class="tabs" id="sectionTabs" role="tablist"></div>
</div>
<section id="macroSection" data-section="macro">
  <div class="dashboard" id="dashboard"></div>
  <div class="macro-actions" id="macroActions" style="display:none">
    <div class="macro-insight-badges" id="macroBadges"></div>
  </div>
  <!-- GRID IFRAMES -->
  <div id="historyLegend"></div>
  <div id="historyControls"><label class="muted" for="historyMonthSelect">Meses:</label> <select id="historyMonthSelect" multiple></select></div>
  <canvas id="historyChart"></canvas>
</section>
<div class="widgets-grid" id="widgetsGrid"></div>
<!-- Refer√™ncias Redes -->
<div aria-hidden="true" class="refsocial-wrap" id="refSocialWrap" style="display:none">
  <div class="refsocial-top">
    <form id="refSocialForm" class="refsocial-form" data-mode="link">
      <div class="refsocial-mode" id="refSocialModeToggle" role="radiogroup">
        <button type="button" data-mode="link" class="active">Adicionar link</button>
        <button type="button" data-mode="upload">Enviar arquivo</button>
      </div>
      <div class="refsocial-grid">
        <label class="refsocial-field refsocial-field-link">
          <span>Link da refer√™ncia</span>
          <input type="url" id="refSocialLinkInput" placeholder="Cole o link do Instagram, YouTube ou TikTok" autocomplete="off" spellcheck="false">
        </label>
        <label class="refsocial-field refsocial-field-upload">
          <span>Arquivo da refer√™ncia</span>
          <input type="file" id="refSocialFile" accept="image/*,video/*">
        </label>
        <label class="refsocial-field">
          <span>Categoria</span>
          <select id="refSocialCategory">
            <option value="stories">Stories</option>
            <option value="feed">Feed</option>
            <option value="youtube">YouTube</option>
            <option value="banner">Banner</option>
            <option value="folder">Folder</option>
            <option value="an√∫ncios">An√∫ncios</option>
            <option value="outros">Outros</option>
          </select>
        </label>
      </div>
      <label class="refsocial-field">
        <span>Detalhes</span>
        <textarea id="refSocialDetails" placeholder="Detalhes do material"></textarea>
      </label>
      <div class="refsocial-link-preview" id="refSocialLinkPreview" data-state="empty">
        <p class="muted" style="margin:0">Cole um link para gerar a pr√©-visualiza√ß√£o.</p>
      </div>
      <div class="refsocial-submit">
        <button type="submit" class="btn small">Adicionar refer√™ncia</button>
      </div>
    </form>
  </div>
  <div id="refSocialList" class="refsocial-list"></div>
</div>
<!-- IA -->
<div aria-hidden="true" class="ia-wrap" id="iaWrap" style="display:none">
  <div class="ia-shell">
    <aside class="ia-sidebar">
      <div class="ia-sidebar-header">
        <button class="btn small" id="iaNewChat" type="button">Nova conversa</button>
      </div>
      <div class="ia-sidebar-search">
        <input type="text" class="input" id="iaChatSearch" placeholder="Buscar conversas">
      </div>
      <div class="ia-sidebar-content">
        <div class="ia-chat-list" id="iaChatList"></div>
        <details class="ia-knowledge" id="iaKnowledge">
          <summary>
            <span>üìÑ Documentos para a IA</span>
            <span class="ia-doc-count" id="iaDocsCount">0</span>
          </summary>
          <div class="ia-knowledge-content">
            <p>Envie arquivos de texto, planilhas ou documentos para treinar o contexto da IA deste cliente. Cada arquivo ser√° convertido para TXT automaticamente.</p>
            <div class="ia-docs-actions">
              <input type="file" id="iaDocsInput" multiple accept=".txt,.md,.csv,.tsv,.json,.doc,.docx,.odt,.rtf,.xls,.xlsx,.ods,.pdf,.ppt,.pptx,.xml,.html,.htm" style="display:none">
              <button class="btn small" id="iaDocsPick" type="button">Selecionar arquivos</button>
              <button class="btn ghost small" id="iaDocsUpload" type="button">Enviar</button>
            </div>
            <div class="ia-docs-status" id="iaDocsStatus">Nenhum arquivo selecionado.</div>
            <div class="ia-docs-list" id="iaDocsList"></div>
          </div>
        </details>
      </div>
    </aside>
    <section class="ia-main">
      <header class="ia-main-head">
        <div class="ia-title" id="iaCurrentTitle">Selecione uma conversa</div>
        <div class="ia-main-actions">
          <button class="btn ghost small" id="iaRenameChat" type="button">Renomear</button>
          <button class="btn ghost small danger" id="iaDeleteChat" type="button">Excluir</button>
        </div>
      </header>
      <div class="ia-history" id="iaHistory"></div>
      <div class="ia-empty" id="iaEmptyState">Comece uma nova conversa ou escolha uma existente ao lado.</div>
      <form class="ia-composer" id="iaComposer">
        <textarea id="iaQuestion" class="input ia-input" rows="1" placeholder="Digite uma mensagem" autocomplete="off"></textarea>
        <button class="btn" id="iaSend" type="submit">Enviar</button>
        <p class="ia-source-note" id="iaSourceNote" aria-live="polite"></p>
      </form>
    </section>
  </div>
</div>
<!-- CAC -->
<style>
  .cac-wrap .cac-tables{display:flex;flex-wrap:wrap;gap:20px;margin-top:10px}
  .cac-wrap .cac-tables>div{flex:1}
  .cac-table{width:100%;border-collapse:collapse}
  .cac-table th,.cac-table td{border:1px solid var(--shell-border);padding:4px;font-size:.85rem}
  .cac-table th{background:var(--title-bg)}
  .cac-table input{width:100%;background:#1a1a1a;color:#fff;border:1px solid #333;border-radius:4px;padding:4px}
</style>
<div aria-hidden="true" class="cac-wrap" id="cacWrap" style="display:none">
  <div class="field">
    <label for="cacMonth">M√™s:</label>
    <select id="cacMonth" class="input">
      <option value="jan">Jan</option>
      <option value="fev">Fev</option>
      <option value="mar">Mar</option>
      <option value="abr">Abr</option>
      <option value="mai">Mai</option>
      <option value="jun">Jun</option>
      <option value="jul">Jul</option>
      <option value="ago">Ago</option>
      <option value="set">Set</option>
      <option value="out">Out</option>
      <option value="nov">Nov</option>
      <option value="dez">Dez</option>
    </select>
  </div>
  <div class="field">
    <label for="cacCurrency">Moeda:</label>
    <select id="cacCurrency" class="input">
      <option value="BRL">Real</option>
      <option value="USD">D√≥lar</option>
    </select>
  </div>
    <div class="cac-tables">
      <div>
        <table class="cac-table">
        <thead>
          <tr><th>Descri√ß√£o</th><th>Valor</th></tr>
        </thead>
        <tbody id="cacExpensesBody">
          <tr><td>Equipe Marketing</td><td><input type="number" step="0.01" class="expense"></td></tr>
          <tr><td>Equipe Vendas</td><td><input type="number" step="0.01" class="expense"></td></tr>
          <tr><td>Softwares</td><td><input type="number" step="0.01" class="expense"></td></tr>
          <tr><td>Verba de Tr√°fego</td><td><input type="number" step="0.01" class="expense" id="cacTraffic"></td></tr>
          <tr><td>Outros</td><td><input type="number" step="0.01" class="expense"></td></tr>
        </tbody>
      </table>
      <button class="btn small" id="addExpenseRow">Adicionar linha</button>
    </div>
    <div>
      <table class="cac-table">
        <thead>
          <tr><th>Descri√ß√£o</th><th>Valor</th></tr>
        </thead>
        <tbody>
          <tr><td>Qtde de Vendas</td><td><input type="number" step="1" id="cacSales" readonly></td></tr>
          <tr><td>Total Receita</td><td><input type="number" step="0.01" id="cacRevenue" readonly></td></tr>
          <tr><td>Ticket M√©dio</td><td><span id="cacTicket">-</span></td></tr>
        </tbody>
      </table>
    </div>
    <div>
      <table class="cac-table">
        <thead>
          <tr><th>Descri√ß√£o</th><th>Valor</th></tr>
        </thead>
        <tbody>
          <tr><td>Qtde de Vendas (Tr√°fego)</td><td><input type="number" step="1" id="cacSalesAds"></td></tr>
          <tr><td>Total Receita (Tr√°fego)</td><td><input type="number" step="0.01" id="cacRevenueAds"></td></tr>
          <tr><td>Ticket M√©dio (Tr√°fego)</td><td><span id="cacTicketAds">-</span></td></tr>
        </tbody>
      </table>
    </div>
  </div>
    <div class="cac-results">
      <p>CAC REAL: <span id="cacReal">-</span></p>
      <p>CAC publicit√°rios: <span id="cacAds">-</span></p>
    </div>
</div>
<!-- METAS -->
<div aria-hidden="true" class="metas-wrap" id="metasWrap" style="display:none">
  <div class="metas-toolbar">
    <button class="btn small" id="addMeta" type="button">Adicionar meta</button>
    <button class="btn small" id="sendMetasLink" type="button">Enviar link para cliente</button>
    <button class="btn small danger" id="clearMetas" type="button">Limpar tudo</button>
    <button class="btn small secondary" id="resetMetas" type="button">Resetar Metas</button>
  </div>
  <div id="metasSummary" class="metas-summary"></div>
  <div id="metasContainer"></div>
</div>
<!-- DEMANDAS -->
<div aria-hidden="true" class="demandas-wrap" id="demandasWrap" style="display:none">
  <div class="demandas-filters">
    <input type="text" id="demandaSearch" placeholder="Buscar...">
    <div class="demanda-month-filter" id="demandaMonthFilter">
      <div class="demanda-year-controls">
        <button class="demanda-year-btn" id="demandaYearPrev" type="button" aria-label="Ano anterior">‚óÄ</button>
        <span class="demanda-year-label" id="demandaYearLabel"></span>
        <button class="demanda-year-btn" id="demandaYearNext" type="button" aria-label="Pr√≥ximo ano">‚ñ∂</button>
      </div>
      <div class="demanda-month-buttons" id="demandaMonthButtons"></div>
    </div>
    <button class="btn small" id="addDemanda">Adicionar linha</button>
    <input type="url" id="demandasWebhook" placeholder="Webhook URL">
  </div>
  <div id="prazoAlert" class="prazo-alert" style="display:none">H√° demandas com per√≠odo vencido!</div>
  <div class="table-wrap">
    <table class="demandas-table" id="demandasTable">
      <thead>
        <tr>
          <th class="col-status">STATUS</th>
          <th class="col-tag">TAG</th>
          <th class="col-demanda">OBJETIVO</th>
          <th class="col-resp">RESPONS√ÅVEL</th>
          <th class="col-prazo">PER√çODO</th>
          <th class="del-cell"></th>
        </tr>
        <tr class="filter-row">
          <th class="col-status">
            <select id="demandaStatusColumnFilter">
              <option value="">Status</option>
              <option value="nao-iniciado">N√£o iniciado</option>
              <option value="em-andamento">Em andamento</option>
              <option value="bloqueado">Bloqueado</option>
              <option value="concluido">Conclu√≠do</option>
              <option value="prioridade">Prioridade</option>
              <option value="prioridade-grupo">Prioridade/Grupo</option>
              <option value="concluido-grupo">Conclu√≠do/Grupo</option>
            </select>
          </th>
          <th class="col-tag">
            <select id="demandaTagColumnFilter">
              <option value="">TAG</option>
              <option value="ROI">ROI</option>
              <option value="VITRINE/ENGAJAMENTO">VITRINE/ENGAJAMENTO</option>
              <option value="NOVAS IDEIAS">NOVAS IDEIAS</option>
              <option value="RELACIONAMENTO">RELACIONAMENTO</option>
              <option value="I.A">I.A</option>
              <option value="GOOGLE BUSINESS">GOOGLE BUSINESS</option>
            </select>
          </th>
          <th class="col-demanda">
            <input type="text" id="demandaObjetivoFilter" placeholder="Filtrar objetivo...">
          </th>
          <th class="col-resp">
            <select id="demandaResponsavelFilter">
              <option value="">Respons√°vel</option>
              <option value="Bruno">Bruno</option>
              <option value="Camilla">Camilla</option>
              <option value="Clailton">Clailton</option>
              <option value="Guilherme">Guilherme</option>
              <option value="Mediagrowth">Mediagrowth</option>
              <option value="Cliente">Cliente</option>
              <option value="Theo">Theo</option>
            </select>
          </th>
          <th class="col-prazo">
            <div class="demanda-period-filter">
              <input type="date" id="demandaPeriodoInicioFilter" aria-label="Filtrar per√≠odo inicial">
              <span>at√©</span>
              <input type="date" id="demandaPeriodoFimFilter" aria-label="Filtrar per√≠odo final">
            </div>
          </th>
          <th class="del-cell">
            <button type="button" id="demandaFilterClear" class="filter-clear-btn">Limpar</button>
          </th>
        </tr>
      </thead>
      <tbody id="demandasBody"></tbody>
  </table>
  </div>
  <section class="impedimentos-section" id="impedimentosSection">
    <div class="impedimentos-head">
      <div>
        <h3>Alertas de Impedimentos</h3>
        <p>Mapeie riscos que podem atrasar ou comprometer o planejamento e acompanhe o status de resolu√ß√£o.</p>
      </div>
      <button class="btn small secondary" id="addImpedimento" type="button">Adicionar linha</button>
    </div>
    <div class="table-wrap">
      <table class="impedimentos-table" id="impedimentosTable">
        <thead>
          <tr>
            <th aria-label="Indicador de aten√ß√£o" class="icon-col">&nbsp;</th>
            <th>Impedimento ou risco</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="impedimentosBody"></tbody>
      </table>
    </div>
    <div class="impedimentos-empty" id="impedimentosEmpty">Nenhum impedimento cadastrado no momento.</div>
  </section>
  <div class="demanda-ai-actions">
    <button class="btn small secondary" id="demandaObjectiveAIButton" type="button">Gerar Planejamento</button>
    <button class="btn small secondary" id="btnCopyPlanningLink" type="button">Copiar link do planejamento</button>
  </div>
  <div class="demanda-plans" id="demandaPlans"></div>
</div>
<!-- TR√ÅFEGO -->
<style id="trafego-css">
  .trafego-wrap{margin-left:var(--margin-left);margin-right:var(--margin-right);display:flex;flex-direction:column;gap:16px}
  .trafego-header{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
  .trafego-card{background:var(--panel);border:1px solid var(--shell-border);border-radius:16px;padding:16px;box-shadow:0 12px 28px rgba(0,0,0,.34);display:flex;flex-direction:column;gap:12px}
  .trafego-card h3{margin:0;font-size:1rem;font-weight:800;color:#fff}
  .trafego-card p{margin:0;font-size:.85rem;color:#94a3b8;line-height:1.4}
  .trafego-card textarea,.trafego-card input[type="text"],.trafego-card input[type="number"],.trafego-card input[type="search"],.trafego-card select{background:#111827;border:1px solid #334155;border-radius:10px;color:#f8fafc;padding:10px;font-size:.9rem;font-weight:600}
  .trafego-card textarea{resize:vertical;min-height:120px}
  .trafego-columns{display:grid;grid-template-columns:1fr;gap:16px}
  .trafego-columns .trafego-card{height:100%}
  .trafego-table-wrap{overflow:auto;border-radius:12px;border:1px solid rgba(148,163,184,.25)}
  .trafego-table{width:100%;border-collapse:collapse;min-width:720px;background:rgba(15,23,42,.55)}
  .trafego-table th,.trafego-table td{border:1px solid rgba(148,163,184,.22);padding:8px;font-size:.85rem;color:#e2e8f0;text-align:left}
  .trafego-table th{background:rgba(15,23,42,.75);font-size:.78rem;text-transform:uppercase;letter-spacing:.05em;font-weight:700;color:#cbd5f5}
  .trafego-table input[type="date"],.trafego-table input[type="number"],.trafego-table input[type="text"]{width:100%;background:#0f172a;border:1px solid #1f2937;border-radius:8px;color:#f8fafc;padding:6px 8px;font-size:.85rem}
  .trafego-table .trafego-roas,.trafego-table .trafego-cpl{font-weight:700;color:#38bdf8}
  .trafego-table .trafego-roas.negative{color:#f87171}
  .trafego-table .trafego-cpl{display:inline-flex;align-items:center;gap:6px}
  .trafego-add-row{align-self:flex-start}
  .trafego-add-row .btn{display:inline-flex;align-items:center;gap:6px}
  .trafego-demandas-actions{display:flex;justify-content:flex-end}
  .trafego-demandas-actions .btn{display:inline-flex;align-items:center;gap:6px}
  .trafego-demandas-table{width:100%;border-collapse:collapse;background:rgba(15,23,42,.55);min-width:640px}
  .trafego-demandas-table th,.trafego-demandas-table td{border:1px solid rgba(148,163,184,.22);padding:8px;font-size:.85rem;color:#e2e8f0}
  .trafego-demandas-table th{background:rgba(15,23,42,.75);font-size:.78rem;text-transform:uppercase;letter-spacing:.05em;font-weight:700;color:#cbd5f5}
  .trafego-demandas-table input,.trafego-demandas-table select{width:100%;background:#0f172a;border:1px solid #1f2937;border-radius:8px;color:#f8fafc;padding:6px 8px;font-size:.85rem}
  .trafego-demandas-table .trafego-remove-demand{background:#431407;border:1px solid rgba(248,113,113,.45);color:#fecaca;border-radius:8px;padding:4px 8px;font-size:.78rem;font-weight:700;cursor:pointer}
  .trafego-demandas-table .trafego-remove-demand:hover{background:#7f1d1d;color:#fff}
  .trafego-routine{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:8px}
  .trafego-routine label{display:flex;align-items:flex-start;gap:10px;font-size:.85rem;color:#e2e8f0}
  .trafego-routine input{margin-top:2px}
  .trafego-empty{font-size:.85rem;color:#94a3b8;background:rgba(148,163,184,.16);border:1px dashed rgba(148,163,184,.35);border-radius:12px;padding:12px;text-align:center}
  .trafego-campaigns-controls{display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end;justify-content:space-between}
  .trafego-campaigns-filters{display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end}
  .trafego-control-group{display:flex;flex-direction:column;gap:6px}
  .trafego-control-group label{font-size:.78rem;font-weight:700;color:#cbd5f5;text-transform:uppercase;letter-spacing:.06em}
  .trafego-campaigns-table{width:100%;border-collapse:collapse;background:rgba(15,23,42,.55);min-width:820px}
  .trafego-campaigns-table th,.trafego-campaigns-table td{border:1px solid rgba(148,163,184,.22);padding:8px;font-size:.85rem;color:#e2e8f0;text-align:left;vertical-align:top}
  .trafego-campaigns-table th{background:rgba(15,23,42,.75);font-size:.78rem;text-transform:uppercase;letter-spacing:.05em;font-weight:700;color:#cbd5f5}
  .trafego-campaigns-table textarea{width:100%;background:#0f172a;border:1px solid #1f2937;border-radius:8px;color:#f8fafc;padding:6px 8px;font-size:.85rem;resize:vertical;min-height:60px}
  .trafego-campaigns-table input[type="text"],.trafego-campaigns-table input[type="search"],.trafego-campaigns-table input[type="number"],.trafego-campaigns-table select{width:100%;background:#0f172a;border:1px solid #1f2937;border-radius:8px;color:#f8fafc;padding:6px 8px;font-size:.85rem}
  .trafego-campaigns-table select{min-width:150px}
  .trafego-campaigns-empty{margin-top:10px}
  .trafego-optimizations-card .trafego-table-wrap{margin-top:12px}
  .trafego-optimizations-controls{display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end;justify-content:space-between}
  .trafego-optimizations-filters{display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end}
  .trafego-optimizations-table{width:100%;border-collapse:collapse;background:rgba(15,23,42,.55);min-width:880px}
  .trafego-optimizations-table th,.trafego-optimizations-table td{border:1px solid rgba(148,163,184,.22);padding:8px;font-size:.85rem;color:#e2e8f0;text-align:left;vertical-align:top}
  .trafego-optimizations-table th{background:rgba(15,23,42,.75);font-size:.78rem;text-transform:uppercase;letter-spacing:.05em;font-weight:700;color:#cbd5f5}
  .trafego-optimizations-table input[type="text"],.trafego-optimizations-table input[type="search"],.trafego-optimizations-table input[type="number"],.trafego-optimizations-table input[type="date"],.trafego-optimizations-table select,.trafego-optimizations-table textarea{width:100%;background:#0f172a;border:1px solid #1f2937;border-radius:8px;color:#f8fafc;padding:6px 8px;font-size:.85rem}
  .trafego-optimizations-table textarea{min-height:54px;resize:vertical}
  .trafego-optimizations-table select[multiple]{min-height:54px;resize:vertical}
  .trafego-history-card{gap:14px}
  .trafego-history-controls{display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end}
  .trafego-history-table-wrap{max-height:260px;overflow:auto;border:1px solid rgba(148,163,184,.22);border-radius:12px;background:rgba(15,23,42,.55)}
  .trafego-history-table{width:100%;border-collapse:collapse;min-width:720px}
  .trafego-history-table th,.trafego-history-table td{padding:8px 10px;font-size:.85rem;color:#e2e8f0;text-align:left;border-bottom:1px solid rgba(148,163,184,.18);vertical-align:top}
  .trafego-history-table th{position:sticky;top:0;background:rgba(15,23,42,.92);font-size:.78rem;text-transform:uppercase;letter-spacing:.05em;font-weight:700;color:#cbd5f5;z-index:1}
  .trafego-history-table tr:last-child td{border-bottom:none}
  .trafego-history-table .trafego-history-meta{font-size:.75rem;color:#94a3b8;margin-top:4px}
  .trafego-history-empty{margin-top:6px}
  .trafego-progress{position:relative;height:28px;border-radius:10px;background:rgba(15,23,42,.65);overflow:hidden;border:1px solid rgba(148,163,184,.28);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.85rem;color:#e2e8f0}
  .trafego-progress-fill{position:absolute;inset:0;background:linear-gradient(120deg,rgba(59,130,246,.8),rgba(99,102,241,.85));background-size:200% 100%;animation:trafego-progress-stripes 1.2s linear infinite;transform-origin:left center;width:0%;transition:width .35s ease}
  .trafego-progress-label{position:relative;z-index:1;text-shadow:0 1px 2px rgba(15,23,42,.8)}
  .trafego-progress.is-due{border-color:rgba(248,113,113,.6);color:#fecaca}
  .trafego-progress.is-due .trafego-progress-fill{background:linear-gradient(120deg,rgba(248,113,113,.85),rgba(239,68,68,.9))}
  .trafego-progress.is-empty .trafego-progress-fill{animation:none}
  .trafego-optimizations-table .trafego-actions-cell{text-align:center}
  .trafego-save-optimization{min-width:92px}
  .trafego-save-optimization[disabled]{opacity:.7;cursor:wait}
  .trafego-history-table .trafego-history-actions{text-align:center}
  .trafego-history-remove{background:transparent;border:0;color:#fca5a5;cursor:pointer;font-size:1.05rem;line-height:1}
  .trafego-history-remove:focus{outline:2px solid rgba(248,113,113,.6);outline-offset:2px}
  .trafego-history-remove:hover{color:#f87171}
  @keyframes trafego-progress-stripes{0%{background-position:0 0}100%{background-position:-200% 0}}
  .trafego-optimizations-empty{margin-top:10px}
  @media(max-width:1024px){
    .trafego-columns{grid-template-columns:1fr;gap:14px}
  }
  @media(max-width:720px){
    .trafego-table{min-width:620px}
    .trafego-demandas-table{min-width:560px}
    .trafego-campaigns-table{min-width:620px}
  }
</style>
<div aria-hidden="true" class="trafego-wrap" id="trafegoWrap" style="display:none">
  <div class="trafego-columns">
    <div class="trafego-card trafego-optimizations-card">
      <h3>Otimiza√ß√£o</h3>
      <p>Monitore quando cada campanha precisa ser otimizada novamente e acompanhe o avan√ßo em rela√ß√£o ao intervalo definido.</p>
      <div class="trafego-optimizations-controls">
        <div class="trafego-optimizations-filters">
          <div class="trafego-control-group">
            <label for="trafegoOptimizationPlatformFilter">Plataforma</label>
            <select id="trafegoOptimizationPlatformFilter">
              <option value="all">Todas</option>
              <option value="meta">Meta</option>
              <option value="google">Google</option>
              <option value="tiktok">TikTok</option>
              <option value="linkedin">LinkedIn</option>
              <option value="pinterest">Pinterest</option>
            </select>
          </div>
          <div class="trafego-control-group">
            <label for="trafegoOptimizationRecurrenceFilter">Recorr√™ncia</label>
            <select id="trafegoOptimizationRecurrenceFilter">
              <option value="all">Todas</option>
              <option value="1-dia">1 dia</option>
              <option value="2-dias">2 dias</option>
              <option value="3-dias">3 dias</option>
              <option value="4-dias">4 dias</option>
              <option value="5-dias">5 dias</option>
              <option value="7-dias">7 dias</option>
              <option value="2-semanas">2 semanas</option>
              <option value="3-semanas">3 semanas</option>
              <option value="1-mes">1 m√™s</option>
              <option value="2-meses">2 meses</option>
            </select>
          </div>
          <div class="trafego-control-group">
            <label for="trafegoOptimizationSearch">Buscar campanha</label>
            <input id="trafegoOptimizationSearch" placeholder="Buscar por nome" type="search">
          </div>
        </div>
        <button class="btn small" id="trafegoAddOptimization" type="button">+ Nova linha</button>
      </div>
      <div class="trafego-table-wrap">
        <table class="trafego-optimizations-table">
          <thead>
            <tr>
              <th>Plataforma</th>
              <th>Nome da campanha</th>
              <th>Dias para pr√≥xima otimiza√ß√£o</th>
              <th>Observa√ß√£o</th>
              <th>√öltima otimiza√ß√£o</th>
              <th>Data da √∫ltima otimiza√ß√£o</th>
              <th>Recorr√™ncia</th>
              <th>Pr√≥xima otimiza√ß√£o</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="trafegoOptimizationsBody"></tbody>
        </table>
      </div>
      <div class="trafego-empty trafego-optimizations-empty" id="trafegoOptimizationsEmpty" style="display:none">Cadastre otimiza√ß√µes para acompanhar os prazos de revis√£o.</div>
    </div>
  </div>
  <div class="trafego-header">
    <div class="trafego-card trafego-history-card">
      <h3>Hist√≥rico de Otimiza√ß√µes</h3>
      <p>Visualize automaticamente os ajustes realizados nas campanhas e mantenha um hist√≥rico centralizado.</p>
      <div class="trafego-history-controls">
        <div class="trafego-control-group">
          <label for="trafegoHistoryPlatformFilter">Plataforma</label>
          <select id="trafegoHistoryPlatformFilter">
            <option value="all">Todas</option>
            <option value="meta">Meta</option>
            <option value="google">Google</option>
            <option value="tiktok">TikTok</option>
            <option value="linkedin">LinkedIn</option>
            <option value="pinterest">Pinterest</option>
          </select>
        </div>
        <div class="trafego-control-group">
          <label for="trafegoHistorySearch">Buscar campanha</label>
          <input id="trafegoHistorySearch" placeholder="Buscar por nome" type="search">
        </div>
      </div>
      <div class="trafego-history-table-wrap">
        <table class="trafego-history-table">
          <thead>
            <tr>
              <th>Plataforma</th>
              <th>Nome da campanha</th>
              <th>Observa√ß√£o</th>
              <th>√öltima otimiza√ß√£o</th>
              <th>Data da √∫ltima atualiza√ß√£o</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="trafegoHistoryBody"></tbody>
        </table>
      </div>
      <div class="trafego-empty trafego-history-empty" id="trafegoHistoryEmpty" style="display:none">Nenhum registro no hist√≥rico ainda.</div>
    </div>
  </div>
  <div class="trafego-columns">
    <div class="trafego-card">
      <h3>Demandas do time de tr√°fego</h3>
      <p>Organize ajustes, lan√ßamentos e itens cr√≠ticos para manter a performance crescendo.</p>
      <div class="trafego-table-wrap">
        <table class="trafego-demandas-table">
          <thead>
            <tr>
              <th>Campanha</th>
              <th>Objetivo</th>
              <th>Or√ßamento di√°rio</th>
              <th>Status</th>
              <th>Observa√ß√µes</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="trafegoDemandasBody"></tbody>
        </table>
      </div>
      <div class="trafego-demandas-actions">
        <button class="btn small" id="trafegoAddDemanda" type="button">Adicionar demanda</button>
      </div>
    </div>
  </div>
  <div class="trafego-columns">
    <div class="trafego-card">
      <h3>M√©tricas di√°rias</h3>
      <p>Controle o investimento, receita e ROAS para reagir rapidamente a oscila√ß√µes.</p>
      <div class="trafego-table-wrap">
        <table class="trafego-table">
          <thead>
            <tr>
              <th>Data</th>
              <th>Investimento</th>
              <th>Receita</th>
              <th>ROAS</th>
              <th>Leads/Vendas</th>
              <th>CPL</th>
              <th>Observa√ß√µes</th>
            </tr>
          </thead>
          <tbody id="trafegoMetricsBody"></tbody>
        </table>
      </div>
      <div class="trafego-add-row">
        <button class="btn small" id="trafegoAddMetricRow" type="button">Adicionar linha</button>
      </div>
    </div>
    <div class="trafego-card">
      <h3>Ideias de Campanhas</h3>
      <p>Mapeie propostas de campanhas com objetivos, p√∫blicos e status de valida√ß√£o.</p>
      <div class="trafego-campaigns-controls">
        <div class="trafego-campaigns-filters">
          <div class="trafego-control-group">
            <label for="trafegoCampaignStatusFilter">Status</label>
            <select id="trafegoCampaignStatusFilter">
              <option value="all">Todos</option>
              <option value="nao-testada">Ainda n√£o testada</option>
              <option value="ja-testada">J√° testada</option>
              <option value="aprovado">Aprovado pelo cliente</option>
              <option value="nao-aprovado">N√£o aprovado</option>
            </select>
          </div>
          <div class="trafego-control-group">
            <label for="trafegoCampaignSearch">Filtro r√°pido</label>
            <input id="trafegoCampaignSearch" placeholder="Buscar por nome, p√∫blico, copy..." type="search">
          </div>
        </div>
        <button class="btn small" id="trafegoAddCampaign" type="button">Adicionar campanha</button>
      </div>
      <div class="trafego-table-wrap">
        <table class="trafego-campaigns-table">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Or√ßamento</th>
              <th>Formato</th>
              <th>Observa√ß√£o</th>
              <th>P√∫blico</th>
              <th>Copy</th>
              <th>Objetivo</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="trafegoCampaignsBody"></tbody>
        </table>
      </div>
      <div class="trafego-empty trafego-campaigns-empty" id="trafegoCampaignsEmpty" style="display:none">Cadastre ideias de campanhas para organizar testes e alinhamentos com o cliente.</div>
    </div>
  </div>
</div>
<!-- ARQUIVOS -->
<div aria-hidden="true" class="files-wrap" id="filesWrap" style="display:none">
  <div class="files-layout">
    <aside aria-label="Pastas" class="files-sidebar">
      <div class="files-sidebar-head">
        <button class="btn small" id="newFolder" type="button">Nova pasta</button>
      </div>
      <div class="folder-tree" id="foldersList"></div>
    </aside>
    <section aria-label="Gerenciador de arquivos" class="files-main" id="filesPane">
      <div class="files-breadcrumb" id="filesBreadcrumb"></div>
      <div class="files-actions">
        <div class="left-actions">
          <button class="btn small" id="uploadFilesBtn" type="button">Adicionar arquivos</button>
          <input id="fileInput" multiple type="file">
          <button aria-pressed="false" class="btn small secondary" id="viewAllFilesBtn" type="button">Ver todos os arquivos</button>
        </div>
        <div aria-label="Alternar visualiza√ß√£o" class="files-view-toggle" id="filesViewToggle" role="group">
          <button aria-pressed="true" class="view-btn active" data-mode="list" type="button">Lista</button>
          <button aria-pressed="false" class="view-btn" data-mode="grid" type="button">√çcones</button>
        </div>
        <div class="files-select-tools">
          <label class="select-all-box" for="filesSelectAll">
            <input id="filesSelectAll" type="checkbox">
            <span>Selecionar todos</span>
          </label>
        </div>
        <div class="upload-progress hidden" id="uploadProgress" role="status" aria-live="polite">
          <span class="upload-progress-text" id="uploadProgressText"></span>
          <div class="upload-progress-track">
            <div class="upload-progress-fill" id="uploadProgressBar"></div>
          </div>
          <span class="upload-progress-percent" id="uploadProgressPercent"></span>
        </div>
      </div>
      <div class="files-empty" id="filesEmpty"></div>
      <div class="subfolders-grid hidden" id="subfoldersGrid"></div>
      <div class="files-list hidden" id="filesList"></div>
      <div class="files-bulk-bar hidden" id="filesBulkBar">
        <div class="files-bulk-info">
          <strong>A√ß√µes</strong>
          <span class="files-bulk-count" id="filesBulkCount"></span>
          <span class="files-bulk-status" id="filesBulkStatus"></span>
        </div>
        <div class="files-bulk-actions">
          <button class="btn small danger" data-action="delete" type="button">Excluir</button>
          <button class="btn small" data-action="move" type="button">Mover</button>
          <button class="btn small secondary" data-action="rename" type="button">Renomear</button>
          <button class="btn small ghost hidden" id="filesBulkUndo" type="button">Desfazer</button>
        </div>
      </div>
    </section>
  </div>
</div>
<div aria-hidden="true" class="modal" id="filePreviewModal">
  <div aria-modal="true" class="modal-card" role="dialog">
    <div class="modal-head">
      <strong id="filePreviewTitle">Pr√©-visualiza√ß√£o</strong>
      <button class="btn small secondary" id="filePreviewClose" type="button">Fechar</button>
    </div>
    <div class="modal-body file-preview-body">
      <div class="preview" id="filePreviewContent"></div>
      <div class="file-preview-info" id="filePreviewInfo"></div>
    </div>
  </div>
</div>
<!-- CONCORRENTES -->
<div aria-hidden="true" class="competitors-wrap" id="competitorsWrap" style="display:none">
  <div class="competitors-controls">
    <input type="text" id="competitorName" placeholder="Nome do concorrente">
    <input type="url" id="competitorLink" placeholder="Link">
    <input type="text" id="competitorTags" placeholder="Tags">
    <button class="btn small" id="addCompetitor">Adicionar</button>
  </div>
  <div class="table-wrap">
    <table class="competitors-table" id="competitorsTable">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Link</th>
          <th>Tags</th>
          <th class="del-cell"></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
<!-- NOTAS / ESTRAT√âGIAS -->
<div aria-hidden="true" class="notes-wrap" id="notesWrap" style="display:none">
<div class="note-toolbar">
<button class="tool" data-cmd="bold"><b>B</b></button>
<button class="tool" data-cmd="italic"><i>I</i></button>
<button class="tool" data-cmd="underline"><u>U</u></button>
<input class="tool" id="noteColor" title="Cor do texto" type="color" value="#ffffff"/>
<button class="tool" data-cmd="insertUnorderedList">‚Ä¢ Lista</button>
<button class="tool" data-cmd="insertOrderedList">1. Lista</button>
<button class="tool" data-cmd="formatBlock" data-value="H1">H1</button>
<button class="tool" data-cmd="formatBlock" data-value="H2">H2</button>
  <button class="tool" id="makeLink">üîó Link (texto)</button>
  <button class="tool" id="btnImg">üñºÔ∏è Imagem</button>
  <button class="tool" id="btnImgLink">üîó Link da imagem</button>
  <button class="tool" id="btnVideo">üé¨ V√≠deo</button>
  <button class="tool" id="btnVideoLink">üîó Link do v√≠deo</button>
  <input accept="image/*" id="imgInput" style="display:none" type="file"/>
  <input accept="video/*" id="videoInput" style="display:none" type="file"/>
  <span style="flex:1"></span>
<label>Nome (gerado automaticamente): <input id="noteTitle" placeholder="T√≠tulo gerado automaticamente" type="text"/></label>
<label>Setor:
          <select id="noteSector">
<option value="roi">ROI</option><option value="vitrine-engajamento">Vitrine/Engajamento</option>
<option value="novasideias">Novas Ideias</option><option value="relacionamento">Relacionamento</option>
<option value="ia">I.A</option><option value="gbp">Google Business Profile</option>
</select>
</label>
<label>Data (auto): <input id="noteDate" type="date"/></label>
<div class="note-template-actions">
  <select id="noteTemplateSelect" title="Templates salvos">
    <option value="">Selecionar template...</option>
  </select>
  <button class="btn small secondary" id="insertTemplateBtn" type="button" disabled>Inserir Template</button>
  <button class="btn small" id="saveTemplateBtn" type="button">Salvar como Template</button>
</div>
<span class="muted" id="noteAutoSaveStatus">Altera√ß√µes s√£o salvas automaticamente.</span>
<button class="btn small" id="newNoteBtn" type="button">Nova anota√ß√£o</button>
</div>
<div aria-label="Editor de notas" class="note-editor" contenteditable="true" id="noteEditor"></div>
<div class="note-toolbar" style="justify-content:space-between">
<div style="display:flex;gap:8px;align-items:center">
<strong>Filtrar:</strong>
<select id="filterSector">
<option value="">Todos</option>
<option value="roi">ROI</option><option value="vitrine-engajamento">Vitrine/Engajamento</option>
<option value="novasideias">Novas Ideias</option><option value="relacionamento">Relacionamento</option>
<option value="ia">I.A</option><option value="gbp">Google Business Profile</option>
</select>
<input id="filterFrom" title="De" type="date"/><input id="filterTo" title="At√©" type="date"/>
<button class="btn small" id="applyFilter">Aplicar</button>
<button class="btn small secondary" id="clearFilter">Limpar</button>
</div>
<div class="muted">Dica: cole prints com <b>Ctrl/‚åò+V</b>, redimensione e adicione link.</div>
</div>
<div class="notes-list" id="notesList"></div>
</div>
<!-- ACESSOS -->
<div aria-hidden="true" class="access-wrap" id="accessWrap" style="display:none">
  <div class="access-header">
    <div class="access-toolbar">
      <div class="access-search">
        <input id="accessSearch" placeholder="Buscar por nome, URL, usu√°rio ou tag..." type="text"/>
      </div>
      <div class="access-actions">
        <button class="btn small ghost" id="accessExport">Exportar CSV</button>
        <button class="btn small" id="accessAdd">+ Novo acesso</button>
      </div>
    </div>
    <div class="help-note">Clique em <b>üëÅ</b> para mostrar/ocultar senha ‚Ä¢ <span class="warn">Evite guardar senhas cr√≠ticas.</span></div>
  </div>
<div class="form-inline" id="accessForm" style="display:none">
<input id="fName" placeholder="Nome (ex: Instagram)"/>
<input id="fUrl" placeholder="URL (https://...)"/>
<input id="fUser" placeholder="Usu√°rio / E-mail"/>
<input id="fPass" placeholder="Senha"/>
<input id="fTags" placeholder="Tags (separe por v√≠rgula)"/>
<div class="actions">
<button class="btn small" id="fSave">Salvar</button>
<button class="btn small secondary" id="fCancel">Cancelar</button>
</div>
</div>
<div id="accessList"></div>
<div class="help-note">Voc√™ pode <b>editar</b>, <b>copiar</b> usu√°rio/senha, <b>abrir</b> o link e <b>filtrar</b> por tags.</div>
</div>
<!-- CALEND√ÅRIO / POSTS -->
<div aria-hidden="true" class="calendar-wrap" id="calendarWrap" style="display:none">
<div class="cal-toolbar">
<strong>Cadastro de Post</strong>
<input id="calDate" title="Data do post" type="date"/>
<input id="calDesc" placeholder="Descri√ß√£o do post (legenda/observa√ß√µes)" style="min-width:260px" type="text"/>
<input accept="image/*,video/*" id="calFiles" multiple="" type="file"/>
<select id="calTarget">
  <option value="feed">Feed</option>
  <option value="stories">Stories</option>
</select>
<button class="btn small" id="calUpload" type="button">Enviar</button>
<button class="btn small secondary" id="btnShareCalendar" type="button">Compartilhar calend√°rio</button>
<input id="calendarWebhook" placeholder="Webhook URL" type="url" style="min-width:220px"/>
<div class="cal-google-sync" id="googleCalendarSync">
  <button class="btn small secondary" id="googleCalendarConnect" type="button">Conectar Google Calendar</button>
  <button class="btn small ghost" id="googleCalendarDisconnect" style="display:none" type="button">Desconectar</button>
  <span class="status muted" id="googleCalendarStatus">N√£o conectado.</span>
</div>
<span class="muted">Dica: voc√™ pode selecionar v√°rias imagens/v√≠deos para um carrossel.</span>
</div>
<div style="display:flex; justify-content:space-between; align-items:center; gap:10px">
<div class="cal-legend">
<span><span class="cal-badge b-pendente"></span>Pendente</span>
<span><span class="cal-badge b-aprovado"></span>Aprovado (cliente)</span>
<span><span class="cal-badge b-aprovado-interno"></span>Aprovado (time interno)</span>
<span><span class="cal-badge b-revisar"></span>Revisar</span>
</div>
<div class="cal-filters">
<label>Status:
            <select id="calFilterStatus">
<option value="">Todos</option>
<option value="pendente">Pendente</option>
<option value="aprovado">Aprovado</option>
<option value="revisar">Revisar</option>
</select>
</label>
<label>Pa√≠s:
  <select id="calFilterCountry">
    <option value="">Todos</option>
    <option value="BR">Brasil</option>
    <option value="US">Estados Unidos</option>
    <option value="notes">Anota√ß√µes</option>
  </select>
</label>
<label>Busca:
  <input id="calFilterText" type="text" placeholder="Filtrar feriados"/>
</label>
</div>
</div>
<div class="calendar">
<div class="cal-head">
<div class="nav"><button id="calPrev">&lt;</button></div>
<div class="cal-title" id="calTitle">M√™s Ano</div>
<div class="nav"><button id="calNext">&gt;</button></div>
</div>
<div class="cal-grid" id="calWeekdays"></div>
<div class="cal-grid" id="calDays"></div>
</div>
<div class="insta-preview">
  <div class="insta-phone">
    <div class="insta-stories-wrapper">
      <button class="stories-arrow left" id="storiesPrev">&#8249;</button>
      <div class="insta-stories" id="storiesGrid"></div>
      <button class="stories-arrow right" id="storiesNext">&#8250;</button>
    </div>
    <div class="insta-feed" id="feedGrid"></div>
  </div>
</div>
<div aria-live="polite" class="calendar-demandas-mobile" id="calendarDemandasMobile"></div>
<!-- Hist√≥rico de observa√ß√µes do cliente (fora do pop-up) -->
<div class="notes-block" id="clientNotesPanelWrap" style="margin-top:10px">
<label class="muted" style="display:block; margin:6px 0">Hist√≥rico do cliente (observa√ß√µes)</label>
<div class="notes-list" id="clientNotesPanel"><div class="muted">Abra um post para ver o hist√≥rico.</div></div>
</div>
</div>
<!-- Modal de Post -->
<div aria-hidden="true" class="modal" id="postModal">
<div aria-modal="true" class="modal-card" role="dialog">
<div class="modal-head">
<strong id="modalTitle">Post</strong>
<button class="btn small secondary" id="modalClose">Fechar</button>
</div>
<div class="modal-body">
<div class="preview" id="modalPreview"></div>
<div aria-live="polite" id="clientNotesList"></div>
<div class="info">
<div style="display:flex; gap:8px; align-items:center; margin-bottom:8px">
<span class="muted">Data:</span> <span id="modalDate" style="font-weight:800"></span>
<span class="muted" style="margin-left:10px">Status:</span> <span class="status-pill status-pendente" id="modalStatus">pendente</span>
<span class="muted" style="margin-left:10px">Destino:</span>
<select id="modalTarget">
  <option value="feed">Feed</option>
  <option value="stories">Stories</option>
</select>
</div>
<label class="muted" style="display:block; margin:6px 0">Descri√ß√£o</label>
<textarea id="modalDesc"></textarea>
<div class="notes-block">
<label class="muted" style="display:block; margin:6px 0">Observa√ß√µes do cliente</label>
<div class="notes-list" id="notesList"></div>
</div>
</div>
</div>
<div class="modal-foot">
<button class="btn small" id="btnReview">Pedir revis√£o</button>
<button class="btn small" id="btnApprove">Aprova√ß√£o do cliente</button>
<button class="btn small" id="btnApproveInternal">Aprova√ß√£o interna</button>
<button class="btn small secondary" id="btnCopyApprovalLink">Copiar link de aprova√ß√£o</button>
<button class="btn small secondary" id="btnSave" title="Salvar altera√ß√µes de descri√ß√£o">Salvar</button>
<button class="btn small secondary" id="btnDelete" title="Excluir post">Excluir</button>
</div>
</div>
</div>
<p class="muted" id="iframedica" style="display:none">Dica: d√™ <b>duplo clique</b> em um painel para editar t√≠tulo e link.</p>
</div>
<!-- BRIEFING DO CLIENTE -->
<div aria-hidden="true" class="notes-wrap" id="briefWrap" style="display:none">
<!-- Toolbar for webhook & save -->
<div class="brief-toolbar" style="gap:10px; align-items:flex-start">
<div class="brief-toolbar-main">
<strong>Briefing do Cliente</strong>
<button class="btn small" id="briefSave">Salvar</button>
<div class="brief-webhook-area brief-webhook-controls">
<button class="btn small secondary" id="briefImportJson" title="Colar JSON de um formul√°rio">Importar JSON</button>
<input id="briefWebhookUrl" placeholder="Webhook URL (POST)" style="min-width:280px" type="text"/>
<button class="btn small" id="briefSendWebhook">Enviar Webhook</button>
</div>
</div>
<div class="muted brief-webhook-area">As respostas abaixo s√£o edit√°veis. Voc√™ pode importar dados (JSON) de um Google Forms/Make/Zapier e tamb√©m enviar via webhook.</div>
</div>
<!-- Bloco de notas -->
<label class="muted" style="margin:6px 2px; display:block">Bloco de notas (texto livre)</label>
<div class="brief-note-actions" style="display:flex; justify-content:flex-end; margin:4px 2px 8px; gap:8px">
  <button class="btn small secondary" id="briefCopy" type="button">Copiar briefing</button>
  <button class="btn small" id="briefGenerateAI" type="button">Gerar Briefing com I.A</button>
</div>
<textarea class="input" id="briefText" style="min-height:220px; resize:vertical"></textarea>
<!-- Respostas estruturadas (webhook-ready) -->
<div class="brief-toolbar" style="margin-top:10px">
<strong>Respostas do Briefing (edit√°veis + webhook-ready)</strong>
</div>
<div id="briefForm" style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
<!-- EMPRESA -->
<div><label>1. Nome da empresa*<br/><input class="input" id="q1" placeholder="" type="text"/></label></div>
<div><label>2. Cidade e estado*<br/><input class="input" id="q2" placeholder="" type="text"/></label></div>
<div><label>3. Cidades principais de atua√ß√£o*<br/><input class="input" id="q3" placeholder="" type="text"/></label></div>
<div style="grid-column:1 / -1"><label>4. Descri√ß√£o detalhada (1 frase)<br/><textarea class="input" id="q4" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>5. Servi√ßos/produtos*<br/><textarea class="input" id="q5" style="min-height:90px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>6. Como entregam (ex: loja f√≠sica, or√ßamento gratuito, etc.)<br/><input class="input" id="q6" type="text"/></label></div>
<div><label>7. Slogan/frase de efeito*<br/><input class="input" id="q7" type="text"/></label></div>
<div><label>8. Dias e hor√°rios de funcionamento<br/><input class="input" id="q8" placeholder="Seg a Sex 9h‚Äì18h, S√°b 9h‚Äì13h" type="text"/></label></div>
<!-- DIFERENCIAIS -->
<div style="grid-column:1 / -1"><label>9. Diferenciais (3 itens)<br/><textarea class="input" id="q9" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>10. Tecnologia/atendimento/experi√™ncia superior<br/><textarea class="input" id="q10" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>11. 3 empresas refer√™ncia/inspira√ß√£o<br/><input class="input" id="q11" placeholder="Marca A, Marca B, Marca C" type="text"/></label></div>
<!-- P√öBLICO-ALVO -->
<div style="grid-column:1 / -1"><label>12. Cliente ideal (idade, profiss√£o, regi√£o...)<br/><textarea class="input" id="q12" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>13. Dores/problemas antes de contratar<br/><textarea class="input" id="q13" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>14. Desejos/resultados esperados<br/><textarea class="input" id="q14" style="min-height:70px"></textarea></label></div>
<div><label>15. Tom de abordagem preferido<br/><input class="input" id="q15" placeholder="formal, direto, descontra√≠do..." type="text"/></label></div>
<!-- M√âTRICAS -->
<div><label>16. Ticket m√©dio*<br/><input class="input" id="q16" type="text"/></label></div>
<div><label>17. Taxa de convers√£o (or√ßamento‚Üívenda)<br/><input class="input" id="q17" placeholder="Ex: 3/10" type="text"/></label></div>
<div><label>18. Faturamento m√©dio mensal<br/><input class="input" id="q18" type="text"/></label></div>
<div><label>19. Meta de crescimento (6 meses)<br/><input class="input" id="q19" type="text"/></label></div>
<div><label>20. Promo√ß√µes atuais<br/><input class="input" id="q20" type="text"/></label></div>
<div><label>21. Pacotes/planos/condi√ß√µes especiais<br/><input class="input" id="q21" type="text"/></label></div>
<div><label>22. Sazonalidade (vende mais quando?)<br/><input class="input" id="q22" type="text"/></label></div>
<div><label>23. Per√≠odos fracos<br/><input class="input" id="q23" type="text"/></label></div>
<!-- REDES SOCIAIS -->
<div style="grid-column:1 / -1"><label>24. O que mais chama aten√ß√£o nas redes<br/><textarea class="input" id="q24" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>25. Conte√∫do que deseja publicar<br/><textarea class="input" id="q25" style="min-height:70px"></textarea></label></div>
<!-- MATRIZ CDT -->
<div style="grid-column:1 / -1"><label>26. Caracter√≠sticas (3 a 5)<br/><textarea class="input" id="q26" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>27. Dores/frustra√ß√µes antes de contratar<br/><textarea class="input" id="q27" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>28. Transforma√ß√£o ap√≥s contratar<br/><textarea class="input" id="q28" style="min-height:70px"></textarea></label></div>
<!-- PUV -->
<div style="grid-column:1 / -1"><label>29. Se sumisse do mercado, o que fariam falta?<br/><textarea class="input" id="q29" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>30. O que promete e cumpre como ningu√©m<br/><textarea class="input" id="q30" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>31. Como quer ser lembrado<br/><textarea class="input" id="q31" style="min-height:70px"></textarea></label></div>
<!-- VIS√ÉO -->
<div><label>32. Onde quer estar em 1 ano<br/><input class="input" id="q32" type="text"/></label></div>
<div><label>33. Principais desafios<br/><input class="input" id="q33" type="text"/></label></div>
<!-- Observa√ß√µes -->
<div style="grid-column:1 / -1"><label>34. Observa√ß√µes gerais<br/><textarea class="input" id="q34" style="min-height:70px"></textarea></label></div>
<!-- NOVAS PERGUNTAS DO BRIEFING -->
<div style="grid-column:1 / -1"><label>35. Sobre o cliente e o neg√≥cio ‚Äì PlayBook<br/><input class="input" id="q35" placeholder="Link ou observa√ß√µes sobre o playbook" type="text"/></label></div>
<div style="grid-column:1 / -1"><label>36. Miss√£o e valores da empresa<br/><textarea class="input" id="q36" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>37. Produtos/servi√ßos e Core Business<br/><textarea class="input" id="q37" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>38. P√∫blico-alvo ideal (ICP/Persona)<br/><textarea class="input" id="q38" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>39. Diferenciais da marca<br/><textarea class="input" id="q39" style="min-height:70px"></textarea></label></div>
<!-- OBJETIVOS DO PROJETO -->
<div style="grid-column:1 / -1"><label>40. J√° existe um planejamento da atua√ß√£o?<br/><textarea class="input" id="q40" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>41. Principal objetivo com este trabalho<br/><textarea class="input" id="q41" style="min-height:70px" placeholder="Ex: atrair leads, vender mais, posicionar a marca"></textarea></label></div>
<div style="grid-column:1 / -1"><label>42. Metas espec√≠ficas a alcan√ßar<br/><textarea class="input" id="q42" style="min-height:70px"></textarea></label></div>
<div><label>43. Prazo ideal para ver resultados<br/><input class="input" id="q43" type="text"/></label></div>
<!-- IDENTIDADE E COMUNICA√á√ÉO -->
<div><label>44. Manual da marca dispon√≠vel?<br/><input class="input" id="q44" placeholder="Link ou localiza√ß√£o do manual" type="text"/></label></div>
<div style="grid-column:1 / -1"><label>45. Tom de voz ou linguagem espec√≠fica<br/><textarea class="input" id="q45" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>46. Refer√™ncias de marcas ou campanhas<br/><textarea class="input" id="q46" style="min-height:70px"></textarea></label></div>
<!-- CONCORR√äNCIA E MERCADO -->
<div style="grid-column:1 / -1"><label>47. Principais concorrentes<br/><textarea class="input" id="q47" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>48. O que admira ou deseja evitar no mercado<br/><textarea class="input" id="q48" style="min-height:70px"></textarea></label></div>
<!-- PRESEN√áA DIGITAL ATUAL -->
<div style="grid-column:1 / -1"><label>49. Canais em que a marca est√° presente<br/><textarea class="input" id="q49" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>50. Canais que funcionam melhor atualmente<br/><textarea class="input" id="q50" style="min-height:70px"></textarea></label></div>
<div style="grid-column:1 / -1"><label>51. O que manter ou mudar na presen√ßa digital<br/><textarea class="input" id="q51" style="min-height:70px"></textarea></label></div>
<!-- INVESTIMENTO E RECURSOS -->
<div><label>52. Or√ßamento dispon√≠vel<br/><input class="input" id="q52" type="text"/></label></div>
<div style="grid-column:1 / -1"><label>53. Equipe interna ou parceiros envolvidos<br/><textarea class="input" id="q53" style="min-height:70px"></textarea></label></div>
<!-- ENTREG√ÅVEIS -->
<div><label>54. Frequ√™ncia esperada de entregas/resultados<br/><input class="input" id="q54" type="text"/></label></div>
<div><label>55. Ponto de contato direto<br/><input class="input" id="q55" type="text"/></label></div>
<div style="grid-column:1 / -1"><label>56. Aprova√ß√£o dos materiais<br/><textarea class="input" id="q56" style="min-height:70px" placeholder="Descreva como ser√° o fluxo de aprova√ß√£o"></textarea></label></div>
</div>
<!-- IFRAME -->
<div class="brief-toolbar" style="margin-top:12px; align-items:center; gap:8px">
<strong>Iframe do Briefing</strong>
<input class="input" id="briefIframeUrl" placeholder="Cole o link (https://...)" style="min-width:320px" type="text"/>
<button class="btn small" id="briefApplyIframe">Aplicar</button>
</div>
<div class="frame-shell" id="briefFrameShell" style="height:600px">
<iframe class="widget-iframe" id="briefIframe" loading="lazy" referrerpolicy="no-referrer" sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox" title="Briefing Iframe"></iframe>
</div>
</div>
<!-- RELAT√ìRIO -->
<div aria-hidden="true" class="relatorio-wrap" id="relatorioWrap" style="display:none">
  <div class="relatorio-container">
    <div class="relatorio-header">
      <h2>Relat√≥rio Consolidado</h2>
      <p class="relatorio-subtitle">Visualize e exporte relat√≥rios completos do desempenho do cliente</p>
    </div>
    
    <div class="relatorio-filters">
      <div class="relatorio-filter-group">
        <label for="relatorioMes">üìÖ Selecione o M√™s:</label>
        <input type="month" id="relatorioMes" class="input" />
      </div>
      <button type="button" id="relatorioGerar" class="btn">üìä Gerar Relat√≥rio</button>
      <button type="button" id="relatorioExportar" class="btn secondary">‚¨á Exportar PDF</button>
    </div>
    
    <div class="relatorio-preview" id="relatorioPreview">
      <div class="relatorio-empty">
        <p>üìã Selecione um m√™s e clique em "Gerar Relat√≥rio" para visualizar os dados</p>
      </div>
    </div>
  </div>

  <!-- Carrossel de Stories -->
  <div class="relatorio-container" id="relatorioStoriesSection" style="display:none">
    <div class="relatorio-header">
      <h2>üì± Stories Produzidos</h2>
      <p class="relatorio-subtitle" id="relatorioStoriesSubtitle">Stories criados pelo time de marketing</p>
    </div>
    
    <div class="relatorio-stories-carousel">
      <button type="button" class="carousel-nav carousel-prev" id="relatorioStoriesPrev">‚Äπ</button>
      <div class="relatorio-stories-grid" id="relatorioStoriesGrid">
        <div class="relatorio-stories-empty">
          <p>Nenhum story encontrado para este per√≠odo</p>
        </div>
      </div>
      <button type="button" class="carousel-nav carousel-next" id="relatorioStoriesNext">‚Ä∫</button>
    </div>
    <p class="relatorio-desc" id="relatorioStoriesDesc" style="display:none"></p>
  </div>

  <!-- Carrossel de Posts (Feed) -->
  <div class="relatorio-container" id="relatorioPostsSection" style="display:none">
    <div class="relatorio-header">
      <h2>üì∞ Posts Produzidos</h2>
      <p class="relatorio-subtitle" id="relatorioPostsSubtitle">Posts de feed criados pelo time de marketing</p>
    </div>

    <div class="relatorio-stories-carousel">
      <button type="button" class="carousel-nav carousel-prev" id="relatorioPostsPrev">‚Äπ</button>
      <div class="relatorio-stories-grid" id="relatorioPostsGrid">
        <div class="relatorio-stories-empty">
          <p>Nenhum post de feed encontrado para este per√≠odo</p>
        </div>
      </div>
      <button type="button" class="carousel-nav carousel-next" id="relatorioPostsNext">‚Ä∫</button>
    </div>
    <p class="relatorio-desc" id="relatorioPostsDesc" style="display:none"></p>
  </div>

  <!-- Objetivos do m√™s (Planejamento) -->
  <div class="relatorio-container" id="relatorioGoalsSection" style="display:none">
    <div class="relatorio-header">
      <h2>üéØ Objetivos do m√™s</h2>
      <p class="relatorio-subtitle" id="relatorioGoalsSubtitle">Status das demandas do Planejamento no m√™s selecionado</p>
    </div>
    
    <div class="relatorio-goals-summary">
      <div class="goal-pill goal-done" id="relatorioGoalsDonePill">Conclu√≠dos: <strong>-</strong></div>
      <div class="goal-pill goal-progress" id="relatorioGoalsProgressPill">Em andamento: <strong>-</strong></div>
      <div class="goal-pill goal-todo" id="relatorioGoalsTodoPill">N√£o iniciados: <strong>-</strong></div>
      <button type="button" class="btn small secondary" id="relatorioGoalsClearFilter">Limpar filtro</button>
    </div>

    <div class="goals-columns" id="relatorioGoalsColumns">
      <div class="goals-col" data-status="concluido">
        <h3>Conclu√≠dos</h3>
        <div class="goals-list" id="relatorioGoalsDone"></div>
      </div>
      <div class="goals-col" data-status="em-andamento">
        <h3>Em andamento</h3>
        <div class="goals-list" id="relatorioGoalsProgress"></div>
      </div>
      <div class="goals-col" data-status="nao-iniciado">
        <h3>N√£o iniciados</h3>
        <div class="goals-list" id="relatorioGoalsTodo"></div>
      </div>
    </div>
    <p class="relatorio-desc" id="relatorioGoalsDesc"></p>
    
  </div>

  <!-- Relat√≥rio de Metas do m√™s -->
  <div class="relatorio-container" id="relatorioMetasSection" style="display:none">
    <div class="relatorio-header">
      <h2>üìà Metas do m√™s</h2>
      <p class="relatorio-subtitle" id="relatorioMetasSubtitle">Metas ativas (aba Metas) no m√™s selecionado</p>
    </div>

    <div class="relatorio-goals-summary">
      <div class="goal-pill goal-done" id="relatorioMetasAchievedPill">Atingidas: <strong>-</strong></div>
      <div class="goal-pill goal-progress" id="relatorioMetasProgressPill">Em andamento: <strong>-</strong></div>
      <div class="goal-pill goal-todo" id="relatorioMetasMissingPill">Precisa colocar: <strong>-</strong></div>
      <button type="button" class="btn small secondary" id="relatorioMetasClearFilter">Limpar filtro</button>
    </div>

    <div class="goals-columns" id="relatorioMetasColumns">
      <div class="goals-col" data-status="concluido">
        <h3>Atingidas</h3>
        <div class="goals-list" id="relatorioMetasAchieved"></div>
      </div>
      <div class="goals-col" data-status="em-andamento">
        <h3>Em andamento</h3>
        <div class="goals-list" id="relatorioMetasProgress"></div>
      </div>
      <div class="goals-col" data-status="nao-iniciado">
        <h3>Precisa colocar</h3>
        <div class="goals-list" id="relatorioMetasMissing"></div>
      </div>
    </div>
    <p class="relatorio-desc" id="relatorioMetasDesc"></p>
    
  </div>
  
  <!-- Relat√≥rio de redes trabalhadas (apenas redes com link configurado) -->
  <div class="relatorio-container" id="relatorioRedesSection" style="display:none">
    <div class="relatorio-header">
      <h2>üîó Redes trabalhadas no m√™s</h2>
      <p class="relatorio-subtitle" id="relatorioRedesSubtitle">Listagem das redes com link configurado (aba Macro)</p>
    </div>
    <div class="macro-social-grid" id="relatorioRedesGrid"></div>
    <p class="relatorio-desc" id="relatorioRedesDesc"></p>
  </div>
</div>
<!-- Firebase + App -->
<script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged,
      signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail,
      setPersistence, browserLocalPersistence, inMemoryPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getStorage, ref as sRef, uploadBytes, uploadBytesResumable, getDownloadURL, deleteObject, getMetadata } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";
    import { getFirestore, doc, setDoc, getDoc, getDocs, collection, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, where, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-functions.js";

    /* ========= helpers ========= */
    function mountEmbed(shell, html){
      if(!shell) return;
      shell.innerHTML = html || "";
      const scripts = Array.from(shell.querySelectorAll("script"));
      scripts.forEach(oldS => {
        const s = document.createElement("script");
        for(const attr of Array.from(oldS.attributes||[])){ s.setAttribute(attr.name, attr.value); }
        s.textContent = oldS.textContent || "";
        oldS.parentNode.replaceChild(s, oldS);
      });
    }
    const uuid = ()=> crypto.randomUUID ? crypto.randomUUID() : ('id-'+Math.random().toString(36).slice(2)+Date.now());
function mgToast(msg){ try{ const el=document.createElement('div'); el.className='mg-toast'; el.textContent=msg; document.body.appendChild(el); setTimeout(()=>{ el.remove(); }, 3000);}catch(_){} }

    const __scriptLoadCache = new Map();
    function loadExternalScript(src, check){
      if(typeof check === 'function'){
        try{
          if(check()){
            return Promise.resolve();
          }
        }catch(_err){}
      }
      if(__scriptLoadCache.has(src)){
        return __scriptLoadCache.get(src);
      }
      const promise = new Promise((resolve, reject)=>{
        try{
          if(typeof check === 'function'){
            try{
              if(check()){
                resolve();
                return;
              }
            }catch(_){ }
          }
          const existing = Array.from(document.getElementsByTagName('script')).find(el=> el.src === src);
          if(existing){
            if(typeof check === 'function'){
              try{
                if(check()){
                  resolve();
                  return;
                }
              }catch(_){ }
            }
            existing.addEventListener('load', ()=> resolve());
            existing.addEventListener('error', ()=> reject(new Error(`Falha ao carregar ${src}`)));
            return;
          }
          const script = document.createElement('script');
          script.src = src;
          script.async = true;
          script.defer = true;
          script.onload = ()=> resolve();
          script.onerror = ()=> reject(new Error(`Falha ao carregar ${src}`));
          document.head.appendChild(script);
        }catch(err){
          reject(err);
        }
      });
      __scriptLoadCache.set(src, promise);
      return promise;
    }

    const GOOGLE_CALENDAR_SCOPES = 'https://www.googleapis.com/auth/calendar https://www.googleapis.com/auth/userinfo.email';
    const GOOGLE_CALENDAR_DISCOVERY_URL = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';

    const googleCalendarIntegration = (()=>{
      const state = {
        connectBtn: null,
        disconnectBtn: null,
        statusEl: null,
        clientId: '',
        calendarId: 'primary',
        tokenClient: null,
        tokenClientClientId: '',
        accessToken: null,
        tokenExpiresAt: 0,
        email: '',
        connected: false,
        loading: false,
        statusMessage: '',
        loadError: null,
        activeRequests: 0,
        syncing: false,
        posts: [],
        pendingCreates: {},
        pendingUpdates: {},
        pendingDeletes: {},
        processingPending: false
      };
      let googleApisPromise = null;

      function copyPost(post){
        if(!post) return null;
        const clone = { ...post };
        if(Array.isArray(post.mediaUrls)) clone.mediaUrls = [...post.mediaUrls];
        if(Array.isArray(post.reviewNotes)) clone.reviewNotes = [...post.reviewNotes];
        if(Array.isArray(post.approvedSlides)) clone.approvedSlides = [...post.approvedSlides];
        if(Array.isArray(post.internalApprovedSlides)) clone.internalApprovedSlides = [...post.internalApprovedSlides];
        return clone;
      }

      function beginSync(){
        state.activeRequests += 1;
        state.syncing = state.activeRequests > 0;
        updateUi();
      }
      function endSync(){
        state.activeRequests = Math.max(0, state.activeRequests - 1);
        state.syncing = state.activeRequests > 0;
        updateUi();
      }

      function updateUi(){
        if(state.connectBtn){
          state.connectBtn.disabled = state.loading || (!state.connected && !state.clientId);
          state.connectBtn.textContent = state.connected ? (state.loading ? 'Conectando...' : 'Atualizar conex√£o') : (state.loading ? 'Conectando...' : 'Conectar Google Calendar');
        }
        if(state.disconnectBtn){
          state.disconnectBtn.style.display = state.connected ? '' : 'none';
          state.disconnectBtn.disabled = state.loading;
        }
        if(state.statusEl){
          const parts = [];
          if(state.statusMessage){
            parts.push(state.statusMessage);
          }else if(!state.clientId){
            parts.push('Configure o Client ID do Google Calendar para habilitar a integra√ß√£o.');
          }else if(state.connected){
            parts.push(state.email ? `Conectado como ${state.email}` : 'Conectado ao Google Calendar.');
          }else if(state.loadError){
            parts.push('Integra√ß√£o do Google Calendar indispon√≠vel no momento.');
          }else{
            parts.push('N√£o conectado.');
          }
          if(state.syncing){
            parts.push('Sincronizando‚Ä¶');
          }
          state.statusEl.textContent = parts.join(' ‚Ä¢ ');
        }
      }

      function setStatusMessage(message, options = {}){
        state.statusMessage = message || '';
        updateUi();
        if(options.toast && typeof mgToast === 'function' && message){
          mgToast(message);
        }
      }

      async function ensureApisLoaded(){
        if(googleApisPromise){
          return googleApisPromise;
        }
        googleApisPromise = (async ()=>{
          await loadExternalScript('https://accounts.google.com/gsi/client', ()=> typeof window !== 'undefined' && window.google && window.google.accounts);
          await loadExternalScript('https://apis.google.com/js/api.js', ()=> typeof window !== 'undefined' && window.gapi && typeof window.gapi.load === 'function');
          await new Promise((resolve, reject)=>{
            try{
              window.gapi.load('client', { callback: resolve, onerror: ()=> reject(new Error('Falha ao carregar cliente Google API')) });
            }catch(err){
              reject(err);
            }
          });
          await window.gapi.client.load(GOOGLE_CALENDAR_DISCOVERY_URL);
          state.loadError = null;
        })();
        try{
          await googleApisPromise;
        }catch(err){
          state.loadError = err;
          googleApisPromise = null;
          throw err;
        }
        return googleApisPromise;
      }

      function ensureTokenClient(){
        if(!state.clientId){
          throw new Error('Client ID do Google Calendar n√£o configurado.');
        }
        if(state.tokenClient && state.tokenClientClientId === state.clientId){
          return state.tokenClient;
        }
        const oauth2 = window.google?.accounts?.oauth2;
        if(!oauth2 || typeof oauth2.initTokenClient !== 'function'){
          throw new Error('Biblioteca de autentica√ß√£o Google indispon√≠vel.');
        }
        state.tokenClient = oauth2.initTokenClient({
          client_id: state.clientId,
          scope: GOOGLE_CALENDAR_SCOPES,
          callback: ()=>{}
        });
        state.tokenClientClientId = state.clientId;
        return state.tokenClient;
      }

      async function requestAccessToken({ interactive = false } = {}){
        await ensureApisLoaded();
        ensureTokenClient();
        return new Promise((resolve, reject)=>{
          try{
            state.tokenClient.callback = (response)=>{
              if(response?.error){
                reject(new Error(response.error));
                return;
              }
              const token = response?.access_token || '';
              if(token){
                state.accessToken = token;
                const expires = Number(response?.expires_in);
                state.tokenExpiresAt = Number.isFinite(expires) ? Date.now() + (expires * 1000) - 60000 : Date.now() + 1800000;
                try{
                  if(window.gapi?.client){
                    window.gapi.client.setToken({ access_token: token });
                  }
                }catch(_err){}
              }
              resolve(token);
            };
            state.tokenClient.requestAccessToken({ prompt: interactive ? 'consent' : '' });
          }catch(err){
            reject(err);
          }
        });
      }

      async function ensureAccessToken({ interactive = false } = {}){
        if(state.accessToken && state.tokenExpiresAt && Date.now() < state.tokenExpiresAt){
          return state.accessToken;
        }
        try{
          return await requestAccessToken({ interactive });
        }catch(err){
          if(interactive){
            throw err;
          }
          console.warn('Falha ao obter token do Google Calendar', err);
          return '';
        }
      }

      async function fetchGoogleEmail(token){
        if(!token) return '';
        try{
          const response = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
            headers: { Authorization: `Bearer ${token}` }
          });
          if(!response.ok) return '';
          const data = await response.json();
          return (data && data.email) ? data.email : '';
        }catch(_err){
          return '';
        }
      }

      function formatStatusLabel(status){
        switch((status||'').toLowerCase()){
          case 'aprovado': return 'Aprovado';
          case 'revisar': return 'Revisar';
          case 'pendente': return 'Pendente';
          default:
            return status ? (status.charAt(0).toUpperCase() + status.slice(1)) : '';
        }
      }

      function formatTargetLabel(target){
        return (target||'').toLowerCase() === 'stories' ? 'Stories' : 'Feed';
      }

      function computeEventDates(dateISO){
        const base = dateISO ? new Date(`${dateISO}T00:00:00`) : new Date();
        if(Number.isNaN(base.getTime())){
          const today = new Date();
          today.setHours(0,0,0,0);
          base.setTime(today.getTime());
        }
        const start = new Date(base.getTime());
        start.setHours(0,0,0,0);
        const end = new Date(start.getTime());
        end.setDate(end.getDate() + 1);
        const fmt = (d)=> d.toISOString().slice(0,10);
        return { start: fmt(start), end: fmt(end) };
      }

      function buildEventPayload(post){
        const safe = post || {};
        const { start, end } = computeEventDates(safe.dateISO);
        const statusLabel = formatStatusLabel(safe.status || '');
        const targetLabel = formatTargetLabel(safe.target || '');
        const summaryParts = [];
        if(statusLabel) summaryParts.push(statusLabel);
        if(targetLabel) summaryParts.push(targetLabel);
        const firstLine = (safe.desc || '').split(/\r?\n/).map(t=>t.trim()).find(Boolean) || '';
        if(firstLine){
          summaryParts.push(firstLine);
        }else if(!summaryParts.length){
          summaryParts.push('Post agendado');
        }
        let summary = summaryParts.join(' ‚Ä¢ ').trim();
        if(summary.length > 120){
          summary = summary.slice(0, 117).trimEnd() + '‚Ä¶';
        }
        const descriptionParts = [];
        descriptionParts.push(`Destino: ${targetLabel}`);
        if(statusLabel) descriptionParts.push(`Status: ${statusLabel}`);
        const tenant = (typeof TENANT === 'string' && TENANT) ? TENANT : '';
        const clientKey = (typeof getClientKey === 'function') ? (getClientKey() || '') : '';
        if(tenant) descriptionParts.push(`Cliente: ${tenant}`);
        if(clientKey && clientKey !== tenant) descriptionParts.push(`Chave: ${clientKey}`);
        if(safe.desc){
          descriptionParts.push('');
          descriptionParts.push(safe.desc);
        }
        const panelUrl = (typeof location !== 'undefined' && location?.href) ? location.href.split('#')[0] : '';
        if(panelUrl){
          descriptionParts.push('');
          descriptionParts.push(`Painel: ${panelUrl}`);
        }
        return {
          summary,
          description: descriptionParts.join('\n'),
          start: { date: start },
          end: { date: end },
          extendedProperties: {
            private: {
              mgPostId: safe.id || '',
              mgTenant: tenant || ''
            }
          }
        };
      }

      async function updatePostDoc(postId, data){
        const uid = auth.currentUser?.uid;
        if(!uid || !postId || !data) return;
        try{
          await updateDoc(doc(db, 'usuarios', uid, 'posts', postId), data);
        }catch(err){
          console.warn('updatePostDoc (Google Calendar)', err);
        }
      }

      async function syncEvent(post, mode){
        if(!post || !post.id || !state.connected){
          return false;
        }
        if(!state.clientId){
          setStatusMessage('Client ID do Google Calendar n√£o configurado.');
          return false;
        }
        if(mode !== 'delete' && !post.dateISO){
          console.warn('Post sem data n√£o ser√° sincronizado com o Google Calendar.', post);
          return false;
        }
        beginSync();
        try{
          const token = await ensureAccessToken({ interactive: false });
          if(!token){
            throw new Error('Token do Google Calendar ausente.');
          }
          const calendarId = encodeURIComponent(state.calendarId || 'primary');
          if(mode === 'delete'){
            if(!post.googleEventId){
              return true;
            }
            const response = await fetch(`https://www.googleapis.com/calendar/v3/calendars/${calendarId}/events/${encodeURIComponent(post.googleEventId)}`,{
              method: 'DELETE',
              headers: { Authorization: `Bearer ${token}` }
            });
            if(response.status !== 204 && response.status !== 200 && response.status !== 404){
              const txt = await response.text();
              throw new Error(txt || 'Falha ao excluir evento.');
            }
            return true;
          }
          const payload = buildEventPayload(post);
          const headers = {
            Authorization: `Bearer ${token}`,
            'Content-Type': 'application/json'
          };
          if(mode === 'update' && post.googleEventId){
            const response = await fetch(`https://www.googleapis.com/calendar/v3/calendars/${calendarId}/events/${encodeURIComponent(post.googleEventId)}`, {
              method: 'PATCH',
              headers,
              body: JSON.stringify(payload)
            });
            if(response.status === 404){
              post.googleEventId = '';
              await updatePostDoc(post.id, { googleEventId: '', googleCalendarSyncedAt: serverTimestamp() });
              return await syncEvent(post, 'create');
            }
            if(!response.ok){
              const txt = await response.text();
              throw new Error(txt || 'Falha ao atualizar evento.');
            }
            await updatePostDoc(post.id, { googleCalendarSyncedAt: serverTimestamp() });
            return true;
          }else{
            const response = await fetch(`https://www.googleapis.com/calendar/v3/calendars/${calendarId}/events`, {
              method: 'POST',
              headers,
              body: JSON.stringify(payload)
            });
            if(!response.ok){
              const txt = await response.text();
              throw new Error(txt || 'Falha ao criar evento.');
            }
            const data = await response.json();
            if(data?.id){
              post.googleEventId = data.id;
              await updatePostDoc(post.id, { googleEventId: data.id, googleCalendarSyncedAt: serverTimestamp() });
            }
            return true;
          }
        }catch(err){
          console.error('syncEvent Google Calendar', err);
          setStatusMessage('Falha ao sincronizar com o Google Calendar.');
          return false;
        }finally{
          endSync();
        }
      }

      async function processPendingActions(){
        if(!state.connected || state.processingPending){
          return;
        }
        state.processingPending = true;
        updateUi();
        try{
          const snapshotMap = new Map();
          if(Array.isArray(state.posts)){
            state.posts.forEach(p=>{
              if(p && p.id){
                snapshotMap.set(p.id, copyPost(p));
              }
            });
          }
          const deletes = Object.values(state.pendingDeletes||{});
          for(const pending of deletes){
            if(!pending) continue;
            await syncEvent(pending, 'delete');
            delete state.pendingDeletes[pending.id];
            snapshotMap.delete(pending.id);
          }
          const creates = Object.values(state.pendingCreates||{});
          for(const pending of creates){
            if(!pending) continue;
            const latest = snapshotMap.get(pending.id) || pending;
            await syncEvent(latest, latest.googleEventId ? 'update' : 'create');
            delete state.pendingCreates[pending.id];
            delete state.pendingUpdates[pending.id];
            snapshotMap.set(latest.id, copyPost(latest));
          }
          const updates = Object.values(state.pendingUpdates||{});
          for(const pending of updates){
            if(!pending) continue;
            const latest = snapshotMap.get(pending.id) || pending;
            await syncEvent(latest, latest.googleEventId ? 'update' : 'create');
            delete state.pendingUpdates[pending.id];
            snapshotMap.set(latest.id, copyPost(latest));
          }
          for(const post of snapshotMap.values()){
            if(post && post.id && !post.googleEventId){
              await syncEvent(post, 'create');
            }
          }
        }catch(err){
          console.error('processPendingActions Google Calendar', err);
          setStatusMessage('Falha ao sincronizar pend√™ncias do Google Calendar.');
        }finally{
          state.processingPending = false;
          updateUi();
        }
      }

      async function connect(interactive = true){
        if(state.loading){
          return state.connected;
        }
        if(!state.clientId){
          setStatusMessage('Client ID do Google Calendar n√£o configurado.');
          return false;
        }
        state.loading = true;
        updateUi();
        try{
          await ensureApisLoaded();
          const token = await ensureAccessToken({ interactive });
          if(!token){
            throw new Error('Token ausente.');
          }
          const email = await fetchGoogleEmail(token);
          if(email) state.email = email;
          state.connected = true;
          if(!state.statusMessage){
            setStatusMessage(email ? `Conectado como ${email}` : 'Google Calendar conectado.');
          }else{
            updateUi();
          }
          await processPendingActions();
          return true;
        }catch(err){
          console.error('Google Calendar connect', err);
          state.connected = false;
          if(interactive){
            setStatusMessage('N√£o foi poss√≠vel conectar ao Google Calendar.');
          }else{
            updateUi();
          }
          return false;
        }finally{
          state.loading = false;
          updateUi();
        }
      }

      function disconnect(){
        if(state.loading){
          return;
        }
        try{
          if(state.accessToken && window.google?.accounts?.oauth2?.revoke){
            window.google.accounts.oauth2.revoke(state.accessToken, ()=>{});
          }
        }catch(err){
          console.warn('Falha ao revogar token do Google Calendar', err);
        }
        state.accessToken = null;
        state.tokenExpiresAt = 0;
        state.connected = false;
        state.email = '';
        state.tokenClient = null;
        state.tokenClientClientId = '';
        try{
          if(window.gapi?.client){
            window.gapi.client.setToken(null);
          }
        }catch(_err){}
        setStatusMessage('Google Calendar desconectado.');
      }

      return {
        setDomRefs({ connectBtn, disconnectBtn, statusEl } = {}){
          if(connectBtn && !connectBtn.dataset.googleCalendarBound){
            connectBtn.dataset.googleCalendarBound = '1';
            connectBtn.addEventListener('click', ()=> connect(true));
          }
          if(disconnectBtn && !disconnectBtn.dataset.googleCalendarBound){
            disconnectBtn.dataset.googleCalendarBound = '1';
            disconnectBtn.addEventListener('click', ()=> disconnect());
          }
          if(connectBtn) state.connectBtn = connectBtn;
          if(disconnectBtn) state.disconnectBtn = disconnectBtn;
          if(statusEl) state.statusEl = statusEl;
          updateUi();
        },
        updateConfigFromProfile(profile){
          const dataset = document.body?.dataset || {};
          const globalClientId = typeof window !== 'undefined' ? (window.GOOGLE_CALENDAR_CLIENT_ID || '') : '';
          const globalCalendarId = typeof window !== 'undefined' ? (window.GOOGLE_CALENDAR_CALENDAR_ID || window.GOOGLE_CALENDAR_ID || '') : '';
          const profileIntegration = profile?.integrations?.googleCalendar || {};
          const profileRoot = profile?.googleCalendar || {};
          const newClientId = (profileIntegration.clientId || profileIntegration.clientID || profile?.googleCalendarClientId || profile?.googleCalendarClientID || profileRoot.clientId || profileRoot.clientID || dataset.googleCalendarClientId || globalClientId || '').trim();
          const newCalendarIdRaw = profileIntegration.calendarId || profile?.googleCalendarCalendarId || profile?.googleCalendarId || profileRoot.calendarId || dataset.googleCalendarCalendarId || dataset.googleCalendarId || globalCalendarId || '';
          const newCalendarId = (newCalendarIdRaw || '').trim() || 'primary';
          const prevClientId = state.clientId;
          state.clientId = newClientId;
          state.calendarId = newCalendarId;
          if(prevClientId && newClientId && prevClientId !== newClientId){
            disconnect();
          }else{
            updateUi();
          }
        },
        notifyPostsLoaded(posts){
          state.posts = Array.isArray(posts) ? posts.map(copyPost) : [];
          if(state.connected){
            processPendingActions();
          }
        },
        handlePostCreated(post){
          const copy = copyPost(post);
          if(!copy || !copy.id) return Promise.resolve(false);
          if(state.connected){
            return syncEvent(copy, copy.googleEventId ? 'update' : 'create');
          }
          state.pendingCreates[copy.id] = copy;
          return Promise.resolve(false);
        },
        handlePostUpdated(post){
          const copy = copyPost(post);
          if(!copy || !copy.id) return Promise.resolve(false);
          if(state.connected){
            return syncEvent(copy, copy.googleEventId ? 'update' : 'create');
          }
          state.pendingUpdates[copy.id] = copy;
          return Promise.resolve(false);
        },
        handlePostDeleted(post){
          const copy = copyPost(post);
          if(!copy || !copy.id) return Promise.resolve(false);
          delete state.pendingCreates[copy.id];
          delete state.pendingUpdates[copy.id];
          if(state.connected){
            return syncEvent(copy, 'delete');
          }
          if(copy.googleEventId){
            state.pendingDeletes[copy.id] = { id: copy.id, googleEventId: copy.googleEventId };
          }
          return Promise.resolve(false);
        },
        ensureConnected(){
          return connect(false);
        },
        isConnected(){
          return state.connected;
        },
        setStatusMessage: setStatusMessage
      };
    })();
    window.googleCalendarIntegration = googleCalendarIntegration;

    // Set OpenRouter API key for AI integration
    window.OPENROUTER_API_KEY = "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"; // Cole aqui sua chave da API do OpenRouter


    function getTenantFromHostOrPath(){
      const host = location.hostname, parts = host.split(".");
      if(parts.length>=3 && parts[0]!=="dashboard") return parts[0].replace(/[^a-zA-Z0-9]/g,"").toLowerCase();
      const seg = location.pathname.split("/").filter(Boolean)[0] || "";
      return seg ? seg.replace(/[^a-zA-Z0-9]/g,"").toLowerCase() : null;
    }
    let TENANT = getTenantFromHostOrPath();
    window.TENANT = TENANT;
    if (TENANT) {
      try {
        document.documentElement.dataset.tenant = TENANT;
        document.body.setAttribute('data-client-id', TENANT);
      } catch(_) {}
    } else {
      console.warn('TENANT ausente; recursos de cliente ser√£o ocultados.');
    }


    const firebaseConfig = {
      apiKey: "AIzaSyD4CbPQWrwOcfANX3ar0ibmGN20ffsRCqo",
      authDomain: "mediagrowth-a5349.firebaseapp.com",
      projectId: "mediagrowth-a5349",
      storageBucket: "mediagrowth-a5349.firebasestorage.app",
      messagingSenderId: "1074237637946",
      appId: "1:1074237637946:web:cf5008b649bbb4d7d13c03"
    };

    let app;
    if (TENANT) {
      app = getApps().find(a => a.name === TENANT) || initializeApp(firebaseConfig, TENANT);
    } else {
      app = getApps()[0] || initializeApp(firebaseConfig);
    }
  const auth = getAuth(app); const db = getFirestore(app); const functions = getFunctions(app);
    // exp√µe inst√¢ncias globais para outros scripts (ex.: planilha Macro)
    window.auth = auth;
    window.onAuthStateChanged = onAuthStateChanged;
    const provider = new GoogleAuthProvider(); setPersistence(auth, browserLocalPersistence).catch(console.error);
    let storageInitTried=false;
    let userDocUnsub = null;

  let inviteHelperApp = null;
  let inviteHelperAuth = null;
  let inviteAuthPersistenceReady = false;
  let clientInviteSubmitting = false;
  let clientRoleActionRunning = false;
  let clientAccountsLoading = false;
  let clientAccountsError = null;
  let clientAccountsUnsub = null;
  let clientAccountsNavigationKey = '';
  let clientAccounts = [];
  let clientAccountsStatusMessage = { text: '', type: null };
  const clientAccountsTargets = new Set();
  const clientAccountsStatusEls = new Set();

    function setClientInviteStatus(statusEl, message, type){
      if(!statusEl) return;
      statusEl.textContent = message || '';
      statusEl.classList.remove('success','error');
      if(type === 'success' || type === 'error'){
        statusEl.classList.add(type);
      }
    }

    async function ensureInviteAuth(){
      if(inviteHelperAuth) return inviteHelperAuth;
      const baseName = `${app?.name || 'default'}-client-invite`;
      inviteHelperApp = getApps().find(a => a.name === baseName) || initializeApp(firebaseConfig, baseName);
      inviteHelperAuth = getAuth(inviteHelperApp);
      if(!inviteAuthPersistenceReady){
        try{
          await setPersistence(inviteHelperAuth, inMemoryPersistence);
        }catch(err){
          console.warn('client invite persistence', err);
        }
        inviteAuthPersistenceReady = true;
      }
      return inviteHelperAuth;
    }

    async function tornarAgencia(){
      const user = auth.currentUser;
      if(!user) throw new Error('Sess√£o expirada. Fa√ßa login novamente.');
      const func = httpsCallable(functions, 'becomeAgency');
      await func();
      await user.getIdToken(true);
    }

    async function entrarCliente(clientId){
      const user = auth.currentUser;
      if(!user) throw new Error('Sess√£o expirada. Fa√ßa login novamente.');
      const func = httpsCallable(functions, 'selectClient');
      await func({ clientId });
      await user.getIdToken(true);
    }

    function buildClientKeyCandidates(name, email){
      const candidates = [];
      const normalizedName = normalizeClientKey(name || '');
      if(normalizedName) candidates.push(normalizedName.toLowerCase());
      const emailLocal = (email || '').split('@')[0] || '';
      const normalizedEmail = normalizeClientKey(emailLocal);
      if(normalizedEmail){
        const lower = normalizedEmail.toLowerCase();
        if(!candidates.includes(lower)) candidates.push(lower);
      }
      candidates.push(`client-${Date.now()}`);
      candidates.push(`client-${uuid().slice(0,6)}`);
      return candidates;
    }

    async function resolveUniqueClientKey(agencyUid, name, email){
      const candidates = buildClientKeyCandidates(name, email);
      for(const base of candidates){
        if(!base) continue;
        let attempt = base;
        let suffix = 0;
        while(suffix < 6){
          const ref = doc(db, 'usuarios', agencyUid, 'clients', attempt);
          const snap = await getDoc(ref);
          if(!snap.exists()){
            return attempt;
          }
          suffix += 1;
          attempt = `${base}-${suffix}`;
        }
      }
      throw new Error('N√£o foi poss√≠vel gerar uma chave √∫nica para o cliente.');
    }

    async function createOrUpdateClientDoc(agencyUid, clientKey, payload){
      const ref = doc(db, 'usuarios', agencyUid, 'clients', clientKey);
      const basePayload = {
        agencyId: agencyUid,
        clientId: clientKey
      };
      await setDoc(ref, { ...basePayload, ...payload }, { merge: true });
      return ref;
    }

    async function persistClientUserProfile(clientUid, agencyUid, clientKey, displayName, email){
      const now = serverTimestamp();
      await setDoc(doc(db, 'usuarios', clientUid), {
        role: 'client',
        agencyId: agencyUid,
        clientId: clientKey,
        displayName,
        email,
        updatedAt: now,
        createdAt: now
      }, { merge: true });
    }

    async function grantClientClaimsToUser(clientUid, agencyUid, clientKey){
      try{
        const callable = httpsCallable(functions, 'grantClientClaims');
        await callable({ clientUid, agencyUid, clientId: clientKey });
      }catch(err){
        console.warn('grantClientClaims', err);
        throw new Error('Convite criado, mas houve falha ao aplicar as permiss√µes do cliente.');
      }
    }

    async function registerClientUser(email, password){
      const inviteAuth = await ensureInviteAuth();
      const cred = await createUserWithEmailAndPassword(inviteAuth, email, password);
      return { auth: inviteAuth, user: cred.user };
    }

    async function inviteClientAccount({ name, email, password }){
      const agency = auth.currentUser;
      if(!agency) throw new Error('Sess√£o expirada. Fa√ßa login novamente para convidar o cliente.');
      const agencyUid = agency.uid;
      const clientKey = await resolveUniqueClientKey(agencyUid, name, email);
      let inviteAuthInstance = null;
      try{
        const { auth: inviteAuth, user: clientUser } = await registerClientUser(email, password);
        inviteAuthInstance = inviteAuth;
        const timestamp = serverTimestamp();
        await createOrUpdateClientDoc(agencyUid, clientKey, {
          displayName: name,
          contactEmail: email,
          clientUid: clientUser.uid,
          status: 'active',
          createdAt: timestamp,
          updatedAt: timestamp,
          createdBy: agencyUid,
          clientKey,
          slug: clientKey,
          lastInvitationAt: timestamp
        });
        await persistClientUserProfile(clientUser.uid, agencyUid, clientKey, name, email);
        await grantClientClaimsToUser(clientUser.uid, agencyUid, clientKey);
        return { clientKey, clientUid: clientUser.uid };
      }finally{
        if(inviteAuthInstance){
          try{ await signOut(inviteAuthInstance); }catch(_err){}
        }
      }
    }

    function attachClientInviteForm(form){
      if(!form || form.dataset.bound === 'true') return;
      form.dataset.bound = 'true';
      const nameInput = form.querySelector('#inviteClientName');
      const emailInput = form.querySelector('#inviteClientEmail');
      const passwordInput = form.querySelector('#inviteClientPassword');
      const statusEl = form.querySelector('#inviteClientStatus');
      const submitBtn = form.querySelector('button[type="submit"]');
      form.addEventListener('submit', async (event)=>{
        event.preventDefault();
        if(clientInviteSubmitting) return;
        const name = nameInput?.value?.trim();
        const email = emailInput?.value?.trim();
        const password = passwordInput?.value || '';
        if(!name || !email || !password){
          setClientInviteStatus(statusEl, 'Preencha nome, e-mail e senha inicial.', 'error');
          return;
        }
        if(password.length < 6){
          setClientInviteStatus(statusEl, 'A senha inicial precisa ter ao menos 6 caracteres.', 'error');
          return;
        }
        clientInviteSubmitting = true;
        submitBtn?.setAttribute('disabled', 'true');
        setClientInviteStatus(statusEl, 'Criando acesso para o cliente...', null);
        try{
          await inviteClientAccount({ name, email, password });
          form.reset();
          setClientInviteStatus(statusEl, 'Convite criado e permiss√µes aplicadas.', 'success');
          try{ mgToast('Cliente convidado com sucesso!'); }catch(_toastErr){}
        }catch(err){
          console.error('inviteClientAccount', err);
          let message = 'N√£o foi poss√≠vel concluir o convite. Tente novamente.';
          if(err?.code === 'auth/email-already-in-use'){
            message = 'O e-mail informado j√° possui cadastro ativo.';
          }else if(err?.code === 'auth/invalid-email'){
            message = 'Informe um e-mail v√°lido para o cliente.';
          }else if(typeof err?.message === 'string' && err.message){
            message = err.message;
          }
          setClientInviteStatus(statusEl, message, 'error');
        }finally{
          clientInviteSubmitting = false;
          submitBtn?.removeAttribute('disabled');
        }
      });
    }

    function attachClientRoleActions(container){
      if(!container) return;
      const becomeBtn = container.querySelector('#becomeAgencyBtn');
      const enterBtn = container.querySelector('#enterClientBtn');
      const statusEl = container.querySelector('#clientRoleStatus') || container.querySelector('#inviteClientStatus');
      if(becomeBtn && !becomeBtn.dataset.bound){
        becomeBtn.dataset.bound = 'true';
        becomeBtn.addEventListener('click', async ()=>{
          if(clientRoleActionRunning) return;
          if(!auth?.currentUser){
            setClientInviteStatus(statusEl, 'Fa√ßa login para continuar.', 'error');
            return;
          }
          clientRoleActionRunning = true;
          becomeBtn.setAttribute('disabled', 'true');
          enterBtn?.setAttribute('disabled', 'true');
          setClientInviteStatus(statusEl, 'Atualizando permiss√µes da conta...', null);
          try{
            await tornarAgencia();
            setClientInviteStatus(statusEl, 'Agora sua conta √© uma Ag√™ncia ‚úÖ', 'success');
            try{ mgToast('Conta configurada como ag√™ncia.'); }catch(_err){}
          }catch(err){
            console.error('tornarAgencia', err);
            const message = typeof err?.message === 'string' && err.message
              ? err.message
              : 'N√£o foi poss√≠vel atualizar a conta para ag√™ncia.';
            setClientInviteStatus(statusEl, message, 'error');
          }finally{
            clientRoleActionRunning = false;
            becomeBtn.removeAttribute('disabled');
            enterBtn?.removeAttribute('disabled');
          }
        });
      }
      if(enterBtn && !enterBtn.dataset.bound){
        enterBtn.dataset.bound = 'true';
        enterBtn.addEventListener('click', async ()=>{
          if(clientRoleActionRunning) return;
          if(!auth?.currentUser){
            setClientInviteStatus(statusEl, 'Fa√ßa login para continuar.', 'error');
            return;
          }
          let clientId = prompt('Informe o ID do cliente:');
          if(clientId === null) return; // cancelado
          clientId = clientId.trim();
          if(!clientId){
            setClientInviteStatus(statusEl, 'Informe um ID de cliente v√°lido.', 'error');
            return;
          }
          clientRoleActionRunning = true;
          enterBtn.setAttribute('disabled', 'true');
          becomeBtn?.setAttribute('disabled', 'true');
          setClientInviteStatus(statusEl, `Entrando no cliente ${clientId}...`, null);
          try{
            await entrarCliente(clientId);
            const successMsg = `Voc√™ entrou no cliente: ${clientId}`;
            setClientInviteStatus(statusEl, successMsg, 'success');
            try{ mgToast(successMsg); }catch(_err){}
          }catch(err){
            console.error('entrarCliente', err);
            const message = typeof err?.message === 'string' && err.message
              ? err.message
              : 'N√£o foi poss√≠vel entrar no cliente informado.';
            setClientInviteStatus(statusEl, message, 'error');
          }finally{
            clientRoleActionRunning = false;
            enterBtn.removeAttribute('disabled');
            becomeBtn?.removeAttribute('disabled');
          }
        });
      }
    }

    function updateClientAccountsStatusEls(message, type){
      const text = message || '';
      const normalizedType = type === 'success' || type === 'error' ? type : null;
      [...clientAccountsStatusEls].forEach((el)=>{
        if(!el || !el.isConnected){
          clientAccountsStatusEls.delete(el);
          return;
        }
        setClientInviteStatus(el, text, normalizedType);
      });
    }

    function setClientAccountsStatus(message, type){
      clientAccountsStatusMessage = { text: message || '', type: type || null };
      updateClientAccountsStatusEls(clientAccountsStatusMessage.text, clientAccountsStatusMessage.type);
    }

    function ensureClientAccountsStatusForState(){
      if(clientAccountsStatusMessage.text){
        updateClientAccountsStatusEls(clientAccountsStatusMessage.text, clientAccountsStatusMessage.type);
        return;
      }
      if(clientAccountsLoading){
        updateClientAccountsStatusEls('Carregando clientes...', null);
        return;
      }
      if(clientAccountsError){
        updateClientAccountsStatusEls('N√£o foi poss√≠vel carregar os clientes no momento.', 'error');
        return;
      }
      updateClientAccountsStatusEls('', null);
    }

    function buildClientManagementUrl(clientKey){
      const raw = (clientKey || '').trim();
      if(!raw){
        return window.location.origin;
      }
      const safe = raw.replace(/[^a-zA-Z0-9-]/g, '').toLowerCase() || raw;
      const { protocol, hostname, origin } = window.location;
      const parts = hostname.split('.');
      if(parts.length >= 3){
        const newParts = [...parts];
        newParts[0] = safe;
        return `${protocol}//${newParts.join('.')}/`;
      }
      return `${origin.replace(/\/$/, '')}/${safe}/`;
    }

    async function handleClientAccountLaunch(button, clientKey){
      const targetKey = (clientKey || '').trim();
      if(!targetKey){
        setClientAccountsStatus('Cliente selecionado inv√°lido.', 'error');
        return;
      }
      if(!auth?.currentUser){
        setClientAccountsStatus('Fa√ßa login para entrar no cliente.', 'error');
        return;
      }
      if(clientAccountsNavigationKey){
        return;
      }
      let newTab = null;
      clientAccountsNavigationKey = targetKey;
      try{
        if(button){
          button.disabled = true;
        }
        setClientAccountsStatus(`Preparando acesso ao cliente ${targetKey}...`, null);
        newTab = window.open('', '_blank');
        if(newTab){
          try{ newTab.opener = null; }catch(_err){}
          try{
            newTab.document.write('<p style="font-family:Arial,Helvetica,sans-serif;padding:16px;color:#0f172a;">Carregando cliente...</p>');
          }catch(_err){}
        }
        await entrarCliente(targetKey);
        const destination = buildClientManagementUrl(targetKey);
        if(newTab){
          newTab.location.href = destination;
          setClientAccountsStatus(`Cliente ${targetKey} aberto em uma nova aba.`, 'success');
        }else{
          setClientAccountsStatus('Habilite pop-ups para abrir o cliente automaticamente. Abrindo link em nova aba.', 'error');
          window.open(destination, '_blank');
        }
      }catch(err){
        console.error('handleClientAccountLaunch', err);
        if(newTab && !newTab.closed){
          newTab.close();
        }
        const message = typeof err?.message === 'string' && err.message
          ? err.message
          : 'N√£o foi poss√≠vel abrir o cliente selecionado.';
        setClientAccountsStatus(message, 'error');
      }finally{
        clientAccountsNavigationKey = '';
        if(button){
          button.disabled = false;
        }
        ensureClientAccountsStatusForState();
      }
    }

    function renderClientAccountsList(target){
      if(!target){
        return;
      }
      if(!target.isConnected){
        clientAccountsTargets.delete(target);
        return;
      }
      if(!auth?.currentUser){
        target.innerHTML = '<p class="client-accounts-empty">Fa√ßa login para visualizar os clientes dispon√≠veis.</p>';
        return;
      }
      if(clientAccountsLoading){
        target.innerHTML = '<p class="client-accounts-empty">Carregando clientes...</p>';
        return;
      }
      if(clientAccountsError){
        target.innerHTML = '<p class="client-accounts-empty">N√£o foi poss√≠vel carregar os clientes agora.</p>';
        return;
      }
      if(!Array.isArray(clientAccounts) || clientAccounts.length === 0){
        const hint = USER_DATA?.role === 'agency'
          ? 'Convide um novo cliente para que ele apare√ßa nesta lista.'
          : 'Nenhum cliente vinculado √† sua conta ainda.';
        target.innerHTML = `<p class="client-accounts-empty">${escapeHtml(hint)}</p>`;
        return;
      }
      target.innerHTML = '';
      const fragment = document.createDocumentFragment();
      clientAccounts.forEach((client)=>{
        const key = client.clientKey || client.slug || client.id;
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'client-account-trigger';
        button.dataset.clientKey = key;
        const nameEl = document.createElement('span');
        nameEl.className = 'client-account-name';
        nameEl.textContent = client.displayName || client.name || key || 'Cliente';
        button.appendChild(nameEl);
        const metaParts = [];
        if(client.contactEmail){
          metaParts.push(client.contactEmail);
        }
        if(key){
          metaParts.push(key);
        }
        if(client.status && client.status !== 'active'){
          metaParts.push(client.status);
        }
        if(metaParts.length){
          const metaEl = document.createElement('span');
          metaEl.className = 'client-account-meta';
          metaEl.textContent = metaParts.join(' ‚Ä¢ ');
          button.appendChild(metaEl);
        }
        button.addEventListener('click', ()=>{
          handleClientAccountLaunch(button, key);
        });
        fragment.appendChild(button);
      });
      target.appendChild(fragment);
    }

    function notifyClientAccountsChanged(){
      [...clientAccountsTargets].forEach((target)=>{
        renderClientAccountsList(target);
      });
      ensureClientAccountsStatusForState();
    }

    function startClientAccountsListener(){
      if(clientAccountsUnsub || !auth?.currentUser){
        ensureClientAccountsStatusForState();
        return;
      }
      clientAccountsLoading = true;
      clientAccountsError = null;
      ensureClientAccountsStatusForState();
      try{
        const colRef = collection(db, 'usuarios', auth.currentUser.uid, 'clients');
        clientAccountsUnsub = onSnapshot(colRef, (snapshot)=>{
          clientAccounts = snapshot.docs.map((docSnap)=>{
            const data = docSnap.data() || {};
            return {
              id: docSnap.id,
              clientKey: data.clientKey || docSnap.id,
              slug: data.slug || '',
              displayName: data.displayName || data.name || docSnap.id,
              contactEmail: data.contactEmail || data.email || '',
              status: data.status || ''
            };
          }).sort((a, b)=>{
            const aLabel = (a.displayName || a.clientKey || '').toLowerCase();
            const bLabel = (b.displayName || b.clientKey || '').toLowerCase();
            if(aLabel < bLabel) return -1;
            if(aLabel > bLabel) return 1;
            return 0;
          });
          clientAccountsLoading = false;
          clientAccountsError = null;
          notifyClientAccountsChanged();
        }, (error)=>{
          console.warn('clientAccounts listener', error);
          clientAccountsLoading = false;
          clientAccountsError = error;
          clientAccounts = [];
          notifyClientAccountsChanged();
        });
      }catch(err){
        console.warn('startClientAccountsListener', err);
        clientAccountsLoading = false;
        clientAccountsError = err;
        clientAccounts = [];
        notifyClientAccountsChanged();
      }
    }

    function stopClientAccountsListener(){
      if(clientAccountsUnsub){
        try{ clientAccountsUnsub(); }catch(_err){}
        clientAccountsUnsub = null;
      }
      clientAccounts = [];
      clientAccountsLoading = false;
      clientAccountsError = null;
      clientAccountsNavigationKey = '';
      setClientAccountsStatus('', null);
      notifyClientAccountsChanged();
    }

    function attachClientAccountsList(container){
      if(!container) return;
      const listEl = container.querySelector('#clientAccountsList');
      const statusEl = container.querySelector('#clientAccountsStatus');
      if(statusEl){
        clientAccountsStatusEls.add(statusEl);
      }
      if(listEl){
        clientAccountsTargets.add(listEl);
        renderClientAccountsList(listEl);
      }
      ensureClientAccountsStatusForState();
      startClientAccountsListener();
    }

    async function writeUserDoc(fields){
      if(!auth?.currentUser) return;
      try{
        await setDoc(doc(db, "usuarios", auth.currentUser.uid), fields, { merge: true });
        if(typeof invalidateIAContextCache === 'function') invalidateIAContextCache();
      }catch(err){
        console.warn('writeUserDoc', err);
      }
    }

    const $ = (id)=>document.getElementById(id);
    const headerCalendarBar = $("headerCalendarBar"), headerCalendarMonth = $("headerCalendarMonth"), headerCalendarDays = $("headerCalendarDays");
    const statusBox = $("status"), authArea = $("authArea"), userArea = $("userArea"), userInfo = $("userInfo");
    const profileArea = $("profileArea"), profileAvatar = $("profileAvatar"), profileAvatarImg = $("profileAvatarImg"), profileAvatarPlaceholder = $("profileAvatarPlaceholder"), profileAvatarInput = $("profileAvatarInput"), profileClientName = $("profileClientName");
    const settingsToggle = $("settingsToggle"), settingsPanel = $("settingsPanel"), settingsSidebar = $("settingsSidebar"), settingsBody = $("settingsBody"), settingsTitle = $("settingsTitle"), settingsSubtitle = $("settingsSubtitle"), settingsClose = $("settingsClose"), settingsSectionSelect = $("settingsSectionSelect");
    if (!TENANT) {
      statusBox.textContent = 'Fa√ßa login para continuar.';
    }
    const dashboard = $("dashboard"), totalScore = $("totalScore"), totalCard = $("totalCard"), macroActions = $("macroActions"), macroBadges = $("macroBadges");
    const sectionTabs = $("sectionTabs"), widgetsGrid = $("widgetsGrid"), demandasWrap = $("demandasWrap"), notesWrap = $("notesWrap"), metasWrap = $("metasWrap"), iframeDica = $("iframedica"), filesWrap = $("filesWrap"), foldersList = $("foldersList"), filesPane = $("filesPane"), filesList = $("filesList"), fileInput = $("fileInput"), uploadFilesBtn = $("uploadFilesBtn"), newFolderBtn = $("newFolder"), filesBreadcrumb = $("filesBreadcrumb"), subfoldersGrid = $("subfoldersGrid"), filesEmpty = $("filesEmpty"), filesViewToggle = $("filesViewToggle"), viewAllFilesBtn = $("viewAllFilesBtn"), filePreviewModal = $("filePreviewModal"), filePreviewTitle = $("filePreviewTitle"), filePreviewContent = $("filePreviewContent"), filePreviewInfo = $("filePreviewInfo"), filePreviewClose = $("filePreviewClose"), uploadProgress = $("uploadProgress"), uploadProgressText = $("uploadProgressText"), uploadProgressBar = $("uploadProgressBar"), uploadProgressPercent = $("uploadProgressPercent"), storageUsage = $("storageUsage"), storageUsagePercent = $("storageUsagePercent"), storageUsageFill = $("storageUsageFill"), storageUsageSummary = $("storageUsageSummary"), storageUsageHint = $("storageUsageHint"), filesBulkBar = $("filesBulkBar"), filesBulkCount = $("filesBulkCount"), filesBulkStatus = $("filesBulkStatus"), filesBulkUndo = $("filesBulkUndo"), filesSelectAll = $("filesSelectAll"), trafegoWrap = $("trafegoWrap"), trafegoDemandasBody = $("trafegoDemandasBody"), trafegoAddDemanda = $("trafegoAddDemanda"), trafegoMetricsBody = $("trafegoMetricsBody"), trafegoAddMetricRow = $("trafegoAddMetricRow"), trafegoCampaignsBody = $("trafegoCampaignsBody"), trafegoAddCampaign = $("trafegoAddCampaign"), trafegoCampaignStatusFilter = $("trafegoCampaignStatusFilter"), trafegoCampaignSearch = $("trafegoCampaignSearch"), trafegoCampaignsEmpty = $("trafegoCampaignsEmpty"), trafegoOptimizationsBody = $("trafegoOptimizationsBody"), trafegoAddOptimization = $("trafegoAddOptimization"), trafegoOptimizationPlatformFilter = $("trafegoOptimizationPlatformFilter"), trafegoOptimizationRecurrenceFilter = $("trafegoOptimizationRecurrenceFilter"), trafegoOptimizationSearch = $("trafegoOptimizationSearch"), trafegoOptimizationsEmpty = $("trafegoOptimizationsEmpty"), trafegoHistoryBody = $("trafegoHistoryBody"), trafegoHistoryPlatformFilter = $("trafegoHistoryPlatformFilter"), trafegoHistorySearch = $("trafegoHistorySearch"), trafegoHistoryEmpty = $("trafegoHistoryEmpty");
    const trafegoCampaignsEmptyDefault = trafegoCampaignsEmpty ? trafegoCampaignsEmpty.textContent : '';
    const trafegoOptimizationsEmptyDefault = trafegoOptimizationsEmpty ? trafegoOptimizationsEmpty.textContent : '';
    let macroTabBadgeEl = null;
    let macroTabHasUpdate = false;
    let macroAutoOpenPending = true;
    const tabsContainer = $("tabsContainer"), mainMenuToggle = $("mainMenuToggle");
    const calendarWrap = $("calendarWrap"), iaWrap = $("iaWrap"), competitorsWrap = $("competitorsWrap"), refSocialWrap = $("refSocialWrap"), cacWrap = $("cacWrap"), relatorioWrap = $("relatorioWrap"), refSocialList = $("refSocialList"), refSocialForm = $("refSocialForm"), refSocialFile = $("refSocialFile"), refSocialDetails = $("refSocialDetails"), refSocialCategory = $("refSocialCategory"), refSocialLinkInput = $("refSocialLinkInput"), refSocialLinkPreview = $("refSocialLinkPreview"), refSocialModeToggle = $("refSocialModeToggle");
    const notesList = $("notesList"), noteEditor = $("noteEditor"), noteSector = $("noteSector"), noteTitle = $("noteTitle"), noteDate = $("noteDate"), noteAutoSaveStatus = $("noteAutoSaveStatus"), noteTemplateSelect = $("noteTemplateSelect"), insertTemplateBtn = $("insertTemplateBtn"), saveTemplateBtn = $("saveTemplateBtn");
    const newNoteBtn = $("newNoteBtn"), filterSector = $("filterSector"), filterFrom = $("filterFrom"), filterTo = $("filterTo");
    const applyFilter = $("applyFilter"), clearFilter = $("clearFilter"), scrollHint = $("scrollHint");
    const refreshBtn = $("refreshBtn"), notificationWidgetWrap = $("notificationWidget"), noteWidget = $("noteWidget");
      const btnImg = $("btnImg"), btnImgLink = $("btnImgLink"), imgInput = $("imgInput"),
            btnVideo = $("btnVideo"), btnVideoLink = $("btnVideoLink"), videoInput = $("videoInput");

    const calendarWebhookInput = $("calendarWebhook"), demandasWebhookInput = $("demandasWebhook");

    const SETTINGS_SECTIONS = {
      general: {
        title: "Geral",
        subtitle: "Personalize as informa√ß√µes principais da sua conta.",
        blocks: [
          {
            title: "Identidade da marca",
            description: "Centralize dados que definem como a marca aparece para o time e nos relat√≥rios compartilhados.",
            items: [
              { label: "Nome do cliente", description: "Atualize o t√≠tulo exibido no cabe√ßalho e nos dashboards." },
              { label: "Logo e cores", description: "Envie um novo logotipo e ajuste a cor de destaque que acompanha os cards." },
              { label: "Dados p√∫blicos", description: "Configure telefone, site e redes sociais apresentadas nas entregas." }
            ]
          },
          {
            title: "Experi√™ncia da plataforma",
            description: "Ajuste prefer√™ncias gerais como idioma, fuso hor√°rio e formatos utilizados nos pain√©is.",
            items: [
              { label: "Idioma", description: "Escolha a l√≠ngua padr√£o para a equipe visualizar a plataforma." },
              { label: "Fuso hor√°rio", description: "Garanta que calend√°rios e alertas sigam o hor√°rio do cliente." },
              { label: "Formato de data", description: "Defina o padr√£o de datas que ser√° exibido nos m√≥dulos." }
            ]
          },
          {
            title: "Seguran√ßa b√°sica",
            description: "Mantenha os dados seguros com autentica√ß√£o atualizada e revis√µes recorrentes de acesso.",
            items: [
              { label: "Senha da conta", description: "Altere a senha periodicamente para refor√ßar a seguran√ßa." },
              { label: "Recupera√ß√£o", description: "Cadastre e valide e-mails e telefones alternativos." },
              { label: "Alertas cr√≠ticos", description: "Ative notifica√ß√µes sobre tentativas de acesso suspeitas." }
            ]
          }
        ]
      },
      clients: {
        title: "Gerenciar Clientes",
        subtitle: "Organize contas, pastas e permiss√µes espec√≠ficas para cada cliente atendido.",
        blocks: [
          {
            title: "Estrutura de contas",
            description: "Crie novos clientes, arquive contratos inativos e mantenha os dados sempre alinhados.",
            items: [
              { label: "Cadastro r√°pido", description: "Inclua informa√ß√µes essenciais como CNPJ, segmento e respons√°vel." },
              { label: "Status da conta", description: "Atualize o est√°gio do cliente para alinhar relat√≥rios e metas." },
              { label: "Modelos de briefing", description: "Defina documentos base que facilitam o kick-off com novas marcas." }
            ]
          },
          {
            title: "Convidar e ativar cliente",
            description: "Crie e libere rapidamente o acesso do cliente com as permiss√µes corretas.",
            customContent: `
              <div class="client-role-actions">
                <button type="button" class="btn ghost" id="becomeAgencyBtn">Tornar minha conta uma ag√™ncia</button>
                <button type="button" class="btn secondary" id="enterClientBtn">Entrar no cliente</button>
                <span class="client-invite-status" id="clientRoleStatus"></span>
              </div>
              <form id="inviteClientForm" class="client-invite-form">
                <div class="client-invite-grid">
                  <label>
                    Nome do cliente
                    <input id="inviteClientName" type="text" required placeholder="Ex: Acme Co.">
                  </label>
                  <label>
                    E-mail do respons√°vel
                    <input id="inviteClientEmail" type="email" required placeholder="contato@cliente.com">
                  </label>
                  <label>
                    Senha inicial
                    <input id="inviteClientPassword" type="password" required minlength="6" placeholder="Min. 6 caracteres">
                  </label>
                </div>
                <div class="client-invite-actions">
                  <button type="submit" class="btn">Convidar cliente</button>
                  <span class="client-invite-status" id="inviteClientStatus"></span>
                </div>
              </form>
              <div class="client-accounts-section" data-client-accounts-root>
                <h4>Contas com acesso</h4>
                <div class="client-accounts-list" id="clientAccountsList" role="list"></div>
                <span class="client-invite-status" id="clientAccountsStatus"></span>
              </div>
            `
          }
        ]
      },
      integrations: {
        title: "Integra√ß√µes",
        subtitle: "Conecte ferramentas externas para enriquecer dados e automatizar rotinas.",
        blocks: [
          {
            title: "Fontes de dados",
            description: "Ative integra√ß√µes com plataformas que alimentam dashboards automaticamente.",
            items: [
              { label: "Google e Meta", description: "Sincronize campanhas, m√©tricas e p√∫blicos em tempo real." },
              { label: "RD Station e CRMs", description: "Conecte leads, oportunidades e status de vendas." },
              { label: "Planilhas externas", description: "Importe bases personalizadas via Google Sheets ou CSV." }
            ]
          },
          {
            title: "Automa√ß√£o de tarefas",
            description: "Dispare a√ß√µes autom√°ticas quando eventos espec√≠ficos acontecerem na plataforma.",
            items: [
              { label: "Webhooks", description: "Acione rotinas personalizadas a cada entrega conclu√≠da." },
              { label: "Bots de aprova√ß√£o", description: "Integre com Slack, Discord ou Teams para aprova√ß√µes instant√¢neas." },
              { label: "Sincroniza√ß√£o de arquivos", description: "Envie m√≠dias aprovadas direto para drives compartilhados." }
            ]
          }
        ]
      },
      users: {
        title: "Time",
        subtitle: "Gerencie membros da equipe, permiss√µes e convites.",
        blocks: [
          {
            title: "Membros da Equipe",
            description: "Adicione e gerencie os membros ativos do seu time.",
            customContent: `
              <div class="team-manager">
                <form class="team-form" id="addTeamMemberForm">
                  <div class="team-form-row">
                    <input type="text" id="teamMemberName" placeholder="Nome do membro" required>
                    <input type="email" id="teamMemberEmail" placeholder="E-mail" required>
                    <select id="teamMemberRole" required>
                      <option value="">Selecionar fun√ß√£o</option>
                      <option value="admin">Administrador</option>
                      <option value="manager">Gerente</option>
                      <option value="editor">Editor</option>
                      <option value="viewer">Visualizador</option>
                    </select>
                    <button type="submit" class="btn-primary">Adicionar</button>
                  </div>
                </form>
                <div class="team-list" id="teamMembersList">
                  <div class="team-list-header">
                    <div>Nome</div>
                    <div>E-mail</div>
                    <div>Fun√ß√£o</div>
                    <div>A√ß√µes</div>
                  </div>
                  <!-- Team members will be inserted here -->
                </div>
              </div>
            `
          }
        ]
      },
      plans: {
        title: "Planos",
        subtitle: "Acompanhe a assinatura ativa e ajuste a capacidade conforme o crescimento da opera√ß√£o.",
        blocks: [
          {
            title: "Resumo da assinatura",
            description: "Visualize o plano atual, limites contratados e pr√≥ximos ciclos de faturamento.",
            items: [
              { label: "Status", description: "Veja se a assinatura est√° ativa, em teste ou aguardando pagamento." },
              { label: "Limites", description: "Consulte quantidade de usu√°rios, clientes e espa√ßo dispon√≠veis." },
              { label: "Hist√≥rico de cobran√ßa", description: "Acesse notas fiscais e comprovantes anteriores." }
            ]
          },
          {
            title: "Upgrade e add-ons",
            description: "Simule novas faixas de uso e contrate recursos extras em poucos cliques.",
            items: [
              { label: "Comparativo de planos", description: "Avalie funcionalidades antes de migrar." },
              { label: "Add-ons", description: "Inclua m√≥dulos adicionais como IA, relat√≥rios premium ou suporte dedicado." },
              { label: "Condi√ß√µes comerciais", description: "Negocie pacotes anuais e obtenha descontos progressivos." }
            ]
          }
        ]
      },
      preferences: {
        title: "Prefer√™ncias",
        subtitle: "Defina alertas, notifica√ß√µes e experi√™ncias personalizadas para o time.",
        blocks: [
          {
            title: "Alertas e notifica√ß√µes",
            description: "Escolha canais e frequ√™ncia das comunica√ß√µes que mant√™m o time atualizado.",
            items: [
              { label: "Canais", description: "Ative notifica√ß√µes por e-mail, push e mensagens em apps conectados." },
              { label: "Ritmo", description: "Configure resumos di√°rios, semanais ou apenas alertas cr√≠ticos." },
              { label: "Silenciar hor√°rios", description: "Defina janelas sem notifica√ß√µes para focar em entregas." }
            ]
          },
          {
            title: "Personaliza√ß√£o",
            description: "Ajuste detalhes visuais e escolhas individuais para cada membro da equipe.",
            items: [
              { label: "Tema", description: "Selecione varia√ß√µes de contraste ou modo alto para apresenta√ß√µes." },
              { label: "Widgets favoritos", description: "Fixe m√≥dulos priorit√°rios na primeira dobra do dashboard." },
              { label: "Assistentes inteligentes", description: "Habilite sugest√µes autom√°ticas baseadas em IA para demandas." }
            ]
          }
        ]
      }
    };

    let currentSettingsSection = "general";
    let previousBodyOverflow = "";

    function updateSettingsNav(sectionKey){
      if(settingsSidebar){
        const buttons = settingsSidebar.querySelectorAll('.settings-nav-btn');
        buttons.forEach((btn)=>{
          const isActive = btn instanceof HTMLButtonElement && btn.dataset.section === sectionKey;
          btn.classList.toggle('active', !!isActive);
          btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
        });
      }
      if(settingsSectionSelect){
        settingsSectionSelect.value = sectionKey;
      }
    }

    function renderSettingsSection(sectionKey){
      const safeKey = Object.prototype.hasOwnProperty.call(SETTINGS_SECTIONS, sectionKey) ? sectionKey : 'general';
      const section = SETTINGS_SECTIONS[safeKey];
      currentSettingsSection = safeKey;
      if(settingsTitle){
        settingsTitle.textContent = section.title;
      }
      if(settingsSubtitle){
        settingsSubtitle.textContent = section.subtitle;
      }
      if(settingsBody){
        settingsBody.innerHTML = '';
        const frag = document.createDocumentFragment();
        section.blocks.forEach((block)=>{
          const card = document.createElement('div');
          card.className = 'settings-card';
          if(block.title){
            const h3 = document.createElement('h3');
            h3.textContent = block.title;
            card.appendChild(h3);
          }
          if(block.description){
            const p = document.createElement('p');
            p.textContent = block.description;
            card.appendChild(p);
          }
          if(block.customContent){
            const div = document.createElement('div');
            div.innerHTML = block.customContent;
            card.appendChild(div);

            const teamForm = div.querySelector('#addTeamMemberForm');
            if(teamForm) {
              teamForm.addEventListener('submit', async e => {
                e.preventDefault();
                const nameInput = teamForm.querySelector('#teamMemberName');
                const emailInput = teamForm.querySelector('#teamMemberEmail');
                const roleInput = teamForm.querySelector('#teamMemberRole');

                if(!nameInput?.value || !emailInput?.value || !roleInput?.value) {
                  alert('Por favor, preencha todos os campos.');
                  return;
                }

                const newMember = {
                  name: nameInput.value,
                  email: emailInput.value,
                  role: roleInput.value,
                  addedAt: serverTimestamp()
                };

                try {
                  await addDoc(collection(db, 'usuarios', auth.currentUser.uid, 'team'), newMember);
                  nameInput.value = '';
                  emailInput.value = '';
                  roleInput.value = '';
                  loadTeamMembers();
                  alert('Membro adicionado com sucesso!');
                } catch(err) {
                  console.error('Erro ao adicionar membro:', err);
                  alert('Erro ao adicionar membro. Tente novamente.');
                }
              });
            }

            const inviteForm = div.querySelector('#inviteClientForm');
            if(inviteForm){
              attachClientInviteForm(inviteForm);
            }
            attachClientRoleActions(div);
            attachClientAccountsList(div);
          }
          if(Array.isArray(block.items) && block.items.length){
            const ul = document.createElement('ul');
            block.items.forEach((item)=>{
              if(!item) return;
              const li = document.createElement('li');
              if(typeof item === 'string'){
                li.textContent = item;
              }else if(typeof item === 'object'){
                const label = 'label' in item ? item.label : '';
                const description = 'description' in item ? item.description : '';
                if(label){
                  const strong = document.createElement('strong');
                  strong.textContent = label;
                  li.appendChild(strong);
                  if(description){
                    li.appendChild(document.createTextNode(` ‚Äî ${description}`));
                  }
                }else if(description){
                  li.textContent = description;
                }else{
                  return;
                }
              }else{
                return;
              }
              ul.appendChild(li);
            });
            if(ul.childElementCount){
              card.appendChild(ul);
            }
          }
          frag.appendChild(card);
        });
        settingsBody.appendChild(frag);
      }
      updateSettingsNav(safeKey);
    }

    function openSettingsPanel(){
      if(!settingsPanel || settingsPanel.classList.contains('open')) return;
      renderSettingsSection(currentSettingsSection);
      previousBodyOverflow = document.body.style.overflow;
      document.body.style.overflow = 'hidden';
      settingsPanel.classList.add('open');
      settingsPanel.setAttribute('aria-hidden', 'false');
      settingsToggle?.setAttribute('aria-expanded', 'true');
      
      // Se estiver na se√ß√£o "users", carrega os membros da equipe
      if(currentSettingsSection === 'users') {
        setTimeout(() => loadTeamMembers(), 100);
      }
      
      requestAnimationFrame(()=>{
        settingsClose?.focus();
      });
    }

    function closeSettingsPanel(){
      if(!settingsPanel || !settingsPanel.classList.contains('open')) return;
      settingsPanel.classList.remove('open');
      settingsPanel.setAttribute('aria-hidden', 'true');
      settingsToggle?.setAttribute('aria-expanded', 'false');
      document.body.style.overflow = previousBodyOverflow;
      settingsToggle?.focus({ preventScroll: true });
    }

    settingsToggle?.addEventListener('click', ()=>{
      if(settingsPanel?.classList.contains('open')){
        closeSettingsPanel();
      }else{
        openSettingsPanel();
      }
    });

    settingsClose?.addEventListener('click', closeSettingsPanel);

    settingsPanel?.addEventListener('click', (event)=>{
      if(event.target === settingsPanel){
        closeSettingsPanel();
      }
    });

    document.addEventListener('keydown', (event)=>{
      if(event.key === 'Escape' && settingsPanel?.classList.contains('open')){
        closeSettingsPanel();
      }
    });

    settingsSidebar?.addEventListener('click', (event)=>{
      const target = event.target;
      if(!(target instanceof Element)) return;
      const button = target.closest('.settings-nav-btn');
      if(button instanceof HTMLButtonElement){
        const section = button.dataset.section;
        if(section){
          renderSettingsSection(section);
        }
      }
    });

    settingsSectionSelect?.addEventListener('change', (event)=>{
      const value = event.target?.value;
      if(typeof value === 'string'){
        renderSettingsSection(value);
      }
    });

    // Team management functionality
    async function loadTeamMembers() {
      if(!auth?.currentUser) return;
      try {
        const teamSnapshot = await getDocs(collection(db, 'usuarios', auth.currentUser.uid, 'team'));
        const teamList = document.getElementById('teamMembersList');
        if(!teamList) return;
        
        // Keep header
        const header = teamList.querySelector('.team-list-header');
        teamList.innerHTML = '';
        if(header) teamList.appendChild(header);

        teamSnapshot.forEach(doc => {
          const member = doc.data();
          const div = document.createElement('div');
          div.className = 'team-member';
          div.dataset.id = doc.id;
          div.innerHTML = `
            <div>${member.name}</div>
            <div>${member.email}</div>
            <div>${member.role}</div>
            <div class="team-member-actions">
              <button type="button" class="edit-btn" data-id="${doc.id}">Editar</button>
              <button type="button" class="remove-btn" data-id="${doc.id}">Remover</button>
            </div>
          `;
          teamList.appendChild(div);
        });

        // Add event listeners
        teamList.querySelectorAll('.edit-btn').forEach(btn => {
          btn.addEventListener('click', e => {
            const id = e.target.dataset.id;
            const member = e.target.closest('.team-member');
            if(!member) return;
            
            // Transform row into edit form
            const memberData = {
              name: member.children[0].textContent,
              email: member.children[1].textContent,
              role: member.children[2].textContent
            };
            
            member.innerHTML = `
              <div><input type="text" value="${memberData.name}" class="edit-name"></div>
              <div><input type="email" value="${memberData.email}" class="edit-email"></div>
              <div>
                <select class="edit-role">
                  <option value="admin" ${memberData.role === 'admin' ? 'selected' : ''}>Administrador</option>
                  <option value="manager" ${memberData.role === 'manager' ? 'selected' : ''}>Gerente</option>
                  <option value="editor" ${memberData.role === 'editor' ? 'selected' : ''}>Editor</option>
                  <option value="viewer" ${memberData.role === 'viewer' ? 'selected' : ''}>Visualizador</option>
                </select>
              </div>
              <div class="team-member-actions">
                <button type="button" class="btn-primary save-edit" data-id="${id}">Salvar</button>
                <button type="button" class="btn-secondary cancel-edit">Cancelar</button>
              </div>
            `;

            // Add handlers for save/cancel
            member.querySelector('.save-edit').addEventListener('click', async () => {
              const newData = {
                name: member.querySelector('.edit-name').value,
                email: member.querySelector('.edit-email').value,
                role: member.querySelector('.edit-role').value
              };
              await updateDoc(doc(db, 'usuarios', auth.currentUser.uid, 'team', id), newData);
              loadTeamMembers(); // Reload list
            });

            member.querySelector('.cancel-edit').addEventListener('click', () => {
              loadTeamMembers(); // Reload list to cancel
            });
          });
        });

        teamList.querySelectorAll('.remove-btn').forEach(btn => {
          btn.addEventListener('click', async e => {
            const id = e.target.dataset.id;
            if(!confirm('Tem certeza que deseja remover este membro?')) return;
            await deleteDoc(doc(db, 'usuarios', auth.currentUser.uid, 'team', id));
            loadTeamMembers(); // Reload list
          });
        });
      } catch(err) {
        console.error('Error loading team members:', err);
      }
    }

    // Handle form submission for adding new team members
    const addTeamMemberForm = document.getElementById('addTeamMemberForm');
    if(addTeamMemberForm) {
      addTeamMemberForm.addEventListener('submit', async e => {
        e.preventDefault();
        const nameInput = document.getElementById('teamMemberName');
        const emailInput = document.getElementById('teamMemberEmail');
        const roleInput = document.getElementById('teamMemberRole');

        if(!nameInput || !emailInput || !roleInput) return;

        const newMember = {
          name: nameInput.value,
          email: emailInput.value,
          role: roleInput.value,
          addedAt: serverTimestamp()
        };

        try {
          await addDoc(collection(db, 'usuarios', auth.currentUser.uid, 'team'), newMember);
          nameInput.value = '';
          emailInput.value = '';
          roleInput.value = '';
          loadTeamMembers(); // Reload list
        } catch(err) {
          console.error('Error adding team member:', err);
        }
      });
    }

    // Load team members when settings panel opens or when switching to team section
    const originalRenderSettingsSection = renderSettingsSection;
    function enhancedRenderSettingsSection(sectionKey) {
      originalRenderSettingsSection(sectionKey);
      if(sectionKey === 'users') {
        loadTeamMembers();
      }
    }
    renderSettingsSection = enhancedRenderSettingsSection;

    if(settingsPanel && settingsBody){
      renderSettingsSection(currentSettingsSection);
      settingsPanel.setAttribute('aria-hidden', 'true');
    }

    if(tabsContainer && mainMenuToggle){
      const mobileMenuMedia = window.matchMedia("(max-width: 820px)");
      const closeMainMenu = ()=>{
        tabsContainer.classList.remove("menu-open");
        mainMenuToggle.setAttribute("aria-expanded", "false");
      };
      mainMenuToggle.addEventListener("click", ()=>{
        const isOpen = tabsContainer.classList.toggle("menu-open");
        mainMenuToggle.setAttribute("aria-expanded", isOpen ? "true" : "false");
      });
      sectionTabs?.addEventListener("click", (event)=>{
        if(event.target instanceof Element && event.target.closest(".tab-btn") && mobileMenuMedia.matches){
          closeMainMenu();
        }
      });
      const handleMenuMedia = (event)=>{
        if(!event.matches){
          closeMainMenu();
        }
      };
      if(typeof mobileMenuMedia.addEventListener === "function"){
        mobileMenuMedia.addEventListener("change", handleMenuMedia);
      }else if(typeof mobileMenuMedia.addListener === "function"){
        mobileMenuMedia.addListener(handleMenuMedia);
      }
      document.addEventListener("click", (event)=>{
        if(!mobileMenuMedia.matches || !tabsContainer.classList.contains("menu-open")) return;
        const target = event.target;
        if(!(target instanceof Element)) return;
        if(target === mainMenuToggle) return;
        if(tabsContainer.contains(target)) return;
        closeMainMenu();
      });
    }

    function renderHeaderCalendarBar(){
      if(!headerCalendarDays || !headerCalendarMonth) return;
      const now = new Date();
      const totalDays = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
      const formatter = new Intl.DateTimeFormat('pt-BR', { month: 'long', year: 'numeric' });
      let label = formatter.format(now);
      if(label){
        label = label.charAt(0).toUpperCase() + label.slice(1);
      }
      headerCalendarMonth.textContent = label;
      headerCalendarDays.innerHTML = '';
      const frag = document.createDocumentFragment();
      for(let day = 1; day <= totalDays; day++){
        const cell = document.createElement('div');
        cell.className = 'header-calendar-day';
        cell.setAttribute('role', 'listitem');
        cell.textContent = String(day);
        if(day === now.getDate()){
          cell.classList.add('today');
          cell.setAttribute('aria-current', 'date');
        }
        frag.appendChild(cell);
      }
      headerCalendarDays.appendChild(frag);
      headerCalendarBar?.setAttribute('aria-hidden', 'false');
    }
    renderHeaderCalendarBar();
    const WEBHOOKS = {
      calendar: localStorage.getItem('webhook_calendar') || '',
      demandas: localStorage.getItem('webhook_demandas') || ''
    };
    if (calendarWebhookInput) calendarWebhookInput.value = WEBHOOKS.calendar;
    if (demandasWebhookInput) demandasWebhookInput.value = WEBHOOKS.demandas;
    function persistWebhook(type, value){
      WEBHOOKS[type] = (value||'').trim();
      localStorage.setItem('webhook_'+type, WEBHOOKS[type]);
    }
    calendarWebhookInput?.addEventListener('change', ()=> persistWebhook('calendar', calendarWebhookInput.value));
    demandasWebhookInput?.addEventListener('change', ()=> persistWebhook('demandas', demandasWebhookInput.value));
    async function sendWebhook(type, payload){
      const url = WEBHOOKS[type];
      if(!url) return;
      const finalPayload = { email: auth.currentUser?.email || null, ...payload };
      try{
        await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(finalPayload) });
      }catch(err){ console.warn('Webhook', err); }
    }

    // ===== IA =====
    const iaQuestion = $("iaQuestion"), iaSend = $("iaSend"),
          iaHistory = $("iaHistory"), iaChatList = $("iaChatList"),
          iaNewChat = $("iaNewChat"), iaChatSearch = $("iaChatSearch"),
          iaCurrentTitle = $("iaCurrentTitle"), iaRenameChat = $("iaRenameChat"),
          iaDeleteChat = $("iaDeleteChat"), iaEmptyState = $("iaEmptyState"),
          iaComposer = $("iaComposer"), iaDocsInput = $("iaDocsInput"),
          iaDocsPick = $("iaDocsPick"), iaDocsUpload = $("iaDocsUpload"),
          iaDocsStatus = $("iaDocsStatus"), iaDocsList = $("iaDocsList"),
          iaKnowledge = $("iaKnowledge"), iaDocsCount = $("iaDocsCount"),
          iaSourceNote = $("iaSourceNote");
    let IA_CHATS = [], CURRENT_CHAT = null;
    let IA_DOCS = [];
    let IA_DOCS_PENDING = [];
    let PLATFORM_CODE = "";
    let PLATFORM_TEXT = "";
    const IA_CONTEXT_CACHE = { ts: 0, data: null };
    const IA_CONTEXT_TTL = 10000;
    const IA_MAX_CONTEXT_CHARS = 60000;
    const IA_MAX_PLATFORM_CHARS = 60000;
    const IA_DOC_SNIPPET_CHARS = 20000;
    const IA_MAX_DOC_CHARS = 120000;
    const IA_DEFAULT_SOURCE_LABEL = 'Conversa com o usu√°rio na aba I.A';
    function updateIASourceNote(sources){
      if(!iaSourceNote) return;
      const list = Array.isArray(sources) ? sources.map(source=>String(source||'').trim()).filter(Boolean) : [];
      const unique = Array.from(new Set(list));
      const label = unique.length ? unique.join(' ‚Ä¢ ') : IA_DEFAULT_SOURCE_LABEL;
      iaSourceNote.textContent = `Fontes: ${label}.`;
    }
    const joinPath = (parts)=> Array.isArray(parts) ? parts.join('/') : null;
    const invalidateIAContextCache = ()=>{ IA_CONTEXT_CACHE.ts = 0; IA_CONTEXT_CACHE.data = null; };
    if(iaDocsUpload) iaDocsUpload.disabled = true;
    renderIADocsList();
    updateIADocsStatus();
    updateIASourceNote();
    if(iaKnowledge){
      iaKnowledge.addEventListener('toggle', ()=>{
        if(iaKnowledge.open){
          delete iaKnowledge.dataset.userClosed;
        }else{
          iaKnowledge.dataset.userClosed = 'true';
        }
      });
    }

    iaHistory?.addEventListener('click', async (event)=>{
      const btn = event.target.closest('.ia-copy-btn');
      if(!btn) return;
      const index = Number(btn.dataset.msgIndex);
      if(!CURRENT_CHAT || !Array.isArray(CURRENT_CHAT.messages)) return;
      if(Number.isNaN(index) || index < 0 || index >= CURRENT_CHAT.messages.length) return;
      const targetMsg = CURRENT_CHAT.messages[index];
      const text = typeof targetMsg?.content === 'string' ? targetMsg.content : '';
      try{
        if(navigator.clipboard?.writeText){
          await navigator.clipboard.writeText(text);
        }else{
          const temp = document.createElement('textarea');
          temp.value = text;
          temp.style.position = 'fixed';
          temp.style.opacity = '0';
          document.body.appendChild(temp);
          temp.focus();
          temp.select();
          document.execCommand('copy');
          temp.remove();
        }
        if(typeof mgToast === 'function'){ mgToast('Resposta copiada!'); }
      }catch(err){
        console.error('copy ia message', err);
        if(typeof mgToast === 'function'){ mgToast('N√£o foi poss√≠vel copiar.'); }
      }
    });

    function escHtml(str){ return (str ?? '').replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }
    function deriveTitleFromText(text){
      const clean = (text || '').replace(/\s+/g,' ').trim();
      if(!clean) return 'Nova conversa';
      return clean.length > 60 ? clean.slice(0,57)+'‚Ä¶' : clean;
    }
    function chatTitle(chat){
      if(!chat) return 'Nova conversa';
      const stored = (chat.title || '').trim();
      if(stored) return stored;
      const firstUser = (chat.messages || []).find(m=>m.role==='user' && (m.content||'').trim());
      return deriveTitleFromText(firstUser?.content || '');
    }
    function formatTimestamp(ts){
      if(!ts) return '';
      try{ return new Date(ts).toLocaleString(); }
      catch(_){ return ''; }
    }
    const SCRIPT_CACHE = {};
    function ensureExternalScript(src, check){
      if(typeof check === 'function' && check()) return Promise.resolve();
      if(SCRIPT_CACHE[src]) return SCRIPT_CACHE[src];
      SCRIPT_CACHE[src] = new Promise((resolve, reject)=>{
        const script = document.createElement('script');
        script.src = src;
        script.async = true;
        script.onload = ()=> resolve();
        script.onerror = ()=> reject(new Error('Falha ao carregar script: '+src));
        document.head.appendChild(script);
      }).then(()=>{ if(typeof check === 'function' && !check()) throw new Error('Biblioteca n√£o dispon√≠vel: '+src); });
      return SCRIPT_CACHE[src];
    }
    const JSZIP_SRC = 'https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js';
    const XLSX_SRC = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
    function ensureJSZip(){
      return ensureExternalScript(JSZIP_SRC, ()=> typeof JSZip !== 'undefined');
    }
    function ensureXLSX(){
      return ensureExternalScript(XLSX_SRC, ()=> typeof XLSX !== 'undefined');
    }
    function renderMessageContent(content){
      const text = typeof content === 'string' ? content : '';
      if(!text.trim()) return '';
      return renderMarkdownText(text);
    }
    function touchChat(chat){
      if(!chat) return;
      chat.updatedAt = Date.now();
      IA_CHATS.sort((a,b)=> (b.updatedAt || b.createdAt || 0) - (a.updatedAt || a.createdAt || 0));
    }
    function humanFileSize(bytes){
      if(!Number.isFinite(bytes) || bytes <= 0) return '0 B';
      const units = ['B','KB','MB','GB','TB'];
      let value = bytes;
      let unit = 0;
      while(value >= 1024 && unit < units.length-1){ value /= 1024; unit++; }
      const digits = value < 10 && unit > 0 ? 1 : 0;
      return `${value.toFixed(digits)} ${units[unit]}`;
    }
    function computeWordCount(text){
      if(!text) return 0;
      const trimmed = text.trim();
      if(!trimmed) return 0;
      return trimmed.split(/\s+/).length;
    }
    function normalizePlainText(text){
      return (text || '')
        .replace(/\r\n?/g,'\n')
        .replace(/\u0000/g,'')
        .replace(/[\t\f\v]+/g,' ')
        .replace(/\s+\n/g,'\n')
        .replace(/\n{3,}/g,'\n\n')
        .trim();
    }
    const decodeHelper = document.createElement('textarea');
    function decodeEntities(text){
      if(!text) return '';
      decodeHelper.innerHTML = text;
      return decodeHelper.value;
    }
    function extractXmlText(xml){
      if(!xml) return '';
      const replaced = xml
        .replace(/<w:p[^>]*>/g,'\n')
        .replace(/<text:p[^>]*>/g,'\n')
        .replace(/<[^>]+>/g,' ');
      return normalizePlainText(decodeEntities(replaced));
    }
    async function extractDocxText(file){
      await ensureJSZip();
      const zip = await JSZip.loadAsync(await file.arrayBuffer());
      const docFile = zip.file('word/document.xml');
      if(!docFile) throw new Error('Conte√∫do DOCX n√£o encontrado.');
      const xml = await docFile.async('string');
      return extractXmlText(xml);
    }
    async function extractOdtText(file){
      await ensureJSZip();
      const zip = await JSZip.loadAsync(await file.arrayBuffer());
      const content = zip.file('content.xml');
      if(!content) throw new Error('Conte√∫do ODT n√£o encontrado.');
      const xml = await content.async('string');
      return extractXmlText(xml);
    }
    function extractRtfText(raw){
      if(!raw) return '';
      let text = raw.replace(/\{\\\*\\generator[^}]+\}/gi,'');
      text = text.replace(/\{[^}]*\}/g,' ');
      text = text.replace(/\\'[0-9a-fA-F]{2}/g, m=>{
        const hex = m.slice(2);
        try{ return decodeURIComponent('%'+hex); }
        catch(_){ return ' '; }
      });
      text = text.replace(/\\par[d]?/g,'\n');
      text = text.replace(/\\(tab|line)/g,' ');
      text = text.replace(/\\[a-z]+-?\d*\s?/gi,'');
      text = text.replace(/[{}]/g,' ');
      return normalizePlainText(text);
    }
    async function extractSpreadsheetText(file){
      await ensureXLSX();
      const data = new Uint8Array(await file.arrayBuffer());
      const workbook = XLSX.read(data, { type:'array' });
      const parts = [];
      workbook.SheetNames.forEach(name=>{
        const sheet = workbook.Sheets[name];
        if(!sheet) return;
        const csv = XLSX.utils.sheet_to_csv(sheet);
        const normalized = normalizePlainText(csv);
        if(normalized){
          parts.push(`Planilha: ${name}\n${normalized}`);
        }
      });
      return parts.join('\n\n');
    }
    async function extractLegacyDocText(file){
      const buffer = await file.arrayBuffer();
      const bytes = new Uint8Array(buffer);
      let chars = '';
      for(let i=0;i<bytes.length;i++){
        const code = bytes[i];
        if(code === 0x0d || code === 0x0a){
          chars += '\n';
        } else if(code >= 32 && code <= 126){
          chars += String.fromCharCode(code);
        } else if(code >= 160){
          chars += String.fromCharCode(code);
        } else {
          chars += ' ';
        }
      }
      return normalizePlainText(chars);
    }
    async function extractPlainTextFromFile(file){
      const ext = (file.name.split('.').pop()||'').toLowerCase();
      if(['txt','md','csv','tsv','json','xml','html','htm'].includes(ext)){
        return normalizePlainText(await file.text());
      }
      if(ext === 'rtf'){
        return extractRtfText(await file.text());
      }
      if(ext === 'docx'){
        return await extractDocxText(file);
      }
      if(ext === 'odt'){
        return await extractOdtText(file);
      }
      if(['xls','xlsx','ods'].includes(ext)){
        return await extractSpreadsheetText(file);
      }
      if(ext === 'doc'){
        return await extractLegacyDocText(file);
      }
      throw new Error(`Formato ${ext ? ext.toUpperCase() : 'desconhecido'} n√£o suportado.`);
    }
    function loadIAChatsFromUserData(){
      IA_CHATS = Array.isArray(USER_DATA.iaChats) ? USER_DATA.iaChats.map(chat=>({
        ...chat,
        title: typeof chat.title === 'string' ? chat.title : '',
        messages: Array.isArray(chat.messages) ? chat.messages.map(msg=>({ ...msg })) : [],
        createdAt: chat.createdAt || Date.now(),
        updatedAt: chat.updatedAt || chat.createdAt || Date.now(),
        lastSources: Array.isArray(chat.lastSources) ? chat.lastSources.map(source=>String(source||'').trim()).filter(Boolean) : []
      })) : [];
      IA_CHATS.sort((a,b)=> (b.updatedAt || b.createdAt || 0) - (a.updatedAt || a.createdAt || 0));
      CURRENT_CHAT = IA_CHATS[0] || null;
      if(!CURRENT_CHAT) newIAChat();
    }
    async function saveIAChatsToUserData(){
      USER_DATA.iaChats = IA_CHATS;
      await writeUserDoc({ iaChats: IA_CHATS });
    }
    function renderIAChatList(){
      if(!iaChatList) return;
      const q = (iaChatSearch?.value || '').trim().toLowerCase();
      const filtered = IA_CHATS.filter(chat=>{
        if(!q) return true;
        const title = chatTitle(chat).toLowerCase();
        const lastContent = (chat.messages?.[chat.messages.length-1]?.content || '').toLowerCase();
        return title.includes(q) || lastContent.includes(q);
      });
      if(!filtered.length){
        iaChatList.innerHTML = `<div class="ia-chat-empty">${IA_CHATS.length ? 'Nenhuma conversa encontrada.' : 'Crie sua primeira conversa.'}</div>`;
        return;
      }
      iaChatList.innerHTML = filtered.map(chat=>{
        const isActive = CURRENT_CHAT && CURRENT_CHAT.id === chat.id;
        const lastMsg = chat.messages?.[chat.messages.length-1] || null;
        const rawPreview = lastMsg ? (lastMsg.loading ? 'Digitando‚Ä¶' : (lastMsg.content || '')) : 'Sem mensagens';
        const preview = rawPreview.length > 80 ? rawPreview.slice(0,77)+'‚Ä¶' : rawPreview;
        const meta = formatTimestamp(chat.updatedAt || chat.createdAt);
        return `<button class="ia-chat-item${isActive ? ' active' : ''}" data-id="${chat.id}">
          <div class="ia-chat-title">${escHtml(chatTitle(chat))}</div>
          <div class="ia-chat-preview">${escHtml(preview)}</div>
          <div class="ia-chat-meta">${escHtml(meta)}</div>
        </button>`;
      }).join('');
    }
    function renderIADocsList(){
      if(iaDocsCount) iaDocsCount.textContent = String(IA_DOCS.length);
      if(!iaDocsList) return;
      if(iaKnowledge && IA_DOCS.length && iaKnowledge.dataset.userClosed !== 'true'){
        iaKnowledge.open = true;
      }
      if(!IA_DOCS.length){
        iaDocsList.innerHTML = `<div class="ia-doc-empty">Nenhum documento enviado ainda.</div>`;
        return;
      }
      const sorted = [...IA_DOCS].sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));
      iaDocsList.innerHTML = sorted.map(doc=>{
        let createdTs = doc.createdAt;
        if(createdTs && typeof createdTs.toMillis === 'function'){
          try{ createdTs = createdTs.toMillis(); }
          catch(_){ createdTs = Number(createdTs); }
        }
        const created = createdTs ? formatTimestamp(createdTs) : '';
        const createdLabel = created || 'Sem data';
        const size = humanFileSize(doc.size || doc.chars || 0);
        const words = doc.words || computeWordCount(doc.text || '');
        const truncated = doc.truncated ? '<span class="muted"> ‚Ä¢ texto truncado</span>' : '';
        return `<div class="ia-doc-item" data-id="${doc.id}">
          <h4>${escHtml(doc.name || doc.originalName || 'Documento')}</h4>
          <div class="ia-doc-meta">
            <span>${escHtml(size)}</span>
            <span>${words} palavras</span>
            <span>${escHtml(createdLabel)}</span>
            ${truncated}
          </div>
          <div class="ia-doc-buttons">
            <button class="btn ghost small ia-doc-download" type="button" data-id="${doc.id}">Baixar TXT</button>
            <button class="btn ghost small danger ia-doc-delete" type="button" data-id="${doc.id}">Excluir</button>
          </div>
        </div>`;
      }).join('');
    }
    function updateIADocsStatus(){
      if(!iaDocsStatus) return;
      if(!IA_DOCS_PENDING.length){
        iaDocsStatus.textContent = IA_DOCS.length ? 'Selecione novos arquivos para enviar.' : 'Nenhum arquivo selecionado.';
        if(iaDocsUpload) iaDocsUpload.disabled = true;
        if(iaKnowledge && !IA_DOCS.length && iaKnowledge.dataset.userClosed !== 'true'){
          iaKnowledge.open = false;
        }
        return;
      }
      const total = IA_DOCS_PENDING.reduce((sum,file)=> sum + (file.size||0), 0);
      iaDocsStatus.textContent = `${IA_DOCS_PENDING.length} arquivo(s) selecionado(s) ‚Ä¢ ${humanFileSize(total)}`;
      if(iaDocsUpload) iaDocsUpload.disabled = false;
      if(iaKnowledge){
        iaKnowledge.open = true;
        delete iaKnowledge.dataset.userClosed;
      }
    }
    async function loadIADocs(){
      if(!iaDocsList) return;
      const userKeys = getUserKeyCandidates();
      const clientKey = getClientKey();
      if(!userKeys.length || !clientKey){
        IA_DOCS = [];
        renderIADocsList();
        return;
      }
      const primaryKey = userKeys[0];
      let primaryDocs = [];
      const legacyDocs = [];
      for(let i=0;i<userKeys.length;i++){
        const key = userKeys[i];
        try{
          const col = collection(db, 'usuarios', key, 'clients', clientKey, 'iaDocs');
          const snap = await getDocs(col);
          const mapped = snap.docs.map(d=>{
            const data = d.data() || {};
            let createdAt = data.createdAt;
            if(createdAt && typeof createdAt.toMillis === 'function'){
              try{ createdAt = createdAt.toMillis(); }
              catch(_){ createdAt = Number(createdAt); }
            }
            return { id:d.id, ...data, createdAt, userKey: key, isLegacy: key !== primaryKey };
          });
          if(i === 0){
            primaryDocs = mapped;
          }else if(mapped.length){
            legacyDocs.push(...mapped);
          }
        }catch(err){
          console.warn('loadIADocs', key, err);
        }
      }
      IA_DOCS = [...primaryDocs, ...legacyDocs];
      renderIADocsList();
    }
    let iaDocsUploading = false;
    async function uploadPendingIADocs(){
      if(iaDocsUploading) return;
      if(!IA_DOCS_PENDING.length){ alert('Selecione ao menos um arquivo.'); return; }
      if(!auth.currentUser){ alert('Fa√ßa login para enviar documentos.'); return; }
      const uid = getUserKey();
      const clientKey = getClientKey();
      if(!uid || !clientKey){ alert('Cliente n√£o identificado.'); return; }
      iaDocsUploading = true;
      if(iaDocsUpload) iaDocsUpload.disabled = true;
      if(iaDocsPick) iaDocsPick.disabled = true;
      if(iaDocsStatus) iaDocsStatus.textContent = 'Convertendo documentos...';
      try{
        const col = collection(db, 'usuarios', uid, 'clients', clientKey, 'iaDocs');
        const errors = [];
        for(const file of IA_DOCS_PENDING){
          try{
            let text = await extractPlainTextFromFile(file);
            if(!text){ throw new Error('Nenhum texto detectado'); }
            let truncated = false;
            if(text.length > IA_MAX_DOC_CHARS){
              text = text.slice(0, IA_MAX_DOC_CHARS);
              truncated = true;
            }
            const payload = {
              name: file.name,
              originalName: file.name,
              size: file.size || text.length,
              type: file.type || (file.name.split('.').pop()||'').toLowerCase(),
              chars: text.length,
              words: computeWordCount(text),
              text,
              truncated,
              createdAt: Date.now()
            };
            await addDoc(col, payload);
          }catch(err){
            console.error('uploadPendingIADocs', err);
            errors.push({ file, message: err?.message || String(err) });
          }
        }
        IA_DOCS_PENDING = [];
        if(iaDocsInput) iaDocsInput.value = '';
        await loadIADocs();
        invalidateIAContextCache();
        if(iaDocsStatus){
          if(errors.length){
            iaDocsStatus.textContent = `Falhou em ${errors.length} arquivo(s): ${errors.map(e=>`${e.file.name} (${e.message})`).join('; ')}`;
          }else{
            iaDocsStatus.textContent = 'Documentos enviados com sucesso!';
          }
          setTimeout(()=> updateIADocsStatus(), 5000);
        }
      }finally{
        if(iaDocsUpload) iaDocsUpload.disabled = false;
        if(iaDocsPick) iaDocsPick.disabled = false;
        if(!IA_DOCS_PENDING.length && iaDocsUpload) iaDocsUpload.disabled = true;
        iaDocsUploading = false;
      }
    }
    function renderIAHistory(){
      if(!iaHistory) return;
      if(!CURRENT_CHAT){
        iaHistory.innerHTML = '';
        if(iaCurrentTitle) iaCurrentTitle.textContent = 'Selecione uma conversa';
        if(iaEmptyState) iaEmptyState.style.display = 'flex';
        updateIASourceNote();
        return;
      }
      const messages = CURRENT_CHAT.messages || [];
      updateIASourceNote(Array.isArray(CURRENT_CHAT.lastSources) ? CURRENT_CHAT.lastSources : []);
      if(iaCurrentTitle) iaCurrentTitle.textContent = chatTitle(CURRENT_CHAT);
      if(iaEmptyState) iaEmptyState.style.display = messages.length ? 'none' : 'flex';
      iaHistory.innerHTML = messages.map((msg, idx)=>{
        const cls = msg.role === 'user' ? 'ia-msg ia-msg-user' : 'ia-msg ia-msg-assistant';
        const meta = formatTimestamp(msg.ts);
        const isAssistant = msg.role === 'assistant';
        const isLoading = !!msg.loading;
        const content = isLoading
          ? '<div class="ia-typing"><span></span><span></span><span></span></div>'
          : `<div class="ia-msg-content markdown-view">${renderMessageContent(msg.content)}</div>`;
        const actions = (!isLoading && isAssistant)
          ? `<div class="ia-msg-actions"><button type="button" class="ia-copy-btn" data-msg-index="${idx}">Copiar</button></div>`
          : '';
        return `<div class="${cls}">
          <div class="ia-msg-bubble">${content}${actions}</div>
          ${meta ? `<span class="ia-msg-meta">${escHtml(meta)}</span>` : ''}
        </div>`;
      }).join('');
      requestAnimationFrame(()=>{ iaHistory.scrollTop = iaHistory.scrollHeight; });
    }
    function focusComposer(){ setTimeout(()=> iaQuestion?.focus(), 60); }
    function autoResizeComposer(){
      if(!iaQuestion) return;
      iaQuestion.style.height = 'auto';
      const minHeight = 48;
      const target = Math.max(minHeight, Math.min(180, iaQuestion.scrollHeight || minHeight));
      iaQuestion.style.height = `${target}px`;
    }
    function openIAWithPrompt(promptText){
      if(typeof promptText !== 'string') return;
      const trimmed = promptText.trim();
      if(!trimmed) return;
      const applyPrompt = ()=>{
        if(!iaQuestion) return;
        iaQuestion.value = trimmed;
        autoResizeComposer();
        focusComposer();
      };
      if(currentSection === 'ia'){
        applyPrompt();
        return;
      }
      const iaTab = sectionTabs?.querySelector('.tab-btn[data-section="ia"]');
      if(iaTab){
        iaTab.click();
        setTimeout(applyPrompt, 80);
      } else {
        currentSection = 'ia';
        localStorage.setItem('mg_currentSection', currentSection);
        rerenderBySection();
        setTimeout(applyPrompt, 80);
      }
    }
    function newIAChat(){
      const chat = { id: uuid(), title: 'Nova conversa', createdAt: Date.now(), updatedAt: Date.now(), messages: [], lastSources: [] };
      IA_CHATS.push(chat);
      touchChat(chat);
      CURRENT_CHAT = chat;
      renderIAChatList();
      renderIAHistory();
      saveIAChatsToUserData();
      focusComposer();
    }
    function htmlStringToText(html){
      if(!html) return "";
      try{
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const text = doc?.body?.innerText || doc?.documentElement?.innerText || "";
        return normalizePlainText(text);
      }catch(err){
        try{
          const temp = document.createElement('div');
          temp.innerHTML = html;
          return normalizePlainText(temp.textContent || temp.innerText || "");
        }catch(_err){
          console.warn('htmlStringToText', err);
          return "";
        }
      }
    }
    async function ensurePlatformCode(){
      if(PLATFORM_CODE && PLATFORM_TEXT) return;
      try{
        const [html, js, rotinaJs] = await Promise.all([
          fetch(location.pathname).then(r=>r.text()).catch(()=>""),
          fetch("comemorative_dates_2025.js").then(r=>r.text()).catch(()=>""),
          fetch("rotina_dropdowns.js").then(r=>r.text()).catch(()=>"")
        ]);
        PLATFORM_CODE = [html, js, rotinaJs].filter(Boolean).join("\n\n");
        if(!PLATFORM_TEXT){
          const htmlText = htmlStringToText(html);
          if(htmlText){
            PLATFORM_TEXT = htmlText;
          }
        }
      }catch(err){
        console.warn('erro carregando c√≥digo', err);
      }
      if(!PLATFORM_TEXT){
        try{
          const liveText = document?.body?.innerText || document?.documentElement?.innerText || "";
          PLATFORM_TEXT = normalizePlainText(liveText);
        }catch(err){
          console.warn('fallback platform text', err);
        }
      }
    }
    function firestoreReplacer(_key, value){
      if(value && typeof value === 'object'){
        if(typeof value.toDate === 'function'){
          try{ return value.toDate().toISOString(); }
          catch(_err){ try{ return value.toMillis(); }catch(_e){ return value; } }
        }
        if(value instanceof Date){
          try{ return value.toISOString(); }
          catch(_){ return value; }
        }
      }
      return value;
    }
    function deepClonePlain(value){
      if(value === undefined) return undefined;
      try{
        return JSON.parse(JSON.stringify(value, firestoreReplacer));
      }catch(err){
        console.warn('deepClonePlain', err);
        try{
          return JSON.parse(JSON.stringify(value));
        }catch(_){
          return value;
        }
      }
    }
    function trimLargeText(text, limit){
      if(!text) return '';
      if(text.length <= limit) return text;
      return text.slice(0, limit) + `\n...[conte√∫do truncado; ${text.length-limit} caracteres n√£o enviados]`;
    }
    function safeStringify(value){
      try{
        return JSON.stringify(value, firestoreReplacer, 2);
      }catch(err){
        console.warn('safeStringify', err);
        return '';
      }
    }
    async function fetchDocWithFallback(uid, rawKey, safeKey){
      const attempts = [
        rawKey ? ['usuarios', uid, 'clients', rawKey] : null,
        (safeKey && safeKey !== rawKey) ? ['usuarios', uid, 'clients', safeKey] : null
      ].filter(Boolean);
      for(const parts of attempts){
        try{
          const snap = await getDoc(doc(db, ...parts));
          if(snap.exists()){
            return { data: deepClonePlain(snap.data()), path: parts };
          }
        }catch(err){
          console.warn('fetchDocWithFallback', parts.join('/'), err);
        }
      }
      return { data: null, path: attempts[0] || null };
    }
    async function fetchCollectionWithFallback(paths){
      for(const parts of paths){
        if(!parts) continue;
        try{
          const col = collection(db, ...parts);
          const snap = await getDocs(col);
          return {
            data: snap.docs.map(docSnap => ({ id: docSnap.id, ...deepClonePlain(docSnap.data() || {}) })),
            path: parts
          };
        }catch(err){
          console.warn('fetchCollectionWithFallback', parts.join('/'), err);
        }
      }
      return { data: [], path: null };
    }
    async function fetchFileStructure(uid, rawKey, safeKey){
      const folderResult = await fetchCollectionWithFallback([
        rawKey ? ['usuarios', uid, 'clients', rawKey, 'fileFolders'] : null,
        (safeKey && safeKey !== rawKey) ? ['usuarios', uid, 'clients', safeKey, 'fileFolders'] : null
      ]);
      const folders = [];
      for(const folder of folderResult.data){
        const basePath = folderResult.path ? [...folderResult.path, folder.id, 'files'] : null;
        const altPath = (safeKey && safeKey !== rawKey && (!folderResult.path || folderResult.path[3] !== safeKey))
          ? ['usuarios', uid, 'clients', safeKey, 'fileFolders', folder.id, 'files']
          : null;
        const filesResult = await fetchCollectionWithFallback([
          basePath,
          altPath
        ]);
        folders.push({
          ...folder,
          sourceCollectionPath: joinPath(folderResult.path),
          filesCollectionPath: joinPath(filesResult.path),
          files: filesResult.data
        });
      }
      return {
        collectionPath: joinPath(folderResult.path),
        folders
      };
    }
    async function fetchIframeSnapshots(uid, rawKey, safeKey){
      const result = await fetchCollectionWithFallback([
        safeKey ? ['usuarios', uid, 'clients', safeKey, 'iframes'] : null,
        (rawKey && rawKey !== safeKey) ? ['usuarios', uid, 'clients', rawKey, 'iframes'] : null
      ]);
      return {
        collectionPath: joinPath(result.path),
        data: result.data
      };
    }
    async function fetchIADocuments(userKeys, rawKey, safeKey){
      const keys = Array.isArray(userKeys) ? userKeys.filter(Boolean) : [userKeys].filter(Boolean);
      if(!keys.length) return { collectionPath: null, data: [] };
      const primaryKey = keys[0];
      const aggregated = [];
      let primaryPath = null;
      for(const key of keys){
        const pathCandidates = [];
        if(safeKey) pathCandidates.push(['usuarios', key, 'clients', safeKey, 'iaDocs']);
        if(rawKey && rawKey !== safeKey) pathCandidates.push(['usuarios', key, 'clients', rawKey, 'iaDocs']);
        for(let i=0;i<pathCandidates.length;i++){
          const parts = pathCandidates[i];
          if(!parts) continue;
          if(!primaryPath && key === primaryKey) primaryPath = parts;
          try{
            const snap = await getDocs(collection(db, ...parts));
            if(!snap.empty){
              snap.docs.forEach(docSnap=>{
                aggregated.push({
                  id: docSnap.id,
                  ...deepClonePlain(docSnap.data() || {}),
                  userKey: key,
                  isLegacy: key !== primaryKey,
                  collectionPath: joinPath(parts)
                });
              });
            }
          }catch(err){
            console.warn('fetchIADocuments', parts.join('/'), err);
          }
        }
      }
      return {
        collectionPath: joinPath(primaryPath),
        data: aggregated
      };
    }
    async function fetchClientDataSnapshot(force){
      const now = Date.now();
      if(!force && IA_CONTEXT_CACHE.data && (now - IA_CONTEXT_CACHE.ts) < IA_CONTEXT_TTL){
        return IA_CONTEXT_CACHE.data;
      }
      const uid = auth.currentUser?.uid || null;
      const email = auth.currentUser?.email || null;
      const displayName = auth.currentUser?.displayName || null;
      const userKeysForRead = getUserKeyCandidates();
      const tenant = getClientKey() || null;
      const safeTenant = tenant ? tenant.replace(/[^\w-]/g, '_') : null;
      const snapshot = {
        fetchedAt: new Date().toISOString(),
        tenant,
        user: { uid, email, displayName },
        platformState: {
          userData: deepClonePlain(typeof USER_DATA !== 'undefined' ? USER_DATA : null),
          postsState: deepClonePlain(Array.isArray(POSTS) ? POSTS : []),
          calendarNotesState: deepClonePlain(typeof CAL_NOTES !== 'undefined' ? CAL_NOTES : {}),
          refSocialState: deepClonePlain(Array.isArray(REF_SOCIAL) ? REF_SOCIAL : []),
          socialLinksState: deepClonePlain(typeof SOCIAL_LINKS !== 'undefined' ? SOCIAL_LINKS : {}),
          demandasState: deepClonePlain(Array.isArray(DEMANDAS) ? DEMANDAS : []),
          metasState: deepClonePlain(Array.isArray(METAS) ? METAS : []),
          metaPanelsState: deepClonePlain(Array.isArray(META_PANELS) ? META_PANELS : []),
          notesState: deepClonePlain(Array.isArray(NOTES) ? NOTES : []),
          briefState: deepClonePlain(typeof BRIEF !== 'undefined' ? BRIEF : null),
          widgetsState: deepClonePlain(Array.isArray(WIDGETS) ? WIDGETS : [])
        }
      };
      if(!uid || !tenant){
        IA_CONTEXT_CACHE.data = snapshot;
        IA_CONTEXT_CACHE.ts = now;
        return snapshot;
      }
      const [userDoc, clientDoc, calendarNotes, postsCollection, fileStructure, iframeSnapshots, iaDocsCollection] = await Promise.all([
        (async ()=>{
          try{
            const snap = await getDoc(doc(db,'usuarios',uid));
            return snap.exists() ? deepClonePlain(snap.data()) : null;
          }catch(err){
            console.warn('fetch user doc', err);
            return null;
          }
        })(),
        fetchDocWithFallback(uid, tenant, safeTenant),
        fetchCollectionWithFallback([
          tenant ? ['usuarios', uid, 'clients', tenant, 'calendarNotes'] : null,
          (safeTenant && safeTenant !== tenant) ? ['usuarios', uid, 'clients', safeTenant, 'calendarNotes'] : null
        ]),
        (async ()=>{
          try{
            const colPath = ['usuarios', uid, 'posts'];
            const snap = await getDocs(collection(db, ...colPath));
            return {
              path: colPath,
              data: snap.docs.map(docSnap => ({ id: docSnap.id, ...deepClonePlain(docSnap.data() || {}) }))
            };
          }catch(err){
            console.warn('fetch posts collection', err);
            return { path: ['usuarios', uid, 'posts'], data: [] };
          }
        })(),
        fetchFileStructure(uid, tenant, safeTenant),
        fetchIframeSnapshots(uid, tenant, safeTenant),
        fetchIADocuments(userKeysForRead, tenant, safeTenant)
      ]);
      snapshot.firebase = {
        userDoc,
        userDocPath: joinPath(['usuarios', uid]),
        clientDoc: clientDoc.data,
        clientDocPath: joinPath(clientDoc.path),
        calendarNotes: calendarNotes.data,
        calendarNotesPath: joinPath(calendarNotes.path),
        posts: postsCollection.data,
        postsPath: joinPath(postsCollection.path),
        fileFolders: fileStructure.folders,
        fileFoldersPath: fileStructure.collectionPath,
        iframes: iframeSnapshots.data,
        iframesPath: iframeSnapshots.collectionPath,
        iaDocs: iaDocsCollection.data,
        iaDocsPath: iaDocsCollection.collectionPath
      };
      IA_CONTEXT_CACHE.data = snapshot;
      IA_CONTEXT_CACHE.ts = now;
      return snapshot;
    }
    function formatMonthLabel(monthKey){
      if(typeof monthKey !== 'string') return String(monthKey || '');
      const parts = monthKey.split('-');
      if(parts.length !== 2) return monthKey;
      const [year, month] = parts;
      const date = new Date(Number(year), Number(month) - 1, 1);
      if(Number.isNaN(date.getTime())) return monthKey;
      return date.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' });
    }
    function summarizeMetasForGuide(metas){
      const list = Array.isArray(metas) ? metas.filter(meta => meta && meta.ativo !== false) : [];
      if(!list.length){
        return 'Nenhuma meta cadastrada at√© o momento.';
      }
      return list.slice(0, 8).map(meta=>{
        const desc = meta?.descricao || 'Meta sem t√≠tulo';
        const unidade = meta?.unidade || '';
        const modo = meta?.modo === 'media' ? 'valor m√©dio' : 'valor total';
        const meses = meta?.meses && typeof meta.meses === 'object' ? Object.entries(meta.meses) : [];
        const recent = meses.sort((a,b)=>a[0].localeCompare(b[0])).slice(-6);
        const monthPieces = recent.map(([month, vals])=>{
          const planejado = vals?.p ?? '';
          const realizado = vals?.r ?? '';
          const partes = [];
          if(planejado !== '' && planejado !== null){ partes.push(`meta ${planejado}`); }
          if(realizado !== '' && realizado !== null){ partes.push(`realizado ${realizado}`); }
          if(!partes.length) partes.push('sem dados');
          return `${formatMonthLabel(month)}: ${partes.join(' / ')}`;
        });
        const detalheMeses = monthPieces.length ? monthPieces.join('; ') : 'nenhum m√™s preenchido';
        return `${desc} (${modo} ‚Ä¢ ${unidade || 'sem unidade'}). Meses: ${detalheMeses}.`;
      }).join('\n');
    }
    function summarizeRefSocial(refs){
      if(!Array.isArray(refs) || !refs.length){
        return 'Nenhuma refer√™ncia cadastrada.';
      }
      const counts = refs.reduce((acc, item)=>{
        const cat = (item?.category || 'sem categoria').toLowerCase();
        acc[cat] = (acc[cat] || 0) + 1;
        return acc;
      }, {});
      return Object.entries(counts).map(([cat, count])=>`${cat}: ${count}`).join(' ‚Ä¢ ');
    }
    function summarizePosts(posts){
      if(!Array.isArray(posts) || !posts.length){
        return 'Nenhum post registrado.';
      }
      const byStatus = posts.reduce((acc, post)=>{
        const st = (post?.status || 'pendente').toLowerCase();
        acc[st] = (acc[st] || 0) + 1;
        return acc;
      }, {});
      const total = posts.length;
      const detail = Object.entries(byStatus).map(([status, count])=>`${status}: ${count}`).join(' ‚Ä¢ ');
      return `Total de posts: ${total}. Distribui√ß√£o por status ‚Üí ${detail}.`;
    }
    function summarizeCalendarNotes(notes){
      if(!notes || typeof notes !== 'object') return 'Nenhuma anota√ß√£o no calend√°rio.';
      const entries = Object.keys(notes);
      if(!entries.length) return 'Nenhuma anota√ß√£o no calend√°rio.';
      const recent = entries.sort().slice(-6);
      return `Anota√ß√µes recentes (${recent.length}): ${recent.map(formatMonthLabel).join(', ')}.`;
    }
    function summarizeDemandas(demandas){
      if(!Array.isArray(demandas) || !demandas.length){
        return 'Nenhuma demanda cadastrada.';
      }
      const statusLabels = {
        'nao-iniciado': 'N√£o iniciado',
        'em-andamento': 'Em andamento',
        'bloqueado': 'Bloqueado',
        'concluido': 'Conclu√≠do',
        'prioridade': 'Prioridade',
        'prioridade-grupo': 'Prioridade/Grupo',
        'concluido-grupo': 'Conclu√≠do/Grupo'
      };
      const counters = demandas.reduce((acc, demanda)=>{
        const key = demanda?.status || 'sem status';
        acc[key] = (acc[key] || 0) + 1;
        return acc;
      }, {});
      const overdue = demandas.filter(d=>{
        const dueDate = getDemandaDueDate(d);
        if(!dueDate) return false;
        const due = dueDate.getTime();
        if(Number.isNaN(due)) return false;
        const done = d.status === 'concluido' || d.status === 'concluido-grupo';
        return !done && due < Date.now();
      }).length;
      const pieces = Object.entries(counters).map(([status, count])=>{
        const label = statusLabels[status] || status;
        return `${label}: ${count}`;
      });
      if(overdue){
        pieces.push(`Atrasadas: ${overdue}`);
      }
      return `Demandas registradas (${demandas.length}). ${pieces.join(' ‚Ä¢ ') || 'Distribui√ß√£o n√£o dispon√≠vel.'}`;
    }
    function formatDateForText(value){
      if(value && typeof value === 'object' && !Array.isArray(value)){
        const label = formatPrazoLabel(value);
        return label || 'sem per√≠odo';
      }
      if(!value) return 'sem per√≠odo';
      const date = new Date(value);
      if(Number.isNaN(date.getTime())){
        return String(value);
      }
      try{
        return date.toLocaleString('pt-BR', { hour12: false });
      }catch(_){
        return date.toISOString();
      }
    }
    function buildDemandasText(demandas){
      if(!Array.isArray(demandas) || !demandas.length){
        return '';
      }
      const statusLabels = {
        'nao-iniciado': 'N√£o iniciado',
        'em-andamento': 'Em andamento',
        'bloqueado': 'Bloqueado',
        'concluido': 'Conclu√≠do',
        'prioridade': 'Prioridade',
        'prioridade-grupo': 'Prioridade/Grupo',
        'concluido-grupo': 'Conclu√≠do/Grupo'
      };
      const sorted = [...demandas].sort((a,b)=>{
        const aDate = getDemandaStartDate(a);
        const bDate = getDemandaStartDate(b);
        const aDue = aDate ? aDate.getTime() : 0;
        const bDue = bDate ? bDate.getTime() : 0;
        if(aDue !== bDue) return aDue - bDue;
        return (a?.demanda || '').localeCompare(b?.demanda || '');
      });
      return sorted.map(item=>{
        const title = (item?.demanda || 'Sem t√≠tulo').trim();
        const status = statusLabels[item?.status] || item?.status || 'Sem status';
        const tag = item?.tag || 'Sem tag';
        const owner = item?.responsavel || 'Sem respons√°vel';
        const deadline = formatDateForText(item);
        const overdue = (()=>{
          const dueDate = getDemandaDueDate(item);
          if(!dueDate) return '';
          const due = dueDate.getTime();
          if(Number.isNaN(due)) return '';
          const done = item.status === 'concluido' || item.status === 'concluido-grupo';
          return (!done && due < Date.now()) ? ' (atrasada)' : '';
        })();
        return `‚Ä¢ ${title} | Status: ${status} | Tag: ${tag} | Respons√°vel: ${owner} | Per√≠odo: ${deadline}${overdue}`;
      }).join('\n');
    }
    function formatCalendarDate(key){
      if(!key) return '';
      if(/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(key)){
        const [y,m,d] = key.split('-');
        return `${d}/${m}/${y}`;
      }
      if(/^[0-9]{4}-[0-9]{2}$/.test(key)){
        return formatMonthLabel(key);
      }
      return key;
    }
    function buildCalendarNotesDetail(notes){
      if(!notes || typeof notes !== 'object') return '';
      const entries = Object.entries(notes);
      if(!entries.length) return '';
      return entries
        .sort(([a],[b])=>a.localeCompare(b))
        .map(([key, value])=>{
          const label = formatCalendarDate(key);
          const noteText = typeof value === 'string' ? value : safeStringify(value);
          return `${label}: ${noteText}`;
        }).join('\n');
    }
    function buildPostsText(posts){
      if(!Array.isArray(posts) || !posts.length){
        return '';
      }
      const toText = text=>{
        const clean = (text || '').replace(/\s+/g, ' ').trim();
        if(clean.length > 180) return clean.slice(0, 177) + '‚Ä¶';
        return clean;
      };
      const sorted = [...posts].sort((a,b)=>{
        return (a?.dateISO || '').localeCompare(b?.dateISO || '');
      });
      return sorted.map(post=>{
        const dateISO = post?.dateISO || '';
        const label = formatCalendarDate(dateISO) || dateISO || 'Sem data';
        const status = post?.status || 'sem status';
        const target = post?.target || 'feed';
        const mediaCount = Array.isArray(post?.mediaUrls) ? post.mediaUrls.length : 0;
        const caption = toText(post?.desc || 'Sem legenda');
        return `‚Ä¢ ${label} | Destino: ${target} | Status: ${status} | M√≠dias: ${mediaCount} | Legenda: ${caption}`;
      }).join('\n');
    }
    function buildIframeText(iframes){
      if(!Array.isArray(iframes) || !iframes.length) return '';
      return iframes.map((iframe, idx)=>{
        const name = iframe?.title || iframe?.name || iframe?.id || `iframe-${idx+1}`;
        const html = iframe?.html || iframe?.content || iframe?.embed || iframe?.code || '';
        const url = iframe?.url || iframe?.src || '';
        const pieces = [`Nome: ${name}`];
        if(url){ pieces.push(`URL: ${url}`); }
        if(typeof html === 'string' && html.trim()){
          const text = htmlStringToText(html);
          if(text){ pieces.push(`Conte√∫do: ${text}`); }
        }
        if(!url && (!html || typeof html !== 'string')){
          pieces.push(`Dados: ${safeStringify(iframe)}`);
        }
        return pieces.join('\n');
      }).join('\n\n');
    }
    function summarizeAccesses(accesses){
      if(!Array.isArray(accesses) || !accesses.length){
        return 'Nenhum acesso cadastrado.';
      }
      const tags = new Set();
      accesses.forEach(acc=>{
        (acc?.tags || '').split(',').map(t=>t.trim()).filter(Boolean).forEach(tag=>tags.add(tag.toLowerCase()));
      });
      return `Total de acessos: ${accesses.length}${tags.size ? `. Tags utilizadas: ${Array.from(tags).slice(0,12).join(', ')}.` : '.'}`;
    }
    function summarizeCAC(cac){
      if(!cac || typeof cac !== 'object') return 'Sem dados de CAC informados.';
      const currency = cac.currency || 'BRL';
      const months = Object.keys({
        ...(cac.sales||{}),
        ...(cac.revenue||{}),
        ...(cac.salesAds||{}),
        ...(cac.revenueAds||{})
      });
      if(!months.length) return 'Sem dados de CAC informados.';
      const list = months.sort().slice(-6).map(formatMonthLabel).join(', ');
      return `Moeda: ${currency}. Meses com lan√ßamentos: ${list}.`;
    }
    function summarizeNotes(notes){
      if(!Array.isArray(notes) || !notes.length){
        return 'Nenhuma estrat√©gia registrada.';
      }
      const sectors = notes.reduce((acc, note)=>{
        const setor = (note?.setor || 'sem setor').toLowerCase();
        acc[setor] = (acc[setor] || 0) + 1;
        return acc;
      }, {});
      return Object.entries(sectors).map(([sector, count])=>`${sector}: ${count}`).join(' ‚Ä¢ ');
    }
    function summarizeCompetitors(snapshot){
      const { platformState = {}, firebase = {} } = snapshot || {};
      const fromState = platformState?.userData?.competitors;
      const fromClientDoc = firebase?.clientDoc?.competitors;
      const list = Array.isArray(fromClientDoc) && fromClientDoc.length ? fromClientDoc
        : (Array.isArray(fromState) ? fromState : []);
      if(!list.length){
        return 'Nenhum concorrente salvo no Firebase. Ao responder, indique a necessidade de pesquisa externa quando solicitado.';
      }
      return `Concorrentes cadastrados (${list.length}): ${list.map(c=>c?.name||'-').slice(0,8).join(', ')}.`;
    }
    function buildTabGuide(snapshot){
      if(!snapshot || typeof snapshot !== 'object') return '';
      const { platformState = {}, firebase = {} } = snapshot;
      const userData = platformState?.userData || {};
      const metas = platformState?.metasState || [];
      const posts = platformState?.postsState || [];
      const notes = platformState?.notesState || [];
      const refs = platformState?.refSocialState || [];
      const accesses = Array.isArray(userData?.accesses) ? userData.accesses : [];
      const calendarNotes = platformState?.calendarNotesState || {};
      const cacData = userData?.cac || firebase?.userDoc?.cac;
      const macroNotes = Object.keys(userData).filter(k=>/^nota-\d+$/.test(k));
      const macroHist = Object.keys(userData).filter(k=>/^hist-\d+$/.test(k));
      const widgetsCount = Array.isArray(platformState?.widgetsState) ? platformState.widgetsState.length : 0;
      const lines = [];
      lines.push([
        'Macro ‚Üí',
        `  ‚Ä¢ Campos de avalia√ß√£o: notas em userData['nota-{i}'] e observa√ß√µes em userData['obs-{i}'] (${macroNotes.length} cart√µes preenchidos).`,
        `  ‚Ä¢ Hist√≥rico mensal: arrays em userData['hist-{i}'] (${macroHist.length} s√©ries).`,
        `  ‚Ä¢ Widgets conectados: ${widgetsCount}. Dados complementares tamb√©m aparecem em firebase.clientDoc.`
      ].join('\n'));
      lines.push([
        'Metas ‚Üí',
        `  ‚Ä¢ Utilize platformState.metasState (campos meses[AAAA-MM].p para planejado e meses[AAAA-MM].r para realizado).`,
        `  ‚Ä¢ Resumo: ${summarizeMetasForGuide(metas)}`
      ].join('\n'));
      lines.push([
        'CAC ‚Üí',
        `  ‚Ä¢ Dados consolidados em userData.cac (e replicados em firebase.userDoc.cac). ${summarizeCAC(cacData)}`,
        '  ‚Ä¢ Avise quando um m√™s n√£o tiver entradas e oriente o usu√°rio a preencher a planilha.'
      ].join('\n'));
      lines.push([
        'Refer√™ncia de Redes ‚Üí',
        `  ‚Ä¢ Materiais em platformState.refSocialState com campos category/details/url. ${summarizeRefSocial(refs)}`
      ].join('\n'));
      lines.push([
        'Estrat√©gias ‚Üí',
        `  ‚Ä¢ Notas estrat√©gicas no array platformState.notesState (t√≠tulo, setor, conte√∫do rich text). ${summarizeNotes(notes)}`
      ].join('\n'));
      lines.push([
        'Calend√°rio / Posts ‚Üí',
        `  ‚Ä¢ Posts em platformState.postsState com dateISO, status, m√≠dia e legendas. ${summarizePosts(posts)}`,
        `  ‚Ä¢ Observa√ß√µes de calend√°rio em platformState.calendarNotesState. ${summarizeCalendarNotes(calendarNotes)}`
      ].join('\n'));
      lines.push([
        'Demandas ‚Üí',
        `  ‚Ä¢ Demandas cadastradas em platformState.demandasState com status, respons√°veis e prazos. ${summarizeDemandas(platformState?.demandasState)}`
      ].join('\n'));
      lines.push([
        'Acessos ‚Üí',
        `  ‚Ä¢ Lista em userData.accesses com campos name, url, user, pass e tags. ${summarizeAccesses(accesses)}`
      ].join('\n'));
      lines.push([
        'Concorrentes ‚Üí',
        `  ‚Ä¢ Informa√ß√µes armazenadas no documento do cliente (firebase.clientDoc.competitors) e em userData.competitors. ${summarizeCompetitors(snapshot)}`
      ].join('\n'));
      return lines.join('\n\n');
    }
    async function buildIAContextMessages(){
      let contextData;
      try{
        contextData = await fetchClientDataSnapshot(true);
      }catch(err){
        console.warn('buildIAContextMessages fetch', err);
        contextData = {
          fetchedAt: new Date().toISOString(),
          error: 'Falha ao coletar dados do Firebase automaticamente.'
        };
      }
      const platformSnippet = trimLargeText(PLATFORM_CODE || '', IA_MAX_PLATFORM_CHARS);
      const platformTextSnippet = trimLargeText(PLATFORM_TEXT || '', IA_MAX_PLATFORM_CHARS);
      const contextJson = trimLargeText(safeStringify(contextData), IA_MAX_CONTEXT_CHARS);
      const tabGuide = trimLargeText(buildTabGuide(contextData), IA_MAX_CONTEXT_CHARS);
      const postsDetail = trimLargeText(buildPostsText(contextData?.platformState?.postsState), IA_MAX_CONTEXT_CHARS);
      const calendarNotesDetail = trimLargeText(buildCalendarNotesDetail(contextData?.platformState?.calendarNotesState), IA_MAX_CONTEXT_CHARS);
      const demandasDetail = trimLargeText(buildDemandasText(contextData?.platformState?.demandasState), IA_MAX_CONTEXT_CHARS);
      const iframeDetail = trimLargeText(buildIframeText(contextData?.firebase?.iframes), IA_MAX_CONTEXT_CHARS);
      const sources = [];
      const messages = [{
        role: 'system',
        content: 'Voc√™ √© o assistente de marketing da Mediagrowth. Utilize somente os dados fornecidos do cliente logado e assuma que todo o contexto relevante est√° nos blocos a seguir. Siga estas regras: (1) antes de responder, valide que todos os dados mais recentes foram carregados do Firebase do cliente, incluindo n√∫meros, textos, links e senhas; (2) sempre que a solicita√ß√£o envolver n√∫meros, metas do m√™s ou metas do projeto, consulte exclusivamente a aba METAS da plataforma; (3) em pedidos de an√°lise do m√™s, utilize a aba MACRO como fonte principal; (4) quando uma informa√ß√£o n√£o estiver dispon√≠vel, informe que ela n√£o foi encontrada e pe√ßa para o usu√°rio cadastr√°-la ou criar a aba correspondente (por exemplo, adicionar a aba solicitada na plataforma). Nunca invente valores ou estimativas.'
      }];
      if(platformSnippet){
        messages.push({ role: 'system', content: `C√≥digo da plataforma (trecho):\n${platformSnippet}` });
        sources.push('Trechos do c√≥digo da plataforma');
      }
      if(platformTextSnippet){
        messages.push({ role: 'system', content: `Descri√ß√£o textual da plataforma (trecho):\n${platformTextSnippet}` });
        sources.push('Descri√ß√£o textual da plataforma');
      }
      if(contextJson){
        messages.push({ role: 'system', content: `Dados coletados automaticamente do Firebase e da plataforma:\n${contextJson}` });
        sources.push('Snapshot do Firebase e estados da plataforma');
      }
      if(tabGuide){
        messages.push({ role: 'system', content: `Guia de abas e onde encontrar os dados dentro do contexto:\n${tabGuide}` });
        sources.push('Guia autom√°tico das abas da plataforma');
      }
      if(postsDetail){
        messages.push({ role: 'system', content: `Calend√°rio de posts detalhado:\n${postsDetail}` });
        sources.push('Calend√°rio de posts');
      }
      if(calendarNotesDetail){
        messages.push({ role: 'system', content: `Observa√ß√µes do calend√°rio:\n${calendarNotesDetail}` });
        sources.push('Observa√ß√µes recentes do calend√°rio');
      }
      if(demandasDetail){
        messages.push({ role: 'system', content: `Demandas registradas:\n${demandasDetail}` });
        sources.push('Demandas cadastradas na plataforma');
      }
      if(iframeDetail){
        messages.push({ role: 'system', content: `Conte√∫do dos iframes e widgets HTML do cliente:\n${iframeDetail}` });
        sources.push('Widgets e iframes salvos na plataforma');
      }
      if(IA_DOCS.length){
        IA_DOCS.slice(0, 10).forEach(doc=>{
          const text = trimLargeText(doc.text || '', IA_DOC_SNIPPET_CHARS);
          if(!text) return;
          const name = doc.name || doc.originalName || 'Documento sem t√≠tulo';
          messages.push({ role: 'system', content: `Documento de treinamento (${name}):\n${text}` });
          sources.push(`Documento da base IA: ${name}`);
        });
        if(IA_DOCS.length > 10){
          messages.push({ role: 'system', content: `Existem ${IA_DOCS.length - 10} documento(s) adicionais n√£o inclu√≠dos integralmente no contexto.` });
          sources.push(`Documentos adicionais da base IA (${IA_DOCS.length - 10})`);
        }
      }
      return { messages, sources };
    }
    function appendSourcesToResponse(text, sources){
      const base = typeof text === 'string' ? text : '';
      const list = Array.isArray(sources) ? sources.map(s=>String(s||'').trim()).filter(Boolean) : [];
      const unique = Array.from(new Set(list));
      if(CURRENT_CHAT){
        CURRENT_CHAT.lastSources = unique;
      }
      updateIASourceNote(unique);
      return base;
    }
async function sendIAQuestion(){
  if(!iaQuestion) return;
  const question = iaQuestion.value.trim();
  if(!question) return;
  if(!auth.currentUser){ alert('Fa√ßa login.'); return; }
  if(!CURRENT_CHAT) newIAChat();
  const chat = CURRENT_CHAT;
  const sendBtn = iaSend;
  if(sendBtn) sendBtn.disabled = true;
  const userMsg = { role:'user', content: question, ts: Date.now() };
  chat.messages.push(userMsg);
  if(!chat.title || chat.title === 'Nova conversa'){
    chat.title = deriveTitleFromText(question);
  }
  iaQuestion.value = '';
  autoResizeComposer();
  touchChat(chat);
  renderIAHistory();
  renderIAChatList();
  await saveIAChatsToUserData();

  const loadingMsg = { role:'assistant', content:'', ts: Date.now(), loading:true };
  chat.messages.push(loadingMsg);
  touchChat(chat);
  renderIAHistory();
  renderIAChatList();
  await saveIAChatsToUserData();

  await ensurePlatformCode();
  let contextMessages = [];
  let contextSources = [];
  try{
    const payload = await buildIAContextMessages();
    contextMessages = Array.isArray(payload?.messages) ? payload.messages : [];
    contextSources = Array.isArray(payload?.sources) ? payload.sources : [];
  }catch(err){
    console.warn('contextMessages', err);
    contextMessages = [{ role:'system', content:'Voc√™ √© o assistente de marketing da Mediagrowth. Use apenas as mensagens da conversa.' }];
    contextSources = ['Mensagens anteriores da conversa'];
  }

  const OPENROUTER_API_KEY = window.OPENROUTER_API_KEY;
  if(!OPENROUTER_API_KEY){
    loadingMsg.loading = false;
    loadingMsg.content = 'Defina window.OPENROUTER_API_KEY = "cole_sua_chave_do_openrouter_aqui"';
    loadingMsg.ts = Date.now();
    touchChat(chat);
    renderIAHistory();
    renderIAChatList();
    await saveIAChatsToUserData();
    if(sendBtn) sendBtn.disabled = false;
    focusComposer();
    return;
  }

  try{
    const resp = await fetch('https://openrouter.ai/api/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: [
          ...contextMessages,
          ...chat.messages.filter(m=>m !== loadingMsg).map(m=>({ role: m.role, content: m.content }))
        ]
      })
    });
    const data = await resp.json();
    if(!resp.ok) throw new Error(data?.error?.message || `HTTP ${resp.status}`);
    loadingMsg.loading = false;
    const answer = data.choices?.[0]?.message?.content || 'Sem resposta da IA';
    loadingMsg.content = appendSourcesToResponse(answer, contextSources);
    loadingMsg.ts = Date.now();
  }catch(err){
    loadingMsg.loading = false;
    loadingMsg.content = appendSourcesToResponse(`Erro: ${err.message}`, contextSources);
    loadingMsg.ts = Date.now();
  }
  touchChat(chat);
  renderIAHistory();
  renderIAChatList();
  await saveIAChatsToUserData();
  if(sendBtn) sendBtn.disabled = false;
  focusComposer();
}
    iaNewChat?.addEventListener('click', ()=>{ newIAChat(); });
    iaComposer?.addEventListener('submit', (event)=>{ event.preventDefault(); sendIAQuestion(); });
    iaQuestion?.addEventListener('keydown', (event)=>{
      if(event.key === 'Enter' && !event.shiftKey){ event.preventDefault(); sendIAQuestion(); }
    });
    iaQuestion?.addEventListener('input', autoResizeComposer);
    iaChatSearch?.addEventListener('input', ()=>{ renderIAChatList(); });
    iaDocsPick?.addEventListener('click', ()=>{ iaDocsInput?.click(); });
    iaDocsUpload?.addEventListener('click', ()=>{ uploadPendingIADocs(); });
    iaDocsInput?.addEventListener('change', ()=>{
      IA_DOCS_PENDING = Array.from(iaDocsInput?.files || []);
      updateIADocsStatus();
    });
    iaDocsList?.addEventListener('click', async (event)=>{
      const btn = event.target.closest('button');
      if(!btn) return;
      const id = btn.dataset.id;
      if(!id) return;
      if(btn.classList.contains('ia-doc-delete')){
        if(!auth.currentUser){ alert('Fa√ßa login para excluir documentos.'); return; }
        if(!confirm('Excluir este documento da base da IA?')) return;
        try{
          const clientKey = getClientKey();
          const docMeta = IA_DOCS.find(d=>d.id === id);
          const userKey = docMeta?.userKey || getUserKey();
          if(!userKey || !clientKey) throw new Error('Cliente n√£o identificado.');
          await deleteDoc(doc(db, 'usuarios', userKey, 'clients', clientKey, 'iaDocs', id));
          await loadIADocs();
          updateIADocsStatus();
          invalidateIAContextCache();
        }catch(err){
          console.error('delete ia doc', err);
          alert('Falha ao excluir: ' + (err?.message || String(err)));
        }
        return;
      }
      if(btn.classList.contains('ia-doc-download')){
        const item = IA_DOCS.find(d=>d.id === id);
        if(!item){ alert('Documento n√£o encontrado.'); return; }
        const text = item.text || '';
        const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        const base = (item.name || 'documento').replace(/\.[^/.]+$/,'');
        link.href = url;
        link.download = `${base || 'documento'}-ia.txt`;
        document.body.appendChild(link);
        link.click();
        setTimeout(()=>{
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        }, 0);
      }
    });
    iaChatList?.addEventListener('click', (event)=>{
      const item = event.target.closest('.ia-chat-item');
      if(!item) return;
      const chat = IA_CHATS.find(c=>c.id === item.dataset.id);
      if(chat){ CURRENT_CHAT = chat; renderIAChatList(); renderIAHistory(); focusComposer(); }
    });
    iaRenameChat?.addEventListener('click', async ()=>{
      if(!CURRENT_CHAT) return;
      const suggested = chatTitle(CURRENT_CHAT);
      const response = prompt('Novo t√≠tulo da conversa', suggested);
      if(response === null) return;
      const trimmed = response.trim();
      CURRENT_CHAT.title = trimmed ? deriveTitleFromText(trimmed) : 'Nova conversa';
      touchChat(CURRENT_CHAT);
      renderIAChatList();
      renderIAHistory();
      await saveIAChatsToUserData();
    });
    iaDeleteChat?.addEventListener('click', async ()=>{
      if(!CURRENT_CHAT) return;
      if(!confirm('Excluir esta conversa?')) return;
      const id = CURRENT_CHAT.id;
      IA_CHATS = IA_CHATS.filter(chat=>chat.id !== id);
      if(!IA_CHATS.length){
        CURRENT_CHAT = null;
        renderIAChatList();
        renderIAHistory();
        await saveIAChatsToUserData();
        newIAChat();
        return;
      }
      CURRENT_CHAT = IA_CHATS[0];
      touchChat(CURRENT_CHAT);
      renderIAChatList();
      renderIAHistory();
      await saveIAChatsToUserData();
      focusComposer();
    });
    function renderIA(){
      if(iaQuestion){ iaQuestion.value=""; autoResizeComposer(); }
      renderIAChatList();
      renderIAHistory();
      renderIADocsList();
      updateIADocsStatus();
      ensurePlatformCode();
    }

    // ===== BRIEFING =====
    const briefWrap = $("briefWrap");
    const briefText = $("briefText");
    const briefSave = $("briefSave");
    const briefImportJson = $("briefImportJson");
    const briefWebhookUrl = $("briefWebhookUrl");
    const briefSendWebhook = $("briefSendWebhook");
    const briefIframeUrl = $("briefIframeUrl");
    const briefApplyIframe = $("briefApplyIframe");
    const briefIframe = $("briefIframe");
    const briefFrameShell = $("briefFrameShell");
    const briefForm = $("briefForm");
    const briefGenerateAI = $("briefGenerateAI");
    const briefCopy = $("briefCopy");

    const BRIEF_FIELD_COUNT = 56;
    const BRIEFING_QUESTION_TITLES = [
      "Nome da empresa",
      "Cidade e estado",
      "Cidades principais de atua√ß√£o",
      "Descri√ß√£o detalhada (1 frase)",
      "Servi√ßos/produtos",
      "Como entregam (ex: loja f√≠sica, or√ßamento gratuito, etc.)",
      "Slogan/frase de efeito",
      "Dias e hor√°rios de funcionamento",
      "Diferenciais (3 itens)",
      "Tecnologia/atendimento/experi√™ncia superior",
      "3 empresas refer√™ncia/inspira√ß√£o",
      "Cliente ideal (idade, profiss√£o, regi√£o...)",
      "Dores/problemas antes de contratar",
      "Desejos/resultados esperados",
      "Tom de abordagem preferido",
      "Ticket m√©dio",
      "Taxa de convers√£o (or√ßamento‚Üívenda)",
      "Faturamento m√©dio mensal",
      "Meta de crescimento (6 meses)",
      "Promo√ß√µes atuais",
      "Pacotes/planos/condi√ß√µes especiais",
      "Sazonalidade (vende mais quando?)",
      "Per√≠odos fracos",
      "O que mais chama aten√ß√£o nas redes",
      "Conte√∫do que deseja publicar",
      "Caracter√≠sticas (3 a 5)",
      "Dores/frustra√ß√µes antes de contratar",
      "Transforma√ß√£o ap√≥s contratar",
      "Se sumisse do mercado, o que fariam falta?",
      "O que promete e cumpre como ningu√©m",
      "Como quer ser lembrado",
      "Onde quer estar em 1 ano",
      "Principais desafios",
      "Observa√ß√µes gerais",
      "Sobre o cliente e o neg√≥cio ‚Äì PlayBook",
      "Miss√£o e valores da empresa",
      "Produtos/servi√ßos e Core Business",
      "P√∫blico-alvo ideal (ICP/Persona)",
      "Diferenciais da marca",
      "J√° existe um planejamento da atua√ß√£o?",
      "Principal objetivo com este trabalho",
      "Metas espec√≠ficas a alcan√ßar",
      "Prazo ideal para ver resultados",
      "Manual da marca dispon√≠vel?",
      "Tom de voz ou linguagem espec√≠fica",
      "Refer√™ncias de marcas ou campanhas",
      "Principais concorrentes",
      "O que admira ou deseja evitar no mercado",
      "Canais em que a marca est√° presente",
      "Canais que funcionam melhor atualmente",
      "O que manter ou mudar na presen√ßa digital",
      "Or√ßamento dispon√≠vel",
      "Equipe interna ou parceiros envolvidos",
      "Frequ√™ncia esperada de entregas/resultados",
      "Ponto de contato direto",
      "Aprova√ß√£o dos materiais"
    ];
    let BRIEF = {
      text: "",
      iframeUrl: "",
      webhookUrl: "",
      answers: {}, // q1..q56
      updatedAt: 0
    };

    function briefFieldIds() { return Array.from({length:BRIEF_FIELD_COUNT}, (_,i)=>"q"+(i+1)); }
    function buildBriefClipboardText(){
      const sections = [];
      const noteText = (briefText?.value || "").trim();
      if(noteText){
        sections.push(`Bloco de notas (texto livre)\n${noteText}`);
      }
      briefFieldIds().forEach((fid, index)=>{
        const el = $(fid);
        if(!el) return;
        const title = `${index + 1}. ${BRIEFING_QUESTION_TITLES[index] || fid}`;
        const value = (el.value || "").trim();
        sections.push(`${title}\n${value}`);
      });
      return sections.join("\n\n").trim();
    }
    function buildBriefingIAPrompt(notesText){
      const normalizedNotes = normalizePlainText(notesText || "");
      const questionGuide = BRIEFING_QUESTION_TITLES
        .map((title, index)=> `q${index + 1}: ${title}`)
        .join('\n');
      const notesBlock = normalizedNotes || 'Sem anota√ß√µes fornecidas.';
      return [
        'Voc√™ √© o assistente de marketing da Mediagrowth encarregado de estruturar o briefing completo de um cliente.',
        'Analise cuidadosamente as anota√ß√µes e preencha cada resposta de q1 a q56 com base no contexto fornecido.',
        'Quando a informa√ß√£o estiver presente ou puder ser inferida de forma coerente, utilize-a. Quando n√£o houver dado relacionado, deixe a resposta como string vazia.',
        'Retorne exclusivamente um objeto JSON v√°lido contendo 56 pares chave-valor utilizando as chaves "q1" at√© "q56". Cada valor deve ser uma string em portugu√™s, sem bullet points ou coment√°rios extras.',
        'N√£o inclua texto fora do JSON nem blocos de c√≥digo.',
        `Perguntas do briefing (mapa de chaves):\n${questionGuide}`,
        `Anota√ß√µes do briefing:\n"""\n${notesBlock}\n"""`
      ].join('\n\n');
    }
    function coerceBriefingAnswerValue(value){
      if(value === null || value === undefined) return '';
      if(typeof value === 'string'){
        return normalizePlainText(value);
      }
      if(Array.isArray(value)){
        return value.map(coerceBriefingAnswerValue).filter(Boolean).join(', ');
      }
      if(typeof value === 'object'){
        return Object.values(value).map(coerceBriefingAnswerValue).filter(Boolean).join('; ');
      }
      return normalizePlainText(String(value));
    }
    function extractJsonObject(text){
      if(!text) return null;
      let raw = text.trim();
      const fenced = raw.match(/```(?:json)?([\s\S]*?)```/i);
      if(fenced){
        raw = fenced[1];
      }
      const braceMatch = raw.match(/\{[\s\S]*\}/);
      if(braceMatch){
        raw = braceMatch[0];
      }
      try{
        return JSON.parse(raw);
      }catch(_err){
        return null;
      }
    }
    function parseBriefingAIResponse(text){
      const data = extractJsonObject(text);
      if(!data || typeof data !== 'object') return null;
      if(data.answers && typeof data.answers === 'object'){ return data.answers; }
      return data;
    }
    function renderBrief() {
      briefText.value = BRIEF.text || "";
      briefWebhookUrl.value = BRIEF.webhookUrl || "";
      briefIframeUrl.value = BRIEF.iframeUrl || "";
      if (BRIEF.iframeUrl) {
        const u = sanitizeUrl(BRIEF.iframeUrl);
        if (u && briefIframe.src !== u) briefIframe.src = u;
      } else {
        briefIframe.removeAttribute("src");
      }
      briefFieldIds().forEach(fid=> { const el = $(fid); if (el) el.value = BRIEF.answers?.[fid] || ""; });
    }
    async function persistBrief() {
      const uid = auth.currentUser?.uid; if (!uid) return;
      BRIEF.text = briefText.value || "";
      BRIEF.webhookUrl = (briefWebhookUrl.value||"").trim();
      BRIEF.iframeUrl = (briefIframeUrl.value||"").trim();
      const answers = {};
      briefFieldIds().forEach(fid=> { const el=$(fid); answers[fid]=(el?.value||"").trim(); });
      BRIEF.answers = answers;
      BRIEF.updatedAt = Date.now();
      const key = `brief-${TENANT}`;
      await setDoc(doc(db, "usuarios", uid), { [key]: BRIEF }, { merge: true });
      USER_DATA[key] = BRIEF;
    }
    function loadBriefFromUserData() {
      const key = `brief-${TENANT}`;
      if (USER_DATA[key] && typeof USER_DATA[key] === 'object') {
        BRIEF = { ...BRIEF, ...USER_DATA[key] };
      } else if (USER_DATA.brief && typeof USER_DATA.brief === 'object') {
        BRIEF = { ...BRIEF, ...USER_DATA.brief };
      }
    }
    const debouncedPersistBrief = debounce(async () => { await persistBrief(); }, 1000);
    briefText?.addEventListener('input', debouncedPersistBrief);
    briefForm?.addEventListener('input', debouncedPersistBrief);
    briefWebhookUrl?.addEventListener('input', debouncedPersistBrief);
    briefIframeUrl?.addEventListener('input', debouncedPersistBrief);
    briefSave?.addEventListener("click", async ()=>{ await persistBrief(); alert("Briefing salvo!"); });
    briefCopy?.addEventListener('click', async ()=>{
      const text = buildBriefClipboardText();
      if(!text){
        alert('Nenhum conte√∫do para copiar.');
        return;
      }
      let copied = false;
      try{
        if(navigator?.clipboard?.writeText){
          await navigator.clipboard.writeText(text);
          copied = true;
        }
      }catch(_err){ copied = false; }
      if(!copied){
        try{
          const helper = document.createElement('textarea');
          helper.value = text;
          helper.setAttribute('readonly', '');
          helper.style.position = 'fixed';
          helper.style.opacity = '0';
          document.body.appendChild(helper);
          helper.select();
          document.execCommand('copy');
          document.body.removeChild(helper);
          copied = true;
        }catch(_err){ copied = false; }
      }
      if(copied){
        if(typeof mgToast === 'function'){
          mgToast('Briefing copiado para a √°rea de transfer√™ncia');
        }else{
          alert('Briefing copiado para a √°rea de transfer√™ncia');
        }
      }else{
        alert('N√£o foi poss√≠vel copiar o briefing.');
      }
    });
    briefApplyIframe?.addEventListener("click", async ()=>{ const u = sanitizeUrl(briefIframeUrl.value||""); if(u) briefIframe.src=u; else briefIframe.removeAttribute("src"); await persistBrief(); });
    briefGenerateAI?.addEventListener('click', async ()=>{
      if(!auth?.currentUser){
        alert('Fa√ßa login para gerar o briefing com a I.A.');
        return;
      }
      const OPENROUTER_API_KEY = window.OPENROUTER_API_KEY;
      if(!OPENROUTER_API_KEY){
        alert('Configure a chave da API do OpenRouter para usar a I.A.');
        return;
      }
      const prompt = buildBriefingIAPrompt(briefText?.value || "").trim();
      if(!prompt){
        alert('N√£o foi poss√≠vel montar o prompt para a I.A.');
        return;
      }
      const originalText = briefGenerateAI.textContent;
      briefGenerateAI.disabled = true;
      briefGenerateAI.textContent = 'Gerando...';
      try{
        const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${OPENROUTER_API_KEY}`
          },
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages: [
              { role: 'system', content: 'Voc√™ √© o assistente de marketing da Mediagrowth. Leia as instru√ß√µes e retorne apenas JSON v√°lido com as chaves q1 a q56.' },
              { role: 'user', content: prompt }
            ]
          })
        });
        const data = await response.json();
        if(!response.ok){
          throw new Error(data?.error?.message || `HTTP ${response.status}`);
        }
        const content = data?.choices?.[0]?.message?.content || '';
        const parsed = parseBriefingAIResponse(content);
        if(!parsed){
          throw new Error('N√£o foi poss√≠vel interpretar a resposta da I.A.');
        }
        const fieldIds = briefFieldIds();
        const newAnswers = {};
        fieldIds.forEach((fid, index)=>{
          const keyOptions = [fid, `q${index + 1}`, String(index + 1), BRIEFING_QUESTION_TITLES[index]];
          let value = '';
          for(const key of keyOptions){
            if(Object.prototype.hasOwnProperty.call(parsed, key)){
              value = coerceBriefingAnswerValue(parsed[key]);
              break;
            }
          }
          newAnswers[fid] = value;
        });
        BRIEF.text = briefText?.value || '';
        BRIEF.answers = newAnswers;
        BRIEF.updatedAt = Date.now();
        renderBrief();
        await persistBrief();
        if(typeof mgToast === 'function'){
          mgToast('Briefing atualizado com sucesso');
        } else {
          alert('Briefing atualizado com sucesso');
        }
      }catch(err){
        console.error('briefGenerateAI', err);
        alert(`Falha ao gerar briefing: ${err?.message || err}`);
      }finally{
        briefGenerateAI.disabled = false;
        if(typeof originalText === 'string'){
          briefGenerateAI.textContent = originalText;
        }
      }
    });
    briefImportJson?.addEventListener("click", async ()=>{
      try{ const str=prompt("Cole o JSON com as respostas do formul√°rio:"); if(!str) return;
        const data=JSON.parse(str); const answers={ ...(BRIEF.answers||{}) };
        Object.keys(data||{}).forEach(k=>{ const m=String(k).match(/(\d+)/); if(m){ const i=parseInt(m[1],10); if(i>=1&&i<=BRIEF_FIELD_COUNT) answers["q"+i]=String(data[k]??""); }
          if(answers[k]!==undefined) answers[k]=String(data[k]??""); });
        BRIEF.answers=answers; renderBrief(); await persistBrief(); alert("Dados importados no briefing.");
      }catch(e){ alert("JSON inv√°lido: "+(e.message||String(e))); }
    });
    briefSendWebhook?.addEventListener("click", async ()=>{
      const url=(briefWebhookUrl.value||"").trim(); if(!url){ alert("Informe o Webhook URL."); return; }
      await persistBrief();
      const payload={ tenant:TENANT, user:auth.currentUser?.email||null, brief:BRIEF };
      try{ const res=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
        alert("Webhook enviado: "+res.status);
      }catch(e){ alert("Falha ao enviar webhook: "+(e.message||String(e))); }
    });
    /* ========= cart√µes ========= */
    const MACRO_COMPONENTS = [
      { key: "planejamento", icon: "üóÇÔ∏è", title: "Planejamento", sub: "Demandas e planos em andamento", gradient: "linear-gradient(135deg,#2563eb,#7c3aed)" },
      { key: "metas", icon: "üéØ", title: "Metas", sub: "Objetivos e resultados", gradient: "linear-gradient(135deg,#16a34a,#65a30d)" },
      { key: "posts", icon: "üì£", title: "Posts", sub: "Publica√ß√µes e aprova√ß√µes", gradient: "linear-gradient(135deg,#f97316,#facc15)" }
    ];
    const HISTORY_COLORS = ['#e6194b','#3cb44b','#ffe119','#4363d8','#f58231','#911eb4'];
    const macroSectionRoot = document.getElementById('macroSection');
    let historyChart = null;
    let selectedMonths = [];
    let historyEventsBound = false;

    function getMacroHistoryElements(){
      if(!macroSectionRoot) return {};
      return {
        controls: macroSectionRoot.querySelector('#historyControls'),
        legend: macroSectionRoot.querySelector('#historyLegend'),
        canvas: macroSectionRoot.querySelector('#historyChart'),
        monthSelect: macroSectionRoot.querySelector('#historyMonthSelect')
      };
    }
    const MACRO_HISTORY_KEY_PREFIX = 'macro_history_v1';
    const MACRO_SETTINGS_KEY_PREFIX = 'macro_settings_v1';

    function resolveMacroClientIdentifier(){
      try{
        if(typeof getClientKey === 'function'){
          const key = getClientKey();
          if(key && key !== 'no-client') return key;
        }
      }catch(_){ }
      const bodyClient = document.body?.getAttribute('data-client-id');
      if(bodyClient && bodyClient !== 'no-client') return bodyClient;
      try{
        const search = new URLSearchParams(location.search || '');
        const searchClient = search.get('client');
        if(searchClient) return searchClient;
      }catch(_){ }
      if(location && typeof location.pathname === 'string'){
        const pathClient = location.pathname.replace(/^\/+/, '').split('/')[0];
        if(pathClient) return pathClient;
      }
      return null;
    }

    function getMacroHistoryStorageKey(){
      const uid = auth?.currentUser?.uid || window.auth?.currentUser?.uid || 'anon';
      const client = resolveMacroClientIdentifier() || 'anon';
      return `${MACRO_HISTORY_KEY_PREFIX}_${uid}_${client}`;
    }

    function getMacroSettingsStorageKey(){
      const uid = auth?.currentUser?.uid || window.auth?.currentUser?.uid || 'anon';
      const client = resolveMacroClientIdentifier() || 'anon';
      return `${MACRO_SETTINGS_KEY_PREFIX}_${uid}_${client}`;
    }

    function loadMacroHistory(){
      try{
        const raw = localStorage.getItem(getMacroHistoryStorageKey());
        const arr = raw ? JSON.parse(raw) : [];
        if(!Array.isArray(arr)) return [];
        return arr.filter(item => item && typeof item === 'object' && Number.isFinite(item.ts));
      }catch(_){
        return [];
      }
    }

    function saveMacroHistory(records){
      try{
        localStorage.setItem(getMacroHistoryStorageKey(), JSON.stringify(records));
      }catch(_){ }
    }

    function loadMacroSettings(){
      try{
        const raw = localStorage.getItem(getMacroSettingsStorageKey());
        if(!raw) return {};
        const parsed = JSON.parse(raw);
        return parsed && typeof parsed === 'object' ? parsed : {};
      }catch(_){
        return {};
      }
    }

    function saveMacroSettings(settings){
      try{
        if(!settings || typeof settings !== 'object') return;
        localStorage.setItem(getMacroSettingsStorageKey(), JSON.stringify(settings));
      }catch(_){ }
    }

    function computeDefaultMonthlyPostsTarget(referenceDate = new Date()){
      const date = safeDate(referenceDate) || new Date();
      const year = date.getFullYear();
      const month = date.getMonth();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const weeks = Math.max(4, Math.ceil(daysInMonth / 7));
      return weeks * 3;
    }

    function resolveMacroPostsTarget(referenceDate = new Date()){
      const date = safeDate(referenceDate) || new Date();
      const defaultTarget = computeDefaultMonthlyPostsTarget(date);
      const settings = loadMacroSettings();
      const stored = settings && typeof settings === 'object' ? Number(settings.postsMonthlyTarget) : NaN;
      const normalized = Number.isFinite(stored) && stored > 0 ? Math.round(stored) : null;
      return {
        target: normalized || defaultTarget,
        defaultTarget,
        isCustom: Boolean(normalized)
      };
    }

    function updateMacroPostsTarget(value){
      let settings = loadMacroSettings();
      if(!settings || typeof settings !== 'object') settings = {};
      const raw = typeof value === 'string' ? value.trim() : value;
      if(raw === '' || raw === null || raw === undefined){
        delete settings.postsMonthlyTarget;
        saveMacroSettings(settings);
        return;
      }
      const num = Number(raw);
      if(Number.isFinite(num) && num > 0){
        settings.postsMonthlyTarget = Math.round(num);
      }else{
        delete settings.postsMonthlyTarget;
      }
      saveMacroSettings(settings);
    }

    function handleMacroPostTargetInputEvent(event){
      const input = event?.target;
      if(!(input instanceof HTMLInputElement)) return;
      const raw = (input.value ?? '').toString().trim();
      if(!raw){
        if(input.value !== '') input.value = '';
        updateMacroPostsTarget('');
      }else{
        const num = Number(raw);
        if(Number.isFinite(num) && num > 0){
          const normalized = Math.round(num);
          if(String(normalized) !== input.value){
            input.value = String(normalized);
          }
          updateMacroPostsTarget(normalized);
        }else{
          input.value = '';
          updateMacroPostsTarget('');
        }
      }
      try{ refreshMacroInsights({ immediate: true }); }catch(_){ }
    }

    function handleMacroPostTargetKeydown(event){
      if(event?.key !== 'Enter') return;
      event.preventDefault();
      handleMacroPostTargetInputEvent(event);
      const target = event?.target;
      if(target && typeof target.blur === 'function') target.blur();
    }

    function clamp(value, min, max){
      const num = Number(value);
      if(Number.isNaN(num)) return min;
      return Math.min(Math.max(num, min), max);
    }

    function safeDate(value){
      if(!value) return null;
      try{
        const dt = value instanceof Date ? value : new Date(value);
        return Number.isNaN(dt.getTime()) ? null : dt;
      }catch(_){
        return null;
      }
    }

    function describePerformance(progress){
      if(progress >= 0.85) return 'excelente';
      if(progress >= 0.7) return 'bom';
      if(progress >= 0.5) return 'aten√ß√£o';
      return 'cr√≠tico';
    }

    function computePlanMetrics(demandasList, now){
      const tasks = [];
      const monthTasks = [];
      const source = Array.isArray(demandasList) ? demandasList : [];
      const monthKey = typeof buildMonthKey === 'function'
        ? buildMonthKey(now.getFullYear(), now.getMonth()+1)
        : null;
      source.forEach(item=>{
        if(!item) return;
        const copy = { ...item, planos: item.planos ? { ...item.planos } : {} };
        if(typeof normalizeDemanda === 'function'){
          try{ normalizeDemanda(copy); }catch(_){ }
        }
        const hasContent = (copy.demanda || '').trim() || (copy.status || '').trim() || (copy.responsavel || '').trim();
        if(!hasContent) return;
        tasks.push(copy);
        if(!monthKey){
          monthTasks.push(copy);
          return;
        }
        let matchesMonth = false;
        if(typeof getDemandMonthKeys === 'function'){
          try{
            const months = getDemandMonthKeys(copy);
            if(Array.isArray(months) && months.includes(monthKey)){
              matchesMonth = true;
            }
          }catch(_err){ }
        }
        if(!matchesMonth){
          const due = typeof getDemandaDueDate === 'function' ? getDemandaDueDate(copy) : null;
          if(due && due.getFullYear() === now.getFullYear() && due.getMonth() === now.getMonth()){
            matchesMonth = true;
          }else if(!due && typeof getDemandaStartDate === 'function'){
            const start = getDemandaStartDate(copy);
            if(start && start.getFullYear() === now.getFullYear() && start.getMonth() === now.getMonth()){
              matchesMonth = true;
            }
          }
        }
        if(matchesMonth){
          monthTasks.push(copy);
        }
      });
      const relevantTasks = monthTasks.length ? monthTasks : tasks;
      const total = relevantTasks.length;
      let completed = 0;
      let inProgress = 0;
      let blocked = 0;
      let withDates = 0;
      let withResponsible = 0;
      let lastEdited = 0;
      const timeline = [];
      let overdue = 0;
      relevantTasks.forEach(d=>{
        const status = (d.status || '').toLowerCase();
        if(status === 'concluido' || status === 'concluido-grupo'){ completed++; }
        else if(status === 'em-andamento' || status === 'prioridade' || status === 'prioridade-grupo'){ inProgress++; }
        else if(status === 'bloqueado'){ blocked++; }
        const due = typeof getDemandaDueDate === 'function' ? getDemandaDueDate(d) : null;
        const dueTs = due ? due.getTime() : null;
        if(dueTs !== null){
          withDates++;
          const done = status === 'concluido' || status === 'concluido-grupo';
          if(!done && dueTs < now.getTime()){ overdue++; }
          if(dueTs >= now.getTime() - 1000*60*60*24*2){
            timeline.push({ date: new Date(dueTs), type:'planejamento', title: d.demanda || 'Demanda sem t√≠tulo', meta: d.responsavel || '', status });
          }
        }
        if(d.responsavel && d.responsavel.trim()){ withResponsible++; }
        const edited = Number(d.edited) || 0;
        if(edited > lastEdited) lastEdited = edited;
      });
      const actionableTotal = completed + inProgress;
      const rawProgress = total ? (completed + inProgress * 0.5) / total : 0;
      const progress = clamp(rawProgress, 0, 1);
      const fill = total ? clamp((withDates/Math.max(total,1))*0.6 + (withResponsible/Math.max(total,1))*0.4, 0, 1) : 0;
      timeline.sort((a,b)=> a.date.getTime() - b.date.getTime());
      return {
        progress,
        total,
        completed,
        inProgress,
        actionable: actionableTotal,
        blocked,
        overdue,
        withDates,
        withResponsible,
        fill,
        timeline,
        lastEdited: lastEdited || null
      };
    }

    function normalizeMetaNumber(value){
      if(value === null || value === undefined) return 0;
      const num = typeof value === 'string' ? parseFloat(value) : Number(value);
      return Number.isFinite(num) ? num : 0;
    }

    function evaluateMetaGoal(planned, realized, direction){
      const p = Math.max(0, normalizeMetaNumber(planned));
      const r = normalizeMetaNumber(realized);
      if(p <= 0) return 'missing';
      const dir = (direction || 'aumentar').toLowerCase();
      if(dir === 'diminuir'){
        return r <= p ? 'achieved' : 'in-progress';
      }
      if(dir === 'manter'){
        if(p === 0) return 'in-progress';
        const tolerance = Math.max(Math.abs(p) * 0.05, 0.01);
        return Math.abs(r - p) <= tolerance ? 'achieved' : 'in-progress';
      }
      return r >= p ? 'achieved' : 'in-progress';
    }

    function computeMetaMetrics(metasList, now){
      const metas = Array.isArray(metasList)
        ? metasList.filter(meta => meta && meta.ativo !== false)
        : [];
      const monthIndex = now.getMonth();
      const monthKey = Array.isArray(META_MONTHS) ? META_MONTHS[monthIndex] : null;
      const monthLabel = monthKey ? (META_MONTH_LABELS?.[monthKey] || monthKey.toUpperCase()) : '';
      const total = metas.length;
      const monthly = {
        total,
        defined: 0,
        achieved: 0,
        inProgress: 0,
        missing: 0,
        monthKey,
        monthLabel
      };
      const annual = {
        total,
        defined: 0,
        achieved: 0,
        inProgress: 0,
        missing: 0,
        year: now.getFullYear()
      };
      metas.forEach(meta=>{
        const meses = meta?.meses || {};
        const current = monthKey ? (meses[monthKey] || {}) : {};
        const planned = normalizeMetaNumber(current.p ?? current.P);
        const realized = normalizeMetaNumber(current.r ?? current.R);
        if(planned > 0){
          monthly.defined++;
          const status = evaluateMetaGoal(planned, realized, meta?.direcao);
          if(status === 'achieved') monthly.achieved++;
          else monthly.inProgress++;
        }

        let yearlyPlanned = 0;
        let yearlyRealized = 0;
        if(Array.isArray(META_MONTHS)){
          META_MONTHS.forEach(m=>{
            const info = meses[m] || {};
            yearlyPlanned += normalizeMetaNumber(info.p ?? info.P);
            yearlyRealized += normalizeMetaNumber(info.r ?? info.R);
          });
        }
        if(meta?.modo === 'media'){
          const divisor = Array.isArray(META_MONTHS) && META_MONTHS.length ? META_MONTHS.length : 1;
          yearlyPlanned = yearlyPlanned / divisor;
          yearlyRealized = yearlyRealized / divisor;
        }
        if(yearlyPlanned > 0){
          annual.defined++;
          const annualStatus = evaluateMetaGoal(yearlyPlanned, yearlyRealized, meta?.direcao);
          if(annualStatus === 'achieved') annual.achieved++;
          else annual.inProgress++;
        }
      });
      monthly.missing = Math.max(total - monthly.defined, 0);
      annual.missing = Math.max(total - annual.defined, 0);
      const filled = monthly.defined;
      const progress = monthly.defined ? clamp(monthly.achieved / monthly.defined, 0, 1) : 0;
      const fill = total ? clamp(monthly.defined / total, 0, 1) : 0;
      const summaryLines = [];
      if(total === 0){
        summaryLines.push('Nenhuma meta cadastrada.');
      }else{
        const monthTitle = monthLabel ? `Mensal (${monthLabel})` : 'Mensal';
        summaryLines.push(`${monthTitle}: Definidas ${monthly.defined} ‚Ä¢ Alcan√ßadas ${monthly.achieved} ‚Ä¢ Em andamento ${monthly.inProgress} ‚Ä¢ Por definir ${monthly.missing}`);
        const yearLabel = annual.year ? String(annual.year) : '';
        const annualTitle = yearLabel ? `Anual (${yearLabel})` : 'Anual';
        summaryLines.push(`${annualTitle}: Definidas ${annual.defined} ‚Ä¢ Alcan√ßadas ${annual.achieved} ‚Ä¢ Em andamento ${annual.inProgress} ‚Ä¢ Por definir ${annual.missing}`);
      }
      return {
        progress,
        total,
        filled,
        withPlan: monthly.defined,
        monthKey,
        monthly,
        annual,
        fill,
        summaryLines,
        ratios: []
      };
    }

    function computePostMetrics(postsList, now){
      const posts = Array.isArray(postsList) ? postsList : [];
      const referenceDate = safeDate(now) || new Date();
      const { target, defaultTarget, isCustom } = resolveMacroPostsTarget(referenceDate);
      const monthStart = new Date(referenceDate.getFullYear(), referenceDate.getMonth(), 1);
      const nextMonthStart = new Date(referenceDate.getFullYear(), referenceDate.getMonth() + 1, 1);
      const timeline = [];
      let registered = 0;
      let approved = 0;
      let needsReview = 0;
      let lastApproved = null;
      posts.forEach(post=>{
        if(!post) return;
        const status = (post.status || '').toLowerCase();
        let postDate = safeDate(post.dateISO);
        if(!postDate || !Number.isFinite(postDate.getTime())){
          if(post.createdAt){
            const created = safeDate(post.createdAt);
            if(created && Number.isFinite(created.getTime())) postDate = created;
          }
          if((!postDate || !Number.isFinite(postDate.getTime())) && post.updatedAt){
            const updated = safeDate(post.updatedAt);
            if(updated && Number.isFinite(updated.getTime())) postDate = updated;
          }
        }
        if(!postDate) return;
        const ts = postDate.getTime();
        if(ts < monthStart.getTime() || ts >= nextMonthStart.getTime()) return;
        registered++;
        if(status === 'aprovado'){
          approved++;
          if(!lastApproved || ts > lastApproved.getTime()) lastApproved = postDate;
        }else if(status === 'revisar'){
          needsReview++;
        }
        timeline.push({
          date: postDate,
          type:'posts',
          title: post.desc || 'Post sem descri√ß√£o',
          meta: post.target || 'feed',
          status
        });
      });
      timeline.sort((a,b)=> a.date.getTime() - b.date.getTime());
      const effectiveTarget = target > 0 ? target : 0;
      const plannedContribution = effectiveTarget > 0 ? Math.min(registered, effectiveTarget) * 0.5 : 0;
      const approvalContribution = effectiveTarget > 0 ? Math.min(approved, effectiveTarget) * 0.5 : 0;
      const progress = effectiveTarget > 0
        ? clamp((plannedContribution + approvalContribution) / effectiveTarget, 0, 1)
        : 0;
      const fill = effectiveTarget > 0 ? clamp(registered / effectiveTarget, 0, 1) : 0;
      const remaining = effectiveTarget > 0 ? Math.max(effectiveTarget - approved, 0) : 0;
      const monthLabel = referenceDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
      return {
        progress,
        total: registered,
        registered,
        approved,
        needsReview,
        fill,
        timeline: timeline.slice(0,6),
        lastApproved,
        target: effectiveTarget,
        defaultTarget,
        isCustomTarget: isCustom,
        plannedContribution,
        approvalContribution,
        monthLabel,
        remaining
      };
    }

    function computeBriefingMetrics(brief){
      const answers = brief && typeof brief === 'object' ? brief.answers : null;
      let answered = 0;
      if(answers && typeof answers === 'object'){
        Object.values(answers).forEach(value=>{
          if(typeof value === 'string' && value.trim()){ answered++; }
        });
      }
      const total = BRIEF_FIELD_COUNT || 56;
      const progress = total ? clamp(answered/total, 0, 1) : 0;
      return {
        progress,
        answered,
        total,
        updatedAt: brief?.updatedAt || null
      };
    }

    function buildMacroSupplementalData(){
      let cacState;
      try{ cacState = CAC_DATA; }catch(_){ cacState = null; }
      let refState;
      try{ refState = Array.isArray(REF_SOCIAL) ? REF_SOCIAL : []; }
      catch(_){ refState = []; }
      let notesState;
      try{ notesState = Array.isArray(NOTES) ? NOTES : []; }
      catch(_){ notesState = []; }
      let filesState = Array.isArray(recentFilesCache) ? recentFilesCache : [];
      let competitorsState;
      try{ competitorsState = Array.isArray(COMPETITORS) ? COMPETITORS : []; }
      catch(_){ competitorsState = []; }
      let socialState;
      try{
        socialState = SOCIAL_LINKS && typeof SOCIAL_LINKS === 'object' ? { ...SOCIAL_LINKS } : {};
      }catch(_){
        socialState = {};
      }

      const now = new Date();
      const monthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      const monthLabel = now.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
      const currency = cacState?.currency || 'BRL';
      const monthExpenses = Array.isArray(cacState?.expenses?.[monthKey]) ? cacState.expenses[monthKey] : [];
      const totalExpenses = monthExpenses.reduce((acc, item)=> acc + (Number(item?.val) || 0), 0);
      const monthSales = Number(cacState?.sales?.[monthKey]) || 0;
      const cacValue = monthSales > 0 ? totalExpenses / monthSales : null;
      const cacDisplay = cacValue !== null ? formatMacroCurrency(cacValue, currency) : '‚Äî';
      const expensesDisplay = totalExpenses > 0 ? formatMacroCurrency(totalExpenses, currency) : null;
      let cacDetail = '';
      if(monthSales > 0 && expensesDisplay){
        const salesLabel = monthSales.toLocaleString('pt-BR');
        cacDetail = `${salesLabel} venda(s) ‚Ä¢ Despesas: ${expensesDisplay}`;
      }else if(expensesDisplay){
        cacDetail = `Despesas: ${expensesDisplay} ‚Ä¢ Informe as vendas para calcular o CAC.`;
      }else{
        cacDetail = 'Cadastre despesas e vendas para calcular o CAC do m√™s.';
      }

      const referencesCount = refState.length;
      const categoryMap = new Map();
      refState.forEach(item=>{
        const raw = (item?.category || 'Sem categoria').toString().trim();
        const label = raw || 'Sem categoria';
        categoryMap.set(label, (categoryMap.get(label) || 0) + 1);
      });
      const topCategories = Array.from(categoryMap.entries())
        .sort((a,b)=> b[1] - a[1])
        .slice(0, 2)
        .map(([label, count])=> `${label}: ${count}`);
      let referencesDetail = '';
      if(referencesCount === 0){
        referencesDetail = 'Nenhuma refer√™ncia cadastrada.';
      }else if(topCategories.length){
        referencesDetail = `Principais categorias ‚Ä¢ ${topCategories.join(' ‚Ä¢ ')}`;
      }else{
        referencesDetail = 'Refer√™ncias registradas na plataforma.';
      }

      const sectorLabels = {
        roi: 'ROI',
        'vitrine-engajamento': 'Vitrine/Engajamento',
        novasideias: 'Novas Ideias',
        relacionamento: 'Relacionamento',
        ia: 'I.A',
        gbp: 'Google Business Profile'
      };
      const noteItems = notesState
        .map(note=>{
          if(!note || typeof note !== 'object') return null;
          const title = (note.title || '').trim() || 'Anota√ß√£o sem t√≠tulo';
          const timestamps = [note.updatedAt, note.createdAt]
            .map(val=> Number(val))
            .filter(val=> Number.isFinite(val));
          let date = null;
          if(timestamps.length){
            const ts = Math.max(...timestamps);
            date = new Date(ts);
          }else if(note.dateISO){
            const parsed = new Date(note.dateISO);
            if(Number.isFinite(parsed.getTime())) date = parsed;
          }
          const subtitleParts = [];
          if(date){
            subtitleParts.push(formatMacroDate(date));
          }
          const sector = (note.sector || '').toString().trim();
          if(sector){
            subtitleParts.push(sectorLabels[sector] || sector);
          }
          return {
            title,
            subtitle: subtitleParts.join(' ‚Ä¢ '),
            ts: date ? date.getTime() : 0
          };
        })
        .filter(Boolean)
        .sort((a,b)=> (b.ts || 0) - (a.ts || 0))
        .slice(0, 3);

      const fileItems = filesState
        .map(file=>{
          const name = (file?.name || '').trim() || 'Arquivo sem nome';
          const createdAt = Number(file?.createdAt);
          const date = Number.isFinite(createdAt) ? new Date(createdAt) : null;
          const subtitleParts = [];
          if(date){
            subtitleParts.push(formatMacroDate(date));
          }
          if(file?.folderLabel){
            subtitleParts.push(file.folderLabel);
          }
          return {
            title: name,
            subtitle: subtitleParts.join(' ‚Ä¢ '),
            ts: date ? date.getTime() : 0
          };
        })
        .filter(Boolean)
        .sort((a,b)=> (b.ts || 0) - (a.ts || 0))
        .slice(0, 4);

      const competitorItems = competitorsState
        .map((comp, idx)=>{
          const title = (comp?.name || comp?.link || `Concorrente ${idx + 1}`).toString().trim();
          const subtitleParts = [];
          if(comp?.tags){
            subtitleParts.push(comp.tags);
          }
          if(comp?.link){
            subtitleParts.push(comp.link);
          }
          return {
            title,
            subtitle: subtitleParts.join(' ‚Ä¢ ')
          };
        })
        .slice(0, 5);

      const socialNetworks = [
        { key: 'instagram', label: 'Instagram' },
        { key: 'facebook', label: 'Facebook' },
        { key: 'linkedin', label: 'LinkedIn' },
        { key: 'tiktok', label: 'TikTok' },
        { key: 'youtube', label: 'YouTube' },
        { key: 'whatsapp', label: 'WhatsApp' },
        { key: 'website', label: 'Site' }
      ];
      const socialItems = socialNetworks.map(meta=>{
        const raw = (socialState?.[meta.key] || '').toString().trim();
        const hasLink = raw.length > 0;
        let iconInfo = null;
        try{
          iconInfo = typeof SOCIAL_ICONS !== 'undefined' ? SOCIAL_ICONS[meta.key] || null : null;
        }catch(_){
          iconInfo = null;
        }
        return {
          key: meta.key,
          label: meta.label,
          hasLink,
          link: hasLink ? raw : null,
          status: hasLink ? 'ok' : 'missing',
          statusLabel: hasLink ? 'OK' : 'Indispon√≠vel',
          detail: hasLink ? 'Link conectado' : 'Falta adicionar',
          icon: {
            src: iconInfo && iconInfo.src ? iconInfo.src : null,
            emoji: iconInfo && iconInfo.emoji ? iconInfo.emoji : null
          }
        };
      });
      const socialConfigured = socialItems.filter(item=> item.hasLink).length;
      const socialTotal = socialItems.length;
      const socialPercent = socialTotal ? Math.round((socialConfigured / socialTotal) * 100) : 0;
      const socialSummaryText = socialTotal
        ? `${socialConfigured} de ${socialTotal} redes configuradas ‚Ä¢ ${socialPercent}% conclu√≠do`
        : 'Nenhuma rede social configurada.';

      return {
        cac: {
          title: `CAC do m√™s (${monthLabel})`,
          value: cacDisplay,
          detail: cacDetail
        },
        references: {
          title: 'Refer√™ncias cadastradas',
          value: referencesCount.toLocaleString('pt-BR'),
          detail: referencesDetail
        },
        notes: {
          items: noteItems,
          emptyMessage: 'Nenhuma anota√ß√£o registrada recentemente.'
        },
        files: {
          items: fileItems,
          emptyMessage: 'Nenhum arquivo enviado recentemente.'
        },
        competitors: {
          items: competitorItems,
          emptyMessage: 'Nenhum concorrente cadastrado.'
        },
        social: {
          items: socialItems,
          summary: {
            ready: socialConfigured,
            total: socialTotal,
            percent: socialPercent,
            text: socialSummaryText
          }
        }
      };
    }

    function computeMacroInsightsSources({ demandas = [], metas = [], posts = [], brief = null } = {}){
      const now = new Date();
      const plan = computePlanMetrics(demandas, now);
      const metasMetrics = computeMetaMetrics(metas, now);
      const postsMetrics = computePostMetrics(posts, now);
      const briefingMetrics = computeBriefingMetrics(brief);
      const components = {};
      MACRO_COMPONENTS.forEach(comp=>{
        const base =
          comp.key === 'planejamento' ? plan :
          comp.key === 'metas' ? metasMetrics :
          postsMetrics;
        components[comp.key] = {
          ...base,
          label: comp.title,
          icon: comp.icon,
          gradient: comp.gradient,
          description: comp.sub,
          progress: clamp(base.progress ?? 0, 0, 1),
          status: describePerformance(base.progress ?? 0)
        };
      });
      const weights = { planejamento: 0.4, metas: 0.3, posts: 0.3 };
      let weighted = 0;
      let weightTotal = 0;
      MACRO_COMPONENTS.forEach(comp=>{
        const w = weights[comp.key] ?? (1/MACRO_COMPONENTS.length);
        const progress = components[comp.key]?.progress ?? 0;
        weighted += progress * w;
        weightTotal += w;
      });
      const normalized = weightTotal ? weighted/weightTotal : 0;
      const score = Math.round(normalized * 100);
      const levelKey = describePerformance(normalized);
      const level = levelKey === 'excelente' ? 'Excelente'
        : levelKey === 'bom' ? 'Bom'
        : levelKey === 'aten√ß√£o' ? 'Aten√ß√£o'
        : 'Cr√≠tico';
      const timeline = [...plan.timeline.slice(0,4), ...postsMetrics.timeline.slice(0,4)]
        .sort((a,b)=> a.date.getTime() - b.date.getTime())
        .slice(0,8);
      const checklist = [
        {
          label: 'Planejamento em dia',
          done: plan.progress >= 0.7 && plan.overdue === 0 && plan.total > 0,
          detail: plan.total ? `${plan.completed}/${plan.total} conclu√≠das ‚Ä¢ ${plan.overdue} atrasadas` : 'Cadastre as demandas estrat√©gicas do cliente.'
        },
        {
          label: 'Metas atualizadas',
          done: metasMetrics.progress >= 0.6 && metasMetrics.total > 0,
          detail: metasMetrics.total
            ? `${metasMetrics.monthly.achieved} metas alcan√ßadas ‚Ä¢ ${metasMetrics.monthly.inProgress} em andamento ‚Ä¢ ${metasMetrics.monthly.missing} sem defini√ß√£o`
            : 'Nenhuma meta cadastrada.'
        },
        {
          label: 'Posts aprovados',
          done: postsMetrics.target > 0 && postsMetrics.progress >= 0.6 && postsMetrics.registered > 0,
          detail: postsMetrics.registered > 0
            ? (postsMetrics.target > 0
              ? `Meta: ${postsMetrics.target} ‚Ä¢ Cadastrados: ${postsMetrics.registered} ‚Ä¢ Aprovados: ${postsMetrics.approved}${postsMetrics.needsReview ? ` ‚Ä¢ ${postsMetrics.needsReview} aguardando revis√£o` : ''}`
              : 'Defina a meta mensal de posts para calcular o progresso.')
            : 'Nenhum post cadastrado.'
        },
        {
          label: 'Briefing completo',
          done: briefingMetrics.progress >= 0.7,
          detail: `${briefingMetrics.answered}/${briefingMetrics.total} respostas preenchidas`
        }
      ];
      const alerts = [];
      if(plan.total === 0){
        alerts.push({ type: 'warn', text: 'Nenhum planejamento cadastrado. Organize as a√ß√µes estrat√©gicas do cliente.' });
      }else{
        if(plan.overdue > 0){
          alerts.push({ type: 'warn', text: `${plan.overdue} demanda(s) est√°(√£o) atrasada(s). Reforce as responsabilidades.` });
        }
        if(plan.inProgress === 0 && plan.completed < plan.total){
          alerts.push({ type: 'warn', text: 'Nenhuma demanda em andamento. Verifique o status das entregas.' });
        }
      }
      if(metasMetrics.total === 0){
        alerts.push({ type: 'warn', text: 'Cadastre metas mensais para acompanhar o desempenho comercial.' });
      }else if(metasMetrics.progress < 0.5){
        alerts.push({ type: 'warn', text: 'As metas do m√™s est√£o com baixa execu√ß√£o. Revise os n√∫meros planejados vs realizados.' });
      }
      if(postsMetrics.registered === 0){
        alerts.push({ type: 'warn', text: 'Nenhum post cadastrado no calend√°rio. Adicione as publica√ß√µes planejadas.' });
      }else{
        if(postsMetrics.approved/Math.max(postsMetrics.registered,1) < 0.5){
          alerts.push({ type: 'warn', text: 'Menos da metade dos posts est√° aprovada. Ajuste o pipeline com o cliente.' });
        }
        if(postsMetrics.needsReview > 0){
          alerts.push({ type: 'warn', text: `${postsMetrics.needsReview} post(s) aguardam revis√£o.` });
        }
        const missingPlanned = Math.max(postsMetrics.target - postsMetrics.registered, 0);
        if(missingPlanned > 0){
          alerts.push({ type: 'warn', text: `Cadastre mais ${missingPlanned} post(s) para atingir a meta mensal.` });
        }
        const missingApproved = Math.max(postsMetrics.target - postsMetrics.approved, 0);
        if(missingApproved > 0){
          alerts.push({ type: 'warn', text: `${missingApproved} post(s) ainda precisam ser aprovados para cumprir a meta mensal.` });
        }
      }
      if(briefingMetrics.progress < 0.5){
        alerts.push({ type: 'warn', text: 'Briefing incompleto. Preencha as informa√ß√µes essenciais do cliente.' });
      }
      if(!alerts.length){
        alerts.push({ type: 'ok', text: 'Nenhum alerta cr√≠tico no momento. Continue monitorando os indicadores.' });
      }
      const actionable = plan.actionable || 0;
      const completionPercent = Math.round(clamp(plan.progress || 0, 0, 1) * 100);
      const completionDetail = plan.total === 0
        ? 'Cadastre novas demandas.'
        : actionable === 0
          ? `${plan.total} pendentes ‚Ä¢ ${plan.overdue} atrasadas`
          : `${plan.completed}/${actionable} conclu√≠das ‚Ä¢ ${plan.inProgress} em andamento ‚Ä¢ ${plan.overdue} atrasadas`;
      const postsMiniDetailParts = [];
      if(postsMetrics.registered > 0){
        postsMiniDetailParts.push(`Meta ${postsMetrics.isCustomTarget ? 'personalizada' : 'padr√£o'}: ${postsMetrics.target}`);
        postsMiniDetailParts.push(`Cadastrados: ${postsMetrics.registered}`);
        postsMiniDetailParts.push(`Aprovados: ${postsMetrics.approved}`);
        if(postsMetrics.needsReview > 0){
          postsMiniDetailParts.push(`${postsMetrics.needsReview} aguardando revis√£o`);
        }
      }
      const postsMiniDetail = postsMiniDetailParts.length ? postsMiniDetailParts.join(' ‚Ä¢ ') : 'Nenhum post cadastrado.';
      const postsMiniValue = postsMetrics.target > 0 ? `${postsMetrics.approved}/${postsMetrics.target}` : String(postsMetrics.approved);
      const miniCards = [
        { title: 'Demandas conclu√≠das', value: `${completionPercent}%`, detail: completionDetail },
        { title: 'Metas com dados', value: metasMetrics.total ? `${metasMetrics.monthly.defined}/${metasMetrics.total}` : '0', detail: metasMetrics.total ? `Alcan√ßadas: ${metasMetrics.monthly.achieved} ‚Ä¢ Em andamento: ${metasMetrics.monthly.inProgress} ‚Ä¢ Por definir: ${metasMetrics.monthly.missing}` : 'Inclua metas para o m√™s atual.' },
        { title: 'Posts do m√™s', value: postsMiniValue, detail: postsMiniDetail }
      ];
      const fillIndicators = [
        {
          label: 'Briefing',
          percent: Math.round(briefingMetrics.progress * 100),
          description: `${briefingMetrics.answered}/${briefingMetrics.total} respostas preenchidas`
        },
        {
          label: 'Planejamento',
          percent: Math.round(plan.fill * 100),
          description: plan.total ? `${plan.withDates}/${plan.total} com prazo ‚Ä¢ ${plan.withResponsible}/${plan.total} com respons√°vel` : 'Nenhuma demanda cadastrada.'
        },
        {
          label: 'Metas',
          percent: Math.round(metasMetrics.fill * 100),
          description: metasMetrics.total ? `${metasMetrics.monthly.defined}/${metasMetrics.total} metas definidas ‚Ä¢ ${metasMetrics.monthly.missing} por definir` : 'Cadastre metas mensais.'
        },
        {
          label: 'Posts',
          percent: Math.round(postsMetrics.progress * 100),
          description: postsMetrics.registered > 0
            ? `Meta: ${postsMetrics.target} ‚Ä¢ Cadastrados: ${postsMetrics.registered} ‚Ä¢ Aprovados: ${postsMetrics.approved}${postsMetrics.needsReview ? ` ‚Ä¢ ${postsMetrics.needsReview} aguardando revis√£o` : ''}`
            : 'Nenhum post registrado.'
        }
      ];
      const scoreTip = MACRO_COMPONENTS.map(comp=>{
        const data = components[comp.key];
        const pct = Math.round(clamp(data?.progress ?? 0, 0, 1) * 100);
        return `${comp.title}: ${pct}%`;
      }).join(' ‚Ä¢ ');
      return {
        score,
        level,
        levelKey,
        components,
        checklist,
        alerts,
        miniCards,
        fillIndicators,
        timeline,
        briefing: briefingMetrics,
        generatedAt: now,
        scoreTip,
        supplemental: buildMacroSupplementalData()
      };
    }

    function computeMacroInsights(){
      return computeMacroInsightsSources({
        demandas: DEMANDAS,
        metas: METAS,
        posts: POSTS,
        brief: BRIEF
      });
    }

    let lastMacroInsights = null;
    const MACRO_REFRESH_DEBOUNCE = 140;
    let macroRefreshTimer = null;
    let macroPendingRender = false;
    let macroDomRefs = null;
    let recentFilesCache = [];
    const MACRO_DATE_TIME_FORMATTER = new Intl.DateTimeFormat('pt-BR', { dateStyle: 'short', timeStyle: 'short' });

    function formatMacroCurrency(value, currencyCode){
      const amount = Number(value);
      if(!Number.isFinite(amount)) return '‚Äî';
      const code = (currencyCode || 'BRL').toUpperCase();
      const locale = code === 'USD' ? 'en-US' : 'pt-BR';
      try{
        return new Intl.NumberFormat(locale, {
          style: 'currency',
          currency: code,
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        }).format(amount);
      }catch(_){
        return `${code} ${amount.toFixed(2)}`;
      }
    }

    function formatMacroDate(value){
      if(!(value instanceof Date) || Number.isNaN(value.getTime())) return '';
      try{
        return MACRO_DATE_TIME_FORMATTER.format(value);
      }catch(_){
        return value.toLocaleString('pt-BR');
      }
    }

    function createMacroDom(){
      const root = document.createElement('div');
      root.className = 'macro-intel';

      const summary = document.createElement('section');
      summary.className = 'macro-summary';
      const left = document.createElement('div');
      left.className = 'macro-summary-left';
      const levelEl = document.createElement('div');
      levelEl.className = 'macro-summary-level';
      const scoreEl = document.createElement('div');
      scoreEl.className = 'macro-summary-score';
      const detail = document.createElement('div');
      detail.className = 'macro-summary-detail';
      detail.textContent = 'Monitoramento autom√°tico dos principais indicadores do cliente.';
      left.append(levelEl, scoreEl, detail);
      summary.appendChild(left);
      const metaWrap = document.createElement('div');
      metaWrap.className = 'macro-summary-meta';
      const generatedEl = document.createElement('span');
      const tipEl = document.createElement('span');
      metaWrap.append(generatedEl, tipEl);
      summary.appendChild(metaWrap);
      root.appendChild(summary);

      const progressGrid = document.createElement('div');
      progressGrid.className = 'macro-progress-grid';
      const progressRefs = new Map();
      MACRO_COMPONENTS.forEach(comp=>{
        const card = document.createElement('div');
        card.className = 'macro-progress-card';
        card.dataset.macroKey = comp.key;
        card.dataset.defaultGradient = comp.gradient || '';
        card.style.background = comp.gradient || '';
        const title = document.createElement('strong');
        title.textContent = `${comp.icon} ${comp.title}`;
        const sub = document.createElement('small');
        sub.textContent = comp.sub;
        const summaryBox = document.createElement('div');
        summaryBox.className = 'macro-progress-summary';
        let summaryMetric = null;
        if(comp.key === 'posts'){
          const valueDisplay = document.createElement('div');
          valueDisplay.className = 'macro-post-target-value';
          const valueNumber = document.createElement('span');
          valueNumber.textContent = '‚Äî';
          valueDisplay.appendChild(valueNumber);
          summaryBox.append(valueDisplay);
          summaryMetric = valueNumber;
        }
        const value = document.createElement('div');
        value.className = 'macro-progress-value';
        const bar = document.createElement('div');
        bar.className = 'macro-progress-bar';
        const fill = document.createElement('div');
        fill.className = 'macro-progress-fill';
        bar.appendChild(fill);
        const meta = document.createElement('div');
        meta.className = 'macro-progress-meta';
        const statusText = document.createElement('span');
        const statusIcon = document.createElement('span');
        meta.append(statusText, statusIcon);
        card.append(title, sub, summaryBox, value, bar, meta);
        progressGrid.appendChild(card);
        progressRefs.set(comp.key, {
          card,
          summaryEl: summaryBox,
          summaryMetricEl: summaryMetric,
          valueEl: value,
          fillEl: fill,
          statusTextEl: statusText,
          statusIconEl: statusIcon
        });
      });
      root.appendChild(progressGrid);

      function createGoalsCard(title){
        const card = document.createElement('div');
        card.className = 'macro-goals-card';
        const titleEl = document.createElement('h4');
        titleEl.className = 'macro-goals-card-title';
        titleEl.textContent = title;
        card.appendChild(titleEl);
        const rows = {};
        [
          ['defined', 'Definidas'],
          ['achieved', 'Alcan√ßadas'],
          ['inProgress', 'Em andamento'],
          ['missing', 'Por definir']
        ].forEach(([key, label])=>{
          const row = document.createElement('div');
          row.className = 'macro-goals-row';
          const labelEl = document.createElement('span');
          labelEl.className = 'macro-goals-label';
          labelEl.textContent = label;
          const valueEl = document.createElement('span');
          valueEl.className = 'macro-goals-value';
          valueEl.textContent = '0';
          row.append(labelEl, valueEl);
          card.appendChild(row);
          rows[key] = valueEl;
        });
        return { card, titleEl, rows };
      }

      const goalsDetail = document.createElement('section');
      goalsDetail.className = 'macro-goals-detail';
      const goalsTitle = document.createElement('h3');
      goalsTitle.className = 'macro-goals-detail-title';
      goalsTitle.textContent = 'Detalhes das metas';
      const goalsContent = document.createElement('div');
      goalsContent.className = 'macro-goals-detail-content';
      const monthlyCard = createGoalsCard('Metas mensais');
      const annualCard = createGoalsCard('Metas anuais');
      goalsContent.append(monthlyCard.card, annualCard.card);
      const goalsEmpty = document.createElement('div');
      goalsEmpty.className = 'macro-goals-empty';
      goalsEmpty.textContent = 'Nenhuma meta cadastrada.';
      goalsDetail.append(goalsTitle, goalsContent, goalsEmpty);
      root.appendChild(goalsDetail);

      const sections = document.createElement('div');
      sections.className = 'macro-sections';

      const timeline = document.createElement('div');
      timeline.className = 'macro-timeline';
      const tlTitle = document.createElement('h3');
      tlTitle.className = 'macro-section-title';
      tlTitle.textContent = 'Timeline de marcos';
      const timelineList = document.createElement('div');
      timelineList.className = 'macro-timeline-list';
      timelineList.style.display = 'none';
      const timelineEmpty = document.createElement('div');
      timelineEmpty.className = 'macro-empty';
      timelineEmpty.textContent = 'Sem eventos recentes. Cadastre novas demandas, posts ou atualiza√ß√µes para alimentar a timeline.';
      timeline.append(tlTitle, timelineList, timelineEmpty);
      sections.appendChild(timeline);

      const checklist = document.createElement('div');
      checklist.className = 'macro-checklist';
      const checkTitle = document.createElement('h3');
      checkTitle.className = 'macro-section-title';
      checkTitle.textContent = 'Checklist r√°pido';
      checklist.appendChild(checkTitle);
      sections.appendChild(checklist);

      root.appendChild(sections);

      const alertsWrap = document.createElement('div');
      alertsWrap.className = 'macro-alerts';
      root.appendChild(alertsWrap);

      const mini = document.createElement('div');
      mini.className = 'macro-mini-dashboard';
      root.appendChild(mini);

      const fill = document.createElement('div');
      fill.className = 'macro-fill';
      root.appendChild(fill);

      const supplemental = document.createElement('section');
      supplemental.className = 'macro-supplemental';

      function createMetricCard(label){
        const card = document.createElement('div');
        card.className = 'macro-metric-card';
        const titleEl = document.createElement('h4');
        titleEl.className = 'macro-metric-title';
        titleEl.textContent = label;
        const valueEl = document.createElement('div');
        valueEl.className = 'macro-metric-value';
        valueEl.textContent = '‚Äî';
        const detailEl = document.createElement('div');
        detailEl.className = 'macro-metric-detail';
        detailEl.textContent = ' ';
        card.append(titleEl, valueEl, detailEl);
        return { card, titleEl, valueEl, detailEl };
      }

      const metricsWrap = document.createElement('div');
      metricsWrap.className = 'macro-supplemental-grid';
      const cacMetric = createMetricCard('CAC do m√™s');
      const refsMetric = createMetricCard('Refer√™ncias cadastradas');
      metricsWrap.append(cacMetric.card, refsMetric.card);
      supplemental.appendChild(metricsWrap);

      function createListCard(label){
        const card = document.createElement('div');
        card.className = 'macro-list-card';
        const titleEl = document.createElement('h4');
        titleEl.className = 'macro-list-title';
        titleEl.textContent = label;
        const listEl = document.createElement('div');
        listEl.className = 'macro-list-items';
        listEl.style.display = 'none';
        const emptyEl = document.createElement('div');
        emptyEl.className = 'macro-list-empty';
        emptyEl.textContent = 'Nenhum registro encontrado.';
        emptyEl.style.display = 'block';
        card.append(titleEl, listEl, emptyEl);
        return { card, titleEl, listEl, emptyEl };
      }

      const notesCard = createListCard('√öltimas anota√ß√µes');
      const filesCard = createListCard('√öltimos arquivos adicionados');
      const competitorsCard = createListCard('Concorrentes cadastrados');
      const listsWrap = document.createElement('div');
      listsWrap.className = 'macro-supplemental-grid';
      listsWrap.append(notesCard.card, filesCard.card, competitorsCard.card);
      supplemental.appendChild(listsWrap);
      const socialCard = document.createElement('div');
      socialCard.className = 'macro-social-card';
      const socialTitle = document.createElement('h4');
      socialTitle.className = 'macro-social-title';
      socialTitle.textContent = 'Redes Sociais Dispon√≠veis na plataforma';
      const socialGrid = document.createElement('div');
      socialGrid.className = 'macro-social-grid';
      const socialSummary = document.createElement('div');
      socialSummary.className = 'macro-social-summary';
      socialSummary.textContent = 'Monitorando redes sociais configuradas.';
      socialCard.append(socialTitle, socialGrid, socialSummary);
      supplemental.appendChild(socialCard);
      root.appendChild(supplemental);

      return {
        root,
        summary: { levelEl, scoreEl, generatedEl, tipEl },
        progress: { grid: progressGrid, cards: progressRefs },
        goalsDetail: {
          container: goalsDetail,
          titleEl: goalsTitle,
          contentEl: goalsContent,
          emptyEl: goalsEmpty,
          monthly: { titleEl: monthlyCard.titleEl, values: monthlyCard.rows },
          annual: { titleEl: annualCard.titleEl, values: annualCard.rows }
        },
        timeline: { list: timelineList, empty: timelineEmpty },
        checklist: { container: checklist, titleEl: checkTitle },
        alerts: { container: alertsWrap },
        mini: { container: mini },
        fill: { container: fill },
        supplemental: {
          container: supplemental,
          metrics: {
            cac: { titleEl: cacMetric.titleEl, valueEl: cacMetric.valueEl, detailEl: cacMetric.detailEl },
            references: { titleEl: refsMetric.titleEl, valueEl: refsMetric.valueEl, detailEl: refsMetric.detailEl }
          },
          lists: {
            notes: { listEl: notesCard.listEl, emptyEl: notesCard.emptyEl },
            files: { listEl: filesCard.listEl, emptyEl: filesCard.emptyEl },
            competitors: { listEl: competitorsCard.listEl, emptyEl: competitorsCard.emptyEl }
          },
          social: {
            card: socialCard,
            gridEl: socialGrid,
            summaryEl: socialSummary
          }
        }
      };
    }

    function ensureMacroDom(){
      if(!dashboard) return null;
      if(macroDomRefs && macroDomRefs.root && dashboard.contains(macroDomRefs.root)){
        return macroDomRefs;
      }
      macroDomRefs = createMacroDom();
      dashboard.innerHTML = '';
      dashboard.appendChild(macroDomRefs.root);
      if(typeof updateMacroSocialFromHeader === 'function'){
        requestAnimationFrame(()=> updateMacroSocialFromHeader());
      }
      return macroDomRefs;
    }

    function updateMacroSummary(insights){
      if(!macroDomRefs || !macroDomRefs.summary) return;
      const { levelEl, scoreEl, generatedEl, tipEl } = macroDomRefs.summary;
      if(levelEl) levelEl.textContent = insights.level;
      if(scoreEl) scoreEl.textContent = `${insights.score}`;
      if(generatedEl){
        generatedEl.textContent = `Atualizado em ${insights.generatedAt.toLocaleString('pt-BR')}`;
      }
      if(tipEl) tipEl.textContent = insights.scoreTip;
    }

    function formatMacroStatusLabel(status){
      const raw = (status || '').toLowerCase();
      if(raw === 'excelente') return 'Excelente';
      if(raw === 'bom') return 'Bom';
      if(raw === 'aten√ß√£o') return 'Aten√ß√£o';
      if(raw === 'critico' || raw === 'cr√≠tico') return 'Cr√≠tico';
      if(!raw) return 'Sem status';
      return raw.charAt(0).toUpperCase() + raw.slice(1);
    }

    function updateMacroGoalsDetail(metaData){
      if(!macroDomRefs || !macroDomRefs.goalsDetail) return;
      const { container, contentEl, emptyEl, monthly, annual } = macroDomRefs.goalsDetail;
      if(!container) return;

      if(container.style.display === 'none'){
        container.style.display = '';
      }

      if(!metaData){
        if(contentEl) contentEl.style.display = 'none';
        if(emptyEl){
          emptyEl.style.display = 'block';
          emptyEl.textContent = 'Nenhuma meta cadastrada.';
        }
        return;
      }

      const hasData = (metaData.total ?? 0) > 0;
      if(contentEl) contentEl.style.display = 'grid';
      if(emptyEl){
        emptyEl.style.display = hasData ? 'none' : 'block';
        if(!hasData){
          emptyEl.textContent = 'Nenhuma meta cadastrada.';
        }
      }

      const numberFormat = (value)=>{
        const num = Number(value) || 0;
        return num.toLocaleString('pt-BR');
      };

      const monthlyData = metaData.monthly || {};
      if(monthly?.titleEl){
        const monthLabel = (monthlyData.monthLabel || '').trim();
        monthly.titleEl.textContent = monthLabel ? `Metas mensais (${monthLabel})` : 'Metas mensais';
      }
      if(monthly?.values){
        const { defined, achieved, inProgress, missing } = monthly.values;
        if(defined) defined.textContent = numberFormat(monthlyData.defined);
        if(achieved) achieved.textContent = numberFormat(monthlyData.achieved);
        if(inProgress) inProgress.textContent = numberFormat(monthlyData.inProgress);
        if(missing) missing.textContent = numberFormat(monthlyData.missing);
      }

      const annualData = metaData.annual || {};
      if(annual?.titleEl){
        const yearLabel = annualData.year ? ` (${annualData.year})` : '';
        annual.titleEl.textContent = `Metas anuais${yearLabel}`;
      }
      if(annual?.values){
        const { defined, achieved, inProgress, missing } = annual.values;
        if(defined) defined.textContent = numberFormat(annualData.defined);
        if(achieved) achieved.textContent = numberFormat(annualData.achieved);
        if(inProgress) inProgress.textContent = numberFormat(annualData.inProgress);
        if(missing) missing.textContent = numberFormat(annualData.missing);
      }
    }

    function updateMacroProgress(insights){
      if(!macroDomRefs || !macroDomRefs.progress) return;
      const { cards } = macroDomRefs.progress;
      let metasUpdated = false;
      cards.forEach((refs, key)=>{
        const data = insights.components?.[key];
        if(!data) return;
        const pct = Math.round(clamp(data.progress || 0, 0, 1) * 100);
        if(refs.valueEl && refs.valueEl.textContent !== `${pct}%`){
          refs.valueEl.textContent = `${pct}%`;
        }
        if(refs.valueEl){
          if(refs.valueEl.style.display !== ''){
            refs.valueEl.style.display = '';
          }
        }
        if(refs.fillEl){
          const width = `${pct}%`;
          if(refs.fillEl.style.width !== width){
            refs.fillEl.style.width = width;
          }
        }
        if(refs.summaryEl){
          if(key === 'metas'){
            if(refs.summaryEl.innerHTML !== ''){
              refs.summaryEl.innerHTML = '';
            }
            if(refs.summaryEl.style.display !== 'none'){
              refs.summaryEl.style.display = 'none';
            }
            refs.summaryEl.classList.remove('is-visible');
          }else if(key === 'posts'){
            if(!refs.summaryEl.classList.contains('is-visible')){
              refs.summaryEl.classList.add('is-visible');
            }
            if(refs.summaryEl.style.display !== ''){
              refs.summaryEl.style.display = '';
            }
            if(refs.summaryMetricEl){
              const targetValue = data.target > 0 ? data.target : data.defaultTarget;
              const metricText = targetValue > 0 ? `${targetValue} posts/m√™s` : '‚Äî';
              if(refs.summaryMetricEl.textContent !== metricText){
                refs.summaryMetricEl.textContent = metricText;
              }
            }
          }else{
            refs.summaryEl.classList.remove('is-visible');
            if(refs.summaryEl.style.display !== 'none'){
              refs.summaryEl.style.display = 'none';
            }
          }
        }
        if(refs.statusTextEl){
          const label = `Status: ${formatMacroStatusLabel(data.status)}`;
          if(refs.statusTextEl.textContent !== label){
            refs.statusTextEl.textContent = label;
          }
        }
        if(refs.statusIconEl){
          const icon = data.status === 'excelente' ? '‚úÖ'
            : data.status === 'bom' ? 'üü¢'
            : data.status === 'aten√ß√£o' ? '‚ö†Ô∏è'
            : 'üî¥';
          if(refs.statusIconEl.textContent !== icon){
            refs.statusIconEl.textContent = icon;
          }
        }
        if(refs.card){
          const bg = data.gradient || refs.card.dataset.defaultGradient || '';
          if(refs.card.style.background !== bg){
            refs.card.style.background = bg;
          }
        }
        if(key === 'metas'){
          metasUpdated = true;
          updateMacroGoalsDetail(data);
        }
      });
      if(!metasUpdated){
        updateMacroGoalsDetail(null);
      }
    }

    function buildTimelineKey(item, index = 0){
      const dt = safeDate(item?.date) || new Date(0);
      const meta = item?.meta || '';
      const status = item?.status || '';
      return `${dt.getTime()}|${item?.type || ''}|${item?.title || ''}|${meta}|${status}|${index}`;
    }

    function createTimelineRow(item, key){
      const row = document.createElement('div');
      row.className = 'macro-timeline-item';
      row.dataset.macroKey = key;
      const dateEl = document.createElement('div');
      dateEl.className = 'macro-timeline-date';
      const content = document.createElement('div');
      content.className = 'macro-timeline-content';
      const labelEl = document.createElement('div');
      labelEl.className = 'macro-timeline-label';
      const metaEl = document.createElement('div');
      metaEl.className = 'macro-timeline-meta';
      const tagEl = document.createElement('span');
      tagEl.className = 'macro-tag';
      content.append(labelEl, metaEl, tagEl);
      row.append(dateEl, content);
      row.__macroRefs = { dateEl, labelEl, metaEl, tagEl };
      updateTimelineRow(row, item);
      return row;
    }

    function updateTimelineRow(row, item){
      const refs = row.__macroRefs || {};
      const dt = safeDate(item?.date);
      const dateText = dt ? dt.toLocaleDateString('pt-BR', { day:'2-digit', month:'short' }) : '';
      if(refs.dateEl && refs.dateEl.textContent !== dateText){
        refs.dateEl.textContent = dateText;
      }
      const labelText = item?.title || 'Evento';
      if(refs.labelEl && refs.labelEl.textContent !== labelText){
        refs.labelEl.textContent = labelText;
      }
      const typeLabel = item?.type === 'planejamento' ? 'Planejamento' : item?.type === 'posts' ? 'Post' : 'Evento';
      const metaText = `${typeLabel}${item?.meta ? ` ‚Ä¢ ${item.meta}` : ''}`;
      if(refs.metaEl && refs.metaEl.textContent !== metaText){
        refs.metaEl.textContent = metaText;
      }
      const tagText = (item?.status ? item.status : typeLabel).toUpperCase();
      if(refs.tagEl && refs.tagEl.textContent !== tagText){
        refs.tagEl.textContent = tagText;
      }
    }

    function updateMacroTimeline(items){
      if(!macroDomRefs || !macroDomRefs.timeline) return;
      const { list, empty } = macroDomRefs.timeline;
      if(!list || !empty) return;
      const nextItems = Array.isArray(items) ? items : [];
      const existing = new Map(Array.from(list.children).map(el=>[el.dataset.macroKey, el]));
      const fragment = document.createDocumentFragment();
      nextItems.forEach((item, index)=>{
        const key = buildTimelineKey(item, index);
        let row = existing.get(key);
        if(row){
          existing.delete(key);
          updateTimelineRow(row, item);
        }else{
          row = createTimelineRow(item, key);
        }
        fragment.appendChild(row);
      });
      list.replaceChildren(fragment);
      empty.style.display = nextItems.length ? 'none' : '';
      list.style.display = nextItems.length ? '' : 'none';
    }

    function createChecklistRow(item, key){
      const row = document.createElement('div');
      row.className = 'macro-check-item';
      row.dataset.macroKey = key;
      const icon = document.createElement('div');
      icon.className = 'macro-check-icon';
      const text = document.createElement('div');
      text.className = 'macro-check-text';
      const strong = document.createElement('strong');
      const span = document.createElement('span');
      text.append(strong, span);
      row.append(icon, text);
      row.__macroRefs = { iconEl: icon, titleEl: strong, detailEl: span };
      updateChecklistRow(row, item);
      return row;
    }

    function updateChecklistRow(row, item){
      const refs = row.__macroRefs || {};
      const done = !!item?.done;
      if(refs.iconEl){
        const cls = 'macro-check-icon ' + (done ? 'done' : 'pending');
        if(refs.iconEl.className !== cls){
          refs.iconEl.className = cls;
        }
        const iconChar = done ? '‚úî' : '!';
        if(refs.iconEl.textContent !== iconChar){
          refs.iconEl.textContent = iconChar;
        }
      }
      if(refs.titleEl && refs.titleEl.textContent !== item?.label){
        refs.titleEl.textContent = item?.label || '';
      }
      if(refs.detailEl && refs.detailEl.textContent !== item?.detail){
        refs.detailEl.textContent = item?.detail || '';
      }
    }

    function updateMacroChecklist(items){
      if(!macroDomRefs || !macroDomRefs.checklist) return;
      const { container, titleEl } = macroDomRefs.checklist;
      if(!container || !titleEl) return;
      const nextItems = Array.isArray(items) ? items : [];
      const existing = new Map(Array.from(container.children)
        .filter(child=>child !== titleEl)
        .map(child=>[child.dataset.macroKey, child]));
      const rows = [];
      nextItems.forEach(item=>{
        const key = `${item?.label || ''}|${item?.detail || ''}`;
        let row = existing.get(key);
        if(row){
          existing.delete(key);
          updateChecklistRow(row, item);
        }else{
          row = createChecklistRow(item, key);
        }
        rows.push(row);
      });
      container.replaceChildren(titleEl, ...rows);
    }

    function createMiniCard(card, key){
      const box = document.createElement('div');
      box.className = 'macro-mini-card';
      box.dataset.macroKey = key;
      const title = document.createElement('strong');
      const value = document.createElement('div');
      value.className = 'macro-mini-value';
      value.style.fontSize = '1.4rem';
      value.style.fontWeight = '800';
      const detail = document.createElement('span');
      box.append(title, value, detail);
      box.__macroRefs = { titleEl: title, valueEl: value, detailEl: detail };
      updateMiniCard(box, card);
      return box;
    }

    function updateMiniCard(node, card){
      const refs = node.__macroRefs || {};
      if(refs.titleEl && refs.titleEl.textContent !== card?.title){
        refs.titleEl.textContent = card?.title || '';
      }
      if(refs.valueEl && refs.valueEl.textContent !== card?.value){
        refs.valueEl.textContent = card?.value || '';
      }
      if(refs.detailEl && refs.detailEl.textContent !== card?.detail){
        refs.detailEl.textContent = card?.detail || '';
      }
    }

    function updateMacroMiniCards(cards){
      if(!macroDomRefs || !macroDomRefs.mini) return;
      const { container } = macroDomRefs.mini;
      if(!container) return;
      const nextCards = Array.isArray(cards) ? cards : [];
      const existing = new Map(Array.from(container.children).map(child=>[child.dataset.macroKey, child]));
      const nodes = [];
      nextCards.forEach(card=>{
        const key = card?.title || '';
        let node = existing.get(key);
        if(node){
          existing.delete(key);
          updateMiniCard(node, card);
        }else{
          node = createMiniCard(card, key);
        }
        nodes.push(node);
      });
      container.replaceChildren(...nodes);
    }

    function updateMacroAlerts(alerts){
      if(!macroDomRefs || !macroDomRefs.alerts) return;
      const { container } = macroDomRefs.alerts;
      if(!container) return;
      const fragment = document.createDocumentFragment();
      (Array.isArray(alerts) ? alerts : []).forEach(alert=>{
        const item = document.createElement('div');
        item.className = 'macro-alert' + (alert?.type === 'ok' ? ' ok' : '');
        item.textContent = alert?.text || '';
        fragment.appendChild(item);
      });
      container.replaceChildren(fragment);
    }

    function updateMacroFill(fillIndicators){
      if(!macroDomRefs || !macroDomRefs.fill) return;
      const { container } = macroDomRefs.fill;
      if(!container) return;
      const fragment = document.createDocumentFragment();
      (Array.isArray(fillIndicators) ? fillIndicators : []).forEach(indicator=>{
        const block = document.createElement('div');
        block.className = 'macro-indicator';
        const head = document.createElement('div');
        head.className = 'macro-indicator-head';
        head.innerHTML = `<span>${indicator.label}</span><span>${indicator.percent}%</span>`;
        const bar = document.createElement('div');
        bar.className = 'macro-indicator-bar';
        const fillBar = document.createElement('div');
        fillBar.className = 'macro-indicator-fill';
        fillBar.style.width = `${indicator.percent}%`;
        bar.appendChild(fillBar);
        const desc = document.createElement('div');
        desc.className = 'macro-indicator-desc';
        desc.textContent = indicator.description;
        block.append(head, bar, desc);
        fragment.appendChild(block);
      });
      container.replaceChildren(fragment);
    }

    function deriveSocialLabel(title = ''){
      if(!title) return '';
      const cleaned = String(title).trim();
      const patterns = [
        /Abrir\s+(.+)/i,
        /Adicionar link para\s+(.+)/i
      ];
      for(const pattern of patterns){
        const match = cleaned.match(pattern);
        if(match && match[1]){
          return match[1].trim();
        }
      }
      return cleaned;
    }

    function collectHeaderSocialItems(){
      const wrap = document.getElementById('socialIcons');
      if(!wrap) return [];
      const nodes = [...wrap.querySelectorAll('.social-icon')];
      return nodes.map(node=>{
        const label = node.dataset.label || deriveSocialLabel(node.title) || node.dataset.socialKey || '';
        const hasLink = node.classList.contains('has-link');
        const href = node.dataset.href || node.getAttribute('data-href') || '';
        const iconImg = node.querySelector('img');
        let iconInfo;
        if(iconImg){
          iconInfo = { type: 'img', src: iconImg.src, alt: iconImg.alt || label };
        }else{
          const text = node.textContent ? node.textContent.trim() : '';
          iconInfo = { type: 'text', text, fontSize: node.style.fontSize };
        }
        return { label, hasLink, href, iconInfo };
      });
    }

    function updateMacroSocialFromHeader(){
      if(!macroDomRefs?.supplemental?.social) return;
      const { gridEl, summaryEl } = macroDomRefs.supplemental.social;
      if(!gridEl || !summaryEl) return;
      const items = collectHeaderSocialItems();
      if(!items.length){
        gridEl.replaceChildren();
        const empty = document.createElement('div');
        empty.className = 'macro-social-item';
        empty.innerHTML = '<div class="macro-social-info"><span class="macro-social-label">Nenhuma rede social mapeada.</span><span class="macro-social-detail">Adicione links nos √≠cones do topo para come√ßar.</span></div>';
        gridEl.appendChild(empty);
        summaryEl.textContent = 'Nenhuma rede social configurada.';
        return;
      }

      const frag = document.createDocumentFragment();
      let connected = 0;
      items.forEach(item=>{
        if(item.hasLink) connected += 1;
        const card = document.createElement('div');
        card.className = 'macro-social-item';
        card.dataset.status = item.hasLink ? 'ok' : 'missing';

        const icon = document.createElement('div');
        icon.className = 'macro-social-icon';
        if(item.iconInfo?.type === 'img' && item.iconInfo.src){
          const img = document.createElement('img');
          img.src = item.iconInfo.src;
          img.alt = item.iconInfo.alt || item.label || '';
          icon.appendChild(img);
        }else if(item.iconInfo?.type === 'text' && item.iconInfo.text){
          icon.textContent = item.iconInfo.text;
          if(item.iconInfo.fontSize){
            icon.style.fontSize = item.iconInfo.fontSize;
          }
        }

        const info = document.createElement('div');
        info.className = 'macro-social-info';
        const labelEl = document.createElement('span');
        labelEl.className = 'macro-social-label';
        labelEl.textContent = item.label || 'Rede social';
        const statusEl = document.createElement('span');
        const statusKey = item.hasLink ? 'ok' : 'missing';
        statusEl.className = `macro-social-status ${statusKey}`;
        statusEl.textContent = statusKey === 'ok' ? 'OK' : 'Indispon√≠vel';
        const detailEl = document.createElement('span');
        detailEl.className = 'macro-social-detail';
        detailEl.textContent = statusKey === 'ok' ? 'Link conectado' : 'Falta adicionar';
        info.append(labelEl, statusEl, detailEl);

        const actions = document.createElement('div');
        actions.className = 'macro-social-actions';
        const openBtn = document.createElement('button');
        openBtn.type = 'button';
        openBtn.className = 'macro-social-open';
        openBtn.textContent = 'Abrir';
        if(item.hasLink && item.href){
          openBtn.addEventListener('click', ()=>{
            const win = window.open(item.href, '_blank');
            if(win){
              win.opener = null;
            }else{
              window.location.href = item.href;
            }
          });
        }else{
          openBtn.disabled = true;
          openBtn.title = 'Falta adicionar link';
        }
        actions.appendChild(openBtn);

        card.append(icon, info, actions);
        frag.appendChild(card);
      });

      gridEl.replaceChildren(frag);
      const total = items.length;
      summaryEl.textContent = `${connected} de ${total} redes conectadas.`;
    }

    function updateMacroSupplemental(supplemental){
      if(!macroDomRefs || !macroDomRefs.supplemental) return;
      const { metrics, lists, social } = macroDomRefs.supplemental;

      const cacData = supplemental?.cac || {};
      if(metrics?.cac){
        if(metrics.cac.titleEl){
          metrics.cac.titleEl.textContent = cacData.title || 'CAC do m√™s';
        }
        if(metrics.cac.valueEl){
          metrics.cac.valueEl.textContent = cacData.value || '‚Äî';
        }
        if(metrics.cac.detailEl){
          metrics.cac.detailEl.textContent = cacData.detail || ' ';
        }
      }

      const referencesData = supplemental?.references || {};
      if(metrics?.references){
        if(metrics.references.titleEl){
          metrics.references.titleEl.textContent = referencesData.title || 'Refer√™ncias cadastradas';
        }
        if(metrics.references.valueEl){
          metrics.references.valueEl.textContent = referencesData.value || '0';
        }
        if(metrics.references.detailEl){
          metrics.references.detailEl.textContent = referencesData.detail || ' ';
        }
      }

      const renderList = (ref, payload)=>{
        if(!ref) return;
        const { listEl, emptyEl } = ref;
        if(!listEl || !emptyEl) return;
        const items = Array.isArray(payload?.items) ? payload.items : [];
        if(items.length){
          const frag = document.createDocumentFragment();
          items.forEach(item=>{
            const row = document.createElement('div');
            row.className = 'macro-list-item';
            const titleEl = document.createElement('strong');
            titleEl.textContent = item.title || '‚Äî';
            row.appendChild(titleEl);
            if(item.subtitle){
              const subtitleEl = document.createElement('span');
              subtitleEl.textContent = item.subtitle;
              row.appendChild(subtitleEl);
            }
            frag.appendChild(row);
          });
          listEl.replaceChildren(frag);
          listEl.style.display = '';
          emptyEl.textContent = '';
          emptyEl.style.display = 'none';
        }else{
          listEl.replaceChildren();
          listEl.style.display = 'none';
          emptyEl.textContent = payload?.emptyMessage || 'Nenhum registro encontrado.';
          emptyEl.style.display = 'block';
        }
      };

      renderList(lists?.notes, supplemental?.notes);
      renderList(lists?.files, supplemental?.files);
      renderList(lists?.competitors, supplemental?.competitors);

      if(social){
        updateMacroSocialFromHeader();
      }
    }

    function macroInsightsChanged(prev, next){
      if(prev === next) return false;
      if(!prev || !next) return true;
      try{
        return JSON.stringify(prev) !== JSON.stringify(next);
      }catch(err){
        console.warn('macro insights diff', err);
        return true;
      }
    }

    function applyMacroInsights(insights, { render = true } = {}){
      if(!insights) return;
      const previousInsights = lastMacroInsights;
      const changed = macroInsightsChanged(previousInsights, insights);
      lastMacroInsights = insights;
      if(totalScore){
        totalScore.textContent = String(insights.score);
      }
      if(totalCard){
        const rawLevel = (insights.levelKey || '').toLowerCase();
        const normalizedLevel = rawLevel ? rawLevel.normalize('NFD').replace(/[\u0300-\u036f]/g,'') : '';
        totalCard.dataset.level = normalizedLevel;
        totalCard.setAttribute('data-tip', insights.scoreTip || '');
        let levelEl = document.getElementById('totalLevel');
        if(!levelEl){
          levelEl = document.createElement('span');
          levelEl.id = 'totalLevel';
          levelEl.className = 'total-level';
          totalCard.appendChild(levelEl);
        }
        levelEl.textContent = insights.level;
      }
      if(macroBadges){
        const nodes = [];
        MACRO_COMPONENTS.forEach(comp=>{
          const data = insights.components[comp.key];
          if(!data) return;
          const badge = document.createElement('div');
          badge.className = 'macro-insight-badge';
          const dot = document.createElement('span');
          dot.className = 'dot';
          dot.style.background = data.status === 'excelente' ? '#22c55e' : data.status === 'bom' ? '#38bdf8' : data.status === 'aten√ß√£o' ? '#f97316' : '#ef4444';
          const span = document.createElement('span');
          span.textContent = `${comp.title}: ${Math.round(clamp(data.progress || 0, 0, 1)*100)}%`;
          badge.append(dot, span);
          nodes.push(badge);
        });
        macroBadges.replaceChildren(...nodes);
      }
      if(render){
        const dom = ensureMacroDom();
        if(dom){
          updateMacroSummary(insights);
          updateMacroProgress(insights);
          updateMacroTimeline(insights.timeline);
          updateMacroChecklist(insights.checklist);
          updateMacroAlerts(insights.alerts);
          updateMacroMiniCards(insights.miniCards);
          updateMacroFill(insights.fillIndicators);
          updateMacroSupplemental(insights.supplemental);
        }
        clearMacroTabBadge();
        macroPendingRender = false;
      }else if(!render && changed){
        markMacroTabUpdated();
        macroPendingRender = true;
      }
      recordMacroHistory(insights);
      renderHistoryChart();
      renderHistoryLegend();
    }

    function renderDashboard(){
      refreshMacroInsights({ immediate: true });
    }

    function refreshMacroInsights(options = {}){
      const immediate = !!(options && options.immediate);
      if(immediate){
        if(macroRefreshTimer){
          clearTimeout(macroRefreshTimer);
          macroRefreshTimer = null;
        }
        applyMacroInsights(computeMacroInsights(), { render: currentSection === 'macro' });
        try{ scheduleNotificationRefresh({ immediate: true }); }
        catch(_err){ }
        return;
      }
      if(macroRefreshTimer){
        clearTimeout(macroRefreshTimer);
      }
      macroRefreshTimer = setTimeout(()=>{
        macroRefreshTimer = null;
        try{
          applyMacroInsights(computeMacroInsights(), { render: currentSection === 'macro' });
        }catch(err){
          console.warn('refreshMacroInsights', err);
        }
        try{ scheduleNotificationRefresh(); }
        catch(_err){ }
      }, MACRO_REFRESH_DEBOUNCE);
    }

    function recordMacroHistory(insights){
      if(!insights) return;
      const records = loadMacroHistory();
      const now = Date.now();
      const snapshot = {
        ts: now,
        score: insights.score,
        components: {}
      };
      MACRO_COMPONENTS.forEach(comp=>{
        snapshot.components[comp.key] = { progress: clamp(insights.components?.[comp.key]?.progress ?? 0, 0, 1) };
      });
      const last = records[records.length-1];
      if(last){
        const diff = Math.abs(now - (last.ts || 0));
        const changed = Math.abs((last.score || 0) - snapshot.score) >= 1
          || MACRO_COMPONENTS.some(comp => Math.abs(((last.components?.[comp.key]?.progress) ?? 0) - snapshot.components[comp.key].progress) >= 0.05);
        if(diff < 1000 * 60 * 60){
          if(changed){
            records[records.length-1] = snapshot;
            saveMacroHistory(records);
          }
          return;
        }
        if(!changed) return;
      }
      records.push(snapshot);
      while(records.length > 120) records.shift();
      saveMacroHistory(records);
    }

    function debounce(fn, d){ let t=null; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),d);} }

    const monthKey = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    function getDefaultMonths(){
      const now=new Date(); const arr=[];
      for(let i=0;i<3;i++){ arr.push(monthKey(new Date(now.getFullYear(), now.getMonth()-i, 1))); }
      return arr;
    }

    function updateHistoryMonthSelect(){
      const { monthSelect } = getMacroHistoryElements();
      if(!monthSelect) return;
      const records = loadMacroHistory();
      const monthsSet = new Set(getDefaultMonths());
      records.forEach(rec=>{
        const dt = safeDate(rec.ts);
        if(!dt) return;
        monthsSet.add(monthKey(dt));
      });
      const months = Array.from(monthsSet).sort();
      monthSelect.innerHTML = '';
      const defaults = getDefaultMonths();
      if(selectedMonths.length === 0){
        selectedMonths = months.filter(m=>defaults.includes(m));
        if(!selectedMonths.length) selectedMonths = months.slice(-3);
      }
      months.forEach(m=>{
        const opt=document.createElement('option');
        opt.value=m;
        opt.textContent=new Date(m+'-01').toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
        if(selectedMonths.includes(m)) opt.selected=true;
        monthSelect.appendChild(opt);
      });
    }

    function bindHistoryMonthSelect(){
      const { monthSelect } = getMacroHistoryElements();
      if(!monthSelect || historyEventsBound) return;
      monthSelect.addEventListener('change', ()=>{
        selectedMonths = Array.from(monthSelect.selectedOptions).map(o=>o.value);
        renderHistoryChart();
      });
      historyEventsBound = true;
    }

    function renderHistoryChart(){
      const { canvas, controls } = getMacroHistoryElements();
      if(currentSection !== 'macro'){
        if(controls) controls.style.display = 'none';
        if(canvas) canvas.style.display = 'none';
        if(historyChart){ historyChart.destroy(); historyChart = null; }
        return;
      }
      if(!canvas || typeof Chart==='undefined') return;
      bindHistoryMonthSelect();
      updateHistoryMonthSelect();
      const records = loadMacroHistory();
      if(!records.length){
        if(historyChart){ historyChart.destroy(); historyChart = null; }
        if(controls) controls.style.display = 'none';
        canvas.style.display = 'none';
        return;
      }
      canvas.style.display = 'block';
      if(controls) controls.style.display = 'block';
      const filterSet = new Set(selectedMonths.length?selectedMonths:getDefaultMonths());
      const datasets = MACRO_COMPONENTS.map((comp,i)=>{
        const data = records
          .filter(rec=>{
            const dt = safeDate(rec.ts);
            return dt && filterSet.has(monthKey(dt));
          })
          .map(rec=>{
            const dt = safeDate(rec.ts);
            return { x: dt, y: Math.round(clamp(rec.components?.[comp.key]?.progress ?? 0, 0, 1) * 10) };
          });
        return {
          label: comp.title,
          data,
          borderColor: HISTORY_COLORS[i % HISTORY_COLORS.length],
          fill: false,
          tension: 0.25
        };
      });
      const cfg = {
        type: 'line',
        data: { datasets },
        options: {
          responsive: true,
          parsing: false,
          scales: {
            x: { type: 'time', time: { unit: 'month' } },
            y: { min: 0, max: 10 }
          },
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const pct = Math.round((ctx.raw?.y || 0) * 10);
                  return `${ctx.dataset.label}: ${pct}%`;
                }
              }
            }
          }
        }
      };
      if(historyChart){ historyChart.destroy(); }
      historyChart = new Chart(canvas, cfg);
    }

    function renderHistoryLegend(){
      const { legend } = getMacroHistoryElements();
      if(!legend) return;
      if(currentSection !== 'macro'){
        legend.style.display = 'none';
        return;
      }
      legend.style.display = 'flex';
      legend.innerHTML='';
      MACRO_COMPONENTS.forEach((c,i)=>{
        const item=document.createElement('div');
        item.className='legend-item';
        item.innerHTML=`<span class="legend-line" style="background:${HISTORY_COLORS[i % HISTORY_COLORS.length]}"></span><span>${c.title}</span>`;
        legend.appendChild(item);
      });
    }

    /* ========= se√ß√µes ========= */
    const SECTIONS = [
      { id:"macro",    name:"Macro" },
      { id:"briefing",  name:"Briefing" },
      { id:"demandas",  name:"Planejamento" },
      { id:"ia",        name:"I.A" },
      { id:"calendar",  name:"Calend√°rio" },
      { id:"trafego",   name:"Tr√°fego Pago" },
      { id:"metas",     name:"Metas" },
      { id:"cac",       name:"CAC" },
      { id:"reportei",  name:"Reportei" },
      { id:"refSocial", name:"Refer√™ncias" },
      { id:"notes",     name:"Anota√ß√µes" },
      { id:"access",    name:"Acessos" },
      { id:"arquivos",  name:"Arquivos" },
      { id:"concorrentes", name:"Concorrentes" },
      { id:"relatorio", name:"Relat√≥rio" }
    ];
    let currentSection = localStorage.getItem("mg_currentSection") || "macro";
    if(currentSection==="other") currentSection="demandas";
    let USER_DATA = {};
    let CLIENT_PROFILE = {};
    if(window.googleCalendarIntegration){
      window.googleCalendarIntegration.updateConfigFromProfile(CLIENT_PROFILE);
    }
    let clientDocPathParts = null;
    let clientDocUnsub = null;
    let profileLogoUploading = false;
    let widgetsRenderedSection = null;
    let trafegoInitialized = false;
    const sectionScroll = {};

    function clearMacroTabBadge(){
      macroTabHasUpdate = false;
      if(macroTabBadgeEl){
        macroTabBadgeEl.hidden = true;
      }
    }

    function markMacroTabUpdated(){
      if(currentSection === 'macro') return;
      macroTabHasUpdate = true;
      if(macroTabBadgeEl){
        macroTabBadgeEl.hidden = false;
      }
    }

    function syncMacroTabBadge(){
      if(!macroTabBadgeEl) return;
      macroTabBadgeEl.hidden = !macroTabHasUpdate;
    }

    function setActiveTab(sectionId, { restoreScroll = true } = {}){
      if(!sectionId) return;
      const target = String(sectionId);
      const prevSection = currentSection;
      if(prevSection !== target){
        sectionScroll[prevSection] = window.scrollY || document.documentElement.scrollTop || 0;
        currentSection = target;
        localStorage.setItem("mg_currentSection", currentSection);
      }
      if(currentSection === 'macro'){
        clearMacroTabBadge();
        if(macroPendingRender){
          try{ refreshMacroInsights({ immediate: true }); }catch(_err){}
        }
      }
      if(sectionTabs){
        const buttons = [...sectionTabs.children];
        buttons.forEach(el=>{ el.classList.remove("active"); el.setAttribute("aria-selected","false"); });
        const btn = sectionTabs.querySelector(`.tab-btn[data-section="${target}"]`);
        if(btn){
          btn.classList.add("active");
          btn.setAttribute("aria-selected","true");
        }
      }
      rerenderBySection();
      if(restoreScroll){
        const y = sectionScroll[currentSection] || 0;
        requestAnimationFrame(()=> window.scrollTo(0, y));
      }
    }
    window.setActiveTab = setActiveTab;

    const MACRO_AUTO_OPEN_EVENT = "macro:auto-open";
    function triggerMacroAutoOpen(options = {}){
      const force = !!(options && options.force);
      if(force){
        macroAutoOpenPending = false;
        setActiveTab("macro", { restoreScroll: false });
        return;
      }
      if(!macroAutoOpenPending) return;
      macroAutoOpenPending = false;
      if(currentSection !== 'macro'){
        setActiveTab("macro", { restoreScroll: false });
      }else{
        clearMacroTabBadge();
      }
    }
    window.triggerMacroAutoOpen = triggerMacroAutoOpen;
    window.addEventListener(MACRO_AUTO_OPEN_EVENT, (event)=>{
      try{
        const detail = event && typeof event.detail === 'object' ? event.detail : {};
        triggerMacroAutoOpen(detail);
      }catch(err){
        console.warn("macro:auto-open handler", err);
      }
    });

    const SOCIAL_ICONS = {
      googleAds: { src: "https://www.google.com/s2/favicons?sz=64&domain=ads.google.com" },
      metaAds: { src: "https://www.google.com/s2/favicons?sz=64&domain=business.facebook.com" },
      instagram: { src: "https://www.google.com/s2/favicons?sz=64&domain=instagram.com", title: "Instagram" },
      website: { src: "https://www.google.com/s2/favicons?sz=64&domain=example.com", title: "Site" },
      tiktok: { src: "https://www.google.com/s2/favicons?sz=64&domain=tiktok.com", title: "TikTok" },
      facebook: { src: "https://www.google.com/s2/favicons?sz=64&domain=facebook.com", title: "Facebook" },
      youtube: { src: "https://www.google.com/s2/favicons?sz=64&domain=youtube.com", title: "YouTube" },
      linkedin: { src: "https://www.google.com/s2/favicons?sz=64&domain=linkedin.com", title: "LinkedIn" },
      whatsapp: { src: "https://www.google.com/s2/favicons?sz=64&domain=whatsapp.com", title: "WhatsApp" },
      googleBusiness: { src: "https://www.google.com/s2/favicons?sz=64&domain=business.google.com" },
      pinterest: { src: "https://www.google.com/s2/favicons?sz=64&domain=pinterest.com" },
      chart: { emoji: "üìà", title: "CRM" }
    };
    let SOCIAL_LINKS = {};

    function loadSocialLinksFromUserData(){
      SOCIAL_LINKS = USER_DATA.socialLinks && typeof USER_DATA.socialLinks === 'object' ? { ...USER_DATA.socialLinks } : {};
    }

    async function persistSocialLinks(){
      const uid = auth.currentUser?.uid;
      if(!uid) return;
      USER_DATA.socialLinks = SOCIAL_LINKS;
      await setDoc(doc(db, "usuarios", uid), { socialLinks: SOCIAL_LINKS }, { merge: true });
    }

    function renderSocialIcons(){
      const wrap = $("socialIcons");
      if(!wrap) return;
      wrap.innerHTML = "";
      Object.entries(SOCIAL_ICONS).forEach(([key, info]) => {
        const span = document.createElement("span");
        span.className = "social-icon" + (SOCIAL_LINKS[key] ? " has-link" : "");
        const label = info.title || key;
        span.dataset.socialKey = key;
        span.dataset.label = label;
        if(SOCIAL_LINKS[key]){
          span.dataset.href = SOCIAL_LINKS[key];
        }
        span.title = SOCIAL_LINKS[key] ? `Abrir ${label}` : `Adicionar link para ${label}`;
        if(info.src){
          const img = document.createElement("img");
          img.src = info.src;
          img.alt = label;
          span.appendChild(img);
        } else if(info.emoji){
          span.textContent = info.emoji;
          span.style.fontSize = "18px";
        }
        span.addEventListener("click", () => {
          const current = SOCIAL_LINKS[key];
          if(current){
            const newWindow = window.open(current, "_blank");
            if(newWindow){
              newWindow.opener = null;
            } else {
              window.location.href = current;
            }
          } else {
            const link = prompt(`Informe o link para ${label}:`, "https://");
            if(link){
              SOCIAL_LINKS[key] = link;
              persistSocialLinks();
              renderSocialIcons();
            }
          }
        });
        wrap.appendChild(span);
      });
      updateMacroSocialFromHeader();
      try{ refreshMacroInsights(); }catch(_err){}
    }

    const MAX_PROFILE_LOGO_SIZE = 5 * 1024 * 1024;

    function formatClientDisplayName(value){
      if(!value) return "";
      return value.replace(/[_-]+/g, " ").trim().toUpperCase();
    }

    function attachClientDocListener(parts){
      if(clientDocUnsub){
        try{ clientDocUnsub(); }catch(_e){}
        clientDocUnsub = null;
      }
      if(!Array.isArray(parts)) return;
      try{
        const ref = doc(db, ...parts);
        clientDocUnsub = onSnapshot(ref, (snap)=>{
          CLIENT_PROFILE = snap.exists() ? (snap.data() || {}) : {};
          if(window.googleCalendarIntegration){
            window.googleCalendarIntegration.updateConfigFromProfile(CLIENT_PROFILE);
          }
          clientDocPathParts = parts;
          syncStorageLimitFromProfile();
          updateProfileAvatar();
          triggerMacroAutoOpen();
        }, (err)=>{
          console.warn('clientDoc listener', err);
        });
      }catch(err){
        console.warn('attachClientDocListener', err);
      }
    }

    function updateProfileAvatar(){
      if(!profileArea) return;
      const hasUser = !!auth?.currentUser;
      if(!hasUser){
        profileArea.classList.remove('active');
        profileArea.setAttribute('aria-hidden','true');
        if(profileAvatar){
          profileAvatar.classList.remove('has-image','uploading');
          profileAvatar.disabled = true;
          profileAvatar.setAttribute('aria-label','Adicionar logo do cliente');
          profileAvatar.setAttribute('title','Adicionar logo do cliente');
        }
        if(profileAvatarImg){
          profileAvatarImg.removeAttribute('src');
        }
        if(profileClientName){
          profileClientName.textContent = '';
        }
        if(profileAvatarPlaceholder){
          profileAvatarPlaceholder.textContent = '+';
        }
        return;
      }
      profileArea.classList.add('active');
      profileArea.setAttribute('aria-hidden','false');
      const clientKey = getClientKey() || '';
      if(profileClientName){
        profileClientName.textContent = clientKey ? formatClientDisplayName(clientKey) : '';
      }
      const logoUrl = CLIENT_PROFILE?.profileLogoUrl || '';
      if(profileAvatar){
        profileAvatar.classList.toggle('has-image', !!logoUrl);
        profileAvatar.classList.toggle('uploading', profileLogoUploading);
        profileAvatar.disabled = !!profileLogoUploading;
        const label = logoUrl ? 'Atualizar logo do cliente' : 'Adicionar logo do cliente';
        profileAvatar.setAttribute('aria-label', label);
        profileAvatar.setAttribute('title', label);
      }
      if(profileAvatarImg){
        if(logoUrl){
          if(profileAvatarImg.src !== logoUrl){
            profileAvatarImg.src = logoUrl;
          }
        }else{
          profileAvatarImg.removeAttribute('src');
        }
      }
      if(profileAvatarPlaceholder){
        profileAvatarPlaceholder.textContent = clientKey ? clientKey.charAt(0).toUpperCase() : '+';
      }
    }

    async function loadClientProfile(){
      if(!auth?.currentUser){
        CLIENT_PROFILE = {};
        if(window.googleCalendarIntegration){
          window.googleCalendarIntegration.updateConfigFromProfile(CLIENT_PROFILE);
        }
        clientDocPathParts = null;
        if(clientDocUnsub){
          try{ clientDocUnsub(); }catch(_e){}
          clientDocUnsub = null;
        }
        syncStorageLimitFromProfile();
        updateProfileAvatar();
        refreshMetasFormSubscription();
        return;
      }
      const uid = auth.currentUser.uid;
      const clientKey = getClientKey();
      if(!clientKey){
        CLIENT_PROFILE = {};
        if(window.googleCalendarIntegration){
          window.googleCalendarIntegration.updateConfigFromProfile(CLIENT_PROFILE);
        }
        clientDocPathParts = null;
        if(clientDocUnsub){
          try{ clientDocUnsub(); }catch(_e){}
          clientDocUnsub = null;
        }
        syncStorageLimitFromProfile();
        updateProfileAvatar();
        refreshMetasFormSubscription();
        return;
      }
      const safeKey = clientKey.replace(/[^\w-]/g,'_');
      let targetKey = safeKey || clientKey;
      try{
        let snap = await getDoc(doc(db, 'usuarios', uid, 'clients', safeKey));
        if(!snap.exists() && safeKey !== clientKey){
          snap = await getDoc(doc(db, 'usuarios', uid, 'clients', clientKey));
          if(snap.exists()){
            targetKey = clientKey;
          }
        }
        CLIENT_PROFILE = snap?.exists() ? (snap.data() || {}) : {};
        if(window.googleCalendarIntegration){
          window.googleCalendarIntegration.updateConfigFromProfile(CLIENT_PROFILE);
        }
        syncStorageLimitFromProfile();
      }catch(err){
        console.warn('loadClientProfile', err);
        CLIENT_PROFILE = CLIENT_PROFILE || {};
        if(window.googleCalendarIntegration){
          window.googleCalendarIntegration.updateConfigFromProfile(CLIENT_PROFILE);
        }
        syncStorageLimitFromProfile();
      }
      const pathParts = ['usuarios', uid, 'clients', targetKey];
      clientDocPathParts = pathParts;
      attachClientDocListener(pathParts);
      updateProfileAvatar();
      refreshMetasFormSubscription();
    }

    function ensureProfileStorage(){
      if(STORAGE) return STORAGE;
      try{
        STORAGE = getStorage(app);
      }catch(err){
        console.warn('ensureProfileStorage', err);
      }
      return STORAGE;
    }

    async function uploadClientLogo(file){
      if(!file) return;
      if(!auth?.currentUser){
        alert('Fa√ßa login para enviar a logo.');
        return;
      }
      const uid = auth.currentUser.uid;
      const clientKey = getClientKey();
      if(!clientKey){
        alert('Cliente n√£o identificado.');
        return;
      }
      if(file.size > MAX_PROFILE_LOGO_SIZE){
        alert('Selecione uma imagem de at√© 5MB.');
        return;
      }
      const storage = ensureProfileStorage();
      if(!storage){
        alert('Armazenamento indispon√≠vel no momento.');
        return;
      }
      const safeKey = clientKey.replace(/[^\w-]/g,'_');
      const previousPath = CLIENT_PROFILE?.profileLogoStoragePath || null;
      profileLogoUploading = true;
      updateProfileAvatar();
      try{
        const rawExt = (file.name || '').split('.').pop() || '';
        const ext = rawExt.toLowerCase().replace(/[^a-z0-9]/g,'');
        const finalExt = ext ? ext.slice(0,8) : 'png';
        const storagePath = `usuarios/${uid}/clients/${safeKey}/profile/logo-${Date.now()}.${finalExt}`;
        const storageRef = sRef(storage, storagePath);
        await uploadBytes(storageRef, file, { contentType: file.type || undefined });
        const url = await getDownloadURL(storageRef);
        const docParts = clientDocPathParts || ['usuarios', uid, 'clients', safeKey];
        await setDoc(doc(db, ...docParts), {
          profileLogoUrl: url,
          profileLogoStoragePath: storagePath,
          profileLogoUpdatedAt: serverTimestamp()
        }, { merge: true });
        CLIENT_PROFILE = {
          ...(CLIENT_PROFILE || {}),
          profileLogoUrl: url,
          profileLogoStoragePath: storagePath
        };
        updateProfileAvatar();
        if(previousPath && previousPath !== storagePath){
          try{ await deleteObject(sRef(storage, previousPath)); }
          catch(err){ console.warn('delete previous logo', err); }
        }
        if(typeof mgToast === 'function'){ mgToast('Logo atualizada!'); }
      }catch(err){
        console.error('uploadClientLogo', err);
        alert('N√£o foi poss√≠vel enviar a logo. Tente novamente.');
      }finally{
        profileLogoUploading = false;
        if(profileAvatarInput){ profileAvatarInput.value = ''; }
        updateProfileAvatar();
      }
    }

    updateProfileAvatar();

    profileAvatar?.addEventListener('click', ()=>{
      if(profileLogoUploading) return;
      if(!auth?.currentUser){
        alert('Fa√ßa login para adicionar a logo.');
        return;
      }
      profileAvatarInput?.click();
    });

    profileAvatarInput?.addEventListener('change', (event)=>{
      const file = event.target?.files?.[0] || null;
      if(event.target){ event.target.value = ''; }
      if(!file) return;
      uploadClientLogo(file);
    });

    function setSectionVisibility({widgets=false, demandas=false, notes=false, briefing=false, access=false, calendar=false, metas=false, trafego=false, files=false, ia=false, concorrentes=false, refSocial=false, cac=false, relatorio=false}){
      widgetsGrid.style.display = widgets? "flex":"none";
      iframeDica.style.display  = widgets? "block":"none";
      metasWrap.style.display = metas? "block":"none"; metasWrap.setAttribute("aria-hidden", metas? "false":"true");
      demandasWrap.style.display = demandas? "block":"none"; demandasWrap.setAttribute("aria-hidden", demandas? "false":"true");
      notesWrap.style.display   = notes? "flex":"none";  notesWrap.setAttribute("aria-hidden", notes? "false":"true");
      calendarWrap.style.display = calendar? "flex":"none"; calendarWrap.setAttribute("aria-hidden", calendar? "false":"true");
      briefWrap.style.display   = briefing? "flex":"none"; briefWrap.setAttribute("aria-hidden", briefing? "false":"true");
      accessWrap.style.display  = access? "flex":"none";  accessWrap.setAttribute("aria-hidden", access? "false":"true");
      filesWrap.style.display   = files? "flex":"none";  filesWrap.setAttribute("aria-hidden", files? "false":"true");
      iaWrap.style.display      = ia? "block":"none"; iaWrap.setAttribute("aria-hidden", ia? "false":"true");
      competitorsWrap.style.display = concorrentes? "block":"none"; competitorsWrap.setAttribute("aria-hidden", concorrentes? "false":"true");
      refSocialWrap.style.display = refSocial? "block":"none"; refSocialWrap.setAttribute("aria-hidden", refSocial? "false":"true");
      cacWrap.style.display = cac? "block":"none"; cacWrap.setAttribute("aria-hidden", cac? "false":"true");
      relatorioWrap.style.display = relatorio? "block":"none"; relatorioWrap.setAttribute("aria-hidden", relatorio? "false":"true");
      if(trafegoWrap){
        trafegoWrap.style.display = trafego? "flex":"none";
        trafegoWrap.setAttribute("aria-hidden", trafego? "false":"true");
      }
    }

    const TRAFEGO_STATUS_OPTIONS = [
      { value: 'ativa', label: 'Ativa' },
      { value: 'teste', label: 'Em teste' },
      { value: 'pausada', label: 'Pausada' },
      { value: 'escalar', label: 'Escalar' },
      { value: 'revisar-criativo', label: 'Rever criativo' }
    ];
    const TRAFEGO_CAMPAIGN_STATUS_OPTIONS = [
      { value: 'nao-testada', label: 'Ainda n√£o testada' },
      { value: 'ja-testada', label: 'J√° testada' },
      { value: 'aprovado', label: 'Aprovado pelo cliente' },
      { value: 'nao-aprovado', label: 'N√£o aprovado' }
    ];
    const TRAFEGO_PLATFORM_OPTIONS = [
      { value: 'meta', label: 'Meta' },
      { value: 'google', label: 'Google' },
      { value: 'tiktok', label: 'TikTok' },
      { value: 'linkedin', label: 'LinkedIn' },
      { value: 'pinterest', label: 'Pinterest' }
    ];
    const TRAFEGO_OPTIMIZATION_HISTORY_FIELDS = ['platform','campaign','observation','lastOptimization','lastOptimizationDate'];
    const TRAFEGO_OPTIMIZATION_HISTORY_LIMIT = 500;
    const TRAFEGO_OPTIMIZATION_SAVE_TIMEOUT_MS = 15000;
    const TRAFEGO_META_TOPIC_OPTIONS = [
      { value: 'An√∫ncio', label: 'An√∫ncio' },
      { value: 'Copy', label: 'Copy' },
      { value: 'P√∫blico', label: 'P√∫blico' },
      { value: 'Segmenta√ß√£o', label: 'Segmenta√ß√£o' },
      { value: 'Criativo', label: 'Criativo' },
      { value: 'Or√ßamento', label: 'Or√ßamento' },
      { value: 'Lances', label: 'Lances' },
      { value: 'Posicionamento', label: 'Posicionamento' },
      { value: 'Frequ√™ncia', label: 'Frequ√™ncia' },
      { value: 'Pixel', label: 'Pixel' },
      { value: 'Convers√£o', label: 'Convers√£o' },
      { value: 'CTA', label: 'CTA' },
      { value: 'V√≠deo', label: 'V√≠deo' },
      { value: 'Imagem', label: 'Imagem' },
      { value: 'T√≠tulo', label: 'T√≠tulo' },
      { value: 'Descri√ß√£o', label: 'Descri√ß√£o' },
      { value: 'Campanha', label: 'Campanha' },
      { value: 'A/B', label: 'A/B' },
      { value: 'Retargeting', label: 'Retargeting' },
      { value: 'Lookalike', label: 'Lookalike' }
    ];
    const TRAFEGO_OPTIMIZATION_TOPICS = {
      meta: TRAFEGO_META_TOPIC_OPTIONS,
      google: [
        { value: 'Palavras-chave', label: 'Palavras-chave' },
        { value: 'Negativas', label: 'Negativas' },
        { value: 'Extens√µes', label: 'Extens√µes' },
        { value: 'Lances', label: 'Lances' },
        { value: 'An√∫ncio', label: 'An√∫ncio' },
        { value: 'T√≠tulo', label: 'T√≠tulo' },
        { value: 'Descri√ß√£o', label: 'Descri√ß√£o' },
        { value: 'Segmenta√ß√£o', label: 'Segmenta√ß√£o' },
        { value: 'Localiza√ß√£o', label: 'Localiza√ß√£o' },
        { value: 'Dispositivo', label: 'Dispositivo' },
        { value: 'Rede', label: 'Rede' },
        { value: 'Convers√£o', label: 'Convers√£o' },
        { value: 'CPC', label: 'CPC' },
        { value: 'CPL', label: 'CPL' },
        { value: 'CTR', label: 'CTR' },
        { value: 'Campanha', label: 'Campanha' },
        { value: 'Display', label: 'Display' },
        { value: 'Performance Max', label: 'Performance Max' },
        { value: 'Remarketing', label: 'Remarketing' },
        { value: 'A/B', label: 'A/B' }
      ],
      tiktok: [
        { value: 'V√≠deo', label: 'V√≠deo' },
        { value: 'Copy', label: 'Copy' },
        { value: 'M√∫sica', label: 'M√∫sica' },
        { value: 'Segmenta√ß√£o', label: 'Segmenta√ß√£o' },
        { value: 'P√∫blico', label: 'P√∫blico' },
        { value: 'Lances', label: 'Lances' },
        { value: 'Or√ßamento', label: 'Or√ßamento' },
        { value: 'Hashtags', label: 'Hashtags' },
        { value: 'Convers√£o', label: 'Convers√£o' },
        { value: 'CTR', label: 'CTR' },
        { value: 'Campanha', label: 'Campanha' },
        { value: 'Formato', label: 'Formato' },
        { value: 'Criativo', label: 'Criativo' },
        { value: 'Engajamento', label: 'Engajamento' },
        { value: 'Retargeting', label: 'Retargeting' },
        { value: 'Pixel', label: 'Pixel' },
        { value: 'Call-to-Action', label: 'Call-to-Action' },
        { value: 'A/B', label: 'A/B' },
        { value: 'Audi√™ncia', label: 'Audi√™ncia' },
        { value: 'Performance', label: 'Performance' }
      ],
      linkedin: TRAFEGO_META_TOPIC_OPTIONS,
      pinterest: TRAFEGO_META_TOPIC_OPTIONS
    };
    function getTrafficOptimizationTopicOptions(platform){
      const key = typeof platform === 'string' ? platform.toLowerCase() : '';
      return TRAFEGO_OPTIMIZATION_TOPICS[key] || [];
    }

    function normalizeOptimizationTopics(rawTopics, platform){
      const baseOptions = getTrafficOptimizationTopicOptions(platform);
      const allowedValues = new Set(baseOptions.map(opt => opt.value));
      let values = [];
      if(Array.isArray(rawTopics)){
        values = rawTopics;
      }else if(typeof rawTopics === 'string'){
        const trimmed = rawTopics.trim();
        if(trimmed){
          if(trimmed.startsWith('[')){
            try{
              const parsed = JSON.parse(trimmed);
              if(Array.isArray(parsed)){
                values = parsed;
              }else{
                values = [trimmed];
              }
            }catch(_err){
              values = [trimmed];
            }
          }else{
            values = [trimmed];
          }
        }
      }
      const unique = [];
      const seen = new Set();
      values.forEach(value => {
        const str = typeof value === 'string' ? value.trim() : '';
        if(!str || seen.has(str)) return;
        seen.add(str);
        unique.push(str);
      });
      if(!allowedValues.size) return unique;
      const recognized = unique.filter(value => allowedValues.has(value));
      if(recognized.length === unique.length) return recognized;
      const extras = unique.filter(value => !allowedValues.has(value));
      return recognized.concat(extras);
    }

    function normalizeOptimizationTopicValue(rawTopic, platform){
      const topics = normalizeOptimizationTopics(rawTopic, platform);
      if(topics.length) return topics[0];
      if(Array.isArray(rawTopic)){
        for(const value of rawTopic){
          if(typeof value === 'string'){
            const trimmed = value.trim();
            if(trimmed) return trimmed;
          }
        }
      }
      return typeof rawTopic === 'string' ? rawTopic.trim() : '';
    }

    function populateOptimizationTopicOptions(select, platform, selectedTopic = ''){
      if(!select) return;
      const topics = getTrafficOptimizationTopicOptions(platform);
      const normalizedSelected = normalizeOptimizationTopicValue(selectedTopic, platform);
      select.innerHTML = '';
      let hasSelectedOption = false;
      topics.forEach(topic => {
        const option = document.createElement('option');
        option.value = topic.value;
        option.textContent = topic.label;
        if(topic.value === normalizedSelected){
          option.selected = true;
          hasSelectedOption = true;
        }
        select.appendChild(option);
      });
      if(!hasSelectedOption && normalizedSelected){
        const option = document.createElement('option');
        option.value = normalizedSelected;
        option.textContent = normalizedSelected;
        option.selected = true;
        option.hidden = true;
        select.appendChild(option);
      }
      select.multiple = false;
      select.removeAttribute('size');
    }

    const TRAFEGO_OPTIMIZATION_RECURRENCE_OPTIONS = [
      { value: '1-dia', label: '1 dia', days: 1 },
      { value: '2-dias', label: '2 dias', days: 2 },
      { value: '3-dias', label: '3 dias', days: 3 },
      { value: '4-dias', label: '4 dias', days: 4 },
      { value: '5-dias', label: '5 dias', days: 5 },
      { value: '7-dias', label: '7 dias', days: 7 },
      { value: '2-semanas', label: '2 semanas', days: 14 },
      { value: '3-semanas', label: '3 semanas', days: 21 },
      { value: '1-mes', label: '1 m√™s', days: 30 },
      { value: '2-meses', label: '2 meses', days: 60 }
    ];
    const TRAFEGO_OPTIMIZATION_LEGACY_RECURRENCE_MAP = {
      diaria: '1-dia',
      trissemanal: '2-dias',
      bissemanal: '4-dias',
      trimestral: '2-meses'
    };
    const TRAFEGO_OPTIMIZATION_DEFAULT_RECURRENCE = TRAFEGO_OPTIMIZATION_RECURRENCE_OPTIONS[0].value;
    const TRAFEGO_OPTIMIZATION_SAVE_DEBOUNCE_MS = 700;
    const TRAFEGO_HISTORY_SAVE_DEBOUNCE_MS = 700;
    const TRAFEGO_DAY_MS = 24 * 60 * 60 * 1000;
    const TRAFEGO_METRICS_SAVE_DEBOUNCE_MS = 700;
    let TRAFEGO_METRICS = [];
    let trafegoMetricsSaveTimer = null;
    let trafegoMetricsSavePending = false;
    let trafegoMetricsSaveInFlight = false;
    let trafegoMetricsSaveQueued = false;
    let pendingTrafficMetricsSnapshot = null;
    let trafficMetricsLocalSignature = '';
    let trafficMetricsSavedSignature = '';
    let trafficMetricsRemoteSignature = '';
    let TRAFEGO_OPTIMIZATIONS = [];
    let TRAFEGO_OPTIMIZATIONS_LAST_SAVED = [];
    let TRAFEGO_OPTIMIZATION_HISTORY = [];
    let trafegoOptimizationSaveTimer = null;
    let trafegoOptimizationSavePending = false;
    let trafegoOptimizationSaveInFlight = false;
    let trafegoOptimizationSaveQueued = false;
    let pendingTrafficOptimizationSnapshot = null;
    let trafficOptimizationLocalSignature = '';
    let trafficOptimizationSavedSignature = '';
    let trafficOptimizationRemoteSignature = '';
    let trafegoHistorySaveTimer = null;
    let trafegoHistorySavePending = false;
    let trafegoHistorySaveInFlight = false;
    let trafegoHistorySaveQueued = false;
    let pendingTrafficOptimizationHistorySnapshot = null;
    let trafficHistoryLocalSignature = '';
    let trafficHistorySavedSignature = '';
    let trafficHistoryRemoteSignature = '';
    let TRAFEGO_CAMPAIGN_IDEAS = [];
    const TRAFEGO_CAMPAIGNS_SAVE_DEBOUNCE_MS = 700;
    let trafegoCampaignSaveTimer = null;
    let trafegoCampaignSavePending = false;
    let trafegoCampaignSaveInFlight = false;
    let trafegoCampaignSaveQueued = false;
    let pendingTrafficCampaignSnapshot = null;
    let trafficCampaignLocalSignature = '';
    let trafficCampaignSavedSignature = '';
    let trafficCampaignRemoteSignature = '';

    function generateTrafficCampaignId(){
      if(typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function'){
        return `camp-${crypto.randomUUID()}`;
      }
      return 'camp-' + Math.random().toString(36).slice(2) + Date.now().toString(36);
    }

    function normalizeTrafficCampaignIdea(raw = {}){
      const statusValue = typeof raw?.status === 'string' ? raw.status.toLowerCase() : '';
      const validStatus = TRAFEGO_CAMPAIGN_STATUS_OPTIONS.some(opt => opt.value === statusValue) ? statusValue : 'nao-testada';
      return {
        id: typeof raw?.id === 'string' && raw.id ? raw.id : generateTrafficCampaignId(),
        name: typeof raw?.name === 'string' ? raw.name : '',
        budget: raw?.budget === undefined || raw?.budget === null ? '' : String(raw.budget),
        format: typeof raw?.format === 'string' ? raw.format : '',
        observation: typeof raw?.observation === 'string' ? raw.observation : '',
        audience: typeof raw?.audience === 'string' ? raw.audience : '',
        copy: typeof raw?.copy === 'string' ? raw.copy : '',
        objective: typeof raw?.objective === 'string' ? raw.objective : '',
        status: validStatus
      };
    }

    function normalizeTrafficCampaignList(list){
      if(!Array.isArray(list)) return [];
      return list.map(normalizeTrafficCampaignIdea);
    }

    function computeTrafficCampaignSignature(list){
      if(!Array.isArray(list) || !list.length) return '[]';
      return JSON.stringify(list.map(item => ({
        id: item?.id || '',
        name: item?.name || '',
        budget: item?.budget || '',
        format: item?.format || '',
        observation: item?.observation || '',
        audience: item?.audience || '',
        copy: item?.copy || '',
        objective: item?.objective || '',
        status: item?.status || ''
      })));
    }

    function getSanitizedTrafficCampaigns(){
      return TRAFEGO_CAMPAIGN_IDEAS.map(item => ({
        id: item.id,
        name: (item.name || '').trim(),
        budget: (item.budget || '').trim(),
        format: (item.format || '').trim(),
        observation: (item.observation || '').trim(),
        audience: (item.audience || '').trim(),
        copy: (item.copy || '').trim(),
        objective: (item.objective || '').trim(),
        status: TRAFEGO_CAMPAIGN_STATUS_OPTIONS.some(opt => opt.value === item.status) ? item.status : 'nao-testada'
      }));
    }

    function updateTrafficCampaignLocalSignature(){
      trafficCampaignLocalSignature = computeTrafficCampaignSignature(TRAFEGO_CAMPAIGN_IDEAS);
    }

    function escapeTrafficCampaignId(value){
      const str = String(value || '');
      if(typeof CSS !== 'undefined' && typeof CSS.escape === 'function'){
        return CSS.escape(str);
      }
      return str.replace(/[^a-zA-Z0-9_-]/g, '\\$&');
    }

    function campaignMatchesFilters(campaign){
      const statusFilter = trafegoCampaignStatusFilter?.value || 'all';
      if(statusFilter !== 'all' && campaign.status !== statusFilter) return false;
      const term = (trafegoCampaignSearch?.value || '').trim().toLowerCase();
      if(!term) return true;
      const haystack = [campaign.name, campaign.format, campaign.observation, campaign.audience, campaign.copy, campaign.objective]
        .map(part => (part || '').toLowerCase())
        .join(' ');
      return haystack.includes(term);
    }

    function renderTrafficCampaignIdeas(){
      if(!trafegoCampaignsBody) return;
      const filtered = TRAFEGO_CAMPAIGN_IDEAS.filter(campaignMatchesFilters);
      trafegoCampaignsBody.innerHTML = '';
      const frag = document.createDocumentFragment();
      filtered.forEach(idea => {
        const row = document.createElement('tr');
        row.dataset.id = idea.id;

        const nameCell = document.createElement('td');
        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.placeholder = 'Campanha ou conceito';
        nameInput.value = idea.name;
        nameInput.dataset.field = 'name';
        nameCell.appendChild(nameInput);
        row.appendChild(nameCell);

        const budgetCell = document.createElement('td');
        const budgetInput = document.createElement('input');
        budgetInput.type = 'text';
        budgetInput.placeholder = 'R$';
        budgetInput.value = idea.budget;
        budgetInput.dataset.field = 'budget';
        budgetCell.appendChild(budgetInput);
        row.appendChild(budgetCell);

        const formatCell = document.createElement('td');
        const formatInput = document.createElement('input');
        formatInput.type = 'text';
        formatInput.placeholder = 'Ex.: Meta Ads, Google, Reels';
        formatInput.value = idea.format;
        formatInput.dataset.field = 'format';
        formatCell.appendChild(formatInput);
        row.appendChild(formatCell);

        const obsCell = document.createElement('td');
        const obsArea = document.createElement('textarea');
        obsArea.placeholder = 'Insights, aprendizados e alertas';
        obsArea.value = idea.observation;
        obsArea.dataset.field = 'observation';
        obsCell.appendChild(obsArea);
        row.appendChild(obsCell);

        const audienceCell = document.createElement('td');
        const audienceInput = document.createElement('input');
        audienceInput.type = 'text';
        audienceInput.placeholder = 'Segmento ou persona';
        audienceInput.value = idea.audience;
        audienceInput.dataset.field = 'audience';
        audienceCell.appendChild(audienceInput);
        row.appendChild(audienceCell);

        const copyCell = document.createElement('td');
        const copyArea = document.createElement('textarea');
        copyArea.placeholder = 'Copy principal, CTA ou promessa';
        copyArea.value = idea.copy;
        copyArea.dataset.field = 'copy';
        copyCell.appendChild(copyArea);
        row.appendChild(copyCell);

        const objectiveCell = document.createElement('td');
        const objectiveInput = document.createElement('input');
        objectiveInput.type = 'text';
        objectiveInput.placeholder = 'Objetivo de neg√≥cio';
        objectiveInput.value = idea.objective;
        objectiveInput.dataset.field = 'objective';
        objectiveCell.appendChild(objectiveInput);
        row.appendChild(objectiveCell);

        const statusCell = document.createElement('td');
        const statusSelect = document.createElement('select');
        statusSelect.dataset.field = 'status';
        TRAFEGO_CAMPAIGN_STATUS_OPTIONS.forEach(opt => {
          const option = document.createElement('option');
          option.value = opt.value;
          option.textContent = opt.label;
          if(opt.value === idea.status) option.selected = true;
          statusSelect.appendChild(option);
        });
        statusCell.appendChild(statusSelect);
        row.appendChild(statusCell);

        frag.appendChild(row);
      });
      trafegoCampaignsBody.appendChild(frag);
      if(trafegoCampaignsEmpty){
        if(filtered.length){
          trafegoCampaignsEmpty.style.display = 'none';
        }else{
          const hasItems = TRAFEGO_CAMPAIGN_IDEAS.length > 0;
          trafegoCampaignsEmpty.textContent = hasItems
            ? 'Nenhuma campanha encontrada com os filtros aplicados.'
            : (trafegoCampaignsEmptyDefault || 'Cadastre ideias de campanhas para organizar testes e alinhamentos com o cliente.');
          trafegoCampaignsEmpty.style.display = 'block';
        }
      }
    }

    function scheduleTrafficCampaignPersist({ immediate = false } = {}){
      trafegoCampaignSavePending = true;
      if(trafegoCampaignSaveTimer){
        clearTimeout(trafegoCampaignSaveTimer);
        trafegoCampaignSaveTimer = null;
      }
      if(immediate){
        flushTrafficCampaignPersist();
        return;
      }
      trafegoCampaignSaveTimer = setTimeout(()=> flushTrafficCampaignPersist(), TRAFEGO_CAMPAIGNS_SAVE_DEBOUNCE_MS);
    }

    function hasPendingTrafficCampaignSave(){
      return trafegoCampaignSavePending || trafegoCampaignSaveInFlight || !!trafegoCampaignSaveTimer;
    }

    function shouldDeferTrafficCampaignSnapshot(){
      return hasPendingTrafficCampaignSave();
    }

    function queuePendingTrafficCampaignSnapshot(payload){
      if(!payload){
        pendingTrafficCampaignSnapshot = null;
        return;
      }
      pendingTrafficCampaignSnapshot = payload;
    }

    function maybeApplyPendingTrafficCampaignSnapshot(){
      if(!pendingTrafficCampaignSnapshot) return;
      if(shouldDeferTrafficCampaignSnapshot()) return;
      const { data, signature } = pendingTrafficCampaignSnapshot;
      pendingTrafficCampaignSnapshot = null;
      TRAFEGO_CAMPAIGN_IDEAS = Array.isArray(data) ? data : [];
      trafficCampaignLocalSignature = signature || computeTrafficCampaignSignature(TRAFEGO_CAMPAIGN_IDEAS);
      trafficCampaignSavedSignature = trafficCampaignLocalSignature;
      trafficCampaignRemoteSignature = trafficCampaignLocalSignature;
      renderTrafficCampaignIdeas();
    }

    async function persistTrafficCampaignIdeas(){
      const uid = auth.currentUser?.uid;
      if(!uid) return;
      const payload = getSanitizedTrafficCampaigns();
      USER_DATA.trafegoCampaignIdeas = payload;
      TRAFEGO_CAMPAIGN_IDEAS = payload.map(item => ({ ...item }));
      trafficCampaignSavedSignature = computeTrafficCampaignSignature(payload);
      trafficCampaignLocalSignature = trafficCampaignSavedSignature;
      try{
        await setDoc(doc(db, 'usuarios', uid), { trafegoCampaignIdeas: payload }, { merge: true });
      }catch(err){
        console.error('persistTrafficCampaignIdeas', err);
      }
    }

    async function flushTrafficCampaignPersist(){
      if(trafegoCampaignSaveTimer){
        clearTimeout(trafegoCampaignSaveTimer);
        trafegoCampaignSaveTimer = null;
      }
      if(trafegoCampaignSaveInFlight){
        trafegoCampaignSaveQueued = true;
        return;
      }
      if(!trafegoCampaignSavePending){
        maybeApplyPendingTrafficCampaignSnapshot();
        return;
      }
      trafegoCampaignSavePending = false;
      trafegoCampaignSaveInFlight = true;
      try{
        await persistTrafficCampaignIdeas();
      }finally{
        trafegoCampaignSaveInFlight = false;
        if(trafegoCampaignSaveQueued){
          trafegoCampaignSaveQueued = false;
          scheduleTrafficCampaignPersist({ immediate: true });
          return;
        }
        maybeApplyPendingTrafficCampaignSnapshot();
      }
    }

    function handleRemoteTrafficCampaignIdeas(rawList){
      const normalized = normalizeTrafficCampaignList(rawList);
      const signature = computeTrafficCampaignSignature(normalized);
      if(signature === trafficCampaignRemoteSignature) return;
      trafficCampaignRemoteSignature = signature;
      if(signature === trafficCampaignLocalSignature){
        trafficCampaignSavedSignature = signature;
        if(TRAFEGO_CAMPAIGN_IDEAS.length !== normalized.length){
          TRAFEGO_CAMPAIGN_IDEAS = normalized;
          renderTrafficCampaignIdeas();
        }
        return;
      }
      if(shouldDeferTrafficCampaignSnapshot()){
        queuePendingTrafficCampaignSnapshot({ data: normalized, signature });
        return;
      }
      TRAFEGO_CAMPAIGN_IDEAS = normalized;
      trafficCampaignLocalSignature = signature;
      trafficCampaignSavedSignature = signature;
      renderTrafficCampaignIdeas();
    }

    function loadTrafficCampaignIdeasFromUserData(){
      TRAFEGO_CAMPAIGN_IDEAS = normalizeTrafficCampaignList(USER_DATA?.trafegoCampaignIdeas);
      const signature = computeTrafficCampaignSignature(TRAFEGO_CAMPAIGN_IDEAS);
      trafficCampaignLocalSignature = signature;
      trafficCampaignSavedSignature = signature;
      trafficCampaignRemoteSignature = signature;
      renderTrafficCampaignIdeas();
    }

    function addTrafficCampaignIdea(data = {}){
      const idea = normalizeTrafficCampaignIdea(data);
      TRAFEGO_CAMPAIGN_IDEAS.push(idea);
      updateTrafficCampaignLocalSignature();
      renderTrafficCampaignIdeas();
      scheduleTrafficCampaignPersist();
      focusTrafficCampaignRow(idea.id);
    }

    function focusTrafficCampaignRow(id){
      if(!id) return;
      requestAnimationFrame(()=>{
        const row = trafegoCampaignsBody?.querySelector(`tr[data-id="${escapeTrafficCampaignId(id)}"]`);
        const focusable = row?.querySelector('input, textarea, select');
        if(focusable){
          focusable.focus();
          if(typeof focusable.select === 'function' && focusable.tagName === 'INPUT'){
            focusable.select();
          }
        }
      });
    }

    function handleTrafficCampaignInput(event){
      const target = event.target;
      if(!target || !target.dataset) return;
      const field = target.dataset.field;
      if(!field || field === 'status') return;
      const row = target.closest('tr');
      if(!row) return;
      const id = row.dataset.id;
      const idea = TRAFEGO_CAMPAIGN_IDEAS.find(item => item.id === id);
      if(!idea) return;
      idea[field] = target.value;
      updateTrafficCampaignLocalSignature();
      scheduleTrafficCampaignPersist();
    }

    function handleTrafficCampaignChange(event){
      const target = event.target;
      if(!target || !target.dataset) return;
      const field = target.dataset.field;
      if(!field) return;
      const row = target.closest('tr');
      if(!row) return;
      const id = row.dataset.id;
      const idea = TRAFEGO_CAMPAIGN_IDEAS.find(item => item.id === id);
      if(!idea) return;
      if(field === 'status'){
        const value = target.value;
        idea.status = TRAFEGO_CAMPAIGN_STATUS_OPTIONS.some(opt => opt.value === value) ? value : 'nao-testada';
        updateTrafficCampaignLocalSignature();
        scheduleTrafficCampaignPersist();
        if(!campaignMatchesFilters(idea)){
          renderTrafficCampaignIdeas();
        }
      }else{
        idea[field] = target.value;
        updateTrafficCampaignLocalSignature();
        scheduleTrafficCampaignPersist();
      }
    }

    function handleTrafficCampaignBlur(event){
      if(!event || !event.target || !event.target.dataset?.field) return;
      const row = event.target.closest('tr');
      if(!row) return;
      const id = row.dataset.id;
      const idea = TRAFEGO_CAMPAIGN_IDEAS.find(item => item.id === id);
      if(!idea) return;
      const statusFilterActive = trafegoCampaignStatusFilter && trafegoCampaignStatusFilter.value !== 'all';
      const searchActive = !!(trafegoCampaignSearch && trafegoCampaignSearch.value.trim());
      if(statusFilterActive || searchActive){
        if(!campaignMatchesFilters(idea)){
          renderTrafficCampaignIdeas();
        }
      }
    }

    function trafegoEscAttr(value){
      if(value === undefined || value === null) return '';
      return String(value).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function trafegoAttrNumber(value){
      const num = Number.parseFloat(value);
      return Number.isFinite(num) ? String(num) : '';
    }

    function trafegoNumberValue(raw){
      const num = Number.parseFloat(raw);
      return Number.isFinite(num) ? num : null;
    }

    function trafegoIntValue(raw){
      const num = Number.parseInt(raw, 10);
      return Number.isFinite(num) ? num : null;
    }

    function generateTrafficMetricId(){
      if(typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function'){
        return `metric-${crypto.randomUUID()}`;
      }
      return `metric-${Date.now().toString(36)}-${Math.floor(Math.random() * 1e9).toString(36)}`;
    }

    function sanitizeTrafficMetricDate(value){
      if(typeof value !== 'string') return '';
      const trimmed = value.trim();
      if(!trimmed) return '';
      if(!/^\d{4}-\d{2}-\d{2}$/.test(trimmed)) return '';
      const date = new Date(trimmed);
      if(Number.isNaN(date.getTime())) return '';
      return trimmed;
    }

    function normalizeTrafficMetric(raw = {}){
      const id = typeof raw?.id === 'string' && raw.id ? raw.id : generateTrafficMetricId();
      const date = sanitizeTrafficMetricDate(raw?.date || '');
      const spendValue = trafegoNumberValue(raw?.spend);
      const revenueValue = trafegoNumberValue(raw?.revenue);
      const leadsValue = trafegoIntValue(raw?.leads);
      const note = typeof raw?.note === 'string' ? raw.note.trim() : '';
      return {
        id,
        date,
        spend: spendValue !== null ? spendValue : null,
        revenue: revenueValue !== null ? revenueValue : null,
        leads: leadsValue !== null ? leadsValue : null,
        note
      };
    }

    function normalizeTrafficMetricList(list){
      if(!Array.isArray(list)) return [];
      return list.map(normalizeTrafficMetric);
    }

    function computeTrafficMetricSignature(list){
      if(!Array.isArray(list) || !list.length) return '[]';
      return JSON.stringify(list.map(item => ({
        id: item?.id || '',
        date: item?.date || '',
        spend: (typeof item?.spend === 'number' && Number.isFinite(item.spend)) ? Number(item.spend) : null,
        revenue: (typeof item?.revenue === 'number' && Number.isFinite(item.revenue)) ? Number(item.revenue) : null,
        leads: (typeof item?.leads === 'number' && Number.isFinite(item.leads)) ? Number(item.leads) : null,
        note: item?.note || ''
      })));
    }

    function getSanitizedTrafficMetrics(){
      return TRAFEGO_METRICS.map(item => {
        const normalized = normalizeTrafficMetric(item);
        return {
          id: normalized.id,
          date: normalized.date,
          spend: normalized.spend !== null ? Number(normalized.spend) : null,
          revenue: normalized.revenue !== null ? Number(normalized.revenue) : null,
          leads: normalized.leads !== null ? Number(normalized.leads) : null,
          note: normalized.note
        };
      });
    }

    function updateTrafficMetricsLocalSignature(){
      trafficMetricsLocalSignature = computeTrafficMetricSignature(getSanitizedTrafficMetrics());
    }

    function hasPendingTrafficMetricsSave(){
      return trafegoMetricsSavePending || trafegoMetricsSaveInFlight || !!trafegoMetricsSaveTimer;
    }

    function shouldDeferTrafficMetricsSnapshot(){
      return hasPendingTrafficMetricsSave();
    }

    function queuePendingTrafficMetricsSnapshot(payload){
      pendingTrafficMetricsSnapshot = payload || null;
    }

    function maybeApplyPendingTrafficMetricsSnapshot(){
      if(!pendingTrafficMetricsSnapshot) return;
      if(shouldDeferTrafficMetricsSnapshot()) return;
      const { data, signature } = pendingTrafficMetricsSnapshot;
      pendingTrafficMetricsSnapshot = null;
      TRAFEGO_METRICS = normalizeTrafficMetricList(data);
      const computedSignature = signature || computeTrafficMetricSignature(TRAFEGO_METRICS);
      trafficMetricsLocalSignature = computedSignature;
      trafficMetricsSavedSignature = computedSignature;
      trafficMetricsRemoteSignature = computedSignature;
      renderTrafficMetrics();
    }

    async function persistTrafficMetrics(){
      const uid = auth.currentUser?.uid;
      if(!uid) return;
      const payload = getSanitizedTrafficMetrics();
      USER_DATA.trafegoMetrics = payload;
      TRAFEGO_METRICS = normalizeTrafficMetricList(payload);
      trafficMetricsSavedSignature = computeTrafficMetricSignature(TRAFEGO_METRICS);
      trafficMetricsLocalSignature = trafficMetricsSavedSignature;
      try{
        await setDoc(doc(db, 'usuarios', uid), { trafegoMetrics: payload }, { merge: true });
      }catch(err){
        console.error('persistTrafficMetrics', err);
      }
    }

    async function flushTrafficMetricsPersist(){
      if(trafegoMetricsSaveTimer){
        clearTimeout(trafegoMetricsSaveTimer);
        trafegoMetricsSaveTimer = null;
      }
      if(trafegoMetricsSaveInFlight){
        trafegoMetricsSaveQueued = true;
        return;
      }
      if(!trafegoMetricsSavePending){
        maybeApplyPendingTrafficMetricsSnapshot();
        return;
      }
      trafegoMetricsSavePending = false;
      trafegoMetricsSaveInFlight = true;
      try{
        await persistTrafficMetrics();
      }finally{
        trafegoMetricsSaveInFlight = false;
        if(trafegoMetricsSaveQueued){
          trafegoMetricsSaveQueued = false;
          scheduleTrafficMetricsPersist({ immediate: true });
        }else{
          maybeApplyPendingTrafficMetricsSnapshot();
        }
      }
    }

    function scheduleTrafficMetricsPersist({ immediate = false } = {}){
      trafegoMetricsSavePending = true;
      if(trafegoMetricsSaveTimer){
        clearTimeout(trafegoMetricsSaveTimer);
        trafegoMetricsSaveTimer = null;
      }
      if(immediate){
        flushTrafficMetricsPersist();
        return;
      }
      trafegoMetricsSaveTimer = setTimeout(()=> flushTrafficMetricsPersist(), TRAFEGO_METRICS_SAVE_DEBOUNCE_MS);
    }

    function handleRemoteTrafficMetrics(rawList){
      const normalized = normalizeTrafficMetricList(rawList);
      const signature = computeTrafficMetricSignature(normalized);
      if(signature === trafficMetricsRemoteSignature){
        return;
      }
      trafficMetricsRemoteSignature = signature;
      if(signature === trafficMetricsLocalSignature){
        trafficMetricsSavedSignature = signature;
        TRAFEGO_METRICS = normalized;
        renderTrafficMetrics();
        return;
      }
      if(shouldDeferTrafficMetricsSnapshot()){
        queuePendingTrafficMetricsSnapshot({ data: normalized, signature });
        return;
      }
      TRAFEGO_METRICS = normalized;
      trafficMetricsLocalSignature = signature;
      trafficMetricsSavedSignature = signature;
      renderTrafficMetrics();
    }

    function loadTrafficMetricsFromUserData(){
      TRAFEGO_METRICS = normalizeTrafficMetricList(USER_DATA?.trafegoMetrics);
      const signature = computeTrafficMetricSignature(TRAFEGO_METRICS);
      trafficMetricsLocalSignature = signature;
      trafficMetricsSavedSignature = signature;
      trafficMetricsRemoteSignature = signature;
      renderTrafficMetrics();
    }

    function escapeTrafficMetricId(value){
      const str = String(value || '');
      if(typeof CSS !== 'undefined' && typeof CSS.escape === 'function'){
        return CSS.escape(str);
      }
      return str.replace(/[^a-zA-Z0-9_-]/g, '\\$&');
    }

    function generateTrafficOptimizationId(){
      if(typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function'){
        return `opt-${crypto.randomUUID()}`;
      }
      return `opt-${Date.now().toString(36)}-${Math.floor(Math.random() * 1e9).toString(36)}`;
    }

    function generateTrafficOptimizationHistoryId(){
      if(typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function'){
        return `opthist-${crypto.randomUUID()}`;
      }
      return `opthist-${Date.now().toString(36)}-${Math.floor(Math.random() * 1e9).toString(36)}`;
    }

    function getTrafficPlatformLabel(value){
      const key = typeof value === 'string' ? value.toLowerCase() : '';
      const option = TRAFEGO_PLATFORM_OPTIONS.find(opt => opt.value === key);
      return option ? option.label : (value || '‚Äî');
    }

    function sanitizeOptimizationDate(value){
      if(typeof value !== 'string') return '';
      const trimmed = value.trim();
      if(!/^\d{4}-\d{2}-\d{2}$/.test(trimmed)) return '';
      const [yearStr, monthStr, dayStr] = trimmed.split('-');
      const year = Number.parseInt(yearStr, 10);
      const month = Number.parseInt(monthStr, 10);
      const day = Number.parseInt(dayStr, 10);
      if(!Number.isFinite(year) || !Number.isFinite(month) || !Number.isFinite(day)) return '';
      const date = new Date(year, month - 1, day);
      if(date.getFullYear() !== year || date.getMonth() !== month - 1 || date.getDate() !== day) return '';
      return `${String(year).padStart(4,'0')}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    }

    function parseOptimizationDate(value){
      const sanitized = sanitizeOptimizationDate(value);
      if(!sanitized) return null;
      const [year, month, day] = sanitized.split('-').map(Number);
      return new Date(year, month - 1, day);
    }

    function getOptimizationRecurrenceOption(value){
      const key = typeof value === 'string' ? value.toLowerCase() : '';
      let option = TRAFEGO_OPTIMIZATION_RECURRENCE_OPTIONS.find(opt => opt.value === key) || null;
      if(option) return option;
      const mappedKey = key ? TRAFEGO_OPTIMIZATION_LEGACY_RECURRENCE_MAP[key] : null;
      if(!mappedKey) return null;
      option = TRAFEGO_OPTIMIZATION_RECURRENCE_OPTIONS.find(opt => opt.value === mappedKey) || null;
      return option;
    }

    function getOptimizationIntervalMs(value){
      const option = getOptimizationRecurrenceOption(value);
      if(!option) return null;
      const days = Number(option.days);
      if(!Number.isFinite(days) || days <= 0) return null;
      return days * TRAFEGO_DAY_MS;
    }

    function normalizeTrafficOptimization(raw = {}){
      const id = typeof raw?.id === 'string' && raw.id ? raw.id : generateTrafficOptimizationId();
      const platformValue = typeof raw?.platform === 'string' ? raw.platform.toLowerCase() : '';
      const recurrenceValue = typeof raw?.recurrence === 'string' ? raw.recurrence.toLowerCase() : '';
      const platform = TRAFEGO_PLATFORM_OPTIONS.some(opt => opt.value === platformValue) ? platformValue : 'meta';
      const recurrenceOption = getOptimizationRecurrenceOption(recurrenceValue);
      const recurrence = recurrenceOption ? recurrenceOption.value : TRAFEGO_OPTIMIZATION_DEFAULT_RECURRENCE;
      return {
        id,
        platform,
        campaign: typeof raw?.campaign === 'string' ? raw.campaign : '',
        observation: typeof raw?.observation === 'string' ? raw.observation : '',
        lastOptimization: normalizeOptimizationTopicValue(raw?.lastOptimization, platform),
        lastOptimizationDate: sanitizeOptimizationDate(raw?.lastOptimizationDate),
        recurrence
      };
    }

    function normalizeTrafficOptimizationList(list){
      if(!Array.isArray(list)) return [];
      return list.map(normalizeTrafficOptimization);
    }

    function computeTrafficOptimizationSignature(list){
      if(!Array.isArray(list) || !list.length) return '[]';
      return JSON.stringify(list.map(item => ({
        id: item?.id || '',
        platform: item?.platform || '',
        campaign: item?.campaign || '',
        observation: item?.observation || '',
        lastOptimization: normalizeOptimizationTopicValue(item?.lastOptimization, item?.platform),
        lastOptimizationDate: item?.lastOptimizationDate || '',
        recurrence: item?.recurrence || ''
      })));
    }

    function getSanitizedTrafficOptimizations(){
      return TRAFEGO_OPTIMIZATIONS.map(item => {
        const platform = TRAFEGO_PLATFORM_OPTIONS.some(opt => opt.value === item.platform) ? item.platform : 'meta';
        const recurrenceOption = getOptimizationRecurrenceOption(item.recurrence);
        const recurrence = recurrenceOption ? recurrenceOption.value : TRAFEGO_OPTIMIZATION_DEFAULT_RECURRENCE;
        const topic = normalizeOptimizationTopicValue(item.lastOptimization, platform);
        return {
          id: item.id,
          platform,
          campaign: (item.campaign || '').trim(),
          observation: (item.observation || '').trim(),
          lastOptimization: topic,
          lastOptimizationDate: sanitizeOptimizationDate(item.lastOptimizationDate),
          recurrence
        };
      });
    }

    function sanitizeHistoryTimestamp(value){
      if(typeof value !== 'string') return new Date().toISOString();
      const trimmed = value.trim();
      if(!trimmed) return new Date().toISOString();
      const date = new Date(trimmed);
      if(Number.isNaN(date.getTime())) return trimmed;
      return date.toISOString();
    }

    function normalizeTrafficOptimizationHistoryEntry(raw = {}){
      const id = typeof raw?.id === 'string' && raw.id ? raw.id : generateTrafficOptimizationHistoryId();
      const optimizationId = typeof raw?.optimizationId === 'string' ? raw.optimizationId : '';
      const platformValue = typeof raw?.platform === 'string' ? raw.platform.toLowerCase() : '';
      const platform = TRAFEGO_PLATFORM_OPTIONS.some(opt => opt.value === platformValue) ? platformValue : 'meta';
      const campaign = typeof raw?.campaign === 'string' ? raw.campaign : '';
      const observation = typeof raw?.observation === 'string' ? raw.observation : '';
      const lastOptimization = normalizeOptimizationTopicValue(raw?.lastOptimization, platform);
      const lastOptimizationDate = sanitizeOptimizationDate(raw?.lastOptimizationDate);
      const updatedAt = sanitizeHistoryTimestamp(raw?.updatedAt);
      const changedFields = Array.isArray(raw?.changedFields)
        ? raw.changedFields
            .map(field => String(field).trim())
            .map(field => {
              const lower = field.toLowerCase();
              if(lower === 'platform') return 'platform';
              if(lower === 'campaign') return 'campaign';
              if(lower === 'observation' || lower === 'observacao' || lower === 'observa√ß√£o') return 'observation';
              if(lower === 'lastoptimization' || lower === 'ultimaotimizacao' || lower === '√∫ltima otimiza√ß√£o' || lower === 'ultima otimiza√ß√£o') return 'lastOptimization';
              if(lower === 'lastoptimizationdate' || lower === 'dataultimaotimizacao' || lower === 'data da √∫ltima otimiza√ß√£o') return 'lastOptimizationDate';
              return null;
            })
            .filter(field => field && TRAFEGO_OPTIMIZATION_HISTORY_FIELDS.includes(field))
        : [];
      const uniqueChangedFields = [];
      if(changedFields.length){
        const seenFields = new Set();
        changedFields.forEach(field => {
          if(!seenFields.has(field)){
            seenFields.add(field);
            uniqueChangedFields.push(field);
          }
        });
      }
      return {
        id,
        optimizationId,
        platform,
        campaign,
        observation,
        lastOptimization,
        lastOptimizationDate,
        updatedAt,
        changedFields: uniqueChangedFields
      };
    }

    function normalizeTrafficOptimizationHistoryList(list){
      if(!Array.isArray(list)) return [];
      const normalized = list.map(normalizeTrafficOptimizationHistoryEntry);
      normalized.sort((a,b)=> (b.updatedAt || '').localeCompare(a.updatedAt || ''));
      const deduped = [];
      const seen = new Set();
      normalized.forEach(entry => {
        const key = entry.id || `${entry.optimizationId || ''}-${entry.updatedAt || ''}`;
        if(!key || seen.has(key)) return;
        seen.add(key);
        deduped.push(entry);
      });
      return deduped.slice(0, TRAFEGO_OPTIMIZATION_HISTORY_LIMIT);
    }

    function computeTrafficOptimizationHistorySignature(list){
      if(!Array.isArray(list) || !list.length) return '[]';
      return JSON.stringify(list.map(entry => ({
        id: entry?.id || '',
        optimizationId: entry?.optimizationId || '',
        platform: entry?.platform || '',
        campaign: entry?.campaign || '',
        observation: entry?.observation || '',
        lastOptimization: normalizeOptimizationTopicValue(entry?.lastOptimization, entry?.platform),
        lastOptimizationDate: entry?.lastOptimizationDate || '',
        updatedAt: entry?.updatedAt || '',
        changedFields: Array.isArray(entry?.changedFields)
          ? entry.changedFields.filter(field => TRAFEGO_OPTIMIZATION_HISTORY_FIELDS.includes(field))
          : []
      })));
    }

    function getSanitizedTrafficOptimizationHistory(){
      return TRAFEGO_OPTIMIZATION_HISTORY.map(entry => {
        const platform = TRAFEGO_PLATFORM_OPTIONS.some(opt => opt.value === entry.platform) ? entry.platform : 'meta';
        const lastOptimization = normalizeOptimizationTopicValue(entry.lastOptimization, platform);
        const lastOptimizationDate = sanitizeOptimizationDate(entry.lastOptimizationDate);
        const updatedAt = sanitizeHistoryTimestamp(entry.updatedAt);
        const changedFields = Array.isArray(entry.changedFields)
          ? entry.changedFields.filter(field => TRAFEGO_OPTIMIZATION_HISTORY_FIELDS.includes(field))
          : [];
        const uniqueChangedFields = [];
        if(changedFields.length){
          const seenFields = new Set();
          changedFields.forEach(field => {
            if(!seenFields.has(field)){
              seenFields.add(field);
              uniqueChangedFields.push(field);
            }
          });
        }
        return {
          id: entry.id || generateTrafficOptimizationHistoryId(),
          optimizationId: typeof entry.optimizationId === 'string' ? entry.optimizationId : '',
          platform,
          campaign: (entry.campaign || '').trim(),
          observation: (entry.observation || '').trim(),
          lastOptimization,
          lastOptimizationDate,
          updatedAt,
          changedFields: uniqueChangedFields
        };
      });
    }

    function updateTrafficOptimizationHistoryLocalSignature(){
      trafficHistoryLocalSignature = computeTrafficOptimizationHistorySignature(TRAFEGO_OPTIMIZATION_HISTORY);
    }

    function collectTrafficOptimizationHistoryEntries(prevList, nextList){
      const entries = [];
      if(!Array.isArray(nextList) || !nextList.length) return entries;
      const prevMap = new Map();
      if(Array.isArray(prevList)){
        prevList.forEach(item => {
          if(item && typeof item === 'object' && typeof item.id === 'string'){
            const platform = TRAFEGO_PLATFORM_OPTIONS.some(opt => opt.value === item.platform) ? item.platform : 'meta';
            prevMap.set(item.id, {
              platform,
              campaign: (item.campaign || '').trim(),
              observation: (item.observation || '').trim(),
              lastOptimization: normalizeOptimizationTopicValue(item.lastOptimization, platform),
              lastOptimizationDate: sanitizeOptimizationDate(item.lastOptimizationDate || '')
            });
          }
        });
      }
      const nowIso = new Date().toISOString();
      nextList.forEach(item => {
        if(!item || typeof item !== 'object') return;
        const id = typeof item.id === 'string' ? item.id : '';
        if(!id) return;
        const platform = TRAFEGO_PLATFORM_OPTIONS.some(opt => opt.value === item.platform) ? item.platform : 'meta';
        const payload = {
          optimizationId: id,
          platform,
          campaign: (item.campaign || '').trim(),
          observation: (item.observation || '').trim(),
          lastOptimization: normalizeOptimizationTopicValue(item.lastOptimization, platform),
          lastOptimizationDate: sanitizeOptimizationDate(item.lastOptimizationDate || '')
        };
        const prev = prevMap.get(id);
        if(!prev){
          const changedFields = TRAFEGO_OPTIMIZATION_HISTORY_FIELDS.filter(field => payload[field]);
          if(changedFields.length){
            entries.push({ ...payload, id: generateTrafficOptimizationHistoryId(), updatedAt: nowIso, changedFields });
          }
          return;
        }
        const changedFields = TRAFEGO_OPTIMIZATION_HISTORY_FIELDS.filter(field => (prev[field] || '') !== (payload[field] || ''));
        if(changedFields.length){
          entries.push({ ...payload, id: generateTrafficOptimizationHistoryId(), updatedAt: nowIso, changedFields });
        }
      });
      return entries;
    }

    function updateTrafficOptimizationLocalSignature(){
      trafficOptimizationLocalSignature = computeTrafficOptimizationSignature(TRAFEGO_OPTIMIZATIONS);
    }

    function escapeTrafficOptimizationId(value){
      if(typeof CSS !== 'undefined' && typeof CSS.escape === 'function'){
        return CSS.escape(value);
      }
      return String(value).replace(/[^a-zA-Z0-9_-]/g, match => `\\${match}`);
    }

    function getOptimizationFilters(){
      const platform = (trafegoOptimizationPlatformFilter?.value || 'all').toLowerCase();
      const recurrence = (trafegoOptimizationRecurrenceFilter?.value || 'all').toLowerCase();
      const search = (trafegoOptimizationSearch?.value || '').toLowerCase().trim();
      return { platform, recurrence, search };
    }

    function optimizationMatchesFilters(item){
      const { platform, recurrence, search } = getOptimizationFilters();
      if(platform !== 'all' && item.platform !== platform) return false;
      if(recurrence !== 'all' && item.recurrence !== recurrence) return false;
      if(search && !(item.campaign || '').toLowerCase().includes(search)) return false;
      return true;
    }

    function computeTrafficOptimizationStats(item){
      const intervalMs = getOptimizationIntervalMs(item?.recurrence);
      const lastDate = parseOptimizationDate(item?.lastOptimizationDate);
      const now = Date.now();
      let percent = 0;
      let isEmpty = true;
      let nextDate = null;
      let nextLabel = '‚Äî';
      let diffDays = 0;
      const intervalDays = intervalMs ? intervalMs / TRAFEGO_DAY_MS : 0;
      if(lastDate && intervalMs){
        isEmpty = false;
        const diff = now - lastDate.getTime();
        diffDays = diff / TRAFEGO_DAY_MS;
        percent = clamp((diff / intervalMs) * 100, 0, 100);
        nextDate = new Date(lastDate.getTime() + intervalMs);
        nextLabel = nextDate.toLocaleDateString('pt-BR');
      }
      const label = `${Math.round(percent)}%`;
      const titleParts = [];
      if(isEmpty){
        titleParts.push('Defina a data da √∫ltima otimiza√ß√£o e a recorr√™ncia para acompanhar o progresso.');
      }else{
        const elapsed = Math.max(diffDays, 0);
        titleParts.push(`Decorrido: ${elapsed >= 10 ? Math.round(elapsed) : elapsed.toFixed(1)} dia(s)`);
        if(intervalDays){
          const intervalDisplay = intervalDays >= 10 || Number.isInteger(intervalDays)
            ? Math.round(intervalDays)
            : intervalDays.toFixed(1);
          titleParts.push(`Intervalo: ${intervalDisplay} dia(s)`);
        }
        if(nextDate){
          titleParts.push(`Pr√≥xima otimiza√ß√£o: ${nextLabel}`);
        }
      }
      return {
        percent,
        label,
        title: titleParts.join(' ‚Ä¢ '),
        isEmpty,
        isDue: !isEmpty && percent >= 100,
        nextLabel
      };
    }

    function createTrafficOptimizationRow(item){
      const row = document.createElement('tr');
      row.dataset.id = item.id;

      const platformCell = document.createElement('td');
      const platformSelect = document.createElement('select');
      platformSelect.dataset.field = 'platform';
      TRAFEGO_PLATFORM_OPTIONS.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.label;
        if(opt.value === item.platform) option.selected = true;
        platformSelect.appendChild(option);
      });
      platformCell.appendChild(platformSelect);
      row.appendChild(platformCell);

      const campaignCell = document.createElement('td');
      const campaignInput = document.createElement('input');
      campaignInput.type = 'text';
      campaignInput.placeholder = 'Campanha';
      campaignInput.dataset.field = 'campaign';
      campaignInput.value = item.campaign;
      campaignCell.appendChild(campaignInput);
      row.appendChild(campaignCell);

      const progressCell = document.createElement('td');
      const progressWrap = document.createElement('div');
      progressWrap.className = 'trafego-progress';
      progressWrap.setAttribute('role', 'progressbar');
      progressWrap.setAttribute('aria-valuemin', '0');
      progressWrap.setAttribute('aria-valuemax', '100');
      const progressFill = document.createElement('div');
      progressFill.className = 'trafego-progress-fill';
      const progressLabel = document.createElement('span');
      progressLabel.className = 'trafego-progress-label';
      progressWrap.appendChild(progressFill);
      progressWrap.appendChild(progressLabel);
      progressCell.appendChild(progressWrap);
      row.appendChild(progressCell);

      const observationCell = document.createElement('td');
      const observationArea = document.createElement('textarea');
      observationArea.placeholder = 'Observa√ß√µes gerais';
      observationArea.dataset.field = 'observation';
      observationArea.value = item.observation;
      observationCell.appendChild(observationArea);
      row.appendChild(observationCell);

      const lastOptimizationCell = document.createElement('td');
      const lastOptimizationSelect = document.createElement('select');
      const selectedTopic = normalizeOptimizationTopicValue(item.lastOptimization, item.platform);
      item.lastOptimization = selectedTopic;
      lastOptimizationSelect.dataset.field = 'lastOptimization';
      lastOptimizationSelect.setAttribute('aria-label', 'Itens da √∫ltima otimiza√ß√£o');
      populateOptimizationTopicOptions(lastOptimizationSelect, item.platform, selectedTopic);
      lastOptimizationCell.appendChild(lastOptimizationSelect);
      row.appendChild(lastOptimizationCell);

      const lastDateCell = document.createElement('td');
      const lastDateInput = document.createElement('input');
      lastDateInput.type = 'date';
      lastDateInput.dataset.field = 'lastOptimizationDate';
      lastDateInput.value = item.lastOptimizationDate || '';
      lastDateCell.appendChild(lastDateInput);
      row.appendChild(lastDateCell);

      const recurrenceCell = document.createElement('td');
      const recurrenceSelect = document.createElement('select');
      recurrenceSelect.dataset.field = 'recurrence';
      TRAFEGO_OPTIMIZATION_RECURRENCE_OPTIONS.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.label;
        if(opt.value === item.recurrence) option.selected = true;
        recurrenceSelect.appendChild(option);
      });
      recurrenceCell.appendChild(recurrenceSelect);
      row.appendChild(recurrenceCell);

      const nextCell = document.createElement('td');
      const nextSpan = document.createElement('span');
      nextSpan.className = 'trafego-next-optimization';
      nextSpan.textContent = '‚Äî';
      nextCell.appendChild(nextSpan);
      row.appendChild(nextCell);

      const actionsCell = document.createElement('td');
      actionsCell.className = 'trafego-actions-cell';
      const saveButton = document.createElement('button');
      saveButton.type = 'button';
      saveButton.className = 'btn small trafego-save-optimization';
      saveButton.textContent = 'Salvar';
      actionsCell.appendChild(saveButton);
      row.appendChild(actionsCell);

      row._optimizationRefs = {
        wrap: progressWrap,
        fill: progressFill,
        label: progressLabel,
        next: nextSpan,
        topicsSelect: lastOptimizationSelect
      };
      updateTrafficOptimizationRow(row, item);
      return row;
    }

    function updateTrafficOptimizationRow(row, item){
      if(!row || !row._optimizationRefs) return;
      const refs = row._optimizationRefs;
      const stats = computeTrafficOptimizationStats(item);
      if(refs.fill){
        refs.fill.style.width = `${stats.percent}%`;
      }
      if(refs.label){
        refs.label.textContent = stats.label;
      }
      if(refs.wrap){
        refs.wrap.classList.toggle('is-due', !!stats.isDue);
        refs.wrap.classList.toggle('is-empty', !!stats.isEmpty);
        refs.wrap.setAttribute('aria-valuenow', String(Math.round(stats.percent)));
        refs.wrap.setAttribute('title', stats.title || '');
      }
      if(refs.next){
        refs.next.textContent = stats.nextLabel || '‚Äî';
      }
    }

    function syncTrafficOptimizationItemFromRow(row, item){
      if(!row || !item) return;
      const platformSelect = row.querySelector('select[data-field="platform"]');
      if(platformSelect){
        const value = String(platformSelect.value || '').toLowerCase();
        const platform = TRAFEGO_PLATFORM_OPTIONS.some(opt => opt.value === value) ? value : 'meta';
        item.platform = platform;
        if(platformSelect.value !== platform){
          platformSelect.value = platform;
        }
      }
      const campaignInput = row.querySelector('input[data-field="campaign"]');
      if(campaignInput){
        item.campaign = campaignInput.value || '';
      }
      const observationArea = row.querySelector('textarea[data-field="observation"]');
      if(observationArea){
        item.observation = observationArea.value || '';
      }
      const recurrenceSelect = row.querySelector('select[data-field="recurrence"]');
      if(recurrenceSelect){
        const value = String(recurrenceSelect.value || '').toLowerCase();
        const option = getOptimizationRecurrenceOption(value);
        const recurrence = option ? option.value : TRAFEGO_OPTIMIZATION_DEFAULT_RECURRENCE;
        item.recurrence = recurrence;
        if(recurrenceSelect.value !== recurrence){
          recurrenceSelect.value = recurrence;
        }
      }
      const dateInput = row.querySelector('input[data-field="lastOptimizationDate"]');
      if(dateInput){
        const sanitized = sanitizeOptimizationDate(dateInput.value);
        item.lastOptimizationDate = sanitized;
        if(dateInput.value !== sanitized){
          dateInput.value = sanitized;
        }
      }
      const topicSelect = row.querySelector('select[data-field="lastOptimization"]');
      if(topicSelect){
        const normalizedTopic = normalizeOptimizationTopicValue(topicSelect.value, item.platform);
        item.lastOptimization = normalizedTopic;
        if(topicSelect.value !== normalizedTopic){
          populateOptimizationTopicOptions(topicSelect, item.platform, normalizedTopic);
        }
      }
      updateTrafficOptimizationRow(row, item);
    }

    function trafegoDelay(ms){
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function renderTrafficOptimizations(){
      if(!trafegoOptimizationsBody) return;
      trafegoOptimizationsBody.innerHTML = '';
      const { platform, recurrence, search } = getOptimizationFilters();
      const filtered = TRAFEGO_OPTIMIZATIONS.filter(item => {
        if(platform !== 'all' && item.platform !== platform) return false;
        if(recurrence !== 'all' && item.recurrence !== recurrence) return false;
        if(search && !(item.campaign || '').toLowerCase().includes(search)) return false;
        return true;
      });
      const frag = document.createDocumentFragment();
      filtered.forEach(item => {
        frag.appendChild(createTrafficOptimizationRow(item));
      });
      trafegoOptimizationsBody.appendChild(frag);
      if(trafegoOptimizationsEmpty){
        if(filtered.length){
          trafegoOptimizationsEmpty.style.display = 'none';
        }else{
          const hasItems = TRAFEGO_OPTIMIZATIONS.length > 0;
          trafegoOptimizationsEmpty.textContent = hasItems
            ? 'Nenhuma otimiza√ß√£o encontrada com os filtros aplicados.'
            : (trafegoOptimizationsEmptyDefault || 'Cadastre otimiza√ß√µes para acompanhar os prazos de revis√£o.');
          trafegoOptimizationsEmpty.style.display = 'block';
        }
      }
    }

    function scheduleTrafficOptimizationHistoryPersist({ immediate = false } = {}){
      trafegoHistorySavePending = true;
      if(trafegoHistorySaveTimer){
        clearTimeout(trafegoHistorySaveTimer);
        trafegoHistorySaveTimer = null;
      }
      if(immediate){
        flushTrafficOptimizationHistoryPersist();
        return;
      }
      trafegoHistorySaveTimer = setTimeout(()=> flushTrafficOptimizationHistoryPersist(), TRAFEGO_HISTORY_SAVE_DEBOUNCE_MS);
    }

    function hasPendingTrafficOptimizationHistorySave(){
      return trafegoHistorySavePending || trafegoHistorySaveInFlight || !!trafegoHistorySaveTimer;
    }

    function shouldDeferTrafficOptimizationHistorySnapshot(){
      return hasPendingTrafficOptimizationHistorySave();
    }

    function queuePendingTrafficOptimizationHistorySnapshot(payload){
      pendingTrafficOptimizationHistorySnapshot = payload;
    }

    function maybeApplyPendingTrafficOptimizationHistorySnapshot(){
      if(!pendingTrafficOptimizationHistorySnapshot) return;
      if(shouldDeferTrafficOptimizationHistorySnapshot()) return;
      const { data, signature } = pendingTrafficOptimizationHistorySnapshot;
      pendingTrafficOptimizationHistorySnapshot = null;
      TRAFEGO_OPTIMIZATION_HISTORY = Array.isArray(data) ? data : [];
      trafficHistoryLocalSignature = signature || computeTrafficOptimizationHistorySignature(TRAFEGO_OPTIMIZATION_HISTORY);
      trafficHistorySavedSignature = trafficHistoryLocalSignature;
      trafficHistoryRemoteSignature = trafficHistoryLocalSignature;
      renderTrafficOptimizationHistory();
    }

    async function persistTrafficOptimizationHistory(){
      const uid = auth.currentUser?.uid;
      if(!uid) return;
      const payload = getSanitizedTrafficOptimizationHistory();
      USER_DATA.trafegoOptimizationHistory = payload;
      TRAFEGO_OPTIMIZATION_HISTORY = normalizeTrafficOptimizationHistoryList(payload);
      trafficHistorySavedSignature = computeTrafficOptimizationHistorySignature(TRAFEGO_OPTIMIZATION_HISTORY);
      trafficHistoryLocalSignature = trafficHistorySavedSignature;
      try{
        await setDoc(doc(db, 'usuarios', uid), { trafegoOptimizationHistory: payload }, { merge: true });
      }catch(err){
        console.error('persistTrafficOptimizationHistory', err);
      }
    }

    async function flushTrafficOptimizationHistoryPersist(){
      if(trafegoHistorySaveTimer){
        clearTimeout(trafegoHistorySaveTimer);
        trafegoHistorySaveTimer = null;
      }
      if(trafegoHistorySaveInFlight){
        trafegoHistorySaveQueued = true;
        return;
      }
      if(!trafegoHistorySavePending){
        maybeApplyPendingTrafficOptimizationHistorySnapshot();
        return;
      }
      trafegoHistorySavePending = false;
      trafegoHistorySaveInFlight = true;
      try{
        await persistTrafficOptimizationHistory();
      }finally{
        trafegoHistorySaveInFlight = false;
        if(trafegoHistorySaveQueued){
          trafegoHistorySaveQueued = false;
          scheduleTrafficOptimizationHistoryPersist({ immediate: true });
        }else{
          maybeApplyPendingTrafficOptimizationHistorySnapshot();
        }
      }
    }

    function formatTrafficHistoryUpdatedAt(iso){
      if(!iso) return '‚Äî';
      const date = new Date(iso);
      if(Number.isNaN(date.getTime())) return iso;
      return date.toLocaleString('pt-BR', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
    }

    function formatHistoryOptimizationDate(iso){
      if(!iso) return '';
      const parts = iso.split('-');
      if(parts.length === 3){
        return `${parts[2]}/${parts[1]}/${parts[0]}`;
      }
      return iso;
    }

    function renderTrafficOptimizationHistory(){
      if(!trafegoHistoryBody) return;
      const platformFilter = (trafegoHistoryPlatformFilter?.value || 'all').toLowerCase();
      const searchValue = (trafegoHistorySearch?.value || '').toLowerCase().trim();
      const sorted = [...TRAFEGO_OPTIMIZATION_HISTORY].sort((a,b)=> (b.updatedAt || '').localeCompare(a.updatedAt || ''));
      const filtered = sorted.filter(entry => {
        if(platformFilter !== 'all' && entry.platform !== platformFilter) return false;
        if(searchValue && !(entry.campaign || '').toLowerCase().includes(searchValue)) return false;
        return true;
      });
      trafegoHistoryBody.innerHTML = '';
      const frag = document.createDocumentFragment();
      filtered.forEach(entry => {
        const row = document.createElement('tr');
        row.dataset.id = entry.id || '';
        if(Array.isArray(entry.changedFields) && entry.changedFields.length){
          const labels = entry.changedFields.map(field => {
            switch(field){
              case 'platform': return 'Plataforma';
              case 'campaign': return 'Nome da campanha';
              case 'observation': return 'Observa√ß√£o';
              case 'lastOptimization': return '√öltima otimiza√ß√£o';
              case 'lastOptimizationDate': return 'Data da √∫ltima otimiza√ß√£o';
              default: return field;
            }
          });
          row.title = `Campos alterados: ${labels.join(', ')}`;
        }
        const platformCell = document.createElement('td');
        platformCell.textContent = getTrafficPlatformLabel(entry.platform);
        row.appendChild(platformCell);

        const campaignCell = document.createElement('td');
        campaignCell.textContent = entry.campaign || '‚Äî';
        row.appendChild(campaignCell);

        const observationCell = document.createElement('td');
        observationCell.textContent = entry.observation || '‚Äî';
        row.appendChild(observationCell);

        const lastOptimizationCell = document.createElement('td');
        lastOptimizationCell.textContent = entry.lastOptimization || '‚Äî';
        row.appendChild(lastOptimizationCell);

        const updatedCell = document.createElement('td');
        const updatedMain = document.createElement('div');
        updatedMain.textContent = formatTrafficHistoryUpdatedAt(entry.updatedAt);
        updatedCell.appendChild(updatedMain);
        if(entry.lastOptimizationDate){
          const optimizationMeta = document.createElement('div');
          optimizationMeta.className = 'trafego-history-meta';
          optimizationMeta.textContent = `√öltima otimiza√ß√£o: ${formatHistoryOptimizationDate(entry.lastOptimizationDate)}`;
          updatedCell.appendChild(optimizationMeta);
        }
        row.appendChild(updatedCell);

        const actionsCell = document.createElement('td');
        actionsCell.className = 'trafego-history-actions';
        const removeButton = document.createElement('button');
        removeButton.type = 'button';
        removeButton.className = 'trafego-history-remove';
        removeButton.setAttribute('aria-label', 'Remover registro');
        removeButton.dataset.id = entry.id || '';
        removeButton.textContent = '‚ùå';
        actionsCell.appendChild(removeButton);
        row.appendChild(actionsCell);

        frag.appendChild(row);
      });
      trafegoHistoryBody.appendChild(frag);
      if(trafegoHistoryEmpty){
        if(filtered.length){
          trafegoHistoryEmpty.style.display = 'none';
        }else{
          const hasItems = TRAFEGO_OPTIMIZATION_HISTORY.length > 0;
          trafegoHistoryEmpty.textContent = hasItems
            ? 'Nenhuma altera√ß√£o encontrada com os filtros aplicados.'
            : 'Nenhum registro no hist√≥rico ainda.';
          trafegoHistoryEmpty.style.display = 'block';
        }
      }
    }

    function removeTrafficOptimizationHistoryEntry(id){
      if(!id) return;
      const index = TRAFEGO_OPTIMIZATION_HISTORY.findIndex(entry => entry.id === id);
      if(index === -1) return;
      TRAFEGO_OPTIMIZATION_HISTORY.splice(index, 1);
      updateTrafficOptimizationHistoryLocalSignature();
      renderTrafficOptimizationHistory();
      scheduleTrafficOptimizationHistoryPersist({ immediate: true });
    }

    function addTrafficOptimizationHistoryEntries(entries = []){
      if(!Array.isArray(entries) || !entries.length) return;
      const normalized = entries.map(normalizeTrafficOptimizationHistoryEntry);
      const combined = [...normalized, ...TRAFEGO_OPTIMIZATION_HISTORY];
      const deduped = [];
      const seen = new Set();
      combined.forEach(entry => {
        const key = entry.id || `${entry.optimizationId || ''}-${entry.updatedAt || ''}`;
        if(!key || seen.has(key)) return;
        seen.add(key);
        deduped.push(entry);
      });
      deduped.sort((a,b)=> (b.updatedAt || '').localeCompare(a.updatedAt || ''));
      TRAFEGO_OPTIMIZATION_HISTORY = deduped.slice(0, TRAFEGO_OPTIMIZATION_HISTORY_LIMIT);
      updateTrafficOptimizationHistoryLocalSignature();
      renderTrafficOptimizationHistory();
      scheduleTrafficOptimizationHistoryPersist();
    }

    function recordManualTrafficOptimizationHistory(item, previousSnapshot = null){
      if(!item) return;
      const sanitizedList = getSanitizedTrafficOptimizations();
      const payload = sanitizedList.find(entry => entry.id === item.id);
      if(!payload) return;
      let changedFields = [];
      if(Array.isArray(previousSnapshot) && previousSnapshot.length){
        const prev = previousSnapshot.find(entry => entry && entry.id === payload.id);
        if(prev){
          changedFields = TRAFEGO_OPTIMIZATION_HISTORY_FIELDS.filter(field => (prev[field] || '') !== (payload[field] || ''));
        }
      }
      if(!changedFields.length){
        const filledFields = TRAFEGO_OPTIMIZATION_HISTORY_FIELDS.filter(field => payload[field]);
        if(filledFields.length){
          changedFields = filledFields;
        }
      }
      const historyEntry = {
        id: generateTrafficOptimizationHistoryId(),
        optimizationId: payload.id,
        platform: payload.platform,
        campaign: payload.campaign,
        observation: payload.observation,
        lastOptimization: payload.lastOptimization,
        lastOptimizationDate: payload.lastOptimizationDate,
        updatedAt: new Date().toISOString(),
        changedFields
      };
      addTrafficOptimizationHistoryEntries([historyEntry]);
    }

    function scheduleTrafficOptimizationPersist({ immediate = false } = {}){
      trafegoOptimizationSavePending = true;
      if(trafegoOptimizationSaveTimer){
        clearTimeout(trafegoOptimizationSaveTimer);
        trafegoOptimizationSaveTimer = null;
      }
      if(immediate){
        flushTrafficOptimizationPersist();
        return;
      }
      trafegoOptimizationSaveTimer = setTimeout(()=> flushTrafficOptimizationPersist(), TRAFEGO_OPTIMIZATION_SAVE_DEBOUNCE_MS);
    }

    function hasPendingTrafficOptimizationSave(){
      return trafegoOptimizationSavePending || trafegoOptimizationSaveInFlight || !!trafegoOptimizationSaveTimer;
    }

    function shouldDeferTrafficOptimizationSnapshot(){
      return hasPendingTrafficOptimizationSave();
    }

    function queuePendingTrafficOptimizationSnapshot(payload){
      if(!payload){
        pendingTrafficOptimizationSnapshot = null;
        return;
      }
      pendingTrafficOptimizationSnapshot = payload;
    }

    async function saveTrafficOptimizationsImmediate(){
      trafegoOptimizationSavePending = true;
      if(trafegoOptimizationSaveTimer){
        clearTimeout(trafegoOptimizationSaveTimer);
        trafegoOptimizationSaveTimer = null;
      }
      await flushTrafficOptimizationPersist();
      const start = Date.now();
      while(trafegoOptimizationSaveInFlight || trafegoOptimizationSaveQueued || trafegoOptimizationSavePending){
        if(Date.now() - start > TRAFEGO_OPTIMIZATION_SAVE_TIMEOUT_MS){
          throw new Error('traffic-optimization-save-timeout');
        }
        await trafegoDelay(80);
      }
    }

    function maybeApplyPendingTrafficOptimizationSnapshot(){
      if(!pendingTrafficOptimizationSnapshot) return;
      if(shouldDeferTrafficOptimizationSnapshot()) return;
      const { data, signature } = pendingTrafficOptimizationSnapshot;
      pendingTrafficOptimizationSnapshot = null;
      TRAFEGO_OPTIMIZATIONS = Array.isArray(data) ? data : [];
      trafficOptimizationLocalSignature = signature || computeTrafficOptimizationSignature(TRAFEGO_OPTIMIZATIONS);
      trafficOptimizationSavedSignature = trafficOptimizationLocalSignature;
      trafficOptimizationRemoteSignature = trafficOptimizationLocalSignature;
      TRAFEGO_OPTIMIZATIONS_LAST_SAVED = getSanitizedTrafficOptimizations().map(item => ({ ...item }));
      renderTrafficOptimizations();
    }

    async function persistTrafficOptimizations(){
      const uid = auth.currentUser?.uid;
      if(!uid) return;
      const payload = getSanitizedTrafficOptimizations();
      TRAFEGO_OPTIMIZATIONS_LAST_SAVED = payload.map(item => ({ ...item }));
      USER_DATA.trafegoOptimizations = payload;
      TRAFEGO_OPTIMIZATIONS = payload.map(normalizeTrafficOptimization);
      trafficOptimizationSavedSignature = computeTrafficOptimizationSignature(TRAFEGO_OPTIMIZATIONS);
      trafficOptimizationLocalSignature = trafficOptimizationSavedSignature;
      try{
        await setDoc(doc(db, 'usuarios', uid), { trafegoOptimizations: payload }, { merge: true });
      }catch(err){
        console.error('persistTrafficOptimizations', err);
      }
    }

    async function flushTrafficOptimizationPersist(){
      if(trafegoOptimizationSaveTimer){
        clearTimeout(trafegoOptimizationSaveTimer);
        trafegoOptimizationSaveTimer = null;
      }
      if(trafegoOptimizationSaveInFlight){
        trafegoOptimizationSaveQueued = true;
        return;
      }
      if(!trafegoOptimizationSavePending){
        maybeApplyPendingTrafficOptimizationSnapshot();
        return;
      }
      trafegoOptimizationSavePending = false;
      trafegoOptimizationSaveInFlight = true;
      try{
        await persistTrafficOptimizations();
      }finally{
        trafegoOptimizationSaveInFlight = false;
        if(trafegoOptimizationSaveQueued){
          trafegoOptimizationSaveQueued = false;
          scheduleTrafficOptimizationPersist({ immediate: true });
          return;
        }
        maybeApplyPendingTrafficOptimizationSnapshot();
      }
    }

    function handleRemoteTrafficOptimizations(rawList){
      const normalized = normalizeTrafficOptimizationList(rawList);
      const signature = computeTrafficOptimizationSignature(normalized);
      if(signature === trafficOptimizationRemoteSignature) return;
      trafficOptimizationRemoteSignature = signature;
      if(signature === trafficOptimizationLocalSignature){
        trafficOptimizationSavedSignature = signature;
        if(TRAFEGO_OPTIMIZATIONS.length !== normalized.length){
          TRAFEGO_OPTIMIZATIONS = normalized;
          renderTrafficOptimizations();
        }
        TRAFEGO_OPTIMIZATIONS_LAST_SAVED = getSanitizedTrafficOptimizations().map(item => ({ ...item }));
        return;
      }
      if(shouldDeferTrafficOptimizationSnapshot()){
        queuePendingTrafficOptimizationSnapshot({ data: normalized, signature });
        return;
      }
      TRAFEGO_OPTIMIZATIONS = normalized;
      trafficOptimizationLocalSignature = signature;
      trafficOptimizationSavedSignature = signature;
      TRAFEGO_OPTIMIZATIONS_LAST_SAVED = getSanitizedTrafficOptimizations().map(item => ({ ...item }));
      renderTrafficOptimizations();
    }

    function handleRemoteTrafficOptimizationHistory(rawList){
      const normalized = normalizeTrafficOptimizationHistoryList(rawList);
      const signature = computeTrafficOptimizationHistorySignature(normalized);
      if(signature === trafficHistoryRemoteSignature) return;
      trafficHistoryRemoteSignature = signature;
      if(signature === trafficHistoryLocalSignature){
        trafficHistorySavedSignature = signature;
        return;
      }
      if(shouldDeferTrafficOptimizationHistorySnapshot()){
        queuePendingTrafficOptimizationHistorySnapshot({ data: normalized, signature });
        return;
      }
      TRAFEGO_OPTIMIZATION_HISTORY = normalized;
      trafficHistoryLocalSignature = signature;
      trafficHistorySavedSignature = signature;
      renderTrafficOptimizationHistory();
    }

    function loadTrafficOptimizationsFromUserData(){
      TRAFEGO_OPTIMIZATIONS = normalizeTrafficOptimizationList(USER_DATA?.trafegoOptimizations);
      const signature = computeTrafficOptimizationSignature(TRAFEGO_OPTIMIZATIONS);
      trafficOptimizationLocalSignature = signature;
      trafficOptimizationSavedSignature = signature;
      trafficOptimizationRemoteSignature = signature;
      TRAFEGO_OPTIMIZATIONS_LAST_SAVED = getSanitizedTrafficOptimizations().map(item => ({ ...item }));
      renderTrafficOptimizations();
    }

    function loadTrafficOptimizationHistoryFromUserData(){
      TRAFEGO_OPTIMIZATION_HISTORY = normalizeTrafficOptimizationHistoryList(USER_DATA?.trafegoOptimizationHistory);
      const signature = computeTrafficOptimizationHistorySignature(TRAFEGO_OPTIMIZATION_HISTORY);
      trafficHistoryLocalSignature = signature;
      trafficHistorySavedSignature = signature;
      trafficHistoryRemoteSignature = signature;
      renderTrafficOptimizationHistory();
    }

    function addTrafficOptimization(data = {}){
      const item = normalizeTrafficOptimization(data);
      TRAFEGO_OPTIMIZATIONS.push(item);
      updateTrafficOptimizationLocalSignature();
      renderTrafficOptimizations();
      scheduleTrafficOptimizationPersist();
      focusTrafficOptimizationRow(item.id);
    }

    function focusTrafficOptimizationRow(id){
      if(!id) return;
      requestAnimationFrame(()=>{
        const row = trafegoOptimizationsBody?.querySelector(`tr[data-id="${escapeTrafficOptimizationId(id)}"]`);
        const focusable = row?.querySelector('input, textarea, select');
        if(focusable){
          focusable.focus();
          if(focusable.tagName === 'INPUT' && typeof focusable.select === 'function'){
            focusable.select();
          }
        }
      });
    }

    function handleTrafficOptimizationInput(event){
      const target = event.target;
      if(!target || !target.dataset) return;
      const field = target.dataset.field;
      if(!field || field === 'platform' || field === 'recurrence' || field === 'lastOptimizationDate' || field === 'lastOptimization') return;
      const row = target.closest('tr');
      if(!row) return;
      const id = row.dataset.id;
      const item = TRAFEGO_OPTIMIZATIONS.find(entry => entry.id === id);
      if(!item) return;
      item[field] = target.value;
      updateTrafficOptimizationLocalSignature();
      scheduleTrafficOptimizationPersist();
      updateTrafficOptimizationRow(row, item);
    }

    function handleTrafficOptimizationChange(event){
      const target = event.target;
      if(!target || !target.dataset) return;
      const field = target.dataset.field;
      if(!field) return;
      const row = target.closest('tr');
      if(!row) return;
      const id = row.dataset.id;
      const item = TRAFEGO_OPTIMIZATIONS.find(entry => entry.id === id);
      if(!item) return;
      if(field === 'platform'){
        const value = String(target.value || '').toLowerCase();
        item.platform = TRAFEGO_PLATFORM_OPTIONS.some(opt => opt.value === value) ? value : 'meta';
        item.lastOptimization = normalizeOptimizationTopicValue(item.lastOptimization, item.platform);
        if(row._optimizationRefs?.topicsSelect){
          populateOptimizationTopicOptions(row._optimizationRefs.topicsSelect, item.platform, item.lastOptimization);
        }
      }else if(field === 'recurrence'){
        const value = String(target.value || '').toLowerCase();
        const recurrenceOption = getOptimizationRecurrenceOption(value);
        item.recurrence = recurrenceOption ? recurrenceOption.value : TRAFEGO_OPTIMIZATION_DEFAULT_RECURRENCE;
      }else if(field === 'lastOptimizationDate'){
        const sanitized = sanitizeOptimizationDate(target.value);
        item.lastOptimizationDate = sanitized;
        if(target.value !== sanitized){
          target.value = sanitized;
        }
      }else if(field === 'lastOptimization'){
        const value = target.value;
        item.lastOptimization = normalizeOptimizationTopicValue(value, item.platform);
        populateOptimizationTopicOptions(target, item.platform, item.lastOptimization);
      }
      updateTrafficOptimizationLocalSignature();
      scheduleTrafficOptimizationPersist();
      updateTrafficOptimizationRow(row, item);
      const { platform, recurrence, search } = getOptimizationFilters();
      const filtersActive = platform !== 'all' || recurrence !== 'all' || !!search;
      if(filtersActive && !optimizationMatchesFilters(item)){
        renderTrafficOptimizations();
      }
    }

    function handleTrafficOptimizationBlur(event){
      if(!event?.target?.dataset?.field) return;
      const row = event.target.closest('tr');
      if(!row) return;
      const id = row.dataset.id;
      const item = TRAFEGO_OPTIMIZATIONS.find(entry => entry.id === id);
      if(!item) return;
      if(!optimizationMatchesFilters(item)){
        renderTrafficOptimizations();
      }
    }

    function handleTrafficOptimizationClick(event){
      const button = event.target?.closest('.trafego-save-optimization');
      if(!button) return;
      event.preventDefault();
      onTrafficOptimizationSaveButtonClick(button);
    }

    async function onTrafficOptimizationSaveButtonClick(button){
      if(!button) return;
      const row = button.closest('tr');
      if(!row) return;
      const id = row.dataset.id;
      if(!id) return;
      const item = TRAFEGO_OPTIMIZATIONS.find(entry => entry.id === id);
      if(!item) return;
      if(button.disabled) return;
      if(!auth?.currentUser){
        alert('Fa√ßa login para salvar otimiza√ß√µes.');
        return;
      }
      button.disabled = true;
      try{
        const previousSnapshot = Array.isArray(TRAFEGO_OPTIMIZATIONS_LAST_SAVED)
          ? TRAFEGO_OPTIMIZATIONS_LAST_SAVED.map(entry => ({ ...entry }))
          : [];
        syncTrafficOptimizationItemFromRow(row, item);
        updateTrafficOptimizationLocalSignature();
        await saveTrafficOptimizationsImmediate();
        recordManualTrafficOptimizationHistory(item, previousSnapshot);
        if(typeof mgToast === 'function'){
          mgToast('Otimiza√ß√£o registrada com sucesso');
        }else{
          alert('Otimiza√ß√£o registrada com sucesso');
        }
      }catch(err){
        console.error('onTrafficOptimizationSaveButtonClick', err);
        alert('N√£o foi poss√≠vel salvar a otimiza√ß√£o. Tente novamente.');
      }finally{
        button.disabled = false;
      }
    }

    function handleTrafficHistoryClick(event){
      const button = event.target?.closest('.trafego-history-remove');
      if(!button) return;
      event.preventDefault();
      const id = button.dataset.id || button.closest('tr')?.dataset.id;
      if(!id) return;
      const confirmed = confirm('Remover este registro do hist√≥rico?');
      if(!confirmed) return;
      removeTrafficOptimizationHistoryEntry(id);
    }

    function addTrafficDemandaRow(data = {}){
      if(!trafegoDemandasBody) return;
      const status = (data.status || '').toLowerCase();
      const options = TRAFEGO_STATUS_OPTIONS.map(opt=>`<option value="${opt.value}"${opt.value===status?' selected':''}>${opt.label}</option>`).join('');
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><input type="text" placeholder="Campanha ou conjunto" value="${trafegoEscAttr(data.campaign)}"></td>
        <td><input type="text" placeholder="Objetivo da otimiza√ß√£o" value="${trafegoEscAttr(data.objective)}"></td>
        <td><input type="number" min="0" step="0.01" placeholder="R$" value="${trafegoAttrNumber(data.budget)}"></td>
        <td><select>${options}</select></td>
        <td><input type="text" placeholder="Pr√≥ximos passos e alertas" value="${trafegoEscAttr(data.notes)}"></td>
        <td><button type="button" class="trafego-remove-demand">Remover</button></td>
      `;
      trafegoDemandasBody.appendChild(row);
    }

    function renderTrafficMetrics(){
      if(!trafegoMetricsBody) return;
      trafegoMetricsBody.innerHTML = '';
      if(!TRAFEGO_METRICS.length) return;
      const frag = document.createDocumentFragment();
      TRAFEGO_METRICS.forEach(metric => {
        frag.appendChild(createTrafficMetricRow(metric));
      });
      trafegoMetricsBody.appendChild(frag);
    }

    function createTrafficMetricRow(metric){
      const item = normalizeTrafficMetric(metric);
      const row = document.createElement('tr');
      row.dataset.id = item.id;
      row.innerHTML = `
        <td><input type="date" data-field="date" value="${trafegoEscAttr(item.date)}"></td>
        <td><input type="number" min="0" step="0.01" data-field="spend" placeholder="0,00" value="${trafegoAttrNumber(item.spend)}"></td>
        <td><input type="number" min="0" step="0.01" data-field="revenue" placeholder="0,00" value="${trafegoAttrNumber(item.revenue)}"></td>
        <td><span class="trafego-roas">‚Äî</span></td>
        <td><input type="number" min="0" step="1" data-field="leads" placeholder="0" value="${trafegoAttrNumber(item.leads)}"></td>
        <td><span class="trafego-cpl">‚Äî</span></td>
        <td><input type="text" data-field="note" placeholder="Insights do dia" value="${trafegoEscAttr(item.note)}"></td>
      `;
      updateTrafficMetricRow(row);
      return row;
    }

    function updateTrafficMetricRow(row){
      if(!row) return null;
      const dateInput = row.querySelector('input[data-field="date"]');
      const spendInput = row.querySelector('input[data-field="spend"]');
      const revenueInput = row.querySelector('input[data-field="revenue"]');
      const leadsInput = row.querySelector('input[data-field="leads"]');
      const noteInput = row.querySelector('input[data-field="note"]');
      const roasCell = row.querySelector('.trafego-roas');
      const cplCell = row.querySelector('.trafego-cpl');

      const spend = trafegoNumberValue(spendInput?.value);
      const revenue = trafegoNumberValue(revenueInput?.value);
      const leads = trafegoIntValue(leadsInput?.value);
      const note = noteInput?.value?.trim?.() || '';

      let roas = null;
      if(spend !== null && spend > 0 && revenue !== null){
        roas = revenue / spend;
      }
      if(roasCell){
        if(roas !== null && Number.isFinite(roas)){
          roasCell.textContent = `${roas.toFixed(2)}x`;
          roasCell.classList.toggle('negative', roas < 1);
        }else{
          roasCell.textContent = '‚Äî';
          roasCell.classList.remove('negative');
        }
      }

      let cpl = null;
      if(spend !== null && spend > 0 && leads !== null && leads > 0){
        cpl = spend / leads;
      }
      if(cplCell){
        if(cpl !== null && Number.isFinite(cpl)){
          cplCell.textContent = `R$ ${cpl.toFixed(2)}`;
        }else{
          cplCell.textContent = '‚Äî';
        }
      }

      const dateValue = dateInput?.value || '';

      row.dataset.date = dateValue;
      row.dataset.spend = spend !== null ? String(spend) : '';
      row.dataset.revenue = revenue !== null ? String(revenue) : '';
      row.dataset.leads = leads !== null ? String(leads) : '';
      row.dataset.roas = roas !== null && Number.isFinite(roas) ? String(roas) : '';
      row.dataset.cpl = cpl !== null && Number.isFinite(cpl) ? String(cpl) : '';
      row.dataset.note = note;

      return { date: dateValue, spend, revenue, leads, note };
    }

    function syncTrafficMetricRow(row, { scheduleSave = true } = {}){
      if(!row) return;
      const id = row.dataset.id;
      const values = updateTrafficMetricRow(row);
      if(!values || !id) return;
      let metric = TRAFEGO_METRICS.find(item => item.id === id);
      if(!metric){
        metric = normalizeTrafficMetric({ id, ...values });
        TRAFEGO_METRICS.push(metric);
        updateTrafficMetricsLocalSignature();
        if(scheduleSave){
          scheduleTrafficMetricsPersist();
        }
        return;
      }
      const changed =
        (metric.date || '') !== values.date ||
        metric.spend !== values.spend ||
        metric.revenue !== values.revenue ||
        metric.leads !== values.leads ||
        (metric.note || '') !== values.note;
      if(!changed) return;
      metric.date = values.date;
      metric.spend = values.spend;
      metric.revenue = values.revenue;
      metric.leads = values.leads;
      metric.note = values.note;
      updateTrafficMetricsLocalSignature();
      if(scheduleSave){
        scheduleTrafficMetricsPersist();
      }
    }

    function addTrafficMetricRow(data = {}, options = {}){
      const { persist = true, focus = true } = options || {};
      const metric = normalizeTrafficMetric(data);
      TRAFEGO_METRICS.push(metric);
      updateTrafficMetricsLocalSignature();
      renderTrafficMetrics();
      if(persist){
        scheduleTrafficMetricsPersist();
      }
      if(focus !== false){
        focusTrafficMetricRow(metric.id);
      }
      return metric;
    }

    function focusTrafficMetricRow(id){
      if(!trafegoMetricsBody || !id) return;
      const selector = `tr[data-id="${escapeTrafficMetricId(id)}"] input[data-field="date"]`;
      const input = trafegoMetricsBody.querySelector(selector);
      if(input){
        input.focus();
        if(typeof input.select === 'function'){
          input.select();
        }
      }
    }

    function renderTrafego(){
      if(!trafegoWrap) return;
      if(!trafegoInitialized){
        trafegoInitialized = true;
        if(trafegoAddDemanda){
          trafegoAddDemanda.addEventListener('click', ()=>{
            addTrafficDemandaRow();
          });
        }
        if(trafegoAddOptimization){
          trafegoAddOptimization.addEventListener('click', ()=> addTrafficOptimization());
        }
        if(trafegoDemandasBody){
          trafegoDemandasBody.addEventListener('click', (event)=>{
            const target = event.target;
            if(target && target.classList?.contains('trafego-remove-demand')){
              const row = target.closest('tr');
              if(row){ row.remove(); }
              event.preventDefault();
            }
          });
        }
        if(trafegoAddMetricRow){
          trafegoAddMetricRow.addEventListener('click', ()=>{
            addTrafficMetricRow({}, { persist: true, focus: true });
          });
        }
        const metricsHandler = (event)=>{
          const row = event.target?.closest?.('tr');
          if(!row) return;
          syncTrafficMetricRow(row);
        };
        if(trafegoMetricsBody){
          trafegoMetricsBody.addEventListener('input', metricsHandler);
          trafegoMetricsBody.addEventListener('change', metricsHandler);
        }
        if(trafegoAddCampaign){
          trafegoAddCampaign.addEventListener('click', ()=> addTrafficCampaignIdea());
        }
        if(trafegoCampaignsBody){
          trafegoCampaignsBody.addEventListener('input', handleTrafficCampaignInput);
          trafegoCampaignsBody.addEventListener('change', handleTrafficCampaignChange);
          trafegoCampaignsBody.addEventListener('blur', handleTrafficCampaignBlur, true);
        }
        if(trafegoOptimizationsBody){
          trafegoOptimizationsBody.addEventListener('input', handleTrafficOptimizationInput);
          trafegoOptimizationsBody.addEventListener('change', handleTrafficOptimizationChange);
          trafegoOptimizationsBody.addEventListener('blur', handleTrafficOptimizationBlur, true);
          trafegoOptimizationsBody.addEventListener('click', handleTrafficOptimizationClick);
        }
        if(trafegoCampaignStatusFilter){
          trafegoCampaignStatusFilter.addEventListener('change', ()=> renderTrafficCampaignIdeas());
        }
        if(trafegoCampaignSearch){
          trafegoCampaignSearch.addEventListener('input', ()=> renderTrafficCampaignIdeas());
        }
        if(trafegoOptimizationPlatformFilter){
          trafegoOptimizationPlatformFilter.addEventListener('change', ()=> renderTrafficOptimizations());
        }
        if(trafegoOptimizationRecurrenceFilter){
          trafegoOptimizationRecurrenceFilter.addEventListener('change', ()=> renderTrafficOptimizations());
        }
        if(trafegoOptimizationSearch){
          trafegoOptimizationSearch.addEventListener('input', ()=> renderTrafficOptimizations());
        }
        if(trafegoHistoryPlatformFilter){
          trafegoHistoryPlatformFilter.addEventListener('change', ()=> renderTrafficOptimizationHistory());
        }
        if(trafegoHistorySearch){
          trafegoHistorySearch.addEventListener('input', ()=> renderTrafficOptimizationHistory());
        }
        if(trafegoHistoryBody){
          trafegoHistoryBody.addEventListener('click', handleTrafficHistoryClick);
        }
        if(trafegoDemandasBody && !trafegoDemandasBody.childElementCount){
          addTrafficDemandaRow({ status: 'ativa' });
        }
        if(!TRAFEGO_METRICS.length){
          addTrafficMetricRow({ date: new Date().toISOString().slice(0,10) }, { persist: false, focus: false });
        }else{
          renderTrafficMetrics();
        }
      }
      renderTrafficOptimizations();
      renderTrafficOptimizationHistory();
      renderTrafficCampaignIdeas();
    }

    function buildTabs(){
      sectionTabs.innerHTML="";
      SECTIONS.forEach(s=>{
        const b=document.createElement("button");
        b.className="tab-btn"+(s.id===currentSection?" active":"");
        b.setAttribute("role","tab"); b.setAttribute("aria-selected",s.id===currentSection?"true":"false");
        b.dataset.section = s.id;
        if(s.id === 'macro'){
          b.innerHTML = `<span class="tab-label">${s.name}</span><span class="tab-badge" hidden>atualizado</span>`;
          macroTabBadgeEl = b.querySelector('.tab-badge');
          syncMacroTabBadge();
        }else{
          b.textContent=s.name;
        }
        b.addEventListener("click",()=>{ if(currentSection===s.id) return; setActiveTab(s.id); });
        sectionTabs.appendChild(b);
      });
    }

    let tabKeyNavBound=false;
    function initTabKeyNav(){
      if(tabKeyNavBound) return;
      tabKeyNavBound=true;
      document.addEventListener('keydown',function(ev){
        if(ev.key!=='ArrowLeft' && ev.key!=='ArrowRight') return;
        const tag=ev.target.tagName?.toLowerCase();
        if(tag==='input' || tag==='textarea' || ev.target.isContentEditable) return;
        if(document.querySelector('.modal.show')) return;
        const tabs=[...sectionTabs.querySelectorAll('.tab-btn')];
        if(!tabs.length) return;
        const idx=tabs.findIndex(t=>t.classList.contains('active'));
        let next=idx+(ev.key==='ArrowRight'?1:-1);
        if(next<0) next=tabs.length-1;
        if(next>=tabs.length) next=0;
        tabs[next].click();
      });
    }

    function rerenderBySection(){
      // show panel only on Macro
      const isMacro = currentSection==="macro";
      if(macroSectionRoot){
        macroSectionRoot.style.display = isMacro ? "block" : "none";
      }
      if(macroActions) macroActions.style.display = isMacro ? "flex" : "none";
      if(!isMacro && historyChart){
        historyChart.destroy();
        historyChart = null;
      }
      renderHistoryChart();
      renderHistoryLegend();
      if(currentSection==="notes"){
        setSectionVisibility({notes:true});
        renderNotes();
      } else if(currentSection==="calendar"){
        setSectionVisibility({calendar:true});
        ensureCalendar();
      } else if(currentSection==="briefing"){
        setSectionVisibility({briefing:true});
        renderBrief();
      } else if(currentSection==="metas"){
        setSectionVisibility({metas:true});
        renderMetas();
      } else if(currentSection==="cac"){
        setSectionVisibility({cac:true});
        renderCAC();
      } else if(currentSection==="trafego"){
        setSectionVisibility({trafego:true});
        renderTrafego();
      } else if(currentSection==="demandas"){
        setSectionVisibility({demandas:true});
        renderDemandas();
      } else if(currentSection==="access"){
        setSectionVisibility({access:true});
        renderAccesses();
      } else if(currentSection==="arquivos"){
        setSectionVisibility({files:true});
        renderFiles();
      } else if(currentSection==="ia"){
        setSectionVisibility({ia:true});
        renderIA();
      } else if(currentSection==="refSocial"){
        setSectionVisibility({refSocial:true});
        renderRefSocial();
      } else if(currentSection==="concorrentes"){
        setSectionVisibility({concorrentes:true});
        renderCompetitors();
      } else if(currentSection==="relatorio"){
        setSectionVisibility({relatorio:true});
        initRelatorio();
      } else {
        setSectionVisibility({widgets:true});
        if(widgetsRenderedSection !== currentSection){
          loadWidgetsFromData();
          renderWidgets();
          widgetsRenderedSection = currentSection;
        }
      }
      updateScrollHint();
    }

    /* ========= Relat√≥rio ========= */
  let relatorioMesInput, relatorioGerarBtn, relatorioExportarBtn, relatorioPreview;
  let relatorioStoriesSection, relatorioStoriesGrid, relatorioStoriesPrev, relatorioStoriesNext, relatorioStoriesSubtitle;
  let relatorioPostsSection, relatorioPostsGrid, relatorioPostsPrev, relatorioPostsNext, relatorioPostsSubtitle;
  let relatorioGoalsSection, relatorioGoalsSubtitle, relatorioGoalsDonePill, relatorioGoalsProgressPill, relatorioGoalsTodoPill, relatorioGoalsClearFilter;
  let relatorioGoalsDone, relatorioGoalsProgress, relatorioGoalsTodo;
  let relatorioMetasSection, relatorioMetasSubtitle, relatorioMetasAchievedPill, relatorioMetasProgressPill, relatorioMetasMissingPill, relatorioMetasClearFilter;
  let relatorioMetasAchieved, relatorioMetasProgress, relatorioMetasMissing;
  let relatorioGoalsNotesSimple, relatorioGoalsNotesSimpleStatus;
  // Redes trabalhadas
  let relatorioRedesSection, relatorioRedesGrid, relatorioRedesDesc, relatorioRedesSubtitle;
  let relatorioStoriesDesc, relatorioPostsDesc, relatorioGoalsDesc, relatorioMetasDesc;
  
    
    function initRelatorio(){
      if(!relatorioMesInput){
        relatorioMesInput = $("relatorioMes");
        relatorioGerarBtn = $("relatorioGerar");
        relatorioExportarBtn = $("relatorioExportar");
        relatorioPreview = $("relatorioPreview");
        relatorioStoriesSection = $("relatorioStoriesSection");
        relatorioStoriesGrid = $("relatorioStoriesGrid");
        relatorioStoriesPrev = $("relatorioStoriesPrev");
        relatorioStoriesNext = $("relatorioStoriesNext");
        relatorioStoriesSubtitle = $("relatorioStoriesSubtitle");
    relatorioStoriesDesc = $("relatorioStoriesDesc");
  relatorioPostsSection = $("relatorioPostsSection");
  relatorioPostsGrid = $("relatorioPostsGrid");
  relatorioPostsPrev = $("relatorioPostsPrev");
  relatorioPostsNext = $("relatorioPostsNext");
  relatorioPostsSubtitle = $("relatorioPostsSubtitle");
  relatorioPostsDesc = $("relatorioPostsDesc");
  relatorioGoalsSection = $("relatorioGoalsSection");
  relatorioGoalsSubtitle = $("relatorioGoalsSubtitle");
  relatorioGoalsDonePill = $("relatorioGoalsDonePill");
  relatorioGoalsProgressPill = $("relatorioGoalsProgressPill");
  relatorioGoalsTodoPill = $("relatorioGoalsTodoPill");
  relatorioGoalsClearFilter = $("relatorioGoalsClearFilter");
  relatorioGoalsDone = $("relatorioGoalsDone");
  relatorioGoalsProgress = $("relatorioGoalsProgress");
  relatorioGoalsTodo = $("relatorioGoalsTodo");
  relatorioGoalsDesc = $("relatorioGoalsDesc");
  relatorioMetasSection = $("relatorioMetasSection");
  relatorioMetasSubtitle = $("relatorioMetasSubtitle");
  relatorioMetasAchievedPill = $("relatorioMetasAchievedPill");
  relatorioMetasProgressPill = $("relatorioMetasProgressPill");
  relatorioMetasMissingPill = $("relatorioMetasMissingPill");
  relatorioMetasClearFilter = $("relatorioMetasClearFilter");
  relatorioMetasAchieved = $("relatorioMetasAchieved");
  relatorioMetasProgress = $("relatorioMetasProgress");
  relatorioMetasMissing = $("relatorioMetasMissing");
  relatorioMetasDesc = $("relatorioMetasDesc");
  relatorioGoalsNotesSimple = $("relatorioGoalsNotesSimple");
  relatorioGoalsNotesSimpleStatus = $("relatorioGoalsNotesSimpleStatus");
  
        
        if(relatorioGerarBtn){
          relatorioGerarBtn.addEventListener('click', gerarRelatorio);
        }
        if(relatorioExportarBtn){
          relatorioExportarBtn.addEventListener('click', exportarRelatorioPDF);
        }
        if(relatorioMesInput){
          relatorioMesInput.addEventListener('change', onRelatorioMesChange);
        }
        if(relatorioStoriesPrev && relatorioStoriesGrid){
          relatorioStoriesPrev.addEventListener('click', ()=> relatorioStoriesGrid.scrollBy({left:-200, behavior:'smooth'}));
        }
        if(relatorioStoriesNext && relatorioStoriesGrid){
          relatorioStoriesNext.addEventListener('click', ()=> relatorioStoriesGrid.scrollBy({left:200, behavior:'smooth'}));
        }
        if(relatorioPostsPrev && relatorioPostsGrid){
          relatorioPostsPrev.addEventListener('click', ()=> relatorioPostsGrid.scrollBy({left:-200, behavior:'smooth'}));
        }
        if(relatorioPostsNext && relatorioPostsGrid){
          relatorioPostsNext.addEventListener('click', ()=> relatorioPostsGrid.scrollBy({left:200, behavior:'smooth'}));
        }
        if(relatorioGoalsDonePill){ relatorioGoalsDonePill.addEventListener('click', ()=> filterGoals('concluido')); }
        if(relatorioGoalsProgressPill){ relatorioGoalsProgressPill.addEventListener('click', ()=> filterGoals('em-andamento')); }
        if(relatorioGoalsTodoPill){ relatorioGoalsTodoPill.addEventListener('click', ()=> filterGoals('nao-iniciado')); }
        if(relatorioGoalsClearFilter){ relatorioGoalsClearFilter.addEventListener('click', ()=> filterGoals('')); }
        if(relatorioMetasAchievedPill){ relatorioMetasAchievedPill.addEventListener('click', ()=> filterMetas('concluido')); }
        if(relatorioMetasProgressPill){ relatorioMetasProgressPill.addEventListener('click', ()=> filterMetas('em-andamento')); }
        if(relatorioMetasMissingPill){ relatorioMetasMissingPill.addEventListener('click', ()=> filterMetas('nao-iniciado')); }
        if(relatorioMetasClearFilter){ relatorioMetasClearFilter.addEventListener('click', ()=> filterMetas('')); }
        if(relatorioGoalsNotesSimple){ relatorioGoalsNotesSimple.addEventListener('input', saveRelatorioGoalsNoteLocal); }
        // Captura dos elementos de Redes trabalhadas
        relatorioRedesSection = $("relatorioRedesSection");
        relatorioRedesGrid = $("relatorioRedesGrid");
        relatorioRedesDesc = $("relatorioRedesDesc");
        relatorioRedesSubtitle = $("relatorioRedesSubtitle");
        
      }
    }
    
    function onRelatorioMesChange(){
      if(!relatorioMesInput || !relatorioMesInput.value) return;
      renderRelatorioStories(relatorioMesInput.value);
      renderRelatorioPosts(relatorioMesInput.value);
      renderRelatorioGoals(relatorioMesInput.value);
  renderRelatorioMetas(relatorioMesInput.value);
  loadRelatorioGoalsNoteLocal(relatorioMesInput.value);
  // Atualiza tamb√©m o bloco de redes trabalhadas (independente do m√™s, mas mant√©m consist√™ncia visual)
  renderRelatorioRedes(relatorioMesInput.value);
    }
    
  function renderRelatorioStories(mesISO){
      if(!relatorioStoriesGrid || !relatorioStoriesSection || !mesISO) return;
      
      const [ano, mes] = mesISO.split('-');
      const stories = POSTS.filter(p => {
        if((p.target || 'feed') !== 'stories') return false;
        if(!p.dateISO) return false;
        const [pAno, pMes] = p.dateISO.split('-');
        return pAno === ano && pMes === mes;
      });
      
      if(stories.length === 0){
        relatorioStoriesSection.style.display = 'none';
        return;
      }
      
      relatorioStoriesSection.style.display = 'block';
      
      const meses = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
      const mesNome = meses[parseInt(mes)-1] || mes;
      if(relatorioStoriesSubtitle){
        relatorioStoriesSubtitle.textContent = `${stories.length} ${stories.length===1?'story':'stories'} produzido${stories.length===1?'':'s'} em ${mesNome} de ${ano}`;
      }

      // Descri√ß√£o resumida abaixo do bloco
      if(relatorioStoriesDesc){
        const total = stories.length;
        const aprovados = stories.filter(p=> (p.status||'')==='aprovado').length;
        const revisar = stories.filter(p=> (p.status||'')==='revisar').length;
        const pendentes = Math.max(0, total - aprovados - revisar);
        const rate = total>0 ? Math.round((aprovados/total)*100) : 0;
        const diasMes = Math.max(1, new Date(parseInt(ano,10), parseInt(mes,10), 0).getDate());
        const mediaDia = (total/diasMes).toFixed(1);
        relatorioStoriesDesc.style.display = 'block';
        relatorioStoriesDesc.textContent = `‚ú® ${mesNome} de ${ano}: ${total} ${total===1?'story':'stories'} produzid${total===1?'o':'os'} ‚Ä¢ ${aprovados} aprovados (${rate}%), ${revisar} para revisar, ${pendentes} pendentes ‚Ä¢ Ritmo m√©dio: ${mediaDia}/dia. Excelente consist√™ncia de publica√ß√µes para refor√ßar a presen√ßa da marca.`;
      }
      
      stories.sort((a,b)=> (a.dateISO<b.dateISO?-1:a.dateISO>b.dateISO?1:0));
      
      relatorioStoriesGrid.innerHTML = stories.map(p=>{
        const firstMedia = p.mediaUrls?.[0] || "";
        const ext = firstMedia.split("?")[0].split(".").pop().toLowerCase();
        const isVideo = ["mp4","mov","webm","m4v","avi"].includes(ext);

        let cls = "relatorio-story-item";
        if(p.status === "aprovado"){
          cls += p.approvedBy === 'interno' ? " aprovado-interno" : " aprovado";
        }else if(p.status === "revisar"){
          cls += " revisar";
        }else{
          cls += " pendente";
        }
        if(isVideo) cls += " video";

        const [y,m,d] = (p.dateISO||'').split('-');
        const dateLabel = d && m ? `${d}/${m}` : '';

        // Se for v√≠deo e houver capa customizada (imagem), usa a capa
        const hasCustomCover = p.thumbUrl && !/\.(mp4|mov|webm|m4v|avi)(\?|$)/i.test(p.thumbUrl);
        if(isVideo){
          if(hasCustomCover){
            return `
              <div class="${cls}" data-id="${p.id}">
                <img src="${p.thumbUrl}" alt="Story ${dateLabel}" crossorigin="anonymous">
                <div class="relatorio-story-status"></div>
                <div class="relatorio-story-date">${dateLabel}</div>
              </div>
            `;
          }
          // Sen√£o, gera automaticamente a thumbnail via canvas
          if(firstMedia){
            return `
              <div class="${cls}" data-id="${p.id}" data-video-url="${firstMedia}">
                <span>V</span>
                <div class="relatorio-story-status"></div>
                <div class="relatorio-story-date">${dateLabel}</div>
              </div>
            `;
          }
        }
        // N√£o √© v√≠deo: usa a primeira m√≠dia dispon√≠vel (thumbUrl preferencial)
        const imgSrc = p.thumbUrl || firstMedia;
        if(imgSrc){
          return `
            <div class="${cls}" data-id="${p.id}">
              <img src="${imgSrc}" alt="Story ${dateLabel}" crossorigin="anonymous">
              <div class="relatorio-story-status"></div>
              <div class="relatorio-story-date">${dateLabel}</div>
            </div>
          `;
        }
        // Sem m√≠dia
        return `
          <div class="${cls}" data-id="${p.id}">
            <div class="relatorio-story-status"></div>
            <div class="relatorio-story-date">${dateLabel}</div>
          </div>
        `;
      }).join("");
      
      relatorioStoriesGrid.querySelectorAll('.relatorio-story-item').forEach(el=>{
        el.addEventListener('click', ()=>{
          const id = el.getAttribute('data-id');
          const post = POSTS.find(p=>p.id===id);
          if(post && typeof openPostModal === 'function') openPostModal(post);
        });
      });
      // Agendar gera√ß√£o das thumbnails de v√≠deo
      setTimeout(() => { try{ applyVideoThumbnails(); }catch(_e){ try{ window.applyVideoThumbnails && window.applyVideoThumbnails(); }catch(__){} } }, 120);
    }

    function renderRelatorioPosts(mesISO){
      if(!relatorioPostsGrid || !relatorioPostsSection || !mesISO) return;

      const [ano, mes] = mesISO.split('-');
      const posts = POSTS.filter(p => {
        if((p.target || 'feed') !== 'feed') return false;
        if(!p.dateISO) return false;
        const [pAno, pMes] = p.dateISO.split('-');
        return pAno === ano && pMes === mes;
      });

      if(posts.length === 0){
        relatorioPostsSection.style.display = 'none';
        return;
      }

      relatorioPostsSection.style.display = 'block';

      const meses = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
      const mesNome = meses[parseInt(mes)-1] || mes;
      if(relatorioPostsSubtitle){
        relatorioPostsSubtitle.textContent = `${posts.length} ${posts.length===1?'post':'posts'} produzido${posts.length===1?'':'s'} em ${mesNome} de ${ano}`;
      }

      // Descri√ß√£o resumida abaixo do bloco
      if(relatorioPostsDesc){
        const total = posts.length;
        const aprovados = posts.filter(p=> (p.status||'')==='aprovado').length;
        const revisar = posts.filter(p=> (p.status||'')==='revisar').length;
        const pendentes = Math.max(0, total - aprovados - revisar);
        const rate = total>0 ? Math.round((aprovados/total)*100) : 0;
        const diasMes = Math.max(1, new Date(parseInt(ano,10), parseInt(mes,10), 0).getDate());
        const mediaDia = (total/diasMes).toFixed(1);
        relatorioPostsDesc.style.display = 'block';
        relatorioPostsDesc.textContent = `‚ú® ${mesNome} de ${ano}: ${total} ${total===1?'post':'posts'} no feed ‚Ä¢ ${aprovados} aprovados (${rate}%), ${revisar} para revisar, ${pendentes} pendentes ‚Ä¢ Ritmo m√©dio: ${mediaDia}/dia. Conte√∫do consistente para ampliar alcance e engajamento.`;
      }

      posts.sort((a,b)=> (a.dateISO<b.dateISO?-1:a.dateISO>b.dateISO?1:0));

      relatorioPostsGrid.innerHTML = posts.map(p=>{
        const firstMedia = p.mediaUrls?.[0] || "";
        const ext = firstMedia.split("?")[0].split(".").pop().toLowerCase();
        const isVideo = ["mp4","mov","webm","m4v","avi"].includes(ext);

        let cls = "relatorio-story-item"; // reaproveita estilos
        if(p.status === "aprovado"){
          cls += p.approvedBy === 'interno' ? " aprovado-interno" : " aprovado";
        }else if(p.status === "revisar"){
          cls += " revisar";
        }else{
          cls += " pendente";
        }
        if(isVideo) cls += " video";

        const [y,m,d] = (p.dateISO||'').split('-');
        const dateLabel = d && m ? `${d}/${m}` : '';

        const hasCustomCover = p.thumbUrl && !/\.(mp4|mov|webm|m4v|avi)(\?|$)/i.test(p.thumbUrl);
        if(isVideo){
          if(hasCustomCover){
            return `
              <div class="${cls}" data-id="${p.id}">
                <img src="${p.thumbUrl}" alt="Post ${dateLabel}" crossorigin="anonymous">
                <div class="relatorio-story-status"></div>
                <div class="relatorio-story-date">${dateLabel}</div>
              </div>
            `;
          }
          if(firstMedia){
            return `
              <div class="${cls}" data-id="${p.id}" data-video-url="${firstMedia}">
                <span>V</span>
                <div class="relatorio-story-status"></div>
                <div class="relatorio-story-date">${dateLabel}</div>
              </div>
            `;
          }
        }
        const imgSrc = p.thumbUrl || firstMedia;
        if(imgSrc){
          return `
            <div class="${cls}" data-id="${p.id}">
              <img src="${imgSrc}" alt="Post ${dateLabel}" crossorigin="anonymous">
              <div class="relatorio-story-status"></div>
              <div class="relatorio-story-date">${dateLabel}</div>
            </div>
          `;
        }
        return `
          <div class="${cls}" data-id="${p.id}">
            <div class="relatorio-story-status"></div>
            <div class="relatorio-story-date">${dateLabel}</div>
          </div>
        `;
      }).join("");

      relatorioPostsGrid.querySelectorAll('.relatorio-story-item').forEach(el=>{
        el.addEventListener('click', ()=>{
          const id = el.getAttribute('data-id');
          const post = POSTS.find(p=>p.id===id);
          if(post && typeof openPostModal === 'function') openPostModal(post);
        });
      });
      // Agendar gera√ß√£o das thumbnails de v√≠deo
      setTimeout(() => { try{ applyVideoThumbnails(); }catch(_e){ try{ window.applyVideoThumbnails && window.applyVideoThumbnails(); }catch(__){} } }, 120);
    }

    function mapDemandaToStatusKey(status){
      const s = (status||'').toLowerCase();
      if(s === 'concluido' || s === 'concluido-grupo') return 'concluido';
      if(s === 'em-andamento' || s === 'bloqueado' || s === 'prioridade' || s==='prioridade-grupo') return 'em-andamento';
      return 'nao-iniciado';
    }

    let currentGoalsFilter = '';
    function filterGoals(key){
      currentGoalsFilter = (key||'');
      const cols = document.querySelectorAll('#relatorioGoalsColumns .goals-col');
      cols.forEach(col=>{
        const st = col.getAttribute('data-status');
        col.style.display = (!currentGoalsFilter || currentGoalsFilter===st) ? 'block':'none';
      });
    }

    function renderRelatorioGoals(mesISO){
      if(!relatorioGoalsSection) return;
      const [ano, mes] = (mesISO||'').split('-');
      const monthKey = `${ano}-${mes}`;
      const list = Array.isArray(DEMANDAS) ? DEMANDAS : [];
      const inMonth = list.filter(d=> {
        try{ return Array.isArray(getDemandMonthKeys(d)) && getDemandMonthKeys(d).includes(monthKey); }catch(_){ return false; }
      });
      // Sempre mostrar a se√ß√£o para exibir o bloco de notas, mesmo sem objetivos
      relatorioGoalsSection.style.display='block';

      const groups = { 'concluido':[], 'em-andamento':[], 'nao-iniciado':[] };
      inMonth.forEach(d=>{ groups[mapDemandaToStatusKey(d.status)].push(d); });

      const meses = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
      const mesNome = meses[(parseInt(mes)||1)-1] || mes;
      if(relatorioGoalsSubtitle){
        relatorioGoalsSubtitle.textContent = `Resumo de ${inMonth.length} objetivo${inMonth.length===1?'':'s'} em ${mesNome} de ${ano}`;
      }
  if(relatorioGoalsDonePill) relatorioGoalsDonePill.querySelector('strong').textContent = groups['concluido'].length;
  if(relatorioGoalsProgressPill) relatorioGoalsProgressPill.querySelector('strong').textContent = groups['em-andamento'].length;
  if(relatorioGoalsTodoPill) relatorioGoalsTodoPill.querySelector('strong').textContent = groups['nao-iniciado'].length;

      // Descri√ß√£o resumida abaixo do bloco
      if(relatorioGoalsDesc){
        const total = inMonth.length;
        const concl = groups['concluido'].length;
        const prog = groups['em-andamento'].length;
        const nao = groups['nao-iniciado'].length;
        const rate = total>0 ? Math.round((concl/total)*100) : 0;
        relatorioGoalsDesc.textContent = total>0
          ? `üöÄ ${mesNome} de ${ano}: ${total} objetivo${total===1?'':'s'} ‚Äî Conclu√≠dos: ${concl} (${rate}%), Em andamento: ${prog}, N√£o iniciados: ${nao}. Foco em entregas com impacto direto na percep√ß√£o da marca.`
          : `Sem objetivos cadastrados para ${mesNome} de ${ano}. Que tal definirmos 2‚Äì3 prioridades estrat√©gicas para o pr√≥ximo ciclo?`;
      }

      const renderCard = (d)=>{
        const title = (d.demanda||'').trim() || '(Sem t√≠tulo)';
        const resp = (d.responsavel||'').trim();
        const end = getDemandaEndDate(d);
        const date = end ? end.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'}) : '';
        const tag = (Array.isArray(d.tags) ? d.tags[0] : (d.tag||'')).toString();
        const statusKey = mapDemandaToStatusKey(d.status);
        const statusLabel = (STATUS_OPTIONS.find(o=>o.value===d.status)?.label) || '';
        return `<div class="goal-card ${statusKey}" data-id="${d.id||''}">
          <div class="goal-title">${escapeHtml(title)}</div>
          <div class="goal-meta">
            ${resp?`<span class="goal-tag">üë§ ${escapeHtml(resp)}</span>`:''}
            ${date?`<span class="goal-tag">üìÖ ${date}</span>`:''}
            ${statusLabel?`<span class="goal-tag">${escapeHtml(statusLabel)}</span>`:''}
            ${tag?`<span class="goal-tag">üè∑Ô∏è ${escapeHtml(tag)}</span>`:''}
          </div>
        </div>`;
      };

      if(relatorioGoalsDone) relatorioGoalsDone.innerHTML = groups['concluido'].sort((a,b)=> (getDemandaEndDate(a)?.getTime()||0)-(getDemandaEndDate(b)?.getTime()||0)).map(renderCard).join('');
      if(relatorioGoalsProgress) relatorioGoalsProgress.innerHTML = groups['em-andamento'].sort((a,b)=> (getDemandaEndDate(a)?.getTime()||0)-(getDemandaEndDate(b)?.getTime()||0)).map(renderCard).join('');
      if(relatorioGoalsTodo) relatorioGoalsTodo.innerHTML = groups['nao-iniciado'].sort((a,b)=> (getDemandaEndDate(a)?.getTime()||0)-(getDemandaEndDate(b)?.getTime()||0)).map(renderCard).join('');

      // Se n√£o houver objetivos no m√™s, mostrar mensagem de vazio, mantendo o bloco de notas vis√≠vel
      if(inMonth.length === 0){
        if(relatorioGoalsSubtitle){
          relatorioGoalsSubtitle.textContent = `Sem objetivos encontrados para ${mesNome} de ${ano}`;
        }
      }

      const bindClicks = (root)=>{
        if(!root) return; 
        root.querySelectorAll('.goal-card').forEach(el=>{
          if(el.dataset.bound==='1') return; el.dataset.bound='1';
          el.addEventListener('click', ()=>{ try{ setActiveTab('demandas'); }catch(_err){} });
        });
      };
      bindClicks(relatorioGoalsDone);
      bindClicks(relatorioGoalsProgress);
      bindClicks(relatorioGoalsTodo);

      filterGoals(currentGoalsFilter);
    }
    
    function gerarRelatorio(){
      if(!relatorioMesInput || !relatorioMesInput.value){
        alert('Por favor, selecione um m√™s');
        return;
      }
      
      const mesISO = relatorioMesInput.value;
  renderRelatorioStories(mesISO);
  renderRelatorioPosts(mesISO);
  renderRelatorioGoals(mesISO);
  renderRelatorioMetas(mesISO);
  loadRelatorioGoalsNoteLocal(mesISO);
  renderRelatorioRedes(mesISO);
  
      
      if(relatorioPreview){
        const [ano, mes] = mesISO.split('-');
        const meses = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
        const mesNome = meses[parseInt(mes)-1] || mes;
        relatorioPreview.classList.add('has-meta');
        relatorioPreview.innerHTML = `
          <div class="relatorio-preview-meta">
            <span class="meta-item">üìÖ ${mesNome} ${ano}</span>
            <span class="meta-sep">‚Ä¢</span>
            <span class="meta-item ok">‚úÖ Relat√≥rio gerado</span>
            <span class="meta-sep">‚Ä¢</span>
            <button id="copyRelatorioLinkBtn" type="button" class="btn ghost small" title="Copiar link do relat√≥rio para compartilhar">üîó Copiar link</button>
          </div>
        `;

        // bot√£o: copiar link do relat√≥rio (gera link p√∫blico por token)
        const btn = relatorioPreview.querySelector('#copyRelatorioLinkBtn');
        btn?.addEventListener('click', async ()=>{
          let url = '';
          try{
            const token = await createOrUpdateReportShare(mesISO);
            url = buildRelatorioShareUrl(mesISO, token);
            const clip = navigator.clipboard;
            if(clip?.writeText){
              await clip.writeText(url);
              alert('Link do relat√≥rio copiado! (acesso p√∫blico)');
              return;
            }
            throw new Error('Clipboard API indispon√≠vel');
          }catch(_err){
            // fallback manual
            url = url || buildRelatorioShareUrl(mesISO);
            try{
              const ta = document.createElement('textarea');
              ta.value = url; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
              alert('Link do relat√≥rio copiado! (acesso p√∫blico)');
            }catch(_){
              prompt('Copie o link do relat√≥rio:', url);
            }
          }
        });
      }
    }

    let currentMetasFilter = '';
    function filterMetas(key){
      currentMetasFilter = (key||'');
      const cols = document.querySelectorAll('#relatorioMetasColumns .goals-col');
      cols.forEach(col=>{
        const st = col.getAttribute('data-status');
        col.style.display = (!currentMetasFilter || currentMetasFilter===st) ? 'block':'none';
      });
    }

    function getMetaMonthKeyFromISO(mesISO){
      if(!mesISO) return META_MONTHS[new Date().getMonth()];
      const parts = mesISO.split('-');
      if(parts.length<2) return META_MONTHS[new Date().getMonth()];
      const idx = Math.min(Math.max(parseInt(parts[1],10)-1,0),11);
      return META_MONTHS[idx];
    }

    // Gera a URL compartilh√°vel do relat√≥rio para o m√™s selecionado
    // Se token for informado, gera link p√∫blico (?share=token)
    function buildRelatorioShareUrl(mesISO, token){
      try{
        const pageUrl = new URL('relatorio.html', location.href);
        const mes = (mesISO && mesISO.length>=7) ? mesISO : (relatorioMesInput?.value || new Date().toISOString().slice(0,7));
        const tenant = getClientKey();
        if(token){
          pageUrl.searchParams.set('share', token);
          // extras amig√°veis (n√£o usados para auth, s√≥ r√≥tulo)
          if(tenant){ pageUrl.searchParams.set('tenant', tenant); }
          pageUrl.searchParams.set('mes', mes);
        } else {
          if(tenant){ pageUrl.searchParams.set('tenant', tenant); }
          pageUrl.searchParams.set('mes', mes);
        }
        return pageUrl.toString();
      }catch(_){
        // Fallback simples
        const base = location.origin + location.pathname.replace(/index\.html?$/i,'');
        const mes = encodeURIComponent((mesISO && mesISO.length>=7) ? mesISO : (relatorioMesInput?.value || new Date().toISOString().slice(0,7)));
        const tenant = encodeURIComponent(getClientKey()||'');
        return token
          ? `${base}relatorio.html?share=${encodeURIComponent(token)}&tenant=${tenant}&mes=${mes}`
          : `${base}relatorio.html?tenant=${tenant}&mes=${mes}`;
      }
    }

    // Monta snapshot dos dados do relat√≥rio do m√™s (para link p√∫blico)
    function buildMonthlyReportData(mesISO){
      const clientKey = getClientKey();
      const [ano, mm] = (mesISO||'').split('-');
      const labelMonth = (()=>{
        const meses = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
        const idx = Math.max(0, Math.min(11, (parseInt(mm,10)||1)-1));
        return `${meses[idx]} ${ano||''}`.trim();
      })();
      // metas
      const monthKey = getMetaMonthKeyFromISO(mesISO);
      const metasActive = Array.isArray(METAS) ? METAS.filter(m=>m && m.ativo!==false) : [];
      const metas = metasActive.map(m=>{
        const cur = (m.meses && m.meses[monthKey]) || {p:'',r:''};
        const planned = normalizeMetaNumber(cur.p ?? cur.P);
        const realized = normalizeMetaNumber(cur.r ?? cur.R);
        const status = evaluateMetaGoal(planned, realized, m.direcao);
        return {
          descricao: (m.descricao||'').toString(),
          unidade: m.unidade||'',
          direcao: m.direcao||'up',
          planned, realized, status
        };
      });
      // posts
      const tenant = clientKey;
      const relevantPosts = filterPostsByClient(Array.isArray(POSTS)?POSTS:[], tenant)
        .filter(p=> String(p.dateISO||'').startsWith(mesISO))
        .sort((a,b)=> String(a.dateISO||'').localeCompare(String(b.dateISO||'')));
      const posts = relevantPosts.map(p=>({
        id: p.id||'',
        dateISO: p.dateISO||'',
        type: p.type||'',
        target: (p.target||'feed'),
        desc: p.desc||'',
        status: p.status||'',
        approvedBy: p.approvedBy||'',
        thumbUrl: p.thumbUrl||'',
        mediaUrls: Array.isArray(p.mediaUrls) ? p.mediaUrls.slice(0, 4) : []
      }));
      // objetivos do m√™s (Planejamento)
      let goals = null;
      try{
        const [ano, mm2] = (mesISO||'').split('-');
        const monthKey = `${ano}-${mm2}`;
        const list = Array.isArray(DEMANDAS) ? DEMANDAS : [];
        const inMonth = list.filter(d=>{
          try{ return Array.isArray(getDemandMonthKeys(d)) && getDemandMonthKeys(d).includes(monthKey); }catch(_){ return false; }
        });
        const groups = { 'concluido':[], 'em-andamento':[], 'nao-iniciado':[] };
        inMonth.forEach(d=>{ const key = (typeof mapDemandaToStatusKey==='function') ? mapDemandaToStatusKey(d.status) : ((d.status||'').toLowerCase()==='concluido'?'concluido':((d.status||'').toLowerCase()==='em-andamento'?'em-andamento':'nao-iniciado')); groups[key].push(d); });
        const toItem = (d)=>{
          const endDate = (function(){ try{ const dt = getDemandaEndDate(d); if(dt && !isNaN(dt)) return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`; }catch(_){ } return ''; })();
          const tag = Array.isArray(d.tags) ? (d.tags[0]||'') : (d.tag||'');
          return { id: d.id||'', title: (d.demanda||'').toString(), responsavel: d.responsavel||'', status: d.status||'', tag: tag||'', endDate };
        };
        goals = {
          summary: {
            total: inMonth.length,
            done: groups['concluido'].length,
            progress: groups['em-andamento'].length,
            todo: groups['nao-iniciado'].length
          },
          items: inMonth.map(toItem)
        };
      }catch(_){ goals = null; }
      // notes
      const notes = [];
      try{
        const map = CAL_NOTES && typeof CAL_NOTES==='object' ? CAL_NOTES : {};
        Object.keys(map).forEach(k=>{ if(String(k).startsWith(mesISO)){ const txt = map[k]; if(txt){ notes.push({ id:k, text: String(txt) }); } }});
        notes.sort((a,b)=> String(a.id).localeCompare(String(b.id)));
      }catch(_){ }
      // social links + snapshot dos √≠cones exibidos no header
      const linksObj = (typeof SOCIAL_LINKS==='object' && SOCIAL_LINKS) ? SOCIAL_LINKS : {};
      const socialLinks = Object.fromEntries(Object.entries(linksObj).filter(([,v])=> !!v));
      let social = [];
      try{
        if(typeof collectHeaderSocialItems === 'function'){
          const items = collectHeaderSocialItems();
          social = (Array.isArray(items)?items:[])
            .filter(i=> i && i.hasLink && i.href)
            .map(i=> ({ label: i.label||'', href: i.href||'', iconInfo: i.iconInfo||null }));
        }
      }catch(_err){ /* fallback para socialLinks */ }
      return { monthKey: mesISO, labelMonth, tenant, metas, posts, notes, socialLinks, social, goals };
    }

    // Cria/atualiza um documento de compartilhamento p√∫blico e retorna o token
    async function createOrUpdateReportShare(mesISO){
      await requireAuthUser();
      const uid = getUserKey();
      if(!uid) throw new Error('Usu√°rio n√£o autenticado');
      const data = buildMonthlyReportData(mesISO);
      // token aleat√≥rio (curto) base36
      const token = (Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2)).slice(0,20);
      const payload = {
        token,
        uid,
        monthKey: data.monthKey,
        tenant: data.tenant || null,
        createdAt: Date.now(),
        payload: data
      };
      try{
        const ref = doc(db, 'reportShares', token);
        await setDoc(ref, payload);
      }catch(err){ console.warn('createOrUpdateReportShare', err); throw err; }
      return token;
    }

    // Notas simples locais (Objetivos do m√™s)
    function getClientKeyLocal(){
      return (typeof window.TENANT === 'string' && window.TENANT) || document.body.getAttribute('data-client-id') || 'default';
    }
    function goalsNoteKey(mesISO){
      const id = (mesISO && mesISO.length>=7) ? mesISO : (new Date().toISOString().slice(0,7));
      return `relatorio_goals_note_${getClientKeyLocal()}_${id}`;
    }
    function loadRelatorioGoalsNoteLocal(mesISO){
      try{
        if(!relatorioGoalsNotesSimple) return;
        const key = goalsNoteKey(mesISO);
        const saved = localStorage.getItem(key) || '';
        relatorioGoalsNotesSimple.value = saved;
        if(relatorioGoalsNotesSimpleStatus){
          relatorioGoalsNotesSimpleStatus.textContent = saved ? 'Auto-salvo neste navegador.' : '';
        }
      }catch(_err){}
    }
    function saveRelatorioGoalsNoteLocal(){
      try{
        if(!relatorioMesInput || !relatorioMesInput.value || !relatorioGoalsNotesSimple) return;
        const key = goalsNoteKey(relatorioMesInput.value);
        localStorage.setItem(key, relatorioGoalsNotesSimple.value || '');
        if(relatorioGoalsNotesSimpleStatus){
          const now = new Date();
          const hora = now.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
          relatorioGoalsNotesSimpleStatus.textContent = `Auto-salvo √†s ${hora}`;
        }
      }catch(_err){}
    }

    function renderRelatorioMetas(mesISO){
      if(!relatorioMetasSection) return;
      const monthKey = getMetaMonthKeyFromISO(mesISO);
      const activeMetas = Array.isArray(METAS) ? METAS.filter(meta => meta && meta.ativo !== false) : [];
      const groups = { achieved:[], progress:[], missing:[] };
      activeMetas.forEach(meta=>{
        const current = (meta.meses && meta.meses[monthKey]) || {p:'',r:''};
        const planned = normalizeMetaNumber(current.p ?? current.P);
        const realized = normalizeMetaNumber(current.r ?? current.R);
        const status = evaluateMetaGoal(planned, realized, meta.direcao);
        if(status === 'achieved') groups.achieved.push({meta, planned, realized});
        else if(status === 'missing') groups.missing.push({meta, planned, realized});
        else groups.progress.push({meta, planned, realized});
      });

      const total = activeMetas.length;
      if(total === 0){ relatorioMetasSection.style.display='none'; return; }
      relatorioMetasSection.style.display='block';

      const labelMonth = META_MONTH_LABELS[monthKey] || monthKey.toUpperCase();
      if(relatorioMetasSubtitle){ relatorioMetasSubtitle.textContent = `Metas ativas: ${total} ‚Ä¢ ${labelMonth}`; }
      if(relatorioMetasAchievedPill) relatorioMetasAchievedPill.querySelector('strong').textContent = groups.achieved.length;
      if(relatorioMetasProgressPill) relatorioMetasProgressPill.querySelector('strong').textContent = groups.progress.length;
      if(relatorioMetasMissingPill) relatorioMetasMissingPill.querySelector('strong').textContent = groups.missing.length;

      // Descri√ß√£o resumida abaixo do bloco
      if(relatorioMetasDesc){
        const a = groups.achieved.length, p = groups.progress.length, m = groups.missing.length;
        const rate = total>0 ? Math.round((a/total)*100) : 0;
        relatorioMetasDesc.textContent = `üéØ ${labelMonth}: ${total} meta${total===1?'':'s'} ativa${total===1?'':'s'} ‚Äî Atingidas: ${a} (${rate}%), Em andamento: ${p}, Precisa colocar: ${m}. Excelente sinal de alinhamento entre planejamento e execu√ß√£o.`;
      }

      const renderMetaCard = (item)=>{
        const m = item.meta;
        const title = (m.descricao||'').trim() || '(Meta sem t√≠tulo)';
        const unidade = m.unidade || '';
        const plannedLabel = formatMetaDisplay(item.planned, unidade);
        const realizedLabel = formatMetaDisplay(item.realized, unidade);
        return `<div class="goal-card" data-id="${m.id}">
          <div class="goal-title">${escapeHtml(title)}</div>
          <div class="goal-meta">
            <span class="goal-tag">üéØ Meta: ${escapeHtml(plannedLabel)}</span>
            <span class="goal-tag">üìà Realizado: ${escapeHtml(realizedLabel)}</span>
            ${m.setor?`<span class="goal-tag">üè¢ ${escapeHtml(m.setor)}</span>`:''}
          </div>
        </div>`;
      };

      if(relatorioMetasAchieved) relatorioMetasAchieved.innerHTML = groups.achieved.map(renderMetaCard).join('');
      if(relatorioMetasProgress) relatorioMetasProgress.innerHTML = groups.progress.map(renderMetaCard).join('');
      if(relatorioMetasMissing) relatorioMetasMissing.innerHTML = groups.missing.map(renderMetaCard).join('');

      const bindClicks = (root)=>{
        if(!root) return; 
        root.querySelectorAll('.goal-card').forEach(el=>{
          if(el.dataset.bound==='1') return; el.dataset.bound='1';
          el.addEventListener('click', ()=>{ try{ setActiveTab('metas'); }catch(_err){} });
        });
      };
      bindClicks(relatorioMetasAchieved);
      bindClicks(relatorioMetasProgress);
      bindClicks(relatorioMetasMissing);

      filterMetas(currentMetasFilter);
    }
    
    // Relat√≥rio: Redes trabalhadas (lista apenas redes com link configurado)
    function renderRelatorioRedes(mesISO){
      // mesISO n√£o altera os links, mas mant√©m consist√™ncia com as demais se√ß√µes
      if(!relatorioRedesSection || !relatorioRedesGrid) return;
      const items = collectHeaderSocialItems();
      const connected = items.filter(i=> i && i.hasLink && i.href);
      if(connected.length === 0){
        relatorioRedesSection.style.display = 'none';
        return;
      }
      relatorioRedesSection.style.display = 'block';
      // Subt√≠tulo e descri√ß√£o
      if(relatorioRedesSubtitle){
        relatorioRedesSubtitle.textContent = 'Redes conectadas no cliente (clique para acessar)';
      }
      if(relatorioRedesDesc){
        relatorioRedesDesc.textContent = `üìå ${connected.length} rede${connected.length===1?'':'s'} com link configurado${mesISO?` ‚Äî relat√≥rio de ${mesISO}`:''}. Mostrando apenas o que est√° ativo e pronto para uso.`;
      }
      // Monta os cards (reaproveitando os estilos de macro-social-item)
      const frag = document.createDocumentFragment();
      connected.forEach(item=>{
        const card = document.createElement('div');
        card.className = 'macro-social-item';

        const icon = document.createElement('div');
        icon.className = 'macro-social-icon';
        if(item.iconInfo?.type === 'img' && item.iconInfo.src){
          const img = document.createElement('img');
          img.src = item.iconInfo.src;
          img.alt = item.iconInfo.alt || item.label || '';
          icon.appendChild(img);
        }else if(item.iconInfo?.type === 'text' && item.iconInfo.text){
          icon.textContent = item.iconInfo.text;
          if(item.iconInfo.fontSize){ icon.style.fontSize = item.iconInfo.fontSize; }
        }

        const info = document.createElement('div');
        info.className = 'macro-social-info';
        const labelEl = document.createElement('span');
        labelEl.className = 'macro-social-label';
        labelEl.textContent = item.label || 'Rede social';
        const detailEl = document.createElement('span');
        detailEl.className = 'macro-social-detail';
        detailEl.textContent = 'Link conectado';
        info.append(labelEl, detailEl);

        const actions = document.createElement('div');
        actions.className = 'macro-social-actions';
        const openBtn = document.createElement('button');
        openBtn.type = 'button';
        openBtn.className = 'macro-social-open';
        openBtn.textContent = 'Abrir';
        openBtn.addEventListener('click', ()=>{
          try{
            const win = window.open(item.href, '_blank');
            if(win){ win.opener = null; } else { window.location.href = item.href; }
          }catch(_){ window.location.href = item.href; }
        });
        actions.appendChild(openBtn);

        card.append(icon, info, actions);
        frag.appendChild(card);
      });
      relatorioRedesGrid.replaceChildren(frag);
    }
    
    function exportarRelatorioPDF(){
      if(!relatorioMesInput || !relatorioMesInput.value){
        alert('Por favor, gere um relat√≥rio primeiro');
        return;
      }
      alert('Funcionalidade de exporta√ß√£o em PDF ser√° implementada em breve!');
    }

    

    /* ========= arquivos ========= */
    const normalizeParent = (value)=> (value===undefined || value===null || value==='') ? null : value;
    const folderCollator = new Intl.Collator('pt-BR', { sensitivity: 'base', numeric: true });
    let FOLDERS = [];
    const DEFAULT_STORAGE_LIMIT_BYTES = 5 * 1024 * 1024 * 1024;
    let storageUsageBytes = 0;
    let storageUsageCount = 0;
    let storageUsageLoading = false;
    let storageUsageFetchToken = 0;
    let storageLimitBytes = null;
    let storageLimitSource = null;
    const STORAGE_METADATA_TTL = 5 * 60 * 1000;
    const storageMetadataCache = new Map();
    const storageMetadataPending = new Map();
    let storageUsageBreakdown = {
      files: 0,
      calendarMedia: 0,
      calendarNotes: 0,
      references: 0,
      notes: 0
    };
    const textEncoder = typeof TextEncoder !== 'undefined' ? new TextEncoder() : null;
    let currentFolder = null;
    let CURRENT_FILES = [];
    let SELECTED_FILES = new Set();
    let LAST_SELECTED_INDEX = null;
    let BULK_ACTION_RUNNING = false;
    let LAST_BULK_SHIFT = false;
    let LAST_UNDO_ACTION = null;
    let BULK_STATUS_MESSAGE = '';
    const uploadingObjectUrls = new Map();
    let FILES_UPLOAD_ACTIVE = false;
    let viewingAllFiles = false;
    let lastSelectedFolder = null;
    const ALL_FILES_CRUMB_ID = '__all__';
    const FILES_VIEW_STORAGE_KEY = 'mg_files_view_mode';
    let FILES_VIEW_MODE = 'list';
    try{
      const storedView = localStorage.getItem(FILES_VIEW_STORAGE_KEY);
      if(storedView === 'grid' || storedView === 'list'){
        FILES_VIEW_MODE = storedView;
      }
    }catch(_){ }
    const IMAGE_EXTS = ['png','jpg','jpeg','gif','bmp','webp','svg','heic','heif','tiff','tif','avif'];
    const VIDEO_EXTS = ['mp4','mov','wmv','mkv','avi','flv','webm','mpeg','mpg','m4v','3gp'];
    const DEFAULT_ROOT_FOLDERS = [
      'üß† ESTRAT√âGIA & RELAT√ìRIOS',
      'üé® IDENTIDADE & MATERIAIS',
      'üì∏ CONTE√öDO & REDES SOCIAIS',
      'üöÄ TR√ÅFEGO & GOOGLE',
      'üìÑ DOCUMENTOS & CONTRATOS',
      'üí° INSPIRA√á√ïES'
    ];
    function normalizeDefaultFolderName(name){
      let base = (name || '').toString().trim().toLowerCase();
      try{
        base = base.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      }catch(_){ }
      return base;
    }
    async function ensureDefaultRootFolders(uid, clientKey, existingFolders, colRef){
      if(!uid || !clientKey) return [];
      const current = Array.isArray(existingFolders) ? existingFolders : [];
      const existingNames = new Set(
        current
          .filter(folder=> !normalizeParent(folder.parentId))
          .map(folder=> normalizeDefaultFolderName(folder.name))
      );
      const missing = DEFAULT_ROOT_FOLDERS.filter(name=> !existingNames.has(normalizeDefaultFolderName(name)));
      if(!missing.length) return [];
      const col = colRef || collection(db, 'usuarios', uid, 'clients', clientKey, 'fileFolders');
      const created = [];
      for(const name of missing){
        try{
          const createdAt = Date.now();
          const docRef = await addDoc(col, { name, parentId: null, createdAt });
          created.push({ id: docRef.id, name, parentId: null, createdAt });
        }catch(err){
          console.warn('ensureDefaultRootFolders', err);
        }
      }
      return created;
    }

    function normalizeTenantKey(value){
      if(!value) return null;
      return value.replace(/[^\w-]/g, '_');
    }

    function extractStoragePath(raw){
      if(!raw) return null;
      if(typeof raw !== 'string') return null;
      if(raw.startsWith('http')){
        try{
          const url = new URL(raw);
          const match = url.pathname.match(/\/o\/([^?]+)/);
          if(match && match[1]){
            return decodeURIComponent(match[1]);
          }
        }catch(_){ }
        return null;
      }
      return raw;
    }

    async function getStorageObjectSize(path){
      if(!path) return null;
      const now = Date.now();
      const cached = storageMetadataCache.get(path);
      if(cached && (now - cached.ts) < STORAGE_METADATA_TTL){
        return cached.size;
      }
      if(storageMetadataPending.has(path)){
        try{
          const size = await storageMetadataPending.get(path);
          return size;
        }catch(_){
          return null;
        }
      }
      const promise = (async ()=>{
        try{
          if(!STORAGE){
            STORAGE = getStorage(app);
          }
        }catch(err){
          console.warn('getStorageObjectSize init', err);
          return null;
        }
        try{
          const metadata = await getMetadata(sRef(STORAGE, path));
          const sizeValue = Number(metadata?.size);
          const size = Number.isFinite(sizeValue) && sizeValue > 0 ? sizeValue : 0;
          storageMetadataCache.set(path, { size, ts: Date.now() });
          return size;
        }catch(err){
          storageMetadataCache.set(path, { size: null, ts: Date.now(), error: true });
          console.warn('getStorageObjectSize', path, err);
          return null;
        }
      })();
      storageMetadataPending.set(path, promise);
      try{
        const size = await promise;
        return size;
      }finally{
        storageMetadataPending.delete(path);
      }
    }

    function estimateObjectBytes(value){
      if(!textEncoder) return 0;
      try{
        if(typeof value === 'string'){
          return textEncoder.encode(value).length;
        }
        if(value && typeof value === 'object'){
          return textEncoder.encode(JSON.stringify(value)).length;
        }
      }catch(err){
        console.warn('estimateObjectBytes', err);
      }
      return 0;
    }

    function filterPostsByClient(posts, clientKey){
      if(!Array.isArray(posts)) return [];
      const safeKey = normalizeTenantKey(clientKey);
      if(!safeKey) return posts.slice();
      return posts.filter(post=>{
        const tenant = post?.tenant || '';
        if(!tenant) return true;
        return tenant === safeKey || tenant === clientKey;
      });
    }

    async function computeCalendarStorageUsage(clientKey){
      const relevantPosts = filterPostsByClient(Array.isArray(POSTS) ? POSTS : [], clientKey);
      const pathMap = new Map();
      relevantPosts.forEach(post=>{
        const mediaMeta = Array.isArray(post?.mediaMeta) ? post.mediaMeta : [];
        const metaByPath = new Map();
        mediaMeta.forEach(meta=>{
          const metaPath = extractStoragePath(meta?.path || meta?.url);
          if(!metaPath) return;
          const sizeValue = Number(meta?.size);
          const knownSize = Number.isFinite(sizeValue) && sizeValue > 0 ? sizeValue : null;
          if(!metaByPath.has(metaPath) || (knownSize && !metaByPath.get(metaPath))){
            metaByPath.set(metaPath, knownSize);
          }
        });
        (Array.isArray(post?.mediaUrls) ? post.mediaUrls : []).forEach((url, index)=>{
          const path = extractStoragePath(url);
          if(!path) return;
          let knownSize = null;
          const meta = mediaMeta[index];
          if(meta){
            const metaSize = Number(meta.size);
            if(Number.isFinite(metaSize) && metaSize > 0){
              knownSize = metaSize;
            } else if(meta.path){
              const cached = metaByPath.get(meta.path);
              if(cached) knownSize = cached;
            }
          } else if(metaByPath.has(path)){
            knownSize = metaByPath.get(path);
          }
          if(!pathMap.has(path) || (knownSize && !pathMap.get(path))){
            pathMap.set(path, knownSize);
          }
        });
        const coverMeta = post?.coverMeta && typeof post.coverMeta === 'object' ? post.coverMeta : null;
        if(coverMeta){
          const coverPath = extractStoragePath(coverMeta.path || coverMeta.url || post.thumbUrl);
          if(coverPath){
            const coverSize = Number(coverMeta.size);
            const knownSize = Number.isFinite(coverSize) && coverSize > 0 ? coverSize : null;
            if(!pathMap.has(coverPath) || (knownSize && !pathMap.get(coverPath))){
              pathMap.set(coverPath, knownSize);
            }
          }
        }
        const thumbPath = extractStoragePath(post?.thumbUrl);
        if(thumbPath && !pathMap.has(thumbPath)){
          pathMap.set(thumbPath, null);
        }
      });

      const mediaResults = await Promise.all(Array.from(pathMap.entries()).map(async ([path, knownSize])=>{
        if(Number.isFinite(knownSize) && knownSize > 0){
          return { path, size: knownSize };
        }
        const size = await getStorageObjectSize(path);
        return { path, size };
      }));

      let mediaBytes = 0;
      mediaResults.forEach(({ size })=>{
        if(Number.isFinite(size) && size > 0){
          mediaBytes += size;
        }
      });
      const mediaCount = pathMap.size;

      const calendarNotes = CAL_NOTES && typeof CAL_NOTES === 'object' ? CAL_NOTES : {};
      const notesBytes = estimateObjectBytes(calendarNotes);
      const notesCount = Object.keys(calendarNotes).length;

      return {
        mediaBytes,
        mediaCount,
        notesBytes,
        notesCount,
        bytes: mediaBytes + notesBytes,
        count: mediaCount + notesCount
      };
    }

    async function computeRefSocialStorageUsage(){
      const items = Array.isArray(REF_SOCIAL) ? REF_SOCIAL : [];
      const pathMap = new Map();
      items.forEach(item=>{
        const isUpload = (item?.sourceType || item?.type) === 'upload';
        if(!isUpload) return;
        const path = extractStoragePath(item?.path || item?.storagePath || item?.url);
        if(!path) return;
        const sizeValue = Number(item?.size);
        const knownSize = Number.isFinite(sizeValue) && sizeValue > 0 ? sizeValue : null;
        if(!pathMap.has(path) || (knownSize && !pathMap.get(path))){
          pathMap.set(path, knownSize);
        }
      });
      const results = await Promise.all(Array.from(pathMap.entries()).map(async ([path, knownSize])=>{
        if(Number.isFinite(knownSize) && knownSize > 0){
          return { path, size: knownSize };
        }
        const size = await getStorageObjectSize(path);
        return { path, size };
      }));
      let bytes = 0;
      results.forEach(({ size })=>{
        if(Number.isFinite(size) && size > 0){
          bytes += size;
        }
      });
      const count = pathMap.size;
      return { bytes, count };
    }

    function computeNotesStorageUsage(){
      const notesArray = Array.isArray(NOTES) ? NOTES : [];
      const bytes = estimateObjectBytes(notesArray);
      return { bytes, count: notesArray.length };
    }

    function escapeHtml(value){
      return String(value ?? '')
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    const escapeAttr = escapeHtml;

    function getFileExt(name){
      return String(name||'').split('.').pop().toLowerCase();
    }

    function isImageFile(file){
      const type = String(file?.contentType||'');
      if(type.startsWith('image/')) return true;
      return IMAGE_EXTS.includes(getFileExt(file?.name));
    }

    function isVideoFile(file){
      const type = String(file?.contentType||'');
      if(type.startsWith('video/')) return true;
      return VIDEO_EXTS.includes(getFileExt(file?.name));
    }

    const sizeUnits = ['B','KB','MB','GB','TB'];
    function formatFileSize(raw){
      if(raw === null || raw === undefined) return '--';
      const size = Number(raw);
      if(!Number.isFinite(size) || size < 0){
        return '--';
      }
      if(size === 0){
        return '0 B';
      }
      let value = size;
      let unitIndex = 0;
      while(value >= 1024 && unitIndex < sizeUnits.length - 1){
        value /= 1024;
        unitIndex++;
      }
      const digits = value >= 10 || unitIndex === 0 ? 0 : 1;
      return `${value.toFixed(digits)} ${sizeUnits[unitIndex]}`;
    }

    function toPositiveNumber(raw){
      if(raw === null || raw === undefined) return null;
      if(typeof raw === 'number'){
        return Number.isFinite(raw) && raw > 0 ? raw : null;
      }
      if(typeof raw === 'string'){
        const cleaned = raw.replace(/[^0-9.,-]/g,'').replace(',', '.');
        if(!cleaned.trim()) return null;
        const num = Number(cleaned);
        return Number.isFinite(num) && num > 0 ? num : null;
      }
      return null;
    }

    function extractStorageLimitFromSource(source, sourceName){
      if(!source || typeof source !== 'object') return null;
      const bytesCandidates = [
        source.storageLimitBytes,
        source.storageUsageLimitBytes,
        source.storageQuotaBytes,
        source.storageQuota,
        source.storageLimit
      ];
      for(const candidate of bytesCandidates){
        const parsed = toPositiveNumber(candidate);
        if(parsed) return { bytes: parsed, source: sourceName };
      }
      const gbCandidates = [
        source.storageLimitGb,
        source.storageLimitGB,
        source.storageQuotaGb,
        source.storageQuotaGB
      ];
      for(const candidate of gbCandidates){
        const parsed = toPositiveNumber(candidate);
        if(parsed) return { bytes: parsed * 1024 * 1024 * 1024, source: sourceName };
      }
      const mbCandidates = [
        source.storageLimitMb,
        source.storageLimitMB,
        source.storageQuotaMb,
        source.storageQuotaMB
      ];
      for(const candidate of mbCandidates){
        const parsed = toPositiveNumber(candidate);
        if(parsed) return { bytes: parsed * 1024 * 1024, source: sourceName };
      }
      return null;
    }

    function syncStorageLimitFromProfile(){
      const clientLimit = extractStorageLimitFromSource(CLIENT_PROFILE, 'profile');
      const userLimit = extractStorageLimitFromSource(USER_DATA, 'user');
      const next = clientLimit || userLimit || null;
      const nextBytes = next ? next.bytes : null;
      const nextSource = next ? next.source : null;
      if(nextBytes !== storageLimitBytes || nextSource !== storageLimitSource){
        storageLimitBytes = nextBytes;
        storageLimitSource = nextSource;
        updateStorageUsageUI();
      }
    }

    const formatFileCount = (count)=>{
      const value = Number(count);
      if(!Number.isFinite(value) || value <= 0) return '0 itens';
      return value === 1 ? '1 item' : `${value} itens`;
    };

    function resetStorageUsageState(options = {}){
      const { loading = false } = options;
      storageUsageBytes = 0;
      storageUsageCount = 0;
      storageLimitBytes = null;
      storageLimitSource = null;
      storageUsageFetchToken++;
      storageUsageLoading = loading;
      updateStorageUsageUI();
    }

    function updateStorageUsageUI(){
      if(!storageUsage) return;
      const hasContext = !!(auth?.currentUser) && !!getClientKey();
      if(!hasContext){
        storageUsage.classList.add('hidden');
        storageUsage.removeAttribute('aria-busy');
        storageUsage.removeAttribute('data-level');
        if(storageUsagePercent) storageUsagePercent.textContent = '';
        if(storageUsageSummary) storageUsageSummary.textContent = '';
        if(storageUsageHint) storageUsageHint.textContent = '';
        if(storageUsageFill) storageUsageFill.style.width = '0%';
        return;
      }
      storageUsage.classList.remove('hidden');
      const breakdownLabel = 'Inclui arquivos, calend√°rio, refer√™ncias e notas.';
      if(storageUsageLoading){
        storageUsage.setAttribute('aria-busy','true');
        storageUsage.dataset.level = 'loading';
        if(storageUsagePercent) storageUsagePercent.textContent = '';
        if(storageUsageSummary) storageUsageSummary.textContent = 'Calculando uso...';
        if(storageUsageHint){
          const limitIsCustom = Number.isFinite(storageLimitBytes) && storageLimitBytes > 0;
          const effectiveLimit = limitIsCustom ? storageLimitBytes : DEFAULT_STORAGE_LIMIT_BYTES;
          const limitLabel = formatFileSize(effectiveLimit);
          const sourceLabel = storageLimitSource === 'user'
            ? 'Limite do usu√°rio'
            : storageLimitSource === 'profile'
              ? 'Limite do cliente'
              : 'Limite padr√£o';
          if(limitIsCustom){
            storageUsageHint.textContent = breakdownLabel ? `${sourceLabel}: ${limitLabel} ‚Ä¢ ${breakdownLabel}` : `${sourceLabel}: ${limitLabel}`;
          } else {
            storageUsageHint.textContent = breakdownLabel ? `${sourceLabel} de ${limitLabel} ‚Ä¢ ${breakdownLabel}` : `${sourceLabel} de ${limitLabel}`;
          }
        }
        if(storageUsageFill) storageUsageFill.style.width = '0%';
        return;
      }
      storageUsage.removeAttribute('aria-busy');
      const bytes = Math.max(0, Number(storageUsageBytes) || 0);
      const count = Math.max(0, Number(storageUsageCount) || 0);
      const limitIsCustom = Number.isFinite(storageLimitBytes) && storageLimitBytes > 0;
      const effectiveLimit = limitIsCustom ? storageLimitBytes : DEFAULT_STORAGE_LIMIT_BYTES;
      const percentRaw = effectiveLimit > 0 ? (bytes / effectiveLimit) * 100 : 0;
      const percentForBar = Math.min(100, Math.max(0, percentRaw));
      const percentRounded = Math.round(percentRaw);
      if(storageUsageFill) storageUsageFill.style.width = `${percentForBar}%`;
      if(storageUsagePercent) storageUsagePercent.textContent = `${percentRounded}%`;
      const usedLabel = formatFileSize(bytes);
      const limitLabel = formatFileSize(effectiveLimit);
      const countLabel = formatFileCount(count);
      const sourceLabel = storageLimitSource === 'user'
        ? 'Limite do usu√°rio'
        : storageLimitSource === 'profile'
          ? 'Limite do cliente'
          : 'Limite padr√£o';
      if(bytes <= 0){
        if(storageUsageSummary){
          if(limitIsCustom){
            const descriptor = storageLimitSource === 'user' ? ' (usu√°rio)' : '';
            storageUsageSummary.textContent = `0 B de ${limitLabel}${descriptor} utilizados`;
          } else {
            storageUsageSummary.textContent = 'Nenhum arquivo enviado ainda.';
          }
        }
        if(storageUsageHint){
          if(limitIsCustom){
            const hintLabel = sourceLabel
              ? `${countLabel} ‚Ä¢ ${sourceLabel} de ${limitLabel}`
              : `${countLabel} ‚Ä¢ Limite de ${limitLabel}`;
            storageUsageHint.textContent = breakdownLabel ? `${hintLabel} ‚Ä¢ ${breakdownLabel}` : hintLabel;
          } else {
            storageUsageHint.textContent = `${countLabel} ‚Ä¢ Limite padr√£o de ${limitLabel} ‚Ä¢ ${breakdownLabel}`;
          }
        }
      } else {
        if(storageUsageSummary){
          if(limitIsCustom){
            const descriptor = storageLimitSource === 'user' ? ' (usu√°rio)' : '';
            storageUsageSummary.textContent = `${usedLabel} de ${limitLabel}${descriptor} utilizados`;
          } else {
            storageUsageSummary.textContent = `${usedLabel} de ${limitLabel} (padr√£o) utilizados`;
          }
        }
        if(storageUsageHint){
          if(limitIsCustom){
            const remaining = Math.max(0, effectiveLimit - bytes);
            const remainingLabel = formatFileSize(remaining);
            if(remaining > 0){
              const base = sourceLabel
                ? `${remainingLabel} restantes ‚Ä¢ ${countLabel} ‚Ä¢ ${sourceLabel}`
                : `${remainingLabel} restantes ‚Ä¢ ${countLabel}`;
              storageUsageHint.textContent = breakdownLabel ? `${base} ‚Ä¢ ${breakdownLabel}` : base;
            } else {
              const base = sourceLabel
                ? `Limite atingido ‚Ä¢ ${countLabel} ‚Ä¢ ${sourceLabel}`
                : `Limite atingido ‚Ä¢ ${countLabel}`;
              storageUsageHint.textContent = breakdownLabel ? `${base} ‚Ä¢ ${breakdownLabel}` : base;
            }
          } else {
            storageUsageHint.textContent = `${countLabel} ‚Ä¢ Limite padr√£o de ${limitLabel} ‚Ä¢ ${breakdownLabel}`;
          }
        }
      }
      let level = 'ok';
      if(percentRaw >= 95){
        level = 'alert';
      } else if(percentRaw >= 80){
        level = 'warn';
      }
      storageUsage.dataset.level = level;
    }

    async function refreshStorageUsage(){
      const uid = getUserKey();
      const clientKey = getClientKey();
      const fetchId = ++storageUsageFetchToken;
      if(!uid || !clientKey){
        storageUsageBytes = 0;
        storageUsageCount = 0;
        storageUsageBreakdown = {
          files: 0,
          calendarMedia: 0,
          calendarNotes: 0,
          references: 0,
          notes: 0
        };
        storageUsageLoading = false;
        updateStorageUsageUI();
        return;
      }
      storageUsageLoading = true;
      updateStorageUsageUI();
      try{
        const folderIds = Array.isArray(FOLDERS)
          ? Array.from(new Set(FOLDERS.map(folder => folder?.id).filter(Boolean)))
          : [];
        let totalBytes = 0;
        let totalCount = 0;
        const breakdown = {
          files: 0,
          calendarMedia: 0,
          calendarNotes: 0,
          references: 0,
          notes: 0
        };
        let aggregatedRecent = [];
        if(folderIds.length){
          const results = await Promise.all(folderIds.map(async (folderId)=>{
            try{
              const filesCol = collection(db, 'usuarios', uid, 'clients', clientKey, 'fileFolders', folderId, 'files');
              const snap = await getDocs(filesCol);
              let folderBytes = 0;
              let folderCount = 0;
              const recentEntries = [];
              const folderLabel = getFolderLabel(folderId);
              snap.forEach(docSnap=>{
                folderCount += 1;
                const data = docSnap.data() || {};
                const sizeValue = Number(data.size);
                if(Number.isFinite(sizeValue) && sizeValue > 0){
                  folderBytes += sizeValue;
                }
                const created = normalizeDateValue(data.createdAt);
                recentEntries.push({
                  id: docSnap.id,
                  name: data.name || '',
                  createdAt: created ? created.getTime() : null,
                  folderId,
                  folderLabel
                });
              });
              return { bytes: folderBytes, count: folderCount, recent: recentEntries };
            }catch(err){
              console.warn('refreshStorageUsage folder', folderId, err);
              return { bytes: 0, count: 0, recent: [] };
            }
          }));
          if(fetchId !== storageUsageFetchToken){
            return;
          }
          results.forEach(({ bytes, count, recent })=>{
            totalBytes += bytes;
            totalCount += count;
            if(Array.isArray(recent)) aggregatedRecent.push(...recent);
          });
          breakdown.files = totalBytes;
          aggregatedRecent.sort((a,b)=> (Number(b?.createdAt) || 0) - (Number(a?.createdAt) || 0));
          recentFilesCache = aggregatedRecent.slice(0, 60);
        }else{
          recentFilesCache = [];
        }
        if(fetchId !== storageUsageFetchToken){
          return;
        }
        const calendarUsage = await computeCalendarStorageUsage(clientKey);
        if(fetchId !== storageUsageFetchToken){
          return;
        }
        if(calendarUsage){
          const mediaBytes = Number(calendarUsage.mediaBytes) || 0;
          const mediaCount = Number(calendarUsage.mediaCount) || 0;
          const notesBytes = Number(calendarUsage.notesBytes) || 0;
          const notesCount = Number(calendarUsage.notesCount) || 0;
          breakdown.calendarMedia = mediaBytes;
          breakdown.calendarNotes = notesBytes;
          totalBytes += (Number(calendarUsage.bytes) || mediaBytes + notesBytes);
          totalCount += mediaCount + notesCount;
        }
        const refUsage = await computeRefSocialStorageUsage();
        if(fetchId !== storageUsageFetchToken){
          return;
        }
        if(refUsage){
          const refBytes = Number(refUsage.bytes) || 0;
          const refCount = Number(refUsage.count) || 0;
          breakdown.references = refBytes;
          totalBytes += refBytes;
          totalCount += refCount;
        }
        const notesUsage = computeNotesStorageUsage();
        if(notesUsage){
          const notesBytes = Number(notesUsage.bytes) || 0;
          const notesCount = Number(notesUsage.count) || 0;
          breakdown.notes = notesBytes;
          totalBytes += notesBytes;
          totalCount += notesCount;
        }
        storageUsageBreakdown = breakdown;
        storageUsageBytes = totalBytes;
        storageUsageCount = totalCount;
      }catch(err){
        if(fetchId === storageUsageFetchToken){
          console.warn('refreshStorageUsage', err);
        }
      }finally{
        if(fetchId === storageUsageFetchToken){
          storageUsageLoading = false;
          updateStorageUsageUI();
          try{ refreshMacroInsights(); }catch(_){ }
        }
      }
    }

    updateStorageUsageUI();

    const fileDateFormatter = new Intl.DateTimeFormat('pt-BR', { dateStyle:'short', timeStyle:'short' });
    function normalizeDateValue(raw){
      if(!raw && raw !== 0) return null;
      if(raw instanceof Date) return Number.isFinite(raw.getTime()) ? raw : null;
      if(typeof raw === 'number'){
        const date = new Date(raw);
        return Number.isFinite(date.getTime()) ? date : null;
      }
      if(typeof raw === 'object' && raw !== null){
        if(typeof raw.toDate === 'function'){
          try{ return raw.toDate(); }catch(_){ return null; }
        }
        if(typeof raw.seconds === 'number'){
          const date = new Date(raw.seconds * 1000);
          return Number.isFinite(date.getTime()) ? date : null;
        }
      }
      return null;
    }

    function formatFileDate(raw){
      const date = normalizeDateValue(raw);
      return date ? fileDateFormatter.format(date) : '--';
    }

    function syncFilesViewToggle(){
      if(!filesViewToggle) return;
      const buttons = filesViewToggle.querySelectorAll('.view-btn');
      buttons.forEach(btn=>{
        const active = btn.dataset.mode === FILES_VIEW_MODE;
        btn.classList.toggle('active', active);
        btn.setAttribute('aria-pressed', active ? 'true' : 'false');
      });
    }

    syncFilesViewToggle();

    function setFilesViewMode(mode){
      const normalized = mode === 'grid' ? 'grid' : 'list';
      if(FILES_VIEW_MODE === normalized){
        syncFilesViewToggle();
        return;
      }
      FILES_VIEW_MODE = normalized;
      try{ localStorage.setItem(FILES_VIEW_STORAGE_KEY, normalized); }
      catch(_){ }
      syncFilesViewToggle();
      renderFilesList(CURRENT_FILES, { showFolder: viewingAllFiles });
    }

    function closeFilePreview(){
      if(!filePreviewModal) return;
      filePreviewModal.classList.remove('show');
      filePreviewModal.setAttribute('aria-hidden','true');
      if(filePreviewContent) filePreviewContent.innerHTML = '';
      if(filePreviewInfo) filePreviewInfo.innerHTML = '';
      delete filePreviewModal.dataset.fileId;
    }

    function openFilePreview(file){
      if(!filePreviewModal || !filePreviewContent || !filePreviewInfo) return;
      if(!file || !file.url) return;
      const name = file.name || 'Arquivo';
      const safeUrl = escapeAttr(file.url);
      const safeName = escapeHtml(name);
      let contentHtml = '';
      if(isImageFile(file)){
        contentHtml = `<img src="${safeUrl}" alt="${safeName}" crossorigin="anonymous">`;
      } else if(isVideoFile(file)){
        contentHtml = `<video src="${safeUrl}" controls playsinline crossorigin="anonymous"></video>`;
      } else {
        contentHtml = `<div class="file-preview-placeholder"><span>Pr√©-visualiza√ß√£o indispon√≠vel.<br><a href="${safeUrl}" target="_blank" rel="noopener">Abrir arquivo</a></span></div>`;
      }
      const typeLabelRaw = file.contentType ? String(file.contentType).split(';')[0] : (getFileExt(name) || '').toUpperCase() || 'Desconhecido';
      const downloadDisabled = Boolean(file.uploading) || !file.url;
      const deleteDisabled = Boolean(file.uploading);
      const renameDisabled = Boolean(file.uploading);
      const downloadAttr = downloadDisabled ? ' disabled' : '';
      const deleteAttr = deleteDisabled ? ' disabled' : '';
      const renameAttr = renameDisabled ? ' disabled' : '';
      const actionsMarkup = `
        <div class="file-preview-actions">
          <a class="btn small" href="${safeUrl}" target="_blank" rel="noopener">Abrir original</a>
          <button class="btn ghost small download-file" type="button"${downloadAttr}>Baixar</button>
          <button class="btn ghost small rename-file" type="button"${renameAttr}>Renomear</button>
          <button class="btn ghost small danger delete-file" type="button"${deleteAttr}>Excluir</button>
        </div>
      `;
      const infoMarkup = [
        `<div><strong>Nome</strong>${safeName}</div>`,
        `<div><strong>Adicionado em</strong>${escapeHtml(formatFileDate(file.createdAt))}</div>`,
        `<div><strong>Tamanho</strong>${escapeHtml(formatFileSize(file.size))}</div>`,
        `<div><strong>Tipo</strong>${escapeHtml(typeLabelRaw)}</div>`,
        actionsMarkup
      ].join('');
      filePreviewTitle && (filePreviewTitle.textContent = name);
      filePreviewContent.innerHTML = contentHtml;
      filePreviewInfo.innerHTML = infoMarkup;
      filePreviewModal.classList.add('show');
      filePreviewModal.setAttribute('aria-hidden','false');
      if(file.id){
        filePreviewModal.dataset.fileId = file.id;
      } else {
        delete filePreviewModal.dataset.fileId;
      }
    }

    filePreviewClose?.addEventListener('click', closeFilePreview);
    filePreviewModal?.addEventListener('click', (event)=>{
      if(event.target === filePreviewModal){
        closeFilePreview();
      }
    });
    filePreviewInfo?.addEventListener('click', (event)=>{
      const downloadBtn = event.target.closest('.download-file');
      if(downloadBtn){
        event.preventDefault();
        event.stopPropagation();
        const fileId = filePreviewModal?.dataset.fileId;
        if(fileId){
          handleFileDownload(fileId);
        }
        return;
      }
      const renameBtn = event.target.closest('.rename-file');
      if(renameBtn){
        event.preventDefault();
        event.stopPropagation();
        const fileId = filePreviewModal?.dataset.fileId;
        if(fileId){
          renameFileById(fileId);
        }
        return;
      }
      const deleteBtn = event.target.closest('.delete-file');
      if(deleteBtn){
        event.preventDefault();
        event.stopPropagation();
        const fileId = filePreviewModal?.dataset.fileId;
        if(fileId){
          deleteFileById(fileId);
        }
      }
    });
    document.addEventListener('keydown', (event)=>{
      if(event.key === 'Escape' && filePreviewModal?.classList.contains('show')){
        closeFilePreview();
      }
    });

    filesViewToggle?.addEventListener('click', (event)=>{
      const btn = event.target.closest('.view-btn');
      if(!btn) return;
      const mode = btn.dataset.mode;
      setFilesViewMode(mode);
    });

    viewAllFilesBtn?.addEventListener('click', async ()=>{
      if(FILES_UPLOAD_ACTIVE) return;
      if(viewingAllFiles){
        const targetFolder = lastSelectedFolder;
        selectFolder(targetFolder);
      } else {
        lastSelectedFolder = currentFolder;
        viewingAllFiles = true;
        updateFilesToolbar();
        await loadAllFiles();
      }
    });

    function getClientKey(){
      return (typeof window.TENANT === 'string' && window.TENANT) || document.body.getAttribute('data-client-id');
    }

    function getUserKey(){
      return auth.currentUser?.uid || null;
    }

    function requireAuthUser(){
      if(auth.currentUser){
        return Promise.resolve(auth.currentUser);
      }
      return new Promise((resolve, reject)=>{
        const unsubscribe = onAuthStateChanged(auth, (user)=>{
          unsubscribe();
          if(user){
            resolve(user);
          } else {
            reject(new Error('Usu√°rio n√£o autenticado.'));
          }
        }, (error)=>{
          unsubscribe();
          reject(error);
        });
      });
    }

    function getUserKeyCandidates(){
      const user = auth.currentUser;
      if(!user) return [];
      const keys = [];
      if(user.uid) keys.push(user.uid);
      if(user.email && user.email !== user.uid) keys.push(user.email);
      return keys;
    }

    function renderFiles(){
      loadFolders();
    }

    function getChildFolders(parentId){
      const target = normalizeParent(parentId);
      return FOLDERS.filter(f=> normalizeParent(f.parentId) === target)
        .sort((a,b)=> folderCollator.compare(a.name||'', b.name||''));
    }

    function getFolderTrail(id){
      const trail = [];
      let currentId = normalizeParent(id);
      const visited = new Set();
      while(currentId){
        if(visited.has(currentId)) break;
        visited.add(currentId);
        const folder = FOLDERS.find(f=>f.id===currentId);
        if(!folder) break;
        trail.push(folder);
        currentId = normalizeParent(folder.parentId);
      }
      return trail.reverse();
    }

    function formatFolderPath(id){
      const trail = getFolderTrail(id);
      return trail.map(f=>f.name).join(' ‚Ä∫ ');
    }

    function getFolderLabel(folderId){
      const normalized = normalizeParent(folderId);
      if(!normalized) return 'Arquivos';
      const path = formatFolderPath(normalized);
      if(path) return path;
      const folder = FOLDERS.find(f=>f.id===normalized);
      return folder?.name || 'Pasta';
    }

    function getFolderDescendants(id){
      const normalized = normalizeParent(id);
      if(!normalized) return [];
      const result = [];
      const stack = [normalized];
      const seen = new Set([normalized]);
      while(stack.length){
        const current = stack.pop();
        const children = FOLDERS.filter(f=> normalizeParent(f.parentId) === current);
        children.forEach(child=>{
          if(seen.has(child.id)) return;
          seen.add(child.id);
          result.push(child.id);
          stack.push(child.id);
        });
      }
      return result;
    }

    async function loadFolders(){
      const uid = getUserKey();
      const clientKey = getClientKey();
      if(!foldersList){ return; }
      if(!uid || !clientKey){
        FOLDERS = [];
        currentFolder = null;
        renderFolders();
        renderFolderContents([]);
        if(!uid){
          resetStorageUsageState({ loading: false });
        }
        return;
      }
      try{
        const col = collection(db, 'usuarios', uid, 'clients', clientKey, 'fileFolders');
        const snap = await getDocs(col);
        const fetchedFolders = snap.docs.map(d=>{
          const data = d.data() || {};
          return {
            id: d.id,
            name: data.name || 'Pasta sem nome',
            parentId: normalizeParent(data.parentId),
            createdAt: data.createdAt || null
          };
        });
        const ensuredFolders = await ensureDefaultRootFolders(uid, clientKey, fetchedFolders, col);
        FOLDERS = [...fetchedFolders, ...ensuredFolders];
      }catch(err){
        console.warn('loadFolders', err);
        FOLDERS = [];
      }
      if(currentFolder && !FOLDERS.some(f=>f.id===currentFolder)){
        currentFolder = null;
      }
      renderFolders();
      renderFolderContents(CURRENT_FILES);
      if(viewingAllFiles){
        await loadAllFiles();
      } else {
        await loadFiles();
      }
      await refreshStorageUsage();
    }

    function renderFolders(){
      if(!foldersList) return;
      const visited = new Set();
      const buildTree = (parentId, depth)=>{
        const children = getChildFolders(parentId).filter(folder=>{
          if(visited.has(folder.id)) return false;
          visited.add(folder.id);
          return true;
        });
        if(!children.length) return '';
        return children.map(folder=>{
          const isActive = (!viewingAllFiles && folder.id === currentFolder) ? ' active' : '';
          const depthValue = depth + 1;
          const safeName = escapeHtml(folder.name);
          return `
            <div class="folder-tree-item${isActive}" data-id="${folder.id}" style="--depth:${depthValue}">
              <span class="tree-icon">üìÅ</span>
              <span class="tree-label">${safeName}</span>
              <div class="folder-actions">
                <button class="folder-action rename-folder" type="button" data-id="${folder.id}" title="Renomear pasta">‚úèÔ∏è</button>
                <button class="folder-action move-folder" type="button" data-id="${folder.id}" title="Mover pasta">üîÄ</button>
                <button class="folder-action delete-folder" type="button" data-id="${folder.id}" title="Excluir pasta">üóëÔ∏è</button>
              </div>
            </div>
            ${buildTree(folder.id, depthValue)}
          `;
        }).join('');
      };
      const rootActive = (!viewingAllFiles && !currentFolder) ? ' active' : '';
      const treeMarkup = buildTree(null, 0);
      foldersList.innerHTML = `
        <div class="folder-tree-item${rootActive}" data-id="" style="--depth:0">
          <span class="tree-icon">üè†</span>
          <span class="tree-label">Arquivos</span>
        </div>
        ${treeMarkup || '<div class="folder-tree-empty">Nenhuma pasta criada.</div>'}
      `;
    }

    function renderFolderContents(files){
      CURRENT_FILES = Array.isArray(files) ? files : [];
      syncSelectionWithCurrentFiles();
      const childFolders = viewingAllFiles ? [] : getChildFolders(currentFolder);
      renderSubfolders(viewingAllFiles ? [] : childFolders);
      renderFilesList(CURRENT_FILES, { showFolder: viewingAllFiles });
      renderEmptyState(viewingAllFiles ? [] : childFolders, CURRENT_FILES);
      renderBreadcrumb();
      updateFilesToolbar();
    }

    function refreshFilesUi(){
      if(viewingAllFiles){
        renderSubfolders([]);
        renderFilesList(CURRENT_FILES, { showFolder: true });
        renderEmptyState([], CURRENT_FILES);
        renderBreadcrumb();
        return;
      }
      const childFolders = getChildFolders(currentFolder);
      renderSubfolders(childFolders);
      renderFilesList(CURRENT_FILES);
      renderEmptyState(childFolders, CURRENT_FILES);
      renderBreadcrumb();
    }

    const clampPercent = (value)=>{
      const num = Number(value);
      if(!Number.isFinite(num)) return 0;
      return Math.max(0, Math.min(100, num));
    };

    function showUploadProgress(percent, message){
      if(!uploadProgress) return;
      uploadProgress.classList.remove('hidden');
      const clamped = clampPercent(percent);
      if(uploadProgressBar){
        uploadProgressBar.style.width = `${clamped}%`;
      }
      if(uploadProgressPercent){
        uploadProgressPercent.textContent = `${clamped}%`;
      }
      if(uploadProgressText){
        uploadProgressText.textContent = message || '';
        if(message){
          uploadProgressText.title = message;
        } else {
          uploadProgressText.removeAttribute('title');
        }
      }
    }

    function hideUploadProgress(){
      if(!uploadProgress) return;
      uploadProgress.classList.add('hidden');
      if(uploadProgressBar){
        uploadProgressBar.style.width = '0%';
      }
      if(uploadProgressPercent){
        uploadProgressPercent.textContent = '';
      }
      if(uploadProgressText){
        uploadProgressText.textContent = '';
        uploadProgressText.removeAttribute('title');
      }
    }

    function renderSubfolders(children){
      if(!subfoldersGrid) return;
      if(!children.length){
        subfoldersGrid.innerHTML = '';
        subfoldersGrid.classList.add('hidden');
        return;
      }
      subfoldersGrid.classList.remove('hidden');
      subfoldersGrid.innerHTML = children.map(folder=>{
        const safeName = escapeHtml(folder.name);
        return `
        <div class="subfolder-card" data-id="${folder.id}">
          <div class="subfolder-icon">üìÅ</div>
          <div class="subfolder-name">${safeName}</div>
        </div>
      `;
      }).join('');
    }

    function renderFilesList(arr, options = {}){
      if(!filesList) return;
      const showFolder = Boolean(options.showFolder);
      if(!Array.isArray(arr) || !arr.length){
        filesList.innerHTML = '';
        filesList.classList.add('hidden');
        delete filesList.dataset.view;
        delete filesList.dataset.all;
        updateSelectionIndicators();
        return;
      }
      filesList.classList.remove('hidden');
      filesList.dataset.view = FILES_VIEW_MODE;
      filesList.dataset.all = showFolder ? 'true' : 'false';
      const rowsMarkup = arr.map((file, index)=>{
        const id = file.id || '';
        const name = file.name || '';
        const safeName = escapeHtml(name);
        const safeTitle = escapeAttr(name);
        const safeUrl = escapeAttr(file.url || '');
        const uploading = Boolean(file.uploading);
        const selected = id && SELECTED_FILES.has(id);
        const progressValue = clampPercent(file.progress ?? (uploading ? 0 : 100));
        const folderIdForFile = normalizeParent(file.folderId ?? currentFolder);
        const availableFolders = FOLDERS.filter(fl=>fl.id !== folderIdForFile);
        const optionsMarkup = availableFolders.map(fl=>{
          const label = getFolderLabel(fl.id);
          return `<option value="${fl.id}">${escapeHtml(label)}</option>`;
        }).join('');
        const baseSelectMarkup = availableFolders.length
          ? `<option value="">Mover para...</option>${optionsMarkup}`
          : '<option value="" disabled>Crie outra pasta para mover</option>';
        let thumb = '<span class="file-icon">üìÑ</span>';
        if(isImageFile(file)){
          thumb = `<img src="${safeUrl}" alt="${safeName}" crossorigin="anonymous">`;
        } else if(isVideoFile(file)){
          thumb = `<video src="${safeUrl}" muted playsinline preload="metadata" crossorigin="anonymous"></video>`;
        }
        const typeLabelRaw = file.contentType ? String(file.contentType).split(';')[0] : (getFileExt(name) || '').toUpperCase() || 'Arquivo';
        const safeType = escapeHtml(typeLabelRaw);
        const added = escapeHtml(formatFileDate(file.createdAt));
        const sizeLabel = escapeHtml(formatFileSize(file.size));
        const folderLabel = showFolder ? escapeHtml(file.folderLabel || getFolderLabel(folderIdForFile)) : '';
        const folderInfo = showFolder ? `<div class="file-folder">üìÅ ${folderLabel}</div>` : '';
        const statusHtml = uploading
          ? `<div class="file-status"><span>Enviando (${progressValue}%)</span><div class="file-status-bar"><div class="file-status-fill" style="width:${progressValue}%"></div></div></div>`
          : '';
        const moveDisabled = uploading || !availableFolders.length;
        const selectAttr = moveDisabled ? ' disabled' : '';
        const copyDisabled = uploading || !file.url;
        const downloadDisabled = uploading || !file.url;
        const deleteDisabled = uploading;
        const renameDisabled = uploading;
        const copyAttr = copyDisabled ? ' disabled' : '';
        const downloadAttr = downloadDisabled ? ' disabled' : '';
        const deleteAttr = deleteDisabled ? ' disabled' : '';
        const renameAttr = renameDisabled ? ' disabled' : '';
        const buttonsHtml = `<div class="file-action-buttons"><button class="btn ghost small copy-link" type="button"${copyAttr}>Copiar link</button><button class="btn ghost small download-file" type="button"${downloadAttr}>Baixar</button><button class="btn ghost small rename-file" type="button"${renameAttr}>Renomear</button><button class="btn ghost small danger delete-file" type="button"${deleteAttr}>Excluir</button></div>`;
        const moveHtml = `<div class="file-action-move"><select class="move-select"${selectAttr}>${baseSelectMarkup}</select></div>`;
        const actionsHtml = `<div class="file-actions">${buttonsHtml}${moveHtml}</div>`;
        const folderDataAttr = folderIdForFile ? ` data-folder="${escapeAttr(folderIdForFile)}"` : '';
        const checkboxAttr = selected ? ' checked' : '';
        const checkboxDisabled = uploading ? ' disabled' : '';
        const checkboxLabelAttr = escapeAttr(name ? `Selecionar ${name}` : 'Selecionar arquivo');
        const checkbox = `<label class="file-select-box${FILES_VIEW_MODE === 'grid' ? ' compact' : ''}"><input aria-label="${checkboxLabelAttr}" class="file-checkbox" data-id="${id}" data-index="${index}" type="checkbox"${checkboxAttr}${checkboxDisabled}>${FILES_VIEW_MODE === 'grid' ? '' : '<span class="file-select-label">Selecionar</span>'}</label>`;
        if(FILES_VIEW_MODE === 'grid'){
          const detailsHtml = `<div class="file-details"><span>${added}</span><span>${sizeLabel}</span><span>${safeType}</span></div>`;
          return `<div class="file-card file-entry${uploading ? ' uploading' : ''}${selected ? ' selected' : ''}" data-id="${id}"${folderDataAttr} title="${safeTitle}">${checkbox}<div class="file-thumb">${thumb}</div><div class="file-name">${safeName}</div>${folderInfo}${detailsHtml}${statusHtml}${actionsHtml}</div>`;
        }
        const infoParts = [`<div class="file-name">${safeName}</div>`];
        if(folderInfo) infoParts.push(folderInfo);
        infoParts.push(`<div class="file-type">${safeType}</div>`);
        if(statusHtml) infoParts.push(statusHtml);
        const infoHtml = infoParts.join('');
        return `<div class="files-table-row file-entry${uploading ? ' uploading' : ''}${selected ? ' selected' : ''}" data-id="${id}"${folderDataAttr} title="${safeTitle}"><div class="file-select-col">${checkbox}</div><div class="file-info"><div class="file-thumb">${thumb}</div><div class="file-text">${infoHtml}</div></div><div class="file-meta">${added}</div><div class="file-meta">${sizeLabel}</div>${actionsHtml}</div>`;
      }).join('');
      if(FILES_VIEW_MODE === 'grid'){
        filesList.innerHTML = `<div class="files-grid">${rowsMarkup}</div>`;
      } else {
        filesList.innerHTML = `<div class="files-table"><div class="files-table-head"><span class="file-select-head"></span><span>Arquivo</span><span>Adicionado</span><span>Tamanho</span><span>A√ß√µes</span></div><div class="files-table-body">${rowsMarkup}</div></div>`;
      }
      updateSelectionIndicators();
    }

    function syncSelectionWithCurrentFiles(){
      const validIds = new Set(CURRENT_FILES.map(file=>file.id).filter(Boolean));
      let changed = false;
      SELECTED_FILES.forEach(id=>{
        if(!validIds.has(id)){
          SELECTED_FILES.delete(id);
          changed = true;
        }
      });
      if(changed){
        LAST_SELECTED_INDEX = null;
      }
      updateSelectionIndicators();
    }

    function updateSelectionIndicators(){
      applySelectionToDom();
      updateSelectAllControl();
      updateBulkBar();
    }

    function applySelectionToDom(){
      if(!filesList) return;
      const entries = filesList.querySelectorAll('.file-entry');
      entries.forEach(entry=>{
        const id = entry.dataset.id;
        if(!id) return;
        const selected = SELECTED_FILES.has(id);
        entry.classList.toggle('selected', selected);
        const checkbox = entry.querySelector('.file-checkbox');
        if(checkbox){
          checkbox.checked = selected;
        }
      });
    }

    function updateSelectAllControl(){
      if(!filesSelectAll) return;
      const selectable = CURRENT_FILES.filter(file=>!file.uploading && file.id);
      const total = selectable.length;
      const selectedCount = selectable.filter(file=>SELECTED_FILES.has(file.id)).length;
      filesSelectAll.disabled = total === 0;
      filesSelectAll.checked = total > 0 && selectedCount === total;
      filesSelectAll.indeterminate = selectedCount > 0 && selectedCount < total;
    }

    function updateBulkBar(){
      if(!filesBulkBar) return;
      const selectedCount = SELECTED_FILES.size;
      const hasUndo = Boolean(LAST_UNDO_ACTION);
      const show = selectedCount > 0 || BULK_ACTION_RUNNING || hasUndo;
      filesBulkBar.classList.toggle('hidden', !show);
      if(filesBulkCount){
        if(selectedCount > 0){
          const plural = selectedCount > 1 ? 's' : '';
          filesBulkCount.textContent = `${selectedCount} arquivo${plural} selecionado${plural}`;
        } else if(hasUndo){
          filesBulkCount.textContent = 'A√ß√£o conclu√≠da';
        } else if(BULK_ACTION_RUNNING){
          filesBulkCount.textContent = 'Processando...';
        } else {
          filesBulkCount.textContent = '';
        }
      }
      if(filesBulkStatus){
        filesBulkStatus.textContent = BULK_STATUS_MESSAGE || '';
        filesBulkStatus.classList.toggle('hidden', !BULK_STATUS_MESSAGE);
      }
      if(filesBulkUndo){
        filesBulkUndo.classList.toggle('hidden', !hasUndo || BULK_ACTION_RUNNING);
        filesBulkUndo.disabled = BULK_ACTION_RUNNING;
      }
      const buttons = filesBulkBar.querySelectorAll('[data-action]');
      buttons.forEach(btn=>{
        btn.disabled = BULK_ACTION_RUNNING || selectedCount === 0;
      });
    }

    function setBulkStatus(message){
      BULK_STATUS_MESSAGE = message || '';
      updateBulkBar();
    }

    function clearBulkStatus(){
      setBulkStatus('');
    }

    function clearSelection(){
      SELECTED_FILES.clear();
      LAST_SELECTED_INDEX = null;
      updateSelectionIndicators();
    }

    function getSelectedFiles(){
      if(!SELECTED_FILES.size) return [];
      const map = new Map(CURRENT_FILES.map(file=>[file.id, file]));
      return Array.from(SELECTED_FILES).map(id=>map.get(id)).filter(Boolean);
    }

    function setUndoAction(action){
      LAST_UNDO_ACTION = action || null;
      updateBulkBar();
    }

    function handleFileSelectionToggle(checkbox, useShift){
      if(!checkbox) return;
      const fileId = checkbox.dataset.id;
      if(!fileId) return;
      if(checkbox.disabled){
        checkbox.checked = false;
        return;
      }
      const index = Number(checkbox.dataset.index);
      const shouldSelect = checkbox.checked;
      if(useShift && LAST_SELECTED_INDEX !== null && Number.isFinite(index)){
        const start = Math.min(LAST_SELECTED_INDEX, index);
        const end = Math.max(LAST_SELECTED_INDEX, index);
        for(let i = start; i <= end; i++){
          const file = CURRENT_FILES[i];
          if(!file || !file.id || file.uploading) continue;
          if(shouldSelect){
            SELECTED_FILES.add(file.id);
          } else {
            SELECTED_FILES.delete(file.id);
          }
        }
      } else {
        if(shouldSelect){
          SELECTED_FILES.add(fileId);
        } else {
          SELECTED_FILES.delete(fileId);
        }
      }
      if(Number.isFinite(index)){
        LAST_SELECTED_INDEX = index;
      }
      updateSelectionIndicators();
    }

    function renderEmptyState(children, files){
      if(!filesEmpty) return;
      let message = '';
      if(viewingAllFiles){
        message = files.length
          ? ''
          : 'Nenhum arquivo encontrado. Crie uma pasta e envie arquivos para come√ßar.';
      } else if(!currentFolder){
        message = children.length
          ? 'Selecione uma pasta na barra lateral ou clique em uma subpasta para visualizar os arquivos.'
          : 'Nenhuma pasta criada. Clique em "Nova pasta" para come√ßar.';
      } else if(!children.length && !files.length){
        message = 'Esta pasta est√° vazia. Utilize os bot√µes acima para adicionar arquivos ou criar subpastas.';
      } else if(!files.length){
        message = 'Nenhum arquivo nesta pasta.';
      }
      filesEmpty.textContent = message;
      filesEmpty.style.display = message ? 'block' : 'none';
    }

    function renderBreadcrumb(){
      if(!filesBreadcrumb) return;
      const parts = [];
      const isRoot = !currentFolder && !viewingAllFiles;
      parts.push(`<span class="crumb${isRoot ? ' current' : ''}" data-id="">Arquivos</span>`);
      if(viewingAllFiles){
        parts.push('<span class="crumb-sep">‚Ä∫</span>');
        parts.push(`<span class="crumb current" data-id="${ALL_FILES_CRUMB_ID}">Todos os arquivos</span>`);
      } else {
        const trail = getFolderTrail(currentFolder);
        trail.forEach((folder, idx)=>{
          parts.push('<span class="crumb-sep">‚Ä∫</span>');
          const isLast = idx === trail.length - 1;
          parts.push(`<span class="crumb${isLast ? ' current' : ''}" data-id="${folder.id}">${escapeHtml(folder.name)}</span>`);
        });
      }
      filesBreadcrumb.innerHTML = parts.join('');
    }

    function updateViewAllButton(){
      if(!viewAllFilesBtn) return;
      const label = viewingAllFiles ? 'Voltar para pastas' : 'Ver todos os arquivos';
      viewAllFilesBtn.textContent = label;
      viewAllFilesBtn.classList.toggle('active', viewingAllFiles);
      viewAllFilesBtn.setAttribute('aria-pressed', viewingAllFiles ? 'true' : 'false');
      viewAllFilesBtn.title = viewingAllFiles
        ? 'Voltar para a visualiza√ß√£o por pastas.'
        : 'Visualizar todos os arquivos de todas as pastas.';
      viewAllFilesBtn.disabled = FILES_UPLOAD_ACTIVE;
    }

    function updateFilesToolbar(){
      if(uploadFilesBtn){
        const disabled = viewingAllFiles || !currentFolder || FILES_UPLOAD_ACTIVE;
        uploadFilesBtn.disabled = disabled;
        if(FILES_UPLOAD_ACTIVE){
          uploadFilesBtn.textContent = 'Enviando...';
          uploadFilesBtn.title = 'Aguarde o envio terminar.';
        } else {
          uploadFilesBtn.textContent = 'Adicionar arquivos';
          if(viewingAllFiles){
            uploadFilesBtn.title = 'Saia do modo "Todos os arquivos" para enviar arquivos.';
          } else {
            uploadFilesBtn.title = currentFolder ? 'Adicionar arquivos' : 'Selecione uma pasta para enviar arquivos.';
          }
        }
      }
      if(newFolderBtn){
        newFolderBtn.textContent = currentFolder ? 'Nova subpasta' : 'Nova pasta';
      }
      updateViewAllButton();
      updateSelectAllControl();
      updateBulkBar();
    }

    function selectFolder(id){
      const normalized = normalizeParent(id);
      const wasViewingAll = viewingAllFiles;
      if(viewingAllFiles){
        viewingAllFiles = false;
        updateViewAllButton();
      }
      lastSelectedFolder = normalized;
      if(normalized === currentFolder && !wasViewingAll){
        renderFolderContents(CURRENT_FILES);
        return;
      }
      currentFolder = normalized;
      CURRENT_FILES = [];
      renderFolders();
      renderFolderContents([]);
      loadFiles();
    }

    foldersList?.addEventListener('click', e=>{
      const deleteBtn = e.target.closest('.delete-folder');
      if(deleteBtn){
        e.preventDefault();
        e.stopPropagation();
        deleteFolder(deleteBtn.dataset.id);
        return;
      }
      const moveBtn = e.target.closest('.move-folder');
      if(moveBtn){
        e.preventDefault();
        e.stopPropagation();
        moveFolder(moveBtn.dataset.id);
        return;
      }
      const renameBtn = e.target.closest('.rename-folder');
      if(renameBtn){
        e.preventDefault();
        e.stopPropagation();
        renameFolder(renameBtn.dataset.id);
        return;
      }
      const item = e.target.closest('.folder-tree-item');
      if(!item) return;
      selectFolder(item.dataset.id || null);
    });

    subfoldersGrid?.addEventListener('click', e=>{
      const card = e.target.closest('.subfolder-card');
      if(!card) return;
      selectFolder(card.dataset.id || null);
    });

    filesBreadcrumb?.addEventListener('click', e=>{
      const crumb = e.target.closest('.crumb');
      if(!crumb || crumb.classList.contains('current')) return;
      selectFolder(crumb.dataset.id || null);
    });

    async function renameFolder(id){
      const folder = FOLDERS.find(f=>f.id===id);
      if(!folder) return;
      const newName = (prompt('Renomear pasta:', folder.name)||'').trim();
      if(!newName || newName===folder.name) return;
      const uid = getUserKey();
      const clientKey = getClientKey();
      if(!uid || !clientKey) return;
      const ref = doc(db, 'usuarios', uid, 'clients', clientKey, 'fileFolders', id);
      await updateDoc(ref, { name: newName });
      folder.name = newName;
      renderFolders();
      renderFolderContents(CURRENT_FILES);
    }

    async function moveFolder(id){
      const folder = FOLDERS.find(f=>f.id===id);
      if(!folder) return;
      const uid = getUserKey();
      const clientKey = getClientKey();
      if(!uid || !clientKey){
        alert('Fa√ßa login para mover pastas.');
        return;
      }
      const blocked = new Set([id, ...getFolderDescendants(id)]);
      const options = [
        { id: '', label: 'Arquivos (raiz)' },
        ...FOLDERS.filter(fl=>!blocked.has(fl.id)).map(fl=>({ id: fl.id, label: getFolderLabel(fl.id) }))
      ];
      if(options.length <= 1){
        alert('Crie outra pasta antes de mover.');
        return;
      }
      const choice = prompt(
        'Mover para qual pasta? Digite o n√∫mero correspondente:\n' +
        options.map((opt, idx)=>`${idx} - ${opt.label}`).join('\n'),
        '0'
      );
      if(choice === null) return;
      const index = Number(choice.trim());
      if(!Number.isInteger(index) || index < 0 || index >= options.length){
        alert('Op√ß√£o inv√°lida.');
        return;
      }
      const target = options[index];
      const newParent = normalizeParent(target.id);
      if(normalizeParent(folder.parentId) === newParent){
        return;
      }
      try{
        const ref = doc(db, 'usuarios', uid, 'clients', clientKey, 'fileFolders', id);
        await updateDoc(ref, { parentId: newParent || null });
        folder.parentId = newParent;
        renderFolders();
        if(viewingAllFiles){
          await loadAllFiles();
        } else {
          renderFolderContents(CURRENT_FILES);
        }
      }catch(err){
        console.warn('moveFolder', err);
        alert('N√£o foi poss√≠vel mover a pasta.');
      }
    }

    async function deleteFolder(id){
      const folder = FOLDERS.find(f=>f.id===id);
      if(!folder) return;
      const confirmed = confirm(`Excluir a pasta "${folder.name}" e todo o conte√∫do? Esta a√ß√£o n√£o pode ser desfeita.`);
      if(!confirmed) return;
      const uid = getUserKey();
      const clientKey = getClientKey();
      if(!uid || !clientKey){
        alert('Fa√ßa login para excluir pastas.');
        return;
      }
      const targetIds = [id, ...getFolderDescendants(id)];
      try{
        for(const folderId of targetIds){
          try{
            const filesCol = collection(db, 'usuarios', uid, 'clients', clientKey, 'fileFolders', folderId, 'files');
            const snap = await getDocs(filesCol);
            for(const docSnap of snap.docs){
              const data = docSnap.data() || {};
              const storagePath = data.storagePath || `usuarios/${uid}/clients/${clientKey}/files/${folderId}/${data.name || ''}`;
              if(storagePath){
                try{
                  if(!STORAGE) STORAGE = getStorage(app);
                  await deleteObject(sRef(STORAGE, storagePath));
                }catch(storageErr){
                  console.warn('deleteFolder storage', storageErr);
                }
              }
              try{
                await deleteDoc(docSnap.ref);
              }catch(fileErr){
                console.warn('deleteFolder fileDoc', fileErr);
              }
            }
          }catch(filesErr){
            console.warn('deleteFolder files', filesErr);
          }
          try{
            await deleteDoc(doc(db, 'usuarios', uid, 'clients', clientKey, 'fileFolders', folderId));
          }catch(folderErr){
            console.warn('deleteFolder doc', folderErr);
          }
        }
      }catch(err){
        console.warn('deleteFolder', err);
        alert('N√£o foi poss√≠vel excluir a pasta.');
        return;
      }
      const removed = new Set(targetIds);
      FOLDERS = FOLDERS.filter(f=>!removed.has(f.id));
      if(removed.has(currentFolder)){
        currentFolder = null;
        CURRENT_FILES = [];
      }
      if(removed.has(lastSelectedFolder)){
        lastSelectedFolder = null;
      }
      renderFolders();
      if(viewingAllFiles){
        await loadAllFiles();
      } else if(currentFolder){
        await loadFiles();
      } else {
        renderFolderContents([]);
      }
      await refreshStorageUsage();
    }

    uploadFilesBtn?.addEventListener('click', ()=>{
      if(uploadFilesBtn.disabled || FILES_UPLOAD_ACTIVE) return;
      fileInput?.click();
    });
    fileInput?.addEventListener('change', ()=>{
      const selection = fileInput?.files ? Array.from(fileInput.files) : [];
      if(selection.length) uploadFiles(selection);
    });

    async function uploadFiles(fileList){
      if(!currentFolder){
        alert('Selecione uma pasta antes de enviar arquivos.');
        if(fileInput) fileInput.value = '';
        return;
      }
      const queue = Array.isArray(fileList) ? fileList : Array.from(fileList || []);
      if(!queue.length){
        if(fileInput) fileInput.value = '';
        return;
      }
      const tenantId = getClientKey();
      if(!tenantId){
        alert('Fa√ßa login para enviar arquivos.');
        if(fileInput) fileInput.value = '';
        return;
      }
      try{
        await requireAuthUser();
      }catch(authError){
        console.error('uploadFiles auth', authError);
        alert('Fa√ßa login para enviar arquivos.');
        if(fileInput) fileInput.value = '';
        return;
      }
      const authenticatedUser = auth.currentUser;
      if(!authenticatedUser || !authenticatedUser.uid){
        alert('Fa√ßa login para enviar arquivos.');
        if(fileInput) fileInput.value = '';
        return;
      }
      const userId = authenticatedUser.uid;
      if(FILES_UPLOAD_ACTIVE){
        if(fileInput) fileInput.value = '';
        return;
      }
      FILES_UPLOAD_ACTIVE = true;
      updateFilesToolbar();
      showUploadProgress(0, 'Preparando envio...');
      const folderPath = String(currentFolder || '').trim();
      const filesCol = collection(db, 'usuarios', userId, 'clients', tenantId, 'fileFolders', currentFolder, 'files');
      const totalBytes = queue.reduce((sum, file)=>{
        const size = Number(file?.size);
        if(Number.isFinite(size) && size > 0){
          return sum + size;
        }
        return sum;
      }, 0);
      const useBytes = totalBytes > 0;
      const totalFiles = queue.length;
      let completedBytes = 0;
      let completedFiles = 0;
      try{
        for(const file of queue){
          const activeUser = auth.currentUser;
          if(!activeUser || !activeUser.uid){
            throw new Error('Sess√£o expirada. Fa√ßa login novamente para enviar arquivos.');
          }
          const storagePath = `usuarios/${activeUser.uid}/clients/${tenantId}/files/${folderPath}/${file.name}`;
          if(!STORAGE){
            STORAGE = getStorage(app);
          }
          const ref = sRef(STORAGE, storagePath);
          const normalizedSize = (()=>{
            const size = Number(file?.size);
            return Number.isFinite(size) && size >= 0 ? size : null;
          })();
          const tempId = `temp-${Date.now()}-${Math.random().toString(36).slice(2,10)}`;
          let objectUrl = '';
          try{
            objectUrl = URL.createObjectURL(file);
            if(objectUrl){
              uploadingObjectUrls.set(tempId, objectUrl);
            }
          }catch(_){ }
          const folderLabel = getFolderLabel(currentFolder);
          const tempEntry = {
            id: tempId,
            name: file.name,
            url: objectUrl || '',
            createdAt: Date.now(),
            size: normalizedSize,
            contentType: file.type || '',
            storagePath,
            uploading: true,
            progress: 0,
            folderId: currentFolder,
            folderLabel
          };
          CURRENT_FILES = [...CURRENT_FILES, tempEntry];
          refreshFilesUi();
          const initialPercent = useBytes && totalBytes
            ? Math.round((completedBytes / totalBytes) * 100)
            : Math.round((completedFiles / totalFiles) * 100);
          showUploadProgress(initialPercent, 'Preparando envio...');
          const snapshot = await new Promise((resolve, reject)=>{
            const task = uploadBytesResumable(ref, file);
            task.on('state_changed', snap=>{
              const totalForFile = snap.totalBytes || (normalizedSize ?? 0);
              const bytesTransferred = snap.bytesTransferred;
              const fileTotal = totalForFile > 0 ? totalForFile : (bytesTransferred > 0 ? bytesTransferred : 0);
              if(fileTotal && (!Number.isFinite(tempEntry.size) || tempEntry.size === null)){
                tempEntry.size = fileTotal;
              }
              const fileProgress = totalForFile > 0
                ? Math.round((bytesTransferred / totalForFile) * 100)
                : (bytesTransferred ? 100 : 0);
              tempEntry.progress = fileProgress;
              const overallPercent = (()=>{
                if(useBytes){
                  const bytes = completedBytes + bytesTransferred;
                  return totalBytes ? Math.round((bytes / totalBytes) * 100) : fileProgress;
                }
                const denom = totalForFile > 0 ? totalForFile : 1;
                const fraction = bytesTransferred / denom;
                const percent = ((completedFiles + fraction) / totalFiles) * 100;
                return Math.round(percent);
              })();
              showUploadProgress(overallPercent, `Enviando ${file.name} (${fileProgress}%)`);
              refreshFilesUi();
            }, reject, ()=> resolve(task.snapshot));
          });
          const rawTotal = Number(snapshot.totalBytes);
          const fileTotal = Number.isFinite(rawTotal) && rawTotal >= 0 ? rawTotal : (normalizedSize ?? 0);
          if(useBytes){
            completedBytes += fileTotal;
          } else {
            completedFiles += 1;
          }
          const url = await getDownloadURL(snapshot.ref);
          const storedSize = Number.isFinite(fileTotal) && fileTotal >= 0 ? fileTotal : (normalizedSize ?? null);
          const docRef = await addDoc(filesCol, {
            name: file.name,
            url,
            createdAt: Date.now(),
            size: storedSize ?? null,
            contentType: file.type || '',
            storagePath
          });
          tempEntry.id = docRef.id;
          tempEntry.url = url;
          tempEntry.uploading = false;
          tempEntry.progress = 100;
          tempEntry.createdAt = Date.now();
          tempEntry.size = storedSize ?? tempEntry.size;
          const savedObjectUrl = uploadingObjectUrls.get(tempId);
          if(savedObjectUrl){
            try{ URL.revokeObjectURL(savedObjectUrl); }catch(_){ }
            uploadingObjectUrls.delete(tempId);
          }
          refreshFilesUi();
          const overallPercent = useBytes && totalBytes
            ? Math.round((completedBytes / totalBytes) * 100)
            : Math.round((completedFiles / totalFiles) * 100);
          const message = completedFiles === totalFiles ? 'Finalizando envio...' : `Enviando ${file.name} (100%)`;
          showUploadProgress(overallPercent, message);
        }
        showUploadProgress(100, 'Upload conclu√≠do!');
        if(viewingAllFiles){
          await loadAllFiles();
        } else {
          await loadFiles();
        }
        await refreshStorageUsage();
      }catch(err){
        console.error('uploadFiles', err);
        alert('Falha ao enviar arquivos: ' + (err?.message || String(err)));
        showUploadProgress(0, 'Falha ao enviar.');
        CURRENT_FILES = CURRENT_FILES.filter(file=>!file.uploading);
        refreshFilesUi();
      }finally{
        if(fileInput) fileInput.value = '';
        FILES_UPLOAD_ACTIVE = false;
        updateFilesToolbar();
        setTimeout(hideUploadProgress, 1500);
        uploadingObjectUrls.forEach(url=>{ try{ URL.revokeObjectURL(url); }catch(_){ } });
        uploadingObjectUrls.clear();
      }
    }

    async function loadFiles(){
      if(!filesList){ return; }
      if(!currentFolder){
        renderFolderContents([]);
        return;
      }
      const uid = getUserKey();
      const clientKey = getClientKey();
      if(!uid || !clientKey){
        renderFolderContents([]);
        return;
      }
      try{
        const col = collection(db, 'usuarios', uid, 'clients', clientKey, 'fileFolders', currentFolder, 'files');
        const snap = await getDocs(col);
        const files = snap.docs.map(docSnap=>{
          const data = docSnap.data() || {};
          let createdAt = data.createdAt;
          if(createdAt && typeof createdAt.toMillis === 'function'){
            try{ createdAt = createdAt.toMillis(); }
            catch(_){ createdAt = Date.now(); }
          } else if(createdAt && typeof createdAt.seconds === 'number'){
            createdAt = createdAt.seconds * 1000;
          }
          const sizeValue = Number(data.size);
          const normalizedSize = Number.isFinite(sizeValue) ? sizeValue : null;
          return {
            id: docSnap.id,
            ...data,
            name: data.name || '',
            url: data.url || '',
            createdAt: createdAt ?? null,
            size: normalizedSize,
            contentType: data.contentType || '',
            storagePath: data.storagePath || `usuarios/${uid}/clients/${clientKey}/files/${currentFolder}/${data.name || ''}`,
            folderId: currentFolder,
            folderLabel: getFolderLabel(currentFolder)
          };
        });
        files.sort((a,b)=> (a.name||'').localeCompare(b.name||'', 'pt-BR', { sensitivity:'base', numeric:true }));
        renderFolderContents(files);
      }catch(err){
        console.warn('loadFiles', err);
        renderFolderContents([]);
      }
    }

    async function loadAllFiles(){
      if(!filesList){ return; }
      const uid = getUserKey();
      const clientKey = getClientKey();
      if(!uid || !clientKey){
        renderFolderContents([]);
        return;
      }
      try{
        const aggregated = [];
        for(const folder of FOLDERS){
          const folderId = folder.id;
          const filesCol = collection(db, 'usuarios', uid, 'clients', clientKey, 'fileFolders', folderId, 'files');
          const snap = await getDocs(filesCol);
          const folderLabel = getFolderLabel(folderId);
          snap.docs.forEach(docSnap=>{
            const data = docSnap.data() || {};
            let createdAt = data.createdAt;
            if(createdAt && typeof createdAt.toMillis === 'function'){
              try{ createdAt = createdAt.toMillis(); }
              catch(_){ createdAt = Date.now(); }
            } else if(createdAt && typeof createdAt.seconds === 'number'){
              createdAt = createdAt.seconds * 1000;
            }
            const sizeValue = Number(data.size);
            const normalizedSize = Number.isFinite(sizeValue) ? sizeValue : null;
            aggregated.push({
              id: docSnap.id,
              ...data,
              name: data.name || '',
              url: data.url || '',
              createdAt: createdAt ?? null,
              size: normalizedSize,
              contentType: data.contentType || '',
              storagePath: data.storagePath || `usuarios/${uid}/clients/${clientKey}/files/${folderId}/${data.name || ''}`,
              folderId,
              folderLabel
            });
          });
        }
        aggregated.sort((a,b)=>{
          const folderCompare = (a.folderLabel||'').localeCompare(b.folderLabel||'', 'pt-BR', { sensitivity:'base', numeric:true });
          if(folderCompare !== 0) return folderCompare;
          return (a.name||'').localeCompare(b.name||'', 'pt-BR', { sensitivity:'base', numeric:true });
        });
        if(!viewingAllFiles){
          return;
        }
        renderFolderContents(aggregated);
      }catch(err){
        console.warn('loadAllFiles', err);
        renderFolderContents([]);
      }
    }

    filesList?.addEventListener('keydown', e=>{
      if(e.target.classList?.contains('file-checkbox') && (e.key === ' ' || e.key === 'Spacebar')){
        LAST_BULK_SHIFT = e.shiftKey;
      }
    });

    filesList?.addEventListener('change', e=>{
      const checkbox = e.target.closest?.('.file-checkbox');
      if(checkbox){
        handleFileSelectionToggle(checkbox, LAST_BULK_SHIFT);
        LAST_BULK_SHIFT = false;
        return;
      }
      if(e.target.classList.contains('move-select')){
        const item = e.target.closest('.file-entry');
        const target = e.target.value;
        if(target && item){
          moveFile(item, target);
        }
        e.target.value = '';
      }
    });

    filesSelectAll?.addEventListener('change', e=>{
      const shouldSelect = Boolean(e.target.checked);
      if(shouldSelect){
        CURRENT_FILES.forEach((file, idx)=>{
          if(file && file.id && !file.uploading){
            SELECTED_FILES.add(file.id);
            LAST_SELECTED_INDEX = idx;
          }
        });
      } else {
        CURRENT_FILES.forEach(file=>{
          if(file && file.id){
            SELECTED_FILES.delete(file.id);
          }
        });
        LAST_SELECTED_INDEX = null;
      }
      updateSelectionIndicators();
    });

    filesList?.addEventListener('click', e=>{
      if(e.target.closest('.file-select-box')){
        e.stopPropagation();
      }
      const checkbox = e.target.closest('.file-checkbox');
      if(checkbox){
        e.stopPropagation();
        handleFileSelectionToggle(checkbox, e.shiftKey);
        return;
      }
      const copyBtn = e.target.closest('.copy-link');
      if(copyBtn){
        e.preventDefault();
        e.stopPropagation();
        const item = e.target.closest('.file-entry');
        const fileId = item?.dataset.id;
        if(fileId){
          copyFileLink(fileId);
        }
        return;
      }
      const downloadBtn = e.target.closest('.download-file');
      if(downloadBtn){
        e.preventDefault();
        e.stopPropagation();
        const item = e.target.closest('.file-entry');
        const fileId = item?.dataset.id;
        if(fileId){
          handleFileDownload(fileId);
        }
        return;
      }
      const renameBtn = e.target.closest('.rename-file');
      if(renameBtn){
        e.preventDefault();
        e.stopPropagation();
        const item = e.target.closest('.file-entry');
        const fileId = item?.dataset.id;
        if(fileId){
          renameFileById(fileId);
        }
        return;
      }
      const deleteBtn = e.target.closest('.delete-file');
      if(deleteBtn){
        e.preventDefault();
        e.stopPropagation();
        const item = e.target.closest('.file-entry');
        const fileId = item?.dataset.id;
        if(fileId){
          deleteFileById(fileId);
        }
        return;
      }
      if(e.target.closest('.move-select')) return;
      if(e.target.closest('.file-actions')) return;
      const item = e.target.closest('.file-entry');
      if(!item) return;
      const fileId = item.dataset.id;
      if(!fileId) return;
      const file = CURRENT_FILES.find(f=>f.id === fileId);
      if(file){
        openFilePreview(file);
      }
    });

    filesBulkBar?.addEventListener('click', async e=>{
      const btn = e.target.closest('[data-action]');
      if(!btn || btn.disabled) return;
      e.preventDefault();
      const action = btn.dataset.action;
      if(action === 'delete'){
        await performBulkDelete(getSelectedFiles());
      } else if(action === 'move'){
        await promptBulkMove();
      } else if(action === 'rename'){
        await promptBulkRename();
      }
    });

    filesBulkUndo?.addEventListener('click', async ()=>{
      if(!LAST_UNDO_ACTION || BULK_ACTION_RUNNING) return;
      BULK_ACTION_RUNNING = true;
      setBulkStatus('Desfazendo...');
      try{
        await LAST_UNDO_ACTION.handler();
        if(typeof mgToast === 'function'){
          mgToast('A√ß√£o desfeita.');
        }
        setUndoAction(null);
        if(viewingAllFiles){
          await loadAllFiles();
        } else {
          await loadFiles();
        }
        await refreshStorageUsage();
      }catch(err){
        console.warn('bulkUndo', err);
        alert('N√£o foi poss√≠vel desfazer a a√ß√£o. Verifique o console.');
      }finally{
        BULK_ACTION_RUNNING = false;
        clearBulkStatus();
        updateSelectionIndicators();
      }
    });

    function copyFileLink(fileId){
      const file = findFileById(fileId);
      if(!file){
        alert('Arquivo n√£o encontrado.');
        return;
      }
      if(file.uploading){
        alert('Aguarde o envio terminar para copiar o link deste arquivo.');
        return;
      }
      if(!file.url){
        alert('Link indispon√≠vel para este arquivo.');
        return;
      }
      const clipboard = typeof navigator !== 'undefined' ? navigator.clipboard : null;
      if(clipboard?.writeText){
        clipboard.writeText(file.url).then(()=>{
          alert('Link copiado com sucesso!');
        }).catch(err=>{
          console.warn('copyFileLink', err);
          alert('N√£o foi poss√≠vel copiar o link do arquivo.');
        });
        return;
      }
      let tempInput;
      try{
        tempInput = document.createElement('input');
        tempInput.type = 'text';
        tempInput.value = file.url;
        tempInput.setAttribute('readonly', '');
        tempInput.style.position = 'fixed';
        tempInput.style.opacity = '0';
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand('copy');
        alert('Link copiado com sucesso!');
      }catch(err){
        console.warn('copyFileLink fallback', err);
        alert('N√£o foi poss√≠vel copiar o link do arquivo.');
      }finally{
        if(tempInput && tempInput.parentNode){
          tempInput.parentNode.removeChild(tempInput);
        }
      }
    }

    function findFileById(fileId){
      if(!fileId) return null;
      return CURRENT_FILES.find(f=>f.id === fileId) || null;
    }

    function handleFileDownload(fileId){
      const file = findFileById(fileId);
      if(!file){
        alert('Arquivo n√£o encontrado.');
        return;
      }
      if(file.uploading){
        alert('Aguarde o envio terminar para baixar este arquivo.');
        return;
      }
      if(!file.url){
        alert('URL do arquivo indispon√≠vel para download.');
        return;
      }
      try{
        const link = document.createElement('a');
        link.href = file.url;
        link.target = '_blank';
        link.rel = 'noopener';
        if(file.name){
          link.download = file.name;
        }
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        setTimeout(()=>{
          document.body.removeChild(link);
        }, 0);
      }catch(err){
        console.warn('handleFileDownload', err);
        alert('N√£o foi poss√≠vel iniciar o download do arquivo.');
      }
    }

    async function deleteFileRecord(file, uid, clientKey){
      const folderId = normalizeParent(file.folderId ?? currentFolder);
      if(!folderId){
        throw new Error('Pasta do arquivo n√£o encontrada.');
      }
      const storagePath = file.storagePath || `usuarios/${uid}/clients/${clientKey}/files/${folderId}/${file.name || ''}`;
      if(storagePath){
        try{
          if(!STORAGE){
            STORAGE = getStorage(app);
          }
          const storageRef = sRef(STORAGE, storagePath);
          await deleteObject(storageRef);
        }catch(err){
          console.warn('deleteFileRecord storage', err);
        }
      }
      const docRef = doc(db, 'usuarios', uid, 'clients', clientKey, 'fileFolders', folderId, 'files', file.id);
      await deleteDoc(docRef);
    }

    async function restoreDeletedFile(file, blob, uid, clientKey){
      const folderId = normalizeParent(file.folderId ?? currentFolder);
      if(!folderId){
        throw new Error('Pasta original do arquivo n√£o localizada.');
      }
      if(!blob){
        throw new Error('N√£o foi poss√≠vel restaurar o arquivo, conte√∫do indispon√≠vel.');
      }
      if(!STORAGE){
        STORAGE = getStorage(app);
      }
      const storagePath = file.storagePath || `usuarios/${uid}/clients/${clientKey}/files/${folderId}/${file.name || ''}`;
      const storageRef = sRef(STORAGE, storagePath);
      await uploadBytes(storageRef, blob);
      const url = await getDownloadURL(storageRef);
      const docRef = doc(db, 'usuarios', uid, 'clients', clientKey, 'fileFolders', folderId, 'files', file.id);
      const payload = {
        name: file.name || '',
        url,
        createdAt: file.createdAt ?? Date.now(),
        size: Number.isFinite(file.size) ? file.size : (typeof blob.size === 'number' ? blob.size : null),
        contentType: file.contentType || blob.type || '',
        storagePath,
        folderId: file.folderId ?? folderId
      };
      await setDoc(docRef, payload);
    }

    async function fetchFileBlob(file){
      if(!file || !file.url){
        throw new Error('Arquivo sem URL dispon√≠vel.');
      }
      const response = await fetch(file.url);
      if(!response.ok){
        throw new Error(`Falha ao acessar o arquivo (${response.status}).`);
      }
      return await response.blob();
    }

    async function performBulkDelete(files, options = {}){
      const list = Array.isArray(files) ? files.filter(Boolean) : [];
      if(!list.length){
        alert('Nenhum arquivo selecionado.');
        return;
      }
      const ready = list.filter(file=>!file.uploading);
      if(!ready.length){
        alert('Aguarde o envio terminar para excluir arquivos.');
        return;
      }
      if(ready.length !== list.length){
        alert('Arquivos em envio foram ignorados na exclus√£o.');
      }
      const confirmMessage = options.confirmMessage
        || (ready.length === 1
          ? `Excluir o arquivo "${ready[0].name || 'arquivo'}"? Esta a√ß√£o n√£o pode ser desfeita.`
          : `Excluir ${ready.length} arquivos selecionados? Esta a√ß√£o n√£o pode ser desfeita.`);
      if(!options.skipConfirm){
        const confirmed = confirm(confirmMessage);
        if(!confirmed) return;
      }
      const uid = getUserKey();
      const clientKey = getClientKey();
      if(!uid || !clientKey){
        alert('Fa√ßa login para excluir arquivos.');
        return;
      }
      try{
        await requireAuthUser();
      }catch(err){
        console.warn('performBulkDelete auth', err);
        alert('Fa√ßa login para excluir arquivos.');
        return;
      }
      BULK_ACTION_RUNNING = true;
      setBulkStatus('Preparando exclus√£o...');
      const backups = [];
      for(let i = 0; i < ready.length; i++){
        const file = ready[i];
        let blob = null;
        try{
          setBulkStatus(`Salvando c√≥pia ${i + 1}/${ready.length}...`);
          blob = await fetchFileBlob(file);
        }catch(err){
          console.warn('performBulkDelete fetch', err);
        }
        backups.push({ file, blob });
      }
      const errors = [];
      for(let i = 0; i < ready.length; i++){
        const file = ready[i];
        setBulkStatus(`Excluindo ${i + 1}/${ready.length}...`);
        try{
          await deleteFileRecord(file, uid, clientKey);
          SELECTED_FILES.delete(file.id);
        }catch(err){
          console.warn('performBulkDelete delete', err);
          errors.push({ file, error: err });
        }
      }
      BULK_ACTION_RUNNING = false;
      clearBulkStatus();
      updateSelectionIndicators();
      if(errors.length){
        alert('Alguns arquivos n√£o puderam ser exclu√≠dos. Verifique o console para detalhes.');
      } else if(ready.length){
        if(typeof mgToast === 'function'){
          mgToast(ready.length > 1 ? 'Arquivos exclu√≠dos.' : 'Arquivo exclu√≠do.');
        }
      }
      const restorable = backups.filter(entry=>entry.file && entry.file.id && entry.blob);
      if(restorable.length){
        setUndoAction({
          label: 'delete',
          async handler(){
            const undoUid = getUserKey();
            const undoClient = getClientKey();
            if(!undoUid || !undoClient){
              throw new Error('Fa√ßa login para desfazer.');
            }
            try{
              await requireAuthUser();
            }catch(err){
              throw err;
            }
            for(let i = 0; i < restorable.length; i++){
              const { file, blob } = restorable[i];
              setBulkStatus(`Restaurando ${i + 1}/${restorable.length}...`);
              await restoreDeletedFile(file, blob, undoUid, undoClient);
            }
          }
        });
      } else {
        setUndoAction(null);
      }
      if(filePreviewModal?.dataset.fileId && ready.some(f=>f.id === filePreviewModal.dataset.fileId)){
        closeFilePreview();
      }
      if(viewingAllFiles){
        await loadAllFiles();
      } else {
        await loadFiles();
      }
      await refreshStorageUsage();
      clearBulkStatus();
    }

    function chooseDestinationFolder(){
      const options = FOLDERS.map(folder=>({ id: folder.id, label: getFolderLabel(folder.id) }))
        .filter(opt=>opt.id)
        .sort((a,b)=> a.label.localeCompare(b.label, 'pt-BR', { sensitivity:'base', numeric:true }));
      if(!options.length){
        alert('Crie outra pasta antes de mover arquivos.');
        return null;
      }
      const message = 'Mover para qual pasta? Digite o n√∫mero correspondente:\n'
        + options.map((opt, idx)=>`${idx} - ${opt.label}`).join('\n');
      const input = prompt(message, '0');
      if(input === null) return null;
      const index = Number(input.trim());
      if(!Number.isInteger(index) || index < 0 || index >= options.length){
        alert('Op√ß√£o inv√°lida.');
        return null;
      }
      return options[index].id;
    }

    async function getExistingNamesInFolder(folderId, uid, clientKey){
      const colRef = collection(db, 'usuarios', uid, 'clients', clientKey, 'fileFolders', folderId, 'files');
      const snap = await getDocs(colRef);
      return snap.docs.map(docSnap=>((docSnap.data()?.name || '').trim().toLowerCase())).filter(Boolean);
    }

    async function moveFileToFolder(file, blob, uid, clientKey, destinationFolderId){
      const sourceFolderId = normalizeParent(file.folderId ?? currentFolder);
      const destId = normalizeParent(destinationFolderId);
      if(!destId || !sourceFolderId){
        throw new Error('Pasta inv√°lida para movimenta√ß√£o.');
      }
      if(!blob){
        throw new Error('Conte√∫do do arquivo indispon√≠vel.');
      }
      if(!STORAGE){
        STORAGE = getStorage(app);
      }
      const newPath = `usuarios/${uid}/clients/${clientKey}/files/${destId}/${file.name || ''}`;
      const newRef = sRef(STORAGE, newPath);
      await uploadBytes(newRef, blob);
      const newUrl = await getDownloadURL(newRef);
      const docRef = doc(db, 'usuarios', uid, 'clients', clientKey, 'fileFolders', destId, 'files', file.id);
      const payload = {
        name: file.name || '',
        url: newUrl,
        createdAt: file.createdAt ?? Date.now(),
        size: Number.isFinite(file.size) ? file.size : (typeof blob.size === 'number' ? blob.size : null),
        contentType: file.contentType || blob.type || '',
        storagePath: newPath,
        folderId: destId
      };
      await setDoc(docRef, payload);
      const oldPath = file.storagePath || `usuarios/${uid}/clients/${clientKey}/files/${sourceFolderId}/${file.name || ''}`;
      try{
        const oldRef = sRef(STORAGE, oldPath);
        await deleteObject(oldRef);
      }catch(err){
        console.warn('moveFileToFolder delete old', err);
      }
      const oldDoc = doc(db, 'usuarios', uid, 'clients', clientKey, 'fileFolders', sourceFolderId, 'files', file.id);
      await deleteDoc(oldDoc);
      return { storagePath: newPath, url: newUrl, oldPath, destinationFolderId: destId, sourceFolderId };
    }

    async function performBulkMove(files, destinationFolderId){
      const list = Array.isArray(files) ? files.filter(file=>file && !file.uploading) : [];
      if(!list.length){
        alert('Selecione arquivos v√°lidos para mover.');
        return;
      }
      const destId = normalizeParent(destinationFolderId);
      if(!destId){
        alert('Escolha uma pasta v√°lida para mover.');
        return;
      }
      const uid = getUserKey();
      const clientKey = getClientKey();
      if(!uid || !clientKey){
        alert('Fa√ßa login para mover arquivos.');
        return;
      }
      try{
        await requireAuthUser();
      }catch(err){
        console.warn('performBulkMove auth', err);
        alert('Fa√ßa login para mover arquivos.');
        return;
      }
      const movable = list.filter(file=>normalizeParent(file.folderId ?? currentFolder) !== destId);
      if(!movable.length){
        alert('Os arquivos selecionados j√° est√£o nessa pasta.');
        return;
      }
      BULK_ACTION_RUNNING = true;
      setBulkStatus('Validando destino...');
      const existingNames = new Set(await getExistingNamesInFolder(destId, uid, clientKey));
      const executed = [];
      const errors = [];
      for(let i = 0; i < movable.length; i++){
        const file = movable[i];
        const nameKey = (file.name || '').trim().toLowerCase();
        if(existingNames.has(nameKey)){
          errors.push({ file, error: new Error('Arquivo duplicado no destino.') });
          continue;
        }
        setBulkStatus(`Movendo ${i + 1}/${movable.length}...`);
        try{
          const blob = await fetchFileBlob(file);
          const result = await moveFileToFolder(file, blob, uid, clientKey, destId);
          existingNames.add(nameKey);
          executed.push({ file, blob, result });
          SELECTED_FILES.delete(file.id);
        }catch(err){
          console.warn('performBulkMove item', err);
          errors.push({ file, error: err });
        }
      }
      BULK_ACTION_RUNNING = false;
      clearBulkStatus();
      updateSelectionIndicators();
      if(errors.length && errors.length === movable.length){
        alert('N√£o foi poss√≠vel mover os arquivos selecionados. Verifique o console.');
      } else if(errors.length){
        alert('Alguns arquivos n√£o foram movidos. Verifique o console.');
      } else if(executed.length){
        if(typeof mgToast === 'function'){
          mgToast(executed.length > 1 ? 'Arquivos movidos.' : 'Arquivo movido.');
        }
      }
      if(executed.length){
        setUndoAction({
          label: 'move',
          async handler(){
            const undoUid = getUserKey();
            const undoClient = getClientKey();
            if(!undoUid || !undoClient){
              throw new Error('Fa√ßa login para desfazer.');
            }
            await requireAuthUser();
            for(let i = 0; i < executed.length; i++){
              const entry = executed[i];
              setBulkStatus(`Restaurando ${i + 1}/${executed.length}...`);
              const payloadFile = {
                ...entry.file,
                folderId: entry.result.destinationFolderId,
                storagePath: entry.result.storagePath,
                url: entry.result.url
              };
              await moveFileToFolder(payloadFile, entry.blob, undoUid, undoClient, entry.result.sourceFolderId);
            }
          }
        });
      } else {
        setUndoAction(null);
      }
      if(viewingAllFiles){
        await loadAllFiles();
      } else {
        await loadFiles();
      }
      await refreshStorageUsage();
      clearBulkStatus();
    }

    async function promptBulkMove(){
      const files = getSelectedFiles();
      if(!files.length){
        alert('Selecione arquivos para mover.');
        return;
      }
      const destination = chooseDestinationFolder();
      if(!destination) return;
      await performBulkMove(files, destination);
    }

    async function performBulkRename(files, pattern){
      const list = Array.isArray(files) ? files.filter(file=>file && !file.uploading) : [];
      if(!list.length){
        alert('Selecione arquivos v√°lidos para renomear.');
        return;
      }
      const trimmedPattern = (pattern || '').trim();
      if(!trimmedPattern){
        alert('Informe um nome v√°lido.');
        return;
      }
      const total = list.length;
      const padLength = String(total).length;
      const usesSequence = trimmedPattern.includes('{n}');
      const renameMap = [];
      for(let i = 0; i < total; i++){
        const file = list[i];
        const originalName = file.name || '';
        let baseName = trimmedPattern;
        if(total > 1){
          if(usesSequence){
            const seq = String(i + 1).padStart(padLength, '0');
            baseName = trimmedPattern.replace(/\{n\}/gi, seq);
          } else {
            baseName = `${trimmedPattern} (${i + 1})`;
          }
        }
        const { name: desiredName, error } = buildRenamedFileName(baseName, originalName);
        if(error === 'empty' || !desiredName){
          alert('Informe um nome v√°lido para os arquivos.');
          return;
        }
        if(error === 'extension'){
          alert('N√£o √© permitido alterar a extens√£o do arquivo.');
          return;
        }
        renameMap.push({ file, newName: desiredName });
      }
      const seenKeys = new Set();
      for(const entry of renameMap){
        const folderId = normalizeParent(entry.file.folderId ?? currentFolder) || 'root';
        const key = `${folderId}::${entry.newName.trim().toLowerCase()}`;
        if(seenKeys.has(key)){
          alert('Os nomes gerados entram em conflito entre si. Ajuste o padr√£o informado.');
          return;
        }
        seenKeys.add(key);
      }
      const conflict = renameMap.find(entry=>{
        const folderId = normalizeParent(entry.file.folderId ?? currentFolder);
        const nameKey = entry.newName.trim().toLowerCase();
        return CURRENT_FILES.some(other=>{
          if(other.id === entry.file.id) return false;
          const otherFolder = normalizeParent(other.folderId ?? currentFolder);
          if(otherFolder !== folderId) return false;
          return (other.name || '').trim().toLowerCase() === nameKey;
        });
      });
      if(conflict){
        alert(`J√° existe um arquivo chamado "${conflict.newName}" na pasta de destino.`);
        return;
      }
      const uid = getUserKey();
      const clientKey = getClientKey();
      if(!uid || !clientKey){
        alert('Fa√ßa login para renomear arquivos.');
        return;
      }
      try{
        await requireAuthUser();
      }catch(err){
        console.warn('performBulkRename auth', err);
        alert('Fa√ßa login para renomear arquivos.');
        return;
      }
      const previewOpenId = (filePreviewModal && filePreviewModal.classList.contains('show'))
        ? (filePreviewModal.dataset.fileId || null)
        : null;
      BULK_ACTION_RUNNING = true;
      setBulkStatus('Renomeando arquivos...');
      const executed = [];
      for(let i = 0; i < renameMap.length; i++){
        const { file, newName } = renameMap[i];
        setBulkStatus(`Renomeando ${i + 1}/${renameMap.length}...`);
        try{
          const folderId = normalizeParent(file.folderId ?? currentFolder);
          if(!folderId){
            throw new Error('Pasta n√£o encontrada para o arquivo.');
          }
          const docRef = doc(db, 'usuarios', uid, 'clients', clientKey, 'fileFolders', folderId, 'files', file.id);
          const previousName = file.name || '';
          await updateDoc(docRef, { name: newName });
          file.name = newName;
          executed.push({ file, oldName: previousName, newName, folderId });
        }catch(err){
          console.warn('performBulkRename item', err);
          alert('N√£o foi poss√≠vel renomear um dos arquivos. Verifique o console.');
          BULK_ACTION_RUNNING = false;
          clearBulkStatus();
          updateSelectionIndicators();
          return;
        }
      }
      BULK_ACTION_RUNNING = false;
      clearBulkStatus();
      updateSelectionIndicators();
      if(executed.length){
        if(typeof mgToast === 'function'){
          mgToast(executed.length > 1 ? 'Arquivos renomeados.' : 'Arquivo renomeado.');
        }
        setUndoAction({
          label: 'rename',
          async handler(){
            const undoUid = getUserKey();
            const undoClient = getClientKey();
            if(!undoUid || !undoClient){
              throw new Error('Fa√ßa login para desfazer.');
            }
            await requireAuthUser();
            for(let i = 0; i < executed.length; i++){
              const entry = executed[i];
              setBulkStatus(`Restaurando ${i + 1}/${executed.length}...`);
              const docRef = doc(db, 'usuarios', undoUid, 'clients', undoClient, 'fileFolders', entry.folderId, 'files', entry.file.id);
              await updateDoc(docRef, { name: entry.oldName });
              entry.file.name = entry.oldName;
            }
          }
        });
      } else {
        setUndoAction(null);
      }
      if(viewingAllFiles){
        await loadAllFiles();
      } else {
        await loadFiles();
      }
      if(previewOpenId){
        const updated = findFileById(previewOpenId);
        if(updated){
          openFilePreview(updated);
        } else if(filePreviewModal?.classList.contains('show')){
          closeFilePreview();
        }
      }
    }

    async function promptBulkRename(preselected){
      const files = Array.isArray(preselected) && preselected.length ? preselected : getSelectedFiles();
      if(!files.length){
        alert('Selecione arquivos para renomear.');
        return;
      }
      const ready = files.filter(file=>!file.uploading);
      if(!ready.length){
        alert('Aguarde o envio terminar para renomear estes arquivos.');
        return;
      }
      const defaultValue = ready.length === 1 ? (ready[0].name || '') : '';
      const message = ready.length === 1
        ? 'Novo nome para o arquivo:'
        : 'Novo nome base. Use {n} para inserir numera√ß√£o sequencial:';
      const input = prompt(message, defaultValue);
      if(input === null) return;
      await performBulkRename(ready, input);
    }

    async function deleteFileById(fileId){
      const file = findFileById(fileId);
      if(!file){
        alert('Arquivo n√£o encontrado.');
        return;
      }
      if(file.uploading){
        alert('Aguarde o envio terminar para excluir este arquivo.');
        return;
      }
      await performBulkDelete([file]);
    }

    function buildRenamedFileName(rawInput, originalName){
      const cleaned = (rawInput ?? '').replace(/[\\/:*?"<>|]/g,'_').trim();
      if(!cleaned){
        return { name: '', error: 'empty' };
      }
      const original = String(originalName || '');
      const dotIndex = original.lastIndexOf('.');
      const originalExt = dotIndex > -1 ? original.slice(dotIndex + 1) : '';
      if(!originalExt){
        return { name: cleaned, error: null };
      }
      const lowerOriginalExt = originalExt.toLowerCase();
      const lastDot = cleaned.lastIndexOf('.');
      if(lastDot > -1){
        const inputExt = cleaned.slice(lastDot + 1);
        if(inputExt.toLowerCase() !== lowerOriginalExt){
          return { name: '', error: 'extension' };
        }
        return { name: cleaned, error: null };
      }
      return { name: `${cleaned}.${originalExt}`, error: null };
    }

    async function renameFileById(fileId){
      const file = findFileById(fileId);
      if(!file){
        alert('Arquivo n√£o encontrado.');
        return;
      }
      if(file.uploading){
        alert('Aguarde o envio terminar para renomear este arquivo.');
        return;
      }
      await promptBulkRename([file]);
    }

    async function moveFile(item, targetFolder){
      const fileId = item.dataset.id;
      if(!fileId) return;
      const file = CURRENT_FILES.find(f=>f.id === fileId);
      if(!file) return;
      await performBulkMove([file], targetFolder);
    }

    newFolderBtn?.addEventListener('click', createFolder);

    async function createFolder(){
      const name = (prompt('Nome da pasta:')||'').trim();
      if(!name) return;
      const uid = getUserKey();
      const clientKey = getClientKey();
      if(!uid || !clientKey){ alert('Fa√ßa login para criar pastas.'); return; }
      const parentId = normalizeParent(currentFolder);
      const col = collection(db, 'usuarios', uid, 'clients', clientKey, 'fileFolders');
      const docRef = await addDoc(col, { name, parentId: parentId || null, createdAt: Date.now() });
      const newFolder = { id: docRef.id, name, parentId };
      FOLDERS.push(newFolder);
      selectFolder(docRef.id);
    }


    /* ========= widgets with stable IDs ========= */
    let WIDGETS = [];
    const k = (suffix)=> `${currentSection}-${suffix}`;
    function sanitizeUrl(raw){ let s=(raw||"").trim(); if(!s) return ""; if(!/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(s)) s="https://"+s;
      try{ const u=new URL(s); if(!/^https?:$/.test(u.protocol)) return ""; return u.toString(); }catch{ return ""; } }
    const getHost = (url)=>{ try{ return url? new URL(url).hostname : ""; }catch{ return ""; } };
    const findIndexById = (id)=> WIDGETS.findIndex(w=>w.id===id);

    function migrateOldFormatIfNeeded(){
      const arr = USER_DATA[k("widgets")];
      if(Array.isArray(arr) && arr.length){
        return arr.map(w=> ({ id: w.id || uuid(), title: w.title||"", url: w.url||"", embed: w.embed||"", h: w.h, order: w.order??0 }));
      }
      const hasOld = Object.keys(USER_DATA||{}).some(f=>f.startsWith(`${currentSection}-widget-`)||f===`${currentSection}-widgetOrder`);
      if(!hasOld) return [{ id: uuid(), title:`Widget 1`, url:""}];
      const tmp = [];
      let i=0;
      while(USER_DATA.hasOwnProperty(k(`widget-${i}-title`)) || USER_DATA.hasOwnProperty(k(`widget-${i}-url`))){
        tmp.push({ id: uuid(), title: USER_DATA[k(`widget-${i}-title`)] || `Widget ${i+1}`, url: USER_DATA[k(`widget-${i}-url`)] || "" });
        i++;
      }
      return tmp.length?tmp:[{id:uuid(),title:"Widget 1", url:""}];
    }

    async function loadWidgetsFromData(){
      let arr = Array.isArray(USER_DATA[k("widgets")]) ? [...USER_DATA[k("widgets")]] : migrateOldFormatIfNeeded();
      if(!arr || arr.length === 0){
        let title = "Widget 1";
        if(currentSection==="refSocial") title = "Refer√™ncia Rede 1";
        else if(currentSection==="concorrentes") title = "Concorrente 1";
        arr = [{ id: uuid(), title, url: "" }];
        await persistWidgets();
      } else {
        arr = arr.map(w=> ({ id: w.id||uuid(), title:w.title||"", url:w.url||"", embed:w.embed||"", h:w.h, order:w.order??0 })).sort((a,b)=>(a.order??0)-(b.order??0));
      }
      WIDGETS = arr;
    }

    async function persistWidgets(){
      const uid=auth.currentUser?.uid; if(!uid) return;
      WIDGETS = WIDGETS.map((w,i)=>({...w, order:i}));
      USER_DATA[k("widgets")] = WIDGETS;
      await setDoc(doc(db,"usuarios",uid), { [k("widgets")]: WIDGETS }, { merge:true });
    }

    function renderWidgets(){
      widgetsGrid.innerHTML="";
      WIDGETS.forEach((w,i)=> widgetsGrid.appendChild(createWidgetCard(w)));
      setupDragAndDrop();
    }

    function createWidgetCard(w){
      const index = WIDGETS.findIndex(x=>x.id===w.id);
      const card=document.createElement("div"); card.className="widget-card"; card.dataset.id=w.id;
      const host=getHost(w.url);
      card.innerHTML=`
        <div class="widget-head" draggable="true">
          <div class="widget-title" title="${w.title||`Widget`}">${w.title||`Widget`}</div>
          <div class="widget-meta">${host}</div>
          <div class="widget-actions">
            <button class="icon-btn btn-dup" title="Duplicar">‚ßâ</button>
            <button class="icon-btn btn-up"  title="Mover para cima">‚Üë</button>
            <button class="icon-btn btn-down" title="Mover para baixo">‚Üì</button>
            <button class="icon-btn danger btn-del" title="Fechar">‚®â</button>
          </div>
        </div>
        <div class="widget-input">
          <input class="input w-title" type="text" placeholder="T√≠tulo do painel" value="${w.title||""}">
          <input class="input w-url"   type="text" placeholder="Cole o link (https://...) ou c√≥digo embed" value="${w.url||w.embed||""}">
        </div>
        <div class="frame-shell">${
          w.embed ? w.embed :
          `<iframe class="widget-iframe" title="Widget" loading="lazy"
            sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox"
            referrerpolicy="no-referrer" ${w.url? `src="${sanitizeUrl(w.url)}"`:""}></iframe>`
        }</div>`;

      const inputTitle=card.querySelector(".w-title"), inputUrl=card.querySelector(".w-url");
      const titleEl=card.querySelector(".widget-title"), metaEl=card.querySelector(".widget-meta");
      const iframe=card.querySelector("iframe");
      const shell=card.querySelector(".frame-shell");

      // reexecuta scripts se embed salvo
      if(w.embed){ mountEmbed(shell, w.embed); }
      if(typeof w.h === "number" && w.h>0){ shell.style.height = w.h + "px"; }

      // salvar altura com ID est√°vel
      let __heightTimer=null;
      function saveHeightDebounced(){
        clearTimeout(__heightTimer);
        __heightTimer=setTimeout(async()=>{
          const h=Math.round(shell.getBoundingClientRect().height);
          if(!Number.isFinite(h) || h<=0) return;
          const idx=findIndexById(w.id);
          if(idx<0) return;
          WIDGETS[idx] = { ...(WIDGETS[idx]||{}), h };
          await persistWidgets();
        }, 400);
      }
      try{
        const ro=new ResizeObserver(()=> saveHeightDebounced());
        ro.observe(shell);
      }catch(e){ shell.addEventListener("mouseup", saveHeightDebounced); shell.addEventListener("touchend", saveHeightDebounced); }

      const btnUp=card.querySelector(".btn-up"), btnDown=card.querySelector(".btn-down");
      const btnDup=card.querySelector(".btn-dup"), btnDel=card.querySelector(".btn-del");
      const head=card.querySelector(".widget-head");

      if(!w.url && !w.embed) card.classList.add("editing");

      const apply = async ()=>{
        const t=(inputTitle.value||"").trim() || `Widget`;
        const raw=(inputUrl.value||"").trim();
        const idx=findIndexById(w.id);
        if(idx<0) return;
        let newData={ ...(WIDGETS[idx]||{}), title:t, url:"", embed:"" };

        if(raw.startsWith("<")){
          newData.embed = raw;
          mountEmbed(shell, raw);
          metaEl.textContent = "embed";
        } else {
          const u=sanitizeUrl(raw);
          newData.url = u;
          titleEl.textContent=t; titleEl.title=t; metaEl.textContent=getHost(u);
          if(u){ if(iframe){ iframe.src="about:blank"; setTimeout(()=>{ iframe.src=u; },0); } else {
            shell.innerHTML = `<iframe class="widget-iframe" title="Widget" loading="lazy"
              sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox"
              referrerpolicy="no-referrer" src="${u}"></iframe>`;
          } } else { if(iframe){ iframe.removeAttribute("src"); } }
        }

        WIDGETS[idx] = newData;
        titleEl.textContent=t; titleEl.title=t;
        card.classList.remove("editing");
        await persistWidgets();
      };
      inputTitle.addEventListener("keydown",(e)=>{ if(e.key==="Enter") apply(); });
      inputUrl  .addEventListener("keydown",(e)=>{ if(e.key==="Enter") apply(); });
      // s√≥ fecha edi√ß√£o ao clicar FORA do card, n√£o fora do documento todo
      card.addEventListener("focusout",(ev)=>{
        if(!card.contains(ev.relatedTarget)){ apply(); }
      });
      card.addEventListener("dblclick",()=>{ card.classList.add("editing"); inputTitle.focus(); setTimeout(()=>{ const v=inputTitle.value; inputTitle.selectionStart=inputTitle.selectionEnd=v.length; },0); });

      iframe?.addEventListener("mouseenter", showScrollHintTemporario);

      btnUp.addEventListener("click", async ()=>{
        const idx=findIndexById(w.id); if(idx<=0) return;
        const it=WIDGETS.splice(idx,1)[0]; WIDGETS.splice(idx-1,0,it);
        await persistWidgets(); renderWidgets();
      });
      btnDown.addEventListener("click", async ()=>{
        const idx=findIndexById(w.id); if(idx<0 || idx>=WIDGETS.length-1) return;
        const it=WIDGETS.splice(idx,1)[0]; WIDGETS.splice(idx+1,0,it);
        await persistWidgets(); renderWidgets();
      });
      btnDup.addEventListener("click", async ()=>{
        const idx=findIndexById(w.id); if(idx<0) return;
        const copy={...WIDGETS[idx], id: uuid()};
        WIDGETS.splice(idx+1,0,copy);
        await persistWidgets(); renderWidgets();
      });
      btnDel.addEventListener("click", async ()=>{
        if(!confirm("Remover este painel?")) return;
        const idx=findIndexById(w.id); if(idx<0) return;
        WIDGETS.splice(idx,1);
        if(WIDGETS.length===0){ WIDGETS=[{id:uuid(), title:"Widget 1", url:""}]; }
        await persistWidgets(); renderWidgets();
      });

      head.addEventListener("dragstart",(e)=>{ card.classList.add("dragging"); e.dataTransfer.effectAllowed="move"; e.dataTransfer.setData("text/plain",w.id); });
      head.addEventListener("dragend",()=>{ card.classList.remove("dragging"); removePlaceholder(); });

      return card;
    }

    /* drag & drop */
    let placeholder=null;
    function createPlaceholder(){ if(!placeholder){ placeholder=document.createElement("div"); placeholder.className="drag-placeholder"; } return placeholder; }
    function removePlaceholder(){ if(placeholder && placeholder.parentNode){ placeholder.parentNode.removeChild(placeholder); } }
    function setupDragAndDrop(){
      widgetsGrid.addEventListener("dragover",(e)=>{
        e.preventDefault();
        const dragging = widgetsGrid.querySelector(".widget-card.dragging"); if(!dragging) return;
        const after = getDragAfterElement(e.clientY); const ph=createPlaceholder();
        if(after==null) widgetsGrid.appendChild(ph); else widgetsGrid.insertBefore(ph,after);
      });
      widgetsGrid.addEventListener("drop", async (e)=>{
        const dragging = widgetsGrid.querySelector(".widget-card.dragging"); if(!dragging) return;
        const movingId = dragging.dataset.id;
        const phIndex = [...widgetsGrid.children].indexOf(placeholder);
        const from = findIndexById(movingId);
        let to = phIndex;
        const actualChildren = [...widgetsGrid.children].filter(el=>!el.classList.contains("drag-placeholder"));
        const afterEl = getDragAfterElement(e.clientY);
        to = afterEl ? actualChildren.indexOf(afterEl) : actualChildren.length;
        if(to>from) to = to-1;
        const item=WIDGETS.splice(from,1)[0]; WIDGETS.splice(to,0,item);
        await persistWidgets(); renderWidgets();
      });
    }
    function getDragAfterElement(y){
      const els=[...widgetsGrid.querySelectorAll(".widget-card:not(.dragging)")];
      return els.reduce((closest,child)=>{
        const box=child.getBoundingClientRect(); const offset=y - box.top - box.height/2;
        if(offset<0 && offset>closest.offset){ return {offset,element:child}; } else { return closest; }
      },{offset:Number.NEGATIVE_INFINITY}).element;
    }

    /* ========= Concorrentes ========= */
    let COMPETITORS = [];
    const COMP_CACHE_PREFIX = 'competitors_';
    function competitorsCacheKey(){
      const client = getClientKey();
      if(!client) return 'competitorsList';
      return COMP_CACHE_PREFIX + client;
    }
    async function loadCompetitors(){
      const uid = getUserKey();
      const clientKey = getClientKey();
      COMPETITORS = [];
      if(uid && clientKey){
        const safeClient = clientKey.replace(/[^\w-]/g,'_');
        try{
          let snap = await getDoc(doc(db, 'usuarios', uid, 'clients', safeClient));
          if(!snap.exists() && safeClient !== clientKey){
            snap = await getDoc(doc(db, 'usuarios', uid, 'clients', clientKey));
          }
          if(snap.exists()){
            const data = snap.data() || {};
            if(Array.isArray(data.competitors)){
              COMPETITORS = data.competitors.map(item=>({ ...item }));
            }
          }
        }catch(err){
          console.warn('loadCompetitors firebase', err);
        }
      }
      if(!Array.isArray(COMPETITORS) || !COMPETITORS.length){
        const storageKey = competitorsCacheKey();
        try{
          const cached = JSON.parse(localStorage.getItem(storageKey) || localStorage.getItem('competitorsList') || '[]');
          if(Array.isArray(cached)) COMPETITORS = cached;
        }catch(_){ COMPETITORS = []; }
      }
      const stateKey = clientKey ? `competitors-${clientKey}` : 'competitors';
      const fromUserData = USER_DATA?.[stateKey] || USER_DATA?.competitors;
      if(Array.isArray(fromUserData) && fromUserData.length){
        COMPETITORS = fromUserData.map(item=>({ ...item }));
      }
      if(!Array.isArray(COMPETITORS)) COMPETITORS = [];
      USER_DATA.competitors = COMPETITORS;
      if(stateKey){ USER_DATA[stateKey] = COMPETITORS; }
      try{ localStorage.setItem(competitorsCacheKey(), JSON.stringify(COMPETITORS)); }
      catch(_){ }
      try{ refreshMacroInsights(); }catch(_){ }
    }
    async function persistCompetitors(){
      try{ localStorage.setItem(competitorsCacheKey(), JSON.stringify(COMPETITORS)); }
      catch(_){ }
      USER_DATA.competitors = COMPETITORS;
      const clientKey = getClientKey();
      if(clientKey){ USER_DATA[`competitors-${clientKey}`] = COMPETITORS; }
      const uid = getUserKey();
      if(uid && clientKey){
        const safeClient = clientKey.replace(/[^\w-]/g,'_');
        try{
          await setDoc(doc(db, 'usuarios', uid, 'clients', safeClient), { competitors: COMPETITORS }, { merge: true });
        }catch(err){
          console.error('persistCompetitors', err);
        }
      }
      try{ refreshMacroInsights(); }catch(_){ }
    }
    function renderCompetitors(){
      const tbody = $("competitorsTable")?.querySelector("tbody");
      if(!tbody) return;
      tbody.innerHTML = "";
      COMPETITORS.forEach((c, idx)=>{
        const tr = document.createElement("tr");
        const link = sanitizeUrl(c.link);
        tr.innerHTML = `
          <td>${c.name||""}</td>
          <td><a href="${link}" target="_blank" rel="noopener">${c.link||""}</a></td>
          <td>${c.tags||""}</td>
          <td class="del-cell"><button data-idx="${idx}">üóëÔ∏è</button></td>`;
        tr.querySelector("button")?.addEventListener("click", async ()=>{
          if(confirm("Remover concorrente?")){
            COMPETITORS.splice(idx,1);
            await persistCompetitors();
            renderCompetitors();
          }
        });
        tbody.appendChild(tr);
      });
    }
    loadCompetitors().then(()=>renderCompetitors());
    $("addCompetitor")?.addEventListener("click", async ()=>{
      const name = $("competitorName").value.trim();
      const link = $("competitorLink").value.trim();
      const tags = $("competitorTags").value.trim();
      if(!name || !link){ alert("Nome e link s√£o obrigat√≥rios."); return; }
      COMPETITORS.push({name, link, tags});
      await persistCompetitors();
      $("competitorName").value = "";
      $("competitorLink").value = "";
      $("competitorTags").value = "";
      renderCompetitors();
    });
    
    /* ========= CAC ========= */
    function renderCAC(){
      if(renderCAC._bound) return;
      const currency = $("cacCurrency");
      const monthSel = $("cacMonth");
      const expensesBody = $("cacExpensesBody");
      const addExpense = $("addExpenseRow");
      const sales = $("cacSales");
      const revenue = $("cacRevenue");
      const ticket = $("cacTicket");
      const salesAds = $("cacSalesAds");
      const revenueAds = $("cacRevenueAds");
      const ticketAds = $("cacTicketAds");
      const real = $("cacReal");
      const ads = $("cacAds");
      function fmt(v){
        if(currency.value === 'USD'){
          return 'US$ ' + new Intl.NumberFormat('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}).format(v||0);
        } else {
          return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL',minimumFractionDigits:2}).format(v||0);
        }
      }
      function parseToNumber(raw, isCurrency = false){
        if (typeof raw === 'number') return raw;
        const s0 = String(raw ?? '').trim();

        // mant√©m d√≠gitos, v√≠rgula e ponto at√© definir o decimal
        const s = s0.replace(/[^\d.,-]/g, '');
        if (!s) return 0;
        const lastComma = s.lastIndexOf(',');
        const lastDot   = s.lastIndexOf('.');
        let norm;

        if (lastComma > -1 && lastDot > -1) {
          // o √∫ltimo define o decimal
          if (lastComma > lastDot) {       // pt-BR: 240.000,00
            norm = s.replace(/\./g, '').replace(',', '.');
          } else {                         // en-US: 10,500.75
            norm = s.replace(/,/g, '');
          }
        } else if (lastComma > -1) {       // s√≥ v√≠rgula => pt-BR
          norm = s.replace(/\./g, '').replace(',', '.');
        } else {                           // s√≥ ponto ou nenhum
          norm = s.replace(/,/g, '');
        }
        return Number(norm) || 0;
      }
      function recalc(){
        const expenses = [...expensesBody.querySelectorAll('input.expense')].map(i=>parseFloat(i.value)||0);
        const totalExpenses = expenses.reduce((a,b)=>a+b,0);
        const tBudget = parseFloat((expensesBody.querySelector('#cacTraffic')||{}).value)||0;
        const salesVal = parseFloat(sales.value)||0;
        const revenueVal = parseFloat(revenue.value)||0;
        const salesAdsVal = parseFloat(salesAds.value)||0;
        const revenueAdsVal = parseFloat(revenueAds.value)||0;
        const ticketVal = salesVal ? revenueVal / salesVal : 0;
        const ticketAdsVal = salesAdsVal ? revenueAdsVal / salesAdsVal : 0;
        ticket.textContent = fmt(ticketVal);
        ticketAds.textContent = fmt(ticketAdsVal);
        real.textContent = fmt(salesVal ? totalExpenses / salesVal : 0);
        ads.textContent  = fmt(salesAdsVal ? tBudget / salesAdsVal : 0);
      }
      function updateFromMetas(){
        const m = monthSel.value;
        const norm = s => (s||'')
          .toLowerCase()
          .normalize('NFD')
          .replace(/[ÃÄ-ÕØ]/g,'')
          .replace(/\s+/g,' ')
          .trim();
        const activeMetas = Array.isArray(METAS) ? METAS.filter(meta => meta && meta.ativo !== false) : [];
        const totalMeta = activeMetas.find(meta => {
          const d = norm(meta.descricao);
          return d === 'faturamento total das vendas' || d === 'total de vendas' || d === 'valor dos contratos no mes';
        });
        const dealsMeta = activeMetas.find(meta => norm(meta.descricao) === 'numero de negocios fechados');
        const revenueVal = totalMeta ? parseToNumber((totalMeta.meses?.[m]?.r ?? totalMeta.meses?.[m]?.p), true) : 0;
        const salesVal = dealsMeta ? parseToNumber((dealsMeta.meses?.[m]?.r ?? dealsMeta.meses?.[m]?.p), false) : 0;
        revenue.value = Number.isFinite(revenueVal) ? revenueVal : 0;
        sales.value = Number.isFinite(salesVal) ? salesVal : 0;
        CAC_DATA.revenue = CAC_DATA.revenue || {};
        CAC_DATA.sales = CAC_DATA.sales || {};
        CAC_DATA.revenue[m] = Number.isFinite(revenueVal) ? revenueVal : 0;
        CAC_DATA.sales[m] = Number.isFinite(salesVal) ? salesVal : 0;
        recalc();
        saveMonth();
      }
      function loadMonth(){
        currency.value = CAC_DATA.currency || 'BRL';
        const m = monthSel.value;
        const rows = CAC_DATA.expenses?.[m] || [];
        const defaults = [
          {desc:'Equipe Marketing', val:0},
          {desc:'Equipe Vendas', val:0},
          {desc:'Softwares', val:0},
          {desc:'Verba de Tr√°fego', val:0},
          {desc:'Outros', val:0}
        ];
        const data = rows.length ? rows : defaults;
        expensesBody.innerHTML = '';
        data.forEach(item=>{
          const tr=document.createElement('tr');
          if(defaults.some(d=>d.desc===item.desc)){
            const idAttr = item.desc === 'Verba de Tr√°fego' ? ' id="cacTraffic"' : '';
            tr.innerHTML=`<td>${item.desc}</td><td><input type="number" step="0.01" class="expense"${idAttr} value="${item.val ?? ''}"></td>`;
          } else {
            tr.innerHTML=`<td><input type="text" placeholder="Descri√ß√£o" class="input" style="width:100%" value="${item.desc||''}"></td><td><input type="number" step="0.01" class="expense" value="${item.val||''}"></td>`;
          }
          expensesBody.appendChild(tr);
        });
        salesAds.value = CAC_DATA.salesAds?.[m] ?? '';
        revenueAds.value = CAC_DATA.revenueAds?.[m] ?? '';
        updateFromMetas();
        recalc();
      }
      function saveMonth(){
        const m = monthSel.value;
        const rows = [...expensesBody.querySelectorAll('tr')];
        CAC_DATA.expenses = CAC_DATA.expenses || {};
        CAC_DATA.expenses[m] = rows.map(tr=>{
          const descInput = tr.querySelector('td:first-child input');
          const desc = descInput ? descInput.value : tr.cells[0].textContent.trim();
          const val = parseFloat(tr.querySelector('input.expense').value) || 0;
          return { desc, val };
        });
        CAC_DATA.salesAds = CAC_DATA.salesAds || {};
        CAC_DATA.revenueAds = CAC_DATA.revenueAds || {};
        CAC_DATA.salesAds[m] = parseFloat(salesAds.value) || 0;
        CAC_DATA.revenueAds[m] = parseFloat(revenueAds.value) || 0;
        CAC_DATA.currency = currency.value;
        persistCAC();
        try{ refreshMacroInsights(); }catch(_){ }
      }
      expensesBody.addEventListener('input', recalc);
      expensesBody.addEventListener('change', ()=>{ recalc(); saveMonth(); });
      [currency, salesAds, revenueAds].forEach(el=>{
        el.addEventListener('input', recalc);
        el.addEventListener('change', ()=>{ recalc(); saveMonth(); });
      });
      monthSel.addEventListener('change', loadMonth);
      addExpense?.addEventListener('click', ()=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td><input type="text" placeholder="Descri√ß√£o" class="input" style="width:100%"></td><td><input type="number" step="0.01" class="expense"></td>`;
        expensesBody.appendChild(tr);
      });
      renderCAC._bound=true;
      renderCAC.refresh = loadMonth;
      const now = new Date();
      const mIdx = now.getMonth();
      monthSel.value = META_MONTHS[mIdx];
      loadMonth();
    }

    /* ========= Refer√™ncias Redes ========= */
    let REF_SOCIAL = [];
    const refSocialLinkPreviewCache = new Map();
    const refSocialPreviewPending = new Set();
    let refSocialLinkPreviewData = null;
    let refSocialLinkPreviewTimer = null;

    function getRefSocialMode(){
      return refSocialForm?.dataset.mode === 'upload' ? 'upload' : 'link';
    }
    function setRefSocialMode(mode){
      if(!refSocialForm) return;
      const normalized = mode === 'upload' ? 'upload' : 'link';
      refSocialForm.dataset.mode = normalized;
      if(refSocialModeToggle){
        refSocialModeToggle.querySelectorAll('button[data-mode]').forEach(btn=>{
          btn.classList.toggle('active', btn.dataset.mode === normalized);
        });
      }
      if(normalized === 'upload'){
        if(refSocialLinkInput){
          refSocialLinkInput.value = '';
        }
        refSocialLinkPreviewData = null;
        refSocialForm?.removeAttribute('data-preview-url');
        resetRefSocialLinkPreview('Cole um link para gerar a pr√©-visualiza√ß√£o.');
      } else {
        if(refSocialFile){
          try{ refSocialFile.value = ''; }catch(_){ }
        }
      }
    }
    setRefSocialMode(getRefSocialMode());
    refSocialModeToggle?.addEventListener('click', evt=>{
      const btn = evt.target.closest('button[data-mode]');
      if(!btn) return;
      evt.preventDefault();
      const current = getRefSocialMode();
      const next = btn.dataset.mode;
      if(!next || next === current) return;
      setRefSocialMode(next);
    });

    const normalizeRefLink = (url)=>{
      if(!url) return '';
      let trimmed = url.trim();
      if(!trimmed) return '';
      if(!/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(trimmed)){
        trimmed = 'https://' + trimmed;
      }
      return trimmed;
    };
    const detectRefLinkProvider = (url)=>{
      const lower = (url || '').toLowerCase();
      if(lower.includes('instagram.com')) return 'instagram';
      if(lower.includes('tiktok.com')) return 'tiktok';
      if(lower.includes('youtu')) return 'youtube';
      return 'link';
    };
    function youtubeIdFromUrl(url){
      if(!url) return null;
      try{
        const u = new URL(url);
        if(u.hostname.includes('youtu.be')){
          return u.pathname.split('/').filter(Boolean)[0] || null;
        }
        if(u.searchParams.get('v')) return u.searchParams.get('v');
        const pathMatch = u.pathname.match(/\/shorts\/([\w-]{5,})/);
        if(pathMatch) return pathMatch[1];
        const embedMatch = u.pathname.match(/\/embed\/([\w-]{5,})/);
        if(embedMatch) return embedMatch[1];
      }catch(_){
        const fallback = url.match(/(?:youtu\.be\/|v=|\/shorts\/|\/embed\/)([\w-]{5,})/);
        return fallback ? fallback[1] : null;
      }
      return null;
    }
    const instagramInfoFromUrl = (url)=>{
      if(!url) return null;
      const match = url.match(/instagram\.com\/(p|reel|tv)\/([\w-]+)/i);
      if(match) return { type: match[1], id: match[2] };
      return null;
    };
    const tiktokIdFromUrl = (url)=>{
      if(!url) return null;
      const match = url.match(/tiktok\.com\/@[^/]+\/video\/(\d+)/i) || url.match(/tiktok\.com\/(?:t|v)\/(\w+)/i);
      return match ? match[1] : null;
    };
    async function buildRefSocialLinkPreview(rawUrl){
      const url = normalizeRefLink(rawUrl);
      if(!url) throw new Error('URL inv√°lida');
      if(refSocialLinkPreviewCache.has(url)){
        return { ...refSocialLinkPreviewCache.get(url) };
      }
      const provider = detectRefLinkProvider(url);
      const preview = { url, provider };
      try{
        const res = await fetch(`https://noembed.com/embed?url=${encodeURIComponent(url)}`);
        if(res.ok){
          const data = await res.json();
          if(!preview.provider && data?.provider_name){
            preview.provider = (data.provider_name || '').toLowerCase();
          }
          if(data?.title) preview.title = data.title;
          if(data?.thumbnail_url) preview.thumbnail = data.thumbnail_url;
          if(data?.html && provider === 'youtube' && !preview.embedUrl){
            const iframeMatch = data.html.match(/src=\"([^\"]+)\"/i);
            if(iframeMatch) preview.embedUrl = iframeMatch[1];
          }
        }
      }catch(err){
        console.warn('buildRefSocialLinkPreview', err);
      }
      if(provider === 'youtube'){
        const yId = youtubeIdFromUrl(url);
        if(yId){
          preview.embedUrl = `https://www.youtube.com/embed/${yId}`;
          preview.thumbnail = preview.thumbnail || `https://img.youtube.com/vi/${yId}/hqdefault.jpg`;
        }
      } else if(provider === 'instagram'){
        const info = instagramInfoFromUrl(url);
        if(info){
          preview.embedUrl = `https://www.instagram.com/${info.type}/${info.id}/embed/`;
        }
      } else if(provider === 'tiktok'){
        const ttId = tiktokIdFromUrl(url);
        if(ttId){
          preview.embedUrl = `https://www.tiktok.com/embed/v2/${ttId}`;
        }
      }
      if(!preview.title){
        preview.title = url.replace(/^https?:\/\//i, '');
      }
      refSocialLinkPreviewCache.set(url, { ...preview });
      return { ...preview };
    }
    function resetRefSocialLinkPreview(message){
      if(!refSocialLinkPreview) return;
      refSocialLinkPreviewData = null;
      refSocialForm?.removeAttribute('data-preview-url');
      refSocialLinkPreview.dataset.state = 'empty';
      refSocialLinkPreview.innerHTML = `<p class="muted" style="margin:0">${message || 'Cole um link para gerar a pr√©-visualiza√ß√£o.'}</p>`;
    }
    function showRefSocialLinkPreviewLoading(){
      if(!refSocialLinkPreview) return;
      refSocialLinkPreview.dataset.state = 'loading';
      refSocialLinkPreview.innerHTML = '<p class="muted" style="margin:0">Gerando pr√©via...</p>';
    }
    function renderRefSocialLinkPreview(preview){
      if(!refSocialLinkPreview) return;
      refSocialLinkPreview.dataset.state = 'ready';
      refSocialLinkPreview.innerHTML = '';
      const mediaWrap = document.createElement('div');
      mediaWrap.className = 'refsocial-link-preview-media';
      if(preview.embedUrl){
        const iframe = document.createElement('iframe');
        iframe.src = preview.embedUrl;
        iframe.loading = 'lazy';
        iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
        iframe.allowFullscreen = true;
        mediaWrap.appendChild(iframe);
      } else if(preview.thumbnail){
        const img = document.createElement('img');
        img.src = preview.thumbnail;
        img.alt = preview.title || 'Pr√©via do link';
        img.loading = 'lazy';
        mediaWrap.appendChild(img);
      }
      if(mediaWrap.childNodes.length){
        refSocialLinkPreview.appendChild(mediaWrap);
      }
      const meta = document.createElement('div');
      meta.className = 'refsocial-link-preview-meta';
      const providerEl = document.createElement('strong');
      providerEl.textContent = (preview.provider || 'Link').toUpperCase();
      meta.appendChild(providerEl);
      if(preview.title){
        const titleEl = document.createElement('span');
        titleEl.textContent = preview.title;
        meta.appendChild(titleEl);
      }
      const linkEl = document.createElement('a');
      linkEl.href = preview.url;
      linkEl.target = '_blank';
      linkEl.rel = 'noopener noreferrer';
      linkEl.textContent = 'Abrir link original';
      meta.appendChild(linkEl);
      refSocialLinkPreview.appendChild(meta);
    }
    async function ensureRefSocialLinkPreview(item){
      if(!item || (item.embedUrl || item.thumbnail) || !item.url) return;
      if(refSocialPreviewPending.has(item.id)) return;
      refSocialPreviewPending.add(item.id);
      try{
        const preview = await buildRefSocialLinkPreview(item.url);
        let changed = false;
        ['embedUrl','thumbnail','title','provider'].forEach(key=>{
          if(preview[key] && item[key] !== preview[key]){
            item[key] = preview[key];
            changed = true;
          }
        });
        if(!item.type) item.type = 'link';
        if(!item.sourceType) item.sourceType = 'link';
        if(changed){
          await persistRefSocial();
          renderRefSocial();
        }
      }catch(err){
        console.warn('ensureRefSocialLinkPreview', err);
      }finally{
        refSocialPreviewPending.delete(item.id);
      }
    }
    async function loadRefSocial(){
      const uid = auth.currentUser?.uid;
      if(!uid){ REF_SOCIAL = []; return; }
      const rawClientKey = (typeof window.TENANT === 'string' && window.TENANT)
        || document.body.getAttribute('data-client-id');
      if (!rawClientKey || rawClientKey === 'no-client') {
        console.warn('Cliente n√£o definido na URL.');
        REF_SOCIAL = [];
        return;
      }
      const safeClientKey = rawClientKey.replace(/[^\w-]/g, '_');
      try{
        let snap = await getDoc(doc(db, 'usuarios', uid, 'clients', safeClientKey));
        if(!snap.exists() && safeClientKey !== rawClientKey){
          snap = await getDoc(doc(db, 'usuarios', uid, 'clients', rawClientKey));
        }
        const data = snap.exists() ? snap.data() : {};
        REF_SOCIAL = Array.isArray(data.refSocial) ? data.refSocial : [];
      }catch(err){
        console.error('loadRefSocial', err);
        REF_SOCIAL = [];
      }
      await refreshStorageUsage();
      try{ refreshMacroInsights(); }catch(_){ }
    }
    async function persistRefSocial(){
      const uid = auth.currentUser?.uid; if(!uid) return;
      const rawClientKey = (typeof window.TENANT === 'string' && window.TENANT)
        || document.body.getAttribute('data-client-id');
      if (!rawClientKey || rawClientKey === 'no-client') {
        console.warn('Cliente n√£o definido na URL.');
        return;
      }
      const safeClientKey = rawClientKey.replace(/[^\w-]/g, '_');
      USER_DATA.refSocial = REF_SOCIAL;
      try{
        await setDoc(doc(db, 'usuarios', uid, 'clients', safeClientKey), { refSocial: REF_SOCIAL }, { merge: true });
        await refreshStorageUsage();
        try{ refreshMacroInsights(); }catch(_){ }
      }catch(err){
        console.error('persistRefSocial', err);
      }
    }
    function renderRefSocial(){
      if(!refSocialList) return;
      refSocialList.innerHTML = "";
      REF_SOCIAL.forEach(item=>{
        const div=document.createElement("div");
        div.className="ref-item";

        const mediaWrap=document.createElement("div");
        mediaWrap.className="ref-item-media";
        if((item.sourceType === 'link' || item.type === 'link')){
          if(item.embedUrl){
            const iframe=document.createElement('iframe');
            iframe.src=item.embedUrl;
            iframe.loading='lazy';
            iframe.allow='accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
            iframe.allowFullscreen=true;
            mediaWrap.appendChild(iframe);
          } else if(item.thumbnail){
            const img=document.createElement('img');
            img.src=item.thumbnail;
            img.alt=item.title || item.details || 'Pr√©via do link';
            img.loading='lazy';
            mediaWrap.appendChild(img);
          } else {
            const placeholder=document.createElement('div');
            placeholder.className='muted';
            placeholder.style.padding='18px';
            placeholder.textContent='Pr√©via indispon√≠vel';
            mediaWrap.appendChild(placeholder);
            ensureRefSocialLinkPreview(item);
          }
        } else {
          let mediaEl;
          if(item.type && item.type.startsWith("video")){
            mediaEl=document.createElement("video");
            mediaEl.src=item.url;
            mediaEl.controls=true;
          } else {
            mediaEl=document.createElement("img");
            mediaEl.src=item.url;
            mediaEl.alt="";
            mediaEl.loading="lazy";
          }
          mediaWrap.appendChild(mediaEl);
        }
        div.appendChild(mediaWrap);

        const detailsWrap=document.createElement("div");
        detailsWrap.className="ref-item-details";
        if(item.sourceType === 'link' || item.type === 'link'){
          const linkInfo=document.createElement('div');
          linkInfo.className='ref-link-info';
          if(item.provider){
            const providerEl=document.createElement('span');
            providerEl.className='ref-link-provider';
            providerEl.textContent=(item.provider||'Link').toUpperCase();
            linkInfo.appendChild(providerEl);
          }
          if(item.title){
            const titleEl=document.createElement('p');
            titleEl.style.margin='0';
            titleEl.textContent=item.title;
            linkInfo.appendChild(titleEl);
          }
          const linkActions=document.createElement('div');
          linkActions.className='ref-link-actions';
          const anchor=document.createElement('a');
          anchor.href=item.url || '#';
          anchor.target='_blank';
          anchor.rel='noopener noreferrer';
          anchor.textContent='Abrir refer√™ncia';
          linkActions.appendChild(anchor);
          linkInfo.appendChild(linkActions);
          detailsWrap.appendChild(linkInfo);
        }
        const categoryEl=document.createElement("strong");
        categoryEl.textContent=item.category || "";
        const detailsText=document.createElement("div");
        detailsText.className="ref-item-details-text markdown-view";
        detailsText.innerHTML=renderMarkdownText(item.details || "");
        detailsWrap.appendChild(categoryEl);
        detailsWrap.appendChild(detailsText);

        const actions=document.createElement("div");
        actions.className="ref-item-actions";
        const editBtn=document.createElement("button");
        editBtn.type="button";
        editBtn.className="ref-edit";
        editBtn.textContent="Editar texto";
        editBtn.addEventListener("click", ()=>{
          if(div.dataset.editing === "1") return;
          div.dataset.editing = "1";
          const textarea=document.createElement("textarea");
          textarea.className="ref-edit-input";
          textarea.rows = 4;
          textarea.value=item.details || "";
          detailsWrap.replaceChild(textarea, detailsText);
          textarea.focus();
          try{ textarea.setSelectionRange(textarea.value.length, textarea.value.length); }catch(_){ }

          const saveBtn=document.createElement("button");
          saveBtn.type="button";
          saveBtn.className="ref-save";
          saveBtn.textContent="Salvar";
          const cancelBtn=document.createElement("button");
          cancelBtn.type="button";
          cancelBtn.className="ref-cancel";
          cancelBtn.textContent="Cancelar";

          const exitEditing=()=>{
            delete div.dataset.editing;
            if(detailsWrap.contains(textarea)){
              detailsWrap.replaceChild(detailsText, textarea);
            }
            actions.innerHTML="";
            actions.appendChild(editBtn);
          };

          cancelBtn.addEventListener("click", ()=>{
            exitEditing();
          });

          saveBtn.addEventListener("click", async ()=>{
            const updated=textarea.value;
            if(updated === item.details){
              exitEditing();
              return;
            }
            const uid = auth.currentUser?.uid;
            if(!uid){
              alert('Fa√ßa login para salvar.');
              exitEditing();
              return;
            }
            const idx=REF_SOCIAL.findIndex(r=> r.id === item.id);
            if(idx === -1){
              exitEditing();
              return;
            }
            REF_SOCIAL[idx] = { ...REF_SOCIAL[idx], details: updated };
            detailsText.innerHTML = renderMarkdownText(updated);
            exitEditing();
            await persistRefSocial();
            renderRefSocial();
            if(typeof mgToast === "function"){
              mgToast("Texto atualizado!");
            }
          });

          textarea.addEventListener("keydown", evt=>{
            if(evt.key === "Escape"){
              evt.preventDefault();
              cancelBtn.click();
            }
            if((evt.metaKey || evt.ctrlKey) && evt.key === "Enter"){
              evt.preventDefault();
              saveBtn.click();
            }
          });

          actions.innerHTML="";
          actions.append(saveBtn, cancelBtn);
        });
        actions.appendChild(editBtn);
        detailsWrap.appendChild(actions);

        div.appendChild(detailsWrap);

        const btn=document.createElement("button");
        btn.type="button";
        btn.className="ref-remove";
        btn.textContent="√ó";
        btn.addEventListener("click", async ()=>{
          if(!confirm("Remover refer√™ncia?")) return;
          if(!STORAGE){ try{ STORAGE = getStorage(app); }catch(_){ } }
          try{ if(item.path) await deleteObject(sRef(STORAGE, item.path)); }catch(err){ console.error('deleteObject', err); }
          REF_SOCIAL = REF_SOCIAL.filter(r=> r.id !== item.id);
          await persistRefSocial();
          renderRefSocial();
        });
        div.appendChild(btn);
        refSocialList.appendChild(div);
      });
    }
    refSocialForm?.addEventListener("submit", async e=>{
      e.preventDefault();
      const mode = getRefSocialMode();
      if(mode === 'upload'){
        const file = refSocialFile?.files?.[0];
        if(!file){
          alert('Selecione um arquivo para enviar.');
          return;
        }
        const details = refSocialDetails?.value?.trim() || '';
        const category = refSocialCategory?.value || '';
        const uid = auth.currentUser?.uid;
        if(!uid) return alert('Fa√ßa login para salvar.');
        const clientKey = (typeof window.TENANT === 'string' && window.TENANT)
          || document.body.getAttribute('data-client-id');
        if (!clientKey || clientKey === 'no-client') {
          console.warn('Cliente n√£o definido na URL.');
          return;
        }
        if(!STORAGE){
          try{ STORAGE = getStorage(app); }catch(err){ console.error(err); return alert('Storage n√£o inicializado.'); }
        }
        const id = uuid();
        const safeClientKey = clientKey.replace(/[^\w-]/g, '_');
        const safeFileName = file.name.replace(/[^\w.-]/g, '_');
        const path = `usuarios/${uid}/clients/${safeClientKey}/refSocial/${id}_${safeFileName}`;
        try{
          const r = sRef(STORAGE, path);
          await uploadBytes(r, file);
          const url = await getDownloadURL(r);
          const fileSize = Number(file?.size);
          REF_SOCIAL.push({ id, sourceType:'upload', type:file.type, url, details, category, path, size: Number.isFinite(fileSize) && fileSize > 0 ? fileSize : null, contentType: file?.type || '' });
          await persistRefSocial();
          renderRefSocial();
          refSocialForm.reset();
          refSocialForm?.removeAttribute('data-preview-url');
        }catch(err){
          console.error('upload refSocial', err);
          const msg = err?.message || err?.code || String(err);
          alert('Erro ao enviar arquivo: ' + msg);
        }
        return;
      }

      const rawUrl = refSocialLinkInput?.value?.trim();
      if(!rawUrl){
        alert('Informe um link v√°lido.');
        refSocialLinkInput?.focus?.();
        return;
      }
      const url = normalizeRefLink(rawUrl);
      let preview = refSocialLinkPreviewData;
      if(!preview || preview.url !== url){
        try{
          showRefSocialLinkPreviewLoading();
          preview = await buildRefSocialLinkPreview(url);
          refSocialLinkPreviewData = preview;
          refSocialForm?.setAttribute('data-preview-url', preview.url);
          renderRefSocialLinkPreview(preview);
        }catch(err){
          console.warn('submit link preview', err);
          alert('N√£o foi poss√≠vel gerar a pr√©-visualiza√ß√£o deste link.');
          resetRefSocialLinkPreview('Cole um link para gerar a pr√©-visualiza√ß√£o.');
          return;
        }
      }
      const details = refSocialDetails?.value?.trim() || '';
      const category = refSocialCategory?.value || '';
      const id = uuid();
      const item = {
        id,
        sourceType:'link',
        type:'link',
        url: preview.url || url,
        category,
        details,
        provider: preview.provider || detectRefLinkProvider(url),
        title: preview.title || '',
        thumbnail: preview.thumbnail || null,
        embedUrl: preview.embedUrl || null
      };
      REF_SOCIAL.push(item);
      await persistRefSocial();
      renderRefSocial();
      refSocialForm.reset();
      refSocialForm?.removeAttribute('data-preview-url');
      resetRefSocialLinkPreview('Cole um link para gerar a pr√©-visualiza√ß√£o.');
    });
    refSocialLinkInput?.addEventListener('input', ()=>{
      if(getRefSocialMode() !== 'link') return;
      if(refSocialLinkPreviewTimer) clearTimeout(refSocialLinkPreviewTimer);
      const raw = refSocialLinkInput.value;
      if(!raw){
        refSocialForm?.removeAttribute('data-preview-url');
        resetRefSocialLinkPreview('Cole um link para gerar a pr√©-visualiza√ß√£o.');
        return;
      }
      refSocialLinkPreviewTimer = setTimeout(async ()=>{
        try{
          showRefSocialLinkPreviewLoading();
          const preview = await buildRefSocialLinkPreview(raw);
          refSocialLinkPreviewData = preview;
          refSocialForm?.setAttribute('data-preview-url', preview.url);
          renderRefSocialLinkPreview(preview);
        }catch(err){
          console.warn('preview link', err);
          resetRefSocialLinkPreview('N√£o foi poss√≠vel gerar a pr√©-visualiza√ß√£o. Verifique o link.');
        }
      }, 500);
    });
    refSocialForm?.addEventListener('reset', ()=>{
      refSocialForm?.removeAttribute('data-preview-url');
      setTimeout(()=> resetRefSocialLinkPreview('Cole um link para gerar a pr√©-visualiza√ß√£o.'), 0);
    });
    resetRefSocialLinkPreview('Cole um link para gerar a pr√©-visualiza√ß√£o.');
    loadRefSocial();
    renderRefSocial();


    /* ========= Notas ========= */
    let NOTES = []; // {id,title,html,sector,dateISO,updatedAt,createdAt}
    let noteMarkdownSource = '';
    let currentNoteId = null;
    let NOTE_TEMPLATES = []; // {id,name,markdown,createdAt,updatedAt}
    const sectorLabel = (v)=>({roi:"ROI","vitrine-engajamento":"Vitrine/Engajamento","novasideias":"Novas Ideias",relacionamento:"Relacionamento",ia:"I.A",gbp:"Google Business Profile"})[v]||v;

    function defaultDateISO(){ const d=new Date(); return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10); }
    function loadNotesFromUserData(){
      if(!Array.isArray(USER_DATA.notes)){
        NOTES = [];
        return;
      }
      NOTES = USER_DATA.notes.map(n=>{
        if(!n || typeof n !== 'object') return n;
        const copy = { ...n };
        if(typeof copy.createdAt === 'string'){ const num = Number(copy.createdAt); if(Number.isFinite(num)) copy.createdAt = num; }
        if(typeof copy.updatedAt === 'string'){ const num = Number(copy.updatedAt); if(Number.isFinite(num)) copy.updatedAt = num; }
        return copy;
      });
      try{ refreshMacroInsights(); }catch(_){ }
    }
    function saveNotesToUserData(){ USER_DATA.notes = NOTES; }

    function loadNoteTemplatesFromUserData(){
      if(!Array.isArray(USER_DATA.noteTemplates)){
        NOTE_TEMPLATES = [];
        refreshNoteTemplateOptions();
        return;
      }
      NOTE_TEMPLATES = USER_DATA.noteTemplates.map(t=>{
        if(!t || typeof t !== 'object') return null;
        const copy = { ...t };
        if(!copy.id){ copy.id = uuid(); }
        if(typeof copy.createdAt === 'string'){ const num = Number(copy.createdAt); if(Number.isFinite(num)) copy.createdAt = num; }
        if(typeof copy.updatedAt === 'string'){ const num = Number(copy.updatedAt); if(Number.isFinite(num)) copy.updatedAt = num; }
        const raw = typeof copy.markdown === 'string' ? copy.markdown : (typeof copy.content === 'string' ? copy.content : '');
        copy.markdown = normalizeNoteRaw(raw);
        delete copy.content;
        return copy;
      }).filter(Boolean);
      refreshNoteTemplateOptions();
    }
    function saveNoteTemplatesToUserData(){ USER_DATA.noteTemplates = NOTE_TEMPLATES; }

    const NOTE_TITLE_MAX_WORDS = 12;
    const NOTE_TITLE_MAX_LENGTH = 120;
    const NOTE_AUTO_SAVE_IDLE_MS = 2000;

    function updateNoteTemplateControlsState(){
      if(!noteTemplateSelect) return;
      const hasTemplates = Array.isArray(NOTE_TEMPLATES) && NOTE_TEMPLATES.length > 0;
      noteTemplateSelect.disabled = !hasTemplates;
      if(!hasTemplates){
        noteTemplateSelect.value = '';
      }
      if(insertTemplateBtn){
        insertTemplateBtn.disabled = !hasTemplates || !(noteTemplateSelect.value);
      }
    }

    function refreshNoteTemplateOptions(selectedId){
      if(!noteTemplateSelect) return;
      const templates = Array.isArray(NOTE_TEMPLATES) ? [...NOTE_TEMPLATES] : [];
      const previous = typeof selectedId === 'string' ? selectedId : noteTemplateSelect.value;
      noteTemplateSelect.innerHTML = '<option value="">Selecionar template...</option>';
      templates
        .sort((a,b)=>{
          const diff = (b.updatedAt||0) - (a.updatedAt||0);
          return diff || String(a.name||'').localeCompare(String(b.name||''));
        })
        .forEach(template=>{
          const option = document.createElement('option');
          option.value = template.id || '';
          option.textContent = template.name || 'Template sem nome';
          noteTemplateSelect.appendChild(option);
        });
      const valid = templates.some(t=> (t.id||'') === previous) ? previous : '';
      noteTemplateSelect.value = valid;
      updateNoteTemplateControlsState();
    }

    async function persistNoteTemplates(){
      saveNoteTemplatesToUserData();
      const uid = auth.currentUser?.uid;
      if(!uid) return;
      await setDoc(doc(db,'usuarios',uid), { noteTemplates: NOTE_TEMPLATES }, { merge:true });
    }

    function ensureDateISOFromTimestamp(ts){
      if(!ts) return defaultDateISO();
      const d = new Date(ts);
      return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
    }
    function generateNoteTitleFromMarkdown(raw){
      const normalized = normalizeNoteRaw(raw||'').trim();
      if(!normalized) return '';
      const words = normalized.split(/\s+/).filter(Boolean).slice(0, NOTE_TITLE_MAX_WORDS);
      let title = words.join(' ');
      if(title.length > NOTE_TITLE_MAX_LENGTH){
        title = title.slice(0, NOTE_TITLE_MAX_LENGTH).trim();
      }
      if(normalized.length > title.length){
        title = title.replace(/[\s,.!?;:-]+$/,'');
        title += '‚Ä¶';
      }
      return title;
    }
    function formatNoteDateTime(note){
      if(!note) return '';
      const ts = typeof note.createdAt === 'number' ? note.createdAt : (typeof note.updatedAt === 'number' ? note.updatedAt : null);
      if(!ts){
        return note.dateISO || '';
      }
      const d = new Date(ts);
      const dateStr = d.toLocaleDateString('pt-BR');
      const timeStr = d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
      return `${dateStr} ${timeStr}`;
    }

    function normalizeNoteRaw(raw){
      return typeof raw === 'string'
        ? raw.replace(/\u00a0/g, ' ').replace(/\r\n?/g, '\n')
        : '';
    }
    function extractNoteEditorMarkdown(){
      if(!noteEditor) return '';
      const sanitizedCurrent = sanitizeMarkdownHtml(noteEditor.innerHTML || '');
      let markdown = htmlToMarkdown(sanitizedCurrent);
      if(!markdown){
        markdown = noteEditor.textContent || '';
      }
      const normalized = normalizeNoteRaw(markdown);
      noteMarkdownSource = normalized;
      noteEditor.dataset.raw = normalized;
      return normalized;
    }
    function computeNoteHtmlFromMarkdown(raw){
      const normalized = normalizeNoteRaw(raw);
      if(!normalized.trim()) return '';
      const markedLib = window.marked;
      let html = '';
      if(markedLib){
        try{
          const parser = typeof markedLib.parse === 'function' ? markedLib.parse : markedLib;
          const rendered = parser.call(markedLib, normalized, { gfm:true, breaks:true });
          if(typeof rendered === 'string') html = rendered;
        }catch(err){
          console.warn('Markdown render error', err);
        }
      }
      if(!html){
        html = escapeHtml(normalized).replace(/\n/g,'<br>');
      }
      let safe = html;
      const purifier = window.DOMPurify;
      if(purifier && typeof purifier.sanitize === 'function'){
        try{
          safe = purifier.sanitize(html, { USE_PROFILES: { html: true } });
        }catch(err){
          console.warn('DOMPurify sanitize error', err);
          safe = sanitizeMarkdownHtml(html);
        }
      }else{
        safe = sanitizeMarkdownHtml(html);
      }
      return safe;
    }
    let noteEditorUpdating = false;
    function setNoteEditorMarkdown(raw, selectionState=null){
      if(!noteEditor) return;
      const prevScrollTop = noteEditor.scrollTop;
      const prevScrollLeft = noteEditor.scrollLeft;
      const normalized = normalizeNoteRaw(raw);
      noteMarkdownSource = normalized;
      noteEditor.dataset.raw = normalized;
      const html = normalized ? computeNoteHtmlFromMarkdown(normalized) : '';
      if(html){
        if(noteEditor.innerHTML !== html){
          noteEditor.innerHTML = html;
        }
      }else{
        noteEditor.innerHTML = '';
      }
      if(selectionState){
        restoreEditableSelection(noteEditor, selectionState);
      }
      noteEditor.scrollTop = prevScrollTop;
      noteEditor.scrollLeft = prevScrollLeft;
    }
    function refreshNoteEditorFromCurrentHtml(options={}){
      if(!noteEditor || noteEditorUpdating) return;
      noteEditorUpdating = true;
      try{
        const prevScrollTop = noteEditor.scrollTop;
        const prevScrollLeft = noteEditor.scrollLeft;
        const normalized = extractNoteEditorMarkdown();
        const isActive = document.activeElement === noteEditor;
        if(!isActive || options.forceRender){
          const html = normalized ? (computeNoteHtmlFromMarkdown(normalized) || '') : '';
          if(html){
            if(noteEditor.innerHTML !== html){
              noteEditor.innerHTML = html;
            }
          }else if(noteEditor.innerHTML){
            noteEditor.innerHTML = '';
          }
          noteEditor.scrollTop = prevScrollTop;
          noteEditor.scrollLeft = prevScrollLeft;
        }
      }finally{
        noteEditorUpdating = false;
      }
    }
    if(noteEditor && !noteEditor.innerHTML.trim()){
      setNoteEditorMarkdown('');
    }

    function renderNotes(){
      noteDate.value = noteDate.value || defaultDateISO();
      let items=[...NOTES];
      const fs=filterSector.value, ff=filterFrom.value, ft=filterTo.value;
      if(fs) items=items.filter(n=>n.sector===fs);
      if(ff) items=items.filter(n=>n.dateISO>=ff);
      if(ft) items=items.filter(n=>n.dateISO<=ft);
      items.sort((a,b)=> (a.dateISO<b.dateISO?1:a.dateISO>b.dateISO?-1:(b.updatedAt||0)-(a.updatedAt||0)));

      notesList.innerHTML="";
      if(items.length===0){ const d=document.createElement("div"); d.className="muted"; d.textContent="Nenhuma nota encontrada."; notesList.appendChild(d); return; }
      items.forEach(n=>{
        const div=document.createElement("div"); div.className="note-item";
        if(n.id) div.dataset.id = n.id;
        if(n.id && n.id===currentNoteId) div.classList.add('active');
        const dateLabel = formatNoteDateTime(n) || n.dateISO || '';
        div.innerHTML=`
          <div class="note-head">
            <div>
              <div class="note-title">${n.title||"(Sem nome)"}</div>
              <div class="note-meta"><span class="tag">${sectorLabel(n.sector)}</span>${dateLabel?` ‚Ä¢ ${dateLabel}`:''}</div>
            </div>
            <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end">
              <button class="btn small secondary" data-act="edit">Editar</button>
              <button class="btn small" data-act="dup">Duplicar</button>
              <button class="btn small secondary" data-act="del">Excluir</button>
              <button class="btn small" data-act="dl-html" title="Baixar HTML">Download HTML</button>
            </div>
          </div>`;
        div.querySelector('[data-act="edit"]').onclick=()=>{
          const sanitized = sanitizeMarkdownHtml(n.html||'');
          let markdown = htmlToMarkdown(sanitized);
          if(!markdown && sanitized){
            const temp=document.createElement('div');
            temp.innerHTML=sanitized;
            markdown=temp.textContent||'';
          }
          markdown = normalizeNoteRaw(markdown||'');
          setNoteEditorMarkdown(markdown);
          if(noteEditor){
            const len = (noteEditor.textContent||'').length;
            restoreEditableSelection(noteEditor, { start: len, end: len });
            noteEditor.focus();
          }
          currentNoteId = n.id;
          noteTitle.value=n.title||generateNoteTitleFromMarkdown(markdown)||"";
          noteSector.value=n.sector||"roi";
          noteDate.value=n.dateISO||ensureDateISOFromTimestamp(n.createdAt||n.updatedAt||Date.now());
          if(noteAutoSaveStatus){
            const when = formatNoteDateTime(n);
            noteAutoSaveStatus.textContent = when ? `√öltimo salvamento em ${when}.` : 'Altera√ß√µes s√£o salvas automaticamente.';
          }
          notesList.querySelectorAll('.note-item').forEach(item=>item.classList.remove('active'));
          div.classList.add('active');
          window.scrollTo({top:sectionTabs.offsetTop,behavior:"smooth"});
        };
        div.querySelector('[data-act="dup"]').onclick=async()=>{
          const now = Date.now();
          const copy={...n,id:uuid(),updatedAt:now,createdAt:now,dateISO:ensureDateISOFromTimestamp(now)};
          NOTES.push(copy);
          await persistNotes();
          renderNotes();
        };
        div.querySelector('[data-act="del"]').onclick=async()=>{
          if(confirm("Excluir esta nota?")){
            NOTES=NOTES.filter(x=>x.id!==n.id);
            if(n.id===currentNoteId){
              currentNoteId=null;
              startNewNote();
            }
            await persistNotes();
            renderNotes();
          }
        };
        div.querySelector('[data-act="dl-html"]').onclick=()=> downloadNoteHTML(n);
        notesList.appendChild(div);
      });
    }

    function updateNoteListAfterSave(note, { isNew=false }={}){
      if(!notesList || !note) return;
      if(isNew){
        renderNotes();
        return;
      }
      const item = note.id ? notesList.querySelector(`.note-item[data-id="${note.id}"]`) : null;
      if(!item) return;
      const titleEl = item.querySelector('.note-title');
      if(titleEl){
        titleEl.textContent = note.title || '(Sem nome)';
      }
      const metaEl = item.querySelector('.note-meta');
      if(metaEl){
        const dateLabel = formatNoteDateTime(note) || note.dateISO || '';
        metaEl.innerHTML = `<span class="tag">${sectorLabel(note.sector)}</span>${dateLabel?` ‚Ä¢ ${dateLabel}`:''}`;
      }
    }

    // toolbar texto ‚Äî ESCOPADA AO NOTES WRAP
    notesWrap.querySelectorAll(".note-toolbar .tool").forEach(btn=>{
      const cmd=btn.dataset.cmd; if(!cmd) return;
      btn.addEventListener("click",()=>{ const v=btn.dataset.value||null; if(cmd==="formatBlock"&&v) document.execCommand(cmd,false,v); else document.execCommand(cmd,false,v); noteEditor.focus(); });
    });
    notesWrap.querySelector("#makeLink").addEventListener("click",()=>{
      let url=prompt("URL do link:"); if(url){ if(!/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(url)) url="https://"+url; document.execCommand("createLink",false,url); }
      noteEditor.focus();
    });

    notesWrap.querySelector("#noteColor").addEventListener("input",(e)=>{
      document.execCommand("foreColor", false, e.target.value);
      noteEditor.focus();
    });

    // m√≠dias nas notas (imagens e v√≠deos)
    notesWrap.querySelector("#btnImg").addEventListener("click",()=>imgInput.click());
    imgInput.addEventListener("change",(e)=>{ const f=e.target.files?.[0]; if(f) insertImageFromFile(f); imgInput.value=""; });
    notesWrap.querySelector("#btnVideo").addEventListener("click",()=>videoInput.click());
    videoInput.addEventListener("change",(e)=>{ const f=e.target.files?.[0]; if(f) insertVideoFromFile(f); videoInput.value=""; });
    const scheduleNoteEditorRefresh = noteEditor ? debounce(()=>refreshNoteEditorFromCurrentHtml(), 300) : null;
    let noteAutoSaveTimer = null;
    function scheduleNoteAutoSave(options={}){
      if(!noteEditor) return Promise.resolve();
      const force = options?.force === true;
      clearTimeout(noteAutoSaveTimer);
      if(force){
        noteAutoSaveTimer = null;
        return autoSaveCurrentNote(true);
      }
      if(noteAutoSaveStatus){
        updateAutoSaveStatus('Altera√ß√µes pendentes. Salvaremos em instantes...');
      }
      noteAutoSaveTimer = window.setTimeout(()=>{
        noteAutoSaveTimer = null;
        autoSaveCurrentNote();
      }, NOTE_AUTO_SAVE_IDLE_MS);
      return Promise.resolve();
    }

    function applyNoteTemplate(template){
      if(!template || !noteEditor) return;
      const templateContent = normalizeNoteRaw(template.markdown || '');
      if(!templateContent.trim()){
        if(typeof mgToast === 'function'){ mgToast('Template vazio.'); }
        return;
      }
      const current = normalizeNoteRaw(extractNoteEditorMarkdown() || '');
      if(current.trim() && current !== templateContent){
        const confirmReplace = confirm('Substituir o conte√∫do atual pelo template selecionado?');
        if(!confirmReplace){
          refreshNoteEditorFromCurrentHtml({ forceRender: true });
          return;
        }
      }
      setNoteEditorMarkdown(templateContent);
      refreshNoteEditorFromCurrentHtml({ forceRender: true });
      const len = (noteEditor.textContent||'').length;
      restoreEditableSelection(noteEditor, { start: len, end: len });
      noteEditor.focus();
      scheduleNoteAutoSave({ force: true });
      if(typeof mgToast === 'function'){ mgToast('Template inserido!'); }
    }

    if(noteTemplateSelect){
      noteTemplateSelect.addEventListener('change', ()=> updateNoteTemplateControlsState());
    }
    if(saveTemplateBtn){
      saveTemplateBtn.addEventListener('click', async ()=>{
        if(!noteEditor) return;
        refreshNoteEditorFromCurrentHtml({ forceRender: true });
        const { normalized } = getNoteEditorContentForSaving();
        const normalizedContent = normalizeNoteRaw(normalized || '');
        if(!normalizedContent.trim()){
          alert('Escreva algo na anota√ß√£o para salvar como template.');
          noteEditor.focus();
          return;
        }
        const defaultName = (noteTitle?.value || '').trim() || `Template ${NOTE_TEMPLATES.length + 1}`;
        let name = prompt('Nome do template:', defaultName);
        if(name === null) return;
        name = name.trim();
        if(!name){
          alert('Informe um nome v√°lido para o template.');
          return;
        }
        const now = Date.now();
        const normalizedName = name.toLowerCase();
        let targetId = null;
        const existing = NOTE_TEMPLATES.find(t => (t.name||'').toLowerCase() === normalizedName);
        if(existing){
          if(!confirm(`Substituir o template "${existing.name}"?`)) return;
          existing.name = name;
          existing.markdown = normalizedContent;
          existing.updatedAt = now;
          if(!existing.createdAt) existing.createdAt = now;
          targetId = existing.id;
        }else{
          const template = { id: uuid(), name, markdown: normalizedContent, createdAt: now, updatedAt: now };
          NOTE_TEMPLATES.push(template);
          targetId = template.id;
        }
        try{
          await persistNoteTemplates();
          refreshNoteTemplateOptions(targetId);
          if(typeof mgToast === 'function'){ mgToast('Template salvo!'); }
        }catch(err){
          console.error('note template save', err);
          alert('N√£o foi poss√≠vel salvar o template. Tente novamente.');
        }
      });
    }
    if(insertTemplateBtn){
      insertTemplateBtn.addEventListener('click', ()=>{
        const id = noteTemplateSelect?.value || '';
        if(!id){
          alert('Selecione um template para inserir.');
          noteTemplateSelect?.focus();
          return;
        }
        const template = NOTE_TEMPLATES.find(t=> (t.id||'') === id);
        if(!template){
          alert('Template n√£o encontrado. Atualize a lista e tente novamente.');
          refreshNoteTemplateOptions();
          return;
        }
        applyNoteTemplate(template);
      });
    }
    noteEditor.addEventListener("paste",(e)=>{
      const items=e.clipboardData?.items||[];
      for(const it of items){
        if(it.type?.startsWith("image/")){
          e.preventDefault();
          const f=it.getAsFile();
          if(f) insertImageFromFile(f);
          return;
        }
      }
      const text=e.clipboardData?.getData('text/plain');
      if(typeof text === 'string' && text.length){
        e.preventDefault();
        const normalized=normalizeNoteRaw(text);
        document.execCommand('insertText', false, normalized);
        refreshNoteEditorFromCurrentHtml();
        scheduleNoteAutoSave();
      }
    });
    noteEditor.addEventListener("keydown",(e)=>{
      if(e.key === 'Tab' && !e.shiftKey){
        e.preventDefault();
        const insertion = '  ';
        const inserted = document.execCommand('insertText', false, insertion);
        if(!inserted){
          const selection = window.getSelection();
          if(selection && selection.rangeCount){
            const range = selection.getRangeAt(0);
            range.deleteContents();
            range.insertNode(document.createTextNode(insertion));
            range.collapse(false);
            selection.removeAllRanges();
            selection.addRange(range);
          }
        }
        if(scheduleNoteEditorRefresh) scheduleNoteEditorRefresh();
        scheduleNoteAutoSave();
      }
    });
    noteEditor.addEventListener("input",()=>{
      if(scheduleNoteEditorRefresh) scheduleNoteEditorRefresh();
      scheduleNoteAutoSave();
    });
    noteEditor.addEventListener("blur",()=>{
      refreshNoteEditorFromCurrentHtml({ forceRender: true });
      scheduleNoteAutoSave({ force: true });
    });
    let lastMediaBox=null;
    function insertImageFromFile(file){ const r=new FileReader(); r.onload=()=>insertImageBox(String(r.result)); r.readAsDataURL(file); }
    function insertImageBox(src){
      const box=document.createElement("span"); box.className="media-resizable"; box.contentEditable="false"; box.innerHTML=`<img alt="imagem" src="${src}" crossorigin="anonymous">`; box.style.width="420px";
      box.addEventListener("click",(ev)=>{ ev.stopPropagation(); selectMediaBox(box); });
      const range=getCurrentRange(); if(range) range.insertNode(box); else noteEditor.appendChild(box); selectMediaBox(box);
    }
    function insertVideoFromFile(file){ const r=new FileReader(); r.onload=()=>insertVideoBox(String(r.result)); r.readAsDataURL(file); }
    function insertVideoBox(src){
      const box=document.createElement("span"); box.className="media-resizable"; box.contentEditable="false"; box.innerHTML=`<video controls src="${src}" crossorigin="anonymous"></video>`; box.style.width="420px";
      box.addEventListener("click",(ev)=>{ ev.stopPropagation(); selectMediaBox(box); });
      const range=getCurrentRange(); if(range) range.insertNode(box); else noteEditor.appendChild(box); selectMediaBox(box);
    }
    function selectMediaBox(box){ if(lastMediaBox) lastMediaBox.classList.remove("selected"); lastMediaBox=box; box.classList.add("selected"); }
    function getCurrentRange(){ const sel=window.getSelection(); if(!sel||sel.rangeCount===0) return null; return sel.getRangeAt(0); }
    notesWrap.querySelector("#btnImgLink").addEventListener("click",()=>{
      if(!lastMediaBox || !lastMediaBox.querySelector("img")){ alert("Clique na imagem para selecion√°-la primeiro."); return; }
      let a=lastMediaBox.closest("a"); let url=a?.getAttribute("href")||"";
      url=prompt("URL para abrir ao clicar na imagem:",url||"https://")||""; if(!url){ if(a){ a.replaceWith(lastMediaBox); } return; }
      if(!/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(url)) url="https://"+url;
      const link=document.createElement("a"); link.href=url; link.target="_blank"; link.rel="noopener noreferrer";
      lastMediaBox.replaceWith(link); link.appendChild(lastMediaBox); selectMediaBox(lastMediaBox);
    });
    notesWrap.querySelector("#btnVideoLink").addEventListener("click",()=>{
      if(!lastMediaBox || !lastMediaBox.querySelector("video")){ alert("Clique no v√≠deo para selecion√°-lo primeiro."); return; }
      let a=lastMediaBox.closest("a"); let url=a?.getAttribute("href")||"";
      url=prompt("URL para abrir ao clicar no v√≠deo:",url||"https://")||""; if(!url){ if(a){ a.replaceWith(lastMediaBox); } return; }
      if(!/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(url)) url="https://"+url;
      const link=document.createElement("a"); link.href=url; link.target="_blank"; link.rel="noopener noreferrer";
      lastMediaBox.replaceWith(link); link.appendChild(lastMediaBox); selectMediaBox(lastMediaBox);
    });
    document.addEventListener("click",(e)=>{ if(!noteEditor.contains(e.target) && lastMediaBox){ lastMediaBox.classList.remove("selected"); lastMediaBox=null; } });

    function updateAutoSaveStatus(message){
      if(noteAutoSaveStatus) noteAutoSaveStatus.textContent = message;
    }

    function startNewNote(){
      clearTimeout(noteAutoSaveTimer);
      noteAutoSaveTimer = null;
      currentNoteId = null;
      setNoteEditorMarkdown('');
      if(noteEditor){
        restoreEditableSelection(noteEditor, { start:0, end:0 });
        noteEditor.focus();
      }
      if(noteTitle) noteTitle.value = '';
      if(noteDate) noteDate.value = defaultDateISO();
      if(noteTemplateSelect){
        noteTemplateSelect.value = '';
        updateNoteTemplateControlsState();
      }
      if(notesList){
        notesList.querySelectorAll('.note-item').forEach(item=>item.classList.remove('active'));
      }
      updateAutoSaveStatus('Digite para criar uma nova anota√ß√£o. Salvamento autom√°tico ativo.');
    }

    function captureNoteEditorState(){
      if(!noteEditor) return null;
      const active = document.activeElement === noteEditor;
      return {
        active,
        selection: active ? getEditableSelection(noteEditor) : null,
        scrollTop: noteEditor.scrollTop,
        scrollLeft: noteEditor.scrollLeft
      };
    }
    function restoreNoteEditorState(state){
      if(!state || !noteEditor) return;
      noteEditor.scrollTop = state.scrollTop;
      noteEditor.scrollLeft = state.scrollLeft;
      if(state.active){
        try{
          noteEditor.focus({ preventScroll: true });
        }catch(_err){
          noteEditor.focus();
        }
        if(state.selection){
          restoreEditableSelection(noteEditor, state.selection);
        }
      }
    }
    function getNoteEditorContentForSaving(){
      if(!noteEditor) return { normalized: '', html: '' };
      const normalized = extractNoteEditorMarkdown();
      const html = normalized ? (computeNoteHtmlFromMarkdown(normalized) || '') : '';
      return { normalized, html };
    }
    async function autoSaveCurrentNote(force=false){
      if(!noteEditor) return;
      const editorState = captureNoteEditorState();
      try{
      clearTimeout(noteAutoSaveTimer);
      noteAutoSaveTimer = null;
      const { normalized, html: editorHtml } = getNoteEditorContentForSaving();
      const normalizedContent = normalized || '';
      const trimmed = normalizedContent.trim();
      const sector = noteSector?.value || 'roi';

      if(!trimmed){
        if(!currentNoteId){
          if(noteTitle) noteTitle.value = '';
          if(noteDate) noteDate.value = defaultDateISO();
          updateAutoSaveStatus('Digite para criar uma nova anota√ß√£o. Salvamento autom√°tico ativo.');
          return;
        }
        const existing = NOTES.find(n=>n.id===currentNoteId);
        if(existing){
          const hadContent = !!(existing.html && existing.html.trim());
          existing.title = '';
          existing.html = '';
          existing.sector = sector;
          existing.updatedAt = Date.now();
          if(!existing.dateISO) existing.dateISO = ensureDateISOFromTimestamp(existing.updatedAt);
          try{
            await persistNotes();
          }catch(err){
            console.error('autoSaveCurrentNote(empty)', err);
          }
          if(hadContent) renderNotes();
        }
        updateAutoSaveStatus('Anota√ß√£o vazia. Nenhuma altera√ß√£o nova para salvar.');
        return;
      }

      const html = editorHtml || '';
      const title = generateNoteTitleFromMarkdown(normalizedContent) || 'Anota√ß√£o';
      if(noteTitle) noteTitle.value = title;
      let note = currentNoteId ? NOTES.find(n=>n.id===currentNoteId) : null;
      let noteWasNew = false;
      const now = Date.now();

      if(!note){
        note = { id: uuid(), title, html, sector, dateISO: ensureDateISOFromTimestamp(now), createdAt: now, updatedAt: now };
        NOTES.push(note);
        currentNoteId = note.id;
        noteWasNew = true;
      }else{
        const sameContent = !force && (note.html||'')===html && (note.title||'')===title && (note.sector||'')===sector;
        if(sameContent){
          const savedLabel = formatNoteDateTime(note);
          updateAutoSaveStatus(savedLabel ? `√öltimo salvamento em ${savedLabel}.` : 'Altera√ß√µes salvas automaticamente.');
          return;
        }
        note.title = title;
        note.html = html;
        note.sector = sector;
        note.updatedAt = now;
        if(!note.createdAt) note.createdAt = now;
        if(!note.dateISO) note.dateISO = ensureDateISOFromTimestamp(note.createdAt);
      }

      if(noteDate) noteDate.value = note.dateISO || ensureDateISOFromTimestamp(note.createdAt||now);
      updateAutoSaveStatus('Salvando...');
      try{
        await persistNotes();
        updateNoteListAfterSave(note, { isNew: noteWasNew });
        const savedLabel = formatNoteDateTime(note);
        updateAutoSaveStatus(savedLabel ? `Salvo automaticamente em ${savedLabel}.` : 'Altera√ß√µes salvas automaticamente.');
      }catch(err){
        console.error('autoSaveCurrentNote', err);
        updateAutoSaveStatus('Falha ao salvar na nuvem. Guardado localmente.');
        updateNoteListAfterSave(note, { isNew: noteWasNew });
      }
      }finally{
        restoreNoteEditorState(editorState);
      }
    }

    if(newNoteBtn){
      newNoteBtn.addEventListener('click', ()=>{
        autoSaveCurrentNote(true).finally(()=>{
          startNewNote();
        });
      });
    }
    if(noteSector){
      noteSector.addEventListener('change', ()=>autoSaveCurrentNote(true));
    }
    document.addEventListener('visibilitychange', ()=>{
      if(document.visibilityState === 'hidden'){
        autoSaveCurrentNote(true);
      }
    });
    window.addEventListener('beforeunload', ()=>{
      autoSaveCurrentNote(true);
    });
    if(noteTitle){
      noteTitle.readOnly = true;
      noteTitle.placeholder = 'T√≠tulo gerado automaticamente';
    }
    if(noteDate){
      noteDate.disabled = true;
      noteDate.title = 'Definido automaticamente ao criar a anota√ß√£o';
    }
    if(noteAutoSaveStatus){
      updateAutoSaveStatus('Digite para criar uma nova anota√ß√£o. Salvamento autom√°tico ativo.');
    }
    refreshNoteTemplateOptions();
    if(!currentNoteId && (!noteEditor || !(noteEditor.textContent||'').trim())){
      startNewNote();
    }

    async function persistNotes(){
      saveNotesToUserData();
      const uid = auth.currentUser?.uid;
      if(!uid) return;
      await setDoc(doc(db,"usuarios",uid), { notes: NOTES }, { merge:true });
      await refreshStorageUsage();
      try{ refreshMacroInsights(); }catch(_){ }
    }
    applyFilter.addEventListener("click",renderNotes);
    clearFilter.addEventListener("click",()=>{ filterSector.value=""; filterFrom.value=""; filterTo.value=""; renderNotes(); });

    function sanitizeFileName(str){
      return (str||"nota").replace(/[\\/:*?"<>|]/g,"_");
    }
    function downloadNoteHTML(n){
      const html=`<!DOCTYPE html><html><head><meta charset="utf-8"><title>${n.title||""}</title></head><body>${n.html||""}</body></html>`;
      const blob=new Blob([html],{type:"text/html"});
      const a=document.createElement("a"); a.href=URL.createObjectURL(blob);
      a.download=`${sanitizeFileName(`${n.dateISO||""}-${n.title||"nota"}`)}.html`;
      document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();
    }

    /* ========= ACESSOS (dados) ========= */
    const accessWrap = $("accessWrap"), accessList = $("accessList"), accessForm = $("accessForm");
    let ACCESSES = []; // {id,name,url,user,pass,tags}
    let editingId = null;
    function loadAccessesFromUserData(){ ACCESSES = Array.isArray(USER_DATA.accesses) ? USER_DATA.accesses : []; }
    function saveAccessesToUserData(){ USER_DATA.accesses = ACCESSES; }
    async function persistAccesses(){ saveAccessesToUserData(); const uid=auth.currentUser?.uid; if(!uid) return; await setDoc(doc(db,"usuarios",uid), { accesses: ACCESSES }, { merge:true }); }

    function renderAccesses(){
      loadAccessesFromUserData();
      const list = $("accessList");
      const search = ($("accessSearch").value||"").toLowerCase().trim();
      let items = [...ACCESSES];
      if(search){
        items = items.filter(a => [a.name,a.url,a.user,(a.tags||"")].join(" ").toLowerCase().includes(search));
      }
      list.innerHTML = "";
      if(items.length===0){
        const d=document.createElement("div"); d.className="access-empty"; d.textContent="Nenhum acesso cadastrado."; list.appendChild(d); return;
      }
      items.forEach(a=>{
        const row=document.createElement("div"); row.className="access-row";
        row.innerHTML=`
          <div class="cell"><strong>${a.name||"-"}</strong></div>
          <div class="cell"><a href="${a.url||'#'}" target="_blank" rel="noopener">${a.url||"-"}</a></div>
          <div class="cell">${a.user||"-"}</div>
          <div class="cell">
            <span class="pw" data-pw="${a.pass||""}">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
            <button class="btn small ghost btn-eye" title="Mostrar/ocultar">üëÅ</button>
            <button class="btn small ghost btn-copy-pass" title="Copiar senha">üìã</button>
          </div>
          <div class="cell hide-sm">${(a.tags||"").split(",").filter(Boolean).map(t=>`<span class="pill">${t.trim()}</span>`).join(" ")||"-"}</div>
          <div class="actions">
            <button class="btn small" data-act="edit">Editar</button>
            <button class="btn small secondary" data-act="open">Abrir</button>
            <button class="btn small secondary" data-act="copy-user">Copiar usu√°rio</button>
            <button class="btn small secondary" data-act="del">Excluir</button>
          </div>
        `;
        row.querySelector(".btn-eye").onclick=()=>{
          const span=row.querySelector(".pw"); const cur=span.textContent;
          if(cur.startsWith("‚Ä¢")) span.textContent = span.dataset.pw || "";
          else span.textContent = "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
        };
        row.querySelector(".btn-copy-pass").onclick=()=> navigator.clipboard.writeText(row.querySelector(".pw").dataset.pw||"");
        row.querySelector('[data-act="copy-user"]').onclick=()=> navigator.clipboard.writeText(a.user||"");
        row.querySelector('[data-act="open"]').onclick=()=> { if(a.url) window.open(a.url,"_blank","noopener"); };
        row.querySelector('[data-act="edit"]').onclick=()=> openAccessForm(a);
        row.querySelector('[data-act="del"]').onclick=async()=>{
          if(!confirm("Excluir este acesso?")) return;
          ACCESSES = ACCESSES.filter(x=>x.id!==a.id);
          await persistAccesses(); renderAccesses();
        };
        list.appendChild(row);
      });
    }
    function openAccessForm(item=null){
      accessForm.style.display="grid";
      editingId = item?.id || null;
      $("fName").value = item?.name || "";
      $("fUrl").value  = item?.url  || "";
      $("fUser").value = item?.user || "";
      $("fPass").value = item?.pass || "";
      $("fTags").value = item?.tags || "";
      $("fName").focus();
    }
    $("accessAdd").onclick = ()=> openAccessForm(null);
    $("fCancel").onclick = ()=> { accessForm.style.display="none"; editingId=null; };
    $("fSave").onclick = async ()=>{
      const name=$("fName").value.trim();
      const url =($("fUrl").value||"").trim();
      const user=($("fUser").value||"").trim();
      const pass=($("fPass").value||"").trim();
      const tags=($("fTags").value||"").trim();
      if(!name){ alert("Informe um nome (ex: Instagram, Site, Google My Business)"); $("fName").focus(); return; }
      if(editingId){
        const idx=ACCESSES.findIndex(x=>x.id===editingId);
        if(idx>=0) ACCESSES[idx]={...ACCESSES[idx],name,url,user,pass,tags};
      }else{
        ACCESSES.push({id:uuid(),name,url,user,pass,tags});
      }
      await persistAccesses();
      accessForm.style.display="none"; editingId=null;
      renderAccesses();
    };
    $("accessSearch").addEventListener("input", ()=> renderAccesses());
    $("accessExport").onclick = ()=>{
      const rows = [["Nome","URL","Usu√°rio","Senha","Tags"]];
      ACCESSES.forEach(a=> rows.push([a.name||"",a.url||"",a.user||"",a.pass||"",a.tags||""]));
      const csv = rows.map(r=> r.map(v=> `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
      const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
      const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="acessos.csv"; document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();
    };

    /* ========= CAC DATA ========= */
    let CAC_DATA = { currency:'BRL', expenses:{}, sales:{}, revenue:{}, salesAds:{}, revenueAds:{} };
    function loadCACFromUserData(){
      const data = USER_DATA.cac;
      if(data && typeof data === 'object'){
        CAC_DATA = {
          currency: data.currency || 'BRL',
          expenses: data.expenses || {},
          sales: data.sales || {},
          revenue: data.revenue || {},
          salesAds: data.salesAds || {},
          revenueAds: data.revenueAds || {}
        };
      } else {
        CAC_DATA = { currency:'BRL', expenses:{}, sales:{}, revenue:{}, salesAds:{}, revenueAds:{} };
      }
      try{ refreshMacroInsights(); }catch(_){ }
    }
    async function persistCAC(){
      const uid = auth.currentUser?.uid;
      if(!uid) return;
      USER_DATA.cac = CAC_DATA;
      await setDoc(doc(db,'usuarios',uid), { cac: CAC_DATA }, { merge:true });
      try{ refreshMacroInsights(); }catch(_){ }
    }

    /* ========= metas ========= */
    let METAS = [];
    let META_PANELS = Array(6).fill(null);
    const META_MONTHS = ['jan','fev','mar','abr','mai','jun','jul','ago','set','out','nov','dez'];
    const META_MONTH_LABELS = { jan:'Janeiro', fev:'Fevereiro', mar:'Mar√ßo', abr:'Abril', mai:'Maio', jun:'Junho', jul:'Julho', ago:'Agosto', set:'Setembro', out:'Outubro', nov:'Novembro', dez:'Dezembro' };
    const METAS_LS_KEY = 'mg_metas_cache';
    let metasFormUnsub = null;
    let metasFormAppliedVersions = {};
    const META_TAG_OPTIONS = ['investimento_publicidade','faturamento_trafego','roas_publicidade','taxa_mql','leads_aquecidos','cac','seguidores_tracao','comentarios_gbp','negocios_fechados','valor_contratos_mes','orcamentos_recorrentes','negocios_fechados_recorrentes','taxa_conversao_recorrentes','leads_novos','orcamentos_leads_novos','negocios_fechados_leads_novos','taxa_conversao_leads_novos','valor_orcamentos_perdidos','leads_gerados'];

    function createEmptyMonths(){
      const o = {};
      META_MONTHS.forEach(m => o[m] = { p:'', r:'' });
      return o;
    }

    function createMeta(){
      return {
        id: uuid(),
        pos: 0,
        setor: 'comercial',
        descricao: '',
        tag: '',
        unidade: '%',
        direcao: 'aumentar',
        modo: 'total',
        ativo: true,
        meses: createEmptyMonths()
      };
    }

    function nextMetaPos(){
      return METAS.reduce((max,m)=>Math.max(max, m.pos||0),0) + 1;
    }

    function createDefaultMetas(){
      const defs = [
        {setor:'marketing', descricao:'Investimento em publicidade', unidade:'BRL', direcao:'aumentar', tag:'investimento_publicidade'},
        {setor:'marketing', descricao:'Faturamento com origem no tr√°fego', unidade:'BRL', direcao:'aumentar', tag:'faturamento_trafego'},
        {setor:'marketing', descricao:'N√∫mero de leads gerados', unidade:'BRL', direcao:'aumentar', tag:'faturamento_trafego'},
        {setor:'marketing', descricao:'ROAS (Retorno do Investimento em Publicidade)', unidade:'%', direcao:'aumentar', tag:'roas_publicidade'},
        {setor:'marketing', descricao:'Taxa de leads qualificados (MQL)', unidade:'%', direcao:'aumentar', tag:'taxa_mql'},
        {setor:'marketing', descricao:'CPL (Custo por Lead)', unidade:'BRL', direcao:'diminuir'},
        {setor:'marketing', descricao:'CAC (Custo de Aquisi√ß√£o de Cliente)', unidade:'BRL', direcao:'diminuir', tag:'cac'},
        {setor:'marketing', descricao:'N¬∫ de leads aquecidos (nutri√ß√£o)', unidade:'numero', direcao:'aumentar', tag:'leads_aquecidos'},
        {setor:'marketing', descricao:'N¬∫ de seguidores (canais de tra√ß√£o)', unidade:'numero', direcao:'aumentar', tag:'seguidores_tracao'},
        {setor:'marketing', descricao:'Coment√°rios positivos no GBP', unidade:'numero', direcao:'aumentar', tag:'comentarios_gbp'},
        {setor:'comercial', descricao:'Faturamento total das Vendas', unidade:'BRL', direcao:'aumentar'},
        {setor:'comercial', descricao:'Neg√≥cios fechados de clientes recorrentes', unidade:'numero', direcao:'aumentar'},
        {setor:'comercial', descricao:'Taxa de convers√£o clientes recorrentes', unidade:'%', direcao:'aumentar'},
        {setor:'comercial', descricao:'Leads novos', unidade:'numero', direcao:'aumentar'},
        {setor:'comercial', descricao:'Or√ßamentos leads novos', unidade:'numero', direcao:'aumentar'},
        {setor:'comercial', descricao:'Neg√≥cios fechados leads novos', unidade:'numero', direcao:'aumentar'},
        {setor:'comercial', descricao:'N√∫mero de neg√≥cios fechados', unidade:'numero', direcao:'aumentar', fixed:true},
        {setor:'comercial', descricao:'Taxa de convers√£o leads novos', unidade:'%', direcao:'aumentar'},
        {setor:'comercial', descricao:'Valor de or√ßamentos perdidos', unidade:'BRL', direcao:'diminuir'}
      ];
      return defs.map((d,i) => ({...createMeta(), pos:i+1, ...d}));
    }

    function calcRoasMeta(){
      const active = Array.isArray(METAS) ? METAS.filter(m => m && m.ativo !== false) : [];
      const inv = active.find(m => m.tag === 'investimento_publicidade');
      const fat = active.find(m => m.tag === 'faturamento_trafego');
      const roas = active.find(m => m.tag === 'roas_publicidade');
      if(!inv || !fat || !roas) return;
      roas.unidade = '%';
      META_MONTHS.forEach(m => {
        const invR = parseFloat(inv.meses?.[m]?.r) || 0;
        const fatR = parseFloat(fat.meses?.[m]?.r) || 0;
        if(invR){
          const ratio = fatR / invR;
          roas.meses[m].r = parseFloat(ratio.toFixed(2));
        } else {
          roas.meses[m].r = 0;
        }
      });
    }

    function loadMetasFromUserData(){
      if(!Array.isArray(USER_DATA.metas)){
        try{
          const cached = JSON.parse(localStorage.getItem(METAS_LS_KEY) || '[]');
          if(Array.isArray(cached) && cached.length){
            USER_DATA.metas = cached;
          }
        }catch(_){ /* ignore */ }
      }
      METAS = Array.isArray(USER_DATA.metas) ? USER_DATA.metas : [];
      let changed = false;
      let maxPos = METAS.reduce((max,m)=>Math.max(max, m.pos||0),0);
      METAS = METAS.map(m => {
        const meta = { ...createMeta(), ...m, meses: { ...createEmptyMonths(), ...(m.meses||{}) } };
        if(meta.ativo === undefined){ meta.ativo = true; }
        if(!meta.pos || meta.pos <= 0){ meta.pos = ++maxPos; changed = true; }
        return meta;
      });
      const norm = s => (s||'').toLowerCase().normalize('NFD').replace(/[ÃÄ-ÕØ]/g,'').trim();
      if(METAS.length === 0){
        METAS = createDefaultMetas();
        changed = true;
      }
      METAS = METAS.map(m => {
        const d = norm(m.descricao);
        if(d === 'faturamento total das vendas' || d === 'total de vendas' || d === 'valor dos contratos no mes'){
          if(m.unidade !== 'BRL'){ m.unidade = 'BRL'; changed = true; }
          if(!m.fixed){ m.fixed = true; changed = true; }
        }
        if(d === 'numero de negocios fechados'){
          if(m.unidade !== 'numero'){ m.unidade = 'numero'; changed = true; }
          if(!m.fixed){ m.fixed = true; changed = true; }
        }
        return m;
      });
      calcRoasMeta();
      try{ localStorage.setItem(METAS_LS_KEY, JSON.stringify(METAS)); }catch(_){ }
      if(changed){
        persistMetas();
      }
      try{ refreshMacroInsights(); }catch(_){ }
    }

    async function persistMetas(){
      calcRoasMeta();
      USER_DATA.metas = METAS;
      try{ localStorage.setItem(METAS_LS_KEY, JSON.stringify(METAS)); }catch(_){ }
      const uid = auth.currentUser?.uid;
      if(uid){
        try{
          await setDoc(doc(db,'usuarios',uid), { metas: METAS }, { merge:true });
        }catch(e){ console.error('persistMetas setDoc', e); }
      }
      if (typeof renderCAC === 'function' && renderCAC.refresh) {
        try {
          renderCAC.refresh();
        } catch (e) { /* noop */ }
      }
      try{ refreshMacroInsights(); }catch(_){ }
    }

    function loadMetaPanelsFromUserData(){
      META_PANELS = Array.isArray(USER_DATA.metaPanels) ? USER_DATA.metaPanels.slice(0,6) : [];
      while(META_PANELS.length < 6) META_PANELS.push(null);
    }

    async function persistMetaPanels(){
      const uid = auth.currentUser?.uid;
      if(!uid) return;
      await setDoc(doc(db,'usuarios',uid), { metaPanels: META_PANELS }, { merge:true });
    }

    function normalizeClientKey(key){
      return (key || '').toString().replace(/[^\w-]/g,'_');
    }

    function getSafeClientKey(){
      if(Array.isArray(clientDocPathParts) && clientDocPathParts.length >= 4){
        return clientDocPathParts[3];
      }
      const raw = getClientKey();
      if(!raw) return null;
      return normalizeClientKey(raw);
    }

    function buildMetasFormUrl(token, safeKey, rawClientKey){
      const base = new URL(location.href);
      base.search = '';
      base.hash = '';
      if(!base.pathname.endsWith('/')){
        const idx = base.pathname.lastIndexOf('/');
        base.pathname = idx >= 0 ? base.pathname.slice(0, idx + 1) : '/';
      }
      const target = new URL('metas-form.html', base);
      target.searchParams.set('token', token);
      const clientParam = safeKey || rawClientKey || '';
      if(clientParam){
        target.searchParams.set('client', clientParam);
      }
      return target.toString();
    }

    function buildApprovalLink(token, safeKey, rawClientKey){
      const base = new URL(location.href);
      base.search = '';
      base.hash = '';
      if(!base.pathname.endsWith('/')){
        const idx = base.pathname.lastIndexOf('/');
        base.pathname = idx >= 0 ? base.pathname.slice(0, idx + 1) : '/';
      }
      const target = new URL('approval.html', base);
      target.searchParams.set('token', token);
      const clientParam = safeKey || rawClientKey || '';
      if(clientParam){
        target.searchParams.set('client', clientParam);
      }
      return target.toString();
    }

    function buildCalendarShareLink(token, safeKey, rawClientKey, monthKey){
      const base = new URL(location.href);
      base.search = '';
      base.hash = '';
      if(!base.pathname.endsWith('/')){
        const idx = base.pathname.lastIndexOf('/');
        base.pathname = idx >= 0 ? base.pathname.slice(0, idx + 1) : '/';
      }
      const target = new URL('calendario-publico.html', base);
      target.searchParams.set('token', token);
      const clientParam = safeKey || rawClientKey || '';
      if(clientParam){
        target.searchParams.set('client', clientParam);
      }
      if(monthKey){
        target.searchParams.set('month', monthKey);
      }
      return target.toString();
    }

    function buildPlanningShareLink(token, safeKey, rawClientKey, monthKey){
      const base = new URL(location.href);
      base.search = '';
      base.hash = '';
      if(!base.pathname.endsWith('/')){
        const idx = base.pathname.lastIndexOf('/');
        base.pathname = idx >= 0 ? base.pathname.slice(0, idx + 1) : '/';
      }
      const target = new URL('planejamento-publico.html', base);
      target.searchParams.set('token', token);
      const clientParam = safeKey || rawClientKey || '';
      if(clientParam){
        target.searchParams.set('client', clientParam);
      }
      if(monthKey){
        target.searchParams.set('month', monthKey);
      }
      return target.toString();
    }

    function sanitizeMetaFormNumber(value){
      if(value === '' || value === null || value === undefined) return null;
      if(typeof value === 'number'){ return Number.isFinite(value) ? value : null; }
      const parsed = typeof value === 'string' ? parseFloat(value.replace(',', '.')) : Number(value);
      return Number.isFinite(parsed) ? parsed : null;
    }

    function applyMetasFormResponses(responses, monthKey, projectionMonths){
      if(!responses || typeof responses !== 'object') return false;
      const validMonth = META_MONTHS.includes(monthKey) ? monthKey : META_MONTHS[new Date().getMonth()];
      let months = Array.isArray(projectionMonths) && projectionMonths.length
        ? projectionMonths.filter(m => META_MONTHS.includes(m))
        : META_MONTHS.slice(Math.max(0, META_MONTHS.indexOf(validMonth)));
      if(!months.length){
        months = META_MONTHS.slice();
      }
      let changed = false;
      Object.entries(responses).forEach(([metaId, payload]) => {
        if(!payload || typeof payload !== 'object') return;
        const meta = METAS.find(m => m && m.id === metaId);
        if(!meta || meta.ativo === false) return;
        if(!meta.meses){ meta.meses = createEmptyMonths(); }
        if(!meta.meses[validMonth]){ meta.meses[validMonth] = { p:'', r:'' }; }

        if(Object.prototype.hasOwnProperty.call(payload, 'current')){
          const num = sanitizeMetaFormNumber(payload.current);
          if(num === null){
            if(meta.meses[validMonth].r !== ''){
              meta.meses[validMonth].r = '';
              changed = true;
            }
          } else {
            const prev = sanitizeMetaFormNumber(meta.meses[validMonth].r);
            if(prev === null || Math.abs(prev - num) > 0.000001){
              meta.meses[validMonth].r = num;
              changed = true;
            }
          }
        }

        if(payload.projections && typeof payload.projections === 'object'){
          months.forEach(month => {
            if(!meta.meses[month]){ meta.meses[month] = { p:'', r:'' }; }
            if(Object.prototype.hasOwnProperty.call(payload.projections, month)){
              const val = sanitizeMetaFormNumber(payload.projections[month]);
              if(val === null){
                if(meta.meses[month].p !== ''){
                  meta.meses[month].p = '';
                  changed = true;
                }
              } else {
                const prev = sanitizeMetaFormNumber(meta.meses[month].p);
                if(prev === null || Math.abs(prev - val) > 0.000001){
                  meta.meses[month].p = val;
                  changed = true;
                }
              }
            }
          });
        }
      });
      return changed;
    }

    function processMetasFormDoc(docSnap){
      const data = docSnap.data();
      if(!data) return;
      const version = data.version || 0;
      if(!version) return;
      if(data.appliedVersion && data.appliedVersion === version) return;
      if(metasFormAppliedVersions[docSnap.id] === version) return;
      const responses = data.responses;
      if(!responses || typeof responses !== 'object' || !Object.keys(responses).length) return;
      const monthKey = data.monthKey || META_MONTHS[new Date().getMonth()];
      const projectionMonths = Array.isArray(data.projectionMonths) ? data.projectionMonths : [];
      const changed = applyMetasFormResponses(responses, monthKey, projectionMonths);
      metasFormAppliedVersions[docSnap.id] = version;
      setDoc(docSnap.ref, { appliedVersion: version, appliedAt: serverTimestamp() }, { merge: true })
        .catch(err => console.warn('metasForms applied mark', err));
      if(changed){
        persistMetas();
        renderMetas();
        renderMetaSummary();
        if(typeof mgToast === 'function'){
          mgToast('Metas atualizadas com respostas do cliente.');
        }
      }
    }

    function refreshMetasFormSubscription(){
      if(metasFormUnsub){
        try{ metasFormUnsub(); }catch(_e){}
        metasFormUnsub = null;
      }
      metasFormAppliedVersions = {};
      const uid = auth.currentUser?.uid;
      if(!uid){
        return;
      }
      const safeKey = getSafeClientKey();
      if(!safeKey){
        return;
      }
      try{
        const col = collection(db, 'metasForms');
        const qy = query(col, where('uid','==', uid), where('clientKeyNormalized','==', safeKey));
        metasFormUnsub = onSnapshot(qy, snap => {
          snap.forEach(docSnap => processMetasFormDoc(docSnap));
        }, err => console.warn('metasForms snapshot', err));
      }catch(err){
        console.warn('refreshMetasFormSubscription', err);
      }
    }

    async function handleSendMetasLink(){
      const btn = $('sendMetasLink');
      const originalText = btn ? btn.textContent : '';
      if(btn){
        btn.disabled = true;
        btn.textContent = 'Gerando link...';
      }
      try{
        if(!auth?.currentUser){
          throw new Error('Fa√ßa login para gerar o link.');
        }
        const clientKey = getClientKey();
        if(!clientKey){
          throw new Error('Cliente n√£o identificado.');
        }
        const safeKey = getSafeClientKey();
        const activeMetas = Array.isArray(METAS) ? METAS.filter(meta => meta && meta.ativo !== false) : [];
        if(!activeMetas.length){
          throw new Error('Cadastre ao menos uma meta ativa antes de enviar o link.');
        }
        const now = new Date();
        const monthKey = META_MONTHS[now.getMonth()];
        const monthLabel = metaMonthLabel(monthKey);
        const projectionMonths = META_MONTHS.slice(META_MONTHS.indexOf(monthKey));
        const metasPayload = activeMetas
          .map(meta => {
            const proj = {};
            projectionMonths.forEach(m => {
              const raw = meta.meses?.[m]?.p;
              const num = sanitizeMetaFormNumber(raw);
              proj[m] = num !== null ? num : null;
            });
            return {
              id: meta.id,
              descricao: meta.descricao || '',
              unidade: meta.unidade || 'numero',
              pos: meta.pos || 0,
              currentValue: sanitizeMetaFormNumber(meta.meses?.[monthKey]?.r),
              projections: proj
            };
          })
          .sort((a,b) => {
            const posDiff = (a.pos||0) - (b.pos||0);
            if(posDiff !== 0) return posDiff;
            return (a.descricao||'').localeCompare(b.descricao||'', 'pt-BR', { sensitivity:'base' });
          });

        const token = (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : uuid();
        const version = Date.now();
        const docData = {
          token,
          uid: auth.currentUser.uid,
          clientKey,
          clientKeyNormalized: safeKey || normalizeClientKey(clientKey),
          clientLabel: formatClientDisplayName(clientKey) || clientKey,
          monthKey,
          monthLabel,
          projectionMonths,
          metas: metasPayload,
          responses: {},
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          version
        };
        await setDoc(doc(db, 'metasForms', token), docData);
        const shareUrl = buildMetasFormUrl(token, docData.clientKeyNormalized, clientKey);
        let copied = false;
        if(navigator?.clipboard?.writeText){
          try{
            await navigator.clipboard.writeText(shareUrl);
            copied = true;
          }catch(_e){ copied = false; }
        }
        if(copied){
          if(typeof mgToast === 'function'){
            mgToast('Link copiado! Envie ao cliente para preencher as metas.');
          }
        } else {
          prompt('Link gerado. Copie e envie ao cliente:', shareUrl);
        }
      }catch(err){
        console.error('handleSendMetasLink', err);
        alert(err?.message || 'N√£o foi poss√≠vel gerar o link.');
      }finally{
        if(btn){
          btn.disabled = false;
          btn.textContent = originalText || 'Enviar link para cliente';
        }
      }
    }

    function colorClass(p){
      if(p >= 100) return 'concl-azul';
      if(p >= 80)  return 'concl-verde';
      if(p >= 50)  return 'concl-amarelo';
      if(p >= 20)  return 'concl-laranja';
      return 'concl-vermelho';
    }

    function formatMetaNumber(val, unidade){
      if(!isFinite(val)) val = 0;
      if(unidade === 'BRL' || unidade === 'USD'){
        return val.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
      }
      return val.toFixed(2);
    }

    function formatMetaDisplay(val, unidade){
      const num = formatMetaNumber(val, unidade);
      if(unidade === 'BRL') return 'R$ ' + num;
      if(unidade === 'USD') return 'US$ ' + num;
      if(unidade === '%') return num + '%';
      return num;
    }

    function formatMetaInput(val, unidade){
      if(val === '' || val === null || val === undefined) return '';
      if(unidade === 'BRL' || unidade === 'USD' || unidade === '%'){
        const num = parseFloat(val) || 0;
        return formatMetaNumber(num, unidade);
      }
      return val;
    }

    function parseMetaInput(str, unidade){
      if(unidade === 'BRL' || unidade === 'USD'){
        return parseFloat(str.replace(/\./g,'').replace(',','.')) || 0;
      }
      return parseFloat(str) || 0;
    }

    function metaMonthLabel(key){
      return META_MONTH_LABELS[key] || key.toUpperCase();
    }

    function metaValueKindLabel(kind){
      return kind === 'planned' ? 'planejado' : 'realizado';
    }

    let metaInputTimer;
    let metaPersistTimer;
    function scheduleMetaRerender(metaId, month, cls){
      clearTimeout(metaInputTimer);
      metaInputTimer = setTimeout(()=>{
        renderMetas();
        const sel = document.querySelector(`input.${cls}[data-meta-id="${metaId}"][data-month="${month}"]`);
        if(sel) sel.focus();
      }, 300);
    }

    function scheduleMetaPersist(){
      clearTimeout(metaPersistTimer);
      metaPersistTimer = setTimeout(()=>{
        metaPersistTimer = null;
        persistMetas();
      }, 500);
    }

    function flushMetaPersist(){
      if(metaPersistTimer){
        clearTimeout(metaPersistTimer);
        metaPersistTimer = null;
      }
      persistMetas();
    }

    let metaBulkMenu = null;
    let metaBulkMenuData = null;

    function ensureMetaBulkMenu(){
      if(metaBulkMenu) return metaBulkMenu;
      metaBulkMenu = document.createElement('div');
      metaBulkMenu.id = 'metaBulkMenu';
      metaBulkMenu.className = 'meta-bulk-menu';
      metaBulkMenu.innerHTML = '<div class="meta-bulk-header"></div>' +
        '<div class="meta-bulk-quick">' +
          '<button type="button" class="meta-bulk-quick-future">Meses seguintes</button>' +
          '<button type="button" class="meta-bulk-quick-all">Todos</button>' +
          '<button type="button" class="meta-bulk-quick-clear">Limpar</button>' +
        '</div>' +
        '<div class="meta-bulk-list"></div>' +
        '<div class="meta-bulk-footer">' +
          '<button type="button" class="cancel">Cancelar</button>' +
          '<button type="button" class="apply">Aplicar</button>' +
        '</div>';
      document.body.appendChild(metaBulkMenu);
      metaBulkMenu.querySelector('.cancel').addEventListener('click', hideMetaBulkMenu);
      metaBulkMenu.querySelector('.apply').addEventListener('click', applyMetaBulkSelection);
      metaBulkMenu.querySelector('.meta-bulk-quick-all').addEventListener('click', selectMetaBulkAll);
      metaBulkMenu.querySelector('.meta-bulk-quick-clear').addEventListener('click', clearMetaBulkSelection);
      metaBulkMenu.querySelector('.meta-bulk-quick-future').addEventListener('click', selectMetaBulkFuture);
      document.addEventListener('mousedown', handleMetaBulkOutside);
      document.addEventListener('touchstart', handleMetaBulkOutside);
      window.addEventListener('resize', hideMetaBulkMenu);
      window.addEventListener('scroll', hideMetaBulkMenu, true);
      document.addEventListener('keydown', handleMetaBulkEsc);
      return metaBulkMenu;
    }

    function handleMetaBulkEsc(ev){
      if(ev.key === 'Escape') hideMetaBulkMenu();
    }

    function handleMetaBulkOutside(ev){
      if(!metaBulkMenu || !metaBulkMenu.classList.contains('show')) return;
      if(metaBulkMenu.contains(ev.target)) return;
      if(ev.target.closest && ev.target.closest('.meta-bulk-btn')) return;
      hideMetaBulkMenu();
    }

    function hideMetaBulkMenu(){
      if(!metaBulkMenu) return;
      metaBulkMenu.classList.remove('show');
      metaBulkMenu.style.left = '-9999px';
      metaBulkMenu.style.top = '-9999px';
      metaBulkMenuData = null;
    }

    function setMetaBulkSelection(predicate){
      const menu = ensureMetaBulkMenu();
      const boxes = menu.querySelectorAll('.meta-bulk-list input[type="checkbox"]');
      boxes.forEach(cb => {
        cb.checked = !!predicate(cb);
      });
    }

    function selectMetaBulkAll(){
      setMetaBulkSelection(() => true);
    }

    function clearMetaBulkSelection(){
      setMetaBulkSelection(() => false);
    }

    function selectMetaBulkFuture(){
      if(!metaBulkMenuData) return;
      const limit = metaBulkMenuData.index;
      setMetaBulkSelection(cb => {
        const idx = parseInt(cb.dataset.index, 10);
        return idx > limit;
      });
    }

    function applyMetaBulkSelection(){
      if(!metaBulkMenuData) return;
      const menu = ensureMetaBulkMenu();
      const selected = Array.from(menu.querySelectorAll('.meta-bulk-list input[type="checkbox"]:checked')).map(cb => cb.value);
      if(!selected.length){
        if(typeof mgToast === 'function') mgToast('Selecione ao menos um m√™s.');
        return;
      }
      const { metaId, month, kind } = metaBulkMenuData;
      const typeLabel = metaValueKindLabel(kind);
      applyMetaBulk(metaId, month, kind, selected);
      hideMetaBulkMenu();
      if(typeof mgToast === 'function'){
        const plural = selected.length > 1 ? 'meses' : 'm√™s';
        mgToast(`Valor ${typeLabel} aplicado em ${selected.length} ${plural}.`);
      }
    }

    function applyMetaBulk(metaId, sourceMonth, kind, targetMonths){
      if(!Array.isArray(targetMonths) || !targetMonths.length) return;
      const meta = METAS.find(m => m.id === metaId);
      if(!meta) return;
      const key = kind === 'realized' ? 'r' : 'p';
      const sourceVal = meta.meses?.[sourceMonth]?.[key];
      targetMonths.forEach(month => {
        if(!meta.meses[month]) meta.meses[month] = { p:'', r:'' };
        meta.meses[month][key] = sourceVal;
      });
      scheduleMetaPersist();
      scheduleMetaRerender(metaId, sourceMonth, kind === 'realized' ? 'realized' : 'planned');
    }

    function showMetaBulkMenu(trigger, metaId, month, kind){
      const meta = METAS.find(m => m.id === metaId);
      if(!meta) return;
      const menu = ensureMetaBulkMenu();
      if(metaBulkMenuData && metaBulkMenuData.metaId === metaId && metaBulkMenuData.month === month && metaBulkMenuData.kind === kind && menu.classList.contains('show')){
        hideMetaBulkMenu();
        return;
      }
      const monthIndex = Math.max(0, META_MONTHS.indexOf(month));
      metaBulkMenuData = { metaId, month, kind, index: monthIndex };
      const header = menu.querySelector('.meta-bulk-header');
      header.textContent = `Aplicar valor ${metaValueKindLabel(kind)} de ${metaMonthLabel(month)} para:`;
      const list = menu.querySelector('.meta-bulk-list');
      list.innerHTML = '';
      META_MONTHS.forEach((m, idx) => {
        if(m === month) return;
        const label = document.createElement('label');
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.value = m;
        cb.dataset.index = idx;
        label.appendChild(cb);
        const span = document.createElement('span');
        span.textContent = metaMonthLabel(m);
        label.appendChild(span);
        list.appendChild(label);
      });
      const futureBtn = menu.querySelector('.meta-bulk-quick-future');
      futureBtn.disabled = metaBulkMenuData.index >= META_MONTHS.length - 1;
      selectMetaBulkFuture();
      if(!list.querySelector('input[type="checkbox"]:checked')){
        selectMetaBulkAll();
      }
      menu.classList.add('show');
      menu.style.visibility = 'hidden';
      menu.style.left = '0px';
      menu.style.top = '0px';
      requestAnimationFrame(() => {
        const rect = trigger.getBoundingClientRect();
        const menuRect = menu.getBoundingClientRect();
        let left = rect.left + window.scrollX;
        let top = rect.bottom + window.scrollY + 6;
        const maxLeft = window.scrollX + window.innerWidth - menuRect.width - 8;
        const maxTop = window.scrollY + window.innerHeight - menuRect.height - 8;
        if(left > maxLeft) left = Math.max(window.scrollX + 8, maxLeft);
        if(top > maxTop) top = rect.top + window.scrollY - menuRect.height - 6;
        if(top < window.scrollY + 8) top = window.scrollY + 8;
        if(left < window.scrollX + 8) left = window.scrollX + 8;
        menu.style.left = left + 'px';
        menu.style.top = top + 'px';
        menu.style.visibility = 'visible';
      });
    }

    function clearAllMetas(){
      if(!METAS.length){
        if(typeof mgToast === 'function'){ mgToast('Nenhuma meta cadastrada para limpar.'); }
        return;
      }
      if(!confirm('Limpar todos os valores planejados e realizados das metas deste ano?')){
        return;
      }
      if(metaPersistTimer){
        clearTimeout(metaPersistTimer);
        metaPersistTimer = null;
      }
      METAS = METAS.map(meta => ({ ...meta, meses: createEmptyMonths() }));
      persistMetas();
      renderMetas();
      if(typeof mgToast === 'function'){ mgToast('Metas limpas com sucesso.'); }
    }

    function resetMetasToDefault(){
      if(!confirm('Resetar todas as metas para o padr√£o inicial? Isso remover√° metas atuais personalizadas.')){
        return;
      }
      if(metaPersistTimer){
        clearTimeout(metaPersistTimer);
        metaPersistTimer = null;
      }
      METAS = createDefaultMetas();
      META_PANELS = Array(6).fill(null);
      USER_DATA.metaPanels = META_PANELS;
      persistMetaPanels();
      persistMetas();
      renderMetas();
      if(typeof mgToast === 'function'){ mgToast('Metas redefinidas com sucesso para o padr√£o inicial.'); }
    }

    function renderMetas(){
      const container = $('metasContainer');
      if(!container) return;
      hideMetaBulkMenu();
      renderMetaSummary();
      container.innerHTML = '';
      const mobile = window.matchMedia('(max-width:600px)').matches;
      const months = META_MONTHS;

      ['marketing','comercial'].forEach(setor => {
        const metas = METAS.filter(m => (m.setor || 'comercial') === setor);
        const wrap = document.createElement('div');
        wrap.className = 'meta-setor ' + setor;

        const title = document.createElement('h3');
        title.textContent = setor.charAt(0).toUpperCase() + setor.slice(1);
        wrap.appendChild(title);

        const table = document.createElement('table');
        table.className = 'metas-table';
        
        const colgroup = document.createElement('colgroup');
        if(!mobile){
          const colInfo = document.createElement('col');
          colInfo.className = 'meta-col-info';
          colgroup.appendChild(colInfo);
        }
        months.forEach(() => {
          const col = document.createElement('col');
          col.className = 'meta-col-month';
          colgroup.appendChild(col);
        });
        const colTotal = document.createElement('col');
        colTotal.className = 'meta-col-total';
        colgroup.appendChild(colTotal);
        table.appendChild(colgroup);

        const thead = document.createElement('thead');
        thead.innerHTML = mobile
          ? '<tr>' + months.map(m => '<th>' + m.substring(0,3).toUpperCase() + '</th>').join('') + '<th>Total</th></tr>'
          : '<tr><th class="meta-name">Meta</th>' + months.map(m => '<th>' + m.substring(0,3).toUpperCase() + '</th>').join('') + '<th>Total</th></tr>';
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        metas.forEach(meta => tbody.appendChild(createMetaRows(meta, mobile)));
        table.appendChild(tbody);
        wrap.appendChild(table);
        container.appendChild(wrap);
      });

      const addBtn = $('addMeta');
      if(addBtn){
        addBtn.onclick = () => {
          const m = createMeta();
          m.pos = nextMetaPos();
          METAS.push(m);
          persistMetas();
          renderMetas();
        };
      }

      const shareBtn = $('sendMetasLink');
      if(shareBtn){
        shareBtn.onclick = handleSendMetasLink;
      }

      const clearBtn = $('clearMetas');
      if(clearBtn){
        clearBtn.onclick = clearAllMetas;
      }

      const resetBtn = $('resetMetas');
      if(resetBtn){
        resetBtn.onclick = resetMetasToDefault;
      }
    }

    function renderMetaSummary(){
      const wrap = $('metasSummary');
      if(!wrap) return;
      const monthKey = META_MONTHS[new Date().getMonth()];
      wrap.innerHTML = '';
      for(let i=0;i<6;i++){
        const panel = document.createElement('div');
        panel.className = 'meta-panel';
        const sel = document.createElement('select');
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'Selecione';
        sel.appendChild(opt);
        METAS.forEach(m=>{
          const o=document.createElement('option');
          o.value=m.id;
          const active = m.ativo !== false;
          o.textContent=(m.pos? m.pos + ' - ' : '') + (m.descricao||'') + (active ? '' : ' (inativa)');
          sel.appendChild(o);
        });
        sel.value = META_PANELS[i] || '';
        sel.onchange = ()=>{
          META_PANELS[i] = sel.value || null;
          persistMetaPanels();
          renderMetaSummary();
        };
        panel.appendChild(sel);
        const stats = document.createElement('div');
        stats.className = 'stats';
        const addStat = (label, value) => {
          const line = document.createElement('div');
          line.className = 'stat-line';
          const lab = document.createElement('span');
          lab.className = 'stat-label';
          lab.textContent = label;
          const val = document.createElement('span');
          val.className = 'stat-value';
          val.textContent = value;
          line.appendChild(lab);
          line.appendChild(val);
          stats.appendChild(line);
        };
        const meta = METAS.find(m=>m.id===META_PANELS[i]);
        if(meta && meta.ativo !== false){
          const mes = meta.meses?.[monthKey] || {};
          const mesP = parseFloat(mes.p) || 0;
          const mesR = parseFloat(mes.r) || 0;
          const anoP = META_MONTHS.reduce((s,m)=>s+(parseFloat(meta.meses?.[m]?.p)||0),0);
          const anoR = META_MONTHS.reduce((s,m)=>s+(parseFloat(meta.meses?.[m]?.r)||0),0);
          addStat('M√™s', `${formatMetaDisplay(mesR, meta.unidade)} / ${formatMetaDisplay(mesP, meta.unidade)}`);
          addStat('Ano', `${formatMetaDisplay(anoR, meta.unidade)} / ${formatMetaDisplay(anoP, meta.unidade)}`);
        } else if(meta){
          addStat('Status', 'Meta desativada');
          addStat('M√™s', '-');
          addStat('Ano', '-');
        } else {
          addStat('M√™s', '-');
          addStat('Ano', '-');
        }
        panel.appendChild(stats);
        wrap.appendChild(panel);
      }
    }

    window.addEventListener('resize', () => {
      if (currentSection === 'metas') renderMetas();
    });

    function createMetaRows(meta, mobile=false){
      const months = META_MONTHS;
      const frag = document.createDocumentFragment();
      const rows = [];
      const computeTitle = () => (meta.pos ? meta.pos + ' - ' : '') + (meta.descricao || '');
      const applyRowState = () => {
        const active = meta.ativo !== false;
        rows.forEach(row => {
          if(row){
            row.classList.toggle('meta-inactive', !active);
          }
        });
      };
      const applyToggleVisual = btn => {
        if(!btn) return;
        const active = meta.ativo !== false;
        btn.classList.toggle('on', active);
        btn.classList.toggle('off', !active);
        btn.textContent = active ? 'ON' : 'OFF';
        btn.setAttribute('aria-pressed', active ? 'true' : 'false');
        btn.setAttribute('aria-label', active ? 'Desativar meta' : 'Ativar meta');
      };
      const setupToggle = btn => {
        if(!btn) return;
        applyToggleVisual(btn);
        btn.addEventListener('click', ev => {
          ev.preventDefault();
          ev.stopPropagation();
          meta.ativo = meta.ativo === false ? true : false;
          applyToggleVisual(btn);
          applyRowState();
          persistMetas();
          renderMetas();
        });
      };

      const trTitle = document.createElement('tr');
      trTitle.className = 'meta-title-row';
      rows.push(trTitle);
      if(!mobile){
        const tdSpacer = document.createElement('td');
        tdSpacer.className = 'meta-title-spacer';
        trTitle.appendChild(tdSpacer);
      }
      const tdTitle = document.createElement('td');
      tdTitle.className = 'meta-title-cell';
      tdTitle.colSpan = months.length + 1;
      const titleWrap = document.createElement('div');
      titleWrap.className = 'meta-title-content';
      const titleTextEl = document.createElement('span');
      titleTextEl.className = 'meta-title-text';
      titleTextEl.textContent = computeTitle();
      titleWrap.appendChild(titleTextEl);
      const updateTitleText = () => { titleTextEl.textContent = computeTitle(); };
      if(mobile){
        const toggleWrap = document.createElement('div');
        toggleWrap.className = 'meta-activation';
        const toggleBtn = document.createElement('button');
        toggleBtn.type = 'button';
        toggleBtn.className = 'meta-toggle';
        toggleWrap.appendChild(toggleBtn);
        titleWrap.appendChild(toggleWrap);
        setupToggle(toggleBtn);
      }
      tdTitle.appendChild(titleWrap);
      trTitle.appendChild(tdTitle);
      frag.appendChild(trTitle);

      const trMonths = document.createElement('tr');
      trMonths.className = 'meta-months-row';
      rows.push(trMonths);
      if(!mobile){
        const tdSpacer = document.createElement('td');
        tdSpacer.className = 'meta-title-spacer';
        trMonths.appendChild(tdSpacer);
      }
      months.forEach(m => {
        const td = document.createElement('td');
        td.textContent = m.substring(0,3).toUpperCase();
        trMonths.appendChild(td);
      });
      const tdTotLabel = document.createElement('td');
      tdTotLabel.textContent = 'Total';
      trMonths.appendChild(tdTotLabel);
      frag.appendChild(trMonths);

      const trP = document.createElement('tr');
      trP.className = 'projetado';
      rows.push(trP);

      let info;
      if(!mobile){
        info = document.createElement('td');
        info.className = 'meta-info';
        info.rowSpan = 4;
        const actionsHtml = meta.fixed
          ? '<div class="actions"><button class="up">‚Üë</button><button class="down">‚Üì</button><button class="del">Excluir</button></div>'
          : '<div class="actions"><button class="up">‚Üë</button><button class="down">‚Üì</button><button class="dup">Duplicar</button><button class="del">Excluir</button></div>';
        const tagOpts = '<option value=""></option>' + META_TAG_OPTIONS.map(t=>'<option value="'+t+'"'+(meta.tag===t?' selected':'')+'>'+t+'</option>').join('');
        info.innerHTML = `
          <div class="meta-activation"><button type="button" class="meta-toggle"></button></div>
          <input type="number" class="meta-pos" placeholder="N¬∫" min="1" style="width:50px">
          <input type="text" class="meta-desc" placeholder="Descri√ß√£o">
          <select class="meta-tag">${tagOpts}</select>
          <select class="meta-setor"><option value="comercial">Comercial</option><option value="marketing">Marketing</option></select>
          <select class="meta-unidade"><option value="%">%</option><option value="BRL">R$</option><option value="USD">US$</option><option value="numero">N√∫mero</option></select>
          <select class="meta-direcao"><option value="aumentar">Aumentar</option><option value="diminuir">Diminuir</option></select>
          <div class="meta-modo">
            <label><input type="radio" name="modo_${meta.id}" value="total"> Valor total</label>
            <label><input type="radio" name="modo_${meta.id}" value="media"> Valor m√©dio</label>
          </div>
          ${actionsHtml}`;
        trP.appendChild(info);
        setupToggle(info.querySelector('.meta-toggle'));
      }

      months.forEach(m => {
        const td = document.createElement('td');
        const cell = document.createElement('div');
        cell.className = 'meta-cell';
        const inp = document.createElement('input');
        inp.type = 'text';
        inp.inputMode = 'decimal';
        inp.className = 'planned';
        inp.dataset.metaId = meta.id;
        inp.dataset.month = m;
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'meta-bulk-btn';
        btn.title = 'Aplicar valor em outros meses';
        btn.setAttribute('aria-label', 'Aplicar valor planejado em outros meses');
        btn.textContent = '‚áÜ';
        btn.addEventListener('click', ev => {
          ev.preventDefault();
          ev.stopPropagation();
          showMetaBulkMenu(btn, meta.id, m, 'planned');
        });
        cell.appendChild(inp);
        cell.appendChild(btn);
        td.appendChild(cell);
        trP.appendChild(td);
      });
      const tdTotP = document.createElement('td');
      trP.appendChild(tdTotP);

      const trR = document.createElement('tr');
      trR.className = 'realizado';
      rows.push(trR);
      months.forEach(m => {
        const td = document.createElement('td');
        const cell = document.createElement('div');
        cell.className = 'meta-cell';
        const inp = document.createElement('input');
        inp.type = 'text';
        inp.inputMode = 'decimal';
        inp.className = 'realized';
        inp.dataset.metaId = meta.id;
        inp.dataset.month = m;
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'meta-bulk-btn';
        btn.title = 'Aplicar valor em outros meses';
        btn.setAttribute('aria-label', 'Aplicar valor realizado em outros meses');
        btn.textContent = '‚áÜ';
        btn.addEventListener('click', ev => {
          ev.preventDefault();
          ev.stopPropagation();
          showMetaBulkMenu(btn, meta.id, m, 'realized');
        });
        cell.appendChild(inp);
        cell.appendChild(btn);
        td.appendChild(cell);
        trR.appendChild(td);
      });
      const tdTotR = document.createElement('td');
      trR.appendChild(tdTotR);

      const trC = document.createElement('tr');
      trC.className = 'conclusao';
      rows.push(trC);
      const conclMonthCells = [];
      months.forEach(() => {
        const td = document.createElement('td');
        conclMonthCells.push(td);
        trC.appendChild(td);
      });
      const tdTotC = document.createElement('td');
      trC.appendChild(tdTotC);

      const trE = document.createElement('tr');
      trE.className = 'evolucao';
      rows.push(trE);
      const evolMonthCells = [];
      months.forEach(() => {
        const td = document.createElement('td');
        evolMonthCells.push(td);
        trE.appendChild(td);
      });
      const tdTotE = document.createElement('td');
      trE.appendChild(tdTotE);

      const updateMetaCalculations = () => {
        let sumP = 0, sumR = 0;
        let prev = null, eSum = 0, eCount = 0;
        months.forEach((m, idx) => {
          const monthData = meta.meses?.[m] || {};
          const p = parseFloat(monthData.p) || 0;
          const r = parseFloat(monthData.r) || 0;
          sumP += p;
          sumR += r;
          const pct = p ? (r / p * 100) : 0;
          const conclCell = conclMonthCells[idx];
          if(conclCell){
            conclCell.textContent = p ? pct.toFixed(2) + '%' : '-';
            conclCell.className = colorClass(pct);
          }
          let evoText = '-';
          if(prev !== null && prev !== 0){
            const e = ((r - prev) / prev) * 100;
            evoText = e.toFixed(2) + '%';
            eSum += e;
            eCount++;
          }
          const evolCell = evolMonthCells[idx];
          if(evolCell){
            evolCell.textContent = evoText;
          }
          prev = r;
        });
        const divisor = meta.modo === 'media' ? months.length : 1;
        tdTotP.textContent = formatMetaNumber(sumP / divisor, meta.unidade);
        tdTotR.textContent = formatMetaNumber(sumR / divisor, meta.unidade);
        const totalPct = sumP ? (sumR / sumP * 100) : 0;
        tdTotC.textContent = sumP ? totalPct.toFixed(2) + '%' : '-';
        tdTotC.className = colorClass(totalPct);
        tdTotE.textContent = eCount ? (eSum / eCount).toFixed(2) + '%' : '-';
      };

      updateMetaCalculations();

      if(info){
        const desc = info.querySelector('.meta-desc');
        const posInp = info.querySelector('.meta-pos');
        desc.value = meta.descricao;
        posInp.value = meta.pos || '';
        const syncTitle = () => { updateTitleText(); };
        syncTitle();
        if(meta.fixed){ desc.disabled = true; }
        desc.addEventListener('input', () => { meta.descricao = desc.value; syncTitle(); });
        desc.addEventListener('blur', () => { meta.descricao = desc.value; syncTitle(); persistMetas(); });
        posInp.onchange = () => { meta.pos = parseInt(posInp.value,10) || 0; syncTitle(); persistMetas(); renderMetaSummary(); };

        const setorSel = info.querySelector('.meta-setor');
        setorSel.value = meta.setor;
        if(meta.fixed){ setorSel.disabled = true; }
        setorSel.onchange = () => { meta.setor = setorSel.value; persistMetas(); renderMetas(); };

        const unSel = info.querySelector('.meta-unidade');
        unSel.value = meta.unidade;
        if(meta.fixed){ unSel.disabled = true; }
        unSel.onchange = () => { meta.unidade = unSel.value; persistMetas(); renderMetas(); };

        const dirSel = info.querySelector('.meta-direcao');
        dirSel.value = meta.direcao;
        if(meta.fixed){ dirSel.disabled = true; }
        dirSel.onchange = () => { meta.direcao = dirSel.value; persistMetas(); };

        const tagSel = info.querySelector('.meta-tag');
        tagSel.value = meta.tag || '';
        if(meta.fixed){ tagSel.disabled = true; }
        tagSel.onchange = () => { meta.tag = tagSel.value; persistMetas(); };

        info.querySelectorAll('input[name="modo_'+meta.id+'"]').forEach(r => {
          r.checked = meta.modo === r.value;
          if(meta.fixed){ r.disabled = true; }
          r.onchange = () => {
            if(r.checked){
              meta.modo = r.value;
              persistMetas();
              renderMetas();
            }
          };
        });

        const dupBtn = info.querySelector('.dup');
        if(dupBtn){
          dupBtn.onclick = () => {
            const copy = JSON.parse(JSON.stringify(meta));
            copy.id = uuid();
            copy.pos = nextMetaPos();
            METAS.push(copy);
            persistMetas();
            renderMetas();
          };
        }

        const delBtn = info.querySelector('.del');
        if(delBtn){
          delBtn.onclick = () => {
            if(confirm('Excluir meta?')){
              METAS = METAS.filter(x => x.id !== meta.id);
              persistMetas();
              renderMetas();
            }
          };
        }

        const move = (dir)=>{
          const same = METAS.filter(m=> (m.setor||'comercial')===meta.setor);
          const idx = same.findIndex(m=>m.id===meta.id);
          const target = dir==='up'? same[idx-1] : same[idx+1];
          if(target){
            const i1 = METAS.findIndex(m=>m.id===meta.id);
            const i2 = METAS.findIndex(m=>m.id===target.id);
            [METAS[i1], METAS[i2]] = [METAS[i2], METAS[i1]];
            persistMetas();
            renderMetas();
          }
        };
        info.querySelector('.up').onclick = ()=>move('up');
        info.querySelector('.down').onclick = ()=>move('down');
      } else {
        updateTitleText();
      }

      trP.querySelectorAll('input.planned').forEach(inp => {
        const m = inp.dataset.month;
        inp.value = formatMetaInput(meta.meses[m].p, meta.unidade);
        inp.addEventListener('input', () => {
          meta.meses[m].p = parseMetaInput(inp.value, meta.unidade);
          scheduleMetaPersist();
          updateMetaCalculations();
        });
        inp.addEventListener('blur', () => {
          meta.meses[m].p = parseMetaInput(inp.value, meta.unidade);
          flushMetaPersist();
          updateMetaCalculations();
          if (currentSection === 'metas') {
            renderMetaSummary();
          }
        });
      });

      trR.querySelectorAll('input.realized').forEach(inp => {
        const m = inp.dataset.month;
        inp.value = formatMetaInput(meta.meses[m].r, meta.unidade);
        inp.addEventListener('input', () => {
          meta.meses[m].r = parseMetaInput(inp.value, meta.unidade);
          scheduleMetaPersist();
          updateMetaCalculations();
        });
        inp.addEventListener('blur', () => {
          meta.meses[m].r = parseMetaInput(inp.value, meta.unidade);
          flushMetaPersist();
          updateMetaCalculations();
          if (currentSection === 'metas') {
            renderMetaSummary();
          }
        });
      });

      frag.appendChild(trP);
      frag.appendChild(trR);
      frag.appendChild(trC);
      frag.appendChild(trE);
      const trGap = document.createElement('tr');
      trGap.className = 'meta-gap';
      const tdGap = document.createElement('td');
      tdGap.colSpan = months.length + (mobile ? 1 : 2);
      trGap.appendChild(tdGap);
      frag.appendChild(trGap);
      rows.push(trGap);
      applyRowState();
      return frag;
    }

    /* ========= demandas ========= */
    let DEMANDAS = [];
    let DEMANDA_MONTH_PLANS = {};
    let lastDemandasSignature = '';
    let lastDemandaPlansSignature = '';
    let lastRemoteDemandasSignature = '';
    let lastRemoteDemandaPlansSignature = '';
    const DEMANDAS_SAVE_DEBOUNCE_MS = 650;
    let demandasSaveTimer = null;
    let demandasSavePending = false;
    let demandasSaveInFlight = false;
    let demandasSaveQueued = false;
    let pendingDemandasSnapshot = null;
    const DEMANDA_MONTH_STORAGE_KEY = 'mg_demandas_month';
    const DEMANDA_MONTHS = [
      { month:1, label:'Jan' },
      { month:2, label:'Fev' },
      { month:3, label:'Mar' },
      { month:4, label:'Abr' },
      { month:5, label:'Mai' },
      { month:6, label:'Jun' },
      { month:7, label:'Jul' },
      { month:8, label:'Ago' },
      { month:9, label:'Set' },
      { month:10, label:'Out' },
      { month:11, label:'Nov' },
      { month:12, label:'Dez' }
    ];
    const demandaToday = new Date();
    function buildMonthKey(year, month){
      return `${year}-${String(month).padStart(2,'0')}`;
    }
    function getMonthKeyFromValue(value){
      if(!value) return '';
      const dt = new Date(value);
      if(Number.isNaN(dt.getTime())) return '';
      return buildMonthKey(dt.getFullYear(), dt.getMonth()+1);
    }
    function loadStoredDemandaMonth(){
      try{
        const stored = localStorage.getItem(DEMANDA_MONTH_STORAGE_KEY);
        if(stored && /^\d{4}-\d{2}$/.test(stored)){
          return stored;
        }
      }catch(_err){ }
      return buildMonthKey(demandaToday.getFullYear(), demandaToday.getMonth()+1);
    }
    let selectedDemandaMonth = loadStoredDemandaMonth();
    let demandaMonthYear = parseInt(selectedDemandaMonth.slice(0,4),10) || demandaToday.getFullYear();
    const STATUS_OPTIONS = [
      {value:'nao-iniciado', label:'N√£o iniciado', color:'#1e3a8a'},
      {value:'em-andamento', label:'Em andamento', color:'#b45309'},
      {value:'bloqueado', label:'Bloqueado', color:'#7f1d1d'},
      {value:'concluido', label:'Conclu√≠do', color:'#14532d'},
      {value:'prioridade', label:'Prioridade', color:'#374151'},
      {value:'prioridade-grupo', label:'Prioridade/Grupo', color:'#374151'},
      {value:'concluido-grupo', label:'Conclu√≠do/Grupo', color:'#14532d'}
    ];
    const TAG_OPTIONS = ['ROI','VITRINE/ENGAJAMENTO','NOVAS IDEIAS','RELACIONAMENTO','I.A','GOOGLE BUSINESS'];
    const RESP_OPTIONS = ['Bruno','Camilla','Clailton','Guilherme','Mediagrowth','Cliente','Theo'];
    const PLAN_TYPES = [
      { key:'estrategico', label:'Plano estrat√©gico' },
      { key:'tatico', label:'Plano t√°tico' },
      { key:'operacional', label:'Plano operacional' }
    ];
    const PLAN_PROMPT_HINTS = {
      estrategico: 'Produza direcionamentos de marketing de alto n√≠vel, defini√ß√µes de posicionamento, KPIs norteadores e conex√µes com as metas mensais.',
      tatico: 'Desdobre campanhas, canais, propostas de conte√∫do, segmenta√ß√µes, investimentos e respons√°veis semanais.',
      operacional: 'Liste rotinas, tarefas detalhadas, respons√°veis, prazos e checklists para a execu√ß√£o di√°ria e semanal.'
    };
    function getDemandaDateKey(prazo){
      if(typeof prazo !== 'string') return '';
      const trimmed = prazo.trim();
      if(!trimmed) return '';
      if(trimmed.length >= 10){
        const part = trimmed.slice(0,10);
        if(/^\d{4}-\d{2}-\d{2}$/.test(part)) return part;
      }
      const dt = new Date(trimmed);
      if(Number.isNaN(dt.getTime())) return '';
      const year = dt.getFullYear();
      const month = String(dt.getMonth()+1).padStart(2,'0');
      const day = String(dt.getDate()).padStart(2,'0');
      return `${year}-${month}-${day}`;
    }

    function parseDemandaDate(value){
      if(!value) return null;
      const dt = new Date(value);
      return Number.isNaN(dt.getTime()) ? null : dt;
    }

    function parseFilterDate(value, endOfDay = false){
      if(typeof value !== 'string' || !value) return null;
      const parts = value.split('-').map(Number);
      if(parts.length !== 3 || parts.some(num=>Number.isNaN(num))) return null;
      const [year, month, day] = parts;
      if(endOfDay){
        return new Date(year, month - 1, day, 23, 59, 59, 999);
      }
      return new Date(year, month - 1, day, 0, 0, 0, 0);
    }

    function getDemandaStartDate(d){
      if(!d) return null;
      const start = parseDemandaDate(d.prazo);
      return start ? new Date(start) : null;
    }

    function getDemandaEndDate(d){
      if(!d) return null;
      const start = getDemandaStartDate(d);
      const end = parseDemandaDate(d.prazoFim);
      if(end && start && end.getTime() < start.getTime()){
        return new Date(start);
      }
      if(end) return new Date(end);
      return start ? new Date(start) : null;
    }

    function getDemandaDueDate(d){
      return getDemandaEndDate(d);
    }

    function getDemandaSortMeta(d){
      const start = getDemandaStartDate(d);
      const end = getDemandaEndDate(d);
      const startMs = start ? start.getTime() : (end ? end.getTime() : Number.MAX_SAFE_INTEGER);
      const endMs = end ? end.getTime() : startMs;
      return { startMs, endMs };
    }

    function getDemandMonthKeys(d){
      const start = getDemandaStartDate(d) || parseDemandaDate(d?.prazoFim);
      if(!start) return [];
      const end = getDemandaEndDate(d) || start;
      const keys = [];
      const cursor = new Date(start.getFullYear(), start.getMonth(), 1);
      const limit = new Date(end.getFullYear(), end.getMonth(), 1);
      while(cursor.getTime() <= limit.getTime()){
        keys.push(buildMonthKey(cursor.getFullYear(), cursor.getMonth()+1));
        cursor.setMonth(cursor.getMonth()+1, 1);
      }
      return keys;
    }

    function getDemandaCalendarEntries(d){
      if(!d) return [];
      const entries = [];
      const startKey = getDemandaDateKey(d.prazo);
      const endKey = getDemandaDateKey(d.prazoFim);
      if(startKey){
        entries.push({ demanda: d, part: endKey ? 'start' : 'single', dateKey: startKey });
      }
      if(endKey){
        entries.push({ demanda: d, part: startKey ? 'end' : 'single', dateKey: endKey });
      }
      return entries;
    }

    function getDemandaEntryTime(entry){
      if(!entry || !entry.demanda) return 0;
      if(entry.part === 'end'){
        const end = parseDemandaDate(entry.demanda.prazoFim);
        if(end) return end.getTime();
      }
      const base = parseDemandaDate(entry.demanda.prazo);
      if(base) return base.getTime();
      const fallback = parseDemandaDate(entry.demanda.prazoFim);
      return fallback ? fallback.getTime() : 0;
    }

    function formatDemandaSchedule(entry){
      if(!entry || !entry.demanda) return '';
      const d = entry.demanda;
      const joinParts = parts => parts.filter(Boolean).join(' ');
      const startParts = getDemandaCalendarParts(d.prazo);
      const endParts = getDemandaCalendarParts(d.prazoFim);
      const startText = joinParts([startParts.dateLabel, startParts.timeLabel]);
      const endText = joinParts([endParts.dateLabel, endParts.timeLabel]);
      if(entry.part === 'start'){
        const startLabel = startText || endText;
        if(endText){
          const fimLabel = endText;
          if(startLabel){
            return `In√≠cio: ${startLabel} ‚Ä¢ Fim: ${fimLabel}`;
          }
          return `Fim: ${fimLabel}`;
        }
        return startLabel ? `In√≠cio: ${startLabel}` : '';
      }
      if(entry.part === 'end'){
        const label = endText || startText;
        return label ? `Fim: ${label}` : '';
      }
      if(startText && endText && endText !== startText){
        return `${startText} - ${endText}`;
      }
      if(!startText && endText){
        return `Fim: ${endText}`;
      }
      return startText || endText || '';
    }

    function getDemandaCalendarParts(prazo){
      if(!prazo) return { dateLabel:'', timeLabel:'' };
      const dt = new Date(prazo);
      if(Number.isNaN(dt.getTime())) return { dateLabel:'', timeLabel:'' };
      const dateLabel = dt.toLocaleDateString('pt-BR', { day:'2-digit', month:'2-digit' });
      const timeLabel = dt.toLocaleTimeString('pt-BR', { hour:'2-digit', minute:'2-digit', hour12:false });
      return { dateLabel, timeLabel };
    }

    function renderCalendarDemandaItems(entries, esc, textFilter){
      if(!Array.isArray(entries) || !entries.length) return '';
      const filter = (textFilter||'').trim().toLowerCase();
      const filtered = filter ? entries.filter(entry=>{
        const d = entry?.demanda || {};
        const statusLabel = STATUS_OPTIONS.find(o=>o.value===d.status)?.label || '';
        const schedule = formatDemandaSchedule(entry);
        const search = `${d?.demanda||''} ${statusLabel} ${d?.responsavel||''} ${schedule}`.toLowerCase();
        return search.includes(filter);
      }) : entries;
      if(!filtered.length) return '';
      const itemsHtml = filtered.map(entry=>{
        const d = entry.demanda || {};
        const statusInfo = STATUS_OPTIONS.find(o=>o.value===d.status) || {};
        const color = statusInfo.color || '#64748b';
        const statusLabel = statusInfo.label || '';
        const schedule = formatDemandaSchedule(entry);
        const metaParts = [];
        if(schedule) metaParts.push(schedule);
        if(statusLabel) metaParts.push(statusLabel);
        if(d?.responsavel) metaParts.push(d.responsavel);
        const meta = metaParts.join(' ‚Ä¢ ');
        const title = (d?.demanda || '').trim() || '(Sem t√≠tulo)';
        return `<div class="cal-demand" style="--status-color:${color}"><span class="cal-demand-dot" aria-hidden="true"></span><div class="cal-demand-text"><div class="cal-demand-title">${esc(title)}</div>${meta?`<div class="cal-demand-meta">${esc(meta)}</div>`:''}</div></div>`;
      }).join('');
      return itemsHtml ? `<div class="cal-demands">${itemsHtml}</div>` : '';
    }

    function renderCalendarMobileDemandas(demandaMap, esc, textFilter, monthKey){
      if(!calendarDemandasMobile) return;
      const items = [];
      if(demandaMap && typeof demandaMap.forEach === 'function'){
        demandaMap.forEach((list, iso)=>{
          if(!iso || (typeof monthKey === 'string' && !iso.startsWith(monthKey))) return;
          const html = renderCalendarDemandaItems(list, esc, textFilter);
          if(html){
            items.push({ iso, html });
          }
        });
      }
      if(!items.length){
        calendarDemandasMobile.innerHTML = '<h3 class="calendar-demandas-mobile-title">Planejamento &amp; Demandas</h3><div class="calendar-demandas-mobile-empty">Sem demandas planejadas para este m√™s.</div>';
        return;
      }
      items.sort((a,b)=> a.iso.localeCompare(b.iso));
      const formatDate = (iso)=>{
        try{
          const dt = new Date(`${iso}T00:00:00`);
          if(Number.isNaN(dt.getTime())) return iso;
          return dt.toLocaleDateString('pt-BR', { day:'2-digit', month:'2-digit' });
        }catch(_err){
          return iso;
        }
      };
      const content = items.map(({iso, html})=>`
        <div class="calendar-demandas-mobile-day">
          <div class="calendar-demandas-mobile-date">${formatDate(iso)}</div>
          ${html}
        </div>
      `).join('');
      calendarDemandasMobile.innerHTML = `
        <h3 class="calendar-demandas-mobile-title">Planejamento &amp; Demandas</h3>
        <div class="calendar-demandas-mobile-list">${content}</div>
      `;
    }

    const NOTIFICATION_THRESHOLD_DAYS = [30, 15, 7, 5, 4, 2, 1];
    const NOTIFICATION_CATEGORY_ICONS = { demand:'‚è∞', meta:'üéØ', posts:'üóìÔ∏è', item:'üÜï' };
    const NOTIFICATION_SEEN_KEY = 'mg_notifications_seen_v2';
    const NOTIFICATION_COUNTERS_KEY = 'mg_notification_counters_v1';
    const NOTIFICATION_CREATED_KEY = 'mg_notification_created_v1';

    function getNotificationStorageKey(base){
      let tenant = '';
      try{
        if(typeof TENANT === 'string' && TENANT){ tenant = TENANT; }
        else if(document && document.body){
          const attr = document.body.getAttribute('data-client-id');
          if(attr) tenant = attr;
        }
      }catch(_err){ tenant = ''; }
      const safe = tenant ? tenant.replace(/[^\w-]/g, '_') : 'default';
      return `${base}_${safe}`;
    }

    let notificationWidgetEl = null;
    let notificationButtonEl = null;
    let notificationBadgeEl = null;
    let notificationPanelEl = null;
    let notificationListEl = null;
    let notificationEmptyEl = null;
    let notificationMarkReadEl = null;
    let notificationItems = [];
    let notificationSeenMap = loadNotificationSeen();
    let notificationCreatedMap = loadNotificationCreated();
    let notificationAckCounters = loadNotificationCounters();
    let notificationLatestSnapshot = {};
    let notificationUpdateTimer = null;
    let notificationInitialized = false;

    function loadNotificationSeen(){
      try{
        const raw = localStorage.getItem(getNotificationStorageKey(NOTIFICATION_SEEN_KEY));
        if(raw){
          const parsed = JSON.parse(raw);
          if(parsed && typeof parsed === 'object') return parsed;
        }
      }catch(_err){ }
      return {};
    }

    function saveNotificationSeen(){
      try{ localStorage.setItem(getNotificationStorageKey(NOTIFICATION_SEEN_KEY), JSON.stringify(notificationSeenMap)); }
      catch(_err){ }
    }

    function loadNotificationCounters(){
      try{
        const raw = localStorage.getItem(getNotificationStorageKey(NOTIFICATION_COUNTERS_KEY));
        if(raw){
          const parsed = JSON.parse(raw);
          if(parsed && typeof parsed === 'object') return parsed;
        }
      }catch(_err){ }
      return {};
    }

    function saveNotificationCounters(){
      try{ localStorage.setItem(getNotificationStorageKey(NOTIFICATION_COUNTERS_KEY), JSON.stringify(notificationAckCounters)); }
      catch(_err){ }
    }

    function loadNotificationCreated(){
      try{
        const raw = localStorage.getItem(getNotificationStorageKey(NOTIFICATION_CREATED_KEY));
        if(raw){
          const parsed = JSON.parse(raw);
          if(parsed && typeof parsed === 'object') return parsed;
        }
      }catch(_err){ }
      return {};
    }

    function saveNotificationCreated(){
      try{ localStorage.setItem(getNotificationStorageKey(NOTIFICATION_CREATED_KEY), JSON.stringify(notificationCreatedMap)); }
      catch(_err){ }
    }

    function getNotificationCountersSnapshot(){
      const snapshot = {};
      try{
        snapshot.links = USER_DATA && Array.isArray(USER_DATA.links) ? USER_DATA.links.length : 0;
      }catch(_err){ snapshot.links = 0; }
      try{
        const values = SOCIAL_LINKS && typeof SOCIAL_LINKS === 'object' ? Object.values(SOCIAL_LINKS) : [];
        snapshot.social = values.filter(link=> (link||'').toString().trim().length > 0).length;
      }catch(_err){ snapshot.social = 0; }
      try{
        snapshot.references = Array.isArray(REF_SOCIAL) ? REF_SOCIAL.length : 0;
      }catch(_err){ snapshot.references = 0; }
      try{
        snapshot.competitors = Array.isArray(COMPETITORS) ? COMPETITORS.length : 0;
      }catch(_err){ snapshot.competitors = 0; }
      try{
        if(Array.isArray(ACCESSES)) snapshot.accesses = ACCESSES.length;
        else if(USER_DATA && Array.isArray(USER_DATA.accesses)) snapshot.accesses = USER_DATA.accesses.length;
        else snapshot.accesses = 0;
      }catch(_err){ snapshot.accesses = 0; }
      try{
        snapshot.files = Array.isArray(recentFilesCache) ? recentFilesCache.length : 0;
      }catch(_err){ snapshot.files = 0; }
      return snapshot;
    }

    function formatNotificationNumber(value){
      const num = Number(value) || 0;
      return num.toLocaleString('pt-BR');
    }

    function formatNotificationTimestamp(ms){
      const value = Number(ms);
      if(!Number.isFinite(value)) return '';
      const dt = new Date(value);
      if(Number.isNaN(dt.getTime())) return '';
      const day = String(dt.getDate()).padStart(2, '0');
      const month = String(dt.getMonth() + 1).padStart(2, '0');
      const year = dt.getFullYear();
      const hours = String(dt.getHours()).padStart(2, '0');
      const minutes = String(dt.getMinutes()).padStart(2, '0');
      return `${day}/${month}/${year} - ${hours}:${minutes}`;
    }

    function getPostDateForNotifications(post){
      if(!post) return null;
      let dt = safeDate(post.dateISO);
      if(!dt || Number.isNaN(dt.getTime())){
        if(post.createdAt){
          const created = safeDate(post.createdAt);
          if(created && Number.isFinite(created.getTime())) dt = created;
        }
        if((!dt || Number.isNaN(dt.getTime())) && post.updatedAt){
          const updated = safeDate(post.updatedAt);
          if(updated && Number.isFinite(updated.getTime())) dt = updated;
        }
      }
      return dt && Number.isFinite(dt.getTime()) ? dt : null;
    }

    function buildNotificationItems(){
      const items = [];
      const now = new Date();
      const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const msPerDay = 24 * 60 * 60 * 1000;

      const demandasList = Array.isArray(DEMANDAS) ? DEMANDAS : [];
      demandasList.forEach(d=>{
        if(!d) return;
        const status = (d.status || '').toLowerCase();
        const done = status === 'concluido' || status === 'concluido-grupo';
        const due = getDemandaDueDate(d);
        if(!due) return;
        const diffDays = Math.ceil((due.getTime() - todayStart.getTime()) / msPerDay);
        const title = (d.demanda || '').trim() || 'Demanda sem t√≠tulo';
        const responsavel = (d.responsavel || '').trim();
        const dueLabel = due.toLocaleDateString('pt-BR', { day:'2-digit', month:'2-digit' });
        const metaText = responsavel ? `Prazo: ${dueLabel} ‚Ä¢ Respons√°vel: ${responsavel}` : `Prazo: ${dueLabel}`;
        if(diffDays < 0 && !done){
          const overdueDays = Math.abs(diffDays);
          const overdueLabel = overdueDays === 1 ? '1 dia' : `${overdueDays} dias`;
          items.push({
            id: `demanda-${d.id || title}-overdue`,
            category: 'demand',
            severity: 'alert',
            icon: NOTIFICATION_CATEGORY_ICONS.demand,
            title: 'Demanda atrasada',
            message: `${title} est√° atrasada h√° ${overdueLabel}.`,
            meta: metaText,
            action: { label: 'Ver demanda', section: 'demandas', demandaId: d.id || '' }
          });
          return;
        }
        if(done) return;
        if(NOTIFICATION_THRESHOLD_DAYS.includes(diffDays)){
          const label = diffDays === 30 ? '1 m√™s'
            : diffDays === 15 ? '15 dias'
            : diffDays === 7 ? '1 semana'
            : diffDays === 5 ? '5 dias'
            : diffDays === 4 ? '4 dias'
            : diffDays === 2 ? '2 dias'
            : '1 dia';
          items.push({
            id: `demanda-${d.id || title}-${diffDays}`,
            category: 'demand',
            severity: 'warn',
            icon: NOTIFICATION_CATEGORY_ICONS.demand,
            title: 'Prazo de demanda',
            message: `${title} vence em ${label}.`,
            meta: metaText,
            action: { label: 'Ver demanda', section: 'demandas', demandaId: d.id || '' }
          });
        } else if(diffDays === 0){
          items.push({
            id: `demanda-${d.id || title}-hoje`,
            category: 'demand',
            severity: 'warn',
            icon: NOTIFICATION_CATEGORY_ICONS.demand,
            title: 'Prazo de demanda',
            message: `${title} vence hoje.`,
            meta: metaText,
            action: { label: 'Ver demanda', section: 'demandas', demandaId: d.id || '' }
          });
        }
      });

      const metasList = Array.isArray(METAS) ? METAS.filter(meta=> meta && meta.ativo !== false) : [];
      const monthKey = Array.isArray(META_MONTHS) ? META_MONTHS[now.getMonth()] : null;
      const totalDays = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate() || 30;
      const dayRatio = totalDays ? now.getDate() / totalDays : 1;
      const metasAtRisk = [];
      metasList.forEach(meta=>{
        if(!meta || !monthKey) return;
        const meses = meta.meses || {};
        const current = meses[monthKey] || {};
        const planned = normalizeMetaNumber(current.p ?? current.P);
        const realized = normalizeMetaNumber(current.r ?? current.R);
        if(planned <= 0) return;
        const status = evaluateMetaGoal(planned, realized, meta.direcao);
        if(status === 'achieved') return;
        const progressRatio = planned ? realized / planned : 0;
        if(dayRatio < 0.5 && progressRatio >= 0.5) return;
        const plannedLabel = formatMetaDisplay(planned, meta.unidade);
        const realizedLabel = formatMetaDisplay(realized, meta.unidade);
        metasAtRisk.push({
          descricao: (meta.descricao || 'Meta sem t√≠tulo').trim() || 'Meta sem t√≠tulo',
          plannedLabel,
          realizedLabel
        });
      });
      if(metasAtRisk.length){
        const detail = metasAtRisk.slice(0,3).map(meta=>`${meta.descricao}: ${meta.realizedLabel}/${meta.plannedLabel}`).join(' ‚Ä¢ ');
        const extra = metasAtRisk.length > 3 ? ` ‚Ä¢ +${metasAtRisk.length - 3} meta(s)` : '';
        items.push({
          id: `meta-risk-${metasAtRisk.map(m=>m.descricao).join('|')}`,
          category: 'meta',
          severity: 'warn',
          icon: NOTIFICATION_CATEGORY_ICONS.meta,
          title: metasAtRisk.length === 1 ? 'Meta em risco' : 'Metas em risco',
          message: detail + extra,
          meta: 'Revise as metas cadastradas para este m√™s.',
          action: { label: 'Ver metas', section: 'metas' }
        });
      }

      const postMetrics = computePostMetrics(Array.isArray(POSTS) ? POSTS : [], now);
      const monthPosts = [];
      const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
      const nextMonthStart = new Date(now.getFullYear(), now.getMonth() + 1, 1);
      (Array.isArray(POSTS) ? POSTS : []).forEach(post=>{
        const dt = getPostDateForNotifications(post);
        if(!dt) return;
        const ts = dt.getTime();
        if(ts < monthStart.getTime() || ts >= nextMonthStart.getTime()) return;
        monthPosts.push(post);
      });
      const statusCounts = { aprovado:0, revisar:0, publicado:0 };
      monthPosts.forEach(post=>{
        const status = (post.status || '').toLowerCase();
        if(Object.prototype.hasOwnProperty.call(statusCounts, status)){
          statusCounts[status] += 1;
        }
      });
      if(monthPosts.length){
        const parts = [];
        if(statusCounts.aprovado) parts.push(`${formatNotificationNumber(statusCounts.aprovado)} aprovado(s)`);
        if(statusCounts.revisar) parts.push(`${formatNotificationNumber(statusCounts.revisar)} aguardando revis√£o`);
        if(statusCounts.publicado) parts.push(`${formatNotificationNumber(statusCounts.publicado)} publicado(s)`);
        const label = parts.join(' ‚Ä¢ ') || 'Nenhum post cadastrado para este m√™s.';
        items.push({
          id: `posts-status-${statusCounts.aprovado}-${statusCounts.revisar}-${statusCounts.publicado}`,
          category: 'posts',
          severity: statusCounts.revisar > 0 ? 'warn' : 'info',
          icon: NOTIFICATION_CATEGORY_ICONS.posts,
          title: 'Status dos posts do m√™s',
          message: label,
          meta: postMetrics && postMetrics.monthLabel ? postMetrics.monthLabel : '',
          action: { label: 'Ver posts', section: 'calendar' }
        });
      }
      if(postMetrics && postMetrics.target > 0 && postMetrics.remaining > 0){
        items.push({
          id: `posts-remaining-${postMetrics.remaining}`,
          category: 'posts',
          severity: 'warn',
          icon: 'üìù',
          title: 'Meta de posts pendente',
          message: `Faltam ${formatNotificationNumber(postMetrics.remaining)} post(s) aprovados para atingir a meta de ${postMetrics.monthLabel || 'posts'}.`,
          meta: postMetrics.target ? `Meta: ${formatNotificationNumber(postMetrics.target)} ‚Ä¢ Aprovados: ${formatNotificationNumber(postMetrics.approved)}` : '',
          action: { label: 'Ver posts', section: 'calendar' }
        });
      }

      const countersSnapshot = getNotificationCountersSnapshot();
      const counterLabels = {
        links: { title:'Novos links', message: diff=>`${formatNotificationNumber(diff)} link(s) cadastrados recentemente.`, section:'widgets', icon:'üîó' },
        social: { title:'Novas redes conectadas', message: diff=>`${formatNotificationNumber(diff)} rede(s) social(is) conectada(s).`, section:'widgets', icon:'üåê' },
        references: { title:'Novas refer√™ncias', message: diff=>`${formatNotificationNumber(diff)} refer√™ncia(s) adicionada(s).`, section:'refSocial', icon:'üìö' },
        competitors: { title:'Novos concorrentes', message: diff=>`${formatNotificationNumber(diff)} concorrente(s) registrado(s).`, section:'concorrentes', icon:'üèÅ' },
        accesses: { title:'Novos acessos', message: diff=>`${formatNotificationNumber(diff)} acesso(s) cadastrado(s).`, section:'access', icon:'üîê' },
        files: { title:'Novos arquivos', message: diff=>`${formatNotificationNumber(diff)} arquivo(s) enviado(s) para a plataforma.`, section:'arquivos', icon:'üóÇÔ∏è' }
      };
      Object.keys(counterLabels).forEach(key=>{
        const current = Number(countersSnapshot[key]) || 0;
        const ack = Number(notificationAckCounters[key]) || 0;
        if(current > ack){
          const diff = current - ack;
          const meta = counterLabels[key];
          items.push({
            id: `new-${key}-${current}`,
            category: 'item',
            severity: 'info',
            icon: meta.icon || NOTIFICATION_CATEGORY_ICONS.item,
            title: meta.title,
            message: meta.message(diff),
            meta: `Total: ${formatNotificationNumber(current)}`,
            action: { label: 'Ver se√ß√£o', section: meta.section }
          });
        }
      });

      const order = { demand:0, meta:1, posts:2, item:3 };
      items.sort((a,b)=> (order[a.category] ?? 99) - (order[b.category] ?? 99));
      return { items, countersSnapshot };
    }

    function ensureNotificationElements(){
      if(notificationInitialized){
        if(!notificationWidgetEl){
          notificationWidgetEl = document.getElementById('notificationWidget');
        }
        return;
      }
      notificationWidgetEl = document.getElementById('notificationWidget');
      notificationButtonEl = document.getElementById('notificationButton');
      notificationBadgeEl = document.getElementById('notificationBadge');
      notificationPanelEl = document.getElementById('notificationPanel');
      notificationListEl = document.getElementById('notificationList');
      notificationEmptyEl = document.getElementById('notificationEmpty');
      notificationMarkReadEl = document.getElementById('notificationMarkRead');
      if(!notificationWidgetEl || !notificationButtonEl || !notificationPanelEl) return;
      notificationInitialized = true;
      notificationButtonEl.addEventListener('click', ()=> toggleNotificationPanel());
      if(notificationMarkReadEl){
        notificationMarkReadEl.addEventListener('click', ()=>{
          markNotificationsSeen();
          renderNotifications();
          updateNotificationBadge();
        });
      }
      document.addEventListener('click', handleNotificationOutside, true);
      document.addEventListener('keydown', handleNotificationKeydown);
    }

    function renderNotifications(){
      ensureNotificationElements();
      if(!notificationListEl || !notificationEmptyEl) return;
      notificationListEl.innerHTML = '';
      if(!notificationItems.length){
        notificationEmptyEl.hidden = false;
        return;
      }
      notificationEmptyEl.hidden = true;
      const frag = document.createDocumentFragment();
      notificationItems.forEach(item=>{
        const wrapper = document.createElement('div');
        wrapper.className = 'notification-item';
        if(item.severity) wrapper.classList.add(item.severity);
        if(!notificationSeenMap[item.id]) wrapper.classList.add('unseen');
        const iconWrap = document.createElement('div');
        iconWrap.className = 'notification-icon-wrap';
        iconWrap.textContent = item.icon || NOTIFICATION_CATEGORY_ICONS[item.category] || 'üîî';
        wrapper.appendChild(iconWrap);
        const content = document.createElement('div');
        content.className = 'notification-content';
        const titleEl = document.createElement('div');
        titleEl.className = 'notification-item-title';
        titleEl.textContent = item.title || 'Notifica√ß√£o';
        content.appendChild(titleEl);
        const messageEl = document.createElement('div');
        messageEl.textContent = item.message || '';
        content.appendChild(messageEl);
        if(item.meta){
          const metaEl = document.createElement('div');
          metaEl.className = 'notification-item-meta';
          metaEl.textContent = item.meta;
          content.appendChild(metaEl);
        }
        const timeLabel = formatNotificationTimestamp(item.createdAt);
        if(timeLabel){
          const timeEl = document.createElement('div');
          timeEl.className = 'notification-item-meta notification-item-time';
          timeEl.textContent = `Registrado em ${timeLabel}`;
          content.appendChild(timeEl);
        }
        if(item.action){
          const actionsWrap = document.createElement('div');
          actionsWrap.className = 'notification-actions';
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'notification-action';
          btn.textContent = item.action.label || 'Abrir';
          btn.addEventListener('click', ()=> handleNotificationAction(item.action));
          actionsWrap.appendChild(btn);
          content.appendChild(actionsWrap);
        }
        wrapper.appendChild(content);
        frag.appendChild(wrapper);
      });
      notificationListEl.appendChild(frag);
    }

    function updateNotificationBadge(){
      ensureNotificationElements();
      if(!notificationBadgeEl) return;
      const unseen = notificationItems.reduce((acc, item)=> acc + (notificationSeenMap[item.id] ? 0 : 1), 0);
      if(unseen > 0){
        notificationBadgeEl.textContent = unseen > 99 ? '99+' : String(unseen);
        notificationBadgeEl.hidden = false;
      }else{
        notificationBadgeEl.hidden = true;
      }
    }

    function attachNotificationTimestamps(items){
      if(!Array.isArray(items)) return [];
      const now = Date.now();
      const activeIds = new Set();
      let changed = false;
      items.forEach(item=>{
        if(!item || !item.id) return;
        const id = String(item.id);
        activeIds.add(id);
        if(!Object.prototype.hasOwnProperty.call(notificationCreatedMap, id)){
          notificationCreatedMap[id] = now;
          changed = true;
        }
        item.createdAt = notificationCreatedMap[id];
      });
      Object.keys(notificationCreatedMap).forEach(id=>{
        if(!activeIds.has(id)){
          delete notificationCreatedMap[id];
          changed = true;
        }
      });
      if(changed) saveNotificationCreated();
      return items;
    }

    function applyNotificationData(data){
      if(!data || !Array.isArray(data.items)) return;
      notificationItems = attachNotificationTimestamps(data.items);
      notificationLatestSnapshot = data.countersSnapshot || notificationLatestSnapshot || {};
      renderNotifications();
      updateNotificationBadge();
    }

    function markNotificationsSeen(){
      let changed = false;
      notificationItems.forEach(item=>{
        if(!notificationSeenMap[item.id]){
          notificationSeenMap[item.id] = Date.now();
          changed = true;
        }
      });
      if(changed) saveNotificationSeen();
      if(notificationLatestSnapshot && typeof notificationLatestSnapshot === 'object'){
        notificationAckCounters = { ...notificationAckCounters, ...notificationLatestSnapshot };
        saveNotificationCounters();
      }
    }

    function toggleNotificationPanel(force){
      ensureNotificationElements();
      if(!notificationWidgetEl || !notificationPanelEl || !notificationButtonEl) return;
      const shouldOpen = typeof force === 'boolean' ? force : !notificationWidgetEl.classList.contains('open');
      notificationWidgetEl.classList.toggle('open', shouldOpen);
      notificationButtonEl.setAttribute('aria-expanded', shouldOpen ? 'true' : 'false');
      if(shouldOpen){
        markNotificationsSeen();
        renderNotifications();
        updateNotificationBadge();
      }
    }

    function handleNotificationOutside(ev){
      if(!notificationWidgetEl || !notificationWidgetEl.classList.contains('open')) return;
      if(notificationWidgetEl.contains(ev.target)) return;
      toggleNotificationPanel(false);
    }

    function handleNotificationKeydown(ev){
      if(ev.key === 'Escape' && notificationWidgetEl && notificationWidgetEl.classList.contains('open')){
        toggleNotificationPanel(false);
      }
    }

    function handleNotificationAction(action){
      if(!action || typeof action !== 'object') return;
      if(action.section){
        try{ setActiveTab(action.section); }
        catch(_err){ }
      }
      toggleNotificationPanel(false);
      if(action.section === 'demandas' && action.demandaId){
        requestAnimationFrame(()=>{
          const selector = `#demandasBody tr[data-id="${action.demandaId}"]`;
          const row = document.querySelector(selector);
          if(row){
            row.scrollIntoView({ behavior:'smooth', block:'center' });
          }
        });
      }
    }

    function scheduleNotificationRefresh(options = {}){
      const immediate = !!options.immediate;
      if(immediate){
        if(notificationUpdateTimer){
          clearTimeout(notificationUpdateTimer);
          notificationUpdateTimer = null;
        }
        try{ applyNotificationData(buildNotificationItems()); }
        catch(err){ console.warn('notifications:update', err); }
        return;
      }
      if(notificationUpdateTimer){
        clearTimeout(notificationUpdateTimer);
      }
      notificationUpdateTimer = setTimeout(()=>{
        notificationUpdateTimer = null;
        try{ applyNotificationData(buildNotificationItems()); }
        catch(err){ console.warn('notifications:update', err); }
      }, 250);
    }

    function initNotificationWidget(){
      ensureNotificationElements();
      renderNotifications();
      updateNotificationBadge();
    }
    document.addEventListener('DOMContentLoaded', initNotificationWidget);

    function formatDate(ms){ return ms? new Date(ms).toLocaleString('pt-BR',{hour12:false}) : ''; }
    function applyStatusColor(tr,status){ const c=STATUS_OPTIONS.find(o=>o.value===status)?.color||''; tr.style.background=c; }
    function getAllDemandaMonthKeys(){
      const set = new Set();
      (Array.isArray(DEMANDAS)?DEMANDAS:[]).forEach(d=>{
        const months = getDemandMonthKeys(d);
        months.forEach(key=>{ if(key) set.add(key); });
      });
      Object.keys(DEMANDA_MONTH_PLANS||{}).forEach(key=>{
        if(typeof key==='string' && key){
          const plan = DEMANDA_MONTH_PLANS[key];
          const hasContent = PLAN_TYPES.some(({key:k})=> (plan?.[k]||'').trim());
          if(hasContent){
            set.add(key);
          }
        }
      });
      return set;
    }
    function renderDemandaMonthButtons(){
      const container=$('demandaMonthButtons');
      const yearLabel=$('demandaYearLabel');
      const prevBtn=$('demandaYearPrev');
      const nextBtn=$('demandaYearNext');
      if(yearLabel){ yearLabel.textContent=demandaMonthYear; }
      if(prevBtn){ prevBtn.onclick=()=>changeDemandaYear(-1); }
      if(nextBtn){ nextBtn.onclick=()=>changeDemandaYear(1); }
      if(!container) return;
      const availableKeys=getAllDemandaMonthKeys();
      container.innerHTML='';
      DEMANDA_MONTHS.forEach(({month,label})=>{
        const key=buildMonthKey(demandaMonthYear,month);
        const btn=document.createElement('button');
        btn.type='button';
        btn.className='demanda-month-button'+(selectedDemandaMonth===key?' active':'')+(availableKeys.has(key)?' has-data':'');
        btn.textContent=label;
        btn.addEventListener('click',()=>{ setSelectedDemandaMonth(key); });
        container.appendChild(btn);
      });
    }
    function setSelectedDemandaMonth(monthKey,{persist=true,triggerRender=true}={}){
      if(typeof monthKey!=='string' || !/^\d{4}-\d{2}$/.test(monthKey)) return;
      selectedDemandaMonth=monthKey;
      const parsedYear=parseInt(monthKey.slice(0,4),10);
      if(!Number.isNaN(parsedYear)) demandaMonthYear=parsedYear;
      if(persist){
        try{ localStorage.setItem(DEMANDA_MONTH_STORAGE_KEY, monthKey); }
        catch(_err){ }
      }
      if(triggerRender){ renderDemandas(); }
    }
    function changeDemandaYear(delta){
      if(!Number.isInteger(delta) || delta===0) return;
      const monthPart=selectedDemandaMonth?.slice(5) || String(demandaToday.getMonth()+1).padStart(2,'0');
      const monthNum=parseInt(monthPart,10);
      if(Number.isNaN(monthNum)) return;
      const newYear=demandaMonthYear+delta;
      setSelectedDemandaMonth(buildMonthKey(newYear, monthNum));
    }
    function normalizeDemanda(d){
      if(!d) return d;
      if(!d.planos || typeof d.planos!=='object'){
        d.planos = {};
      }
      PLAN_TYPES.forEach(({key})=>{
        if(typeof d.planos[key] !== 'string') d.planos[key] = '';
      });
      if(typeof d.prazo !== 'string'){
        d.prazo = d.prazo ? String(d.prazo) : '';
      }
      if(typeof d.prazoFim !== 'string'){
        d.prazoFim = '';
      }
      return d;
    }
    function normalizeMonthPlan(monthKey){
      if(typeof monthKey !== 'string' || !monthKey) return null;
      if(!DEMANDA_MONTH_PLANS || typeof DEMANDA_MONTH_PLANS !== 'object'){
        DEMANDA_MONTH_PLANS = {};
      }
      if(!DEMANDA_MONTH_PLANS[monthKey] || typeof DEMANDA_MONTH_PLANS[monthKey] !== 'object'){
        DEMANDA_MONTH_PLANS[monthKey] = {};
      }
      const plan = DEMANDA_MONTH_PLANS[monthKey];
      PLAN_TYPES.forEach(({key})=>{
        if(typeof plan[key] !== 'string') plan[key] = '';
      });
      if(!plan.objectiveNotes || typeof plan.objectiveNotes !== 'object'){
        plan.objectiveNotes = {};
      }else{
        Object.keys(plan.objectiveNotes).forEach(objKey=>{
          if(typeof plan.objectiveNotes[objKey] !== 'string'){
            plan.objectiveNotes[objKey] = '';
          }
        });
      }
      return plan;
    }
    function cloneMonthPlans(data){
      const out = {};
      if(!data || typeof data !== 'object') return out;
      Object.keys(data).forEach(monthKey=>{
        const src = data[monthKey];
        if(!src || typeof src !== 'object') return;
        const target = {};
        PLAN_TYPES.forEach(({key})=>{
          const val = src[key];
          target[key] = typeof val === 'string' ? val : '';
        });
        const notesSrc = src.objectiveNotes && typeof src.objectiveNotes === 'object' ? src.objectiveNotes : {};
        const notesTarget = {};
        Object.keys(notesSrc).forEach(noteKey=>{
          const noteVal = notesSrc[noteKey];
          notesTarget[noteKey] = typeof noteVal === 'string' ? noteVal : '';
        });
        target.objectiveNotes = notesTarget;
        out[monthKey] = target;
      });
      return out;
    }
    function normalizeDemandasForComparison(list){
      if(!Array.isArray(list)) return [];
      return list.map(item=>{
        const copy = { ...(item || {}) };
        copy.planos = item?.planos && typeof item.planos === 'object' ? { ...item.planos } : {};
        return normalizeDemanda(copy);
      });
    }
    function buildDemandasSignature(list){
      if(!Array.isArray(list)) return '[]';
      const normalized = list.map(item=>({
        id: item?.id ? String(item.id) : '',
        status: item?.status ? String(item.status) : '',
        responsavel: item?.responsavel ? String(item.responsavel) : '',
        tag: item?.tag ? String(item.tag) : '',
        prazo: item?.prazo ? String(item.prazo) : '',
        prazoFim: item?.prazoFim ? String(item.prazoFim) : '',
        edited: Number(item?.edited) || 0
      }));
      normalized.sort((a,b)=>{
        const idDiff = (a.id || '').localeCompare(b.id || '');
        if(idDiff !== 0) return idDiff;
        return a.edited - b.edited;
      });
      return JSON.stringify(normalized);
    }
    function buildMonthPlansSignature(plans){
      if(!plans || typeof plans !== 'object') return '{}';
      const normalized = {};
      Object.keys(plans).sort().forEach(monthKey=>{
        const entry = plans[monthKey] && typeof plans[monthKey] === 'object' ? plans[monthKey] : {};
        normalized[monthKey] = {};
        PLAN_TYPES.forEach(({key})=>{
          const val = entry[key];
          normalized[monthKey][key] = typeof val === 'string' ? val : '';
        });
        const notes = entry.objectiveNotes && typeof entry.objectiveNotes === 'object' ? entry.objectiveNotes : {};
        const normalizedNotes = {};
        Object.keys(notes).sort().forEach(noteKey=>{
          const noteVal = notes[noteKey];
          normalizedNotes[noteKey] = typeof noteVal === 'string' ? noteVal : '';
        });
        normalized[monthKey].objectiveNotes = normalizedNotes;
      });
      return JSON.stringify(normalized);
    }
    function computeDemandSnapshotSignatures(rawDemandas, rawPlans){
      return {
        demandas: buildDemandasSignature(normalizeDemandasForComparison(rawDemandas)),
        plans: buildMonthPlansSignature(cloneMonthPlans(rawPlans))
      };
    }
    function syncDemandasSignatures(){
      lastDemandasSignature = buildDemandasSignature(Array.isArray(DEMANDAS) ? DEMANDAS : []);
      lastDemandaPlansSignature = buildMonthPlansSignature(DEMANDA_MONTH_PLANS);
    }
    function migrateDemandPlansToMonthPlans(){
      if(!Array.isArray(DEMANDAS) || DEMANDAS.length===0) return;
      const buckets = {};
      DEMANDAS.forEach(d=>{
        normalizeDemanda(d);
        const months = getDemandMonthKeys(d);
        if(!months.length) return;
        months.forEach(key=>{
          if(!buckets[key]) buckets[key] = [];
          buckets[key].push(d);
        });
      });
      let changed = false;
      Object.keys(buckets).forEach(monthKey=>{
        const monthPlan = normalizeMonthPlan(monthKey);
        if(!monthPlan) return;
        PLAN_TYPES.forEach(({key})=>{
          if(typeof monthPlan[key] === 'string' && monthPlan[key].trim()) return;
          const values = buckets[monthKey]
            .map(item => (item.planos?.[key] || '').trim())
            .filter(Boolean);
          if(!values.length) return;
          const unique = [...new Set(values)];
          const joined = unique.join('\n\n');
          if(joined){
            monthPlan[key] = joined;
            changed = true;
          }
        });
      });
      if(changed){
        setTimeout(()=>{ try{ scheduleDemandasPersist({ immediate:true }); }catch(_e){} }, 0);
      }
    }
    function createDemanda(){ const now=Date.now(); return normalizeDemanda({id:uuid(),status:'',tag:'',demanda:'',responsavel:'',prazo:'',edited:now,created:now}); }
    function loadDemandasFromUserData(){
      DEMANDAS = Array.isArray(USER_DATA.demandas) ? USER_DATA.demandas.map(normalizeDemanda) : [];
      DEMANDA_MONTH_PLANS = cloneMonthPlans(USER_DATA.demandaMonthPlans);
      Object.keys(DEMANDA_MONTH_PLANS || {}).forEach(monthKey=> normalizeMonthPlan(monthKey));
      if(DEMANDAS.length===0){ DEMANDAS.push(createDemanda()); }
      migrateDemandPlansToMonthPlans();
      normalizeMonthPlan(selectedDemandaMonth);
      syncDemandasSignatures();
      if(typeof renderCalendarDays === 'function'){
        try{ renderCalendarDays(); }catch(_err){}
      }
      try{ refreshMacroInsights(); }catch(_){ }
    }
    async function persistDemandas(){
      const uid=auth.currentUser?.uid;
      if(!uid){
        try{ refreshMacroInsights(); }catch(_){ }
        return;
      }
      const monthPlansPayload = {};
      if(DEMANDA_MONTH_PLANS && typeof DEMANDA_MONTH_PLANS === 'object'){
        Object.keys(DEMANDA_MONTH_PLANS).forEach(monthKey=>{
          const plan = normalizeMonthPlan(monthKey);
          if(!plan) return;
          monthPlansPayload[monthKey] = {};
          PLAN_TYPES.forEach(({key})=>{
            monthPlansPayload[monthKey][key] = typeof plan[key] === 'string' ? plan[key] : '';
          });
          const notes = plan.objectiveNotes && typeof plan.objectiveNotes === 'object' ? plan.objectiveNotes : {};
          const payloadNotes = {};
          Object.keys(notes).forEach(noteKey=>{
            const noteVal = notes[noteKey];
            if(typeof noteVal === 'string' && noteVal.trim()){
              payloadNotes[noteKey] = noteVal;
            }
          });
          monthPlansPayload[monthKey].objectiveNotes = payloadNotes;
        });
      }
      syncDemandasSignatures();
      try{ refreshMacroInsights(); }catch(_){ }
      try{
        await setDoc(doc(db,'usuarios',uid), { demandas: DEMANDAS, demandaMonthPlans: monthPlansPayload }, { merge:true });
      }finally{
        try{ refreshMacroInsights(); }catch(_){ }
      }
    }
    function hasPendingDemandasSave(){
      return demandasSavePending || demandasSaveInFlight || !!demandasSaveTimer;
    }
    function scheduleDemandasPersist({ immediate=false }={}){
      demandasSavePending = true;
      if(demandasSaveTimer){
        clearTimeout(demandasSaveTimer);
        demandasSaveTimer = null;
      }
      if(immediate){
        flushDemandasPersist();
        return;
      }
      demandasSaveTimer = setTimeout(()=>{ flushDemandasPersist(); }, DEMANDAS_SAVE_DEBOUNCE_MS);
    }
    async function flushDemandasPersist(){
      if(demandasSaveTimer){
        clearTimeout(demandasSaveTimer);
        demandasSaveTimer = null;
      }
      if(demandasSaveInFlight){
        demandasSaveQueued = true;
        return;
      }
      if(!demandasSavePending){
        maybeApplyPendingDemandasSnapshot();
        return;
      }
      demandasSavePending = false;
      demandasSaveInFlight = true;
      try{
        await persistDemandas();
      }catch(err){
        console.error('Erro ao salvar demandas', err);
      }finally{
        demandasSaveInFlight = false;
        if(demandasSaveQueued){
          demandasSaveQueued = false;
          scheduleDemandasPersist({ immediate:true });
          return;
        }
        maybeApplyPendingDemandasSnapshot();
      }
    }
    function shouldDeferDemandasSnapshot(){
      return hasPendingDemandasSave() || isDemandasEditing();
    }
    function queuePendingDemandasSnapshot(payload){
      if(!payload || !payload.signatures){
        pendingDemandasSnapshot = null;
        return;
      }
      pendingDemandasSnapshot = {
        data: payload.data || null,
        signatures: payload.signatures,
        matchesLocalState: !!payload.matchesLocalState
      };
    }
    function maybeApplyPendingDemandasSnapshot(){
      if(!pendingDemandasSnapshot) return;
      if(shouldDeferDemandasSnapshot()) return;
      const { data, signatures, matchesLocalState } = pendingDemandasSnapshot;
      pendingDemandasSnapshot = null;
      if(data){
        USER_DATA = data;
      }
      lastRemoteDemandasSignature = signatures.demandas;
      lastRemoteDemandaPlansSignature = signatures.plans;
      if(matchesLocalState){
        lastDemandasSignature = signatures.demandas;
        lastDemandaPlansSignature = signatures.plans;
        return;
      }
      loadDemandasFromUserData();
      requestRenderDemandas();
    }
    function updatePrazoAlert(){
      const el=$('prazoAlert');
      if(!el) return;
      const now=Date.now();
      const overdue = DEMANDAS.filter(d=>{
        const dueDate=getDemandaDueDate(d);
        if(!dueDate) return false;
        const due=dueDate.getTime();
        const done=d.status==='concluido'||d.status==='concluido-grupo';
        return !done && due<now;
      });
      if(overdue.length){
        const names = overdue.map(d=>d.demanda||'(sem t√≠tulo)').join(', ');
        el.textContent = `Demandas atrasadas: ${names}`;
        el.style.display='block';
      } else {
        el.style.display='none';
      }
    }
    function markDemandaEdited(d, row){
      if(!d) return;
      d.edited=Date.now();
      const targetRow = row || document.querySelector(`#demandasBody tr[data-id="${d.id}"]`);
      const editedCell = targetRow?.querySelector('.col-edit');
      if(editedCell){
        editedCell.textContent = formatDate(d.edited);
      }
    }
    function formatPrazoLabel(input, maybeEnd){
      let start = null;
      let end = null;
      if(input && typeof input === 'object' && !Array.isArray(input)){
        start = getDemandaStartDate(input) || getDemandaEndDate(input);
        end = getDemandaEndDate(input);
      }else{
        const startCandidate = parseDemandaDate(input) || parseDemandaDate(maybeEnd);
        if(startCandidate) start = new Date(startCandidate);
        const endCandidate = parseDemandaDate(maybeEnd);
        if(endCandidate){
          if(start && endCandidate.getTime() < start.getTime()){
            end = new Date(start);
          }else{
            end = new Date(endCandidate);
          }
        }else if(start){
          end = new Date(start);
        }
      }
      if(!start) return '';
      if(!end) end = new Date(start);
      const format = dt => dt.toLocaleString('pt-BR',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit',hour12:false});
      if(end.getTime() !== start.getTime()){
        return `${format(start)} ‚Äî ${format(end)}`;
      }
      return format(start);
    }
    function getEditableSelection(root){
      const selection = window.getSelection();
      if(!selection || selection.rangeCount === 0) return null;
      const range = selection.getRangeAt(0);
      if(!root.contains(range.startContainer) || !root.contains(range.endContainer)) return null;
      const preRange = range.cloneRange();
      preRange.selectNodeContents(root);
      preRange.setEnd(range.startContainer, range.startOffset);
      const start = preRange.toString().length;
      const length = range.toString().length;
      return { start, end: start + length };
    }
    function findTextPosition(root, targetOffset){
      const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null);
      let node = walker.nextNode();
      let offset = targetOffset;
      while(node){
        const length = node.nodeValue.length;
        if(offset <= length){
          return { node, offset: Math.max(0, offset) };
        }
        offset -= length;
        node = walker.nextNode();
      }
      return { node: root, offset: root.childNodes.length };
    }
    function restoreEditableSelection(root, saved){
      if(!saved) return;
      const selection = window.getSelection();
      if(!selection) return;
      const totalLength = root.textContent?.length || 0;
      const start = Math.min(saved.start, totalLength);
      const end = Math.min(saved.end, totalLength);
      const range = document.createRange();
      const startPos = findTextPosition(root, start);
      const endPos = findTextPosition(root, end);
      try{
        range.setStart(startPos.node, startPos.offset);
        range.setEnd(endPos.node, endPos.offset);
      }catch(_err){
        range.selectNodeContents(root);
        range.collapse(false);
      }
      selection.removeAllRanges();
      selection.addRange(range);
    }
    function sanitizeMarkdownHtml(html){
      const raw = typeof html === 'string' ? html : '';
      if(!raw) return '';
      const purifier = window.DOMPurify;
      if(purifier && typeof purifier.sanitize === 'function'){
        try{
          return purifier.sanitize(raw, { USE_PROFILES: { html: true } });
        }catch(err){
          console.warn('DOMPurify sanitize error', err);
        }
      }
      const template = document.createElement('template');
      template.innerHTML = raw;
      const blocked = ['script','style','iframe','object','embed','link','meta'];
      blocked.forEach(tag=>{ template.content.querySelectorAll(tag).forEach(el=> el.remove()); });
      template.content.querySelectorAll('*').forEach(node=>{
        Array.from(node.attributes).forEach(attr=>{
          const name = attr.name.toLowerCase();
          if(name.startsWith('on') || name === 'style'){
            node.removeAttribute(attr.name);
            return;
          }
          if(name === 'href' || name === 'src'){
            const value = (node.getAttribute(attr.name) || '').trim();
            if(!/^(https?:|mailto:|tel:|#|\/)/i.test(value)){
              node.removeAttribute(attr.name);
            }
          }
        });
      });
      return template.innerHTML || '';
    }
    function trimInlineMarkdown(text){
      return typeof text === 'string' ? text.replace(/^\s+|\s+$/g, '') : '';
    }
    function htmlToMarkdown(html){
      if(!html) return '';
      const template = document.createElement('template');
      template.innerHTML = html;
      const ELEMENT_NODE = typeof Node !== 'undefined' ? Node.ELEMENT_NODE : 1;
      const TEXT_NODE = typeof Node !== 'undefined' ? Node.TEXT_NODE : 3;
      const convertChildren = (parent, context) => Array.from(parent.childNodes).map(child => convertNode(child, context)).join('');
      const wrapInline = (content, wrapper) => {
        const trimmed = trimInlineMarkdown(content);
        return trimmed ? `${wrapper}${trimmed}${wrapper}` : '';
      };
      const listItemToMarkdown = (node, ctx) => {
        const baseIndent = Math.max(ctx.indent || 0, 0);
        const marker = ctx.type === 'ol' ? `${ctx.index}. ` : '- ';
        const childContext = { indent: baseIndent + 1, parentList: ctx.type };
        const body = convertChildren(node, childContext).replace(/\n+$/, '');
        const lines = body.split(/\n/);
        const firstLine = lines.shift() || '';
        let result = `${'  '.repeat(baseIndent)}${marker}${firstLine.trim()}`;
        if(lines.length){
          const continuation = lines.map(line => {
            const trimmed = line.trim();
            return trimmed ? `${'  '.repeat(baseIndent + 1)}${trimmed}` : '';
          }).filter(Boolean).join('\n');
          if(continuation) result += `\n${continuation}`;
        }
        return `${result}\n`;
      };
      const listToMarkdown = (node, type, context) => {
        const baseIndent = Math.max(context.indent || 0, 0);
        let index = 1;
        const parts = [];
        node.childNodes.forEach(child => {
          if(child.nodeType === ELEMENT_NODE && child.tagName.toLowerCase() === 'li'){
            parts.push(listItemToMarkdown(child, { indent: baseIndent, type, index }));
            index++;
          }
        });
        return `\n${parts.join('')}\n`;
      };
      const blockquoteToMarkdown = (node, context) => {
        const content = convertChildren(node, context).split(/\n/).map(line => line ? `> ${line}` : '>').join('\n');
        return `\n${content}\n\n`;
      };
      const convertNode = (node, context = { indent: 0 }) => {
        if(node.nodeType === TEXT_NODE){
          return (node.nodeValue || '').replace(/\u00a0/g, ' ');
        }
        if(node.nodeType !== ELEMENT_NODE){
          return '';
        }
        const tag = node.tagName.toLowerCase();
        switch(tag){
          case 'br':
            return '\n';
          case 'strong':
          case 'b':
            return wrapInline(convertChildren(node, context), '**');
          case 'em':
          case 'i':
            return wrapInline(convertChildren(node, context), '_');
          case 'u':
            return wrapInline(convertChildren(node, context), '__');
          case 'code': {
            const parent = node.parentElement;
            const isBlock = parent && parent.tagName && parent.tagName.toLowerCase() === 'pre';
            const text = (node.textContent || '').replace(/\u00a0/g, ' ');
            return isBlock ? text : `\`${trimInlineMarkdown(text)}\``;
          }
          case 'pre': {
            const text = (node.textContent || '').replace(/\u00a0/g, ' ');
            const cleaned = text.replace(/^\n+|\n+$/g, '');
            return '\n\n```\n' + cleaned + '\n```\n\n';
          }
          case 'h1':
            return `\n# ${trimInlineMarkdown(convertChildren(node, context))}\n\n`;
          case 'h2':
            return `\n## ${trimInlineMarkdown(convertChildren(node, context))}\n\n`;
          case 'h3':
            return `\n### ${trimInlineMarkdown(convertChildren(node, context))}\n\n`;
          case 'h4':
            return `\n#### ${trimInlineMarkdown(convertChildren(node, context))}\n\n`;
          case 'h5':
            return `\n##### ${trimInlineMarkdown(convertChildren(node, context))}\n\n`;
          case 'h6':
            return `\n###### ${trimInlineMarkdown(convertChildren(node, context))}\n\n`;
          case 'p':
          case 'div': {
            const inner = convertChildren(node, context);
            return inner.trim() ? `\n${inner}\n\n` : '\n';
          }
          case 'ul':
            return listToMarkdown(node, 'ul', context);
          case 'ol':
            return listToMarkdown(node, 'ol', context);
          case 'li': {
            const type = context.parentList === 'ol' ? 'ol' : 'ul';
            const index = typeof context.index === 'number' ? context.index : 1;
            return listItemToMarkdown(node, { indent: context.indent || 0, type, index });
          }
          case 'a': {
            const href = (node.getAttribute('href') || '').trim();
            const label = trimInlineMarkdown(convertChildren(node, context)) || href;
            return href ? `[${label}](${href})` : label;
          }
          case 'img': {
            const src = (node.getAttribute('src') || '').trim();
            const alt = (node.getAttribute('alt') || '').trim();
            return src ? `![${alt}](${src})` : '';
          }
          case 'blockquote':
            return blockquoteToMarkdown(node, context);
          case 'hr':
            return '\n---\n\n';
          case 'span':
          case 'section':
          case 'article':
          case 'header':
          case 'footer':
          case 'aside':
            return convertChildren(node, context);
          default:
            return convertChildren(node, context);
        }
      };
      const markdown = convertChildren(template.content, { indent: 0 });
      return markdown;
    }
    function parseMarkdownToHtml(input){
      const raw = typeof input === 'string' ? input : '';
      if(!raw.trim()) return '';
      const markedLib = window.marked;
      if(markedLib){
        try{
          const parser = typeof markedLib.parse === 'function' ? markedLib.parse : markedLib;
          const html = parser.call(markedLib, raw);
          if(typeof html === 'string' && html.trim()){
            const safe = sanitizeMarkdownHtml(html);
            if(safe) return safe;
          }
        }catch(err){
          console.warn('Markdown render error', err);
        }
      }
      return sanitizeMarkdownHtml(escapeHtml(raw).replace(/\r?\n/g,'<br>'));
    }
    function renderMarkdownText(input){
      const html = parseMarkdownToHtml(input);
      if(html) return html;
      const raw = typeof input === 'string' ? input : '';
      if(!raw.trim()) return '';
      return sanitizeMarkdownHtml(escapeHtml(raw).replace(/\r?\n/g,'<br>'));
    }
    function applyMarkdownFormatting(editable, action){
      if(!editable) return;
      editable.focus();
      const commandMap = {
        bold: () => document.execCommand('bold'),
        italic: () => document.execCommand('italic'),
        h1: () => document.execCommand('formatBlock', false, 'H1'),
        h2: () => document.execCommand('formatBlock', false, 'H2'),
        h3: () => document.execCommand('formatBlock', false, 'H3')
      };
      const handler = commandMap[action];
      if(typeof handler === 'function'){
        handler();
        editable.dispatchEvent(new Event('input', { bubbles:true }));
      }
    }
    function sortDemandasForMonth(list){
      return (Array.isArray(list)?list:[]).slice().sort((a,b)=>{
        const aDate=getDemandaStartDate(a) || getDemandaEndDate(a);
        const bDate=getDemandaStartDate(b) || getDemandaEndDate(b);
        const aTime=aDate?aDate.getTime():Number.NaN;
        const bTime=bDate?bDate.getTime():Number.NaN;
        if(Number.isNaN(aTime) && Number.isNaN(bTime)){
          return (a?.demanda||'').localeCompare(b?.demanda||'');
        }
        if(Number.isNaN(aTime)) return 1;
        if(Number.isNaN(bTime)) return -1;
        if(aTime!==bTime) return aTime-bTime;
        return (a?.demanda||'').localeCompare(b?.demanda||'');
      });
    }
    function buildMonthDemandsSummary(demands){
      if(!Array.isArray(demands) || !demands.length){
        return 'Nenhuma demanda com per√≠odo definido para este m√™s. Informe se h√° demandas pendentes para registrar o planejamento.';
      }
      return demands.map((d,idx)=>{
        normalizeDemanda(d);
        const title=d.demanda?.trim()?d.demanda.trim():'(Sem t√≠tulo)';
        const statusLabel=STATUS_OPTIONS.find(o=>o.value===d.status)?.label;
        const dueLabel=formatPrazoLabel(d);
        const parts=[`${idx+1}. ${title}`];
        if(statusLabel) parts.push(`Status: ${statusLabel}`);
        if(d.responsavel) parts.push(`Respons√°vel: ${d.responsavel}`);
        if(d.tag) parts.push(`Tag: ${d.tag}`);
        if(dueLabel) parts.push(`Per√≠odo: ${dueLabel}`);
        if(d.planos && typeof d.planos==='object'){
          PLAN_TYPES.forEach(({key,label})=>{
            const note=(d.planos?.[key]||'').trim();
            if(note) parts.push(`${label}: ${note.replace(/\s+/g,' ').trim()}`);
          });
        }
        return parts.join(' ‚Ä¢ ');
      }).join('\n');
    }
    function buildPlanIAPrompt({monthLabel, monthKey, planLabel, planKey, monthDemands, existingText}){
      const demandsText=buildMonthDemandsSummary(monthDemands);
      const existingSection=(existingText||'').trim();
      const hint=PLAN_PROMPT_HINTS[planKey] || '';
      const objectiveLine='Priorize os objetivos do m√™s registrados na aba Planejamento e conecte cada entrega √†s demandas listadas.';
      const sections=`Estruture a resposta em: \n1. Objetivo central do m√™s\n2. Principais dados e aprendizados do contexto atual\n3. Recomenda√ß√µes ${planLabel.toLowerCase()} (com rela√ß√£o direta √†s demandas)\n4. Cronograma resumido por semana\n5. Indicadores de sucesso e monitoramento\n6. Alertas ou lacunas de informa√ß√£o.`;
      const existingBlock=existingSection?`\nPlanejamento atual registrado (utilize como refer√™ncia e atualize quando fizer sentido):\n${existingSection}`:'';
      return `Voc√™ √© o planejador de marketing da Mediagrowth. Gere um planejamento ${planLabel.toLowerCase()} para o m√™s ${monthLabel} (${monthKey}).\nUtilize todas as informa√ß√µes dispon√≠veis na plataforma do cliente: trechos do c√≥digo da plataforma, descri√ß√£o textual, snapshot do Firebase, estados da plataforma, guia autom√°tico das abas e demandas cadastradas. ${objectiveLine}\nTipo de planejamento: ${planLabel}. ${hint}\nDemandas do m√™s:\n${demandsText}${existingBlock}\n${sections}\nConclua com uma se√ß√£o "Pr√≥ximos passos imediatos" com at√© cinco bullets claros.`;
    }
    function handlePlanIAGeneration({monthLabel, monthKey, planLabel, planKey, editable, monthDemands}){
      const existingText=(editable?.innerText||'').trim();
      const promptText=buildPlanIAPrompt({monthLabel, monthKey, planLabel, planKey, monthDemands, existingText});
      openIAWithPrompt(promptText);
    }
    function buildObjectivePlanIAPrompt({monthLabel, monthKey, monthDemands, monthPlan}){
      if(!Array.isArray(monthDemands) || !monthDemands.length) return '';
      const plan = monthPlan && typeof monthPlan === 'object' ? monthPlan : normalizeMonthPlan(monthKey);
      const demandBlocks = monthDemands.map((d,idx)=>{
        normalizeDemanda(d);
        const title = d.demanda?.trim() ? d.demanda.trim() : '(Sem t√≠tulo)';
        const statusLabel = STATUS_OPTIONS.find(o=>o.value===d.status)?.label || 'Sem status informado';
        const prazoLabel = formatPrazoLabel(d);
        const partes = [
          `${idx+1}. ID: ${d.id || ''}`.trim(),
          `Objetivo: ${title}`,
          `Status: ${statusLabel}`
        ];
        if(d.responsavel) partes.push(`Respons√°vel: ${d.responsavel}`);
        if(d.tag) partes.push(`Tag: ${d.tag}`);
        if(prazoLabel) partes.push(`Per√≠odo: ${prazoLabel}`);
        PLAN_TYPES.forEach(({key,label})=>{
          const val = (d.planos?.[key]||'').trim();
          if(val) partes.push(`${label} registrado: ${val.replace(/\s+/g,' ').trim()}`);
        });
        const existingNote = plan?.objectiveNotes?.[d.id];
        if(existingNote){
          partes.push(`Plano atual salvo: ${htmlStringToText(existingNote)}`);
        }
        return partes.join('\n');
      }).join('\n\n');
      const planSections = PLAN_TYPES.map(({key,label})=>{
        const text = plan?.[key] ? htmlStringToText(plan[key]) : '';
        return text ? `${label}: ${text}` : `${label}: (sem registro)`;
      }).join('\n');
      return [
        `Cliente Mediagrowth ‚Äì Planejamento mensal ${monthLabel} (${monthKey}).`,
        'Utilize todas as fontes dispon√≠veis na plataforma: c√≥digo da plataforma, descri√ß√£o textual, snapshot do Firebase, estados locais, guia autom√°tico das abas, demandas cadastradas e base da IA.',
        'Crie um checklist operacional de 3 a 7 passos para cada objetivo listado, garantindo foco pr√°tico em execu√ß√£o semanal.',
        'Dados dos objetivos com contexto atual:',
        demandBlocks,
        'Planos mensais j√° registrados:',
        planSections,
        'Responda apenas com JSON v√°lido no formato:',
        '{"objetivos":[{"id":"ID_DA_DEMANDA","passos":[{"tarefa":"A√ß√£o pr√°tica e objetiva","responsavel":"Nome completo ou √°rea","prazo":"Data, semana ou per√≠odo","metrica":"Indicador de sucesso mensur√°vel"}],"observacoes":"(opcional)"}],"planejamento_estrategico_mensal_markdown":"resumo executivo com foco em execu√ß√£o","plano_tatico_markdown":"(opcional)","plano_operacional_markdown":"(opcional)"}',
        'Utilize de 3 a 7 passos por objetivo, com descri√ß√µes objetivas, respons√°veis, prazos e m√©tricas em cada passo. Caso algum campo n√£o se aplique, utilize string vazia.',
        'Ao preencher cada passo, forne√ßa um objeto com os campos tarefa, responsavel, prazo e metrica. O checklist final deve ser apresentado em Markdown com checkboxes (- [ ] ...).',
        'N√£o substitua planejamentos anteriores: acrescente somente atualiza√ß√µes √∫teis, evitando repetir exatamente os mesmos passos.',
        'Conclua preenchendo o campo planejamento_estrategico_mensal_markdown com o plano estrat√©gico consolidado do m√™s. Se n√£o tiver conte√∫do para os campos t√°tico ou operacional, deixe-os como string vazia.'
      ].filter(Boolean).join('\n\n');
    }
    function extractJsonBlock(text){
      if(typeof text !== 'string') return null;
      const match = text.match(/```(?:json)?\s*([\s\S]*?)```/i);
      const candidate = match ? match[1] : text;
      const trimmed = candidate.trim();
      if(!trimmed) return null;
      try{
        return JSON.parse(trimmed);
      }catch(err){
        const first = trimmed.indexOf('{');
        const last = trimmed.lastIndexOf('}');
        if(first !== -1 && last !== -1 && last > first){
          const sliced = trimmed.slice(first, last+1);
          try{ return JSON.parse(sliced); }
          catch(_err){ return null; }
        }
        return null;
      }
    }
    function convertMarkdownToHtmlContent(markdown){
      const raw = typeof markdown === 'string' ? markdown.trim() : '';
      if(!raw) return '';
      const parsed = parseMarkdownToHtml(raw);
      if(parsed) return sanitizeMarkdownHtml(parsed);
      return sanitizeMarkdownHtml(escapeHtml(raw).replace(/\r?\n/g,'<br>'));
    }
    function formatAIUpdateTimestamp(){
      const now = new Date();
      try{
        return now.toLocaleString('pt-BR',{ day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
      }catch(_err){
        const iso = now.toISOString();
        return `${iso.slice(0,10)} ${iso.slice(11,16)}`;
      }
    }
    function appendSanitizedHtml(existingHtml, newHtml){
      const existing = typeof existingHtml === 'string' ? existingHtml.trim() : '';
      const fresh = typeof newHtml === 'string' ? newHtml.trim() : '';
      if(!fresh) return existing;
      if(!existing) return fresh;
      if(existing.includes(fresh)) return existing;
      const combined = `${existing}<hr data-ai-plan="true">${fresh}`;
      return sanitizeMarkdownHtml(combined);
    }
    function normalizePlanStep(step, index){
      if(step==null) return '';
      if(typeof step === 'string'){
        const trimmed = step.trim();
        return trimmed ? `- [ ] ${trimmed}` : '';
      }
      if(typeof step !== 'object') return '';
      const descriptionKeys=['descricao','descri√ß√£o','passo','atividade','tarefa','acao','a√ß√£o','texto','resumo','etapa','titulo','t√≠tulo','title','headline'];
      let description='';
      for(const key of descriptionKeys){
        const value = step[key];
        if(typeof value === 'string' && value.trim()){
          description = value.trim();
          break;
        }
      }
      if(!description && Array.isArray(step.descricao)){ description = step.descricao.map(v=>String(v||'').trim()).filter(Boolean).join(' '); }
      if(!description) return '';
      const responsavelKeys=['responsavel','respons√°vel','owner','responsavel_principal','responsavelGeral','accountable'];
      let responsavel='';
      for(const key of responsavelKeys){
        const value = step[key];
        if(typeof value === 'string' && value.trim()){
          responsavel = value.trim();
          break;
        }
        if(Array.isArray(value)){
          const joined = value.map(v=>String(v||'').trim()).filter(Boolean).join(', ');
          if(joined){ responsavel = joined; break; }
        }
      }
      if(!responsavel && Array.isArray(step.responsaveis)){
        responsavel = step.responsaveis.map(v=>String(v||'').trim()).filter(Boolean).join(', ');
      }
      const prazoKeys=['prazo','deadline','data','quando','entrega','periodo','per√≠odo'];
      let prazo='';
      for(const key of prazoKeys){
        const value = step[key];
        if(typeof value === 'string' && value.trim()){
          prazo = value.trim();
          break;
        }
      }
      const metricaKeys=['metrica','m√©trica','indicador','kpi','kpis','metricas','indicadores'];
      let metrica='';
      for(const key of metricaKeys){
        const value = step[key];
        if(typeof value === 'string' && value.trim()){
          metrica = value.trim();
          break;
        }
        if(Array.isArray(value)){
          const joined = value.map(v=>String(v||'').trim()).filter(Boolean).join(', ');
          if(joined){ metrica = joined; break; }
        }
      }
      const metaParts=[];
      if(responsavel) metaParts.push(`Respons√°vel: ${responsavel}`);
      if(prazo) metaParts.push(`Prazo: ${prazo}`);
      if(metrica) metaParts.push(`M√©trica: ${metrica}`);
      const info = metaParts.length ? ` ‚Äî ${metaParts.join(' ‚Ä¢ ')}` : '';
      return `- [ ] ${description}${info}`;
    }
    function buildObjectivePlanEntryMarkdown(item){
      if(!item || typeof item !== 'object') return '';
      const timestampLabel = formatAIUpdateTimestamp();
      const sections=[];
      sections.push(`#### Checklist Operacional ‚Äì ${timestampLabel}`);
      let rawSteps=item.passos;
      if(rawSteps && typeof rawSteps==='object' && !Array.isArray(rawSteps)){
        rawSteps=Object.values(rawSteps);
      }
      if(!Array.isArray(rawSteps)){ rawSteps=[]; }
      const normalizedSteps=rawSteps.slice(0,7).map((step,index)=> normalizePlanStep(step,index)).filter(Boolean);
      if(!normalizedSteps.length){
        const fallbackMarkdown = typeof item.markdown==='string'?item.markdown.trim():'';
        if(fallbackMarkdown){
          sections.push(fallbackMarkdown);
        }
      }else{
        sections.push(normalizedSteps.join('\n'));
      }
      const observacaoKeys=['observacoes','observa√ß√£o','observacao','comentarios','coment√°rio','comentario','resumo'];
      for(const key of observacaoKeys){
        const value=item[key];
        if(typeof value==='string' && value.trim()){
          sections.push(`**Observa√ß√µes:** ${value.trim()}`);
          break;
        }
      }
      const metricExtras=item.metricas_chave||item.metricasExtras||item.metricas_adicionais||item.metricasComplementares;
      if(Array.isArray(metricExtras)){
        const lines=metricExtras.map(v=>String(v||'').trim()).filter(Boolean);
        if(lines.length){
          sections.push(`**M√©tricas complementares:**\n${lines.map(line=>`- ${line}`).join('\n')}`);
        }
      }else if(typeof metricExtras==='string' && metricExtras.trim()){
        sections.push(`**M√©tricas complementares:** ${metricExtras.trim()}`);
      }
      const filtered=sections.filter(Boolean);
      if(filtered.length<=1) return '';
      return filtered.join('\n\n');
    }
    function applyObjectivePlanAIResult({ result, monthKey, monthDemands }){
      if(!result || typeof result !== 'object') return false;
      const monthPlan = normalizeMonthPlan(monthKey);
      if(!monthPlan) return false;
      if(!monthPlan.objectiveNotes || typeof monthPlan.objectiveNotes !== 'object'){
        monthPlan.objectiveNotes = {};
      }
      const demandList = Array.isArray(monthDemands) ? monthDemands : [];
      const demandById = new Map();
      demandList.forEach(d=>{ if(d?.id) demandById.set(String(d.id), d); });
      let changed = false;
      if(Array.isArray(result.objetivos)){
        result.objetivos.forEach(item=>{
          if(!item || typeof item !== 'object') return;
          let demand = null;
          const id = item.id ? String(item.id).trim() : '';
          if(id && demandById.has(id)){
            demand = demandById.get(id);
          }else if(item.objetivo){
            const targetTitle = String(item.objetivo).trim().toLowerCase();
            if(targetTitle){
              demand = demandList.find(d=> (d?.demanda||'').trim().toLowerCase() === targetTitle);
            }
          }
          if(!demand || !demand.id) return;
          let markdown = buildObjectivePlanEntryMarkdown(item);
          if(!markdown){
            if(typeof item.markdown === 'string' && item.markdown.trim()){
              const timestampLabel = formatAIUpdateTimestamp();
              markdown = [`#### Checklist Operacional ‚Äì ${timestampLabel}`, item.markdown.trim()].join('\n\n');
            }else if(Array.isArray(item.passos)){
              const normalizedFallback=item.passos.slice(0,7).map((step,index)=> normalizePlanStep(step,index)).filter(Boolean);
              if(normalizedFallback.length){
                const timestampLabel = formatAIUpdateTimestamp();
                markdown = [`#### Checklist Operacional ‚Äì ${timestampLabel}`, normalizedFallback.join('\n')].join('\n\n');
              }else{
                markdown = item.passos.map(step=>`- [ ] ${String(step||'').trim()}`).join('\n');
              }
            }else if(typeof item.plano === 'string' && item.plano.trim()){
              const timestampLabel = formatAIUpdateTimestamp();
              markdown = [`#### Checklist Operacional ‚Äì ${timestampLabel}`, item.plano.trim()].join('\n\n');
            }
          }
          const html = convertMarkdownToHtmlContent(markdown);
          if(!html) return;
          const existingHtml = typeof monthPlan.objectiveNotes[demand.id] === 'string' ? monthPlan.objectiveNotes[demand.id] : '';
          const combinedHtml = appendSanitizedHtml(existingHtml, html);
          const finalHtml = combinedHtml || html;
          if(finalHtml && finalHtml !== existingHtml){
            monthPlan.objectiveNotes[demand.id] = finalHtml;
            changed = true;
          }
        });
      }
      const planKeyMap = {
        estrategico: ['plano_estrategico_markdown','plano_estrategico','planejamento_estrategico_markdown','planejamento_estrategico_mensal_markdown'],
        tatico: ['plano_tatico_markdown','plano_tatico'],
        operacional: ['plano_operacional_markdown','plano_operacional']
      };
      Object.entries(planKeyMap).forEach(([planKey, keys])=>{
        keys.forEach(name=>{
          const value = result && typeof result === 'object' ? result[name] : '';
          if(typeof value === 'string' && value.trim()){
            const markdownValue = value.trim();
            const timestampLabel = formatAIUpdateTimestamp();
            const wrappedMarkdown = `### Planejamento Estrat√©gico ‚Äì ${timestampLabel}\n\n${markdownValue}`;
            const html = convertMarkdownToHtmlContent(wrappedMarkdown);
            if(!html) return;
            const existingHtml = typeof monthPlan[planKey] === 'string' ? monthPlan[planKey] : '';
            const combinedHtml = appendSanitizedHtml(existingHtml, html);
            const finalHtml = combinedHtml || html;
            if(finalHtml && finalHtml !== existingHtml){
              monthPlan[planKey] = finalHtml;
              changed = true;
            }
          }
        });
      });
      return changed;
    }
    async function generateObjectivePlansWithAI(button){
      if(button){ button.disabled = true; }
      const originalText = button?.textContent;
      if(button){ button.textContent = 'Gerando...'; }
      try{
        if(!auth?.currentUser){
          throw new Error('Fa√ßa login para gerar o planejamento automaticamente.');
        }
        const apiKey = window.OPENROUTER_API_KEY;
        if(!apiKey){
          throw new Error('Configure a chave do OpenRouter (window.OPENROUTER_API_KEY).');
        }
        const monthKey = typeof selectedDemandaMonth === 'string' ? selectedDemandaMonth : '';
        if(!monthKey){
          throw new Error('Selecione um m√™s v√°lido na planilha de planejamento.');
        }
        const monthDate = new Date(`${monthKey}-01T00:00:00`);
        if(Number.isNaN(monthDate.getTime())){
          throw new Error('N√£o foi poss√≠vel interpretar o m√™s selecionado.');
        }
        const monthLabelRaw = monthDate.toLocaleDateString('pt-BR',{ month:'long', year:'numeric' });
        const monthLabel = monthLabelRaw.charAt(0).toUpperCase()+monthLabelRaw.slice(1);
        const monthPlan = normalizeMonthPlan(monthKey);
        const monthDemands = (Array.isArray(DEMANDAS)?DEMANDAS:[]).filter(d=>{
          const keys = getDemandMonthKeys(d);
          return keys.includes(monthKey);
        });
        if(!monthDemands.length){
          throw new Error('Cadastre objetivos com per√≠odo neste m√™s para gerar o planejamento.');
        }
        const prompt = buildObjectivePlanIAPrompt({ monthLabel, monthKey, monthDemands, monthPlan });
        if(!prompt.trim()){
          throw new Error('N√£o foi poss√≠vel preparar a solicita√ß√£o autom√°tica.');
        }
        const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages: [
              { role: 'system', content: 'Voc√™ √© o planejador de marketing da Mediagrowth. Respeite fielmente o formato JSON solicitado.' },
              { role: 'user', content: prompt }
            ]
          })
        });
        const data = await response.json();
        if(!response.ok){
          throw new Error(data?.error?.message || `HTTP ${response.status}`);
        }
        const content = data?.choices?.[0]?.message?.content || '';
        const parsed = extractJsonBlock(content);
        if(!parsed){
          throw new Error('A resposta gerada n√£o p√¥de ser interpretada.');
        }
        const updated = applyObjectivePlanAIResult({ result: parsed, monthKey, monthDemands });
        if(!updated){
          throw new Error('A resposta gerada n√£o trouxe dados utiliz√°veis.');
        }
        scheduleDemandasPersist();
        renderDemandas({ force:true });
        if(typeof mgToast === 'function'){
          mgToast('Planejamento mensal atualizado.');
        }
      }catch(err){
        console.error('generateObjectivePlansWithAI', err);
        alert(err?.message || String(err));
      }finally{
        if(button){
          button.disabled = false;
          if(typeof originalText === 'string'){ button.textContent = originalText; }
        }
      }
    }
    function renderDemandaPlans(){
      const container=$('demandaPlans');
      if(!container) return;
      const groups={};
      const monthKeysSet=new Set();
      DEMANDAS.forEach(d=>{
        normalizeDemanda(d);
        const months=getDemandMonthKeys(d);
        if(!months.length) return;
        months.forEach(key=>{
          if(!groups[key]) groups[key]=[];
          groups[key].push(d);
          monthKeysSet.add(key);
          normalizeMonthPlan(key);
        });
      });
      Object.keys(DEMANDA_MONTH_PLANS||{}).forEach(monthKey=>{
        if(typeof monthKey==='string' && monthKey){
          monthKeysSet.add(monthKey);
          normalizeMonthPlan(monthKey);
        }
      });
      if(selectedDemandaMonth){
        monthKeysSet.add(selectedDemandaMonth);
        normalizeMonthPlan(selectedDemandaMonth);
      }
      let months=Array.from(monthKeysSet).sort();
      if(selectedDemandaMonth){
        months=months.filter(monthKey=>monthKey===selectedDemandaMonth);
      }
      container.innerHTML='';
      if(!months.length){
        container.innerHTML='<div class="demanda-plan-empty">Defina um per√≠odo para gerar os planos das demandas.</div>';
        return;
      }
      months.forEach(monthKey=>{
        const monthDate=new Date(`${monthKey}-01T00:00:00`);
        const monthLabelRaw=monthDate.toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
        const monthLabel=monthLabelRaw.charAt(0).toUpperCase()+monthLabelRaw.slice(1);
        const monthSection=document.createElement('section');
        monthSection.className='demanda-plan-month';
        const title=document.createElement('h3');
        title.className='demanda-plan-month-title';
        title.textContent=monthLabel;
        monthSection.appendChild(title);
        const monthContent=document.createElement('div');
        monthContent.className='demanda-plan-month-content';
        const plansBox=document.createElement('div');
        plansBox.className='demanda-plan-month-plans';
        const tabs=document.createElement('div');
        tabs.className='demanda-plan-tabs';
        const notesWrap=document.createElement('div');
        notesWrap.className='demanda-plan-notes';
        const monthPlan=normalizeMonthPlan(monthKey);
        const monthDemands=sortDemandasForMonth(groups[monthKey]||[]);
        PLAN_TYPES.forEach(({key,label},index)=>{
          const btn=document.createElement('button');
          btn.type='button';
          btn.className='demanda-plan-tab'+(index===0?' active':'');
          btn.textContent=label;
          const note=document.createElement('div');
          note.className='demanda-plan-note'+(index===0?' active':'');
          const editor=document.createElement('div');
          editor.className='demanda-plan-note-editor';
          const toolbar=document.createElement('div');
          toolbar.className='markdown-toolbar';
          const actions=document.createElement('div');
          actions.className='demanda-plan-note-actions';
          const iaBtn=document.createElement('button');
          iaBtn.type='button';
          iaBtn.className='btn small ghost demanda-plan-ia-btn';
          iaBtn.textContent=`Gerar planejamento ${label.toLowerCase()}`;
          iaBtn.addEventListener('click',()=>{
            handlePlanIAGeneration({
              monthLabel,
              monthKey,
              planLabel:label,
              planKey:key,
              editable,
              monthDemands
            });
          });
          actions.appendChild(iaBtn);
          const editable=document.createElement('div');
          editable.className='demanda-plan-note-editor-area markdown-view';
          editable.setAttribute('contenteditable','true');
          editable.setAttribute('spellcheck','false');
          const toolbarButtons=[
            { action:'bold', label:'Negrito', shortLabel:'B' },
            { action:'italic', label:'It√°lico', shortLabel:'I' },
            { action:'h1', label:'T√≠tulo H1', shortLabel:'H1' },
            { action:'h2', label:'T√≠tulo H2', shortLabel:'H2' },
            { action:'h3', label:'T√≠tulo H3', shortLabel:'H3' }
          ];
          toolbarButtons.forEach(cfg=>{
            const btn=document.createElement('button');
            btn.type='button';
            btn.textContent=cfg.shortLabel;
            btn.setAttribute('title', cfg.label);
            btn.addEventListener('click',()=>applyMarkdownFormatting(editable,cfg.action));
            toolbar.appendChild(btn);
          });
          editable.dataset.placeholder=`Anota√ß√µes do ${label.toLowerCase()}`;
          const initialValue=monthPlan?.[key]||'';
          const initialHtml=parseMarkdownToHtml(initialValue);
          if(initialHtml){
            editable.innerHTML=initialHtml;
            if(!editable.textContent.trim()) editable.innerHTML='';
          }else if(initialValue){
            editable.innerText=initialValue;
          }
          const syncPlanNote=()=>{
            const plan=normalizeMonthPlan(monthKey);
            if(!plan) return;
            const isActive=document.activeElement===editable;
            const selectionState=isActive?getEditableSelection(editable):null;
            const rawHtml=editable.innerHTML;
            const sanitizedCurrent=sanitizeMarkdownHtml(rawHtml);
            const markdownSource=htmlToMarkdown(sanitizedCurrent);
            const parsedHtml=markdownSource?parseMarkdownToHtml(markdownSource):sanitizedCurrent;
            const nextHtml=sanitizeMarkdownHtml(parsedHtml||'');
            if(nextHtml!==editable.innerHTML){
              editable.innerHTML=nextHtml;
            }
            if(isActive && selectionState){
              restoreEditableSelection(editable, selectionState);
            }
            if(!editable.textContent.trim() && !editable.querySelector('img,video,iframe,embed,hr')){
              editable.innerHTML='';
              if(isActive){
                restoreEditableSelection(editable, { start:0, end:0 });
              }
            }
            const cleanHtml=sanitizeMarkdownHtml((editable.innerHTML||'').trim());
            if((plan[key]||'')===cleanHtml){
              return;
            }
            plan[key]=cleanHtml;
            scheduleDemandasPersist();
            renderDemandaMonthButtons();
          };
          const scheduleSyncPlanNote=debounce(syncPlanNote,300);
          editable.addEventListener('input',()=>{ scheduleSyncPlanNote(); });
          editable.addEventListener('blur',()=>{ syncPlanNote(); flushDemandasPersist(); });
          editable.addEventListener('paste',event=>{
            const clipboard=event?.clipboardData || window.clipboardData;
            if(!clipboard){
              setTimeout(syncPlanNote,0);
              return;
            }
            let htmlData='';
            let textData='';
            try{
              htmlData=clipboard.getData('text/html')||'';
            }catch(_err){ htmlData=''; }
            if(!htmlData){
              try{ htmlData=clipboard.getData('HTML')||''; }
              catch(_err){ htmlData=''; }
            }
            try{
              textData=clipboard.getData('text/plain')||'';
            }catch(_err){
              try{ textData=clipboard.getData('Text')||clipboard.getData('text')||''; }
              catch(__err){ textData=''; }
            }
            if(!htmlData && !textData){
              setTimeout(syncPlanNote,0);
              return;
            }
            event.preventDefault();
            let finalHtml='';
            if(htmlData){
              const sanitizedHtml=sanitizeMarkdownHtml(htmlData);
              const markdown=htmlToMarkdown(sanitizedHtml);
              finalHtml=parseMarkdownToHtml(markdown)||sanitizedHtml;
            }else if(textData){
              finalHtml=parseMarkdownToHtml(textData);
              if(!finalHtml){
                finalHtml=sanitizeMarkdownHtml(escapeHtml(textData).replace(/\r?\n/g,'<br>'));
              }
            }
            finalHtml=sanitizeMarkdownHtml(finalHtml||'');
            if(finalHtml){
              let insertWithExecCommand=false;
              try{
                insertWithExecCommand=typeof document.execCommand==='function' && (!document.queryCommandSupported || document.queryCommandSupported('insertHTML'));
              }catch(_err){
                insertWithExecCommand=typeof document.execCommand==='function';
              }
              if(insertWithExecCommand){
                document.execCommand('insertHTML',false,finalHtml);
              }else{
                const selection=window.getSelection();
                if(selection && selection.rangeCount){
                  selection.deleteContents();
                  const temp=document.createElement('div');
                  temp.innerHTML=finalHtml;
                  const frag=document.createDocumentFragment();
                  let node;
                  while((node=temp.firstChild)){
                    frag.appendChild(node);
                  }
                  const range=selection.getRangeAt(0);
                  range.insertNode(frag);
                  range.collapse(false);
                  selection.removeAllRanges();
                  selection.addRange(range);
                }
              }
            }
            scheduleSyncPlanNote();
          });
          editor.appendChild(toolbar);
          editor.appendChild(actions);
          editor.appendChild(editable);
          note.appendChild(editor);
          btn.addEventListener('click',()=>{
            tabs.querySelectorAll('.demanda-plan-tab').forEach(b=>b.classList.remove('active'));
            notesWrap.querySelectorAll('.demanda-plan-note').forEach(n=>n.classList.remove('active'));
            btn.classList.add('active');
            note.classList.add('active');
          });
          if(!editable.innerHTML.trim() && initialValue){
            const parsed=parseMarkdownToHtml(initialValue);
            editable.innerHTML=parsed || '';
            if(!editable.textContent.trim()) editable.innerHTML='';
          }
          tabs.appendChild(btn);
          notesWrap.appendChild(note);
        });
        plansBox.appendChild(tabs);
        plansBox.appendChild(notesWrap);
        const itemsWrap=document.createElement('div');
        itemsWrap.className='demanda-plan-demand-list';
        if(monthDemands.length){
          monthDemands.forEach(d=>{
            normalizeDemanda(d);
            const item=document.createElement('div');
            item.className='demanda-plan-item';
            const header=document.createElement('div');
            header.className='demanda-plan-header';
            const titleEl=document.createElement('div');
            titleEl.className='demanda-plan-title';
            titleEl.textContent=d.demanda?.trim()?d.demanda:'(Sem t√≠tulo)';
            const dateEl=document.createElement('div');
            dateEl.className='demanda-plan-date';
            dateEl.textContent=formatPrazoLabel(d);
            header.appendChild(titleEl);
            header.appendChild(dateEl);
            item.appendChild(header);
            const metaParts=[];
            const statusLabel=STATUS_OPTIONS.find(o=>o.value===d.status)?.label;
            if(statusLabel) metaParts.push(statusLabel);
            if(d.responsavel) metaParts.push(`Resp.: ${d.responsavel}`);
            if(d.tag) metaParts.push(`Tag: ${d.tag}`);
            if(metaParts.length){
              const meta=document.createElement('div');
              meta.className='demanda-plan-demand-meta';
              meta.textContent=metaParts.join(' ‚Ä¢ ');
              item.appendChild(meta);
            }
            const actionWrap=document.createElement('div');
            actionWrap.className='demanda-plan-action';
            const actionLabel=document.createElement('div');
            actionLabel.className='demanda-plan-action-label';
            actionLabel.textContent='Plano de A√ß√£o';
            const actionEditable=document.createElement('div');
            actionEditable.className='demanda-plan-action-editor markdown-view';
            actionEditable.setAttribute('contenteditable','true');
            actionEditable.setAttribute('spellcheck','false');
            actionEditable.setAttribute('aria-label',`Plano de a√ß√£o para ${titleEl.textContent}`);
            actionEditable.dataset.placeholder='Detalhe as pr√≥ximas a√ß√µes ou anota√ß√µes para este objetivo';
            const demandKey=typeof d.id==='string'&&d.id?d.id:'';
            const existingNote=demandKey&&monthPlan?.objectiveNotes?monthPlan.objectiveNotes[demandKey]:'';
            const initialNote=sanitizeMarkdownHtml(existingNote||'');
            if(initialNote){
              actionEditable.innerHTML=initialNote;
              if(!actionEditable.textContent.trim()&&!actionEditable.querySelector('img,video,iframe,embed,hr')){
                actionEditable.innerHTML='';
              }
            }
            if(demandKey){
              const syncActionPlan=()=>{
                const plan=normalizeMonthPlan(monthKey);
                if(!plan) return;
                if(!plan.objectiveNotes||typeof plan.objectiveNotes!=='object'){
                  plan.objectiveNotes={};
                }
                const isActive=document.activeElement===actionEditable;
                const selectionState=isActive?getEditableSelection(actionEditable):null;
                const rawHtml=actionEditable.innerHTML||'';
                const sanitizedCurrent=sanitizeMarkdownHtml(rawHtml);
                if(sanitizedCurrent!==rawHtml){
                  actionEditable.innerHTML=sanitizedCurrent;
                  if(isActive&&selectionState){
                    restoreEditableSelection(actionEditable,selectionState);
                  }
                }
                if(!actionEditable.textContent.trim()&&!actionEditable.querySelector('img,video,iframe,embed,hr')){
                  actionEditable.innerHTML='';
                  if(isActive){
                    restoreEditableSelection(actionEditable,{start:0,end:0});
                  }
                }
                const cleanHtml=sanitizeMarkdownHtml((actionEditable.innerHTML||'').trim());
                const prev=typeof plan.objectiveNotes[demandKey]==='string'?plan.objectiveNotes[demandKey]:'';
                if(prev===cleanHtml){
                  return;
                }
                if(cleanHtml){
                  plan.objectiveNotes[demandKey]=cleanHtml;
                }else{
                  delete plan.objectiveNotes[demandKey];
                }
                scheduleDemandasPersist();
              };
              const scheduleSyncActionPlan=debounce(syncActionPlan,300);
              actionEditable.addEventListener('input',()=>{ scheduleSyncActionPlan(); });
              actionEditable.addEventListener('blur',()=>{ syncActionPlan(); flushDemandasPersist(); });
              actionEditable.addEventListener('paste',event=>{
                const clipboard=event?.clipboardData||window.clipboardData;
                if(!clipboard){
                  setTimeout(syncActionPlan,0);
                  return;
                }
                let htmlData='';
                let textData='';
                try{ htmlData=clipboard.getData('text/html')||''; }
                catch(_err){ htmlData=''; }
                if(!htmlData){
                  try{ htmlData=clipboard.getData('HTML')||''; }
                  catch(__err){ htmlData=''; }
                }
                try{ textData=clipboard.getData('text/plain')||''; }
                catch(_err){
                  try{ textData=clipboard.getData('Text')||clipboard.getData('text')||''; }
                  catch(__err){ textData=''; }
                }
                if(!htmlData&&!textData){
                  setTimeout(syncActionPlan,0);
                  return;
                }
                event.preventDefault();
                let finalHtml='';
                if(htmlData){
                  finalHtml=sanitizeMarkdownHtml(htmlData);
                }else if(textData){
                  finalHtml=sanitizeMarkdownHtml(escapeHtml(textData).replace(/\r?\n/g,'<br>'));
                }
                finalHtml=sanitizeMarkdownHtml(finalHtml||'');
                if(finalHtml){
                  let insertWithExecCommand=false;
                  try{
                    insertWithExecCommand=typeof document.execCommand==='function'&&(!document.queryCommandSupported||document.queryCommandSupported('insertHTML'));
                  }catch(_err){
                    insertWithExecCommand=typeof document.execCommand==='function';
                  }
                  if(insertWithExecCommand){
                    document.execCommand('insertHTML',false,finalHtml);
                  }else{
                    const selection=window.getSelection();
                    if(selection&&selection.rangeCount){
                      selection.deleteContents();
                      const temp=document.createElement('div');
                      temp.innerHTML=finalHtml;
                      const frag=document.createDocumentFragment();
                      let node;
                      while((node=temp.firstChild)){
                        frag.appendChild(node);
                      }
                      const range=selection.getRangeAt(0);
                      range.insertNode(frag);
                      range.collapse(false);
                      selection.removeAllRanges();
                      selection.addRange(range);
                    }else{
                      actionEditable.insertAdjacentHTML('beforeend',finalHtml);
                    }
                  }
                }
                scheduleSyncActionPlan();
              });
            }else{
              actionEditable.setAttribute('contenteditable','false');
              actionEditable.dataset.placeholder='Salve o objetivo para habilitar o plano de a√ß√£o';
            }
            actionWrap.appendChild(actionLabel);
            actionWrap.appendChild(actionEditable);
            item.appendChild(actionWrap);
            itemsWrap.appendChild(item);
          });
        }else{
          const empty=document.createElement('div');
          empty.className='demanda-plan-empty-demands';
          empty.textContent='Nenhuma demanda com per√≠odo definido para este m√™s.';
          itemsWrap.appendChild(empty);
        }
        monthContent.appendChild(itemsWrap);
        monthContent.appendChild(plansBox);
        monthSection.appendChild(monthContent);
        container.appendChild(monthSection);
      });
    }
    /* ========= impedimentos ========= */
    const IMPEDIMENT_STATUS_OPTIONS = [
      { value: 'pending', label: 'Ainda n√£o resolvido' },
      { value: 'resolved', label: 'Resolvido' }
    ];
    const IMPEDIMENT_STATUS_VALUES = new Set(IMPEDIMENT_STATUS_OPTIONS.map(opt => opt.value));
    let IMPEDIMENT_ALERTS = [];
    const IMPEDIMENTS_SAVE_DEBOUNCE_MS = 800;
    let impedimentsSaveTimer = null;
    let impedimentsSavePending = false;
    let impedimentsSaveInFlight = false;
    let impedimentsSaveQueued = false;
    let lastImpedimentsSignature = '';
    let lastRemoteImpedimentsSignature = '';
    function computeImpedimentsSignature(list){
      if(!Array.isArray(list) || list.length === 0) return '[]';
      return list.map(item => {
        const id = item && typeof item.id === 'string' ? item.id : '';
        const text = item && typeof item.descricao === 'string' ? item.descricao.trim() : '';
        const status = item && typeof item.status === 'string' ? item.status : 'pending';
        return `${id}|${text}|${status}`;
      }).join('||');
    }
    function fallbackUUID(){
      return `imp-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;
    }
    function createImpediment(data={}){
      const baseId = typeof data.id === 'string' && data.id ? data.id : (typeof uuid === 'function' ? uuid() : fallbackUUID());
      const statusValue = typeof data.status === 'string' && IMPEDIMENT_STATUS_VALUES.has(data.status) ? data.status : 'pending';
      return {
        id: baseId,
        descricao: typeof data.descricao === 'string' ? data.descricao : '',
        status: statusValue
      };
    }
    function applyImpedimentsFromSource(source, { fromRemote=false }={}){
      const list = Array.isArray(source) ? source : [];
      IMPEDIMENT_ALERTS = list.map(item => createImpediment(item));
      if(!IMPEDIMENT_ALERTS.length){
        IMPEDIMENT_ALERTS.push(createImpediment());
      }
      const signature = computeImpedimentsSignature(IMPEDIMENT_ALERTS);
      lastImpedimentsSignature = signature;
      if(fromRemote){
        lastRemoteImpedimentsSignature = signature;
        if(impedimentsSaveTimer){
          clearTimeout(impedimentsSaveTimer);
          impedimentsSaveTimer = null;
        }
        impedimentsSavePending = false;
        impedimentsSaveQueued = false;
      }
    }
    function loadImpedimentsFromUserData(){
      const source = USER_DATA && Array.isArray(USER_DATA.impediments) ? USER_DATA.impediments : [];
      applyImpedimentsFromSource(source, { fromRemote:true });
    }
    function updateImpedimentsSignature(){
      lastImpedimentsSignature = computeImpedimentsSignature(IMPEDIMENT_ALERTS);
    }
    function renderImpediments(){
      const section = $('impedimentosSection');
      const tbody = $('impedimentosBody');
      const empty = $('impedimentosEmpty');
      if(!tbody){ return; }
      if(!Array.isArray(IMPEDIMENT_ALERTS) || !IMPEDIMENT_ALERTS.length){
        IMPEDIMENT_ALERTS = [createImpediment()];
      }
      tbody.innerHTML = '';
      IMPEDIMENT_ALERTS.forEach(item => {
        const tr = document.createElement('tr');
        tr.dataset.id = item.id;
        tr.dataset.status = item.status;
        const iconTd = document.createElement('td');
        iconTd.className = 'icon-cell';
        const iconSpan = document.createElement('span');
        iconSpan.setAttribute('role','img');
        iconSpan.setAttribute('aria-label','Alerta de aten√ß√£o');
        iconSpan.textContent = '‚ö†Ô∏è';
        iconTd.appendChild(iconSpan);
        const descTd = document.createElement('td');
        const textarea = document.createElement('textarea');
        textarea.placeholder = 'Descreva o impedimento identificado (ex.: atraso no fornecedor, falta de or√ßamento, cliente sem aprova√ß√£o).';
        textarea.value = item.descricao || '';
        textarea.addEventListener('input', ()=>{
          item.descricao = textarea.value;
          updateImpedimentsSignature();
          scheduleImpedimentsPersist();
        });
        textarea.addEventListener('blur', ()=>{
          item.descricao = textarea.value;
          updateImpedimentsSignature();
          scheduleImpedimentsPersist({ immediate:true });
        });
        descTd.appendChild(textarea);
        const statusTd = document.createElement('td');
        const statusWrap = document.createElement('div');
        statusWrap.className = 'impedimentos-status-wrap';
        const select = document.createElement('select');
        IMPEDIMENT_STATUS_OPTIONS.forEach(opt => {
          const option = document.createElement('option');
          option.value = opt.value;
          option.textContent = opt.label;
          if(item.status === opt.value){ option.selected = true; }
          select.appendChild(option);
        });
        select.addEventListener('change', ()=>{
          item.status = select.value;
          tr.dataset.status = item.status;
          updateImpedimentsSignature();
          scheduleImpedimentsPersist();
        });
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'impedimentos-remove';
        removeBtn.setAttribute('aria-label','Remover impedimento');
        removeBtn.textContent = 'Remover';
        removeBtn.addEventListener('click', ()=>{
          IMPEDIMENT_ALERTS = IMPEDIMENT_ALERTS.filter(entry => entry.id !== item.id);
          if(!IMPEDIMENT_ALERTS.length){
            IMPEDIMENT_ALERTS.push(createImpediment());
          }
          updateImpedimentsSignature();
          renderImpediments();
          scheduleImpedimentsPersist({ immediate:true });
        });
        statusWrap.appendChild(select);
        statusWrap.appendChild(removeBtn);
        statusTd.appendChild(statusWrap);
        tr.appendChild(iconTd);
        tr.appendChild(descTd);
        tr.appendChild(statusTd);
        tbody.appendChild(tr);
      });
      if(section){
        section.classList.toggle('empty', !IMPEDIMENT_ALERTS.length);
      }
      if(empty){
        empty.style.display = IMPEDIMENT_ALERTS.length ? 'none' : 'block';
      }
    }
    function sanitizeImpedimentsPayload(){
      return (Array.isArray(IMPEDIMENT_ALERTS) ? IMPEDIMENT_ALERTS : []).map(item => ({
        id: item.id,
        descricao: typeof item.descricao === 'string' ? item.descricao : '',
        status: IMPEDIMENT_STATUS_VALUES.has(item.status) ? item.status : 'pending'
      }));
    }
    async function persistImpediments(){
      const uid = auth?.currentUser?.uid;
      const payload = sanitizeImpedimentsPayload();
      USER_DATA.impediments = payload;
      if(!uid) return;
      try{
        await setDoc(doc(db,'usuarios',uid), { impediments: payload }, { merge:true });
      }catch(err){
        console.error('Erro ao salvar impedimentos', err);
        throw err;
      }
    }
    async function flushImpedimentsPersist(){
      if(impedimentsSaveTimer){
        clearTimeout(impedimentsSaveTimer);
        impedimentsSaveTimer = null;
      }
      if(impedimentsSaveInFlight){
        impedimentsSaveQueued = true;
        return;
      }
      if(!impedimentsSavePending){
        return;
      }
      impedimentsSavePending = false;
      impedimentsSaveInFlight = true;
      try{
        await persistImpediments();
      }finally{
        impedimentsSaveInFlight = false;
        if(impedimentsSaveQueued){
          impedimentsSaveQueued = false;
          scheduleImpedimentsPersist({ immediate:true });
        }
      }
    }
    function scheduleImpedimentsPersist({ immediate=false }={}){
      impedimentsSavePending = true;
      if(impedimentsSaveTimer){
        clearTimeout(impedimentsSaveTimer);
        impedimentsSaveTimer = null;
      }
      if(immediate){
        flushImpedimentsPersist();
        return;
      }
      impedimentsSaveTimer = setTimeout(()=>{ flushImpedimentsPersist(); }, IMPEDIMENTS_SAVE_DEBOUNCE_MS);
    }
    const DEMANDAS_AUTO_RENDER_DELAY = 600;
    const DEMANDAS_TYPING_GRACE_MS = 1200;
    const DEMANDAS_MAX_BLOCK_MS = 8000;
    let demandasRenderTimer = null;
    let demandasRenderPending = false;
    let lastDemandaInputTs = 0;
    let lastDemandaFocusTs = 0;
    let lastDemandaFocusTarget = null;

    function noteDemandaFocus(target){
      if(target){
        lastDemandaFocusTarget = target;
        lastDemandaFocusTs = Date.now();
      }else{
        lastDemandaFocusTarget = null;
        lastDemandaFocusTs = 0;
        maybeApplyPendingDemandasSnapshot();
      }
    }

    function noteDemandaActivity(target){
      lastDemandaInputTs = Date.now();
      if(target){
        noteDemandaFocus(target);
      }
    }

    function isDemandasEditing(){
      const active = document.activeElement;
      if(!active || !active.closest || !active.closest('#demandasBody')) return false;
      const isTextField = !!(active.matches && active.matches('input[type="text"], input[type="search"], textarea'));
      const isEditable = !!active.isContentEditable;
      if(!isTextField && !isEditable) return false;
      const now = Date.now();
      if(active === lastDemandaFocusTarget){
        if(now - lastDemandaInputTs <= DEMANDAS_TYPING_GRACE_MS) return true;
        if(now - lastDemandaFocusTs <= DEMANDAS_MAX_BLOCK_MS) return true;
      }
      if(isEditable || isTextField){
        return now - lastDemandaInputTs <= DEMANDAS_TYPING_GRACE_MS;
      }
      return false;
    }

    function requestRenderDemandas({ immediate=false, force=false }={}){
      if(demandasRenderTimer){
        clearTimeout(demandasRenderTimer);
        demandasRenderTimer = null;
      }
      if(immediate){
        if(!force && isDemandasEditing()){
          demandasRenderPending = true;
          demandasRenderTimer = setTimeout(()=> requestRenderDemandas({ immediate:true, force }), DEMANDAS_AUTO_RENDER_DELAY);
          return;
        }
        demandasRenderPending = false;
        renderDemandas({ force:true });
        return;
      }
      demandasRenderPending = true;
      demandasRenderTimer = setTimeout(()=> requestRenderDemandas({ immediate:true, force }), DEMANDAS_AUTO_RENDER_DELAY);
    }

    function performDemandasRender(){
      const tbody=$('demandasBody');
      if(!tbody) return;
      renderDemandaMonthButtons();
      const search=($('demandaSearch').value||'').toLowerCase();
      const statusFilterEl=$('demandaStatusColumnFilter');
      const tagFilterEl=$('demandaTagColumnFilter');
      const objetivoFilterEl=$('demandaObjetivoFilter');
      const responsavelFilterEl=$('demandaResponsavelFilter');
      const periodoInicioEl=$('demandaPeriodoInicioFilter');
      const periodoFimEl=$('demandaPeriodoFimFilter');
      const fStatus=statusFilterEl?statusFilterEl.value||'':'';
      const fTag=tagFilterEl?tagFilterEl.value||'':'';
      const fObjetivo=objetivoFilterEl?(objetivoFilterEl.value||'').toLowerCase().trim():'';
      const fResponsavel=responsavelFilterEl?responsavelFilterEl.value||'':'';
      const fPeriodoInicio=periodoInicioEl?parseFilterDate(periodoInicioEl.value,false):null;
      const fPeriodoFim=periodoFimEl?parseFilterDate(periodoFimEl.value,true):null;
      const fMonth=selectedDemandaMonth;
      tbody.innerHTML='';
      const source=Array.isArray(DEMANDAS)?DEMANDAS:[];
      const filtered=source.filter(d=>{
        const sMatch=!search||(d.demanda||'').toLowerCase().includes(search);
        const stMatch=!fStatus||d.status===fStatus;
        const tagMatch=!fTag||d.tag===fTag;
        const objetivoMatch=!fObjetivo||(d.demanda||'').toLowerCase().includes(fObjetivo);
        const respMatch=!fResponsavel||(d.responsavel||'')===fResponsavel;
        const demandMonths=getDemandMonthKeys(d);
        const mMatch=!fMonth || !demandMonths.length || demandMonths.includes(fMonth);
        let periodoMatch=true;
        if(fPeriodoInicio||fPeriodoFim){
          const rangeStart=getDemandaStartDate(d)||getDemandaEndDate(d);
          const rangeEnd=getDemandaEndDate(d)||rangeStart;
          if(!rangeStart||!rangeEnd){
            periodoMatch=false;
          }else{
            if(fPeriodoInicio&&rangeEnd.getTime()<fPeriodoInicio.getTime()) periodoMatch=false;
            if(fPeriodoFim&&rangeStart.getTime()>fPeriodoFim.getTime()) periodoMatch=false;
          }
        }
        return sMatch&&stMatch&&tagMatch&&objetivoMatch&&respMatch&&mMatch&&periodoMatch;
      });
      const sorted=filtered.slice().sort((a,b)=>{
        const aMeta=getDemandaSortMeta(a);
        const bMeta=getDemandaSortMeta(b);
        if(aMeta.startMs!==bMeta.startMs) return aMeta.startMs-bMeta.startMs;
        if(aMeta.endMs!==bMeta.endMs) return aMeta.endMs-bMeta.endMs;
        return (a.demanda||'').localeCompare(b.demanda||'', 'pt-BR');
      });
      sorted.forEach(d=>{
        normalizeDemanda(d);
        tbody.appendChild(createDemandaRow(d));
      });
      updatePrazoAlert();
      renderDemandaPlans();
      if(typeof renderCalendarDays === 'function'){
        try{ renderCalendarDays(); }catch(_err){}
      }
    }

    function renderDemandas(eventOrOptions){
      const options = (eventOrOptions instanceof Event || eventOrOptions === undefined) ? {} : eventOrOptions || {};
      if(options.force){
        performDemandasRender();
        return;
      }
      if(isDemandasEditing()){
        requestRenderDemandas({ immediate:true });
        return;
      }
      performDemandasRender();
    }
    
    function createDemandaRow(d){ normalizeDemanda(d); const tr=document.createElement('tr'); tr.dataset.id=d.id; tr.innerHTML=`
        <td class="col-status" data-label="Status"><select><option value=""></option>${STATUS_OPTIONS.map(o=>`<option value="${o.value}" ${d.status===o.value?"selected":""}>${o.label}</option>`).join('')}</select></td>
        <td class="col-tag" data-label="Tag"><select><option value=""></option>${TAG_OPTIONS.map(t=>`<option value="${t}" ${d.tag===t?"selected":""}>${t}</option>`).join('')}</select></td>
        <td class="col-demanda" data-label="Demanda"><input type="text" value="${d.demanda||''}"></td>
        <td class="col-resp" data-label="Respons√°vel"><select><option value=""></option>${RESP_OPTIONS.map(r=>`<option value="${r}" ${d.responsavel===r?"selected":""}>${r}</option>`).join('')}</select></td>
        <td class="col-prazo" data-label="Per√≠odo">
          <div class="periodo-field${d.prazoFim?' range-active':''}">
            <input type="datetime-local" class="periodo-inicio" value="${d.prazo||''}">
            <span class="periodo-sep">at√©</span>
            <input type="datetime-local" class="periodo-fim" value="${d.prazoFim||''}">
            <button type="button" class="periodo-toggle">${d.prazoFim?'Remover intervalo':'Adicionar intervalo'}</button>
          </div>
        </td>
        <td class="del-cell" data-label="Remover"><button>‚úï</button></td>`;
      const statusSel=tr.children[0].querySelector('select');
      const tagSel=tr.children[1].querySelector('select');
      const demandaInput=tr.children[2].querySelector('input');
      const respSel=tr.children[3].querySelector('select');
      const periodoWrap=tr.children[4].querySelector('.periodo-field');
      const inicioInput=periodoWrap.querySelector('.periodo-inicio');
      const fimInput=periodoWrap.querySelector('.periodo-fim');
      const toggleBtn=periodoWrap.querySelector('.periodo-toggle');
      const sepEl=periodoWrap.querySelector('.periodo-sep');
      let rangeEnabled=periodoWrap.classList.contains('range-active');
      const rangeActive=()=>rangeEnabled;
      const syncRangeUI=()=>{
        periodoWrap.classList.toggle('range-active',rangeEnabled);
        toggleBtn.textContent=rangeEnabled?'Remover intervalo':'Adicionar intervalo';
        fimInput.style.display=rangeEnabled?'':'none';
        sepEl.style.display=rangeEnabled?'':'none';
      };
      syncRangeUI();
      function update(field,val){
        d[field]=val;
        if(field==='prazoFim' && val && !rangeEnabled){
          rangeEnabled=true;
        }
        if(field==='prazoFim'){
          syncRangeUI();
        }
        markDemandaEdited(d,tr);
        try{ refreshMacroInsights(); }catch(_){ }
        scheduleDemandasPersist();
        updatePrazoAlert();
        renderDemandaPlans();
        renderDemandaMonthButtons();
        if(['demanda','responsavel','prazo','prazoFim','status'].includes(field)){
          if(typeof renderCalendarDays === 'function'){
            try{ renderCalendarDays(); }catch(_err){}
          }
        }
      }
      statusSel.onchange=()=>{
        update('status',statusSel.value); applyStatusColor(tr,d.status);
        sendWebhook('demandas', { demandas: [d] });
      };
      tagSel.onchange=()=>update('tag',tagSel.value);
      demandaInput.addEventListener('input', ()=>{ update('demanda',demandaInput.value); });
      demandaInput.addEventListener('blur', ()=>{ flushDemandasPersist(); });
      respSel.onchange=()=>update('responsavel',respSel.value);
      inicioInput.onchange=()=>{
        update('prazo',inicioInput.value);
      };
      fimInput.onchange=()=>{
        update('prazoFim',fimInput.value);
      };
      toggleBtn.onclick=()=>{
        if(rangeActive()){
          fimInput.value='';
          update('prazoFim','');
          rangeEnabled=false;
        }else{
          rangeEnabled=true;
          update('prazoFim',fimInput.value);
        }
        syncRangeUI();
      };
      tr.querySelector('.del-cell button').onclick=()=>{ if(confirm('Remover linha?')){ DEMANDAS=DEMANDAS.filter(x=>x.id!==d.id); scheduleDemandasPersist({ immediate:true }); renderDemandas(); } };
      applyStatusColor(tr,d.status);
      return tr; }

    document.addEventListener('focusin',event=>{
      const target=event?.target;
      if(target && typeof target.closest==='function' && target.closest('#demandasBody')){
        noteDemandaFocus(target);
      }
    },true);
    document.addEventListener('focusout',event=>{
      const target=event?.target;
      if(!target || typeof target.closest!=='function') return;
      if(!target.closest('#demandasBody')) return;
      const related=event.relatedTarget;
      if(related && typeof related.closest==='function' && related.closest('#demandasBody')){
        return;
      }
      noteDemandaFocus(null);
      if(demandasRenderPending){
        requestRenderDemandas({ immediate:true, force:true });
      }
    },true);
    document.addEventListener('input',event=>{
      const target=event?.target;
      if(target && typeof target.closest==='function' && target.closest('#demandasBody')){
        noteDemandaActivity(target);
      }
    },true);
    document.addEventListener('keydown',event=>{
      const target=event?.target;
      if(target && typeof target.closest==='function' && target.closest('#demandasBody')){
        noteDemandaActivity(target);
        if(event.key==='Enter' && !event.shiftKey){
          const isTextInput = typeof target.matches==='function' && target.matches('input[type="text"], input[type="search"], textarea');
          const isEditable = !!target.isContentEditable;
          if(isTextInput && !isEditable){
            scheduleDemandasPersist({ immediate:true });
          }
        }
      }
    },true);
    document.addEventListener('visibilitychange',()=>{
      if(document.visibilityState==='hidden'){
        noteDemandaFocus(null);
        flushDemandasPersist();
        flushImpedimentsPersist();
      }
    });

    const demandaSearchEl=$('demandaSearch');
    if(demandaSearchEl){ demandaSearchEl.addEventListener('input', renderDemandas); }
    const demandaStatusColumnEl=$('demandaStatusColumnFilter');
    if(demandaStatusColumnEl){ demandaStatusColumnEl.addEventListener('change', renderDemandas); }
    const demandaTagColumnEl=$('demandaTagColumnFilter');
    if(demandaTagColumnEl){ demandaTagColumnEl.addEventListener('change', renderDemandas); }
    const demandaObjetivoFilterEl=$('demandaObjetivoFilter');
    if(demandaObjetivoFilterEl){ demandaObjetivoFilterEl.addEventListener('input', renderDemandas); }
    const demandaResponsavelFilterEl=$('demandaResponsavelFilter');
    if(demandaResponsavelFilterEl){ demandaResponsavelFilterEl.addEventListener('change', renderDemandas); }
    const demandaPeriodoInicioFilterEl=$('demandaPeriodoInicioFilter');
    if(demandaPeriodoInicioFilterEl){ demandaPeriodoInicioFilterEl.addEventListener('change', renderDemandas); }
    const demandaPeriodoFimFilterEl=$('demandaPeriodoFimFilter');
    if(demandaPeriodoFimFilterEl){ demandaPeriodoFimFilterEl.addEventListener('change', renderDemandas); }
    const addImpedimentoBtn=$('addImpedimento');
    if(addImpedimentoBtn){
      addImpedimentoBtn.addEventListener('click', ()=>{
        IMPEDIMENT_ALERTS.push(createImpediment());
        updateImpedimentsSignature();
        renderImpediments();
        scheduleImpedimentsPersist();
      });
    }
    renderImpediments();
    updateImpedimentsSignature();
    const demandaFilterClearBtn=$('demandaFilterClear');
    if(demandaFilterClearBtn){
      demandaFilterClearBtn.addEventListener('click', ()=>{
        if(demandaStatusColumnEl) demandaStatusColumnEl.value='';
        if(demandaTagColumnEl) demandaTagColumnEl.value='';
        if(demandaObjetivoFilterEl) demandaObjetivoFilterEl.value='';
        if(demandaResponsavelFilterEl) demandaResponsavelFilterEl.value='';
        if(demandaPeriodoInicioFilterEl) demandaPeriodoInicioFilterEl.value='';
        if(demandaPeriodoFimFilterEl) demandaPeriodoFimFilterEl.value='';
        renderDemandas();
      });
    }
    const demandaObjectiveAIButton=$('demandaObjectiveAIButton');
    if(demandaObjectiveAIButton){
      demandaObjectiveAIButton.addEventListener('click', ()=>{ generateObjectivePlansWithAI(demandaObjectiveAIButton); });
    }
    const addDemandaBtn=$('addDemanda');
    if(addDemandaBtn){
      addDemandaBtn.addEventListener('click', ()=>{ DEMANDAS.push(createDemanda()); scheduleDemandasPersist({ immediate:true }); renderDemandas(); });
    }
    /* ========= auth & boot ========= */
    function clearAuthTraces(){
      try{
        const keys=[];
        for(let i=0;i<localStorage.length;i++){
          const k=localStorage.key(i);
          if(k && k.startsWith("mg_")) keys.push(k);
        }
        keys.forEach(k=> localStorage.removeItem(k));
      }catch(_){ }
    }
    function showLoading(){ const el=document.getElementById('loadingScreen'); if(el) el.style.display='flex'; }
    function hideLoading(){ const el=document.getElementById('loadingScreen'); if(el) el.style.display='none'; }
    $("loginGoogle").onclick = async ()=>{
      await signOut(auth).catch(()=>{});
      clearAuthTraces();
      showLoading();
      try{
        statusBox.textContent="";
        await signInWithPopup(auth, provider);
      }catch(e){
        statusBox.textContent=e.message;
      }
      hideLoading();
    };
    $("loginEmail").onclick  = async ()=>{
      await signOut(auth).catch(()=>{});
      clearAuthTraces();
      showLoading();
      try{
        statusBox.textContent="";
        await signInWithEmailAndPassword(auth, $("email").value.trim(), $("password").value.trim());
      }catch(e){
        statusBox.textContent=e.message;
      }
      hideLoading();
    };
    $("signupEmail").onclick = async ()=>{
      await signOut(auth).catch(()=>{});
      clearAuthTraces();
      showLoading();
      try{
        statusBox.textContent="";
        await createUserWithEmailAndPassword(auth, $("email").value.trim(), $("password").value.trim());
      }catch(e){
        statusBox.textContent=e.message;
      }
      hideLoading();
    };
    $("forgotPassword").onclick = ()=> sendPasswordResetEmail(auth, $("email").value.trim()).then(()=> statusBox.textContent="E-mail de redefini√ß√£o enviado!").catch(e=> statusBox.textContent=e.message);
    const togglePassword=$("togglePassword"), pwd=$("password"); const setVisible=(v)=>{ pwd.type=v?"text":"password"; togglePassword.textContent=v?"üôà":"üëÅ"; };
    togglePassword.addEventListener("click",()=>setVisible(pwd.type==="password"));
    // === LOGOUT ===
    $("logoutBtn").onclick = async () => {
      const btn = $("logoutBtn");
      try{
        btn.textContent = "Saindo...";
        btn.disabled = true;
        await signOut(auth);
        clearAuthTraces();
        statusBox.textContent = "Voc√™ saiu da conta.";
        location.reload();
      }catch(e){
        alert(e.message||String(e));
        btn.textContent = "Sair";
        btn.disabled = false;
      }
    };

      onAuthStateChanged(auth, async (user)=>{
        if(user){
          const tenantFromEmail = (user.email||'').split('@')[0].toLowerCase();
          if(tenantFromEmail){
            TENANT = tenantFromEmail;
            window.TENANT = tenantFromEmail;
            try{ document.documentElement.dataset.tenant = tenantFromEmail; document.body.setAttribute('data-client-id', tenantFromEmail); }catch(_){}
          }
          resetStorageUsageState({ loading: true });
          authArea.style.display="none"; authArea.setAttribute("aria-hidden","true");
          userArea.style.display="block"; userArea.setAttribute("aria-hidden","false");
          if(refreshBtn) refreshBtn.style.display = "block";
          if(notificationWidgetWrap) notificationWidgetWrap.style.display = "flex";
          if(noteWidget) noteWidget.style.display = "flex";
          notificationSeenMap = loadNotificationSeen();
          notificationAckCounters = loadNotificationCounters();
          try{ scheduleNotificationRefresh({ immediate: true }); }
          catch(_err){ }
          $("userInfo").textContent=`Logado como: ${user.displayName||user.email} ‚Ä¢ Cliente: ${TENANT}`;
          const ref = doc(db,"usuarios",user.uid);
          const snap=await getDoc(ref); USER_DATA=snap.exists()?snap.data():{}; syncStorageLimitFromProfile(); loadBriefFromUserData();
          await loadClientProfile();
          startClientAccountsListener();
          if(!postsUnsub){
            try{ subscribePosts(); }
            catch(err){ console.error('subscribePosts', err); }
          }
          if(!STORAGE && !storageInitTried){ try{ STORAGE=getStorage(app); }catch(_){ } storageInitTried=true; }
          renderDashboard(USER_DATA); buildTabs(); initTabKeyNav();
          loadNotesFromUserData();
          loadNoteTemplatesFromUserData();
          loadAccessesFromUserData();
          loadCACFromUserData();
          loadDemandasFromUserData();
          loadTrafficMetricsFromUserData();
          loadTrafficOptimizationsFromUserData();
          loadTrafficOptimizationHistoryFromUserData();
          loadTrafficCampaignIdeasFromUserData();
          loadImpedimentsFromUserData();
          loadMetasFromUserData();
          loadMetaPanelsFromUserData();
          loadSocialLinksFromUserData();
          loadIAChatsFromUserData();
          await loadIADocs();
          await loadRefSocial();
          renderRefSocial();
          await refreshStorageUsage();
          renderDemandas();
          renderImpediments();
          renderMetas();
          renderSocialIcons();
          renderIAChatList();
          renderIADocsList();
          updateIADocsStatus();
          rerenderBySection();
          triggerMacroAutoOpen();
          invalidateIAContextCache();
          try{
            await fetchClientDataSnapshot(true);
          }catch(err){
            console.warn('IA context preload', err);
          }
          if(userDocUnsub) userDocUnsub();
          userDocUnsub = onSnapshot(ref, snap=>{
            const data = snap.data() || {};
            const signatures = computeDemandSnapshotSignatures(data.demandas, data.demandaMonthPlans);
            const remoteChanged = signatures.demandas !== lastRemoteDemandasSignature || signatures.plans !== lastRemoteDemandaPlansSignature;
            const matchesLocalState = signatures.demandas === lastDemandasSignature && signatures.plans === lastDemandaPlansSignature;
            USER_DATA = data;
            syncStorageLimitFromProfile();
            loadNoteTemplatesFromUserData();
            if(remoteChanged){
              if(matchesLocalState){
                pendingDemandasSnapshot = null;
                lastDemandasSignature = signatures.demandas;
                lastDemandaPlansSignature = signatures.plans;
                lastRemoteDemandasSignature = signatures.demandas;
                lastRemoteDemandaPlansSignature = signatures.plans;
              }else if(shouldDeferDemandasSnapshot()){
                queuePendingDemandasSnapshot({ data, signatures, matchesLocalState });
              }else{
                pendingDemandasSnapshot = null;
                loadDemandasFromUserData();
                requestRenderDemandas();
                lastRemoteDemandasSignature = signatures.demandas;
                lastRemoteDemandaPlansSignature = signatures.plans;
              }
            }
            const remoteImpediments = Array.isArray(data?.impediments) ? data.impediments : [];
            const remoteImpedimentsSignature = computeImpedimentsSignature(remoteImpediments);
            if(remoteImpedimentsSignature !== lastRemoteImpedimentsSignature){
              if(remoteImpedimentsSignature === lastImpedimentsSignature){
                lastRemoteImpedimentsSignature = remoteImpedimentsSignature;
              }else{
                applyImpedimentsFromSource(remoteImpediments, { fromRemote:true });
                renderImpediments();
              }
            }
            loadMetasFromUserData();
            loadMetaPanelsFromUserData();
            handleRemoteTrafficOptimizations(data?.trafegoOptimizations);
            handleRemoteTrafficOptimizationHistory(data?.trafegoOptimizationHistory);
            handleRemoteTrafficCampaignIdeas(data?.trafegoCampaignIdeas);
            handleRemoteTrafficMetrics(data?.trafegoMetrics);
            loadCACFromUserData();
            renderMetas();
            if(renderCAC.refresh) renderCAC.refresh();
            invalidateIAContextCache();
            triggerMacroAutoOpen();
          });
        }else{
          stopClientAccountsListener();
          if(userDocUnsub){ userDocUnsub(); userDocUnsub=null; }
          if(clientDocUnsub){ try{ clientDocUnsub(); }catch(_e){} clientDocUnsub=null; }
          if(metasFormUnsub){ try{ metasFormUnsub(); }catch(_e){} metasFormUnsub=null; }
          metasFormAppliedVersions = {};
          try{ if(postsUnsub){ postsUnsub(); } }
          catch(_e){}
          postsUnsub = null;
          POSTS = [];
          try{ refreshMacroInsights({ immediate: true }); }
          catch(_e){}
          authArea.style.display="flex"; authArea.setAttribute("aria-hidden","false");
          userArea.style.display="none"; userArea.setAttribute("aria-hidden","true");
          if(refreshBtn) refreshBtn.style.display = "none";
          if(notificationWidgetWrap) notificationWidgetWrap.style.display = "none";
          if(noteWidget){
            noteWidget.style.display = "none";
            const noteTab = document.getElementById('noteTab');
            noteTab?.classList.remove('show');
          }
          notificationSeenMap = loadNotificationSeen();
          notificationAckCounters = loadNotificationCounters();
          applyNotificationData({ items: [], countersSnapshot: {} });
          NOTE_TEMPLATES = [];
          refreshNoteTemplateOptions();
          DEMANDAS = [];
          DEMANDA_MONTH_PLANS = {};
          lastDemandasSignature = '';
          lastDemandaPlansSignature = '';
          lastRemoteDemandasSignature = '';
          lastRemoteDemandaPlansSignature = '';
          TRAFEGO_CAMPAIGN_IDEAS = [];
          TRAFEGO_OPTIMIZATIONS = [];
          TRAFEGO_OPTIMIZATIONS_LAST_SAVED = [];
          TRAFEGO_OPTIMIZATION_HISTORY = [];
          TRAFEGO_METRICS = [];
          trafficCampaignLocalSignature = '';
          trafficCampaignSavedSignature = '';
          trafficCampaignRemoteSignature = '';
          trafficOptimizationLocalSignature = '';
          trafficOptimizationSavedSignature = '';
          trafficOptimizationRemoteSignature = '';
          trafficHistoryLocalSignature = '';
          trafficHistorySavedSignature = '';
          trafficHistoryRemoteSignature = '';
          trafficMetricsLocalSignature = '';
          trafficMetricsSavedSignature = '';
          trafficMetricsRemoteSignature = '';
          pendingTrafficCampaignSnapshot = null;
          pendingTrafficOptimizationSnapshot = null;
          pendingTrafficOptimizationHistorySnapshot = null;
          pendingTrafficMetricsSnapshot = null;
          if(trafegoOptimizationSaveTimer){
            clearTimeout(trafegoOptimizationSaveTimer);
            trafegoOptimizationSaveTimer = null;
          }
          trafegoOptimizationSavePending = false;
          trafegoOptimizationSaveInFlight = false;
          trafegoOptimizationSaveQueued = false;
          if(trafegoHistorySaveTimer){
            clearTimeout(trafegoHistorySaveTimer);
            trafegoHistorySaveTimer = null;
          }
          trafegoHistorySavePending = false;
          trafegoHistorySaveInFlight = false;
          trafegoHistorySaveQueued = false;
          if(trafegoMetricsSaveTimer){
            clearTimeout(trafegoMetricsSaveTimer);
            trafegoMetricsSaveTimer = null;
          }
          trafegoMetricsSavePending = false;
          trafegoMetricsSaveInFlight = false;
          trafegoMetricsSaveQueued = false;
          if(trafegoCampaignStatusFilter) trafegoCampaignStatusFilter.value = 'all';
          if(trafegoCampaignSearch) trafegoCampaignSearch.value = '';
          if(trafegoOptimizationPlatformFilter) trafegoOptimizationPlatformFilter.value = 'all';
          if(trafegoOptimizationRecurrenceFilter) trafegoOptimizationRecurrenceFilter.value = 'all';
          if(trafegoOptimizationSearch) trafegoOptimizationSearch.value = '';
          if(trafegoHistoryPlatformFilter) trafegoHistoryPlatformFilter.value = 'all';
          if(trafegoHistorySearch) trafegoHistorySearch.value = '';
          renderTrafficOptimizations();
          renderTrafficOptimizationHistory();
          renderTrafficCampaignIdeas();
          renderTrafficMetrics();
          applyImpedimentsFromSource([], { fromRemote:true });
          renderImpediments();
          updateImpedimentsSignature();
          SOCIAL_LINKS = {};
          renderSocialIcons();
          CLIENT_PROFILE = {};
          clientDocPathParts = null;
          profileLogoUploading = false;
          updateProfileAvatar();
          resetStorageUsageState({ loading: false });
          IA_CHATS = []; CURRENT_CHAT = null;
          IA_DOCS = [];
          IA_DOCS_PENDING = [];
          renderIAChatList();
          renderIAHistory();
          renderIADocsList();
          updateIADocsStatus();
          invalidateIAContextCache();
          macroAutoOpenPending = true;
          clearMacroTabBadge();
        }
      });


    /* ========= CALEND√ÅRIO / POSTS (Firestore + Storage) ========= */
    const calWeekdays = $("calWeekdays"), calDays = $("calDays"), calTitle = $("calTitle");
    const googleCalendarConnectBtn = $("googleCalendarConnect"), googleCalendarDisconnectBtn = $("googleCalendarDisconnect"), googleCalendarStatus = $("googleCalendarStatus");
    if(window.googleCalendarIntegration){
      window.googleCalendarIntegration.setDomRefs({
        connectBtn: googleCalendarConnectBtn,
        disconnectBtn: googleCalendarDisconnectBtn,
        statusEl: googleCalendarStatus
      });
      if(typeof window.googleCalendarIntegration.ensureConnected === 'function'){
        window.googleCalendarIntegration.ensureConnected();
      }
    }
    const calPrev = $("calPrev"), calNext = $("calNext"), calUpload = $("calUpload"), btnShareCalendar = $("btnShareCalendar");
    const calDate = $("calDate"), calDesc = $("calDesc"), calFiles = $("calFiles"), calTarget = $("calTarget"), calFilterStatus = $("calFilterStatus"), calFilterCountry = $("calFilterCountry"), calFilterText = $("calFilterText");
      const feedGrid = $("feedGrid"), storiesGrid = $("storiesGrid"), storiesPrev = $("storiesPrev"), storiesNext = $("storiesNext");
    const postModal = $("postModal"), modalClose = $("modalClose"), modalTitle = $("modalTitle"), modalPreview = $("modalPreview"), modalDate = $("modalDate"), modalStatus = $("modalStatus"), modalDesc = $("modalDesc"), modalTarget = $("modalTarget");
      const btnApprove = $("btnApprove"), btnApproveInternal = $("btnApproveInternal"), btnReview = $("btnReview"), btnCopyApprovalLink = $("btnCopyApprovalLink"), btnSave = $("btnSave"), btnDelete = $("btnDelete");

      if(storiesPrev && storiesGrid) storiesPrev.onclick = () => storiesGrid.scrollBy({left:-100, behavior:'smooth'});
      if(storiesNext && storiesGrid) storiesNext.onclick = () => storiesGrid.scrollBy({left:100, behavior:'smooth'});

      let STORAGE = null;
    let POSTS = []; // {id,dateISO,desc,mediaUrls:[...],thumbUrl,type,status,target,createdAt}
    let coverInput = null;
    let coverUploading = false;

    function ensureCoverInput(){
      if(coverInput) return coverInput;
      coverInput = document.createElement('input');
      coverInput.type = 'file';
      coverInput.accept = 'image/*';
      coverInput.style.display = 'none';
      coverInput.id = 'coverUploadInput';
      document.body.appendChild(coverInput);
      coverInput.addEventListener('change', ()=>{
        const file = coverInput.files?.[0] || null;
        const postId = coverInput.getAttribute('data-post-id');
        coverInput.value = '';
        coverInput.removeAttribute('data-post-id');
        if(file && postId){ uploadCoverImage(postId, file); }
      });
      return coverInput;
    }

    function promptCoverUpload(postId){
      if(!postId) return;
      const input = ensureCoverInput();
      input.setAttribute('data-post-id', postId);
      input.click();
    }

    async function uploadCoverImage(postId, file){
      if(!file) return;
      if(coverUploading) return;
      try{
        if(!(file.type||'').toLowerCase().startsWith('image/')){
          alert('Selecione uma imagem para a capa.');
          return;
        }
        const uid = auth.currentUser?.uid;
        if(!uid){
          alert('Fa√ßa login para enviar a capa.');
          return;
        }
        const post = POSTS.find(p=>p.id===postId);
        if(!post){
          alert('Post n√£o encontrado.');
          return;
        }
        const safeTenant = (typeof TENANT!=="undefined" && TENANT) ? TENANT : null;
        if(!safeTenant || safeTenant === 'no-client'){
          alert('Cliente n√£o definido na URL.');
          return;
        }
        if(!STORAGE){
          try{ STORAGE = getStorage(app); }
          catch(err){ console.error(err); alert('Storage n√£o inicializado.'); return; }
        }
        coverUploading = true;
        const safeName = (file.name||'cover').replace(/[^a-zA-Z0-9._-]/g,'_');
        const path = `users/${uid}/tenant-${safeTenant}/posts/${postId}/cover_${Date.now()}_${safeName}`;
        const ref = sRef(STORAGE, path);
        await uploadBytes(ref, file);
        const url = await getDownloadURL(ref);
        const coverSize = Number(file?.size);
        const coverMeta = {
          path,
          size: Number.isFinite(coverSize) && coverSize > 0 ? coverSize : null,
          contentType: file?.type || ''
        };
        await updateDoc(doc(db, 'usuarios', uid, 'posts', postId), {
          thumbUrl: url,
          coverMeta,
          updatedAt: serverTimestamp()
        });
        post.thumbUrl = url;
        post.coverMeta = coverMeta;
        if(selectedPost && selectedPost.id===postId){
          selectedPost.thumbUrl = url;
          selectedPost.coverMeta = coverMeta;
        }
        if(typeof mgToast === 'function'){
          mgToast('Capa atualizada!');
        }
        renderCalendarDays();
        renderPlanilha();
        await refreshStorageUsage();
      }catch(err){
        console.error('uploadCoverImage', err);
        alert('Falha ao enviar capa: ' + (err?.message || String(err)));
      }finally{
        coverUploading = false;
      }
    }
    let postsUnsub = null;
    let currentMonth = (()=>{ const d=new Date(); return new Date(d.getFullYear(), d.getMonth(), 1); })();
    let selectedPost = null;
    const COMMEMORATIVE_DATES_BR = window.COMMEMORATIVE_DATES_BR || {};
    const COMMEMORATIVE_DATES_US = window.COMMEMORATIVE_DATES_US || {};
    let CAL_NOTES = {};
    let calNotesUnsub = null;
// === Estado do carrossel (aprova√ß√£o slide a slide) ===
let SLIDE_IDX = 0;
let SLIDES = []; // array de URLs da m√≠dia do post
let APPROVED_CLIENT_SET = new Set(); // √≠ndices aprovados pelo cliente
let APPROVED_INTERNAL_SET = new Set(); // √≠ndices aprovados pelo time interno
let REVIEWED_SET = new Set();  // √≠ndices revisados (carregados de Firestore)

    function normalizeRole(value){
      const v = (value||"").toString().toLowerCase();
      return v === 'cliente' || v === 'interno' ? v : '';
    }
    function guessOriginFromEmail(email){
      const lower = (email||'').toLowerCase();
      if(lower.includes('mediagrowth')) return 'interno';
      return lower ? 'cliente' : '';
    }
    function getPortalRoleFromContext(){
      const attrRole = normalizeRole(document.body?.getAttribute('data-portal-role'));
      if(attrRole) return attrRole;
      if(typeof window.MG_PORTAL_ROLE === 'string'){
        const fromGlobal = normalizeRole(window.MG_PORTAL_ROLE);
        if(fromGlobal) return fromGlobal;
      }
      try{
        const qs = new URLSearchParams(location.search||'');
        const qsRole = normalizeRole(qs.get('portalRole') || qs.get('role'));
        if(qsRole) return qsRole;
      }catch(_){ /* ignore */ }
      const host = (location.hostname||'').toLowerCase();
      if(host.includes('cliente') || host.includes('client')) return 'cliente';
      return '';
    }
    function getCurrentReviewOrigin(){
      const contextual = getPortalRoleFromContext();
      if(contextual) return contextual;
      const emailOrigin = guessOriginFromEmail(auth?.currentUser?.email || '');
      return emailOrigin || 'interno';
    }
    function resolveReviewOrigin(note){
      if(note && typeof note.origin === 'string'){
        const normalized = normalizeRole(note.origin);
        if(normalized) return normalized;
      }
      const fromEmail = guessOriginFromEmail(note?.by || '');
      return fromEmail || 'cliente';
    }


    function ensureCalendar(){
      if(!STORAGE){ try{ STORAGE = getStorage(app); }catch(_){ /* ignore */ } }
      if(!postsUnsub){ subscribePosts(); }
      if(!calNotesUnsub){ subscribeCalNotes(); }
      renderCalendarStatic();
      renderCalendarDays();
      renderPlanilha();
    }

    function monthLabel(d){
      const names = ["janeiro","fevereiro","mar√ßo","abril","maio","junho","julho","agosto","setembro","outubro","novembro","dezembro"];
      return `${names[d.getMonth()].slice(0,1).toUpperCase()}${names[d.getMonth()].slice(1)} ${d.getFullYear()}`;
    }
    function localDateISO(d){
      const z = new Date(d.getTime() - d.getTimezoneOffset()*60000);
      return z.toISOString().slice(0,10);
    }
    function daysInMonth(year, month){ return new Date(year, month+1, 0).getDate(); }

    function renderCalendarStatic(){
      if(!calWeekdays) return;
      calWeekdays.innerHTML = ["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"].map((w, idx)=>`<div class="cal-weekday${(idx===0||idx===6)?' weekend':''}">${w}</div>`).join("");
      calPrev.onclick = ()=>{ currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()-1, 1); renderCalendarDays(); };
      calNext.onclick = ()=>{ currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth()+1, 1); renderCalendarDays(); };
      calFilterStatus.onchange = ()=>{ renderCalendarDays(); renderPlanilha(); };
      calFilterCountry.onchange = ()=>{ renderCalendarDays(); };
      calFilterText.oninput = ()=>{ renderCalendarDays(); };
    // === Fun√ß√µes de gera√ß√£o de thumbnail de v√≠deo (se√ß√£o 2) ===
    // Fun√ß√µes duplicadas aqui porque o c√≥digo est√° em duas se√ß√µes
    if(typeof VIDEO_THUMBNAILS_CACHE === "undefined") var VIDEO_THUMBNAILS_CACHE = new Map();
    if(typeof generateVideoThumbnail === "undefined") {
      window.generateVideoThumbnail = async function(videoUrl, postId) {
        console.log("[GenerateThumbnail] Iniciando para:", videoUrl);
        if (VIDEO_THUMBNAILS_CACHE.has(videoUrl)) { console.log("[GenerateThumbnail] Retornando do cache"); return VIDEO_THUMBNAILS_CACHE.get(videoUrl); }
        return new Promise((resolve, reject) => {
          const video = document.createElement("video"); video.crossOrigin = "anonymous"; video.preload = "metadata"; video.muted = true; video.playsInline = true;
          console.log("[GenerateThumbnail] Video element criado");
          const timeout = setTimeout(() => { console.error("[GenerateThumbnail] Timeout"); video.src = ""; reject(new Error("Timeout")); }, 10000);
          video.onloadedmetadata = () => { console.log("[GenerateThumbnail] Metadata carregada, dura√ß√£o:", video.duration); const seekTime = Math.min(0.5, video.duration * 0.1); video.currentTime = seekTime; console.log("[GenerateThumbnail] Buscando frame em:", seekTime, "s"); };
          video.onseeked = () => { console.log("[GenerateThumbnail] Frame encontrado, capturando..."); try { clearTimeout(timeout); const canvas = document.createElement("canvas"); canvas.width = video.videoWidth || 640; canvas.height = video.videoHeight || 360; const ctx = canvas.getContext("2d"); ctx.drawImage(video, 0, 0, canvas.width, canvas.height); const thumbnailDataUrl = canvas.toDataURL("image/jpeg", 0.7); console.log("[GenerateThumbnail] Thumbnail gerada, tamanho:", thumbnailDataUrl.length, "bytes"); VIDEO_THUMBNAILS_CACHE.set(videoUrl, thumbnailDataUrl); video.src = ""; resolve(thumbnailDataUrl); } catch (err) { clearTimeout(timeout); console.error("[GenerateThumbnail] Erro ao capturar:", err); reject(err); } };
          video.onerror = (err) => { clearTimeout(timeout); console.error("[GenerateThumbnail] Erro ao carregar:", err, video.error); video.src = ""; reject(err); };
          console.log("[GenerateThumbnail] Carregando URL:", videoUrl); video.src = videoUrl;
        });
      };
    }
    if(typeof applyVideoThumbnails === "undefined") {
      window.applyVideoThumbnails = function() {
        const videoContainers = document.querySelectorAll(".cal-thumb[data-video-url], .feed-item[data-video-url], .story-item[data-video-url], .relatorio-story-item[data-video-url]");
        console.log("[Thumbnails] Encontrados", videoContainers.length, "v√≠deos para processar");
        videoContainers.forEach(async (container) => {
          const videoUrl = container.getAttribute("data-video-url"); const postId = container.getAttribute("data-id");
          if (!videoUrl) { console.log("[Thumbnails] Container sem videoUrl:", container); return; }
          if (container.querySelector("img")) { console.log("[Thumbnails] J√° tem thumbnail:", videoUrl); return; }
          console.log("[Thumbnails] Gerando thumbnail para:", videoUrl);
          try { const thumbnailUrl = await window.generateVideoThumbnail(videoUrl, postId); console.log("[Thumbnails] Gerada:", thumbnailUrl.substring(0, 50) + "...");
            if (container.getAttribute("data-video-url") === videoUrl) { const img = document.createElement("img"); img.src = thumbnailUrl; img.alt = "Video preview"; img.crossOrigin = "anonymous"; img.style.width = "100%"; img.style.height = "100%"; img.style.objectFit = "cover"; const span = container.querySelector("span"); if (span) span.remove(); container.appendChild(img); console.log("[Thumbnails] Thumbnail aplicada"); }
          } catch (err) { console.error("[Thumbnails] Falha:", videoUrl, err); }
        });
      };
    }

    }

    function postsByDateMap(){
      const map = new Map();
      const filt = (calFilterStatus?.value||"").trim();
      POSTS.forEach(p=>{
        if(filt && p.status !== filt) return;
        const list = map.get(p.dateISO) || [];
        list.push(p); map.set(p.dateISO, list);
      });
      return map;
    }

    function renderCalendarDays(){
      console.log("[Calendar] renderCalendarDays() chamado");
      if(!calDays) return;
      calTitle.textContent = monthLabel(currentMonth);
      const y = currentMonth.getFullYear(), m = currentMonth.getMonth();
      const monthKey = buildMonthKey(y, m+1);
      const todayISO = localDateISO(new Date());
      const firstDay = new Date(y, m, 1);
      const startWeekday = (firstDay.getDay() + 7) % 7; // 0=Sun
      const totalDays = daysInMonth(y,m);
      const prevPad = startWeekday;
      const totalCells = Math.ceil((prevPad + totalDays) / 7) * 7;

      const map = postsByDateMap();
      const demandaMap = new Map();
      if(Array.isArray(DEMANDAS)){
        DEMANDAS.forEach(d=>{
          normalizeDemanda(d);
          const entries = getDemandaCalendarEntries(d);
          entries.forEach(entry=>{
            if(!entry?.dateKey) return;
            const list = demandaMap.get(entry.dateKey) || [];
            list.push(entry);
            demandaMap.set(entry.dateKey, list);
          });
        });
        demandaMap.forEach(list=>{
          list.sort((a,b)=>{
            const diff = getDemandaEntryTime(a) - getDemandaEntryTime(b);
            if(diff !== 0) return diff;
            const nameA = (a?.demanda?.demanda || '').toLowerCase();
            const nameB = (b?.demanda?.demanda || '').toLowerCase();
            return nameA.localeCompare(nameB);
          });
        });
      }
      const esc = s => s.replace(/[&<>]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
      const cells = [];
      const country = (calFilterCountry?.value||"").trim();
      const textFilter = (calFilterText?.value||"").trim().toLowerCase();
      for(let i=0;i<totalCells;i++){
        const dayNum = i - prevPad + 1;
        const inMonth = dayNum>=1 && dayNum<=totalDays;
        const weekday = i % 7;
        const isWeekend = weekday === 0 || weekday === 6;
        const date = inMonth ? new Date(y,m,dayNum) : null;
        const iso = inMonth ? localDateISO(date) : "";
        const isToday = iso === todayISO;
        const items = inMonth ? (map.get(iso) || []) : [];
        const demandas = inMonth ? (demandaMap.get(iso) || []) : [];
        let holidays = [];
        if(inMonth && country){
          if(country === 'BR') holidays = COMMEMORATIVE_DATES_BR[iso] || [];
          else if(country === 'US') holidays = COMMEMORATIVE_DATES_US[iso] || [];
          if(textFilter) holidays = holidays.filter(h=>h.toLowerCase().includes(textFilter));
        }
        const cellClasses = ['cal-cell'];
        if(isWeekend) cellClasses.push('weekend');
        if(inMonth){
          if(isToday) cellClasses.push('today');
        }else{
          cellClasses.push('out');
        }
        const holidayHtml = holidays.map(h=>`<div>${esc(h)}</div>`).join("");
        const thumbs = items.map(post => {
          let cls = "cal-thumb";
          if(post.status === "aprovado"){
            cls += post.approvedBy === 'interno' ? " aprovado-interno" : " aprovado";
          }else if(post.status === "revisar"){
            cls += " revisar";
          }
          const first = (post.thumbUrl || post.mediaUrls?.[0] || "");
          const ext = first.split("?")[0].split(".").pop().toLowerCase();
          const isVideo = ["mp4","mov","webm","m4v","avi"].includes(ext);
          const label = post.type==="carousel" ? "C" : (isVideo ? "V" : "");
          if(first){
            if(isVideo){
              // Se j√° tem thumbUrl personalizada (capa), usa ela
              if(post.thumbUrl && !post.thumbUrl.includes('.mp4') && !post.thumbUrl.includes('.mov') && !post.thumbUrl.includes('.webm')) {
                return `<div class="${cls}" data-id="${post.id}" title="${(post.desc||'').replace(/"/g,'&quot;')}"><img src="${post.thumbUrl}" alt="" crossorigin="anonymous"></div>`;
              }
              // Sen√£o, renderiza com data-video-url para gerar thumbnail autom√°tica
              return `<div class="${cls}" data-id="${post.id}" data-video-url="${first}" title="${(post.desc||'').replace(/"/g,'&quot;')}"><span>${label||"V"}</span></div>`;
            }else{
              return `<div class="${cls}" data-id="${post.id}" title="${(post.desc||'').replace(/"/g,'&quot;')}"><img src="${first}" alt="" crossorigin="anonymous"></div>`;
            }
          }else{
            return `<div class="${cls}" data-id="${post.id}" title="${(post.desc||'').replace(/"/g,'&quot;')}"><span>${label||"+"}</span></div>`;
          }
        }).join("");

        const demandasHtml = inMonth ? renderCalendarDemandaItems(demandas, esc, textFilter) : '';
        const note = inMonth ? esc(CAL_NOTES[iso] || '') : '';
        cells.push(`
          <div class="${cellClasses.join(' ')}" data-iso="${iso}">
            ${inMonth?`<div class="daynum">${dayNum}</div>`:''}
            ${holidayHtml?`<div class="cal-holidays">${holidayHtml}</div>`:''}
            <div class="cal-items">${thumbs}</div>
            ${demandasHtml}
            ${inMonth?`<textarea class="cal-note">${note}</textarea>`:''}
          </div>`);
      }
      calDays.innerHTML = cells.join("");
      renderCalendarMobileDemandas(demandaMap, esc, textFilter, monthKey);
      calDays.querySelectorAll('.cal-note').forEach(el=>{
        const iso = el.closest('.cal-cell')?.getAttribute('data-iso');
        el.value = CAL_NOTES[iso] || '';
        const h = ()=> saveCalNote(el);
        el.addEventListener('change', h);
        el.addEventListener('blur', h);
      });

      // Bind clicks
      calDays.querySelectorAll(".cal-thumb").forEach(el=>{
        el.addEventListener("click",()=>{
          const id = el.getAttribute("data-id");
          const post = POSTS.find(p=>p.id===id);
          if(post) openPostModal(post);
        });
      });

      // Gera thumbnails autom√°ticas para v√≠deos
      console.log('[Calendar] Agendando applyVideoThumbnails em 100ms');
      setTimeout(() => {
        console.log('[Calendar] Executando applyVideoThumbnails agora');
        applyVideoThumbnails();
      }, 100);
    }

    function renderPlanilha(){
      if(!feedGrid && !storiesGrid) return;
      let items = [...POSTS];
      const filt = (calFilterStatus?.value||"").trim();
      if(filt){ items = items.filter(p=>p.status===filt); }
      items.sort((a,b)=> (a.dateISO<b.dateISO?1:a.dateISO>b.dateISO?-1: (b.updatedAt||0)-(a.updatedAt||0)));

      const feedItems = items.filter(p=> (p.target||"feed") !== "stories");
      if(feedGrid){
        feedGrid.innerHTML = feedItems.map(p=>{
          const first = p.thumbUrl || p.mediaUrls?.[0] || "";
          const ext = first.split("?")[0].split(".").pop().toLowerCase();
          const isVideo = ["mp4","mov","webm","m4v","avi"].includes(ext);
          const label = p.type==="carousel" ? "C" : (isVideo ? "V" : "");
          const showCoverBtn = (p.type === 'video');
          const coverBtn = showCoverBtn ? `<button class="cover-upload-btn" type="button" data-id="${p.id}">üì∑ Capa</button>` : "";
          let cls = "feed-item";
          if(p.status === "aprovado"){
            cls += p.approvedBy === 'interno' ? " aprovado-interno" : " aprovado";
          }else if(p.status === "revisar"){
            cls += " revisar";
          }else{
            cls += " pendente";
          }
          if(first){
            if(isVideo){
              // Se j√° tem thumbUrl personalizada (capa), usa ela
              if(p.thumbUrl && !p.thumbUrl.includes('.mp4') && !p.thumbUrl.includes('.mov') && !p.thumbUrl.includes('.webm')) {
                return `<div class="${cls}" data-id="${p.id}">${coverBtn}<img src="${p.thumbUrl}" alt="" crossorigin="anonymous"></div>`;
              }
              // Sen√£o, renderiza com data-video-url para gerar thumbnail autom√°tica
              return `<div class="${cls}" data-id="${p.id}" data-video-url="${first}">${coverBtn}<span>${label||"V"}</span></div>`;
            }else{
              return `<div class="${cls}" data-id="${p.id}">${coverBtn}<img src="${first}" alt="" crossorigin="anonymous"></div>`;
            }
          }else{
            return `<div class="${cls}" data-id="${p.id}">${coverBtn}<span>${label||"+"}</span></div>`;
          }
        }).join("");
        feedGrid.querySelectorAll(".feed-item").forEach(el=>{
          el.addEventListener("click",()=>{
            const id = el.getAttribute("data-id");
            const post = POSTS.find(p=>p.id===id);
            if(post) openPostModal(post);
          });
        });
        feedGrid.querySelectorAll('.cover-upload-btn').forEach(btn=>{
          if(btn.dataset.coverBound === '1') return;
          btn.dataset.coverBound = '1';
          btn.addEventListener('click', ev=>{
            ev.stopPropagation();
            const id = btn.getAttribute('data-id');
            if(id) promptCoverUpload(id);
          });
        });
      }

      if(storiesGrid){
        const storyItems = items.filter(p=> (p.target||"feed") === "stories");
        storiesGrid.innerHTML = storyItems.map(p=>{
          const first = p.thumbUrl || p.mediaUrls?.[0] || "";
          const ext = first.split("?")[0].split(".").pop().toLowerCase();
          const isVideo = ["mp4","mov","webm","m4v","avi"].includes(ext);
          const label = p.type==="carousel" ? "C" : (isVideo ? "V" : "");
          const showCoverBtn = (p.type === 'video');
          const coverBtn = showCoverBtn ? `<button class="cover-upload-btn" type="button" data-id="${p.id}">üì∑ Capa</button>` : "";
          let cls = "story-item";
          if(p.status === "aprovado"){
            cls += p.approvedBy === 'interno' ? " aprovado-interno" : " aprovado";
          }else if(p.status === "revisar"){
            cls += " revisar";
          }else{
            cls += " pendente";
          }
          const [y,m,d] = (p.dateISO||'').split('-');
          const dateLabel = d && m ? `${d}/${m}` : '';
          if(first){
            if(isVideo){
              // Se j√° tem thumbUrl personalizada (capa), usa ela
              if(p.thumbUrl && !p.thumbUrl.includes('.mp4') && !p.thumbUrl.includes('.mov') && !p.thumbUrl.includes('.webm')) {
                return `<div class="${cls}" data-id="${p.id}">${coverBtn}<img src="${p.thumbUrl}" alt="" crossorigin="anonymous"><div class="story-date">${dateLabel}</div></div>`;
              }
              // Sen√£o, renderiza com data-video-url para gerar thumbnail autom√°tica
              return `<div class="${cls}" data-id="${p.id}" data-video-url="${first}">${coverBtn}<span>${label||"V"}</span><div class="story-date">${dateLabel}</div></div>`;
            }else{
              return `<div class="${cls}" data-id="${p.id}">${coverBtn}<img src="${first}" alt="" crossorigin="anonymous"><div class="story-date">${dateLabel}</div></div>`;
            }
          }else{
            return `<div class="${cls}" data-id="${p.id}">${coverBtn}<span>${label||"+"}</span><div class="story-date">${dateLabel}</div></div>`;
          }
        }).join("");
        storiesGrid.querySelectorAll(".story-item").forEach(el=>{
          el.addEventListener("click",()=>{
            const id = el.getAttribute("data-id");
            const post = POSTS.find(p=>p.id===id);
            if(post) openPostModal(post);
          });
        });
        storiesGrid.querySelectorAll('.cover-upload-btn').forEach(btn=>{
          if(btn.dataset.coverBound === '1') return;
          btn.dataset.coverBound = '1';
          btn.addEventListener('click', ev=>{
            ev.stopPropagation();
            const id = btn.getAttribute('data-id');
            if(id) promptCoverUpload(id);
          });
        });
      }
    }

      // Gera thumbnails autom√°ticas para v√≠deos no feed e stories
      setTimeout(() => { if(typeof applyVideoThumbnails !== "undefined") applyVideoThumbnails(); else if(typeof window.applyVideoThumbnails !== "undefined") window.applyVideoThumbnails(); }, 150);

    async function saveCalNote(el){
      const iso = el.closest('.cal-cell')?.getAttribute('data-iso');
      const uid = auth.currentUser?.uid;
      if(!iso || !uid) return;
      const clientKey = (typeof window.TENANT === 'string' && window.TENANT)
        || document.body.getAttribute('data-client-id');
      if (!clientKey || clientKey === 'no-client') {
        console.warn('Cliente n√£o definido na URL.');
        return;
      }
      const note = el.value.trim();
      const ref = doc(db, 'usuarios', uid, 'clients', clientKey, 'calendarNotes', iso);
      try{
        if(note){
          await setDoc(ref, { note, updatedAt: Date.now() }, { merge:true });
        }else{
          await deleteDoc(ref);
        }
      }catch(err){ console.error('saveCalNote', err); }
    }

    function subscribeCalNotes(){
      const uid = auth.currentUser?.uid;
      if(!uid) return;
      const clientKey = (typeof window.TENANT === 'string' && window.TENANT)
        || document.body.getAttribute('data-client-id');
      if (!clientKey || clientKey === 'no-client') {
        console.warn('Cliente n√£o definido na URL.');
        return;
      }
      try{ calNotesUnsub && calNotesUnsub(); }catch(_){ }
      const col = collection(db, 'usuarios', uid, 'clients', clientKey, 'calendarNotes');
      calNotesUnsub = onSnapshot(col, snap=>{
        CAL_NOTES = {};
        snap.forEach(docSnap=>{
          const d = docSnap.data() || {};
          if(d.note) CAL_NOTES[docSnap.id] = d.note;
        });
        renderCalendarDays();
        refreshStorageUsage();
      }, err=> console.error('onSnapshot calNotes', err));
    }

    function subscribePosts(){
      const uid = auth.currentUser?.uid; if(!uid) return;
      try{ postsUnsub && postsUnsub(); }catch(_){}
      const col = collection(db, "usuarios", uid, "posts");
      const qy = query(col, orderBy("dateISO","asc")); // sem √≠ndice composto
      postsUnsub = onSnapshot(qy, snap=>{
        POSTS = [];
        snap.forEach(docSnap => {
          const d = docSnap.data() || {};
          POSTS.push({
            id: docSnap.id,
            dateISO: d.dateISO||"",
            desc: d.desc||"",
            mediaUrls: d.mediaUrls||[],
            thumbUrl: d.thumbUrl||"",
            type: d.type||"",
            status: d.status||"pendente",
            target: d.target||"feed",
            reviewNotes: d.reviewNotes||[],
            approvedSlides: d.approvedSlides||[],
            internalApprovedSlides: d.internalApprovedSlides||[],
            approvedBy: d.approvedBy||"",
            createdAt: d.createdAt?.toMillis?.()||0,
            updatedAt: d.updatedAt?.toMillis?.()||0,
            mediaMeta: Array.isArray(d.mediaMeta) ? d.mediaMeta : [],
            coverMeta: d.coverMeta && typeof d.coverMeta === 'object' ? d.coverMeta : null,
            tenant: d.tenant || '',
            googleEventId: d.googleEventId || ''
          });
        });
        renderCalendarDays();
        renderPlanilha();
        refreshStorageUsage();
        try{ refreshMacroInsights(); }catch(_){ }
        if(window.googleCalendarIntegration){
          window.googleCalendarIntegration.notifyPostsLoaded(POSTS);
        }
      }, err=> console.error("onSnapshot posts", err));
    }

    async function handleUpload(){
      const btn = calUpload;
      try{
        const uid = auth.currentUser?.uid; if(!uid) return alert("Fa√ßa login.");
        const dateISO = (calDate.value||"").trim() || localDateISO(new Date());
        const desc = (calDesc.value||"").trim();
        const target = (calTarget.value||"feed");
        const files = calFiles.files;
        if(!files || files.length===0) return alert("Selecione ao menos 1 m√≠dia.");

        // whitelist de formatos
        const okExt = ["jpg","jpeg","png","mp4","mov"];
        for(let i=0;i<files.length;i++){
          const f = files[i];
          const ext = (f.name.split(".").pop()||"").toLowerCase();
          const mime = (f.type||"").toLowerCase();
          const isImage = mime.startsWith("image/");
          const isVideo = mime.startsWith("video/");
          if(!okExt.includes(ext) || (!isImage && !isVideo)){
            return alert("Formato n√£o suportado. Use JPG, JPEG, PNG, MP4 ou MOV.");
          }
        }

        if(!db) return alert("Banco de dados n√£o inicializado.");
        if(!STORAGE){ try{ STORAGE = getStorage(app); }catch(e){ console.error(e); return alert("Storage n√£o inicializado."); } }

        btn && (btn.disabled=true, btn.textContent="Enviando...");
        const safeTenant = (typeof TENANT!=="undefined" && TENANT) ? TENANT : null;
        if (!safeTenant || safeTenant === 'no-client') {
          console.warn('Cliente n√£o definido na URL.');
          btn && (btn.disabled=false, btn.textContent='Enviar');
          return;
        }
        const col = collection(db, "usuarios", uid, "posts");
        const newRef = await addDoc(col, { dateISO, desc, mediaUrls: [], thumbUrl: "", type: files.length>1 ? "carousel" : guessType(files[0]?.name||""), status: "pendente", target, createdAt: serverTimestamp(), updatedAt: serverTimestamp(), tenant: safeTenant });

        const urls = [];
        const mediaMeta = [];
        let thumb = "";
        for(let i=0;i<files.length;i++){
          const f = files[i];
          const safe = (f.name||'file').replace(/[^a-zA-Z0-9._-]/g,'_');
          const path = `users/${uid}/tenant-${safeTenant}/posts/${newRef.id}/${Date.now()}_${safe}`;
          const r = sRef(STORAGE, path);
          await uploadBytes(r, f);
          const url = await getDownloadURL(r);
          urls.push(url);
          const sizeValue = Number(f?.size);
          mediaMeta.push({
            path,
            size: Number.isFinite(sizeValue) && sizeValue > 0 ? sizeValue : null,
            contentType: f?.type || ''
          });
          if(!thumb) thumb = url;
        }
        await updateDoc(newRef, { mediaUrls: urls, thumbUrl: thumb, mediaMeta, updatedAt: serverTimestamp() });
        if(window.googleCalendarIntegration){
          const newPost = {
            id: newRef.id,
            dateISO,
            desc,
            target,
            status: 'pendente',
            googleEventId: '',
            tenant: safeTenant
          };
          try{ await window.googleCalendarIntegration.handlePostCreated(newPost); }
          catch(err){ console.warn('googleCalendarIntegration.handlePostCreated', err); }
        }
        sendWebhook('calendar', { action:'upload', id: newRef.id, dateISO, desc, target, mediaUrls: urls, thumbUrl: thumb });
        calFiles.value=""; calDesc.value=""; if(calTarget) calTarget.value="feed";
        alert("Post cadastrado!");
        await refreshStorageUsage();
      }catch(e){
        console.error("upload error", e);
        const msg = (e && (e.message||e.code)) ? (e.message||e.code) : String(e);
        alert("Falha no upload: "+ msg);
      }finally{
        btn && (btn.disabled=false, btn.textContent="Enviar");
      }
    }
    function guessType(name){
      const ext = (name.split(".").pop()||"").toLowerCase();
      if(["mp4","mov","webm","m4v","avi"].includes(ext)) return "video";
      return "image";
    }

    function openPostModal(post){
      selectedPost = post;
      SLIDES = Array.isArray(post.mediaUrls) && post.mediaUrls.length ? post.mediaUrls.slice() : [post.thumbUrl || (post.mediaUrls?.[0]||"")];
      SLIDE_IDX = 0;
      APPROVED_CLIENT_SET = new Set(Array.isArray(post.approvedSlides)? post.approvedSlides : []);
      APPROVED_INTERNAL_SET = new Set(Array.isArray(post.internalApprovedSlides)? post.internalApprovedSlides : []);
      REVIEWED_SET = new Set(Array.isArray(post.reviewedSlides)? post.reviewedSlides : (Array.isArray(post.reviewNotes)? post.reviewNotes.map(n=> Number.isInteger(n.slide)? n.slide : null).filter(n=> Number.isInteger(n)) : []));
      selectedPost.approvedSlides = Array.from(APPROVED_CLIENT_SET);
      selectedPost.internalApprovedSlides = Array.from(APPROVED_INTERNAL_SET);

      modalTitle.textContent = post.desc ? (post.desc.slice(0,60)+(post.desc.length>60?"‚Ä¶":"")) : "Post";
      modalDate.textContent = post.dateISO || "";
      modalDesc.value = post.desc || "";
      setModalStatus(post.status||"pendente");

      function renderSlide(){
        const url = SLIDES[SLIDE_IDX] || "";
        const ext = (url.split("?")[0].split(".").pop()||"").toLowerCase();
        const isVideo = ["mp4","mov","webm","m4v","avi"].includes(ext);
        const hasMany = SLIDES.length > 1;
        let arrows = hasMany ? `<div class="pv-arrow left" id="pvLeft">‚Äπ</div><div class="pv-arrow right" id="pvRight">‚Ä∫</div>` : "";
        const approvals = [];
        if(APPROVED_CLIENT_SET.has(SLIDE_IDX)) approvals.push('cliente');
        if(APPROVED_INTERNAL_SET.has(SLIDE_IDX)) approvals.push('time interno');
        const approvalInfo = approvals.length ? `‚úîÔ∏è aprovado (${approvals.join(' + ')})` : '';
        modalPreview.innerHTML = `<div class="pv-stage"><div class="pv-media">${isVideo?`<video src="${url}" controls playsinline crossorigin="anonymous"></video>`:`<img src="${url}" alt="" crossorigin="anonymous">`}</div>${arrows}</div><div class=\"muted\" style=\"margin-top:6px;display:flex;justify-content:space-between\"><span>Item ${SLIDE_IDX+1}/${SLIDES.length}</span><span>${approvalInfo}</span></div>`;
        modalPreview.classList.toggle('pv-has-many', hasMany);
        // render historic only on first slide
        const cn = document.getElementById('clientNotesList');
        if(cn){ if(SLIDE_IDX===0){ cn.style.display='block'; renderClientNotesInCard(selectedPost); } else { cn.style.display='none'; } }
        // bind arrows
        const L = document.getElementById("pvLeft"), R = document.getElementById("pvRight");
        if(L) L.onclick = ()=>{ SLIDE_IDX = (SLIDE_IDX>0? SLIDE_IDX-1 : 0); renderSlide(); syncApproveButtons(); };
        if(R) R.onclick = ()=>{ SLIDE_IDX = (SLIDE_IDX<SLIDES.length-1? SLIDE_IDX+1 : SLIDE_IDX); renderSlide(); syncApproveButtons(); };
        syncApproveButtons();
      }

      function syncApproveButtons(){
        const total = SLIDES.length;
        if(btnApprove){
          const aprovados = APPROVED_CLIENT_SET.size;
          if(APPROVED_CLIENT_SET.has(SLIDE_IDX)){
            btnApprove.textContent = `Cliente aprovou (${aprovados}/${total})`;
            btnApprove.disabled = true;
          }else{
            const nextCount = aprovados + 1;
            const lastPending = (nextCount===total);
            btnApprove.textContent = lastPending? `Cliente aprovar e finalizar (${nextCount}/${total})` : `Cliente aprovar (${nextCount}/${total})`;
            btnApprove.disabled = false;
          }
        }
        if(btnApproveInternal){
          const aprovadosInternos = APPROVED_INTERNAL_SET.size;
          const internalComplete = ((aprovadosInternos >= total) && total>0) || selectedPost?.approvedBy === 'interno';
          if(APPROVED_INTERNAL_SET.has(SLIDE_IDX)){
            btnApproveInternal.textContent = `Time interno aprovou (${aprovadosInternos}/${total})`;
            btnApproveInternal.disabled = true;
          }else{
            const nextInternal = aprovadosInternos + 1;
            const lastInternal = (nextInternal===total);
            btnApproveInternal.textContent = lastInternal? `Aprova√ß√£o interna e finalizar (${nextInternal}/${total})` : `Aprova√ß√£o interna (${nextInternal}/${total})`;
            btnApproveInternal.disabled = false;
          }
          btnApproveInternal.classList.toggle('btn-interno-concluido', internalComplete);
        }
      }

      // exp√µe helpers dentro do escopo
      openPostModal._renderSlide = renderSlide;
      openPostModal._syncApproveButtons = syncApproveButtons;

      renderSlide();
      postModal.classList.add("show"); postModal.setAttribute("aria-hidden","false");
      renderReviewNotes(post);
      renderClientNotesPanel(post);
    }
    function closePostModal(){ postModal.classList.remove("show"); postModal.setAttribute("aria-hidden","true"); selectedPost=null; }
    modalClose.onclick = closePostModal;
    postModal.addEventListener("click",(e)=>{ if(e.target===postModal) closePostModal(); });

    function setModalStatus(s){
      modalStatus.textContent = s;
      const approvedBy = selectedPost?.approvedBy || "";
      const statusClass = s === "aprovado"
        ? (approvedBy === "interno" ? "status-aprovado-interno" : "status-aprovado")
        : (s === "revisar" ? "status-revisar" : "status-pendente");
      modalStatus.className = "status-pill " + statusClass;
    }

    async function updatePostStatus(post, status){
      try{
        const uid = auth.currentUser?.uid; if(!uid) return;
        const ref = doc(db, "usuarios", uid, "posts", post.id);
        await updateDoc(ref, { status, updatedAt: serverTimestamp() });
        if(status === 'aprovado' || status === 'revisar'){
          const payload = { action:'status', id: post.id, status };
          if(status === 'revisar'){
            payload.dateISO = post.dateISO || '';
            payload.postName = post.desc || '';
            payload.postDesc = post.desc || '';
            payload.reviewNotes = Array.isArray(post.reviewNotes) ? post.reviewNotes.map(n => n.text) : [];
          }
          sendWebhook('calendar', payload);
        }
        post.status = status;
        if(selectedPost && selectedPost.id===post.id){ setModalStatus(status); }
        if(window.googleCalendarIntegration){
          try{ await window.googleCalendarIntegration.handlePostUpdated(post); }
          catch(err){ console.warn('googleCalendarIntegration.handlePostUpdated', err); }
        }
      }catch(e){ console.error(e); alert("Falha ao atualizar status: "+(e.message||String(e))); }
    }
    async function savePostMeta(post, desc, target){
      try{
        const uid = auth.currentUser?.uid; if(!uid) return;
        const ref = doc(db, "usuarios", uid, "posts", post.id);
        await updateDoc(ref, { desc: desc||"", target: target||"feed", updatedAt: serverTimestamp() });
        post.desc = desc||"";
        post.target = target||"feed";
        if(window.googleCalendarIntegration){
          try{ await window.googleCalendarIntegration.handlePostUpdated(post); }
          catch(err){ console.warn('googleCalendarIntegration.handlePostUpdated', err); }
        }
      }catch(e){ console.error(e); alert("Falha ao salvar: "+(e.message||String(e))); }
    }
    async function deletePost(post){
      if(!confirm("Excluir este post?")) return;
      try{
        const uid = auth.currentUser?.uid; if(!uid) return;
        const ref = doc(db, "usuarios", uid, "posts", post.id);
        if(window.googleCalendarIntegration){
          try{ await window.googleCalendarIntegration.handlePostDeleted(post); }
          catch(err){ console.warn('googleCalendarIntegration.handlePostDeleted', err); }
        }
        await deleteDoc(ref);
        if(selectedPost?.id===post.id) closePostModal();
      }catch(e){ console.error(e); alert("Falha ao excluir: "+(e.message||String(e))); }
    }

    async function approveSlide(kind){
      if(!selectedPost) return;
      try{
        const uid = auth.currentUser?.uid; if(!uid) return;
        const ref = doc(db, "usuarios", uid, "posts", selectedPost.id);
        const payload = { updatedAt: serverTimestamp() };
        const isInternal = kind === 'interno';
        if(isInternal){
          payload.internalApprovedSlides = arrayUnion(SLIDE_IDX);
        }else{
          payload.approvedSlides = arrayUnion(SLIDE_IDX);
        }
        await updateDoc(ref, payload);

        const targetSet = isInternal ? APPROVED_INTERNAL_SET : APPROVED_CLIENT_SET;
        targetSet.add(SLIDE_IDX);
        if(isInternal){
          selectedPost.internalApprovedSlides = Array.from(targetSet);
        }else{
          selectedPost.approvedSlides = Array.from(targetSet);
        }

        const totalSlides = SLIDES.length;
        const fullyApproved = (APPROVED_CLIENT_SET.size >= totalSlides) || (APPROVED_INTERNAL_SET.size >= totalSlides);
        if(fullyApproved){
          await updateDoc(ref, { status: "aprovado", updatedAt: serverTimestamp(), approvedBy: isInternal ? 'interno' : 'cliente' });
          selectedPost.status = "aprovado";
          selectedPost.approvedBy = isInternal ? 'interno' : 'cliente';
          sendWebhook('calendar', { action:'status', id: selectedPost.id, status: 'aprovado', approvedBy: isInternal ? 'interno' : 'cliente' });
          setModalStatus("aprovado");
          if(window.googleCalendarIntegration){
            try{ await window.googleCalendarIntegration.handlePostUpdated(selectedPost); }
            catch(err){ console.warn('googleCalendarIntegration.handlePostUpdated', err); }
          }
          if(typeof mgToast === 'function'){
            mgToast(isInternal ? 'Post aprovado pelo time interno.' : 'Post aprovado pelo cliente.');
          }
        }else{
          // avan√ßa para o pr√≥ximo slide n√£o aprovado dentro do contexto atual
          let next = SLIDE_IDX;
          for(let i=0;i<SLIDES.length;i++){
            const j = (SLIDE_IDX + 1 + i) % SLIDES.length;
            if(!targetSet.has(j)){ next = j; break; }
          }
          SLIDE_IDX = next;
        }
        if(typeof openPostModal._renderSlide === "function"){ openPostModal._renderSlide(); }
        if(typeof openPostModal._syncApproveButtons === "function"){ openPostModal._syncApproveButtons(); }
      }catch(e){
        console.error(e);
        alert("Falha ao aprovar: " + (e.message||String(e)));
      }
    }
    if(btnApprove) btnApprove.onclick = ()=> approveSlide('cliente');
    if(btnApproveInternal) btnApproveInternal.onclick = ()=> approveSlide('interno');

    async function generateCalendarShare(){
      const btn = btnShareCalendar;
      if(!db){
        alert('Banco de dados n√£o inicializado.');
        return;
      }
      if(btn){
        btn.disabled = true;
        btn.textContent = 'Gerando link...';
      }
      try {
        if(!auth?.currentUser){
          throw new Error('Fa√ßa login para compartilhar o calend√°rio.');
        }
        const user = auth.currentUser;
        const clientKey = getClientKey();
        if(!clientKey || clientKey === 'no-client'){
          throw new Error('Cliente n√£o identificado. Abra a plataforma usando o link do cliente.');
        }
        const safeKey = getSafeClientKey() || normalizeClientKey(clientKey);
        if(!safeKey){
          throw new Error('N√£o foi poss√≠vel determinar o identificador do cliente.');
        }
        const monthRef = (currentMonth instanceof Date) ? new Date(currentMonth.getTime()) : new Date();
        const year = monthRef.getFullYear();
        const monthIndex = monthRef.getMonth();
        const monthKey = buildMonthKey(year, monthIndex + 1);
        const safeTenantLower = safeKey.toLowerCase();
        const postsInMonth = Array.isArray(POSTS) ? POSTS.filter(p => {
          if(!p || !p.dateISO) return false;
          if(p.dateISO.slice(0,7) !== monthKey) return false;
          const tenant = (p.tenant || '').toLowerCase();
          return !tenant || tenant === safeTenantLower;
        }) : [];
        if(postsInMonth.length === 0){
          const proceed = confirm('Nenhum post cadastrado neste m√™s. Deseja mesmo gerar o link do calend√°rio?');
          if(!proceed){
            return;
          }
        }
        const token = (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : uuid();
        const timestamp = serverTimestamp();
        const postsCollectionPath = ['usuarios', user.uid, 'posts'];
        const postSummaries = postsInMonth.map(post => {
          const media = Array.isArray(post.mediaUrls) ? post.mediaUrls.filter(Boolean) : [];
          return {
            id: post.id,
            dateISO: post.dateISO || '',
            desc: post.desc || '',
            target: post.target || 'feed',
            status: post.status || 'pendente',
            approvedBy: post.approvedBy || '',
            type: post.type || '',
            thumbUrl: post.thumbUrl || '',
            mediaUrls: media.slice(0, 12),
            approvedSlides: Array.isArray(post.approvedSlides) ? post.approvedSlides : [],
            tenant: post.tenant || '',
            postDocPath: ['usuarios', user.uid, 'posts', post.id]
          };
        });
        const docRef = doc(db, 'calendarShares', token);
        const docData = {
          token,
          uid: user.uid,
          userEmail: user.email || '',
          clientKey,
          clientKeyNormalized: safeKey,
          clientLabel: formatClientDisplayName(clientKey) || clientKey,
          tenant: safeKey,
          monthKey,
          monthLabel: monthLabel(monthRef),
          monthYear: year,
          monthNumber: monthIndex + 1,
          monthStartISO: localDateISO(new Date(year, monthIndex, 1)),
          postsCollectionPath,
          postIds: postSummaries.map(p => p.id),
          postsCount: postSummaries.length,
          postSummaries,
          createdAt: timestamp,
          updatedAt: timestamp,
          lastAction: 'share-created',
          lastActionAt: timestamp
        };
        await setDoc(docRef, docData);
        const shareUrl = buildCalendarShareLink(token, safeKey, clientKey, monthKey);
        let copied = false;
        if(navigator?.clipboard?.writeText){
          try{
            await navigator.clipboard.writeText(shareUrl);
            copied = true;
          }catch(_err){ copied = false; }
        }
        if(copied){
          if(typeof mgToast === 'function'){
            mgToast('Link do calend√°rio copiado! Compartilhe com o cliente.');
          }else{
            alert('Link copiado! Compartilhe com o cliente.');
          }
        }else{
          prompt('Link do calend√°rio gerado. Copie para enviar ao cliente:', shareUrl);
        }
        sendWebhook('calendar', {
          action: 'share-link',
          token,
          monthKey,
          postsCount: postSummaries.length
        });
      }catch(err){
        console.error('generateCalendarShare', err);
        alert(err?.message || 'N√£o foi poss√≠vel gerar o link do calend√°rio.');
      }finally{
        if(btn){
          btn.disabled = false;
          btn.textContent = 'Compartilhar calend√°rio';
        }
      }
    }

    async function generatePlanningShare(){
      const btn = btnCopyPlanningLink;
      if(!db){
        alert('Banco de dados n√£o inicializado.');
        return;
      }
      if(btn){
        btn.disabled = true;
        btn.textContent = 'Gerando link...';
      }
      try {
        if(!auth?.currentUser){
          throw new Error('Fa√ßa login para compartilhar o planejamento.');
        }
        const user = auth.currentUser;
        const clientKey = getClientKey();
        if(!clientKey || clientKey === 'no-client'){
          throw new Error('Cliente n√£o identificado. Abra a plataforma usando o link do cliente.');
        }
        const safeKey = getSafeClientKey() || normalizeClientKey(clientKey);
        if(!safeKey){
          throw new Error('N√£o foi poss√≠vel determinar o identificador do cliente.');
        }
        const today = new Date();
        const year = today.getFullYear();
        const monthIndex = today.getMonth();
        const monthKey = buildMonthKey(year, monthIndex + 1);
        const monthDate = new Date(`${monthKey}-01T00:00:00`);
        const monthLabelText = monthLabel(monthDate);
        const monthStart = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
        const monthEnd = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0);
        const metaMonthKey = META_MONTHS[monthDate.getMonth()] || META_MONTHS[monthIndex];
        const plan = normalizeMonthPlan(monthKey) || {};
        const objectiveNotes = plan.objectiveNotes && typeof plan.objectiveNotes === 'object' ? plan.objectiveNotes : {};
        const statusMap = new Map(STATUS_OPTIONS.map(opt => [opt.value, opt]));
        const rawDemandas = Array.isArray(DEMANDAS) ? DEMANDAS.filter(d => getDemandMonthKeys(d).includes(monthKey)) : [];
        const monthDemandas = sortDemandasForMonth(rawDemandas);
        const toDisplayText = value => typeof value === 'string' ? htmlStringToText(value).trim() : '';
        const objectives = monthDemandas.map((d, idx) => {
          normalizeDemanda(d);
          const statusInfo = statusMap.get(d.status) || {};
          const startDate = getDemandaStartDate(d);
          const endDate = getDemandaEndDate(d);
          const startISO = startDate ? localDateISO(startDate) : '';
          const endISO = endDate ? localDateISO(endDate) : (startISO || '');
          const periodoTexto = formatPrazoLabel(d) || 'Prazo n√£o definido';
          const planDetails = [];
          PLAN_TYPES.forEach(({key, label}) => {
            const planRaw = d.planos?.[key];
            const text = planRaw ? toDisplayText(planRaw) : '';
            if(text){
              planDetails.push({ key, label, text });
            }
          });
          const noteHtml = objectiveNotes[d.id];
          const noteText = noteHtml ? toDisplayText(noteHtml) : '';
          return {
            id: d.id || `obj-${idx}`,
            order: idx + 1,
            title: (d.demanda || '').trim() || 'Objetivo sem t√≠tulo',
            tag: d.tag || '',
            responsavel: d.responsavel || 'N√£o definido',
            status: d.status || '',
            statusLabel: statusInfo.label || 'Sem status',
            statusColor: statusInfo.color || '',
            periodo: {
              inicioISO: startISO,
              fimISO: endISO,
              texto: periodoTexto
            },
            planDetails,
            note: noteText
          };
        });
        const counts = {
          total: objectives.length,
          completed: 0,
          inProgress: 0,
          blocked: 0,
          priority: 0,
          notStarted: 0
        };
        objectives.forEach(obj => {
          switch(obj.status){
            case 'concluido':
            case 'concluido-grupo':
              counts.completed += 1;
              break;
            case 'em-andamento':
              counts.inProgress += 1;
              break;
            case 'bloqueado':
              counts.blocked += 1;
              break;
            case 'prioridade':
            case 'prioridade-grupo':
              counts.priority += 1;
              break;
            case 'nao-iniciado':
              counts.notStarted += 1;
              break;
            default:
              break;
          }
        });
        const impedimentStatusMap = new Map(IMPEDIMENT_STATUS_OPTIONS.map(opt => [opt.value, opt]));
        const impediments = (Array.isArray(IMPEDIMENT_ALERTS) ? IMPEDIMENT_ALERTS : []).map(item => {
          if(!item) return null;
          const description = typeof item.descricao === 'string' ? item.descricao.trim() : '';
          const statusValue = typeof item.status === 'string' ? item.status : 'pending';
          if(!description && !statusValue){
            return null;
          }
          const statusInfo = impedimentStatusMap.get(statusValue) || impedimentStatusMap.get('pending') || { label:'Ainda n√£o resolvido' };
          const suggestion = statusValue === 'resolved'
            ? 'Monitorar para garantir que o impedimento n√£o volte a impactar as entregas.'
            : 'Acionar o respons√°vel, definir a pr√≥xima etapa e atualizar o status at√© o pr√≥ximo alinhamento.';
          return {
            id: item.id || (typeof uuid === 'function' ? uuid() : fallbackUUID()),
            descricao: description || 'Impedimento sem descri√ß√£o detalhada.',
            status: statusValue,
            statusLabel: statusInfo.label || 'Ainda n√£o resolvido',
            suggestedAction: suggestion
          };
        }).filter(Boolean);
        const timeline = [];
        const addTimelineEntry = (demanda, kind, date) => {
          if(!date) return;
          const dateISO = localDateISO(date);
          const statusInfo = statusMap.get(demanda.status) || {};
          timeline.push({
            id: `${demanda.id || demanda.demanda || dateISO}-${kind}`,
            objectiveId: demanda.id || '',
            objectiveTitle: (demanda.demanda || '').trim() || 'Objetivo sem t√≠tulo',
            kind,
            label: kind === 'start' ? 'In√≠cio' : 'Entrega',
            dateISO,
            status: demanda.status || '',
            statusLabel: statusInfo.label || '',
            responsavel: demanda.responsavel || '',
            periodo: formatPrazoLabel(demanda) || ''
          });
        };
        monthDemandas.forEach(d => {
          const start = getDemandaStartDate(d);
          const end = getDemandaEndDate(d);
          if(start){
            addTimelineEntry(d, 'start', start);
          }
          if(end && (!start || end.getTime() !== start.getTime())){
            addTimelineEntry(d, 'end', end);
          }
        });
        timeline.sort((a, b) => {
          if(a.dateISO && b.dateISO){
            const diff = a.dateISO.localeCompare(b.dateISO);
            if(diff !== 0) return diff;
          } else if(a.dateISO){
            return -1;
          } else if(b.dateISO){
            return 1;
          }
          return a.objectiveTitle.localeCompare(b.objectiveTitle);
        });
        const activeMetas = Array.isArray(METAS) ? METAS.filter(meta => meta && meta.ativo !== false) : [];
        const findMetaByTag = tag => activeMetas.find(meta => (meta.tag || '') === tag);
        const parseMetaNumber = (meta, field) => {
          if(!meta || !meta.meses) return null;
          const raw = meta.meses?.[metaMonthKey]?.[field];
          if(raw === '' || raw === undefined || raw === null) return null;
          const num = Number(raw);
          return Number.isFinite(num) ? num : null;
        };
        const currencyCode = (CAC_DATA?.currency || 'BRL').toUpperCase();
        const formatCurrencyValue = value => {
          if(!Number.isFinite(value)) return '';
          const locale = currencyCode === 'USD' ? 'en-US' : 'pt-BR';
          return new Intl.NumberFormat(locale, {
            style: 'currency',
            currency: currencyCode,
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          }).format(value);
        };
        const investmentMeta = findMetaByTag('investimento_publicidade');
        let plannedBudget = parseMetaNumber(investmentMeta, 'p');
        let actualBudget = parseMetaNumber(investmentMeta, 'r');
        let budgetSource = 'meta';
        if(!Number.isFinite(plannedBudget) && !Number.isFinite(actualBudget)){
          const expenses = CAC_DATA?.expenses?.[monthKey];
          if(Array.isArray(expenses)){
            const trafficRow = expenses.find(row => typeof row?.desc === 'string' && row.desc.toLowerCase().includes('tr√°f'));
            if(trafficRow){
              const val = Number(trafficRow.val);
              if(Number.isFinite(val)){
                plannedBudget = val;
                actualBudget = val;
                budgetSource = 'cac';
              }
            }
          }
        }
        const plannedBudgetDisplay = formatCurrencyValue(plannedBudget);
        const actualBudgetDisplay = formatCurrencyValue(actualBudget);
        const kpis = [];
        const pushMetaKpi = meta => {
          if(!meta) return;
          const targetVal = parseMetaNumber(meta, 'p');
          const currentVal = parseMetaNumber(meta, 'r');
          if(!Number.isFinite(targetVal) && !Number.isFinite(currentVal)) return;
          const unit = (meta.unidade || '').toLowerCase();
          const formatValue = value => {
            if(!Number.isFinite(value)) return '';
            if(unit === 'brl'){
              return formatCurrencyValue(value);
            }
            if(unit === '%'){
              return `${value.toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 2 })}%`;
            }
            return value.toLocaleString('pt-BR', { maximumFractionDigits: 2 });
          };
          kpis.push({
            label: meta.descricao || 'Indicador',
            unit: meta.unidade || '',
            targetValue: Number.isFinite(targetVal) ? targetVal : null,
            targetDisplay: formatValue(targetVal),
            currentValue: Number.isFinite(currentVal) ? currentVal : null,
            currentDisplay: formatValue(currentVal)
          });
        };
        pushMetaKpi(findMetaByTag('roas_publicidade'));
        pushMetaKpi(findMetaByTag('leads_gerados') || findMetaByTag('leads_novos'));
        pushMetaKpi(findMetaByTag('taxa_mql'));
        const planSections = {};
        PLAN_TYPES.forEach(({key, label}) => {
          const raw = plan?.[key];
          const text = raw ? toDisplayText(raw) : '';
          planSections[key] = { label, text };
        });
        const firstStrategicLine = planSections.estrategico?.text
          ? planSections.estrategico.text.split(/\n+/).map(line => line.trim()).find(Boolean)
          : '';
        let adsObjective = firstStrategicLine || 'Gerar demanda qualificada com campanhas de m√≠dia.';
        if(adsObjective && adsObjective.length){
          adsObjective = adsObjective.replace(/\s+/g, ' ');
        }
        const firstTimelineEntry = timeline.find(item => item.dateISO);
        const lastTimelineEntry = [...timeline].reverse().find(item => item.dateISO);
        const formatDayMonth = iso => {
          if(!iso) return '';
          const dt = new Date(`${iso}T00:00:00`);
          if(Number.isNaN(dt.getTime())) return '';
          return dt.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        };
        let scheduleText = '';
        if(firstTimelineEntry && lastTimelineEntry){
          const startLabel = formatDayMonth(firstTimelineEntry.dateISO);
          const endLabel = formatDayMonth(lastTimelineEntry.dateISO);
          if(startLabel && endLabel){
            scheduleText = startLabel === endLabel
              ? `Ativa√ß√µes concentradas em ${startLabel}.`
              : `Execu√ß√£o prevista de ${startLabel} at√© ${endLabel}.`;
          }
        }
        if(!scheduleText){
          scheduleText = 'Cronograma distribu√≠do ao longo do m√™s para manter ritmo de entregas e aprendizado cont√≠nuo.';
        }
        const googleAdsPlan = {
          objective: adsObjective,
          budget: {
            currency: currencyCode,
            plannedValue: Number.isFinite(plannedBudget) ? plannedBudget : null,
            actualValue: Number.isFinite(actualBudget) ? actualBudget : null,
            plannedDisplay: plannedBudgetDisplay,
            actualDisplay: actualBudgetDisplay,
            source: budgetSource
          },
          kpis,
          schedule: scheduleText
        };
        const buildPlanningSummary = () => {
          const parts = [];
          const total = counts.total || 0;
          if(total > 0){
            parts.push(`O planejamento de ${monthLabelText} organiza ${total} objetivo${total > 1 ? 's' : ''} priorit√°rio${total > 1 ? 's' : ''} para o m√™s.`);
          }else{
            parts.push(`Ainda n√£o h√° objetivos registrados para ${monthLabelText}. Utilize este plano para alinhar prioridades e demandas com o cliente.`);
          }
          if(counts.completed){
            parts.push(`${counts.completed} conclu√≠do${counts.completed > 1 ? 's' : ''} at√© o momento.`);
          }
          if(counts.inProgress){
            parts.push(`${counts.inProgress} em andamento com acompanhamento semanal.`);
          }
          if(counts.priority){
            parts.push(`${counts.priority} demanda${counts.priority > 1 ? 's' : ''} marcada${counts.priority > 1 ? 's' : ''} como prioridade da equipe.`);
          }
          if(counts.blocked){
            parts.push(`Aten√ß√£o a ${counts.blocked} item${counts.blocked > 1 ? 's' : ''} com bloqueios pendentes.`);
          }
          const pendingImpediments = impediments.filter(item => item.status === 'pending');
          if(pendingImpediments.length){
            const names = pendingImpediments.slice(0, 2).map(item => item.descricao).filter(Boolean);
            if(names.length){
              parts.push(`Impedimentos em aberto: ${names.join('; ')}.`);
            }
          }
          if(googleAdsPlan.objective){
            parts.push(`No Google Ads, foco em ${googleAdsPlan.objective.toLowerCase()}.`);
          }
          return parts.join(' ');
        };
        const summary = buildPlanningSummary();
        const token = (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : uuid();
        const timestamp = serverTimestamp();
        const docRef = doc(db, 'planningShares', token);
        const docData = {
          token,
          uid: user.uid,
          userEmail: user.email || '',
          clientKey,
          clientKeyNormalized: safeKey,
          clientLabel: formatClientDisplayName(clientKey) || clientKey,
          tenant: safeKey,
          monthKey,
          monthLabel: monthLabelText,
          monthYear: year,
          monthNumber: monthIndex + 1,
          monthStartISO: localDateISO(monthStart),
          monthEndISO: localDateISO(monthEnd),
          objectives,
          objectivesSummary: counts,
          impediments,
          timeline,
          planSections,
          summary,
          googleAdsPlan,
          createdAt: timestamp,
          updatedAt: timestamp,
          lastAction: 'planning-share-created',
          lastActionAt: timestamp
        };
        await setDoc(docRef, docData);
        const shareUrl = buildPlanningShareLink(token, safeKey, clientKey, monthKey);
        let copied = false;
        if(navigator?.clipboard?.writeText){
          try{
            await navigator.clipboard.writeText(shareUrl);
            copied = true;
          }catch(_err){
            copied = false;
          }
        }
        if(copied){
          if(typeof mgToast === 'function'){
            mgToast('Link do planejamento copiado! Compartilhe com o cliente.');
          }else{
            alert('Link copiado! Compartilhe com o cliente.');
          }
        }else{
          prompt('Link do planejamento gerado. Copie para enviar ao cliente:', shareUrl);
        }
        sendWebhook('demandas', {
          action: 'planning-share',
          token,
          monthKey,
          objectives: counts.total,
          impediments: impediments.length
        });
      }catch(err){
        console.error('generatePlanningShare', err);
        alert(err?.message || 'N√£o foi poss√≠vel gerar o link do planejamento.');
      }finally{
        if(btn){
          btn.disabled = false;
          btn.textContent = 'Copiar link do planejamento';
        }
      }
    }

    async function copyApprovalLinkForPost(){
      const btn = btnCopyApprovalLink;
      if(!selectedPost){
        alert('Abra um post para gerar o link de aprova√ß√£o.');
        return;
      }
      if(!auth?.currentUser){
        alert('Fa√ßa login para gerar o link de aprova√ß√£o.');
        return;
      }
      const originalLabel = btn ? btn.textContent : '';
      if(btn){
        btn.disabled = true;
        btn.textContent = 'Gerando link...';
      }
      try {
        const user = auth.currentUser;
        const clientKey = getClientKey();
        if(!clientKey || clientKey === 'no-client'){
          throw new Error('Cliente n√£o identificado. Abra a plataforma usando o link do cliente.');
        }
        const safeKey = getSafeClientKey() || normalizeClientKey(clientKey);
        const token = (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : uuid();
        const mediaList = Array.isArray(selectedPost.mediaUrls) && selectedPost.mediaUrls.length
          ? selectedPost.mediaUrls.filter(Boolean)
          : (Array.isArray(SLIDES) ? SLIDES.filter(Boolean) : []);
        const descFromModal = (modalDesc?.value || '').trim();
        const targetFromModal = (modalTarget?.value || selectedPost.target || 'feed');
        const thumbUrl = selectedPost.thumbUrl || mediaList[0] || '';
        const timestamp = serverTimestamp();
        const docData = {
          token,
          uid: user.uid,
          userEmail: user.email || '',
          clientKey,
          clientKeyNormalized: safeKey,
          clientLabel: formatClientDisplayName(clientKey) || clientKey,
          postId: selectedPost.id,
          postDocPath: ['usuarios', user.uid, 'posts', selectedPost.id],
          postDesc: descFromModal || selectedPost.desc || '',
          postTarget: targetFromModal,
          postDateISO: selectedPost.dateISO || '',
          postStatus: selectedPost.status || 'pendente',
          postApprovedBy: selectedPost.approvedBy || '',
          mediaUrls: mediaList,
          thumbUrl,
          postType: selectedPost.type || '',
          postTenant: selectedPost.tenant || safeKey || '',
          postApprovedSlides: Array.isArray(selectedPost.approvedSlides) ? selectedPost.approvedSlides : [],
          postInternalApprovedSlides: Array.isArray(selectedPost.internalApprovedSlides) ? selectedPost.internalApprovedSlides : [],
          generatedBy: {
            uid: user.uid,
            email: user.email || '',
            name: user.displayName || ''
          },
          createdAt: timestamp,
          updatedAt: timestamp,
          lastAction: 'link-created',
          lastActionAt: timestamp
        };
        if(Number.isFinite(selectedPost.createdAt)){
          docData.postCreatedAt = selectedPost.createdAt;
        }
        if(Number.isFinite(selectedPost.updatedAt)){
          docData.postUpdatedAt = selectedPost.updatedAt;
        }
        if(Array.isArray(selectedPost.reviewNotes)){
          docData.postReviewNotesCount = selectedPost.reviewNotes.length;
        }
        const docRef = doc(db, 'postApprovals', token);
        await setDoc(docRef, docData);
        const approvalUrl = buildApprovalLink(token, safeKey, clientKey);
        let copied = false;
        if(navigator?.clipboard?.writeText){
          try{
            await navigator.clipboard.writeText(approvalUrl);
            copied = true;
          }catch(_err){ copied = false; }
        }
        if(copied){
          if(typeof mgToast === 'function'){
            mgToast('Link copiado! Envie ao cliente para aprovar o post.');
          }
        }else{
          prompt('Link de aprova√ß√£o gerado. Copie e envie ao cliente:', approvalUrl);
        }
        sendWebhook('calendar', {
          action: 'approval-link',
          id: selectedPost.id,
          token,
          dateISO: selectedPost.dateISO || '',
          desc: descFromModal || selectedPost.desc || ''
        });
      }catch(err){
        console.error('copyApprovalLinkForPost', err);
        alert(err?.message || 'N√£o foi poss√≠vel gerar o link de aprova√ß√£o.');
      }finally{
        if(btn){
          btn.disabled = false;
          btn.textContent = originalLabel || 'Copiar link de aprova√ß√£o';
        }
      }
    }

    if(btnReview)  btnReview.onclick  = ()=>{ if(selectedPost) openReviewPrompt(selectedPost); };
    if(btnCopyApprovalLink) btnCopyApprovalLink.onclick = ()=>{ copyApprovalLinkForPost(); };
    if(btnSave)    btnSave.onclick    = ()=>{ if(selectedPost) savePostMeta(selectedPost, modalDesc.value||"", modalTarget.value||"feed"); };
    if(btnDelete)  btnDelete.onclick  = ()=>{ if(selectedPost) deletePost(selectedPost); };

    if(calUpload) calUpload.onclick = handleUpload;
    if(btnShareCalendar) btnShareCalendar.onclick = ()=> generateCalendarShare();


    /* ======= Revis√£o: observa√ß√µes do cliente ======= */
    const reviewModal = $("reviewModal"), reviewText = $("reviewText"), reviewSend = $("reviewSend"), reviewCancel = $("reviewCancel");
    function fmtDateTime(d){
      try{
        const pad=n=>String(n).padStart(2,"0");
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }catch(_){ return ""; }
    }
    function renderClientNotesPanel(post){
      const panel = document.getElementById("clientNotesPanel");
      if(!panel) return;
      const notes = Array.isArray(post.reviewNotes)? post.reviewNotes : [];
      if(notes.length===0){
        panel.innerHTML = `<div class="muted">Sem observa√ß√µes.</div>`;
        return;
      }
      panel.innerHTML = notes.map(n=>{
        const when = n.at ? (typeof n.at==='number'? n.at : (n.at.toMillis? n.at.toMillis() : Date.parse(n.at)||Date.now())) : Date.now();
        const dt = new Date(when);
        const pad = x => String(x).padStart(2,'0');
        const dstr = `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())} ${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
        const who = (n.by||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const text = renderMarkdownText(n.text||'');
        const slide = Number.isInteger(n.slide)? ` ‚Ä¢ Slide ${n.slide+1}` : '';
        return `<div class="note-item"><div class="note-head"><span>${who||"cliente"}</span><span>‚Ä¢</span><span>${dstr}${slide}</span></div><div class="note-body markdown-view">${text}</div></div>`;
      }).join("");
    }

    function renderClientNotesInCard(post){
  const box = document.getElementById("clientNotesList");
  if(!box) return;
  const notes = Array.isArray(post.reviewNotes)? post.reviewNotes : [];
  if(notes.length===0){ box.innerHTML = `<div class="muted">Sem observa√ß√µes.</div>`; return; }
  const rows = notes.map(n=>{
    const dt = n.at?.toMillis ? new Date(n.at.toMillis()) : (typeof n.at==="number"? new Date(n.at) : (n.at? new Date(n.at): new Date()));
    const pad = x=> String(x).padStart(2,"0");
    const when = `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())} ${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
    const who = (n.by||"").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    const text = renderMarkdownText(n.text||"");
    return `<div class="client-note"><div class="dot"></div><div class="txt markdown-view">${text}<div class="meta">${who||"cliente"} ‚Ä¢ ${when}</div></div></div>`;
  }).join("");
  box.innerHTML = rows;
}

function renderReviewNotes(post){
      const box = $("notesList"); if(!box) return;
      const notes = Array.isArray(post.reviewNotes)? post.reviewNotes : [];
      if(notes.length===0){ box.innerHTML = `<div class="muted">Sem observa√ß√µes.</div>`; return; }
      box.innerHTML = notes.map(n=>{
        const when = n.at?.toMillis ? fmtDateTime(new Date(n.at.toMillis())) : (typeof n.at==="number" ? fmtDateTime(new Date(n.at)) : (n.at ? fmtDateTime(new Date(n.at)):""));
        const who = (n.by||"").replace(/</g,"&lt;").replace(/>/g,"&gt;");
        const origin = resolveReviewOrigin(n);
        const originLabel = origin === 'interno' ? 'Time interno' : 'Cliente';
        const text = renderMarkdownText(n.text||"");
        return `<div class="note-item"><div class="note-head"><span>${who||originLabel.toLowerCase()}</span><span>‚Ä¢</span><span>${when}</span><span class="origin-pill origin-${origin}">${originLabel}</span></div><div class="note-body markdown-view">${text}</div></div>`;
      }).join("");
    }
    function openReviewPrompt(post){
      selectedPost = post;
      if(reviewText) reviewText.value = "";
      if(reviewModal){ reviewModal.classList.add("show"); reviewModal.setAttribute("aria-hidden","false"); setTimeout(()=>reviewText?.focus(), 50); }
    }
    function closeReviewPrompt(){
      if(reviewModal){ reviewModal.classList.remove("show"); reviewModal.setAttribute("aria-hidden","true"); }
    }
    if(reviewCancel) reviewCancel.onclick = closeReviewPrompt;
    async function addReviewNote(post, text){
      const uid = auth.currentUser?.uid; if(!uid) return alert("Fa√ßa login.");
      const email = auth.currentUser?.email || "";
      try{
        const ref = doc(db, "usuarios", uid, "posts", post.id);
        const note = { text, by: email, uid, at: Date.now(), slide: SLIDE_IDX, origin: getCurrentReviewOrigin() };
        await updateDoc(ref, {
          status: "revisar",
          updatedAt: serverTimestamp(),
          reviewNotes: arrayUnion(note),
          lastReviewAt: serverTimestamp()
        });
        // local state
        if(!Array.isArray(post.reviewNotes)) post.reviewNotes=[];
        post.reviewNotes.push(note);
        const before = REVIEWED_SET.size;
        REVIEWED_SET.add(SLIDE_IDX);
        // close only the review modal, keep post modal open and move to next media
        closeReviewPrompt();
        // advance to next slide if exists
        if(typeof SLIDE_IDX === 'number' && Array.isArray(SLIDES)){
          if(SLIDE_IDX < SLIDES.length - 1){
            SLIDE_IDX = SLIDE_IDX + 1;
          }
        }
        // re-render media and (if on first slide) the card notes
        if(typeof openPostModal._renderSlide === "function"){ openPostModal._renderSlide(); }
        renderClientNotesInCard(post); renderReviewNotes(post);
        if(REVIEWED_SET.size === SLIDES.length && before !== SLIDES.length){
          sendWebhook('calendar', {
            action:'status',
            id: post.id,
            status: 'revisar',
            dateISO: post.dateISO || '',
            postName: post.desc || '',
            postDesc: post.desc || '',
            reviewNotes: Array.isArray(post.reviewNotes) ? post.reviewNotes.map(n => n.text) : []
          });
        }
        if(window.googleCalendarIntegration){
          try{ await window.googleCalendarIntegration.handlePostUpdated(post); }
          catch(err){ console.warn('googleCalendarIntegration.handlePostUpdated', err); }
        }
        mgToast('Observa√ß√£o salva. Avance para o pr√≥ximo item do carrossel.');
      }catch(e){ console.error(e); alert("Falha ao enviar observa√ß√£o: "+(e.message||String(e))); }
    }
    if(reviewSend) reviewSend.onclick = ()=>{
      if(!selectedPost) return;
      const text = (reviewText?.value||"").trim();
      if(!text) return alert("Descreva o que precisa ser ajustado.");
      addReviewNote(selectedPost, text);
    };

    /* scroll hint */
    let hideTimer=null;
    function hasMoreToScroll(){ const el=document.documentElement; return el.scrollHeight - (el.scrollTop + window.innerHeight) > 16; }
    function showScrollHint(){ if(!scrollHint) return; if(hasMoreToScroll()) scrollHint.classList.add("show"); }
    function hideScrollHint(){ if(!scrollHint) return; scrollHint.classList.remove("show"); }
    function showScrollHintTemporario(){ if(!scrollHint) return; showScrollHint(); clearTimeout(hideTimer); hideTimer=setTimeout(()=>scrollHint.classList.remove("show"),2000); }
    function updateScrollHint(){ if(!scrollHint) return; if(hasMoreToScroll()) showScrollHint(); else hideScrollHint(); }
    if(scrollHint){
      window.addEventListener("scroll",()=>{ hideScrollHint(); clearTimeout(hideTimer); hideTimer=setTimeout(updateScrollHint,500); });
      window.addEventListener("resize",updateScrollHint);
      document.addEventListener("DOMContentLoaded",updateScrollHint);
    }
  </script>
<!-- Modal: Pedir Revis√£o (coleta observa√ß√µes) -->
<div aria-hidden="true" class="modal" id="reviewModal">
<div aria-modal="true" class="modal-card small" role="dialog">
<div class="modal-head">
<strong>Pedir revis√£o</strong>
<button class="btn small secondary" id="reviewCancel">Fechar</button>
</div>
<div class="modal-body" style="grid-template-columns: 1fr">
<div class="info">
<label class="muted" style="display:block; margin:6px 0">Descreva o que precisa ser ajustado</label>
<textarea id="reviewText" placeholder="Ex.: trocar a m√∫sica, cortar os 3s iniciais, corrigir texto..."></textarea>
</div>
</div>
<div class="modal-foot">
<button class="btn small" id="reviewSend">Enviar observa√ß√£o</button>
</div>
</div>
    <!-- Bloco de notas simples (Objetivos do m√™s) -->
    <div class="notes-block" id="relatorioGoalsSimpleNotesWrap">
      <div class="relatorio-header" style="margin-top:10px">
        <h3>üìù Anota√ß√µes do objetivo do m√™s</h3>
      </div>
      <textarea id="relatorioGoalsNotesSimple" rows="4" placeholder="Escreva suas anota√ß√µes do objetivo do m√™s..."
        style="width:100%;background:#0f0f0f;border:1px solid #2a2a2a;color:#fff;border-radius:8px;padding:10px;resize:vertical;text-align:center;"></textarea>
      <div id="relatorioGoalsNotesSimpleStatus" style="margin-top:6px;font-size:.8rem;color:#9ca3af;text-align:right;"></div>
    </div>
</div>
<script>
  (function(){
    function fixPreviewMedia(){
      var wrap = document.getElementById('modalPreview'); if(!wrap) return;
      var vid = wrap.querySelector('video');
      if(vid){
        vid.setAttribute('playsinline','');
        vid.setAttribute('controls','');
        vid.setAttribute('webkit-playsinline','');
        vid.style.maxHeight = '56vh';
        vid.style.width = '100%';
        vid.style.height = 'auto';
      }
      var img = wrap.querySelector('img');
      if(img){
        img.style.maxHeight = '56vh';
        img.style.width = '100%';
        img.style.height = 'auto';
        img.style.objectFit = 'contain';
        img.decoding = 'async';
      }
    }
    // Run after modal content swaps
    const pm = document.getElementById('postModal');
    if(pm){
      const obs = new MutationObserver(fixPreviewMedia);
      obs.observe(pm, { childList:true, subtree:true });
    }
    // Also run on load
    document.addEventListener('DOMContentLoaded', fixPreviewMedia);
  })();
</script>
<script>
  (function(){
    var postModal = document.getElementById('postModal');
    if(!postModal) return;
    function toggleBodyLock(){
      if(postModal.classList.contains('show')){
        document.documentElement.style.overflow = 'hidden';
        document.body.style.overflow = 'hidden';
      } else {
        document.documentElement.style.overflow = '';
        document.body.style.overflow = '';
      }
    }
    var mo = new MutationObserver(toggleBodyLock);
    mo.observe(postModal, { attributes: true, attributeFilter: ['class'] });
    toggleBodyLock();
  })();
</script>
<script>
(function(){
  // fechar ao tocar fora do cart√£o
  var modals = document.querySelectorAll('.modal');
  modals.forEach(function(m){
    m.addEventListener('click', function(e){
      if(e.target === m){ m.classList.remove('show'); } // backdrop
    }, {passive:true});
  });
  // swipe down para fechar reviewModal
  var rm = document.getElementById('reviewModal');
  if(rm){
    var startY=0, delta=0;
    rm.addEventListener('touchstart', function(ev){ startY = ev.touches[0].clientY; delta=0; }, {passive:true});
    rm.addEventListener('touchmove', function(ev){ delta = ev.touches[0].clientY - startY; }, {passive:true});
    rm.addEventListener('touchend', function(){ if(delta > 80){ rm.classList.remove('show'); } }, {passive:true});
  }
})();
</script>
<script>
(function(){
  function setupReelsOverlay(){
    var pv = document.getElementById('modalPreview');
    if(!pv) return;
    // ensure container is relative
    pv.classList.add('preview');
    // find media
    var v = pv.querySelector('video');
    // If no video, remove play overlay if exists
    var existingPlay = document.getElementById('reelsPlayOverlay');
    var existingClose = document.getElementById('reelsCloseOverlay');
    if(!v){
      if(existingPlay) existingPlay.remove();
      if(existingClose) existingClose.remove();
      return;
    }
    // attributes to behave inline
    v.setAttribute('playsinline','');
    v.setAttribute('webkit-playsinline','');
    v.setAttribute('controls','');
    v.style.objectFit = 'contain';
    v.style.background = '#000';
    v.style.maxHeight = '62dvh';

    // create overlays if missing
    var play = existingPlay;
    if(!play){
      play = document.createElement('div');
      play.id = 'reelsPlayOverlay';
      pv.appendChild(play);
    }
    var closeX = existingClose;
    if(!closeX){
      closeX = document.createElement('button');
      closeX.id = 'reelsCloseOverlay';
      closeX.type = 'button';
      closeX.textContent = '√ó';
      pv.appendChild(closeX);
      closeX.addEventListener('click', function(e){
        e.stopPropagation();
        try{ document.getElementById('postModal').classList.remove('show'); }catch(_){};
      }, {passive:true});
    }

    // show play overlay when paused, hide when playing
    function syncOverlay(){
      if(v.paused){ play.style.display = 'flex'; } else { play.style.display = 'none'; }
    }
    v.addEventListener('play', syncOverlay, {passive:true});
    v.addEventListener('pause', syncOverlay, {passive:true});
    v.addEventListener('ended', syncOverlay, {passive:true});
    syncOverlay();

    // tap to toggle play/pause when tapping on overlay
    play.addEventListener('click', function(e){
      e.stopPropagation();
      try{ v.play(); }catch(_){};
    }, {passive:true});
  }

  // Run on DOM ready and whenever modal content changes
  document.addEventListener('DOMContentLoaded', setupReelsOverlay);
  var pm = document.getElementById('postModal');
  if(pm){
    var mo = new MutationObserver(function(){ setupReelsOverlay(); });
    mo.observe(pm, { childList:true, subtree:true });
  }
})();
</script>
<script>
(function(){
  // singleton fullscreen close button
  var fsBtn = document.getElementById('fsCloseOverlay');
  if(!fsBtn){
    fsBtn = document.createElement('button');
    fsBtn.id = 'fsCloseOverlay';
    fsBtn.type = 'button';
    fsBtn.textContent = '√ó';
    document.body.appendChild(fsBtn);
  }
  function isFullscreen(){
    return !!(document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement);
  }
  function exitFS(){
    if(document.exitFullscreen){ document.exitFullscreen().catch(()=>{}); }
    else if(document.webkitExitFullscreen){ document.webkitExitFullscreen(); }
    // iOS video API
    var vf = document.querySelector('video');
    if(vf && typeof vf.webkitExitFullscreen === 'function'){
      try{ vf.webkitExitFullscreen(); }catch(_){}
    }
  }
  function enterFSForVideo(v){
    // Try vendor-prefixed first for iOS Safari
    if(typeof v.webkitEnterFullscreen === 'function'){
      try{ v.webkitEnterFullscreen(); return true; }catch(_){}
    }
    // Generic Fullscreen API
    if(v.requestFullscreen){ v.requestFullscreen().catch(()=>{}); return true; }
    if(v.webkitRequestFullscreen){ v.webkitRequestFullscreen(); return true; }
    return false;
  }
  function onFSChange(){
    // toggle global close 'X' in fullscreen
    fsBtn.style.display = isFullscreen() ? 'block' : 'none';
    if(!isFullscreen()){
      // when leaving fullscreen, pause and show play overlay again
      var pv = document.getElementById('modalPreview');
      var v = pv && pv.querySelector('video');
      if(v){ try{ v.pause(); }catch(_){ } }
      var play = document.getElementById('reelsPlayOverlay');
      if(play){ play.style.display = 'flex'; }
    }
  }
  ['fullscreenchange','webkitfullscreenchange','msfullscreenchange'].forEach(function(evt){
    document.addEventListener(evt, onFSChange);
  });
  fsBtn.addEventListener('click', function(ev){
    ev.preventDefault(); ev.stopPropagation();
    exitFS();
  }, {passive:false});

  function hookupPlayToFullscreen(){
    var pv = document.getElementById('modalPreview'); if(!pv) return;
    var v = pv.querySelector('video'); if(!v) return;
    var play = document.getElementById('reelsPlayOverlay'); if(!play) return;
    // Center play tap -> enter fullscreen and play
    play.addEventListener('click', function(e){
      e.preventDefault(); e.stopPropagation();
      // Ensure we start at currentTime (no reset)
      if(enterFSForVideo(v)){ setTimeout(function(){ try{ v.play(); }catch(_){} }, 150); }
      else { try{ v.play(); }catch(_){} }
    }, {passive:false});
  }

  document.addEventListener('DOMContentLoaded', hookupPlayToFullscreen);
  var pm = document.getElementById('postModal');
  if(pm){
    var mo = new MutationObserver(function(){ hookupPlayToFullscreen(); });
    mo.observe(pm, {childList:true, subtree:true});
  }
})();
</script>
<script>
(function(){
  function fmtDate(ts){
    try{
      if(!ts) return '';
      if(typeof ts === 'number'){ var d = new Date(ts); }
      else if(ts && ts.seconds){ var d = new Date(ts.seconds*1000); }
      else if(typeof ts === 'string'){ var d = new Date(ts); }
      else { return ''; }
      const pad=n=>String(n).padStart(2,'0');
      return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+' '+pad(d.getHours())+':'+pad(d.getMinutes());
    }catch(_){ return ''; }
  }
  function esc(s){ return (s||'').replace(/[&<>]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m])); }

  function ensureNotesContainer(){
    const modal = document.getElementById('postModal');
    if(!modal) return null;
    // Find the label "Observa√ß√µes do cliente"
    const labels = modal.querySelectorAll('label, .label, .field-label, h4, h5');
    let anchor = null;
    labels.forEach(el => {
      const t = (el.textContent||'').trim().toLowerCase();
      if(!anchor && (t === 'observa√ß√µes do cliente' || t === 'observacoes do cliente')) anchor = el;
    });
    if(!anchor){
      // try to find by placeholder on input
      const input = modal.querySelector('input[placeholder*="observa"], textarea[placeholder*="observa"]');
      if(input) anchor = input.closest('.field') || input.parentElement;
    }
    if(!anchor) return null;

    // Insert container after the field block
    // Find block wrapper (field group)
    let block = anchor.closest('.field, .row, div');
    if(!block) block = anchor.parentElement;
    // place after this block
    // If already exists, return it
    let list = modal.querySelector('#clientNotesList');
    if(list) return list;
    list = document.createElement('div');
    list.id = 'clientNotesList';
    // Insert after block
    if(block.nextSibling){
      block.parentNode.insertBefore(list, block.nextSibling);
    }else{
      block.parentNode.appendChild(list);
    }
    return list;
  }

  function renderClientNotes(post){
    try{
      const list = ensureNotesContainer();
      if(!list) return;
      const notes = Array.isArray(post && post.reviewNotes) ? post.reviewNotes : [];
      if(notes.length === 0){
        list.innerHTML = '<div class="client-note"><div class="txt" style="color:var(--muted,#bbb)">Sem observa√ß√µes do cliente ainda.</div></div>';
        return;
      }
      const html = notes.map(n => {
        const author = (n.by||'').split('@')[0] || 'cliente';
        const when = fmtDate(n.at);
        const textHtml = renderMarkdownText(n.text||'');
        return '<div class="client-note">'
          + '<div class="dot"></div>'
          + '<div class="txt markdown-view">' + textHtml + '<div class="meta">por ' + esc(author) + (when? ' ‚Ä¢ ' + esc(when) : '') + '</div></div>'
          + '</div>';
      }).join('');
      list.innerHTML = html;
    }catch(e){ /* noop */ }
  }

  // Hook into modal updates: expect a global CURRENT_POST or read from DOM attributes if used
  function getCurrentPost(){
    try{
      if(window.CURRENT_POST) return window.CURRENT_POST;
      // fallback: if your app stores post id on modal
      const pm = document.getElementById('postModal');
      const id = pm && pm.getAttribute('data-post-id');
      if(id && window.POSTS && Array.isArray(window.POSTS)){
        return window.POSTS.find(p=>p.id===id);
      }
    }catch(_){}
    return null;
  }

  function update(){
    const p = getCurrentPost();
    if(p) renderClientNotes(p);
  }

  document.addEventListener('DOMContentLoaded', update);
  const pm = document.getElementById('postModal');
  if(pm){
    const mo = new MutationObserver(function(){ update(); });
    mo.observe(pm, { childList:true, subtree:true, attributes:true });
  }
  // Also refresh after any Firestore change if app exposes POSTS globally
  if(Array.isArray(window.POSTS)){
    setInterval(update, 1200);
  }
})();
</script>
<script>
(function(){
  function toast(msg){
    var el=document.createElement('div');
    el.textContent=msg;
    el.style.cssText='position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:rgba(0,0,0,.85);color:#fff;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.2);z-index:100000;font-weight:800';
    document.body.appendChild(el);
    setTimeout(function(){ el.remove(); }, 3000);
  }
  function patchApproveButton(btn){
    if(btn && !btn.__patched){
      btn.__patched = true;
      btn.style.background = '#2e7d32';
      btn.style.borderColor = '#2e7d32';
      var orig = btn.onclick;
      btn.onclick = function(ev){
        if(typeof orig === 'function'){ orig.call(btn, ev); }
        var msg = btn.id === 'btnApproveInternal' ? 'Aprova√ß√£o interna registrada!' : 'Obrigado! J√° vamos agendar este post!';
        toast(msg);
        setTimeout(function(){
          var modal=document.getElementById('postModal');
          if(modal) modal.classList.remove('show');
        }, 3000);
      };
    }
  }
  patchApproveButton(document.getElementById('btnApprove'));
  patchApproveButton(document.getElementById('btnApproveInternal'));

  // Fullscreen image viewer
  function setupImageFS(){
    var pv=document.getElementById('modalPreview'); if(!pv) return;
    var img=pv.querySelector('img'); if(!img || img.__fsBound) return;
    img.__fsBound=true;
    var backdrop=document.getElementById('imgFsBackdrop');
    if(!backdrop){
      backdrop=document.createElement('div');
      backdrop.id='imgFsBackdrop';
      backdrop.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.95);display:none;align-items:center;justify-content:center;z-index:100000';
      backdrop.innerHTML='<img id="imgFsContent" style="max-width:100%;max-height:100%;object-fit:contain"><button id="imgFsClose" style="position:fixed;top:12px;right:12px;padding:8px 12px;border-radius:12px;background:rgba(0,0,0,.6);color:#fff;font-weight:800;border:1px solid rgba(255,255,255,.25)">√ó</button>';
      document.body.appendChild(backdrop);
      backdrop.querySelector('#imgFsClose').onclick=function(){ backdrop.style.display='none'; };
    }
    var fsImg=document.getElementById('imgFsContent');
    img.style.cursor='zoom-in';
    img.addEventListener('click',function(){
      fsImg.src=img.currentSrc||img.src;
      backdrop.style.display='flex';
    });
  }
  document.addEventListener('DOMContentLoaded', setupImageFS);
  var pm=document.getElementById('postModal');
  if(pm){
    var mo=new MutationObserver(setupImageFS);
    mo.observe(pm,{childList:true,subtree:true});
  }
})();
</script>
<script>
(function(){
  function getCurrentPost(){
    try{
      if(window.selectedPost) return window.selectedPost;
      if(window.CURRENT_POST) return window.CURRENT_POST;
      var pm = document.getElementById('postModal');
      var id = pm && pm.getAttribute('data-post-id');
      if(id && Array.isArray(window.POSTS)){
        return window.POSTS.find(p=>p.id===id);
      }
    }catch(e){}
    return null;
  }
  function guessVideo(u){
    if(!u) return false;
    var clean = (u.split('?')[0]||'').toLowerCase();
    return /\.(mp4|mov|webm|m4v|avi)$/.test(clean);
  }
  function buildCarousel(){
    var pm = document.getElementById('postModal');
    var pv = document.getElementById('modalPreview');
    if(!pm || !pv || !pm.classList.contains('show')) return;
    var post = getCurrentPost();
    if(!post) return;

    var urls = Array.isArray(post.mediaUrls) && post.mediaUrls.length ? post.mediaUrls.slice() : [];
    if(!urls.length && post.thumbUrl) urls = [post.thumbUrl];

    if(urls.length <= 1){
      // Single media: ensure stage exists but no arrows
      var u = urls[0];
      var markup = '<div class="pv-stage"><div class="pv-media">'
                 + (guessVideo(u)? '<video src="'+u+'" controls playsinline webkit-playsinline></video>'
                                 : '<img src="'+(u||'')+'" alt="">')
                 + '</div></div>';
      pv.innerHTML = markup;
      pv.classList.remove('pv-has-many','pv-hint','pv-hint-end');
      return;
    }

    var idx = 0;
    pv.classList.add('pv-has-many','pv-hint');
    pv.innerHTML = '<div class="pv-stage">'
                 + '  <div class="pv-media" id="pvMedia"></div>'
                 + '  <button type="button" class="pv-arrow left" aria-label="Anterior">‚Äπ</button>'
                 + '  <button type="button" class="pv-arrow right" aria-label="Pr√≥ximo">‚Ä∫</button>'
                 + '</div>';
    var mediaBox = pv.querySelector('#pvMedia');
    var prev = pv.querySelector('.pv-arrow.left');
    var next = pv.querySelector('.pv-arrow.right');

    function render(){
      var u = urls[idx];
      mediaBox.innerHTML = guessVideo(u)
        ? '<video src="'+u+'" controls playsinline webkit-playsinline></video>'
        : '<img src="'+u+'" alt="m√≠dia '+(idx+1)+'">';
    }
    function go(d){ idx = (idx + d + urls.length) % urls.length; render(); stopHint(); }

    prev.onclick = function(e){ e.stopPropagation(); go(-1); };
    next.onclick = function(e){ e.stopPropagation(); go(+1); };

    // Swipe (mobile)
    var sx=0, sy=0, dx=0, dy=0, moved=false;
    mediaBox.addEventListener('touchstart', function(ev){
      var t=ev.touches[0]; sx=t.clientX; sy=t.clientY; dx=dy=0; moved=false;
    }, {passive:true});
    mediaBox.addEventListener('touchmove', function(ev){
      var t=ev.touches[0]; dx=t.clientX - sx; dy=t.clientY - sy;
      if(Math.abs(dx) > 18 && Math.abs(dx) > Math.abs(dy)){ moved = true; ev.preventDefault(); }
    }, {passive:false});
    mediaBox.addEventListener('touchend', function(){
      if(moved){
        if(dx < -30) go(+1);
        if(dx >  30) go(-1);
      }
    }, {passive:true});

    // Keyboard (desktop)
    function onKey(e){
      if(!pm.classList.contains('show')) return;
      if(e.key==='ArrowLeft') go(-1);
      if(e.key==='ArrowRight') go(+1);
    }
    document.addEventListener('keydown', onKey);

    function stopHint(){
      pv.classList.remove('pv-hint'); pv.classList.add('pv-hint-end');
    }
    prev.addEventListener('click', stopHint, {passive:true});
    next.addEventListener('click', stopHint, {passive:true});
    mediaBox.addEventListener('click', stopHint, {passive:true});

    // Clean up when modal closes
    var mo = new MutationObserver(function(){
      if(!pm.classList.contains('show')){
        document.removeEventListener('keydown', onKey);
        mo.disconnect();
      }
    });
    mo.observe(pm, {attributes:true, attributeFilter:['class']});

    render();
  }

  // Rebuild on modal open/content changes
  document.addEventListener('DOMContentLoaded', function(){

  // Filtro por m√™s
  if (el.filterMonth && !el.filterMonth.dataset.bound){
    el.filterMonth.dataset.bound = '1';
    el.filterMonth.addEventListener('change', render);
  }
  if (el.clearFilter && !el.clearFilter.dataset.bound){
    el.clearFilter.dataset.bound = '1';
    el.clearFilter.addEventListener('click', function(){ if(el.filterMonth){ el.filterMonth.value = ''; } render(); });
  }

    var pm = document.getElementById('postModal');
    if(!pm) return;
    var obs = new MutationObserver(function(){
      if(pm.classList.contains('show')){
        setTimeout(buildCarousel, 30);
      }
    });
    obs.observe(pm, {attributes:true, attributeFilter:['class'], childList:true, subtree:true});
  });
})();
</script>
<!-- PATCH Macro: remover apenas as barras (widget-input) do PRIMEIRO card da aba Macro -->
<script>
(function(){
  "use strict";
  function isMacroActive(){
    var btn = document.querySelector('.tabs [role="tab"].active, .tab-btn.active');
    var txt = btn ? (btn.textContent||"").toLowerCase() : "";
    return txt.indexOf("macro") !== -1;
  }
  function getMacroGrid(){
    return document.querySelector('#widgetsGrid-macro, [data-section="macro"].widgets-grid')
        || document.querySelector('#widgetsGrid')
        || document.querySelector('.widgets-grid');
  }
  function removeMacroBars(){
    if (!isMacroActive()) return;
    var grid = getMacroGrid();
    if (!grid) return;
    var first = grid.querySelector('.widget-card');
    if (!first) return;
    var input = first.querySelector('.widget-input');
    if (input) input.remove();
  }
  document.addEventListener('DOMContentLoaded', function(){
    // aplica em loop curto para cobrir re-render inicial
    var tries = 0;
    var iv = setInterval(function(){
      tries++;
      removeMacroBars();
      if (tries > 30) clearInterval(iv);
    }, 100);
  });
  // observa mudan√ßas (re-renderiza√ß√µes)
  var mo = new MutationObserver(function(){ try{ removeMacroBars(); }catch(e){} });
  mo.observe(document.documentElement, { childList: true, subtree: true });
})();
</script>


<!-- PATCH Macro v4: remover header + barras (widget-input) + iframe do PRIMEIRO card da aba Macro -->
<script>
(function(){
  "use strict";
  function isMacroActive(){
    var btn = document.querySelector('.tabs [role="tab"].active, .tab-btn.active');
    var txt = btn ? (btn.textContent||"").toLowerCase() : "";
    return txt.indexOf("macro") !== -1;
  }
  function getMacroGrid(){
    return document.querySelector('#widgetsGrid-macro, [data-section="macro"].widgets-grid')
        || document.querySelector('#widgetsGrid')
        || document.querySelector('.widgets-grid');
  }
  function nukeFirstMacroCardBits(){
    if (!isMacroActive()) return;
    var grid = getMacroGrid();
    if (!grid) return;
    var first = grid.querySelector('.widget-card');
    if (!first) return;

    // 1) header
    var head = first.querySelector('.widget-head');
    if (head) head.remove();

    // 2) barras (inputs)
    var input = first.querySelector('.widget-input');
    if (input) input.remove();

    // 3) iframe e container
    var shell = first.querySelector('.frame-shell');
    if (shell) shell.remove();
    var ifr = first.querySelector('iframe');
    if (ifr) ifr.remove();
  }

  // roda v√°rias vezes no in√≠cio para cobrir re-render inicial
  document.addEventListener('DOMContentLoaded', function(){
    var tries = 0;
    var iv = setInterval(function(){
      tries++;
      nukeFirstMacroCardBits();
      if (tries > 40) clearInterval(iv); // ~4s
    }, 100);
  });

  // observa mudan√ßas e reaplica
  var mo = new MutationObserver(function(){ try{ nukeFirstMacroCardBits(); }catch(e){} });
  mo.observe(document.documentElement, { childList: true, subtree: true });

  // utilit√°rio manual
  window.__nukeFirstMacroCardBits = nukeFirstMacroCardBits;
})();
</script>



</body>
</html>
<!-- partial -->
<!-- Modal: Pedir Revis√£o (coleta observa√ß√µes) -->
<div aria-hidden="true" class="modal" id="reviewModal">
<div aria-modal="true" class="modal-card small" role="dialog">
<div class="modal-head">
<strong>Pedir revis√£o</strong>
<button class="btn small secondary" id="reviewCancel">Fechar</button>
</div>
<div class="modal-body" style="grid-template-columns: 1fr">
<div class="info">
<label class="muted" style="display:block; margin:6px 0">Descreva o que precisa ser ajustado</label>
<textarea id="reviewText" placeholder="Ex.: trocar a m√∫sica, cortar os 3s iniciais, corrigir texto..."></textarea>
</div>
</div>
<div class="modal-foot">
<button class="btn small" id="reviewSend">Enviar observa√ß√£o</button>
</div>
</div>
</div>
<script>
  (function(){
    function fixPreviewMedia(){
      var wrap = document.getElementById('modalPreview'); if(!wrap) return;
      var vid = wrap.querySelector('video');
      if(vid){
        vid.setAttribute('playsinline','');
        vid.setAttribute('controls','');
        vid.setAttribute('webkit-playsinline','');
        vid.style.maxHeight = '56vh';
        vid.style.width = '100%';
        vid.style.height = 'auto';
      }
      var img = wrap.querySelector('img');
      if(img){
        img.style.maxHeight = '56vh';
        img.style.width = '100%';
        img.style.height = 'auto';
        img.style.objectFit = 'contain';
        img.decoding = 'async';
      }
    }
    // Run after modal content swaps
    const pm = document.getElementById('postModal');
    if(pm){
      const obs = new MutationObserver(fixPreviewMedia);
      obs.observe(pm, { childList:true, subtree:true });
    }
    // Also run on load
    document.addEventListener('DOMContentLoaded', fixPreviewMedia);
  })();
</script>
<script>
  (function(){
    var postModal = document.getElementById('postModal');
    if(!postModal) return;
    function toggleBodyLock(){
      if(postModal.classList.contains('show')){
        document.documentElement.style.overflow = 'hidden';
        document.body.style.overflow = 'hidden';
      } else {
        document.documentElement.style.overflow = '';
        document.body.style.overflow = '';
      }
    }
    var mo = new MutationObserver(toggleBodyLock);
    mo.observe(postModal, { attributes: true, attributeFilter: ['class'] });
    toggleBodyLock();
  })();
</script>
<script>
(function(){
  // fechar ao tocar fora do cart√£o
  var modals = document.querySelectorAll('.modal');
  modals.forEach(function(m){
    m.addEventListener('click', function(e){
      if(e.target === m){ m.classList.remove('show'); } // backdrop
    }, {passive:true});
  });
  // swipe down para fechar reviewModal
  var rm = document.getElementById('reviewModal');
  if(rm){
    var startY=0, delta=0;
    rm.addEventListener('touchstart', function(ev){ startY = ev.touches[0].clientY; delta=0; }, {passive:true});
    rm.addEventListener('touchmove', function(ev){ delta = ev.touches[0].clientY - startY; }, {passive:true});
    rm.addEventListener('touchend', function(){ if(delta > 80){ rm.classList.remove('show'); } }, {passive:true});
  }
})();
</script>
<script>
(function(){
  function setupReelsOverlay(){
    var pv = document.getElementById('modalPreview');
    if(!pv) return;
    // ensure container is relative
    pv.classList.add('preview');
    // find media
    var v = pv.querySelector('video');
    // If no video, remove play overlay if exists
    var existingPlay = document.getElementById('reelsPlayOverlay');
    var existingClose = document.getElementById('reelsCloseOverlay');
    if(!v){
      if(existingPlay) existingPlay.remove();
      if(existingClose) existingClose.remove();
      return;
    }
    // attributes to behave inline
    v.setAttribute('playsinline','');
    v.setAttribute('webkit-playsinline','');
    v.setAttribute('controls','');
    v.style.objectFit = 'contain';
    v.style.background = '#000';
    v.style.maxHeight = '62dvh';

    // create overlays if missing
    var play = existingPlay;
    if(!play){
      play = document.createElement('div');
      play.id = 'reelsPlayOverlay';
      pv.appendChild(play);
    }
    var closeX = existingClose;
    if(!closeX){
      closeX = document.createElement('button');
      closeX.id = 'reelsCloseOverlay';
      closeX.type = 'button';
      closeX.textContent = '√ó';
      pv.appendChild(closeX);
      closeX.addEventListener('click', function(e){
        e.stopPropagation();
        try{ document.getElementById('postModal').classList.remove('show'); }catch(_){};
      }, {passive:true});
    }

    // show play overlay when paused, hide when playing
    function syncOverlay(){
      if(v.paused){ play.style.display = 'flex'; } else { play.style.display = 'none'; }
    }
    v.addEventListener('play', syncOverlay, {passive:true});
    v.addEventListener('pause', syncOverlay, {passive:true});
    v.addEventListener('ended', syncOverlay, {passive:true});
    syncOverlay();

    // tap to toggle play/pause when tapping on overlay
    play.addEventListener('click', function(e){
      e.stopPropagation();
      try{ v.play(); }catch(_){};
    }, {passive:true});
  }

  // Run on DOM ready and whenever modal content changes
  document.addEventListener('DOMContentLoaded', setupReelsOverlay);
  var pm = document.getElementById('postModal');
  if(pm){
    var mo = new MutationObserver(function(){ setupReelsOverlay(); });
    mo.observe(pm, { childList:true, subtree:true });
  }
})();
</script>
<script>
(function(){
  // singleton fullscreen close button
  var fsBtn = document.getElementById('fsCloseOverlay');
  if(!fsBtn){
    fsBtn = document.createElement('button');
    fsBtn.id = 'fsCloseOverlay';
    fsBtn.type = 'button';
    fsBtn.textContent = '√ó';
    document.body.appendChild(fsBtn);
  }
  function isFullscreen(){
    return !!(document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement);
  }
  function exitFS(){
    if(document.exitFullscreen){ document.exitFullscreen().catch(()=>{}); }
    else if(document.webkitExitFullscreen){ document.webkitExitFullscreen(); }
    // iOS video API
    var vf = document.querySelector('video');
    if(vf && typeof vf.webkitExitFullscreen === 'function'){
      try{ vf.webkitExitFullscreen(); }catch(_){}
    }
  }
  function enterFSForVideo(v){
    // Try vendor-prefixed first for iOS Safari
    if(typeof v.webkitEnterFullscreen === 'function'){
      try{ v.webkitEnterFullscreen(); return true; }catch(_){}
    }
    // Generic Fullscreen API
    if(v.requestFullscreen){ v.requestFullscreen().catch(()=>{}); return true; }
    if(v.webkitRequestFullscreen){ v.webkitRequestFullscreen(); return true; }
    return false;
  }
  function onFSChange(){
    // toggle global close 'X' in fullscreen
    fsBtn.style.display = isFullscreen() ? 'block' : 'none';
    if(!isFullscreen()){
      // when leaving fullscreen, pause and show play overlay again
      var pv = document.getElementById('modalPreview');
      var v = pv && pv.querySelector('video');
      if(v){ try{ v.pause(); }catch(_){ } }
      var play = document.getElementById('reelsPlayOverlay');
      if(play){ play.style.display = 'flex'; }
    }
  }
  ['fullscreenchange','webkitfullscreenchange','msfullscreenchange'].forEach(function(evt){
    document.addEventListener(evt, onFSChange);
  });
  fsBtn.addEventListener('click', function(ev){
    ev.preventDefault(); ev.stopPropagation();
    exitFS();
  }, {passive:false});

  function hookupPlayToFullscreen(){
    var pv = document.getElementById('modalPreview'); if(!pv) return;
    var v = pv.querySelector('video'); if(!v) return;
    var play = document.getElementById('reelsPlayOverlay'); if(!play) return;
    // Center play tap -> enter fullscreen and play
    play.addEventListener('click', function(e){
      e.preventDefault(); e.stopPropagation();
      // Ensure we start at currentTime (no reset)
      if(enterFSForVideo(v)){ setTimeout(function(){ try{ v.play(); }catch(_){} }, 150); }
      else { try{ v.play(); }catch(_){} }
    }, {passive:false});
  }

  document.addEventListener('DOMContentLoaded', hookupPlayToFullscreen);
  var pm = document.getElementById('postModal');
  if(pm){
    var mo = new MutationObserver(function(){ hookupPlayToFullscreen(); });
    mo.observe(pm, {childList:true, subtree:true});
  }
})();
</script>
<script>
(function(){
  function fmtDate(ts){
    try{
      if(!ts) return '';
      if(typeof ts === 'number'){ var d = new Date(ts); }
      else if(ts && ts.seconds){ var d = new Date(ts.seconds*1000); }
      else if(typeof ts === 'string'){ var d = new Date(ts); }
      else { return ''; }
      const pad=n=>String(n).padStart(2,'0');
      return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+' '+pad(d.getHours())+':'+pad(d.getMinutes());
    }catch(_){ return ''; }
  }
  function esc(s){ return (s||'').replace(/[&<>]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m])); }

  function ensureNotesContainer(){
    const modal = document.getElementById('postModal');
    if(!modal) return null;
    // Find the label "Observa√ß√µes do cliente"
    const labels = modal.querySelectorAll('label, .label, .field-label, h4, h5');
    let anchor = null;
    labels.forEach(el => {
      const t = (el.textContent||'').trim().toLowerCase();
      if(!anchor && (t === 'observa√ß√µes do cliente' || t === 'observacoes do cliente')) anchor = el;
    });
    if(!anchor){
      // try to find by placeholder on input
      const input = modal.querySelector('input[placeholder*="observa"], textarea[placeholder*="observa"]');
      if(input) anchor = input.closest('.field') || input.parentElement;
    }
    if(!anchor) return null;

    // Insert container after the field block
    // Find block wrapper (field group)
    let block = anchor.closest('.field, .row, div');
    if(!block) block = anchor.parentElement;
    // place after this block
    // If already exists, return it
    let list = modal.querySelector('#clientNotesList');
    if(list) return list;
    list = document.createElement('div');
    list.id = 'clientNotesList';
    // Insert after block
    if(block.nextSibling){
      block.parentNode.insertBefore(list, block.nextSibling);
    }else{
      block.parentNode.appendChild(list);
    }
    return list;
  }

  function renderClientNotes(post){
    try{
      const list = ensureNotesContainer();
      if(!list) return;
      const notes = Array.isArray(post && post.reviewNotes) ? post.reviewNotes : [];
      if(notes.length === 0){
        list.innerHTML = '<div class="client-note"><div class="txt" style="color:var(--muted,#bbb)">Sem observa√ß√µes do cliente ainda.</div></div>';
        return;
      }
      const html = notes.map(n => {
        const author = (n.by||'').split('@')[0] || 'cliente';
        const when = fmtDate(n.at);
        const textHtml = renderMarkdownText(n.text||'');
        return '<div class="client-note">'
          + '<div class="dot"></div>'
          + '<div class="txt markdown-view">' + textHtml + '<div class="meta">por ' + esc(author) + (when? ' ‚Ä¢ ' + esc(when) : '') + '</div></div>'
          + '</div>';
      }).join('');
      list.innerHTML = html;
    }catch(e){ /* noop */ }
  }

  // Hook into modal updates: expect a global CURRENT_POST or read from DOM attributes if used
  function getCurrentPost(){
    try{
      if(window.CURRENT_POST) return window.CURRENT_POST;
      // fallback: if your app stores post id on modal
      const pm = document.getElementById('postModal');
      const id = pm && pm.getAttribute('data-post-id');
      if(id && window.POSTS && Array.isArray(window.POSTS)){
        return window.POSTS.find(p=>p.id===id);
      }
    }catch(_){}
    return null;
  }

  function update(){
    const p = getCurrentPost();
    if(p) renderClientNotes(p);
  }

  document.addEventListener('DOMContentLoaded', update);
  const pm = document.getElementById('postModal');
  if(pm){
    const mo = new MutationObserver(function(){ update(); });
    mo.observe(pm, { childList:true, subtree:true, attributes:true });
  }
  // Also refresh after any Firestore change if app exposes POSTS globally
  if(Array.isArray(window.POSTS)){
    setInterval(update, 1200);
  }
})();
</script>
<script>
(function(){
  function toast(msg){
    var el=document.createElement('div');
    el.textContent=msg;
    el.style.cssText='position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:rgba(0,0,0,.85);color:#fff;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.2);z-index:100000;font-weight:800';
    document.body.appendChild(el);
    setTimeout(function(){ el.remove(); }, 3000);
  }
  function patchApproveButton(btn){
    if(btn && !btn.__patched){
      btn.__patched = true;
      btn.style.background = '#2e7d32';
      btn.style.borderColor = '#2e7d32';
      var orig = btn.onclick;
      btn.onclick = function(ev){
        if(typeof orig === 'function'){ orig.call(btn, ev); }
        var msg = btn.id === 'btnApproveInternal' ? 'Aprova√ß√£o interna registrada!' : 'Obrigado! J√° vamos agendar este post!';
        toast(msg);
        setTimeout(function(){
          var modal=document.getElementById('postModal');
          if(modal) modal.classList.remove('show');
        }, 3000);
      };
    }
  }
  patchApproveButton(document.getElementById('btnApprove'));
  patchApproveButton(document.getElementById('btnApproveInternal'));

  // Fullscreen image viewer
  function setupImageFS(){
    var pv=document.getElementById('modalPreview'); if(!pv) return;
    var img=pv.querySelector('img'); if(!img || img.__fsBound) return;
    img.__fsBound=true;
    var backdrop=document.getElementById('imgFsBackdrop');
    if(!backdrop){
      backdrop=document.createElement('div');
      backdrop.id='imgFsBackdrop';
      backdrop.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.95);display:none;align-items:center;justify-content:center;z-index:100000';
      backdrop.innerHTML='<img id="imgFsContent" style="max-width:100%;max-height:100%;object-fit:contain"><button id="imgFsClose" style="position:fixed;top:12px;right:12px;padding:8px 12px;border-radius:12px;background:rgba(0,0,0,.6);color:#fff;font-weight:800;border:1px solid rgba(255,255,255,.25)">√ó</button>';
      document.body.appendChild(backdrop);
      backdrop.querySelector('#imgFsClose').onclick=function(){ backdrop.style.display='none'; };
    }
    var fsImg=document.getElementById('imgFsContent');
    img.style.cursor='zoom-in';
    img.addEventListener('click',function(){
      fsImg.src=img.currentSrc||img.src;
      backdrop.style.display='flex';
    });
  }
  document.addEventListener('DOMContentLoaded', setupImageFS);
  var pm=document.getElementById('postModal');
  if(pm){
    var mo=new MutationObserver(setupImageFS);
    mo.observe(pm,{childList:true,subtree:true});
  }
})();
</script>
<script>
(function(){
  function getCurrentPost(){
    try{
      if(window.selectedPost) return window.selectedPost;
      if(window.CURRENT_POST) return window.CURRENT_POST;
      var pm = document.getElementById('postModal');
      var id = pm && pm.getAttribute('data-post-id');
      if(id && Array.isArray(window.POSTS)){
        return window.POSTS.find(p=>p.id===id);
      }
    }catch(e){}
    return null;
  }
  function guessVideo(u){
    if(!u) return false;
    var clean = (u.split('?')[0]||'').toLowerCase();
    return /\.(mp4|mov|webm|m4v|avi)$/.test(clean);
  }
  function buildCarousel(){
    var pm = document.getElementById('postModal');
    var pv = document.getElementById('modalPreview');
    if(!pm || !pv || !pm.classList.contains('show')) return;
    var post = getCurrentPost();
    if(!post) return;

    var urls = Array.isArray(post.mediaUrls) && post.mediaUrls.length ? post.mediaUrls.slice() : [];
    if(!urls.length && post.thumbUrl) urls = [post.thumbUrl];

    if(urls.length <= 1){
      // Single media: ensure stage exists but no arrows
      var u = urls[0];
      var markup = '<div class="pv-stage"><div class="pv-media">'
                 + (guessVideo(u)? '<video src="'+u+'" controls playsinline webkit-playsinline></video>'
                                 : '<img src="'+(u||'')+'" alt="">')
                 + '</div></div>';
      pv.innerHTML = markup;
      pv.classList.remove('pv-has-many','pv-hint','pv-hint-end');
      return;
    }

    var idx = 0;
    pv.classList.add('pv-has-many','pv-hint');
    pv.innerHTML = '<div class="pv-stage">'
                 + '  <div class="pv-media" id="pvMedia"></div>'
                 + '  <button type="button" class="pv-arrow left" aria-label="Anterior">‚Äπ</button>'
                 + '  <button type="button" class="pv-arrow right" aria-label="Pr√≥ximo">‚Ä∫</button>'
                 + '</div>';
    var mediaBox = pv.querySelector('#pvMedia');
    var prev = pv.querySelector('.pv-arrow.left');
    var next = pv.querySelector('.pv-arrow.right');

    function render(){
      var u = urls[idx];
      mediaBox.innerHTML = guessVideo(u)
        ? '<video src="'+u+'" controls playsinline webkit-playsinline></video>'
        : '<img src="'+u+'" alt="m√≠dia '+(idx+1)+'">';
    }
    function go(d){ idx = (idx + d + urls.length) % urls.length; render(); stopHint(); }

    prev.onclick = function(e){ e.stopPropagation(); go(-1); };
    next.onclick = function(e){ e.stopPropagation(); go(+1); };

    // Swipe (mobile)
    var sx=0, sy=0, dx=0, dy=0, moved=false;
    mediaBox.addEventListener('touchstart', function(ev){
      var t=ev.touches[0]; sx=t.clientX; sy=t.clientY; dx=dy=0; moved=false;
    }, {passive:true});
    mediaBox.addEventListener('touchmove', function(ev){
      var t=ev.touches[0]; dx=t.clientX - sx; dy=t.clientY - sy;
      if(Math.abs(dx) > 18 && Math.abs(dx) > Math.abs(dy)){ moved = true; ev.preventDefault(); }
    }, {passive:false});
    mediaBox.addEventListener('touchend', function(){
      if(moved){
        if(dx < -30) go(+1);
        if(dx >  30) go(-1);
      }
    }, {passive:true});

    // Keyboard (desktop)
    function onKey(e){
      if(!pm.classList.contains('show')) return;
      if(e.key==='ArrowLeft') go(-1);
      if(e.key==='ArrowRight') go(+1);
    }
    document.addEventListener('keydown', onKey);

    function stopHint(){
      pv.classList.remove('pv-hint'); pv.classList.add('pv-hint-end');
    }
    prev.addEventListener('click', stopHint, {passive:true});
    next.addEventListener('click', stopHint, {passive:true});
    mediaBox.addEventListener('click', stopHint, {passive:true});

    // Clean up when modal closes
    var mo = new MutationObserver(function(){
      if(!pm.classList.contains('show')){
        document.removeEventListener('keydown', onKey);
        mo.disconnect();
      }
    });
    mo.observe(pm, {attributes:true, attributeFilter:['class']});

    render();
  }

  // Rebuild on modal open/content changes
  document.addEventListener('DOMContentLoaded', function(){
    var pm = document.getElementById('postModal');
    if(!pm) return;
    var obs = new MutationObserver(function(){
      if(pm.classList.contains('show')){
        setTimeout(buildCarousel, 30);
      }
    });
    obs.observe(pm, {attributes:true, attributeFilter:['class'], childList:true, subtree:true});
  });
})();
</script>
<!-- ========== PATCH: iframes persistentes por TENANT (n√£o altera login) ========== -->
<script>
/**
 * MediaGrowth Dashboard ‚Äì Persist√™ncia de iFrames por TENANT (sem alterar login)
 * O que faz:
 *  - Salva/Carrega seus widgets/iframes com chave: TENANT + se√ß√£o (ex.: "ACME-ads-widgets")
 *  - Migra automaticamente os dados antigos (sem TENANT) para o novo formato
 *  - Mant√©m seu fluxo atual (drag, altura, etc). Login permanece igual.
 *
 * Pr√©-requisitos que seu projeto j√° tem:
 *  - window.TENANT (string), window.currentSection (string)
 *  - Firebase v9 globais: auth, db, setDoc, doc
 *  - USER_DATA (objeto cache), WIDGETS (array), uuid() (opcional; existe fallback)
 */
(function(){
  try {
    if (typeof window === 'undefined') return;
    const g = window;
    const hasFirebase = !!(g.auth && g.db && g.setDoc && g.doc);

    function nsKey(section, suffix){
      const base = (typeof g.TENANT === 'string' && g.TENANT) ? (g.TENANT + '-') : '';
      return base + section + '-' + suffix;
    }
    function legacyKey(section, suffix){
      return section + '-' + suffix;
    }
    async function writeUserDoc(fields){
      if (!hasFirebase) return;
      const uid = g.auth?.currentUser?.uid;
      if (!uid) return;
      await g.setDoc(g.doc(g.db, 'usuarios', uid), fields, { merge: true });
    }
    function ensureUUID(){
      if (typeof g.uuid === 'function') return g.uuid;
      return function uuidLite(){
        return 'u-' + Math.random().toString(36).slice(2) + Date.now().toString(36);
      };
    }
    const mkUUID = ensureUUID();

    // Deixa k(suffix) TENANT-aware (ou cria, se n√£o existir)
    if (typeof g.k === 'function' && !g.k.__patchedByTenant) {
      const oldK = g.k;
      g.k = function(suffix){
        try {
          const raw = oldK(suffix);
          const t = (typeof g.TENANT === 'string' && g.TENANT) ? g.TENANT : null;
          if (!t) return legacyKey(g.currentSection || 'default', suffix);
          return raw && raw.startsWith(t + '-') ? raw : nsKey(g.currentSection || 'default', suffix);
        } catch(e){
          return nsKey(g.currentSection || 'default', suffix);
        }
      };
      g.k.__patchedByTenant = true;
      g.k.__old = oldK;
      console.info('[iframes-persist] k() est√° TENANT-aware.');
    } else if (typeof g.k !== 'function') {
      g.k = function(suffix){
        const sec = (typeof g.currentSection === 'string' && g.currentSection) ? g.currentSection : 'default';
        return nsKey(sec, suffix);
      };
      g.k.__patchedByTenant = true;
      console.info('[iframes-persist] k() injetado (TENANT-aware).');
    }

    // Migra√ß√£o (uma vez): legacy -> TENANT
    async function migrateOnce(){
      try {
        const section = (typeof g.currentSection === 'string' && g.currentSection) ? g.currentSection : 'default';
        const newKey = nsKey(section, 'widgets');
        const oldKey = legacyKey(section, 'widgets');

        g.USER_DATA = g.USER_DATA || {};
        if (Array.isArray(g.USER_DATA[newKey])) return; // j√° migrado

        let legacy = Array.isArray(g.USER_DATA[oldKey]) ? g.USER_DATA[oldKey] : null;

        // Ultra-legacy (widget-0-title/url/...)
        if (!legacy) {
          const ultra = [];
          const keys = Object.keys(g.USER_DATA || {});
          const grouped = {};
          keys.forEach(key => {
            const m = key.match(/^widget-(\d+)-(title|url|embed|h|order|id)$/i);
            if (m) {
              const idx = m[1], prop = m[2];
              grouped[idx] = grouped[idx] || {};
              grouped[idx][prop] = g.USER_DATA[key];
            }
          });
          Object.keys(grouped).sort((a,b)=> (+a)-(+b)).forEach(idx => {
            const w = grouped[idx];
            if (w && (w.title || w.url || w.embed)) {
              ultra.push({
                id: w.id || mkUUID(),
                title: w.title || '',
                url: w.url || '',
                embed: w.embed || '',
                h: w.h,
                order: (typeof w.order === 'number') ? w.order : (+idx)||0
              });
            }
          });
          if (ultra.length) legacy = ultra;
        }

        if (Array.isArray(legacy) && legacy.length) {
          const normalized = legacy.map((w,i)=> ({
            id: w.id || mkUUID(),
            title: w.title || '',
            url: w.url || '',
            embed: w.embed || '',
            h: w.h,
            order: (typeof w.order === 'number') ? w.order : i
          }));
          g.USER_DATA[newKey] = normalized;
          g.USER_DATA[oldKey] = legacy; // compat
          await writeUserDoc({ [newKey]: normalized, [oldKey]: legacy });
          console.info('[iframes-persist] Migrado para TENANT:', newKey);
        }
      } catch(e){
        console.warn('[iframes-persist] Migra√ß√£o ignorada:', e);
      }
    }

    async function defaultLoadWidgets(){
      const section = (typeof g.currentSection === 'string' && g.currentSection) ? g.currentSection : 'default';
      const key = nsKey(section, 'widgets');
      g.USER_DATA = g.USER_DATA || {};

      let arr = Array.isArray(g.USER_DATA[key]) ? g.USER_DATA[key] : null;
      if (!arr || !arr.length) {
        await migrateOnce();
        arr = Array.isArray(g.USER_DATA[key]) ? g.USER_DATA[key] : null;
      }
      if (!arr || !arr.length) {
        arr = [{ id: mkUUID(), title: 'Widget 1', url: '' }];
        g.USER_DATA[key] = arr;
        await writeUserDoc({ [key]: arr });
      }
      arr = arr.map((w,i)=> ({
        id: w.id || mkUUID(),
        title: w.title || '',
        url: w.url || '',
        embed: w.embed || '',
        h: w.h,
        order: (typeof w.order === 'number') ? w.order : i
      })).sort((a,b)=> (a.order||0)-(b.order||0));

      g.WIDGETS = arr;
      return arr;
    }

    async function defaultPersistWidgets(){
      const uid = g.auth?.currentUser?.uid;
      if (!uid) return;
      const section = (typeof g.currentSection === 'string' && g.currentSection) ? g.currentSection : 'default';
      const key = nsKey(section, 'widgets');

      g.WIDGETS = Array.isArray(g.WIDGETS) ? g.WIDGETS : [];
      g.WIDGETS = g.WIDGETS.map((w,i)=> ({ ...w, id: w.id || mkUUID(), order: i }));
      g.USER_DATA = g.USER_DATA || {};
      g.USER_DATA[key] = g.WIDGETS;

      await writeUserDoc({ [key]: g.WIDGETS });
    }

    // ‚ÄúEnvolve‚Äù fun√ß√µes existentes; se n√£o houver, fornece padr√£o
    let hookedLoad = false, hookedPersist = false;
    if (typeof g.loadWidgetsFromData === 'function' && !g.loadWidgetsFromData.__patchedByTenant) {
      const oldLoad = g.loadWidgetsFromData;
      g.loadWidgetsFromData = async function(){
        await migrateOnce();
        try { await oldLoad.apply(this, arguments); } catch(e){ /* continua */ }
        await defaultLoadWidgets(); // garante namespace/normaliza√ß√£o
        return g.WIDGETS;
      };
      g.loadWidgetsFromData.__patchedByTenant = true;
      g.loadWidgetsFromData.__old = oldLoad;
      hookedLoad = true;
      console.info('[iframes-persist] loadWidgetsFromData() hook aplicado.');
    }
    if (typeof g.persistWidgets === 'function' && !g.persistWidgets.__patchedByTenant) {
      const oldPersist = g.persistWidgets;
      g.persistWidgets = async function(){
        try { await oldPersist.apply(this, arguments); } catch(e){ /* continua */ }
        await defaultPersistWidgets(); // grava no namespace TENANT
      };
      g.persistWidgets.__patchedByTenant = true;
      g.persistWidgets.__old = oldPersist;
      hookedPersist = true;
      console.info('[iframes-persist] persistWidgets() hook aplicado.');
    }
    if (!hookedLoad)  g.loadWidgetsFromData  = defaultLoadWidgets;
    if (!hookedPersist) g.persistWidgets     = defaultPersistWidgets;

    // Aviso opcional quando o site bloqueia iframe (X-Frame-Options/CSP)
    try {
      const observer = new MutationObserver((mutations)=>{
        mutations.forEach(m=>{
          m.addedNodes && Array.from(m.addedNodes).forEach(node=>{
            if (node && node.tagName === 'IFRAME') {
              node.addEventListener('error', ()=>{
                const wrap = document.createElement('div');
                wrap.style.padding = '12px';
                wrap.style.border = '1px dashed #999';
                wrap.style.borderRadius = '8px';
                wrap.style.fontSize = '12px';
                wrap.style.marginTop = '6px';
                wrap.innerHTML = 'Este conte√∫do bloqueou o carregamento em iframe (X-Frame-Options/CSP). <a href="'+(node.src||'#')+'" target="_blank" rel="noopener">Abrir em nova aba</a>';
                node.parentNode && node.parentNode.insertBefore(wrap, node.nextSibling);
              }, { once:true });
            }
          });
        });
      });
      observer.observe(document.documentElement || document.body, { childList:true, subtree:true });
    } catch(e){ /* opcional */ }

    // Carrega assim que o usu√°rio estiver autenticado (login inalterado)
    if (hasFirebase) {
      if (g.auth?.currentUser) {
        defaultLoadWidgets();
      } else if (typeof g.auth?.onAuthStateChanged === 'function') {
        g.auth.onAuthStateChanged(function(u){
          if (u) defaultLoadWidgets();
        });
      }
    }
  } catch (err) {
    console.warn('[iframes-persist] Erro no patch:', err);
  }
})();
</script>
<!-- ========== /PATCH ========== -->
<!-- MG IFRAME PERSISTENCE PATCH v1.2 | Keeps iframe widgets permanently saved (Firestore + localStorage fallback) -->
<script>
(function(){
  if(window.__MG_IFRAME_PERSIST_PATCH__) return; // avoid double injection
  window.__MG_IFRAME_PERSIST_PATCH__ = true;

  const LS_KEY = "mg_iframes_backup_v2";
  const GRID_SELECTOR = ".widgets-grid";
  const CARD_SELECTOR = ".widget-card";
  const IFRAME_SELECTOR = "iframe.widget-iframe";
  const FRAME_SHELL_CLASS = "frame-shell";
  const META_ATTR_ID = "data-wid";

  function $(sel, root){ return (root||document).querySelector(sel); }
  function $all(sel, root){ return Array.from((root||document).querySelectorAll(sel)); }

  function log(){ try{ console.log("[MG-PERSIST]", ...arguments); }catch(_){ } }

  function uid(){ return (window.auth && window.auth.currentUser) ? window.auth.currentUser.uid : null; }
  function now(){ return Date.now(); }

  // ----- helpers to read/write Firestore if available -----
  async function saveToFirestore(snapshot){
    try{
      if(!(window.db && window.doc && window.setDoc && window.serverTimestamp && uid())) return false;
      const ref = window.doc(window.db, "usuarios", uid(), "settings", "iframes");
      await window.setDoc(ref, { widgets: snapshot, updatedAt: window.serverTimestamp() }, { merge: true });
      return true;
    }catch(e){ console.warn("Firestore save error", e); return false; }
  }
  async function loadFromFirestore(){
    try{
      if(!(window.db && window.doc && window.getDoc && uid())) return null;
      const ref = window.doc(window.db, "usuarios", uid(), "settings", "iframes");
      const snap = await window.getDoc(ref);
      if(snap && snap.exists && snap.exists()){ 
        const data = snap.data && snap.data() || {};
        return Array.isArray(data.widgets) ? data.widgets : null;
      }
      return null;
    }catch(e){ console.warn("Firestore load error", e); return null; }
  }

  function saveToLocal(snapshot){
    try{ localStorage.setItem(LS_KEY, JSON.stringify({t:now(), widgets:snapshot})); }catch(_){}
  }
  function loadFromLocal(){
    try{ const raw = localStorage.getItem(LS_KEY); if(!raw) return null;
      const obj = JSON.parse(raw); return Array.isArray(obj.widgets) ? obj.widgets : null;
    }catch(_){ return null; }
  }

  // build a serializable snapshot of current iframe widgets
  function takeSnapshot(){
    const grid = $(GRID_SELECTOR); if(!grid) return [];
    const out = [];
    $all(CARD_SELECTOR, grid).forEach((card, idx)=>{
      try{
        const iframe = $(IFRAME_SELECTOR, card);
        const shell = $("."+FRAME_SHELL_CLASS, card) || card;
        const titleEl = $(".widget-title", card);
        const title = titleEl ? titleEl.textContent.trim() : "";
        const src = iframe ? iframe.getAttribute("src") || "" : "";
        if(!src) return;
        const h = (shell && shell.style && shell.style.height) ? shell.style.height : "";
        const id = card.getAttribute(META_ATTR_ID) || ("w"+(idx+1));
        out.push({ id, title, src, height: h });
      }catch(_){}
    });
    return out;
  }

  function createCard(w){
    const id = w.id || ("w"+Math.random().toString(36).slice(2,7));
    const title = (w.title || "Widget");
    const src = w.src || "";
    const h = w.height || "720px";

    const card = document.createElement("div");
    card.className = "widget-card";
    card.setAttribute(META_ATTR_ID, id);

    const head = document.createElement("div");
    head.className = "widget-head";
    const titleSpan = document.createElement("div");
    titleSpan.className = "widget-title";
    titleSpan.textContent = title;
    const meta = document.createElement("div");
    meta.className = "widget-meta";
    meta.textContent = "iframe persistente";
    head.appendChild(titleSpan);
    head.appendChild(meta);

    const shell = document.createElement("div");
    shell.className = FRAME_SHELL_CLASS;
    shell.style.height = h;

    const iframe = document.createElement("iframe");
    iframe.className = "widget-iframe";
    iframe.setAttribute("src", src);
    iframe.setAttribute("loading", "lazy");
    iframe.setAttribute("referrerpolicy", "no-referrer-when-downgrade");
    iframe.setAttribute("allowfullscreen", "true");
    iframe.setAttribute("sandbox", "allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox");

    shell.appendChild(iframe);
    card.appendChild(head);
    card.appendChild(shell);
    return card;
  }

  function renderSnapshot(widgets){
    const grid = $(GRID_SELECTOR); if(!grid) return false;
    if(!Array.isArray(widgets) || widgets.length===0) return false;
    // If grid already has many iframes, don't duplicate ‚Äî only hydrate when empty
    const current = $all(IFRAME_SELECTOR, grid);
    if(current.length > 0) { log("Grid already has iframes, skip hydration."); return false; }
    const frag = document.createDocumentFragment();
    widgets.forEach(w => { frag.appendChild(createCard(w)); });
    grid.appendChild(frag);
    log("Hydrated", widgets.length, "iframes from persistence.");
    return true;
  }

  // Debounced auto-save on DOM mutations within widgets-grid
  let saveTimer = null;
  function scheduleSave(){
    clearTimeout(saveTimer);
    saveTimer = setTimeout(async ()=>{
      const snap = takeSnapshot();
      if(!snap.length) return;
      saveToLocal(snap);
      await saveToFirestore(snap);
      log("Snapshot saved", snap);
    }, 700);
  }

  function initMutationObserver(){
    const grid = $(GRID_SELECTOR); if(!grid) return;
    const mo = new MutationObserver((mutList)=>{
      let changed = false;
      for(const m of mutList){
        if(m.type === "childList"){
          changed = true; break;
        }
        if(m.type === "attributes" && (m.target.matches(IFRAME_SELECTOR) || m.target.classList.contains(FRAME_SHELL_CLASS))){
          changed = true; break;
        }
      }
      if(changed) scheduleSave();
    });
    mo.observe(grid, { childList: true, subtree: true, attributes: true, attributeFilter: ["src", "style"] });
    window.addEventListener("beforeunload", ()=>{
      const snap = takeSnapshot();
      if(snap.length){ saveToLocal(snap); }
    });
  }

  async function hydrate(){
    // Try Firestore (if logged), else localStorage
    let widgets = null;
    if(uid()){ widgets = await loadFromFirestore(); }
    if(!widgets || !widgets.length){ widgets = loadFromLocal(); }
    if(widgets && widgets.length){
      renderSnapshot(widgets);
    }
  }

  function onAuthChanged(){
    // whenever auth changes, attempt hydration and set up observer
    hydrate();
    initMutationObserver();
  }

  // If Firebase Auth is available, wait for state; else run immediately
  try{
    if(window.onAuthStateChanged && window.auth){
      window.onAuthStateChanged(window.auth, ()=>{ onAuthChanged(); });
    }else{
      // no auth: still persist locally
      onAuthChanged();
    }
  }catch(e){
    console.warn("Auth hook error", e);
    onAuthChanged();
  }
})();
</script>
<!-- === Demandas: resumo flutuante === -->
<div id="notificationWidget" class="notification-widget" aria-live="polite">
  <div id="notificationPanel" class="notification-panel" role="region" aria-label="Notifica√ß√µes">
    <div class="notification-header">
      <h3 class="notification-title">Notifica√ß√µes</h3>
      <button type="button" class="notification-clear" id="notificationMarkRead">Marcar como lidas</button>
    </div>
    <div class="notification-list" id="notificationList"></div>
    <div class="notification-empty" id="notificationEmpty" hidden>Tudo em dia por aqui! Cadastre novas demandas, metas ou posts para receber alertas.</div>
  </div>
  <button id="notificationButton" class="notification-button" type="button" aria-haspopup="true" aria-expanded="false" aria-controls="notificationPanel" title="Abrir notifica√ß√µes">
    <span class="notification-icon" aria-hidden="true">üîî</span>
    <span id="notificationBadge" class="notification-badge" hidden>0</span>
  </button>
</div>
<div id="mg-iframe-container"></div>
<!-- === MediaGrowth: Firebase iFrames Persist (per user/email + per client) === -->
<script type="module">
// ===== 1) Cole seu firebaseConfig aqui =====
const firebaseConfig = {
  apiKey: "COLE_AQUI",
  authDomain: "COLE_AQUI.firebaseapp.com",
  projectId: "COLE_AQUI",
  storageBucket: "COLE_AQUI.appspot.com",
  messagingSenderId: "COLE_AQUI",
  appId: "COLE_AQUI"
};

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { 
  getFirestore, enableIndexedDbPersistence, collection, addDoc, onSnapshot, 
  deleteDoc, doc, serverTimestamp, query, orderBy, getDocs, writeBatch 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
enableIndexedDbPersistence(db).catch(()=>{});

// ===== Util =====
const qs = new URLSearchParams(location.search);
const pathClient = location.pathname.replace(/^\/+/, '').split('/')[0];
let clientKey = (typeof window.TENANT === 'string' && window.TENANT)
  || document.body.getAttribute('data-client-id')
  || qs.get('client')
  || pathClient;
if (!clientKey) {
  console.warn('Cliente n√£o definido na URL; usando chave "no-client".');
  clientKey = 'no-client';
}
try { document.body.setAttribute('data-client-id', clientKey); } catch(_) {}
const adminParam = (qs.get('iframeAdmin') === '1') || localStorage.getItem('mg_iframe_admin') === '1';
const container = document.getElementById('mg-iframe-container');
function sanitizeSrc(raw){ try{ const u=new URL(raw.trim()); return u.toString(); }catch(e){ return (raw||'').trim(); } }
function renderList(list){
  container.innerHTML='';
  list.forEach(item=>{
    const wrap=document.createElement('div');
    wrap.className='mg-iframe-wrap';
    wrap.style.position='relative'; wrap.style.margin='12px 0';
    if(item.title){
      const h=document.createElement('div'); h.textContent=item.title;
      h.style.margin='6px 0'; h.style.fontWeight='600'; h.style.color='#ddd'; wrap.appendChild(h);
    }
    const f=document.createElement('iframe'); f.src=item.src; f.width='100%'; f.height='640'; f.loading='lazy'; f.style.border='1px solid #333'; wrap.appendChild(f);
    const rm=document.createElement('button'); rm.textContent='Remover'; rm.className='mg-remove';
    rm.style.cssText='display:none;position:absolute;top:8px;right:8px;background:#000a;color:#fff;border:1px solid #fff3;border-radius:8px;padding:6px 10px;font-size:12px;cursor:pointer';
    rm.addEventListener('click', async ()=>{ if(!window.mgCloud.ctx) return; await deleteDoc(window.mgCloud.docRef(item.id)); });
    wrap.appendChild(rm);
    container.appendChild(wrap);
  });
  document.body.classList.toggle('mg-admin', adminParam);
  Array.from(document.querySelectorAll('.mg-remove')).forEach(b=> b.style.display = adminParam ? 'inline-block' : 'none');
}

// ===== Cloud ctx (USERS path) =====
window.mgCloud = {
  ctx:null,
  docRef:(id)=>{ const {uid}=window.mgCloud.ctx; return doc(db,'usuarios',uid,'clients',clientKey,'iframes',id); },
  async add(src,title){ if(!window.mgCloud.ctx) return alert('Fa√ßa login para salvar na nuvem.'); await addDoc(window.mgCloud.ctx.colRef,{src:sanitizeSrc(src),title:title||'',createdAt:serverTimestamp()}); },
  async importLocalStorage(){
    if(!window.mgCloud.ctx) return;
    const key='mg_iframes_'+clientKey;
    let local=[]; try{ local=JSON.parse(localStorage.getItem(key))||[]; }catch(e){}
    if(!local.length) return alert('Nada no localStorage.');
    const snap=await getDocs(window.mgCloud.ctx.colRef); const existing=new Set(); snap.forEach(d=> existing.add((d.get('src')||'').trim()));
    const batch=writeBatch(db); let count=0;
    local.forEach(it=>{ const src=sanitizeSrc(it.src||''); if(!src || existing.has(src)) return; const ref=doc(window.mgCloud.ctx.colRef); batch.set(ref,{src,title:it.title||'',createdAt:serverTimestamp()}); count++; });
    if(count>0){ await batch.commit(); alert('Importados '+count+' iFrames.'); } else { alert('Nada novo para importar.'); }
  }
};

// ===== Auth + snapshot =====
onAuthStateChanged(auth, (user)=>{
  if(user){
    const colRef = collection(db,'usuarios',user.uid,'clients',clientKey,'iframes');
    const q = query(colRef, orderBy('createdAt'));
    if(window.mgCloud.ctx && window.mgCloud.ctx.unsub){ window.mgCloud.ctx.unsub(); }
    const unsub = onSnapshot(q, snap=>{
      const list=[]; snap.forEach(d=> list.push({ id:d.id, ...d.data() }));
      renderList(list);
    });
    window.mgCloud.ctx = { uid:user.uid, colRef, unsub };
    if(qs.get('import')==='1'){ window.mgCloud.importLocalStorage(); }
  }else{
    renderList([]);
  }
});

// ===== Importar <iframe data-persist="true"> do DOM para localStorage =====
(function importDOM(){
  if(qs.get('import')!=='1') return;
  const key='mg_iframes_'+clientKey;
  const existing=Array.from(document.querySelectorAll('iframe[data-persist="true"]'));
  if(!existing.length) return;
  let local=[]; try{ local=JSON.parse(localStorage.getItem(key))||[]; }catch(e){}
  existing.forEach(el=>{ const src=el.getAttribute('src')||''; const title=el.getAttribute('title')||el.getAttribute('data-title')||''; if(src) local.push({src,title}); });
  const seen=new Set(); const out=[]; local.forEach(it=>{ const s=(it.src||'').trim(); if(s && !seen.has(s)){ seen.add(s); out.push({src:s,title:it.title||''}); }});
  localStorage.setItem(key, JSON.stringify(out));
  alert('iFrames do DOM adicionados ao localStorage. Clique "Importar do localStorage" para enviar ao Firebase.');
})();
</script>
<!-- === /MediaGrowth: Firebase iFrames Persist === -->

<!-- PATCH Macro: remover apenas as barras (widget-input) do PRIMEIRO card da aba Macro -->
<script>
(function(){
  "use strict";
  function isMacroActive(){
    var btn = document.querySelector('.tabs [role="tab"].active, .tab-btn.active');
    var txt = btn ? (btn.textContent||"").toLowerCase() : "";
    return txt.indexOf("macro") !== -1;
  }
  function getMacroGrid(){
    return document.querySelector('#widgetsGrid-macro, [data-section="macro"].widgets-grid')
        || document.querySelector('#widgetsGrid')
        || document.querySelector('.widgets-grid');
  }
  function removeMacroBars(){
    if (!isMacroActive()) return;
    var grid = getMacroGrid();
    if (!grid) return;
    var first = grid.querySelector('.widget-card');
    if (!first) return;
    var input = first.querySelector('.widget-input');
    if (input) input.remove();
  }
  document.addEventListener('DOMContentLoaded', function(){
    // aplica em loop curto para cobrir re-render inicial
    var tries = 0;
    var iv = setInterval(function(){
      tries++;
      removeMacroBars();
      if (tries > 30) clearInterval(iv);
    }, 100);
  });
  // observa mudan√ßas (re-renderiza√ß√µes)
  var mo = new MutationObserver(function(){ try{ removeMacroBars(); }catch(e){} });
  mo.observe(document.documentElement, { childList: true, subtree: true });
})();
</script>


<!-- PATCH Macro v4: remover header + barras (widget-input) + iframe do PRIMEIRO card da aba Macro -->
<script>
(function(){
  "use strict";
  function isMacroActive(){
    var btn = document.querySelector('.tabs [role="tab"].active, .tab-btn.active');
    var txt = btn ? (btn.textContent||"").toLowerCase() : "";
    return txt.indexOf("macro") !== -1;
  }
  function getMacroGrid(){
    return document.querySelector('#widgetsGrid-macro, [data-section="macro"].widgets-grid')
        || document.querySelector('#widgetsGrid')
        || document.querySelector('.widgets-grid');
  }
  function nukeFirstMacroCardBits(){
    if (!isMacroActive()) return;
    var grid = getMacroGrid();
    if (!grid) return;
    var first = grid.querySelector('.widget-card');
    if (!first) return;

    // 1) header
    var head = first.querySelector('.widget-head');
    if (head) head.remove();

    // 2) barras (inputs)
    var input = first.querySelector('.widget-input');
    if (input) input.remove();

    // 3) iframe e container
    var shell = first.querySelector('.frame-shell');
    if (shell) shell.remove();
    var ifr = first.querySelector('iframe');
    if (ifr) ifr.remove();
  }

  // roda v√°rias vezes no in√≠cio para cobrir re-render inicial
  document.addEventListener('DOMContentLoaded', function(){
    var tries = 0;
    var iv = setInterval(function(){
      tries++;
      nukeFirstMacroCardBits();
      if (tries > 40) clearInterval(iv); // ~4s
    }, 100);
  });

  // observa mudan√ßas e reaplica
  var mo = new MutationObserver(function(){ try{ nukeFirstMacroCardBits(); }catch(e){} });
  mo.observe(document.documentElement, { childList: true, subtree: true });

  // utilit√°rio manual
  window.__nukeFirstMacroCardBits = nukeFirstMacroCardBits;
})();
</script>




<!-- === Tenant slug routing (per-user URL like /empresa) === -->
<script>
(function(){
  if(window.__MG_SLUG_ROUTER_INSTALLED__) return;
  window.__MG_SLUG_ROUTER_INSTALLED__ = true;

  function slugifyEmail(email){
    if(!email) return '';
    const local = email.split('@')[0] || '';
    return local
      .normalize('NFD').replace(/[ÃÄ-ÕØ]/g,'')
      .toLowerCase()
      .replace(/[^a-z0-9]+/g,'-')
      .replace(/(^-|-$)/g,'');
  }

  async function getOrCreateUserSlug(uid, email){
    try{
      const ref = doc(db, 'usuarios', uid);
      const snap = await getDoc(ref);
      let slug = snap.exists() && snap.data()?.slug;
      if(!slug){
        slug = slugifyEmail(email) || ('user-' + (uid||'').slice(0,6));
        await setDoc(ref, { slug }, { merge: true });
      }
      return slug;
    }catch(e){
      console.error('slug profile error', e);
      return slugifyEmail(email) || ('user-' + (uid||'').slice(0,6));
    }
  }

  async function resolveTenantFromPathOrProfile(user){
    const pathSlug = (location.pathname || '/').replace(/^\/+/, '').split('/')[0] || '';
    const profileSlug = await getOrCreateUserSlug(user.uid, user.email || '');
    if(!pathSlug || pathSlug !== profileSlug){
      history.replaceState({}, '', '/' + profileSlug);
    }
    TENANT = profileSlug;
    window.TENANT = profileSlug;
    document.documentElement.dataset.tenant = profileSlug;
    try { document.body.setAttribute('data-client-id', profileSlug); } catch(_) {}
    return profileSlug;
  }

  async function guardRouteForUser(user){
    try{
      const ref = doc(db, 'usuarios', user.uid);
      const snap = await getDoc(ref);
      const mySlug = (snap.exists() && snap.data()?.slug) || slugifyEmail(user.email||'');
      const pathSlug = (location.pathname||'/').replace(/^\/+/, '').split('/')[0] || '';
      if(pathSlug && pathSlug !== mySlug){
        history.replaceState({}, '', '/' + mySlug);
        if(typeof mgToast === 'function'){ mgToast('Sem acesso a /' + pathSlug + '. Redirecionado para seu painel.'); }
      }
      TENANT = mySlug;
      window.TENANT = mySlug;
      document.documentElement.dataset.tenant = mySlug;
      try { document.body.setAttribute('data-client-id', mySlug); } catch(_) {}
      if(typeof loadClientProfile === 'function'){
        try{ await loadClientProfile(); }
        catch(err){ console.warn('profile logo sync', err); }
      }
      return mySlug;
    }catch(e){
      console.error('guardRoute error', e);
    }
  }

  // Listen to auth changes without interfering with existing handlers
  (function attachSlugAuthListener(){
    if(!window.__MG_SLUG_ONAUTH_PATCHED__){
      window.__MG_SLUG_ONAUTH_PATCHED__ = true;
      if(typeof onAuthStateChanged === 'function' && typeof auth !== 'undefined'){
        try{
          onAuthStateChanged(auth, async (user) => {
            if(user){
              try{
                await resolveTenantFromPathOrProfile(user);
                await guardRouteForUser(user);
                if(typeof ensureCalendar === 'function'){ try{ ensureCalendar(); }catch(_e){} }
                // Rehydrate UI data now that TENANT is confirmed
                try{ if(typeof loadBriefFromUserData === 'function') loadBriefFromUserData(); }catch(_e){}
                try{ if(typeof renderDashboard === 'function') renderDashboard(USER_DATA); }catch(_e){}
                try{ if(typeof buildTabs === 'function') buildTabs(); }catch(_e){}
                try{ if(typeof loadNotesFromUserData === 'function') loadNotesFromUserData(); }catch(_e){}
                try{ if(typeof loadNoteTemplatesFromUserData === 'function') loadNoteTemplatesFromUserData(); }catch(_e){}
                try{ if(typeof loadAccessesFromUserData === 'function') loadAccessesFromUserData(); }catch(_e){}
                try{ if(typeof rerenderBySection === 'function') rerenderBySection(); }catch(_e){}
              }catch(err){ console.error('slug flow', err); }
            }else{
              history.replaceState({}, '', '/');
              TENANT = getTenantFromHostOrPath();
              window.TENANT = TENANT;
              document.documentElement.dataset.tenant = TENANT;
              try { document.body.setAttribute('data-client-id', TENANT); } catch(_) {}
            }
          });
        }catch(e){ console.warn('Could not attach onAuthStateChanged slug listener', e); }
      }else{
        // Retry once after DOM ready in case libs load later
        document.addEventListener('DOMContentLoaded', function(){
          if(typeof onAuthStateChanged === 'function' && typeof auth !== 'undefined'){
            try{
              onAuthStateChanged(auth, async (user) => {
                if(user){
                  try{
                    await resolveTenantFromPathOrProfile(user);
                    await guardRouteForUser(user);
                    if(typeof ensureCalendar === 'function'){ try{ ensureCalendar(); }catch(_e){} }
                  }catch(err){ console.error('slug flow late', err); }
                }else{
                  history.replaceState({}, '', '/');
                  TENANT = getTenantFromHostOrPath();
                  window.TENANT = TENANT;
                  document.documentElement.dataset.tenant = TENANT;
                  try { document.body.setAttribute('data-client-id', TENANT); } catch(_) {}
                }
              });
            }catch(e){ console.warn('Late attach failed', e); }
          }
        });
      }
    }
  })();

  // Keep TENANT synced when user uses back/forward navigation
  window.addEventListener('popstate', () => {
    const pathSlug = (location.pathname||'/').replace(/^\/+/, '').split('/')[0] || '';
    if(pathSlug){
      TENANT = pathSlug;
      window.TENANT = pathSlug;
      document.documentElement.dataset.tenant = pathSlug;
      try { document.body.setAttribute('data-client-id', pathSlug); } catch(_) {}
      if(typeof loadClientProfile === 'function'){
        try{ loadClientProfile(); }
        catch(err){ console.warn('profile logo popstate', err); }
      }
    }
  });
})();
</script>
<!-- === end Tenant slug routing === -->
</body>
<script type="module">
/* ===== 1) Firebase config ‚Äì COLE OS SEUS DADOS ===== */
const firebaseConfig = {
¬† apiKey: "AIzaSyD4CbPQWrwOcfANX3ar0ibmGN20ffsRCqo",
¬† authDomain: "mediagrowth-a5349.firebaseapp.com",
¬† projectId: "mediagrowth-a5349",
¬† storageBucket: "mediagrowth-a5349.firebasestorage.app",
¬† messagingSenderId: "1074237637946",
¬† appId: "1:1074237637946:web:cf5008b649bbb4d7d13c03"
};

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, enableIndexedDbPersistence, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);
// tornar auth acess√≠vel globalmente (planilha Macro depende)
window.auth = auth;
window.onAuthStateChanged = onAuthStateChanged;
enableIndexedDbPersistence(db).catch(()=>{});

/* ===== 2) Cliente (por URL ?client=... ou data-client-id no <body>) ===== */
const qs = new URLSearchParams(location.search);
const pathClient = location.pathname.replace(/^\/+/, '').split('/')[0];
let clientKey = (typeof window.TENANT === 'string' && window.TENANT)
  || document.body.getAttribute('data-client-id')
  || qs.get('client')
  || pathClient;
if (!clientKey) {
  console.warn('Cliente n√£o definido na URL; usando chave "no-client".');
  clientKey = 'no-client';
}
try { document.body.setAttribute('data-client-id', clientKey); } catch(_) {}

/* ===== 3) Utilidades ===== */
function $all(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }
function normalize(src){ try{ return new URL((src||'').trim()).toString(); } catch { return (src||'').trim(); } }
function domPath(el){
  // caminho est√°vel para gerar ID do doc por campo
  const parts=[]; while(el && el.nodeType===1 && el!==document.body){
    const tag = el.tagName.toLowerCase(); let i=1, s=el;
    while((s=s.previousElementSibling)) if(s.tagName===el.tagName) i++;
    parts.unshift(`${tag}:${i}`); el = el.parentElement;
  } return parts.join('/');
}
function djb2(str){ let h=5381; for(let i=0;i<str.length;i++){ h=((h<<5)+h)+str.charCodeAt(i);} return (h>>>0).toString(36); }
function keyForInput(input){
  const wrap = input.closest('.widget-card'); // estrutura do seu projeto
  const base = [
    wrap ? ('wid:' + (wrap.getAttribute('data-widget-id')||'auto')) : '',
    input.name ? ('name:'+input.name) : '',
    input.id   ? ('id:'+input.id)     : '',
    input.getAttribute('placeholder') || '',
    domPath(input)
  ].join('|');
  return 'w_' + djb2(base);
}
function findOrCreateIframeFor(input){
  // tenta achar um iframe do pr√≥prio widget; se n√£o existir, cria logo abaixo
  const wrap = input.closest('.widget-card');
  let ifr = wrap?.querySelector('.frame-shell .widget-iframe');
  if(!ifr){
    const shell = wrap?.querySelector('.frame-shell');
    if(shell){
      ifr = document.createElement('iframe');
      ifr.className = 'widget-iframe';
      ifr.style.cssText = 'width:100%;height:100%;border:0;background:transparent';
      shell.innerHTML = ''; shell.appendChild(ifr);
    }else{
      // fallback: cria abaixo do input
      ifr = document.createElement('iframe');
      ifr.style.cssText = 'width:100%;height:560px;border:1px solid #333;background:#000;margin:6px 0';
      input.insertAdjacentElement('afterend', ifr);
    }
  }
  return ifr;
}

/* ===== 4) Bind em todos os campos de link =====
   Ele considera inputs cujo placeholder contenha ‚ÄúCole o link‚Äù ou ‚Äúhttps://‚Äù */
let ctx = { uid:null };
function bindInput(input){
  if(input.dataset.mgBound==='1') return;
  const ph = (input.getAttribute('placeholder')||'').toLowerCase();
  if(!ph.includes('cole o link') && !ph.includes('https://')) return;
  input.dataset.mgBound='1';

  const docId = keyForInput(input);
  input.dataset.docId = docId;

  function path(){ return ['usuarios', ctx.uid, 'clients', clientKey, 'iframes', docId]; }

  // 4.1 Restaurar do Firestore em tempo real
  function startSnapshot(){
    const ref = doc(db, ...path());
    onSnapshot(ref, snap=>{
      if(!snap.exists()) return;
      const src = snap.data().src || '';
      if(src && input.value.trim() !== src){ input.value = src; }
      const ifr = findOrCreateIframeFor(input);
      if(src && ifr.src !== src) ifr.src = src;
    });
  }

  // 4.2 Salvar (enter/blur/change)
  async function save(){
    if(!ctx.uid) return alert('Fa√ßa login para salvar os iFrames deste cliente.');
    const src = normalize(input.value);
    if(!src) return;
    const ref = doc(db, ...path());
    // tamb√©m escreve no localStorage (cache) para restaurar instant√¢neo
    const k = `mg_cache_${ctx.uid}_${clientKey}`;
    const cache = JSON.parse(localStorage.getItem(k) || '{}');
    cache[docId] = { src, updatedAt: Date.now() };
    localStorage.setItem(k, JSON.stringify(cache));
    // grava na nuvem
    await setDoc(ref, { src, updatedAt: Date.now() }, { merge: true });
    // mostra no iframe
    const ifr = findOrCreateIframeFor(input);
    ifr.src = src;
  }

  input.addEventListener('change', save);
  input.addEventListener('blur', save);
  input.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); save(); } });

  // 4.3 Restaura√ß√£o imediata do cache local (antes do snapshot)
  function restoreCache(){
    if(!ctx.uid) return;
    const k = `mg_cache_${ctx.uid}_${clientKey}`;
    const cache = JSON.parse(localStorage.getItem(k) || '{}');
    const hit = cache[docId];
    if(hit?.src){
      if(!input.value) input.value = hit.src;
      const ifr = findOrCreateIframeFor(input);
      if(!ifr.src) ifr.src = hit.src;
    }
  }

  if(ctx.uid){
    restoreCache();
    startSnapshot();
  }
}

/* ===== 5) Observar DOM e aplicar bind quando itens renderizam ===== */
function scan(){ $all('input,textarea').forEach(bindInput); }
const mo = new MutationObserver(scan);
mo.observe(document.documentElement, { childList:true, subtree:true });

/* ===== 6) Login ‚Üí ativa binds e snapshots ===== */
onAuthStateChanged(auth, user=>{
  ctx.uid = user ? user.uid : null;
  scan();
});
</script>

<!-- partial -->

<div id="noteWidget" style="display:none">
  <div id="noteIcon">üìù</div>
  <div id="noteTab">
    <textarea id="noteTextarea" placeholder="Escreva sua nota..."></textarea>
    <button id="noteClear">Apagar</button>
  </div>
</div>
<style>
  #noteWidget{position:fixed;bottom:10px;left:10px;display:flex;align-items:flex-end;z-index:100000;}
  #noteIcon{background:#000;color:#fff;border:1px solid #333;padding:8px 10px;border-radius:8px;cursor:pointer;}
  #noteTab{display:none;margin-left:8px;background:#000;padding:10px;border:1px solid #333;border-radius:10px;flex-direction:column;align-items:flex-end;}
  #noteTab.show{display:flex;}
  #noteTab textarea{width:300px;height:200px;background:#000;color:#fff;border:1px solid #666;border-radius:8px;padding:8px;}
  #noteTab button{margin-top:8px;background:#333;color:#fff;border:1px solid #555;border-radius:6px;padding:6px 12px;cursor:pointer;}

  .tabs,
  .widget-head,
  .frame-shell,
  [class$="-wrap"],
  [class$="Wrap"]{
    margin-left:var(--margin-left);
    margin-right:var(--margin-right);
    max-width:100%;
  }
</style>
<script>
  (function(){
    const icon=document.getElementById('noteIcon');
    const tab=document.getElementById('noteTab');
    const textarea=document.getElementById('noteTextarea');
    const clearBtn=document.getElementById('noteClear');
    const KEY='mg_note';
    textarea.value=localStorage.getItem(KEY)||'';
    textarea.addEventListener('input',()=>localStorage.setItem(KEY,textarea.value));
    clearBtn.addEventListener('click',()=>{textarea.value='';localStorage.removeItem(KEY);});
    icon.addEventListener('click',()=>tab.classList.toggle('show'));
  })();
</script>
</body>
</html>

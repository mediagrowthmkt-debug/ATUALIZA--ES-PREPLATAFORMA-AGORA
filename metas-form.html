<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Atualiza√ß√£o de Metas ‚Ä¢ MediaGrowth</title>
  <link rel="icon" type="image/png" href="favicon.png"/>
  <style>
    :root {
      color-scheme: dark;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top, rgba(56,189,248,0.12), transparent 55%), #0f172a;
      color: #f8fafc;
      min-height: 100vh;
      display: flex;
      justify-content: center;
    }
    .container {
      width: min(720px, 94vw);
      padding: 40px 0 60px;
      display: flex;
      flex-direction: column;
      gap: 28px;
    }
    header {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(59,130,246,0.16);
      border: 1px solid rgba(148,163,184,0.35);
      color: #bae6fd;
      font-weight: 700;
      letter-spacing: .06em;
      font-size: .75rem;
      text-transform: uppercase;
      border-radius: 999px;
      padding: 6px 14px;
      width: fit-content;
    }
    h1 {
      margin: 0;
      font-size: clamp(1.8rem, 3vw, 2.4rem);
      color: #e0f2fe;
    }
    p {
      margin: 0;
      font-size: 1rem;
      color: #cbd5f5;
      line-height: 1.6;
    }
    .status {
      min-height: 1.25rem;
      font-size: .9rem;
      color: #38bdf8;
    }
    .status.error {
      color: #f87171;
    }
    
    /* Wizard/Step styles */
    .wizard-container {
      display: flex;
      flex-direction: column;
      gap: 32px;
    }
    .progress-bar {
      background: rgba(15,23,42,0.65);
      border: 1px solid rgba(148,163,184,0.25);
      border-radius: 12px;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }
    .progress-text {
      font-size: .9rem;
      color: #cbd5f5;
      font-weight: 600;
    }
    .progress-steps {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .progress-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(148,163,184,0.3);
      transition: all 0.3s ease;
    }
    .progress-dot.completed {
      background: #4ade80;
      box-shadow: 0 0 8px rgba(74,222,128,0.5);
    }
    .progress-dot.current {
      background: #38bdf8;
      box-shadow: 0 0 12px rgba(56,189,248,0.6);
      transform: scale(1.3);
    }
    
    .meta-step {
      background: rgba(15,23,42,0.85);
      border: 2px solid rgba(56,189,248,0.4);
      border-radius: 20px;
      padding: 36px 32px;
      box-shadow: 0 20px 45px rgba(15,23,42,0.55), 0 0 0 1px rgba(56,189,248,0.1);
      display: flex;
      flex-direction: column;
      gap: 28px;
      animation: slideIn 0.4s ease;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .meta-step-header {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .meta-number {
      font-size: .85rem;
      font-weight: 800;
      letter-spacing: .08em;
      color: #38bdf8;
      text-transform: uppercase;
    }
    .meta-question {
      font-size: 1.5rem;
      font-weight: 700;
      color: #f8fafc;
      line-height: 1.4;
      margin: 0;
    }
    .meta-subtitle {
      font-size: .95rem;
      color: #94a3b8;
      margin: 0;
    }
    .meta-explanation {
      background: rgba(56,189,248,0.08);
      border-left: 3px solid #38bdf8;
      border-radius: 10px;
      padding: 14px 16px;
      font-size: .9rem;
      color: #bae6fd;
      line-height: 1.5;
      margin-top: 4px;
    }
    .meta-input-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .input-prefix, .input-suffix {
      font-size: 1.1rem;
      font-weight: 700;
      color: #38bdf8;
      white-space: nowrap;
    }
    input[type="number"].wizard-input {
      flex: 1;
      background: rgba(10,17,35,0.95);
      border: 2px solid rgba(148,163,184,0.4);
      border-radius: 14px;
      padding: 16px 20px;
      color: #f8fafc;
      font-size: 1.3rem;
      font-weight: 600;
      text-align: center;
      transition: all 0.3s ease;
    }
    input[type="number"].wizard-input:focus {
      outline: none;
      border-color: #38bdf8;
      box-shadow: 0 0 0 4px rgba(56,189,248,0.2), 0 8px 16px rgba(56,189,248,0.15);
      transform: scale(1.02);
    }
    input[type="number"].wizard-input::-webkit-outer-spin-button,
    input[type="number"].wizard-input::-webkit-inner-spin-button {
      appearance: none;
      margin: 0;
    }
    .current-value-display {
      background: rgba(56,189,248,0.1);
      border: 1px solid rgba(56,189,248,0.3);
      border-radius: 12px;
      padding: 14px 18px;
      font-size: .95rem;
      color: #bae6fd;
      text-align: center;
    }
    .wizard-actions {
      display: flex;
      gap: 12px;
      justify-content: space-between;
      margin-top: 8px;
    }
    .btn {
      padding: 14px 28px;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #38bdf8, #0ea5e9);
      color: #fff;
      box-shadow: 0 8px 20px rgba(56,189,248,0.35);
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(56,189,248,0.45);
    }
    .btn-secondary {
      background: rgba(148,163,184,0.15);
      color: #cbd5f5;
      border: 1px solid rgba(148,163,184,0.35);
    }
    .btn-secondary:hover {
      background: rgba(148,163,184,0.25);
    }
    .btn-approve {
      background: linear-gradient(135deg, #4ade80, #22c55e);
      color: #fff;
      box-shadow: 0 8px 20px rgba(74,222,128,0.35);
    }
    .btn-approve:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(74,222,128,0.45);
    }
    .btn-edit {
      background: rgba(251,191,36,0.15);
      color: #fbbf24;
      border: 1px solid rgba(251,191,36,0.4);
    }
    .btn-edit:hover {
      background: rgba(251,191,36,0.25);
    }
    .btn-skip {
      background: rgba(148,163,184,0.08);
      color: #94a3b8;
      border: 1px solid rgba(148,163,184,0.25);
      font-size: 0.9rem;
    }
    .btn-skip:hover {
      background: rgba(148,163,184,0.15);
      color: #cbd5e1;
    }
    .completion-screen {
      text-align: center;
      padding: 60px 32px;
      background: rgba(15,23,42,0.85);
      border: 2px solid rgba(74,222,128,0.4);
      border-radius: 20px;
      box-shadow: 0 20px 45px rgba(15,23,42,0.55);
      animation: slideIn 0.5s ease;
    }
    .completion-icon {
      font-size: 4rem;
      margin-bottom: 20px;
      animation: bounce 0.6s ease;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-15px); }
    }
    .completion-screen h2 {
      margin: 0 0 12px;
      font-size: 2rem;
      color: #4ade80;
    }
    .completion-screen p {
      font-size: 1.1rem;
      color: #cbd5f5;
      margin: 0 0 8px;
    }
    .hidden {
      display: none !important;
    }
    .empty-state, .loading, .error-section {
      text-align: center;
      padding: 80px 20px;
      color: #e0f2fe;
      font-size: 1.1rem;
    }
    .error-section h2 {
      margin: 0 0 10px;
      font-size: 1.6rem;
    }
    @media (max-width: 640px) {
      .container {
        padding: 28px 0 48px;
        gap: 22px;
      }
      .meta-step {
        padding: 28px 20px;
      }
      .meta-question {
        font-size: 1.3rem;
      }
      input[type="number"].wizard-input {
        font-size: 1.2rem;
        padding: 14px 16px;
      }
      .wizard-actions {
        flex-direction: column;
        gap: 10px;
      }
      .btn {
        width: 100%;
        justify-content: center;
      }
      .btn-skip {
        order: 3; /* Fica por √∫ltimo em mobile */
      }
      .btn-secondary {
        order: 2;
      }
      .btn-primary, .btn-approve, .btn-edit {
        order: 1; /* Ficam no topo em mobile */
      }
    }
  </style>
</head>
<body>
  <main class="container">
    <div id="loading" class="loading">Carregando dados das metas...</div>
    <section id="content" class="hidden">
      <header>
        <span class="badge">Atualiza√ß√£o de metas</span>
        <h1 id="pageTitle">Metas do cliente</h1>
        <p id="instructions">Responda uma pergunta por vez. Suas respostas s√£o salvas automaticamente.</p>
      </header>
      <div id="statusMessage" class="status"></div>
      <div id="wizardContainer" class="wizard-container"></div>
    </section>
    <section id="error" class="error-section hidden">
      <h2>Link indispon√≠vel</h2>
      <p id="errorMessage">N√£o foi poss√≠vel carregar este formul√°rio.</p>
    </section>
  </main>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD4CbPQWrwOcfANX3ar0ibmGN20ffsRCqo",
      authDomain: "mediagrowth-a5349.firebaseapp.com",
      projectId: "mediagrowth-a5349",
      storageBucket: "mediagrowth-a5349.firebasestorage.app",
      messagingSenderId: "1074237637946",
      appId: "1:1074237637946:web:cf5008b649bbb4d7d13c03"
    };

    const MONTH_LABELS = { 
      jan:'Janeiro', fev:'Fevereiro', mar:'Mar√ßo', abr:'Abril', 
      mai:'Maio', jun:'Junho', jul:'Julho', ago:'Agosto', 
      set:'Setembro', out:'Outubro', nov:'Novembro', dez:'Dezembro' 
    };

    const qs = new URLSearchParams(location.search);
    const token = qs.get('token') || qs.get('metasForm');
    const loadingEl = document.getElementById('loading');
    const contentEl = document.getElementById('content');
    const errorEl = document.getElementById('error');
    const errorMessageEl = document.getElementById('errorMessage');
    const statusEl = document.getElementById('statusMessage');
    const wizardContainerEl = document.getElementById('wizardContainer');
    const titleEl = document.getElementById('pageTitle');
    const instructionsEl = document.getElementById('instructions');

    if(!token){
      showError('O link informado √© inv√°lido. Solicite um novo link ao time da MediaGrowth.');
      throw new Error('Token ausente');
    }

    const app = getApps().find(a => a.name === 'metas-form') || initializeApp(firebaseConfig, 'metas-form');
    const db = getFirestore(app);
    const formRef = doc(db, 'metasForms', token);

    const state = {
      initialized: false,
      currentStep: 0,
      responses: {},
      docData: null,
      metas: [],
      monthKey: '',
      monthLabel: '',
      saveTimer: null,
      saving: false
    };

    function showError(message){
      loadingEl.classList.add('hidden');
      contentEl.classList.add('hidden');
      errorEl.classList.remove('hidden');
      errorMessageEl.textContent = message;
    }

    function showContent(){
      loadingEl.classList.add('hidden');
      errorEl.classList.add('hidden');
      contentEl.classList.remove('hidden');
    }

    function setStatus(message, isError=false){
      statusEl.textContent = message || '';
      statusEl.classList.toggle('error', !!isError);
    }

    function getUnitSymbol(unit){
      if(unit === 'BRL') return 'R$';
      if(unit === 'USD') return 'US$';
      if(unit === '%') return '%';
      if(unit === 'numero') return '';
      return '';
    }

    function getInputStep(unit){
      if(unit === 'numero') return '1';
      if(unit === '%') return '0.1';
      return '0.01';
    }

    function formatNumberDisplay(value, unit){
      if(value === null || value === undefined || value === '') return '‚Äî';
      const num = Number(value);
      if(!Number.isFinite(num)) return '‚Äî';
      if(unit === 'BRL') return num.toLocaleString('pt-BR', { style:'currency', currency:'BRL' });
      if(unit === 'USD') return num.toLocaleString('pt-BR', { style:'currency', currency:'USD' });
      if(unit === '%') return num.toLocaleString('pt-BR', { minimumFractionDigits:1, maximumFractionDigits:2 }) + '%';
      if(unit === 'numero') return num.toLocaleString('pt-BR', { minimumFractionDigits:0, maximumFractionDigits:0 });
      return num.toLocaleString('pt-BR', { minimumFractionDigits:0, maximumFractionDigits:2 });
    }

    function buildPayload(){
      const out = {};
      Object.entries(state.responses).forEach(([metaId, value]) => {
        if(value !== null && value !== undefined && value !== ''){
          const num = Number(value);
          if(Number.isFinite(num)){
            out[metaId] = { current: num };
          }
        }
      });
      return out;
    }

    function scheduleSave(){
      if(!state.initialized) return;
      setStatus('üíæ Salvando...');
      clearTimeout(state.saveTimer);
      state.saveTimer = setTimeout(runSave, 800);
    }

    async function runSave(){
      if(state.saving){
        scheduleSave();
        return;
      }
      clearTimeout(state.saveTimer);
      state.saveTimer = null;
      const payload = buildPayload();
      state.saving = true;
      try{
        await setDoc(formRef, {
          responses: payload,
          updatedAt: serverTimestamp()
        }, { merge: true });
        setStatus('‚úÖ Resposta salva automaticamente');
        setTimeout(() => setStatus(''), 2000);
      }catch(err){
        console.error('Erro ao salvar respostas', err);
        setStatus('‚ö†Ô∏è N√£o conseguimos salvar. Tentando novamente...', true);
        state.saveTimer = setTimeout(runSave, 3000);
      }finally{
        state.saving = false;
      }
    }

    function generateQuestion(meta){
      const desc = (meta.descricao || '').toLowerCase();
      const unit = meta.unidade || '';
      const symbol = getUnitSymbol(unit);
      
      // Mapeamento de perguntas personalizadas
      if(desc.includes('investimento') && desc.includes('tr√°fego')){
        return `Quanto voc√™ pretende investir em tr√°fego pago (an√∫ncios online)?`;
      }
      if(desc.includes('faturamento') || desc.includes('receita')){
        return `Qual √© a meta de faturamento para este m√™s?`;
      }
      if(desc.includes('vendas') || desc.includes('neg√≥cios fechados')){
        return `Quantas vendas voc√™ espera fechar este m√™s?`;
      }
      if(desc.includes('leads') || desc.includes('contatos')){
        return `Quantos novos contatos/leads voc√™ quer gerar?`;
      }
      if(desc.includes('ticket m√©dio')){
        return `Qual deve ser o valor m√©dio de cada venda?`;
      }
      if(desc.includes('taxa de convers√£o') || desc.includes('convers√£o')){
        return `Qual a taxa de convers√£o esperada?`;
      }
      if(desc.includes('roi') || desc.includes('retorno')){
        return `Qual o retorno sobre investimento (ROI) esperado?`;
      }
      if(desc.includes('custo') || desc.includes('despesa')){
        return `Qual o limite de custos para este m√™s?`;
      }
      
      // Pergunta gen√©rica
      if(unit === 'BRL' || unit === 'USD'){
        return `Qual a meta de "${meta.descricao}" para este m√™s?`;
      }
      if(unit === '%'){
        return `Qual a porcentagem esperada de "${meta.descricao}"?`;
      }
      if(unit === 'numero'){
        return `Quantos "${meta.descricao}" voc√™ espera alcan√ßar?`;
      }
      return `Qual a meta de "${meta.descricao}"?`;
    }

    function generateExplanation(meta){
      const desc = (meta.descricao || '').toLowerCase();
      
      // Explica√ß√µes personalizadas baseadas no documento do cliente
      if(desc.includes('investimento') && (desc.includes('tr√°fego') || desc.includes('publicidade'))){
        return `üí° Valor aplicado em an√∫ncios pagos. Exemplo: Investir R$ 1.500 em campanhas no Meta Ads.`;
      }
      if(desc.includes('faturamento') && desc.includes('tr√°fego')){
        return `üí° Vendas geradas pelos an√∫ncios online. Exemplo: R$ 7.000 em vendas vindas de campanhas.`;
      }
      if(desc.includes('roas')){
        return `üí° Lucro por cada real investido. Exemplo: Investiu R$ 1.000, faturou R$ 4.000 ‚Üí ROAS 4x.`;
      }
      if(desc.includes('taxa') && desc.includes('qualificado')){
        return `üí° Percentual de leads prontos para contato. Exemplo: 30 dos 100 leads demonstraram interesse (30%).`;
      }
      if(desc.includes('cpl') || (desc.includes('custo') && desc.includes('lead'))){
        return `üí° Valor m√©dio pago por cada lead. Exemplo: Gastou R$ 500 e gerou 25 leads ‚Üí R$ 20 por lead.`;
      }
      if(desc.includes('cac') || desc.includes('custo de aquisi√ß√£o')){
        return `üí° Custo total para conquistar um cliente. Exemplo: Investiu R$ 2.000 e fechou 4 clientes ‚Üí CAC R$ 500.`;
      }
      if(desc.includes('aquecido') || desc.includes('nutri√ß√£o')){
        return `üí° Leads engajados e pr√≥ximos de comprar. Exemplo: 10 leads que responderam follow-up e pediram or√ßamento.`;
      }
      if(desc.includes('seguidores') || desc.includes('tra√ß√£o')){
        return `üí° Crescimento do p√∫blico nas redes sociais. Exemplo: Instagram passou de 2.000 para 2.350 seguidores.`;
      }
      if(desc.includes('coment√°rios') || desc.includes('gbp') || desc.includes('google business')){
        return `üí° Avalia√ß√µes positivas no Google Business Profile. Exemplo: 5 novas avalia√ß√µes com 5 estrelas no m√™s.`;
      }
      if(desc.includes('valor') && desc.includes('contrato')){
        return `üí° Soma total de contratos fechados. Exemplo: Fechou dois projetos de R$ 8.000 ‚Üí total R$ 16.000.`;
      }
      if(desc.includes('or√ßamento') && desc.includes('recorrente')){
        return `üí° Propostas enviadas a clientes antigos. Exemplo: Reenviou 3 or√ßamentos para clientes j√° existentes.`;
      }
      if(desc.includes('neg√≥cio') && desc.includes('recorrente')){
        return `üí° Vendas feitas para clientes antigos. Exemplo: Fechou 2 servi√ßos com clientes recorrentes.`;
      }
      if(desc.includes('taxa') && desc.includes('convers√£o') && desc.includes('recorrente')){
        return `üí° Percentual de retorno de clientes antigos. Exemplo: 5 or√ßamentos enviados, 2 fechados ‚Üí 40%.`;
      }
      if(desc.includes('total') && desc.includes('lead')){
        return `üí° Quantidade total de novos contatos recebidos. Exemplo: 60 novos leads captados via an√∫ncios.`;
      }
      if(desc.includes('or√ßamento') && (desc.includes('novo') || desc.includes('leads novos'))){
        return `üí° Propostas enviadas a novos contatos. Exemplo: 20 or√ßamentos enviados para leads do site.`;
      }
      if(desc.includes('neg√≥cio') && (desc.includes('novo') || desc.includes('leads novos'))){
        return `üí° Vendas conclu√≠das com novos leads. Exemplo: 6 novos clientes vindos de an√∫ncios.`;
      }
      if(desc.includes('taxa') && desc.includes('convers√£o') && (desc.includes('novo') || desc.includes('leads novos'))){
        return `üí° Percentual de leads que se tornaram clientes. Exemplo: 30 leads gerados, 6 vendas ‚Üí 20%.`;
      }
      if(desc.includes('perdido')){
        return `üí° Total de propostas n√£o convertidas. Exemplo: Perdeu 3 or√ßamentos que somavam R$ 5.000.`;
      }
      if(desc.includes('faturamento') && desc.includes('total')){
        return `üí° Soma de todas as vendas do m√™s. Exemplo: Vendeu R$ 50.000 entre todos os clientes.`;
      }
      if(desc.includes('leads') || desc.includes('contatos')){
        return `üí° Pessoas interessadas no seu produto/servi√ßo. Quantos novos contatos voc√™ quer capturar?`;
      }
      if(desc.includes('ticket m√©dio')){
        return `üí° Valor m√©dio de cada venda. Exemplo: Vendeu R$ 1.000 e R$ 2.000 ‚Üí ticket m√©dio R$ 1.500.`;
      }
      if(desc.includes('taxa de convers√£o') || desc.includes('convers√£o')){
        return `üí° Percentual de leads que compraram. Exemplo: 100 leads, 5 compraram = 5% de convers√£o.`;
      }
      
      // Explica√ß√£o gen√©rica
      return `üí° ${meta.descricao} - Defina o valor que voc√™ espera alcan√ßar neste m√™s.`;
    }

    function renderProgressBar(){
      const total = state.metas.length;
      const current = state.currentStep;
      
      const progressBar = document.createElement('div');
      progressBar.className = 'progress-bar';
      
      const text = document.createElement('div');
      text.className = 'progress-text';
      text.textContent = `Meta ${Math.min(current + 1, total)} de ${total}`;
      
      const dots = document.createElement('div');
      dots.className = 'progress-steps';
      
      for(let i = 0; i < total; i++){
        const dot = document.createElement('div');
        dot.className = 'progress-dot';
        if(i < current) dot.classList.add('completed');
        if(i === current) dot.classList.add('current');
        dots.appendChild(dot);
      }
      
      progressBar.appendChild(text);
      progressBar.appendChild(dots);
      
      return progressBar;
    }

    function renderMetaStep(meta, index){
      const container = document.createElement('div');
      
      // Progress bar
      container.appendChild(renderProgressBar());
      
      const step = document.createElement('div');
      step.className = 'meta-step';
      
      // Header
      const header = document.createElement('div');
      header.className = 'meta-step-header';
      
      const number = document.createElement('div');
      number.className = 'meta-number';
      number.textContent = `Meta ${index + 1} ‚Ä¢ ${meta.descricao || 'Meta'}`;
      
      const question = document.createElement('h2');
      question.className = 'meta-question';
      question.textContent = generateQuestion(meta);
      
      const subtitle = document.createElement('p');
      subtitle.className = 'meta-subtitle';
      subtitle.textContent = `Referente ao m√™s de ${state.monthLabel}`;
      
      const explanation = document.createElement('div');
      explanation.className = 'meta-explanation';
      explanation.textContent = generateExplanation(meta);
      
      header.appendChild(number);
      header.appendChild(question);
      header.appendChild(subtitle);
      header.appendChild(explanation);
      step.appendChild(header);
      
      // Pega o valor planejado (P) que a ag√™ncia definiu
      const plannedValue = meta.plannedValue; // Vem do backend
      const hasPlannedValue = plannedValue !== null && plannedValue !== undefined && plannedValue !== '';
      
      // Verifica se j√° tem valor salvo pelo cliente
      const savedValue = state.responses[meta.id];
      const hasSavedValue = savedValue !== null && savedValue !== undefined && savedValue !== '';
      
      const unit = meta.unidade || '';
      const symbol = getUnitSymbol(unit);
      
      // Input group
      const inputGroup = document.createElement('div');
      inputGroup.className = 'meta-input-group';
      
      if(hasPlannedValue){
        // MODO APROVA√á√ÉO: Ag√™ncia j√° definiu um valor planejado
        const display = document.createElement('div');
        display.className = 'current-value-display';
        
        let approvalText = '';
        if(unit === 'BRL' || unit === 'USD'){
          approvalText = `A ag√™ncia sugeriu: ${formatNumberDisplay(plannedValue, unit)}. Voc√™ aprova este valor?`;
        } else if(unit === '%'){
          approvalText = `A ag√™ncia sugeriu: ${formatNumberDisplay(plannedValue, unit)}. Voc√™ aprova esta meta?`;
        } else if(unit === 'numero'){
          approvalText = `A ag√™ncia sugeriu: ${formatNumberDisplay(plannedValue, unit)}. Voc√™ aprova este n√∫mero?`;
        } else {
          approvalText = `Valor sugerido pela ag√™ncia: ${formatNumberDisplay(plannedValue, unit)}`;
        }
        
        display.textContent = approvalText;
        inputGroup.appendChild(display);
        
        // Actions
        const actions = document.createElement('div');
        actions.className = 'wizard-actions';
        
        const skipBtn = document.createElement('button');
        skipBtn.className = 'btn btn-skip';
        skipBtn.type = 'button';
        skipBtn.innerHTML = '‚è≠Ô∏è N√£o sei, pular';
        skipBtn.onclick = () => {
          // Remove resposta se existir
          delete state.responses[meta.id];
          // Avan√ßa sem salvar
          nextStep();
        };
        
        const editBtn = document.createElement('button');
        editBtn.className = 'btn btn-edit';
        editBtn.type = 'button';
        editBtn.innerHTML = '‚úèÔ∏è Quero ajustar este valor';
        editBtn.onclick = () => {
          // Substitui por input com valor pr√©-preenchido
          inputGroup.innerHTML = '';
          inputGroup.appendChild(createInputField(meta, plannedValue));
        };
        
        const approveBtn = document.createElement('button');
        approveBtn.className = 'btn btn-approve';
        approveBtn.type = 'button';
        approveBtn.innerHTML = '‚úÖ Aprovar e continuar';
        approveBtn.onclick = () => {
          state.responses[meta.id] = plannedValue;
          scheduleSave();
          nextStep();
        };
        
        actions.appendChild(skipBtn);
        actions.appendChild(editBtn);
        actions.appendChild(approveBtn);
        inputGroup.appendChild(actions);
        
      } else {
        // MODO INPUT: N√£o tem valor planejado, cliente precisa preencher
        const noPlannedMsg = document.createElement('div');
        noPlannedMsg.className = 'current-value-display';
        noPlannedMsg.style.background = 'rgba(251,191,36,0.1)';
        noPlannedMsg.style.borderColor = 'rgba(251,191,36,0.3)';
        noPlannedMsg.style.color = '#fbbf24';
        noPlannedMsg.textContent = '‚ö†Ô∏è A ag√™ncia ainda n√£o definiu esta meta. Voc√™ pode sugerir um valor:';
        inputGroup.appendChild(noPlannedMsg);
        
        inputGroup.appendChild(createInputField(meta, hasSavedValue ? savedValue : ''));
      }
      
      step.appendChild(inputGroup);
      container.appendChild(step);
      
      return container;
    }

    function createInputField(meta, initialValue = ''){
      const wrapper = document.createElement('div');
      wrapper.className = 'input-wrapper';
      
      const unit = meta.unidade || '';
      const symbol = getUnitSymbol(unit);
      
      if(symbol && (unit === 'BRL' || unit === 'USD')){
        const prefix = document.createElement('span');
        prefix.className = 'input-prefix';
        prefix.textContent = symbol;
        wrapper.appendChild(prefix);
      }
      
      const input = document.createElement('input');
      input.type = 'number';
      input.className = 'wizard-input';
      input.step = getInputStep(unit);
      input.inputMode = unit === 'numero' ? 'numeric' : 'decimal';
      input.placeholder = '0';
      input.value = initialValue;
      input.autofocus = true;
      
      // Auto-save on input
      let inputTimer;
      input.oninput = () => {
        clearTimeout(inputTimer);
        inputTimer = setTimeout(() => {
          const val = input.value.trim();
          if(val !== ''){
            const num = Number(val);
            if(Number.isFinite(num)){
              state.responses[meta.id] = num;
              scheduleSave();
            }
          }
        }, 500);
      };
      
      // Enter to continue
      input.onkeypress = (e) => {
        if(e.key === 'Enter'){
          e.preventDefault();
          const val = input.value.trim();
          if(val !== ''){
            const num = Number(val);
            if(Number.isFinite(num)){
              state.responses[meta.id] = num;
              scheduleSave();
              nextStep();
            }
          }
        }
      };
      
      wrapper.appendChild(input);
      
      if(symbol && unit === '%'){
        const suffix = document.createElement('span');
        suffix.className = 'input-suffix';
        suffix.textContent = '%';
        wrapper.appendChild(suffix);
      }
      
      // Actions
      const actions = document.createElement('div');
      actions.className = 'wizard-actions';
      
      const backBtn = document.createElement('button');
      backBtn.className = 'btn btn-secondary';
      backBtn.type = 'button';
      backBtn.innerHTML = '‚Üê Voltar';
      backBtn.onclick = previousStep;
      if(state.currentStep === 0) backBtn.style.visibility = 'hidden';
      
      const skipBtn = document.createElement('button');
      skipBtn.className = 'btn btn-skip';
      skipBtn.type = 'button';
      skipBtn.innerHTML = '‚è≠Ô∏è N√£o sei, pular';
      skipBtn.onclick = () => {
        // Remove resposta se existir
        delete state.responses[meta.id];
        // Avan√ßa sem salvar
        nextStep();
      };
      
      const nextBtn = document.createElement('button');
      nextBtn.className = 'btn btn-primary';
      nextBtn.type = 'button';
      nextBtn.innerHTML = 'Pr√≥xima ‚Üí';
      nextBtn.onclick = () => {
        const val = input.value.trim();
        if(val !== ''){
          const num = Number(val);
          if(Number.isFinite(num)){
            state.responses[meta.id] = num;
            scheduleSave();
            nextStep();
          }
        } else {
          // Permite pular se n√£o quiser responder
          nextStep();
        }
      };
      
      actions.appendChild(backBtn);
      actions.appendChild(skipBtn);
      actions.appendChild(nextBtn);
      
      const container = document.createElement('div');
      container.appendChild(wrapper);
      container.appendChild(actions);
      
      return container;
    }

    function renderCompletionScreen(){
      const screen = document.createElement('div');
      screen.className = 'completion-screen';
      
      const icon = document.createElement('div');
      icon.className = 'completion-icon';
      icon.textContent = 'üéâ';
      
      const title = document.createElement('h2');
      title.textContent = 'Pronto! Metas atualizadas';
      
      const message = document.createElement('p');
      message.textContent = 'Todas as suas respostas foram salvas com sucesso.';
      
      const submessage = document.createElement('p');
      submessage.style.fontSize = '.9rem';
      submessage.style.color = '#94a3b8';
      submessage.textContent = 'Voc√™ pode fechar esta p√°gina agora.';
      
      const restartBtn = document.createElement('button');
      restartBtn.className = 'btn btn-secondary';
      restartBtn.type = 'button';
      restartBtn.innerHTML = 'üîÑ Revisar respostas';
      restartBtn.style.marginTop = '24px';
      restartBtn.onclick = () => {
        state.currentStep = 0;
        renderCurrentStep();
      };
      
      screen.appendChild(icon);
      screen.appendChild(title);
      screen.appendChild(message);
      screen.appendChild(submessage);
      screen.appendChild(restartBtn);
      
      return screen;
    }

    function renderCurrentStep(){
      wizardContainerEl.innerHTML = '';
      
      if(state.currentStep >= state.metas.length){
        // Completion
        wizardContainerEl.appendChild(renderCompletionScreen());
        return;
      }
      
      const meta = state.metas[state.currentStep];
      wizardContainerEl.appendChild(renderMetaStep(meta, state.currentStep));
      
      // Auto-focus no input
      setTimeout(() => {
        const input = wizardContainerEl.querySelector('.wizard-input');
        if(input) input.focus();
      }, 100);
    }

    function nextStep(){
      if(state.currentStep < state.metas.length){
        state.currentStep++;
        renderCurrentStep();
      }
    }

    function previousStep(){
      if(state.currentStep > 0){
        state.currentStep--;
        renderCurrentStep();
      }
    }

    async function init(){
      try{
        const snap = await getDoc(formRef);
        if(!snap.exists()){
          showError('Este link expirou ou foi revogado. Solicite um novo link ao seu consultor.');
          return;
        }
        
        const data = snap.data();
        state.docData = data;
        state.monthKey = data.monthKey || '';
        state.monthLabel = data.monthLabel || MONTH_LABELS[state.monthKey] || 'm√™s atual';
        
        // Carrega respostas salvas
        if(data.responses && typeof data.responses === 'object'){
          Object.entries(data.responses).forEach(([metaId, payload]) => {
            if(payload && typeof payload === 'object' && payload.current !== undefined){
              state.responses[metaId] = payload.current;
            }
          });
        }
        
        // Prepara metas (somente do m√™s atual)
        if(Array.isArray(data.metas) && data.metas.length > 0){
          state.metas = data.metas.map((m, idx) => {
            // Extrai o valor planejado (P) para o m√™s atual
            const plannedValue = m.projections && m.projections[state.monthKey] !== undefined 
              ? m.projections[state.monthKey] 
              : null;
            
            return {
              ...m,
              pos: idx + 1,
              plannedValue // Adiciona o valor planejado ao objeto meta
            };
          });
        } else {
          showError('Nenhuma meta ativa foi compartilhada neste link. Solicite uma atualiza√ß√£o ao time da MediaGrowth.');
          return;
        }
        
        const clientLabel = data.clientLabel || data.clientKey || 'Cliente';
        titleEl.textContent = `Metas ‚Ä¢ ${clientLabel}`;
        instructionsEl.innerHTML = `Responda as perguntas sobre <strong>${state.monthLabel}</strong>. V√° no seu ritmo, suas respostas s√£o salvas automaticamente.`;
        
        showContent();
        renderCurrentStep();
        state.initialized = true;
        
      }catch(err){
        console.error('Erro ao carregar formul√°rio de metas', err);
        showError('N√£o foi poss√≠vel carregar este formul√°rio. Verifique o link ou tente novamente mais tarde.');
      }
    }

    init();
  </script>
</body>
</html>

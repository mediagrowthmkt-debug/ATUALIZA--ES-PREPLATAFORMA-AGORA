rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ===== Helpers existentes ===== */
    function isSignedIn() { return request.auth != null; }
    function isOwner(userId) { return isSignedIn() && request.auth.uid == userId; }
    function isAdmin() {
      return isSignedIn() &&
             exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    /* ===== Helper para verificar se √© um usu√°rio v√°lido ===== */
    function isValidUser() {
      return isSignedIn() && (
        exists(/databases/$(database)/documents/usuarios/$(request.auth.uid)) ||
        isAdmin()
      );
    }

    /* ===== Novos helpers multi-tenant ===== */
    function isAgency() {
      return isSignedIn() && request.auth.token.role == 'agency' && request.auth.token.agencyId is string;
    }
    function isClient() {
      return isSignedIn() && request.auth.token.role == 'client' && request.auth.token.agencyId is string && request.auth.token.clientId is string;
    }
    function sameAgencyData(doc) {
      return doc.agencyId is string && request.auth.token.agencyId == doc.agencyId;
    }
    function sameAgencyReq(doc) {
      return doc.agencyId is string && request.auth.token.agencyId == doc.agencyId;
    }
    function sameClientData(doc) {
      return doc.clientId is string && request.auth.token.clientId == doc.clientId && sameAgencyData(doc);
    }
    function sameClientReq(doc) {
      return doc.clientId is string && request.auth.token.clientId == doc.clientId && sameAgencyReq(doc);
    }

    /* ===== Isolamento por usu√°rio (compat) + abertura para ag√™ncia ===== */
    match /usuarios/{userId} {

      // O dono (usu√°rio legado) segue com acesso total e ag√™ncia/cliente t√™m acesso dentro do pr√≥prio contexto
      // IMPORTANTE: Permite leitura se o usu√°rio estiver autenticado e for o pr√≥prio dono
      allow read: if isOwner(userId)
           || isAdmin()
           || (isSignedIn() && exists(resource) && 'agencyId' in resource.data && resource.data.agencyId == request.auth.uid)
           || (isClient() && exists(resource) && sameClientData(resource.data));
    
    // Permite admin fazer queries (list) para buscar por email
    allow list: if isAdmin();
    
    // Permite cria√ß√£o e atualiza√ß√£o se for o dono
    allow create, update, delete: if isOwner(userId)
           || isAdmin()
           || (isSignedIn()
             && 'agencyId' in request.resource.data
             && request.resource.data.agencyId is string
             && request.resource.data.agencyId == request.auth.uid)
           || (isClient()
             && 'agencyId' in request.resource.data
             && request.resource.data.agencyId == request.auth.token.agencyId
             && 'clientId' in request.resource.data
             && request.resource.data.clientId == request.auth.token.clientId);

      /* posts (mantido) */
      match /posts/{postId} {
        // Permite leitura e escrita se for o dono
        allow read, write: if isOwner(userId);
        
        // Permite para ag√™ncias com verifica√ß√£o segura
        allow read, update, create, delete: if isAgency() && (
          (exists(resource) && 'agencyId' in resource.data && sameAgencyData(resource.data)) ||
          ('agencyId' in request.resource.data && sameAgencyReq(request.resource.data))
        );

        /* üî∞ Atualiza√ß√£o p√∫blica via link (mantido) */
        allow update: if
          request.auth == null
          &&
          resource.data.diff(request.resource.data).changedKeys().hasOnly([
            'status','approvedBy','approvedSlides','reviewNotes',
            'updatedAt','lastReviewAt','approvalToken'
          ])
          &&
          request.resource.data.approvalToken is string
          &&
          (
            ( exists(/databases/$(database)/documents/postApprovals/$(request.resource.data.approvalToken))
              && get(/databases/$(database)/documents/postApprovals/$(request.resource.data.approvalToken)).data.uid == userId
              && get(/databases/$(database)/documents/postApprovals/$(request.resource.data.approvalToken)).data.postId == postId
            )
            ||
            (
              exists(/databases/$(database)/documents/calendarShares/$(request.resource.data.approvalToken))
              && get(/databases/$(database)/documents/calendarShares/$(request.resource.data.approvalToken)).data.uid == userId
              &&
              (
                !('postsCollectionPath' in get(/databases/$(database)/documents/calendarShares/$(request.resource.data.approvalToken)).data)
                ||
                (
                  get(/databases/$(database)/documents/calendarShares/$(request.resource.data.approvalToken)).data.postsCollectionPath is list
                  && get(/databases/$(database)/documents/calendarShares/$(request.resource.data.approvalToken)).data.postsCollectionPath.size() >= 2
                  && get(/databases/$(database)/documents/calendarShares/$(request.resource.data.approvalToken)).data.postsCollectionPath[0] == 'usuarios'
                  && get(/databases/$(database)/documents/calendarShares/$(request.resource.data.approvalToken)).data.postsCollectionPath[1] == userId
                )
              )
              &&
              (
                !('postIds' in get(/databases/$(database)/documents/calendarShares/$(request.resource.data.approvalToken)).data)
                ||
                get(/databases/$(database)/documents/calendarShares/$(request.resource.data.approvalToken)).data.postIds.hasAny([postId])
              )
              &&
              (
                !('monthKey' in get(/databases/$(database)/documents/calendarShares/$(request.resource.data.approvalToken)).data)
                || !('dateISO' in resource.data)
                || (resource.data.dateISO is string
                    && resource.data.dateISO.size() >= 7
                    && resource.data.dateISO.slice(0,7) == get(/databases/$(database)/documents/calendarShares/$(request.resource.data.approvalToken)).data.monthKey)
              )
            )
          );
      }

      /* ‚úÖ ESTRUTURA√á√ÉO: Subcole√ß√£o para salvar dados da aba Estrutura√ß√£o (evita limite de 1MB) */
      /* Cada semana √© salva como documento separado: /usuarios/{userId}/estruturacao/{weekId} */
      match /estruturacao/{weekId} {
        // O dono pode ler e escrever seus pr√≥prios dados de estrutura√ß√£o
        allow read, write: if isOwner(userId);
        
        // Admin tamb√©m tem acesso total
        allow read, write: if isAdmin();
        
        // Ag√™ncias podem acessar se tiverem o mesmo agencyId
        allow read, write: if isAgency() && (
          (exists(resource) && 'agencyId' in resource.data && sameAgencyData(resource.data)) ||
          ('agencyId' in request.resource.data && sameAgencyReq(request.resource.data))
        );
      }

      /* ‚úÖ AN√ÅLISES: Subcole√ß√£o para salvar an√°lises dos entreg√°veis (evita limite de 1MB) */
      /* Cada an√°lise √© salva como documento separado: /usuarios/{userId}/analises/{entregavelId} */
      match /analises/{entregavelId} {
        // O dono pode ler e escrever suas pr√≥prias an√°lises
        allow read, write: if isOwner(userId);
        
        // Admin tamb√©m tem acesso total
        allow read, write: if isAdmin();
        
        // Ag√™ncias podem acessar se tiverem o mesmo agencyId
        allow read, write: if isAgency() && (
          (exists(resource) && 'agencyId' in resource.data && sameAgencyData(resource.data)) ||
          ('agencyId' in request.resource.data && sameAgencyReq(request.resource.data))
        );
      }

      /* ‚úÖ CONVERSAS I.A.: Subcole√ß√£o para arquivar conversas antigas (evita limite de 1MB) */
      /* Cada conversa arquivada √© salva como documento separado: /usuarios/{userId}/iaChats/{chatId} */
      match /iaChats/{chatId} {
        // O dono pode ler e escrever suas pr√≥prias conversas I.A.
        allow read, write: if isOwner(userId);
        
        // Admin tamb√©m tem acesso total
        allow read, write: if isAdmin();
        
        // Ag√™ncias podem acessar se tiverem o mesmo agencyId
        allow read, write: if isAgency() && (
          (exists(resource) && 'agencyId' in resource.data && sameAgencyData(resource.data)) ||
          ('agencyId' in request.resource.data && sameAgencyReq(request.resource.data))
        );
      }

      /* ‚úÖ METADADOS DE M√çDIAS: Subcole√ß√£o para tags/descri√ß√µes de fotos/v√≠deos */
      /* Cada m√≠dia √© salva como documento separado: /usuarios/{userId}/midias_metadados/{urlHash} */
      match /midias_metadados/{urlHash} {
        // O dono pode ler e escrever seus pr√≥prios metadados de m√≠dia
        allow read, write: if isOwner(userId);
        
        // Admin tamb√©m tem acesso total
        allow read, write: if isAdmin();
        
        // Ag√™ncias podem acessar se tiverem o mesmo agencyId
        allow read, write: if isAgency() && (
          (exists(resource) && 'agencyId' in resource.data && sameAgencyData(resource.data)) ||
          ('agencyId' in request.resource.data && sameAgencyReq(request.resource.data))
        );
      }

      /* ‚úÖ NOTAS DO TIME: Subcole√ß√£o para salvar notas do time (evita limite de 1MB) */
      /* Documento √∫nico: /usuarios/{userId}/teamNotes/notes */
      match /teamNotes/{noteId} {
        // O dono pode ler e escrever suas pr√≥prias notas do time
        allow read, write: if isOwner(userId);
        
        // Admin tamb√©m tem acesso total
        allow read, write: if isAdmin();
        
        // Ag√™ncias podem acessar se tiverem o mesmo agencyId
        allow read, write: if isAgency() && (
          (exists(resource) && 'agencyId' in resource.data && sameAgencyData(resource.data)) ||
          ('agencyId' in request.resource.data && sameAgencyReq(request.resource.data))
        );
      }

      /* ‚úÖ TIME (global): /usuarios/{userId}/team/{memberId} */
      match /team/{memberId} {
        allow read: if isOwner(userId)
                    || (isAgency() && (
                         (exists(resource) && sameAgencyData(resource.data)) ||
                         sameAgencyReq(request.resource.data)
                       ));
        allow create, update, delete: if isOwner(userId)
                    || (isAgency() && (
                         (exists(resource) && sameAgencyData(resource.data)) ||
                         sameAgencyReq(request.resource.data)
                       ));
      }

      /* ‚úÖ TIME em settings: /usuarios/{userId}/settings/{docId}/team/{memberId} */
      match /settings/{docId}/team/{memberId} {
        allow read: if isOwner(userId)
                    || (isAgency() && (
                         (exists(resource) && sameAgencyData(resource.data)) ||
                         sameAgencyReq(request.resource.data)
                       ));
        allow create, update, delete: if isOwner(userId)
                    || (isAgency() && (
                         (exists(resource) && sameAgencyData(resource.data)) ||
                         sameAgencyReq(request.resource.data)
                       ));
      }

      /* documentos de cada cliente (legado) */
      match /clients/{clientId} {
        // Dono segue com acesso
        allow read, write: if isOwner(userId);

        // Ag√™ncia pode ler/escrever tudo do cliente, desde que agencyId/clientId batam
        allow read, update, create, delete: if isAgency() && (
          (exists(resource) && sameAgencyData(resource.data) && resource.data.clientId == request.auth.token.clientId ? true : sameAgencyData(resource.data))
          ||
          sameAgencyReq(request.resource.data)
        );

        // Cliente logado (role=client) s√≥ no pr√≥prio clientId
        allow read, update, create, delete: if isClient() && (
          (exists(resource) && sameClientData(resource.data)) ||
          sameClientReq(request.resource.data)
        );

        /* ‚úÖ TIME por cliente: /usuarios/{userId}/clients/{clientId}/team/{memberId} */
        match /team/{memberId} {
          allow read: if isOwner(userId)
                      || (isAgency() && (
                           (exists(resource) && sameAgencyData(resource.data)) ||
                           sameAgencyReq(request.resource.data)
                         ))
                      || (isClient() && (
                           (exists(resource) && sameClientData(resource.data)) ||
                           sameClientReq(request.resource.data)
                         ));
          allow create, update, delete: if isOwner(userId)
                      || (isAgency() && (
                           (exists(resource) && sameAgencyData(resource.data)) ||
                           sameAgencyReq(request.resource.data)
                         ))
                      || (isClient() && (
                           (exists(resource) && sameClientData(resource.data)) ||
                           sameClientReq(request.resource.data)
                         ));
        }

        match /refSocial/{docId} {
          allow read, write: if isOwner(userId)
                             || (isAgency() && ((exists(resource) && sameAgencyData(resource.data)) || sameAgencyReq(request.resource.data)))
                             || (isClient() && ((exists(resource) && sameClientData(resource.data)) || sameClientReq(request.resource.data)));
        }

        /* ‚ö†Ô∏è CR√çTICO: Conversas da I.A. (iaDocs) - Acesso baseado em hierarquia de path, n√£o em campos do documento */
        match /iaDocs/{docId} {
          // O dono do usu√°rio (userId) sempre tem acesso total
          allow read, write: if isOwner(userId);
          
          // Admin sempre tem acesso
          allow read, write: if isAdmin();
          
          // Ag√™ncia tem acesso se o token agencyId corresponde ao userId do path
          allow read, write: if isAgency() && request.auth.uid == userId;
          
          // Cliente tem acesso se estiver autenticado (path j√° garante isolamento)
          allow read, write: if isClient() && isSignedIn();
        }

        match /{subcol}/{docId} {
          allow read, write: if isOwner(userId)
                             || (isAgency() && ((exists(resource) && sameAgencyData(resource.data)) || sameAgencyReq(request.resource.data)))
                             || (isClient() && ((exists(resource) && sameClientData(resource.data)) || sameClientReq(request.resource.data)));
        }

        match /{path=**} {
          allow read, write: if isOwner(userId)
                             || (isAgency() && ((exists(resource) && sameAgencyData(resource.data)) || sameAgencyReq(request.resource.data)))
                             || (isClient() && ((exists(resource) && sameClientData(resource.data)) || sameClientReq(request.resource.data)));
        }
      }
    }

    /* Leitura global apenas para admins */
    match /{path=**}/notas/{docId}        { allow read: if isAdmin(); }
    match /{path=**}/metricas/{docId}     { allow read: if isAdmin(); }
    match /{path=**}/atualizacoes/{docId} { allow read: if isAdmin(); }
    match /{path=**}/iframes/{docId}      { allow read: if isAdmin(); }

    /* √çndice de clientes */
    match /clientes_index/{clienteId} { allow read: if isAdmin(); allow write: if false; }

    /* Lista de admins */
    match /admins/{uid} { 
      allow read: if isOwner(uid) || isAdmin(); 
      allow create: if isSignedIn() && request.auth.uid == uid;
      allow update: if isOwner(uid);
      allow delete: if false;
      
      /* Companies gerenciadas pelo admin */
      match /companies/{companyId} {
        allow read: if isOwner(uid);
        allow create: if isOwner(uid);
        allow update: if isOwner(uid);
        allow delete: if isOwner(uid);
      }
    }

    /* üî∞ Formul√°rio p√∫blico de Metas (mantido) */
    match /metasForms/{token} {
      allow create: if isSignedIn()
                    && request.resource.data.uid == request.auth.uid
                    && request.resource.data.token == token;
      allow get: if true;
      allow list: if false;
      allow update: if
        (isSignedIn() && request.auth.uid == resource.data.uid)
        ||
        (
          request.auth == null
          && request.resource.data.uid == resource.data.uid
          && request.resource.data.token == resource.data.token
          && request.resource.data.clientKeyNormalized == resource.data.clientKeyNormalized
          && resource.data.diff(request.resource.data).changedKeys().hasOnly(['responses','updatedAt','version'])
        );
      allow delete: if isSignedIn() && request.auth.uid == resource.data.uid;
    }

    /* ‚úÖ Links p√∫blicos de aprova√ß√£o (legado) */
    match /postApprovals/{token} {
      allow create: if isSignedIn()
                    && request.resource.data.uid == request.auth.uid
                    && request.resource.data.token == token;
      allow get: if true;
      allow list: if false;
      allow update: if
        (isSignedIn() && request.auth.uid == resource.data.uid)
        ||
        (
          request.auth == null
          && request.resource.data.uid == resource.data.uid
          && request.resource.data.token == resource.data.token
          && request.resource.data.clientKeyNormalized == resource.data.clientKeyNormalized
          && request.resource.data.postId == resource.data.postId
          && request.resource.data.postDocPath == resource.data.postDocPath
          && resource.data.diff(request.resource.data).changedKeys().hasOnly([
            'decision','decisionBy','decisionEmail','decisionAt',
            'note','notes','reviewNote','approvedSlides','internalApprovedSlides',
            'status','approvedBy','reviewNotes','updatedAt','lastAction','lastActionAt','lastReviewAt'
          ])
        );
      allow delete: if isSignedIn() && request.auth.uid == resource.data.uid;
    }

    /* ‚úÖ Links p√∫blicos do calend√°rio (mantido) */
    match /calendarShares/{token} {
      allow create: if isSignedIn()
                    && request.resource.data.uid == request.auth.uid
                    && request.resource.data.token == token;
      allow get: if true;
      allow list: if false;
      allow update: if
        (isSignedIn() && request.auth.uid == resource.data.uid)
        ||
        (
          request.auth == null
          && request.resource.data.token == resource.data.token
          && request.resource.data.uid   == resource.data.uid
          && resource.data.diff(request.resource.data).changedKeys().hasOnly([
            'lastAction','lastActionAt','updatedAt','lastApprovedPostId','lastReviewPostId','lastReviewNote'
          ])
        );
      allow delete: if isSignedIn() && request.auth.uid == resource.data.uid;
    }

    /* ‚úÖ Links p√∫blicos do PLANEJAMENTO (mantido) */
    match /planningShares/{token} {
      allow create: if isSignedIn()
                    && request.resource.data.uid == request.auth.uid
                    && request.resource.data.token == token
                    && request.resource.data.clientKeyNormalized is string;
      allow get: if true;
      allow list: if false;
      allow update: if
        (isSignedIn() && request.auth.uid == resource.data.uid)
        ||
        (
          request.auth == null
          && request.resource.data.token == resource.data.token
          && request.resource.data.uid   == resource.data.uid
          && resource.data.diff(request.resource.data).changedKeys().hasOnly([
              'updatedAt','lastAction','lastActionAt','lastViewedAt','lastInteraction'
          ])
        );
      allow delete: if isSignedIn() && request.auth.uid == resource.data.uid;
    }

    /* ‚úÖ Links p√∫blicos do RELAT√ìRIO (novo) */
    match /reportShares/{token} {
      // Qualquer pessoa com o link pode visualizar
      allow get: if true;
      allow list: if false;
      // Somente o dono autenticado pode criar/atualizar
      allow create: if isSignedIn()
                    && request.resource.data.uid == request.auth.uid
                    && request.resource.data.token == token
                    && request.resource.data.monthKey is string;
      allow update: if isSignedIn()
                    && request.resource.data.uid == request.auth.uid
                    && request.resource.data.token == token
                    && resource.data.uid == request.auth.uid;
      // Dono pode apagar
      allow delete: if isSignedIn() && resource.data.uid == request.auth.uid;
    }

    /* ‚úÖ Links p√∫blicos de RELAT√ìRIO COMPLETO compartilhado - v2 26/12/2025 */
    match /relatoriosCompartilhados/{token} {
      // Qualquer pessoa com o link pode visualizar (p√∫blico)
      allow get: if true;
      allow list: if false;
      // Somente usu√°rio autenticado pode criar
      allow create: if isSignedIn()
                    && request.resource.data.token == token
                    && request.resource.data.analises is map
                    && (
                      request.resource.data.uid == request.auth.uid
                      || isAdmin()
                    );
      // Usu√°rio autenticado (dono ou admin) pode atualizar
      allow update: if isSignedIn() && (request.auth.uid == resource.data.uid || isAdmin());
      // Dono ou admin pode apagar
      allow delete: if isSignedIn() && (request.auth.uid == resource.data.uid || isAdmin());
    }

    /* ‚úÖ Links p√∫blicos de aprova√ß√£o de AN√ÅLISE de entreg√°veis */
    match /analiseApprovals/{token} {
      // Qualquer pessoa com o link pode visualizar
      allow get: if true;
      allow list: if false;
      // Somente usu√°rio autenticado pode criar (com uid pr√≥prio ou como admin para cliente)
      allow create: if isSignedIn()
                    && request.resource.data.token == token
                    && request.resource.data.entregavelId is string
                    && (
                      request.resource.data.uid == request.auth.uid
                      || isAdmin()
                    );
      // Atualiza√ß√£o: usu√°rio autenticado (dono ou admin) ou an√¥nimo (para aprovar)
      allow update: if
        (isSignedIn() && (request.auth.uid == resource.data.uid || isAdmin()))
        ||
        (
          request.auth == null
          && request.resource.data.token == resource.data.token
          && request.resource.data.uid == resource.data.uid
          && request.resource.data.entregavelId == resource.data.entregavelId
          && resource.data.diff(request.resource.data).changedKeys().hasOnly([
            'approved','approvedAt','approvedTimestamp','updatedAt'
          ])
        );
      // Dono ou admin pode apagar
      allow delete: if isSignedIn() && (request.auth.uid == resource.data.uid || isAdmin());
    }
  }
}

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ===== Helpers existentes ===== */
    function isSignedIn() { return request.auth != null; }
    function isOwner(userId) { return isSignedIn() && request.auth.uid == userId; }
    function isAdmin() {
      return isSignedIn() &&
             exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    /* ===== Novos helpers multi-tenant ===== */
    function isAgency() {
      return isSignedIn() && request.auth.token.role == 'agency' && request.auth.token.agencyId is string;
    }
    function isClient() {
      return isSignedIn() && request.auth.token.role == 'client' && request.auth.token.agencyId is string && request.auth.token.clientId is string;
    }
    function sameAgencyData(doc) {
      return doc.agencyId is string && request.auth.token.agencyId == doc.agencyId;
    }
    function sameAgencyReq(doc) {
      return doc.agencyId is string && request.auth.token.agencyId == doc.agencyId;
    }
    function sameClientData(doc) {
      return doc.clientId is string && request.auth.token.clientId == doc.clientId && sameAgencyData(doc);
    }
    function sameClientReq(doc) {
      return doc.clientId is string && request.auth.token.clientId == doc.clientId && sameAgencyReq(doc);
    }

    /* ===== Isolamento por usu√°rio (compat) + abertura para ag√™ncia ===== */
    match /usuarios/{userId} {

      // O dono (usu√°rio legado) segue com acesso total e ag√™ncia/cliente t√™m acesso dentro do pr√≥prio contexto
    allow read: if isOwner(userId)
           || (isSignedIn() && exists(resource) && resource.data.agencyId == request.auth.uid)
           || (isClient() && exists(resource) && sameClientData(resource.data));
    allow create, update, delete: if isOwner(userId)
           || (isSignedIn()
             && request.resource.data.agencyId is string
             && request.resource.data.agencyId == request.auth.uid)
           || (isClient()
             && request.resource.data.agencyId == request.auth.token.agencyId
             && request.resource.data.clientId == request.auth.token.clientId);

      /* posts (mantido) */
      match /posts/{postId} {
        allow read, write: if isOwner(userId);
        allow read, update, create, delete: if isAgency() && (
          (exists(resource) && sameAgencyData(resource.data)) ||
          sameAgencyReq(request.resource.data)
        );

        /* üî∞ Atualiza√ß√£o p√∫blica via link (mantido) */
        allow update: if
          request.auth == null
          &&
          resource.data.diff(request.resource.data).changedKeys().hasOnly([
            'status','approvedBy','approvedSlides','reviewNotes',
            'updatedAt','lastReviewAt','approvalToken'
          ])
          &&
          request.resource.data.approvalToken is string
          &&
          (
            ( exists(/databases/$(database)/documents/postApprovals/$(request.resource.data.approvalToken))
              && get(/databases/$(database)/documents/postApprovals/$(request.resource.data.approvalToken)).data.uid == userId
              && get(/databases/$(database)/documents/postApprovals/$(request.resource.data.approvalToken)).data.postId == postId
            )
            ||
            (
              exists(/databases/$(database)/documents/calendarShares/$(request.resource.data.approvalToken))
              && get(/databases/$(database)/documents/calendarShares/$(request.resource.data.approvalToken)).data.uid == userId
              &&
              (
                !('postsCollectionPath' in get(/databases/$(database)/documents/calendarShares/$(request.resource.data.approvalToken)).data)
                ||
                (
                  get(/databases/$(database)/documents/calendarShares/$(request.resource.data.approvalToken)).data.postsCollectionPath is list
                  && get(/databases/$(database)/documents/calendarShares/$(request.resource.data.approvalToken)).data.postsCollectionPath.size() >= 2
                  && get(/databases/$(database)/documents/calendarShares/$(request.resource.data.approvalToken)).data.postsCollectionPath[0] == 'usuarios'
                  && get(/databases/$(database)/documents/calendarShares/$(request.resource.data.approvalToken)).data.postsCollectionPath[1] == userId
                )
              )
              &&
              (
                !('postIds' in get(/databases/$(database)/documents/calendarShares/$(request.resource.data.approvalToken)).data)
                ||
                get(/databases/$(database)/documents/calendarShares/$(request.resource.data.approvalToken)).data.postIds.hasAny([postId])
              )
              &&
              (
                !('monthKey' in get(/databases/$(database)/documents/calendarShares/$(request.resource.data.approvalToken)).data)
                || !('dateISO' in resource.data)
                || (resource.data.dateISO is string
                    && resource.data.dateISO.size() >= 7
                    && resource.data.dateISO.slice(0,7) == get(/databases/$(database)/documents/calendarShares/$(request.resource.data.approvalToken)).data.monthKey)
              )
            )
          );
      }

      /* ‚úÖ TIME (global): /usuarios/{userId}/team/{memberId} */
      match /team/{memberId} {
        allow read: if isOwner(userId)
                    || (isAgency() && (
                         (exists(resource) && sameAgencyData(resource.data)) ||
                         sameAgencyReq(request.resource.data)
                       ));
        allow create, update, delete: if isOwner(userId)
                    || (isAgency() && (
                         (exists(resource) && sameAgencyData(resource.data)) ||
                         sameAgencyReq(request.resource.data)
                       ));
      }

      /* ‚úÖ TIME em settings: /usuarios/{userId}/settings/{docId}/team/{memberId} */
      match /settings/{docId}/team/{memberId} {
        allow read: if isOwner(userId)
                    || (isAgency() && (
                         (exists(resource) && sameAgencyData(resource.data)) ||
                         sameAgencyReq(request.resource.data)
                       ));
        allow create, update, delete: if isOwner(userId)
                    || (isAgency() && (
                         (exists(resource) && sameAgencyData(resource.data)) ||
                         sameAgencyReq(request.resource.data)
                       ));
      }

      /* documentos de cada cliente (legado) */
      match /clients/{clientId} {
        // Dono segue com acesso
        allow read, write: if isOwner(userId);

        // Ag√™ncia pode ler/escrever tudo do cliente, desde que agencyId/clientId batam
        allow read, update, create, delete: if isAgency() && (
          (exists(resource) && sameAgencyData(resource.data) && resource.data.clientId == request.auth.token.clientId ? true : sameAgencyData(resource.data))
          ||
          sameAgencyReq(request.resource.data)
        );

        // Cliente logado (role=client) s√≥ no pr√≥prio clientId
        allow read, update, create, delete: if isClient() && (
          (exists(resource) && sameClientData(resource.data)) ||
          sameClientReq(request.resource.data)
        );

        /* ‚úÖ TIME por cliente: /usuarios/{userId}/clients/{clientId}/team/{memberId} */
        match /team/{memberId} {
          allow read: if isOwner(userId)
                      || (isAgency() && (
                           (exists(resource) && sameAgencyData(resource.data)) ||
                           sameAgencyReq(request.resource.data)
                         ))
                      || (isClient() && (
                           (exists(resource) && sameClientData(resource.data)) ||
                           sameClientReq(request.resource.data)
                         ));
          allow create, update, delete: if isOwner(userId)
                      || (isAgency() && (
                           (exists(resource) && sameAgencyData(resource.data)) ||
                           sameAgencyReq(request.resource.data)
                         ))
                      || (isClient() && (
                           (exists(resource) && sameClientData(resource.data)) ||
                           sameClientReq(request.resource.data)
                         ));
        }

        match /refSocial/{docId} {
          allow read, write: if isOwner(userId)
                             || (isAgency() && ((exists(resource) && sameAgencyData(resource.data)) || sameAgencyReq(request.resource.data)))
                             || (isClient() && ((exists(resource) && sameClientData(resource.data)) || sameClientReq(request.resource.data)));
        }

        match /{subcol}/{docId} {
          allow read, write: if isOwner(userId)
                             || (isAgency() && ((exists(resource) && sameAgencyData(resource.data)) || sameAgencyReq(request.resource.data)))
                             || (isClient() && ((exists(resource) && sameClientData(resource.data)) || sameClientReq(request.resource.data)));
        }

        match /{path=**} {
          allow read, write: if isOwner(userId)
                             || (isAgency() && ((exists(resource) && sameAgencyData(resource.data)) || sameAgencyReq(request.resource.data)))
                             || (isClient() && ((exists(resource) && sameClientData(resource.data)) || sameClientReq(request.resource.data)));
        }
      }
    }

    /* Leitura global apenas para admins */
    match /{path=**}/notas/{docId}        { allow read: if isAdmin(); }
    match /{path=**}/metricas/{docId}     { allow read: if isAdmin(); }
    match /{path=**}/atualizacoes/{docId} { allow read: if isAdmin(); }
    match /{path=**}/iframes/{docId}      { allow read: if isAdmin(); }

    /* √çndice de clientes */
    match /clientes_index/{clienteId} { allow read: if isAdmin(); allow write: if false; }

    /* Lista de admins */
    match /admins/{uid} { allow read: if isOwner(uid); allow write: if false; }

    /* üî∞ Formul√°rio p√∫blico de Metas (mantido) */
    match /metasForms/{token} {
      allow create: if isSignedIn()
                    && request.resource.data.uid == request.auth.uid
                    && request.resource.data.token == token;
      allow get: if true;
      allow list: if false;
      allow update: if
        (isSignedIn() && request.auth.uid == resource.data.uid)
        ||
        (
          request.auth == null
          && request.resource.data.uid == resource.data.uid
          && request.resource.data.token == resource.data.token
          && request.resource.data.clientKeyNormalized == resource.data.clientKeyNormalized
          && resource.data.diff(request.resource.data).changedKeys().hasOnly(['responses','updatedAt','version'])
        );
      allow delete: if isSignedIn() && request.auth.uid == resource.data.uid;
    }

    /* ‚úÖ Links p√∫blicos de aprova√ß√£o (legado) */
    match /postApprovals/{token} {
      allow create: if isSignedIn()
                    && request.resource.data.uid == request.auth.uid
                    && request.resource.data.token == token;
      allow get: if true;
      allow list: if false;
      allow update: if
        (isSignedIn() && request.auth.uid == resource.data.uid)
        ||
        (
          request.auth == null
          && request.resource.data.uid == resource.data.uid
          && request.resource.data.token == resource.data.token
          && request.resource.data.clientKeyNormalized == resource.data.clientKeyNormalized
          && request.resource.data.postId == resource.data.postId
          && request.resource.data.postDocPath == resource.data.postDocPath
          && resource.data.diff(request.resource.data).changedKeys().hasOnly([
            'decision','decisionBy','decisionEmail','decisionAt',
            'note','notes','reviewNote','approvedSlides','internalApprovedSlides',
            'status','approvedBy','reviewNotes','updatedAt','lastAction','lastActionAt','lastReviewAt'
          ])
        );
      allow delete: if isSignedIn() && request.auth.uid == resource.data.uid;
    }

    /* ‚úÖ Links p√∫blicos do calend√°rio (mantido) */
    match /calendarShares/{token} {
      allow create: if isSignedIn()
                    && request.resource.data.uid == request.auth.uid
                    && request.resource.data.token == token;
      allow get: if true;
      allow list: if false;
      allow update: if
        (isSignedIn() && request.auth.uid == resource.data.uid)
        ||
        (
          request.auth == null
          && request.resource.data.token == resource.data.token
          && request.resource.data.uid   == resource.data.uid
          && resource.data.diff(request.resource.data).changedKeys().hasOnly([
            'lastAction','lastActionAt','updatedAt','lastApprovedPostId','lastReviewPostId','lastReviewNote'
          ])
        );
      allow delete: if isSignedIn() && request.auth.uid == resource.data.uid;
    }

    /* ‚úÖ Links p√∫blicos do PLANEJAMENTO (mantido) */
    match /planningShares/{token} {
      allow create: if isSignedIn()
                    && request.resource.data.uid == request.auth.uid
                    && request.resource.data.token == token
                    && request.resource.data.clientKeyNormalized is string;
      allow get: if true;
      allow list: if false;
      allow update: if
        (isSignedIn() && request.auth.uid == resource.data.uid)
        ||
        (
          request.auth == null
          && request.resource.data.token == resource.data.token
          && request.resource.data.uid   == resource.data.uid
          && resource.data.diff(request.resource.data).changedKeys().hasOnly([
              'updatedAt','lastAction','lastActionAt','lastViewedAt','lastInteraction'
          ])
        );
      allow delete: if isSignedIn() && request.auth.uid == resource.data.uid;
    }
  }
}
